# 服务管理 
# 服务管理 
背景知识 
LSU（LOG Store Unit， 日志存储单元）虚机是平台定义的虚机类型，该类型虚机可用于安装Gbase数据库。LSU服务用于对Gbase数据库的管理。 
Gbase数据库为大规模分布式并行数据库，主要用于存储策略日志信息，以供后续查询及分析。 
Gbase数据库包括以下三大核心服务组件： 
 
GCluster：分布式调度组件，负责SQL语句的解析优化、分布式执行计划生成、执行调度。 
 
GCWare：分布式管理组件，控制各节点数据一致性状态。 
 
GNode：分布式存储组件，最基本的存储和计算单元。 
 
Gbase数据库安装在LSU虚机上，单个LSU虚机安装的Gbase数据库称为一个Gbase节点，多个Gbase节点构成一个Gbase集群。一个Gbase集群，可对外提供完整的数据库服务。 
Gbase节点可部署不同的组件，部署了GCluster和GCware组件的Gbase节点，为管理节点。仅部署GNode组件的Gbase节点，为数据节点。 
功能说明 
本功能用于LSU服务的管理，包括Gbase管理和Gbaes服务。 
子主题： 
## Gbase管理 
## Gbase管理 
背景知识 
Gbase数据库需要安装在LSU虚机上。 
在PCF环境实例化后，根据实际需要决定是否安装Gbase数据库（是否开启策略日志功能）。 
Gbase数据库一般初始安装3个节点（每个LSU虚机安装1个Gbase数据库节点）。当3个节点无法满足日志存储要求时，可对Gbase数据库进行扩容。Gbase数据库最大支持16个节点。 
功能说明 
本功能用于对Gbase数据库进行管理操作，包括安装、卸载和扩容。 
Gbase数据库主要在策略日志功能中使用。策略日志功能需要License支持，对应的License项为“策略日志”，可通过命令[SHOW LICENSE]查询。
Gbase数据库安装后，需要打开数据分析开关[SET DABASE]，策略日志才会写进Gbase数据库。
连接Gbase数据库，需要配置数据库地址，可通过命令[ADD DATABASEIP]配置。数据库地址可通过命令[SHOW VM]查询，虚机类型为LSU的虚机地址为数据库地址。
子主题： 
### GBase安装(GBASE_INSTALL) 
### GBase安装(GBASE_INSTALL) 
功能说明 
该命令用于安装Gbase数据库。 
当需要使用数据分析功能，且Gbase数据库尚未安装时，使用此命令安装Gbase数据库。 
命令执行成功后，将在所有可用的LSU虚机上安装Gbase数据库。Gbase数据库安装成功后，日志模块可以将相关日志信息写入Gbase数据库，以供维护人员查询及分析。 
注意事项 
安装Gbase数据库前，需要完成以下操作: 
 
 通过命令SET DABASE设置数据库密码。 
 
 通过命令SYNA将配置同步到前台。 
 
Gbase安装过程会持续10分钟左右，具体安装结果，可通过命令[SHOW_GBASE_STATUS]查询。当查询结果为正常时，表示Gbase数据库安装成功。
Gbase数据库安装成功后，需要开启相关配置，日志模块才可以将相关日志写入Gbase数据库。 
 
通过命令SET DABASE打开数据分析功能开关。 
 
通过命令ADD DATABASEIP新增Gbase数据库地址。 
 
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|该参数用于表示命令执行返回结果，提示命令是否执行成功。
命令举例 
`
安装gbase数据库。
GBASE_INSTALL
GBASE_INSTALL:
-----------------Npcf_LogStoreUnit_0----------------
执行结果                                         
-------------------------------------------------
Gbase has been installed. No need install again! 
-------------------------------------------------
记录数：1
` 
### GBase卸载(GBASE_UNINSTALL) 
### GBase卸载(GBASE_UNINSTALL) 
功能说明 
小心：该命令属于高危命令，该操作将卸载Gbase数据库，存储在Gbase数据库里的相关日志信息将被删除。因此执行该命令前，需要确保Gbase数据库中存储日志信息已经备份，或都是无用数据，并且需要与中兴通讯技术支持人员确认后才可以实施。 
该命令用于卸载Gbase数据库。 
当不需要Gbase数据库，或需要重新安装Gbase数据库时，可使用此命令。 
命令执行成功后，开始卸载Gbase数据库。可通过命令[SHOW_GBASE_STATUS]查询Gbase数据库是否卸载完成，当查询结果为“未安装”时，表示Gbase数据库已经卸载完成。
注意事项 
命令执行成功后，Gbase数据库存储的日志信息将会丢失，必须谨慎执行。 
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|该参数用于表示命令执行返回结果，提示命令执行是否成功。
命令举例 
`
卸载Gbase数据库。
GBASE_UNINSTALL
(No.3) : GBASE_UNINSTALL:
-----------------Npcf_LogStoreUnit_0----------------
执行结果                                                                                                  
----------------------------------------------------------------------------------------------------------
Now start uninstall GBase! You can use command [SHOW_GBASE_STATUS] to get the result a few minutes later! 
----------------------------------------------------------------------------------------------------------
记录数：1 
` 
### GBase扩容(GBASE_SCALE_OUT) 
### GBase扩容(GBASE_SCALE_OUT) 
功能说明 
小心：该命令属于高危命令，操作过程中会导致数据库停止服务，短时间内日志信息无法入库等问题。操作不当会导致Gbase数据库损坏，数据丢失等问题，甚至需要重新安装Gbase数据库。因此执行该命令前，需要与中兴通讯技术支持人员确认后才可以实施。 
该命令用于扩容数据库节点。 
当现有节点剩余空间不足时，可通过该命令扩容数据库节点，消除磁盘空间不足问题。 
需要按照如下步骤进行扩容。当前步骤执行成功后，才可执行下一步骤，否则会导致数据库扩容失败。 
扩容预处理 
创建新节点 
创建新分布 
数据重分布 
删除旧分布 
扩容步骤全部按顺序执行成功后，可通过命令[SHOW_GBASE_STATUS]查询节点是否扩容成功。
注意事项 
为保证扩容的成功率，并在扩容出错的情况下可快速恢复，将扩容步骤分成了5步，需要按顺序执行，在步骤执行成功后，再执行下一步骤。 
该命令可扩容管理节点和数据节点。但最多可以有3个管理节点，当管理节点已经有3个时，再次扩容管理节点会失败。Gbase节点总数最多16个，当扩容后节点超过16个，扩容失败。 
执行扩容预处理步骤时，必须填写扩容的管理节点、数据节点个数。其他步骤，填写节点个数无效，可不填写。 
该命令是异步命令，执行结果会多包返回，具体执行结果需要在操作记录界面查看。 
输入参数说明 
标识|名称|类型|说明
---|---|---|---
STEP|扩容步骤|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-30|执行扩容的步骤，必须按如下顺序执行。扩容预处理创建新节点创建新分布数据重分布删除旧分布
COORDINATOR|管理节点个数|参数可选性: 任选参数类型: 数字参数范围: 0-1|扩容的管理节点个数。在执行扩容预处理步骤时，参数有效。不填，表示个数为0。
DATA|数据节点个数|参数可选性: 任选参数类型: 数字参数范围: 0-6|扩容的数据节点个数。在执行扩容预处理步骤时，参数有效。不填，表示个数为0。
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-2000|该参数用于表示命令执行过程信息。
命令举例 
`
扩容Gbase数据库，执行扩容预处理步骤，扩容一个管理节点。
GBASE_SCALE_OUT:STEP="SCALE_OUT_PRE",COORDINATOR=1
(No.10) : GBASE_SCALE_OUT:STEP="SCALE_OUT_PRE",COORDINATOR=1
-----------------Npcf_LogStoreUnit_0----------------
正在执行一个异步命令，请到操作记录中查看执行结果
` 
### Gbase服务启停(GBASE_SERVICE_START_STOP) 
### Gbase服务启停(GBASE_SERVICE_START_STOP) 
功能说明 
该命令用于启动或停止Gbase服务。 
当操作LSU虚机（如重启、迁移）时，若Gbase数据库正在写文件，可能造成文件损坏。为了保护数据库，可使用该命令将Gbase数据库服务停止后，再操作LSU虚机。当LSU虚机操作结束后，再使用该命令启动Gbase服务。 
停止Gbase服务成功后，可开始虚机操作。启动Gbase服务成功后，Gbase数据库可以正常工作。 
注意事项 
停止Gbase服务，将导致日志文件无法入库，必须谨慎执行。 
输入参数说明 
标识|名称|类型|说明
---|---|---|---
STATUS|服务状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-1|该参数用于表示启动或停止Gbase服务。启动服务： 启动Gbase服务。停止服务： 停止Gbase服务。
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|结果|参数可选性: 必选参数类型: 字符串参数范围: 0-500|该参数用于显示命令执行的结果。
命令举例 
`
启动Gbase服务。
SET_GBASE_STATUS:STATUS="ENUM_STATUS_START"
` 
### 设置Gbase数据库连接监控(SET_GBASE_CONNECT_MONIT) 
### 设置Gbase数据库连接监控(SET_GBASE_CONNECT_MONIT) 
功能说明 
该命令用于关闭或打开Gbase数据库连接监控。 
当Gbase数据库出现异常，可能导致LOG或LSU服务异常。此时运维人员可使用该命令先关闭监控，确保LOG或LSU服务正常工作。当Gbase数据库恢复正常后，再使用该命令打开监控。  
关闭Gbase数据库连接监控，系统不会监控程序运行。打开Gbase数据库连接监控，系统会监控程序运行，当程序出现死锁等情况时，系统会自动重启容器进行修复。 
注意事项 
关闭Gbase数据库连接监控，此时系统不会监控程序运行，非异常情况下，不要关闭。 
关键配置，命令执行前请先联系中兴通讯进行确认。 
输入参数说明 
标识|名称|类型|说明
---|---|---|---
SWITCH|开关|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 1-2|该参数用于表示Gbase数据库连接监控开关。监控打开： 打开Gbase数据库连接监控。监控关闭： 关闭Gbase数据库连接监控。
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-100|该参数用于显示命令执行的结果。
命令举例 
`
打开Gbase数据库连接监控
SET_GBASE_CONNECT_MONIT:SWITCH="OPEN"
` 
### 重建表索引(GBASE_RECREATE_TABLE_INDEX) 
### 重建表索引(GBASE_RECREATE_TABLE_INDEX) 
功能说明 
该命令用于重建数据库表的索引。 
当虚机重启或者硬盘空间写满时，数据库表的索引有可能会被损坏。如果索引损坏，数据将无法入库，导致数据丢失。需要使用此命令，重建数据库表的索引，恢复数据的正常入库。  
命令执行成功后，数据库表的索引开始重建。 
注意事项 
危险命令，重建索引期间，CPU使用率升高，查询速度变慢，请谨慎执行。 
重建索引，需要较长的时间，请耐心等待。可通过命令 [SHOW_EVENT_PROC_RESULT]查询执行结果。
输入参数说明 
标识|名称|类型|说明
---|---|---|---
TABLENAME|表名称|参数可选性: 必选参数类型: 字符串参数范围: 0-100|该参数用于标识需要重建索引的数据库表名称。
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 必选参数类型: 字符串参数范围: 0-100|该参数用于标识命令执行结果。
命令举例 
`
重建Gbase表“policy_rcp”的索引。
GBASE_RECREATE_TABLE_INDEX:TABLENAME="policy_rcp"
` 
## Gbase维护 
## Gbase维护 
背景知识 
对Gbase数据库进行专业维护，包括查询Gbase状态、加载存储过程。 
功能说明 
本功能用于对Gbase数据库进行专业维护操作，包括查询Gbase状态、加载存储过程、数据库操作。 
查询Gbase状态: 可查询Gbase数据库的状态信息。 
 
加载存储过程：服务升级后，用于加载新的存储过程。 
 
子主题： 
### Gbase状态查询(SHOW_GBASE_STATUS) 
### Gbase状态查询(SHOW_GBASE_STATUS) 
功能说明 
该命令用于查询Gbase数据库安装状态、工作状态、未安装Gbase的LSU虚机。 
当执行安装或卸载Gbase操作后，可以通过该命令查看安装或卸载Gbase数据库是否成功。当Gbase数据正常运行时，可通过该命令查看Gbase各服务运行状态，查看磁盘的使用情况。 
命令执行成功后，可查询到Gbase数据库的安装情况。当Gbase数据库已安装并处于正常工作状态时，可显示Gbase所有节点的状态、磁盘空间等信息。 
注意事项 
无
输出参数说明 
标识|名称|类型|说明
---|---|---|---
HOST|服务器IP|参数可选性: 必选参数类型: 字符串参数范围: 0-100|Gbase数据库安装节点的IP地址， 即LSU虚机的IP地址。
NODE_TYPE|节点类型|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-20|Gbase数据库节点类型。管理节点：部署GCluster和GCware服务组件的Gbase数据库节点。数据节点：只部署GNode服务组件的Gbase数据库节点。
GCLUSTER_STATE|GCLUSTER服务状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase数据库节点部署的GCluster服务的状态。GCluster服务组件负责SQL语句的解析、优化、分布式执行计划生成、执行调度。OPEN：表示服务正常。CLOSE：表示服务异常。
GCWARE_STATE|GCWARE服务状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase数据库节点部署的GCware服务的状态。GCware服务组件负责控制各节点数据一致性。OPEN：表示服务正常。CLOSE：表示服务异常。
GNODE_STATE|GNODE服务状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase数据库节点部署的GNode服务的状态。GNode服务组件是最基本的存储和计算单元。OPEN：表示服务正常。CLOSE：表示服务异常。
CLUSTER_STATUS|集群状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase集群的状态。至少要一半以上的Gbase节点正常工作，Gbase集群才会正常工作，即Gbaes数据库正常对外提供服务。
CLUSTER_MODE|集群模式|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase集群工作模式，为了保证Gbase数据库数据的完整性、一致性，在做备份恢复操作时，需要设置集群模式。NORMAL：正常。 Gbase集群正常工作状态。READONLY：只读。备份Gbase数据时，需要将集群模式设置为READONLY模式。RECOVERY：恢复。 恢复Gbase数据时，需要将集群模式设置为RECOVERY模式。
AVAIL_DISK_SIZE|剩余空间（GB）|参数可选性: 必选参数类型: 数字参数范围: 0-65535|安装目录剩余磁盘空间（GB）。
AVAIL_DISK_PERSENT|剩余空间百分比（%）|参数可选性: 必选参数类型: 数字参数范围: 0-100|安装目录剩余磁盘空间占总磁盘空间的百分比。
STATUS|Gbase状态|参数可选性: 任选参数类型: 枚举，参见枚举定义参数范围: 0-10|Gbase数据库工作状态。未安装：表示当前未安装Gbase数据库。正常：表示Gbase数据库正常工作。异常：表示Gbase数据库访问异常。安装中：表示当前正在安装Gbase数据库。卸载中：表示当前正在卸载Gbase数据库。
ADDINFO|未安装Gbase的节点|参数可选性: 任选参数类型: 字符串参数范围: 0-2000|当前正常工作的LSU虚机，但未安装Gbase。当不存在未安装Gbase数据库的LSU虚机时，该参数不显示。
命令举例 
`
查询Gbase数据库工作状态。
SHOW_GBASE_STATUS
(No.1) : SHOW_GBASE_STATUS:
-----------------Npcf_LogStoreUnit_0----------------
服务器IP       节点类型 GCLUSTER服务状态 GCWARE服务状态 GNODE服务状态 集群状态 集群模式 剩余空间（GB） 剩余空间百分比（%） 
---------------------------------------------------------------------------------------------------------------------------
192.160.236.36 管理节点 OPEN             OPEN           OPEN          ACTIVE   NORMAL   37             93                  
192.160.236.37 管理节点 OPEN             OPEN           OPEN          ACTIVE   NORMAL   37             94                  
192.160.236.38 管理节点 OPEN             OPEN           OPEN          ACTIVE   NORMAL   37             94                  
---------------------------------------------------------------------------------------------------------------------------
记录数：3
Gbase状态 
----------
正常      
----------
记录数：1
` 
### 查询表分布(SHOW_TABLE_DISTRIBUTION) 
### 查询表分布(SHOW_TABLE_DISTRIBUTION) 
功能说明 
该命令用于查询Gbase数据库中表的分布状态。 
当执行Gbase节点扩容或缩容命令时，数据库表里面的数据需要重新分布，使用该命令查询数据库表是否重分布完成。 
命令执行成功后，可查询到数据库中表的分布ID。重分布前和重分布后的ID是不一样的。若所有表的分布ID都是重分布后的ID，则表示数据库表已经重分布完成。 
注意事项 
在有Gbase节点异常情况下，执行该命令可能超时。 请先解决Gbaes节点异常问题。 
输出参数说明 
标识|名称|类型|说明
---|---|---|---
DISID|分布ID|参数可选性: 必选参数类型: 数字参数范围: 0-4294836225|该参数用于表示数据库表的分布ID，可用于标识表的分布信息。查询摘要信息时显示。
TABLENUM|表总数|参数可选性: 必选参数类型: 数字参数范围: 0-4294836225|该参数用于表示有多少张数据库表属于该分布ID。查询摘要信息时显示。
命令举例 
`
查询Gbase数据库中表的分布ID的信息。
SHOW_TABLE_DISTRIBUTION
SHOW_TABLE_DISTRIBUTION
-----------------Npcf_LogStoreUnit_0----------------
分布ID            表总数 
------------------------
1                   10      
2                   5      
------------------------
记录数：2
` 
### 查询表记录数(SHOW_TABLE_COUNT) 
### 查询表记录数(SHOW_TABLE_COUNT) 
功能说明 
该命令用于查询数据库中表存储的记录数。 
当需要查询当前数据库中各表存储的记录数时，通过该命令查看。 
命令执行成功后，可查询到每个数据库表存储的记录数。 
注意事项 
在有Gbase节点异常情况下，执行该命令可能超时。 请先解决Gbaes节点异常问题。 
统计记录数需要消耗一定的时间。 
输入参数说明 
标识|名称|类型|说明
---|---|---|---
TABLETYPE|表类型|参数可选性: 任选参数类型: 枚举，参见枚举定义参数范围: 0-128|该参数用于表示Gbase表的类型。Policy：查询Policy表的个数。Notice： 查询Policy表的个数。Prov： 查询Prov表的个数。Policy_Statistic： 查询Policy统计表的个数。Rule_Statistic： 查询Rule统计表的个数。Other： 查询其他表的个数。
输出参数说明 
标识|名称|类型|说明
---|---|---|---
TABLENAME|表名称|参数可选性: 必选参数类型: 字符串参数范围: 0-40|该参数用于标识数据库表名称。
COUT|记录数|参数可选性: 必选参数类型: 数字参数范围: 0-18445618199572250625|该参数用于标识数据库表存储的记录数。
命令举例 
`
查询Gbase数据库各表的记录数。
SHOW_TABLE_COUNT
(No.1) : SHOW_TABLE_COUNT:
-----------------Npcf_LogStoreUnit_0----------------
表名称           记录数 
------------------------
pcf_status       1      
pcf_version      1      
policy_statistic 0      
rule_statistic   0      
table_count      5      
------------------------
记录数：5
` 
### Gbase加载存储过程(GBASE_LOAD_PROCEDURE) 
### Gbase加载存储过程(GBASE_LOAD_PROCEDURE) 
功能说明 
该命令用于加载存储过程。存储过程：当前版本事先设定好的的一系列SQL执行语句。加载存储过程后，数据库中会创建相应的库、表、定时处理事件。描述存储过程的文件，随版本包发布。当版本变更，存储过程可能会发生改变。 
在服务升级后，若存储过程发生改变，需要执行该命令。版本发布说明里面会说明存储过程是否改变，是否需要执行该命令。 
命令执行成功后，最新的存储过程将被加载到Gbase数据库，相应的库、表、定时处理事件等创建、修改命令，会在Gbase数据库执行。 
该命令只有在服务升级后第一次执行有效，后续执行无效。 
注意事项 
无
输出参数说明 
标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|该参数用于表示命令执行返回结果，提示命令执行是否成功。
命令举例 
`
加载存储过程。
GBASE_LOAD_PROCEDURE
(No.2):GBASE_LOAD_PROCEDURE:
-----------------Npcf_LogStoreUnit_0----------------
执行结果
----------------------
load procedure succ.
----------------------
记录数：1
` 
### 查询Event触发器执行结果(SHOW_EVENT_PROC_RESULT) 
### 查询Event触发器执行结果(SHOW_EVENT_PROC_RESULT) 
功能说明 
该命令用于查询事件触发器的执行结果。 
Gbase预先定义了很多存储过程，LOG服务可以通过事件，触发预定义的存储过程。当事件创建成功后，Gbase开始执行存储过程，LOG服务无需关心具体的执行过程及结果。  
命令执行成功后，可以显示事件的执行是否成功，及开始结束时间。 
注意事项 
该命令最多显示100条记录。 
输出参数说明 
标识|名称|类型|说明
---|---|---|---
EVENT|事件名称|参数可选性: 必选参数类型: 字符串参数范围: 0-31|该参数用于标识事件名称，事件一般由LOG服务创建，每个事件只会调用相对应的存储过程。
RESULT|执行结果|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-3|该参数用于标识事件执行成功与否。
STARTTIME|开始时间|参数可选性: 必选参数类型: 字符串参数范围: 0-21|该参数用于标识事件执行的开始时间。
ENDTIME|结束时间|参数可选性: 必选参数类型: 字符串参数范围: 0-21|该参数用于标识事件执行的结束时间。
命令举例 
`
查询事件触发器执行结果。
SHOW_EVENT_PROC_RESULT
(No.1) : SHOW_EVENT_PROC_RESULT:
-----------------PCF_236/Npcf_LogStoreUnit_0----------------
事件名称           执行结果 开始时间            结束时间            
--------------------------------------------------------------------
recreate_index     成功     2021-12-07 19:55:58 2021-12-07 19:55:58 
recreate_index     成功     2021-12-07 19:54:53 2021-12-07 19:54:53 
recreate_index     成功     2021-12-07 19:47:15 2021-12-07 19:47:15 
recreate_index     成功     2021-12-07 19:41:48 2021-12-07 19:41:49 
del_useless_record 成功     2021-12-07 03:00:01 2021-12-07 03:00:02 
rule_statis_day    成功     2021-12-07 01:00:04 2021-12-07 01:00:05 
policy_statis_day  成功     2021-12-07 01:00:01 2021-12-07 01:00:04 
--------------------------------------------------------------------
记录数：7
` 
