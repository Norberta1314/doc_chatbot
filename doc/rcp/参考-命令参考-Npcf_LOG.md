# 专业维护 
# 专业维护 


[](None)背景知识 


PCF网元支持将系统策略的执行情况以日志文件格式记录，并对日志数据进行分析生成报表，或者将日志文件传输给第三方日志分析系统。 

Npcf_LOG服务提供PCF网元的日志数据采集功能和数据分析功能： 


 
日志数据采集功能：将生成的日志文件，对外提供给第三方日志分析系统。日志文件包括用量日志、事件日志、策略日志、业务历史日志、事件日志、 规则配置日志、用量穿越日志、传输记录日志。 

 
日志数据分析功能：将生成的日志数据，存入数据库，按要求进行数据分析生成报表。报表文件包括策略/规则映射报表、策略统计报表和规则统计报表。 

 




[](None)功能说明 


该功能用于LOG服务的管理和维护。 

当需要对业务内部统计信息进行采集，获取业务内部运行状态时使用[SHOW_STAT](../mml/1137003.html)命令。

当调试、测试或故障定位过程中，需要对日志、报表或SFTP传输记录文件进行上传、移除时，使用日志信息管理命令集。 




[](None)子主题： 






## 内部统计 
## 内部统计 


[](None)背景知识 


PCF网元内部统计记录了应用内部业务流程的执行情况，例如流程执行总次数、成功次数、失败次数。 

内部统计可以按照区分业务SC或者汇总的方式进行导出，用于业务运行状态检查和故障分析。 

通过获取LOG服务内部统计信息，可以对其内部运行状态进行快速检查。 




[](None)功能说明 


该功能用于采集LOG服务内部统计。 

当需要对业务内部统计信息进行采集，获取业务内部运行状态时使用该命令。 




[](None)子主题： 






### 查询统计(SHOW_STAT) 
### 查询统计(SHOW_STAT) 


[](None)功能说明 

该命令用于查询系统模块统计。
工程或者运维人员可以通过该命令定期检查系统运行状态是否正常。


[](None)注意事项 

无。


[](None)输入参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
LogicNo|SC逻辑编号|参数可选性: 任选参数类型: 数字参数范围: 0-65535|用于选择查询的SC的LogicNO。 不填默认查询所有SC统计之和。
InstNo|进程实例号|参数可选性: 任选参数类型: 数字参数范围: 0-16|该参数用于表示需要查询模块信息的进程实例号，填0或者不填时代表查询所有实例的模块统计信息。




[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
STATINFO|统计信息|参数可选性: 任选参数类型: 字符串参数范围: 0-30000|该参数用来表示各个模块的业务和失败统计。




[](None)命令举例 


`
查询逻辑号为1，进程实例号为1的的业务统计信息。
SHOW_STAT:LOGICNO=1,INSTNO=1

-----------------Npcf_SMPolicyControl_0----------------
统计信息
N7_STAT_REQ_PREPROC_SUCC                1       
N7_STAT_GET_POLICY_CHK_MSG_SUCC         1       
N7_STAT_GET_POLICY_CHK_SESS_DUP_SUCC    1       
N7_STAT_GET_POLICY_CREATE_SESS_SUCC     1       
N7_STAT_GET_POLICY_MAKE_SEND_CCA_SUCC   1       
N7_STAT_GET_NOTIFY_DEC_SUCC             1       
N7_STAT_HTTP_RECV_REQ_MSG               1       
记录数：1

` 


## 日志信息管理 
## 日志信息管理 


[](None)背景知识 


Npcf_LOG服务通过SFTP（Secure File Transfer Protocol，安全文件传输协议）对外提供日志文件或报表文件。 

当启用日志数据采集功能时，PCF支持以SFTP服务端和SFTP客户端两种方式对外提供日志数据文件。作为SFTP服务端时，将日志文件放入SFTP服务器根目录，供外部应用访问；作为SFTP客户端时，将日志文件，放入对接SFTP服务器的指定目录。 

当启用日志数据分析功能时，PCF既作为客户端，又作为SFTP服务器。正常情况下，PCF将生成的报表文件，放入对接SFTP服务器的指定目录。文件上传失败时，通过消息通知对端，作为SFTP服务器对外提供报表文件。 

调试、测试和故障定位过程中，需要对日志和报表文件的传输过程进行控制。 




[](None)功能说明 


该功能功能用于控制日志、报表和SFTP传输记录文件的传输过程。 

当调试，测试或故障定位过程中，需要对日志、报表或SFTP传输记录文件进行上传、移除时，使用该命令集合。 


 
当需要关闭所有日志文件时，使用CLOSE LOGFILE命令。 

 
当需要删除指定时间之前的日志文件时，使用DELETE LOGFILE命令。 

 
当需要重新加载上传文件时，使用RELOAD_ULFILE命令。 

 
当需要查询SFTP传输相关信息时，使用SHOW_UPLOAD_INFO命令。 

 
当需要关闭SFTP传输记录文件时，使用CLOSE_SFTP_TRANS_LOG命令。 

 




[](None)子主题： 






### 关闭所有文件(CLOSE LOGFILE) 
### 关闭所有文件(CLOSE LOGFILE) 


[](None)功能说明 

该命令用于关闭正在写入的所有日志文件。 

当需要立即生成日志文件进行采集功能测试时，无需等待日志文件达到[SHOW POLICYLOG](../mml/unknownCmdCode.html) 配置中的文件大小，以快速获取日志文件，进行日志采集功能测试。

文件关闭成功后，会立即进行压缩，生成日志文件，使用SFTP上传。 


[](None)注意事项 


 
执行该命令前，应确保已经启用了策略日志功能， 配置查询命令为： SHOW SYS GLOBPARA DETAIL:BEGIN=1044,END=1050,EXTFLAG=1。 

 
确保日志SFTP客户端的IP地址、端口配置正确，配置查询命令SHOW LOGSFTPCLT。 

 
确保对端SFTP服务器的IP地址、端口、账户、密码配置正确，配置查询命令SHOW LOGSFTPSRV。 

 


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|命令执行结果，输出文本提示关闭文件是否成功。




[](None)命令举例 


`
环境部署单个LOG服务实例，关闭正在写入的所有日志文件。
CLOSE LOGFILE:

(No.1) : CLOSE LOGFILE:
-----------------Npcf_LOG_0----------------
执行结果                                          
--------------------------------------------------
SC LogicNo: 1
    Successfully closed open files! 
--------------------------------------------------
记录数：1

` 


### 删除指定时间之前的日志文件(DELETE LOGFILE) 
### 删除指定时间之前的日志文件(DELETE LOGFILE) 


[](None)功能说明 

小心：该命令属于高危命令，该操作将删除日志文件，删除后不可恢复。非测试场景下，若要执行该命令，需要与中兴通讯技术支持人员确认后才可以实施。 

该命令用于删除指定时间之前的日志文件，无需等待[SHOW POLICYLOG](../mml/unknownCmdCode.html)配置中的文件保存周期。

该命令不会删除传输记录日志文件。 

当测试过程中，需要清理日志文件时，使用该命令。 

命令执行成功后，会完全删除指定时间之前的所有日志文件。 


[](None)注意事项 


 
该命令仅限于测试场景下使用，执行成功后，文件不可恢复。 

 
当存在SFTP文件上传失败告警时，应谨慎考虑执行该命令。 

 
对于重要文件，在删除文件之前，确保文件已成功上传。 

 
该命令入参是需要删除的结束时间，在结束时间之前生成的日志文件，都会被删除。 

 


[](None)输入参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
TIME|时间|参数可选性: 必选参数类型: 字符串|指定需要删除日志文件的结束时间。该时间之前（包括该时间点）产生的所有日志文件都会被删除。




[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|命令执行返回结果，输出文本提示删除文件是否成功。




[](None)命令举例 


`
环境部署单个LOG服务实例，删除2021年1月1日0点0分0秒之前的日志文件。
DELETE LOGFILE:TIME="2021-01-01 00:00:00"

(No.1) : DELETE LOGFILE:TIME="2021-01-01 00:00:00"
-----------------Npcf_LOG_0----------------
执行结果                                  
------------------------------------------
SC LogicNo: 1
    Delete LogFile Success! 
------------------------------------------
记录数：1

` 


### 重新加载上传文件(RELOAD_ULFILE) 
### 重新加载上传文件(RELOAD_ULFILE) 


[](None)功能说明 

该命令用于将待上传的日志或报表文件重新加入SFTP的上传队列。使用日志数据采集功能时，上传日志文件；启用日志数据分析功能时，上传报表文件。 

当存在文件传输失败，触发SFTP上传失败告警，需要再次上传文件，进行问题分析时，执行此命令。 

命令执行成功后，会将未成功上传的日志或报表文件重新加入SFTP的上传队列，等待SFTP传输。 


[](None)注意事项 


 
文件实际开始上传的时间，取决于配置的上传扫描间隔。 

 
使用日志数据采集功能时，采用SHOW POLICYLOG 配置的上传服务器时间间隔。 

 
使用日志数据分析统计功能时，采用SHOW DAPEERSFTPSRV 配置的扫描间隔。 

 


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|命令执行返回结果，输出文本提示文件加载是否成功。




[](None)命令举例 


`
环境部署单个LOG服务实例，重新加载待上传文件。
RELOAD_ULFILE:

(No.1) : RELOAD_ULFILE:
-----------------Npcf_LOG_0----------------
执行结果                                         
-------------------------------------------------
SC LogicNo: 1
    Reload upload LogFile success! 
-------------------------------------------------
记录数：1

` 


### 查询上传相关信息(SHOW_UPLOAD_INFO) 
### 查询上传相关信息(SHOW_UPLOAD_INFO) 


[](None)功能说明 

该命令用于查询SFTP传输信息，包括对端SFTP服务器数目、使用的SFTP服务器配置ID、本端SFTP服务器启动情况、SFTP客户端端口等信息。 

当需要查询SFTP客户端配置、SFTP服务端配置是否生效，SFTP传输过程是否正常时，使用此命令。 


[](None)注意事项 

无。


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
LOG_FUNC|LOG启用功能|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-20|该参数用于显示LOG服务启用的功能。日志功能：将系统策略的执行情况以日志文件格式记录，将日志文件传输到指定SFTP服务器。报表功能：对日志数据进行分析生成报表，将报表文件传输至指定服务器。
SC_LOGICNO|业务SC逻辑编号|参数可选性: 必选参数类型: 数字参数范围: 0-65535|该参数用于显示查询结果的实例编号。
LOC_SFTP_SERVER|本地SFTP服务器IP|参数可选性: 必选参数类型: 字符串参数范围: 0-100|该参数用于显示本地SFTP服务器配置的IP地址。
LOC_SERVER_STATUS|本地服务器状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-20|该参数用于显示本地SFTP服务器的服务状态。不可用：无可用SFTP服务器。启动成功：SFTP服务正常。启动失败：SFTP服务异常。
LOC_SFTP_CLIENT|SFTP客户端IP|参数可选性: 必选参数类型: 字符串参数范围: 0-100|该参数用于显示本地SFTP客户端配置的IP地址。
SFTP_CLIENT_PORT|客户端端口号|参数可选性: 必选参数类型: 数字参数范围: 0-65535|该参数用于显示本地SFTP客户端使用的端口号。
SFTP_CLIENT_STATUS|客户端状态|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 0-20|该参数用于显示SFTP客户端的工作状态。不可用：无本地客户端配置。启动成功：客户端工作正常。启动失败：客户端工作异常。未启用：客户端暂未启用。
PEER_SEVER_NUM|对端SFTP服务器数量|参数可选性: 必选参数类型: 数字参数范围: 0-5|该参数用于显示对端SFTP服务器的数量。
USED_SERVER_ID|使用的对端服务器编号|参数可选性: 必选参数类型: 数字参数范围: 0-65535|该参数用于显示LOG服务使用的对端SFTP服务器编号。
USED_SERVER_IP|对端服务器IP|参数可选性: 必选参数类型: 字符串参数范围: 0-100|该参数用于显示LOG服务使用的对端SFTP服务器IP地址。




[](None)命令举例 


`
PCF部署单个LOG服务实例，使用LOG的日志采集功能，查询文件上传相关信息。
SHOW_UPLOAD_INFO:

(No.1) : SHOW_UPLOAD_INFO:
-----------------Npcf_LOG_0----------------
LOG启用功能 业务SC逻辑编号 SFTP本地服务器IP 本地服务器状态 SFTP客户端IP  客户端端口号 客户端状态 对端SFTP服务器数量 使用的对端服务器编号 对端服务器IP  
-------------------------------------------------------------------------------------------------------------------------------------------------------
报表功能    1              10.228.36.12     启动成功       10.228.96.124 0            启动失败   1                  0                    192.162.123.3 
-------------------------------------------------------------------------------------------------------------------------------------------------------
记录数：1
执行成功开始时间:2021-05-21 09:29:38 耗时: 0.318秒

` 


### 关闭SFTP上传结果文件(CLOSE_SFTP_TRANS_LOG) 
### 关闭SFTP上传结果文件(CLOSE_SFTP_TRANS_LOG) 


[](None)功能说明 

该命令用于关闭SFTP上传结果记录文件，并上传至配置的SFTP服务器。 

当需要立即获取SFTP上传结果记录文件时，可以使用此命令。 

传输结果记录文件在每天凌晨关闭，使用此命令可立即关闭文件，进行SFTP传输。 


[](None)注意事项 


 
该命令属于调试命令，非测试场景下，不要执行该命令。 

 
启用数据分析功能时，上传结果文件只记录报表文件传送结果，不会将该文件上传至对端服务器。 

 
启用日志数据采集功能时，上传结果文件只记录日志文件传送结果，确保日志SFTP客户端的IP地址、端口配置正确，配置查询命令SHOW LOGSFTPCLT；对端SFTP服务器的IP地址、端口、账户、密码配置正确，配置查询命令SHOW LOGSFTPSRV。 

 
启用日志数据采集功能时，文件实际开始上传的时间，取决于配置的上传扫描间隔，使用日志数据采集功能时，采用SHOW POLICYLOG查询到的“上传服务器时间间隔（分）”。 

 


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|命令执行返回结果，输出文本提示SFTP上传结果记录文件是否关闭成功。




[](None)命令举例 


`
环境部署单个LOG服务实例，关闭文件传输记录文件。
CLOSE_SFTP_TRANS_LOG:

(No.1) : CLOSE_SFTP_TRANS_LOG:
-----------------Npcf_LOG_0----------------
执行结果                                             
-----------------------------------------------------
SC LogicNo: 1
    close sftp trans log file success! 
-----------------------------------------------------
记录数：1

` 


### 设置Gbase数据库连接监控(SET_GBASE_CONNECT_MONIT) 
### 设置Gbase数据库连接监控(SET_GBASE_CONNECT_MONIT) 


[](None)功能说明 

该命令用于关闭或打开Gbase数据库连接监控。 

当Gbase数据库出现异常，可能导致LOG或LSU服务异常。此时运维人员可使用该命令先关闭监控，确保LOG或LSU服务正常工作。当Gbase数据库恢复正常后，再使用该命令打开监控。  

关闭Gbase数据库连接监控，系统不会监控程序运行。打开Gbase数据库连接监控，系统会监控程序运行，当程序出现死锁等情况时，系统会自动重启容器进行修复。 


[](None)注意事项 

关闭Gbase数据库连接监控，此时系统不会监控程序运行，非异常情况下，不要关闭。 

关键配置，命令执行前请先联系中兴通讯进行确认。 


[](None)输入参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
SWITCH|开关|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 1-2|该参数用于表示Gbase数据库连接监控开关。监控打开： 打开Gbase数据库连接监控。监控关闭： 关闭Gbase数据库连接监控。




[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-100|该参数用于显示命令执行的结果。




[](None)命令举例 


`
打开Gbase数据库连接监控
SET_GBASE_CONNECT_MONIT:SWITCH="OPEN"

(No.1) : SET_GBASE_CONNECT_MONIT:SWITCH="OPEN"
-----------------Npcf_LOG_0----------------
执行结果           
-------------------
Set gbase connect monit succ! 
-------------------
记录数：1

` 


## 令牌信息管理 
## 令牌信息管理 


[](None)背景知识 


Npcf_LOG服务在生成业务日志后需要及时写入数据库进行持久化。 

当日志服务生成日志文件后，会周期性向数据库请求将日志文件入库。由于数据库针对同一张表是串行访问，所以需要给入库的请求分配令牌。只有该日志服务实例获取到令牌时才能具备访问数据库的权限。 




[](None)功能说明 


该命令集用于查询当前系统令牌分配及运行情况，并提供了启停令牌功能的功能。 

运维人员在调试，测试或故障定位过程中，可以使用该命令集合对令牌运行情况进行查询。 


 
当需要关闭令牌功能时，使用CLOSE_LOG_TOKEN命令。 

 
当需要查询当前令牌管理的节点信息时，使用SHOW_LOG_TOKEN_NODE命令。 

 
当需要查询当前令牌分配情况时，使用SHOW_LOG_TOKEN_INFO命令。 

 




[](None)子主题： 






### 关闭令牌(CLOSE_LOG_TOKEN) 
### 关闭令牌(CLOSE_LOG_TOKEN) 


[](None)功能说明 

该命令用于启用或者关闭令牌功能。 

当令牌功能出现异常时，可以执行该命令关闭令牌功能。当令牌功能恢复正常后，可以执行该命令启用令牌功能。 

令牌功能成功后，各个实例访问数据库将不受令牌限制。 


[](None)注意事项 

无。 


[](None)输入参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
SWITCH|开关|参数可选性: 必选参数类型: 枚举，参见枚举定义参数范围: 1-2|该标识用来控制是启动还是关闭令牌功能。关：表示关闭令牌功能开：表示启用令牌功能




[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
RESULT|执行结果|参数可选性: 任选参数类型: 字符串参数范围: 0-128|命令执行结果，输出文本提示关闭令牌功能是否成功。




[](None)命令举例 


`
启用令牌功能。
CLOSE_LOG_TOKEN:

(No.1) : CLOSE_LOG_TOKEN:SWITCH="OPEN"
-----------------PCF_197/Npcf_LOG_0----------------
执行结果                                         
-----------------------------------------------
LogicNo[1]: Set Log Token Switch Successfully! 
LogicNo[2]: Set Log Token Switch Successfully! 
-----------------------------------------------
记录数:2

` 


### 查询令牌节点(SHOW_LOG_TOKEN_NODE) 
### 查询令牌节点(SHOW_LOG_TOKEN_NODE) 


[](None)功能说明 

该命令用于查询令牌管理的节点信息。 

当文件入库出现阻塞时，运维人员可使用该命令查询当前各个令牌管理节点信息。  

命令执行成功后， 会返回当前系统令牌节点总个数，活动令牌个数等信息。 


[](None)注意事项 

无。 


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
SWITCH|开关|参数可选性: 必选参数类型: 枚举，参见枚举定义|该参数用于表示当前系统是否开启令牌功能。
POS|游标|参数可选性: 必选参数类型: 数字|该参数用于表示当前使用到了哪个令牌。
ACTIVE_NODE|活动令牌|参数可选性: 必选参数类型: 数字|该参数用于表示当前系统一共有多少个活动令牌。
TOTAL_NODE|令牌总数|参数可选性: 必选参数类型: 数字|该参数用于表示当前系统一共分配了多少个令牌。




[](None)命令举例 


`
查询令牌管理的节点信息。
SHOW_LOG_TOKEN:

(No.1) : SHOW_LOG_TOKEN_NODE:
-----------------Npcf_LOG_0----------------
开关 游标 活动令牌 令牌总数
开     1        1              2
记录数：1

` 


### 查询令牌信息(SHOW_LOG_TOKEN_INFO) 
### 查询令牌信息(SHOW_LOG_TOKEN_INFO) 


[](None)功能说明 

该命令用于查询服务各个实例的令牌信息。 

当文件入库出现阻塞时，运维人员可使用该命令查询当前各个实例的令牌信息，检查令牌分配是否出现异常。  

命令执行成功后，系统返回当前系统令牌分布情况。 


[](None)注意事项 

无。 


[](None)输出参数说明 


[](None)标识|名称|类型|说明
---|---|---|---
LOGIC_NO|逻辑号|参数可选性: 必选参数类型: 数字|该参数用于表示上报实例的逻辑号信息。
TOKEN_STAT|令牌状态|参数可选性: 必选参数类型: 枚举，参见枚举定义|该参数用于表示上报实例的令牌状态信息。空闲：当前实例未获取到令牌。激活：当前实例获取到令牌。
TOKEN_LIFE|在线时间戳|参数可选性: 必选参数类型: 数字|该参数用于表示上报实例的令牌在线时长信息。
TOKEN_TMT|超时时间戳|参数可选性: 必选参数类型: 数字|该参数用于表示上报实例的令牌超时时长信息。




[](None)命令举例 


`
查询服务的令牌信息。
SHOW_LOG_TOKEN:

(No.2) : SHOW_LOG_TOKEN_INFO:
-----------------Npcf_LOG_0----------------
逻辑号 令牌状态 在线时间戳  超时时间戳
2         激活       691486614 691486609
1         空闲       691486614 691486609
记录数：2

` 


