# 特性指导 
## 特性说明 
### RCP特性说明 
#### 特性的概念 
特性是满足客户特定商业价值诉求的端到端解决方案。特性是客户视角的概念，是可定价、可购买的功能或功能的集合。 
功能是产品视角的概念，是产品实现的基本要素。 
#### 特性的分类 
特性分为基本特性和可选特性。 
基本特性是随产品的基本软件包销售的特性，不单独收费。客户购买基本软件包后，即可部署和使用基本特性。 
可选特性可供客户选择购买，不随基本软件包销售，需要单独收费。客户需要购买可选软件包后，才能部署和使用可选特性。部分可选特性由对应的License项控制。只有购买该特性对应的License，才能使用和部署该特性。特性所对应的License项参见“License描述”中的“License控制项”。 
#### 特性的部署 
当运维人员完成ZXUN RCP的互联互通及基本业务开通后，可以继续阅读“特性指导
”文档，了解产品特性的概念、原理，并完成特性的部署。
## 缩略语 
## 缩略语 
### AF 
Application Function应用功能
### APN 
Access Point Name接入点名称
### CDB 
Cloud Database云数据库
### CPE 
Customer Premises Equipment用户驻地设备
### CTS 
Call Trace System呼叫跟踪系统
### EMS 
Element Management System网元管理系统
### FUP 
Fair Usage Policy公平使用策略
### IPv4 
Internet Protocol Version 4互联网通信协议第四版
### IPv6 
Internet Protocol Version 6互联网通信协议第六版
### MCPTT 
Mission Critical Push To Talk关键任务一键通
### MPS 
Multimedia Priority Service多媒体优先业务
### NFV 
Network Functions Virtualization网络功能虚拟化
### NSA 
Non-Standalone5G非独立组网
### PDU 
Packet Data Unit分组数据单元
### PRA 
Presence Reporting Area出现上报区域
### QoS 
Quality of Service服务质量
### RAT 
Radio Access Technology无线接入技术
### SOAP 
Simple Object Access Protocol简单对象访问协议
### SPR 
Subscription Profile Repository用户签约数据库
### TDF 
Traffic Detection Function流量检测功能
### UDSF 
Unstructured Data Storage Function非结构化数据存储功能
### UE 
User Equipment用户设备
### VNF 
Virtualized Network Function虚拟化网络功能
### VoLTE 
Voice over LTELTE语音
### VoNR 
Voice over New Radio新空口承载语音
### VoWiFi 
Voice over WiFi基于WiFi的语音业务
## 接口类特性 
### FL-07-01-001 HTTP信令路由 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
URI|统一资源标识符，用于标识服务化系统资源。
SCP|服务通讯代理，转发HTTP服务化消息至目标网元。
服务提供者|在5G服务化架构中向外暴露服务化调用接口，供其他网元使用服务的网元。特别的，在订阅-通知类型的服务中，接收订阅、发送通知的一方为服务提供者。
服务使用者|调用服务提供者所提供的服务的网元。特别的，在订阅-通知类型的服务中，发起订阅、接收通知的一方为服务使用者。
客户端|发送HTTP请求消息的一方称为客户端。客户端不一定为服务使用者，如在订阅-通知服务中。
服务器|发送HTTP响应消息的一方称为服务器。服务器不一定为服务提供者，如在订阅-通知服务中。
##### 描述 
####### 特性定义 
ZXUN RCP的HTTP信令路由功能，提供了HTTP连接管理、HTTP信令路由寻址等功能。
5G服务化组网时，ZXUN RCP和各网元间主要通过HTTP信令进行信息交互，在信令交互过程中会涉及到HTTP信令链路及路由特性。
本特性包括如下功能： 
支持HTTP/HTTPS静态链路管理。 
支持HTTP/HTTPS动态链路管理。 
支持同一会话的链路保持。 
支持直连静态路由寻址。 
支持直连动态路由寻址。 
支持相同优先级负荷分担路由。 
支持主备路由。 
支持消息重路由发送，包括超时重路由和根据对端错误码重路由。 
支持SCP C模式路由。 
支持SCP D模式路由。 
支持SCP Proxy模式路由。 
支持在N7/N15接口对双网络平面AMF/SMF接入。 
####### 背景知识 
5G核心网网元之间通过服务化接口进行交互，服务化接口协议栈如[图1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new12796aa567714cc1b4a7e0af90e25334__d2d4568e-0f5a-4208-9a67-5343d74b0c06)所示。
图1  协议栈
[]images/image.png)
5G服务化接口基础协议采用HTTP/2（即HTTP 2.0版本，参见RFC 7540）。服务化接口传输层协议仅采用TCP协议。当要求启用传输层安全时，通过TLS进行传输层保护。 
HTTP信令路由主要包括两部分： 
HTTP连接管理HTTP链路提供信息交互的可靠通道，HTTP链路承载于TCP或TLS承载链路之上，因而属于可靠传输。ZXUN RCP和其它网元交互时，将应用消息以HTTP信令方式通过HTTP链路进行收发。为了提升ZXUN RCP和对端网元间的HTTP信令吞吐量，同时提升HTTP链路的高可靠性，ZXUN RCP支持和同一个对端网元以负荷分担方式建立多条HTTP链路。当一条HTTP链路中断时，ZXUN RCP能尝试在其它HTTP链路上发送业务消息。  
HTTP信令路由寻址当ZXUN RCP在某些业务信令接口主动创建会话，进行业务信令寻址时，需要使用HTTP路由功能，即根据服务类型、号码、优先级等参数进行路由寻址，并发送业务消息到对端。当ZXUN RCP向对端请求消息，超时无应答或收到协议故障类错误时，能在配置的重发次数内，重选其它HTTP链路进行消息重发。 
ZXUN RCP支持3GPP协议规定的四种路由通信模式和运营商指定Proxy路由模式，参见[表1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new12796aa567714cc1b4a7e0af90e25334__436627d8-e402-4692-a519-550318d86f22)和[图2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new12796aa567714cc1b4a7e0af90e25334__7f3adef8-360d-470a-b628-cbcee6dacd45)。
服务使用者与服务提供者通信方式|服务发现和路由请求|通信模型
---|---|---
直接通信（直接路由）|无NRF或SCP。|A
使用NRF服务发现，无SCP。|直接通信（直接路由）|B
间接通信（通过SCP路由）|使用NRF服务发现，选择集合中的特定实例作为目的NF，通过SCP发送请求消息给目的NF。。|C
根据服务请中的参数选择代理SCP，通过SCP发现和选择路由请求到目的NF。|间接通信（通过SCP路由）|D
为了兼容4G路由使用习惯，运营商定制要求SCP Proxy模式实现类似4G DRA路由功能。在业务发送请求给SCP后，SCP根据业务请求参数配置路由到目的NF。|间接通信（通过SCP路由）|Proxy
图2  四种路由通信模式
[]images/1.png)
模型A - 无NRF的直接通信既没有NRF也没有SCP。服务使用者配置服务提供者的“NF profiles”，直接选择一个服务提供者进行通信。 
模型B - 有NRF的直接通信服务使用者通过查询NRF发现。基于发现结果，服务使用者发送请求到选择的服务提供者。 
模型C - 无需代理发现的间接通信服务使用者通过查询NRF发现。基于发现结果，服务使用者选择NF集合或NF集合特定实例的服务提供者，服务使用者发送请求到SCP，该SCP能转发请求到前述选定的服务提供者。请求到了SCP后，如果是一个NF实例集合，SCP可选择一个NFS实例进行消息路由。如果有可能，SCP与NRF交互获取选择参数，如位置、容量等。SCP路由该请求到选定的NF服务提供者实例。 
模型D - 有代理发现的间接通信服务使用者不做服务发现和选择。为了将请求发送到合适的服务提供者，服务使用者增加所有必须的发现和选择参数。SCP使用请求地址和请求中的发现选择参数，路由该请求到合适的服务提供者实例处理。SCP通过NRF做服务发现，并获取到发现结果。 
在5GC系统中，对于模式C、D、Proxy，ZXUN RCP有两类请求消息通过SCP路由寻址：
ZXUN RCP主动发送请求消息时，通过SCP来路由寻址CHF、UDR和BSF。 
ZXUN RCP反向发送通知请求消息时，通过SCP来路由寻址AMF、SMF和NEF/AF。 
##### 应用场景 
ZXUN RCP可根据主机IP或FQDN寻址目标NF，HTTP信令路由功能主要包括如下应用场景：
ZXUN RCP与目标NF组网是直连组网（A模式），与目标NF间建立多条链路支持信令负荷分担。 
ZXUN RCP与目标NF组网是直连组网（A模式），目标NF存在备用NF时支持信令主备。 
ZXUN RCP与目标NF组网是直连组网（B模式），通过NRF发现多个目标NF，在多个目标NF间支持信令负荷分担。 
ZXUN RCP与目标NF组网是直连组网（B模式），通过NRF发现多个目标NF，在多个目标NF间支持信令主备。 
ZXUN RCP与目标NF组网是非直连组网（C模式），可通过SCP_C模式进行代理转发。 
ZXUN RCP与目标NF组网是非直连组网（D模式），可通过SCP_D模式进行代理转发。 
ZXUN RCP与目标NF组网是非直连组网（Proxy模式），可通过SCP_Proxy模式进行代理转发。 
##### 客户收益 
对运营商和用户的收益说明参见[表2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new6a4d8b29094c4a2ca55bc30ae2e87339__XXX%E7%89%B9%E6%80%A7%E6%94%B6%E7%9B%8A%E8%AF%B4%E6%98%8E-486D0F21)。
收益方|收益说明
---|---
运营商|可根据运营组网规划，通过信令路由功能部署相关网元，节省网络资源。
终端用户|用户业务通过信令路由快速寻址目标网元，业务体验流畅。
##### 实现原理 
###### 系统架构 
ZXUN RCP在5G核心网中位置如[图3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zc61f0a8a77d34b86b30e63f17602f5bb__20bd3281-f3eb-4462-9d09-704d5defdbab)所示。
作为服务使用者，以客户端角色使用HTTP信令路由，主要与BSF、UDR、CHF等核心网网元交互，根据运营规划，通过静态配置或动态NRF发现来实现路由寻址。 
作为服务提供者，反向发送请求时，以服务使用者的通知URI来直接寻址。 
图3  5G核心网组网
[]images/1627261641722.png)
基于SA架构的服务通信代理（SCP）的非直连网络架构如[图4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zc61f0a8a77d34b86b30e63f17602f5bb__cb743cc4-bb8a-4e92-bdde-70bcca26efe9)所示。
图4  非直连网络架构
[]images/2.png)
其中： 
SCP按大区部署。 
大区内各网元间采用直接的方式直接通讯（如图4中黑色连接线所示）。 
大区间各网元间通信通过SCP进行间接通讯（如图4中蓝色连接线所示）。 
###### 各网元作用 
涉及的网元及其功能参见[表3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf55ad5a929f7432f96614da60ed83630__7b1b0539-5744-4789-9cfc-edbbf2d0cc42)。
网元|描述
---|---
RCP|向SMF提供SM（Session Management）策略，并订阅相关事件。
SMF|执行RCP提供的SM策略，向RCP上报相关事件。
CHF|维护RCP的订阅信息，向RCP提供策略计费信息的查询接口及状态变更的通知。
BSF|维护RCP绑定信息，提供RCP绑定信息的注册、更新、去注册、查询接口。
UDR/SPR|向RCP提供策略签约信息，并允许RCP将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
###### 协议栈 
ZXUN RCP与周边网元的服务化接口都以HTTP/2为承载，以ZXUN RCP和SMF间的N7接口为例（其它接口类似），其协议栈如[图5](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z854e177e80024464af12fc5da2fba686__7d739bdd-075a-445d-b492-0d8afb1ce1ae)所示。
协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。 
图5  协议栈
[]images/1627261813486.png)
###### 业务流程 
####### RCP为服务提供方的业务流程 
RCP为服务提供方时，通过N5、N7、N15接口与AF/NEF、SMF、AMF交互。目前现场实际组网中，N5、N7、N15接口消息一般通过SCP转发至AF/NEF、SMF、AMF。 
下面以N7接口为例，描述RCP作为服务提供方的业务流程，其它接口类似。 
######### 直连场景（B模式） 
RCP为服务提供方，直连场景（B模式）下的业务流程如[图6](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7c299b0774db4013b3c5ff429af049a6__596b0eae-7693-46dc-9ac3-e57d5abcb3e7)所示。
图6  B模式业务流程
[]images/1627262546242.png)
流程说明如下： 
RCP上电后，向NRF注册本NF、服务的相关信息，包括FQDN、IP、优先级、版本号等信息。 
NRF返回注册成功，服务使用者可根据RCP提供信息寻址到RCP。 
SMF收到PDU会话创建请求，若本地没有RCP的服务发现缓存，向NRF获取SM策略服务的相关信息。 
（可选）SMF通过服务实例号、号段等信息向NRF查询SM策略服务地址。 
（可选）NRF将注册的RCP信息返回给SMF。 
SMF构造PDU会话信息，从NRF返回信息中找到目的RCP服务。 
SMF调用SM策略服务的PDU会话创建接口，包含接入网相关信息、用户信息等。 
RCP的SM策略服务收到PDU会话创建请求后，进行PDU会话决策，构造PCC规则和订阅相关事件。 
RCP返回响应消息给SMF。 
当内部事件（例如，内部决策时间到）或签约发生变更时，触发会话重决策。 
RCP使用创建请求消息体中的NotifURI，同时根据本地缓存或NRF查询结果，选择客户端模板。 
（可选）RCP向NRF获取SMF相关信息，便于匹配客户端模板。 
（可选）NRF将注册的SMF信息返回给RCP。 
RCP下发决策的策略通知给SMF。 
SMF回复更新成功应答。 
######### SCP_C模式场景 
RCP为服务提供方，SCP_C模式场景下的业务流程如[图7](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7c299b0774db4013b3c5ff429af049a6__6822c198-5289-46c0-be54-39c6807c6188)所示。
图7  SCP_C模式的业务流程
[]images/scp_c.png)
流程说明如下： 
RCP与目的NF建立初始会话。 
RCP作为服务提供者在初始应答中携带Location主机部分以及3gpp-Sbi-Binding等头部给服务使用者，存储对端可能携带的3gpp-Sbi-Binding头部、notiURI、可能的NF实例号、SCP插入的via头部等信息。 
外部或内部触发RCP发起首次反向通知请求，根据notiURI主机部分（包括IP/FQDN）或类型分析为SCP-C模式，查询NRF获取到目的NF。如果缓存已有相关目的NF信息，则不会向NRF发发现消息。 
（可选）如果需要向NRF发现目的NF，则通过Nnrf_NFDiscovery Request消息携带发现参数（例如，发现AMF会携带guami，发现SMF可能携带smfset等发现参数）。 
（可选）NRF根据发现参数返回目的NF信息。 
RCP得到目的NF，填写到3gpp-Sbi-Target-apiRoot ，下一跳为SCP，发送请求到SCP。 
如果之前存储了目的NF的3gpp-Sbi-Binding信息，会将绑定信息复制到3gpp-Sbi-Routing-Binding头部。RCP发送HTTP2 Notify Request消息，携带url.apiroot为SCP、3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot为发现的目的NF、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback等参数。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
RCP缓存路由信息，以及可能更新的3gpp-Sbi-Binding、3gpp-Sbi-Target-apiRoot。 
外部或内部触发发起后续反向通知请求，RCP根据上次缓存的路由信息发送给SCP。 
RCP发送HTTP2 Notify Request携带参数url.apiroot为SCP、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback给SCP。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
######### SCP_D模式场景 
RCP为服务提供方，SCP_D模式场景下的业务流程如[图8](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7c299b0774db4013b3c5ff429af049a6__ccd0b4a4-4e18-43f8-a481-d0e4e8f1388f)所示。
图8  SCP_DSCP_D模式的业务流程
[]images/%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E6%96%B9_scp_d%E6%A8%A1%E5%BC%8F.png)
流程说明如下： 
RCP与目的NF建立初始会话。 
RCP作为服务提供者在初始应答中携带Location主机部分、3gpp-Sbi-Binding等头部给服务使用者，存储对端可能携带的3gpp-Sbi-Binding头部、notiURI、可能的NF实例号、SCP插入的via头部等信息。 
外部或内部触发首次发起反向通知请求，根据IP或类型分析为SCP-D模式，根据配置发送给SCP。 
如果之前存储了目的NF的3gpp-Sbi-Binding信息，会将绑定信息复制到3gpp-Sbi-Routing-Binding头部。RCP发送HTTP2 Notify Request消息，携带url.apiroot为SCP、3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot为发现的目的NF、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback等参数。 
（可选）如果需要向NRF发现目的NF，通过Nnrf_NFDiscovery Request消息携带发现参数（例如，发现AMF会携带guami，发现SMF可能携带smfset等发现参数）。 
（可选）NRF根据发现参数返回目的NF信息。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP判定通知应答消息中如果没有3gpp-Sbi-Binding，插入3gpp-Sbi-Producer-Id头部。如果没有location头部，插入3gpp-Sbi-Target-apiRoot。 
SCP发送通知应答给RCP，可能携带3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、3gpp-Sbi-Producer-Id等头部。 
RCP缓存路由信息，以及可能更新的3gpp-Sbi-Binding、3gpp-Sbi-Target-apiRoot。 
外部或内部触发发起后续反向通知请求，RCP根据上次缓存的路由信息发送给SCP。 
RCP发送HTTP2 Notify Request携带参数url.apiroot为SCP、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback给SCP。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
######### SCP_Proxy模式场景 
RCP为服务提供方，SCP_Proxy模式场景下的业务流程如[图9](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7c299b0774db4013b3c5ff429af049a6__bab57d27-6163-49cb-8c82-c45048c6b60c)所示。
图9  SCP_Proxy模式流程图
[]images/%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E6%96%B9_scp_proxy%E6%A8%A1%E5%BC%8F.png)
流程说明如下： 
RCP与目的NF 建立初始会话。 
RCP作为服务提供者在初始应答中携带Location主机部分、3gpp-Sbi-Binding等头部给服务使用者，存储对端可能携带的3gpp-Sbi-Binding头部、notiURI、可能的NF实例号、SCP插入的via头部等信息。 
外部或内部触发RCP发起首次反向通知请求，根据notiURI主机部分（包括IP/FQDN）或类型分析为SCP_Proxy模式，查询NRF获取到目的NF。如果缓存已有相关目的NF信息，则不会向NRF发发现消息。 
（可选）如果需要向NRF发现目的NF，则通过Nnrf_NFDiscovery Request携带发现参数（例如，发现AMF会携带guami，发现SMF可能携带smfset等发现参数）。 
（可选）NRF根据发现参数返回目的NF信息。 
RCP得到目的NF，填写到uri.apiroot，下一跳为SCP，发送请求到SCP。 
如果之前存储了目的NF的3gpp-Sbi-Binding信息，会将绑定信息复制到3gpp-Sbi-Routing-Binding头部。RCP发送HTTP2 Notify Request消息，携带url.apiroot为目的NF、3gpp-Sbi-Routing-Binding、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback等参数。 
SCP根据3gpp-Sbi-Routing-Binding等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
RCP缓存路由信息，以及可能更新的3gpp-Sbi-Binding、3gpp-Sbi-Target-apiRoot。 
外部或内部触发发起后续反向通知请求，RCP根据上次缓存的路由信息发送给SCP。 
RCP发送HTTP2 Notify Request携带参数url.apiroot为目的NF、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Binding、user-agent、3gpp-Sbi-Callback给SCP。 
SCP根据3gpp-Sbi-Routing-Binding等参数将通知请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
####### RCP为服务使用方的业务流程 
RCP为服务使用方时，通过Nbsf、N36、N28接口与BSF、UDR、CHF进行交互。 
下面以N28接口为例介绍静态寻址方式，即直连场景（A模式）下的业务流程。以Nbsf接口为例介绍动态寻址方式，包括直连场景（B模式）、以及SCP_C模式、 SCP_D模式、SCP_Proxy模式场景下的业务流程。 
######### 直连场景（A模式） 
RCP为服务使用方，直连场景（A模式）下的业务流程，如[图10](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf875f8f333524c18bf96bf67473f1dcc__2e73ce46-6bc3-4792-900d-f9b06f122fa0)所示。
图10  A模式场景
[]images/1660552152407.png)
流程说明如下： 
RCP收到SMF发起的PDU会话创建请求，通过本地NRF配置获取CHF的相关信息。 
根据NRF本地配置，使用号段等信息匹配到目的CHF。 
RCP向CHF获取消费门限限额状态信息。 
CHF返回消费门限限额状态信息。 
RCP根据消费门限限额状态进行PDU会话决策，构造PCC规则和订阅相关事件，并返回响应消息给SMF 
######### 直连场景（B模式） 
RCP为服务使用方，直连场景（B模式）下的业务流程如[图11](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf875f8f333524c18bf96bf67473f1dcc__84cdb717-dc86-4f82-8ffb-7f8ae4db70fb)所示。
图11  B模式场景下的业务流程
[]images/1660552036120.png)
流程说明如下： 
BSF上电后，向NRF注册本NF、服务的相关信息，包括FQDN、IP、优先级、版本号等信息。 
NRF返回注册成功，服务使用者可根据BSF提供信息寻址到BSF。 
RCP收到SMF发起的PDU会话创建请求，通过动态发现获取BSF的相关信息。 
（可选）RCP通过服务实例号、IP地址、DNN等信息向NRF查询BSF服务地址。 
（可选）NRF将注册的BSF信息返回给RCP。 
RCP根据返回的BSF信息，分析出目的BSF。 
RCP向BSF注册PDU会话绑定信息。 
BSF返回注册绑定信息的结果。 
RCP进行PDU会话决策，构造PCC规则和订阅相关事件。 
######### SCP_C模式场景 
RCP为服务使用方，SCP_C模式场景下的业务流程如[图12](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf875f8f333524c18bf96bf67473f1dcc__67b1d884-53b7-4ab9-9eb5-229172295d92)所示。
图12  服务使用方SCP_C模式
[]images/%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E6%96%B9_scp_c.png)
流程说明如下： 
RCP作为服务使用者发起初始业务请求，根据类型分析为SCP-C模式，查询NRF获取到目的NF。 
（可选）如果需要向NRF发现目的NF，则通过Nnrf_NFDiscovery Request携带发现参数（例如，发现BSF会携带用户地址，发现UDR、CHF携带用户号码）。 
（可选）NRF根据发现参数返回目的NF信息。 
RCP得到目的NF，填写到3gpp-Sbi-Target-apiRoot ，下一跳为SCP，发送请求到SCP。 
RCP发送HTTP2 Request携带参数url.apiroot为SCP、携带3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、user-agent给SCP。 
SCP根据3gpp-Sbi-Target-apiRoot等参数将业务请求路由到目的NF。 
目的NF处理业务请求，回复业务应答给SCP，携带location，目的NF热备时会携带3gpp-Sbi-Binding等头部参数。 
SCP转发业务应答给RCP，携带location、3gpp-Sbi-Binding等头部参数。 
RCP存储location或者3gpp-Sbi-Target-Apiroot、3gpp-Sbi-Binding、3gpp-Sbi-Producer-Id等信息。 
RCP作为服务使用者发起更新业务请求，根据之前的Location主机部分以及3gpp-Sbi-Binding等头部构造目的NF信息。 
RCP发送HTTP2 Request携带参数url.apiroot为SCP、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、user-agent给SCP。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将业务请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
######### SCP_D模式场景 
RCP为服务使用方，SCP_D模式场景下的业务流程如[图13](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf875f8f333524c18bf96bf67473f1dcc__d713d673-38b9-462b-85de-2a88e7db382d)所示。
图13  服务使用方SCP_D模式
[]images/%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E6%96%B9_scp_d%E6%A8%A1%E5%BC%8F.png)
流程说明如下： 
RCP作为服务使用者发起初始业务请求，根据类型分析为SCP_D模式，根据配置发送给SCP。 
RCP发送HTTP2 Request携带参数url.apiroot为SCP、携带发现参数3gpp-Sbi-Discovery-*（如发现BSF会携带用户地址，发现UDR、CHF携带用户号码）、3gpp-Sbi-Binding、user-agent给SCP。 
（可选）如果需要向NRF发现目的NF，则通过Nnrf_NFDiscovery Request携带发现参数（例如，发现BSF会携带用户地址，发现UDR、CHF携带用户号码）。 
（可选）NRF根据发现参数返回目的NF信息。 
SCP根据3gpp-Sbi-Target-apiRoot等参数将业务请求路由到目的NF。 
目的NF处理业务请求信息，回复业务应答给SCP。 
SCP判定业务应答消息中如果没有3gpp-Sbi-Binding，插入3gpp-Sbi-Producer-Id头部；如果没有location头部，插入3gpp-Sbi-Target-apiRoot。 
SCP发送通知应答给RCP，可能携带location、3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、3gpp-Sbi-Producer-Id等头部。 
RCP缓存路由信息，存储location、3gpp-Sbi-Target-apiRoot，3gpp-Sbi-Binding、3gpp-Sbi-Producer-Id等信息。 
RCP作为服务使用者发起更新业务请求，根据之前的Location、3gpp-Sbi-Target-apiRoot主机部分以及3gpp-Sbi-Binding、3gpp-Sbi-Producer-Id等头部构造目的NF信息。 
RCP发送HTTP2 Request携带参数url.apiroot为SCP、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot、3gpp-Sbi-Binding、user-agent给SCP。 
SCP根据3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot等参数将业务请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
######### SCP_Proxy模式场景 
RCP为服务使用方，SCP_Proxy模式场景下的业务流程如[图14](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf875f8f333524c18bf96bf67473f1dcc__c24897d0-2d06-40a0-bbe9-3485a422e3fd)所示。
图14  服务使用方SCP_Proxy模式
[]images/%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E6%96%B9_scp_proxy%E6%A8%A1%E5%BC%8F.png)
流程说明如下： 
RCP作为服务使用者发起初始业务请求，根据类型分析为SCP_Proxy模式，查询NRF获取到目的NF。 
（可选）如果需要向NRF发现目的NF，则通过Nnrf_NFDiscovery Request携带发现参数（例如，发现BSF会携带用户地址，发现UDR、CHF携带用户号码）。 
（可选）NRF根据发现参数返回目的NF信息。 
RCP得到目的NF，填写到3gpp-Sbi-Target-apiRoot ，下一跳为SCP，发送请求到SCP。 
RCP发送HTTP2 Request携带参数url.apiroot为目的NF、可能携带3gpp-Sbi-Binding、user-agent到SCP。 
SCP根据url.apiroot等参数将业务请求路由到目的NF。 
目的NF处理业务请求，回复业务应答给SCP，携带location、目的NF热备时会携带3gpp-Sbi-Binding等头部参数。 
SCP转发业务应答给RCP，携带location、3gpp-Sbi-Binding等头部参数。 
RCP存储location、3gpp-Sbi-Binding等信息。 
RCP作为服务使用者发起更新业务请求，根据之前的Location主机部分以及3gpp-Sbi-Binding等头部构造目的NF信息。 
RCP发送HTTP2 Request携带参数url.apiroot为目的NF、可能携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Binding、user-agent到SCP。 
SCP根据3gpp-Sbi-Routing-Binding、url.apiroot等参数将业务请求路由到目的NF。 
目的NF处理通知信息，回复通知应答给SCP。 
SCP转发通知应答给RCP。 
###### 本网元实现 
######## 支持HTTP静态链路管理和动态链路管理 
RCP的链路管理有两种方式： 
静态配置方式客户端支持通过网络配置的方式在客户端上事先配置到服务器的连接。静态配置方式下，客户端支持配置服务器的连接地址。 
动态建立方式当客户端需要与服务器交互时，动态建立连接后进行消息发送，除非特别指明，默认情况下客户端、代理、服务器之间维护HTTP长连接，即在本次HTTP交互完成后不拆除HTTP连接，后续HTTP消息交互可基于之前已建立的连接进行。动态建立方式下，客户端不配置服务器的连接地址。客户端支持与同一个服务器端点在同一时刻维护多条HTTP连接。当客户端在一条HTTP连接上发送消息失败时，若客户端需要重新发送消息，则应支持选择其它可用的HTTP连接进行发送。 
######## 传输消息可采用HTTPS协议 
RCP支持加载证书套件， 采用TLS协议对HTTP消息构建加密传输，支持对TLS协议进行验签认证。 
RCP作为客户端时，可按服务化接口配置使用的HTTP客户端模板进行TLS加密。配置为使用TLS加密时，将对HTTP消息进行TLS加密，发送HTTPS请求。配置为不加密时，不会对HTTP消息进行加密，发送HTTP请求。 
RCP作为服务端时，可按服务化接口配置使用的HTTP服务端模板进行TLS验证。配置为使用TLS加密时，将支持对HTTPS消息进行TLS验证。配置为不加密时，不支持对HTTPS消息进行验证。 
######## 支持直连路由寻址 
静态路由寻址
当RCP作为客户端发送请求时，RCP支持通过本地NRF配置的方式进行路由寻址。 
以“从本地NRF配置中查询CHF”为例进行介绍。 
SCP基本属性配置SCP功能开关参数配置为不启用SCP功能。SCP功能开关参数配置为启用SCP功能，但是SCP按NF类型选择配置、SCP按FQDN选择配置中SCP模式参数配置为不启用SCP。SCP功能开关参数配置为启用SCP功能，但是SCP按NF类型选择配置、SCP按FQDN选择配置未配置，SCP缺省选择配置的SCP模式参数配置为不启用SCP。 
本地NRF配置配置CHF网元信息。（等价于把动态发现响应中携带的CHF网元信息通过静态配置的方式配置到系统中去。） 
服务发现方式配置发现方式参数配置为静态，RCP从本地NRF配置获取CHF信息。 
服务发现配置若启用了缓存发现结果的功能，本地NRF配置也会有静态缓存。路由寻址时根据携带的参数，优先到缓存中进行匹配，缓存中匹配失败才会进行本地NRF匹配。 
动态路由寻址
当RCP作为客户端发送请求时，RCP支持通过动态发现的方式进行路由寻址。动态路由寻址通过服务化特性查询NRF来获取目标NF信息，根据优先级、容量、权重等信息来选择信令路由。 
以“动态查询BSF”为例进行介绍。 
SCP基本属性配置SCP功能开关参数配置为不启用SCP功能。SCP功能开关参数配置为启用SCP功能，但是SCP按NF类型选择配置、SCP按FQDN选择配置中SCP模式参数配置为不启用SCP。SCP功能开关参数配置为启用SCP功能，但是SCP按NF类型选择配置、SCP按FQDN选择配置未配置，SCP缺省选择配置的SCP模式参数配置为不启用SCP。 
服务发现方式配置发现方式参数配置为动态或动态优先，RCP通过动态查询NRF发现目的NF。 
服务发现配置若启用了缓存发现结果的功能，路由寻址时根据携带的参数，优先到缓存中进行匹配，缓存中匹配失败再动态查询。 

初次进行服务发现携带的参数见表4。表4  初次进行服务发现携带的参数名称说明ue ip用户IPv4地址或者IPv6地址前缀locality（可选）位置优选参数requester-nf-instrance-fqdn请求查询的NF的FQDNrequester-nf-type请求查询的NF类型requester-nf-instrance-id请求查询的NF实例号dnnN7会话携带的dnnservice-names查询目标NF的服务名target-nf-type查询目标NF的类型 
######## 支持SCP_C模式路由寻址 
RCP作为客户端发送请求时，若SCP配置为启用SCP，且为C模式，服务发现方式配置为动态或者动态优先时，RCP会通过动态发现的方式进行路由寻址。 
以“动态查询BSF”为例进行介绍。 
SCP基本属性配置SCP功能开关参数配置为启用SCP功能。SCP按NF类型选择配置、SCP按FQDN选择配置的SCP模式参数配置为C模式SCP。 
服务发现方式配置发现方式参数配置为动态或动态优先，RCP通过动态查询NRF发现目的NF。 
服务发现配置若启用了缓存发现结果的功能，路由寻址时根据携带的参数，优先到缓存中进行匹配，匹配失败后再进行动态查询。 
初次进行服务发现携带的参数见表4。 
携带给SCP用于寻址的参数参见表5。表5  携带给SCP寻址Nbsf参数名称说明apiroot (SCP)apiRoot为SCP的IP地址3gpp_Sbi_Route_Binding用于业务后续请求时指定特定目标NF资源上下文3gpp_Sbi_Target_apiRoot (Producer NF)目的NF的IP地址 
######## 支持SCP_D模式路由寻址 
RCP作为客户端发送请求时，若SCP配置为启用SCP且为D模式，SCP会通过动态发现的方式进行路由寻址。 
以“动态查询BSF”为例进行介绍。 
SCP基本属性配置SCP功能开关参数配置为启用SCP功能。SCP按NF类型选择配置、SCP按FQDN选择配置的SCP模式参数配置为D模式SCP。 
携带给SCP用于服务发现的参数参见表4。 
携带给SCP用于寻址的参数参见表5。 
######## 支持SCP_Proxy模式路由寻址 
RCP作为客户端发送请求时，若SCP配置为启用SCP且为Proxy模式，服务发现方式配置为动态或者动态优先时，RCP会通过动态发现的方式进行路由寻址。 
以“动态查询BSF”为例进行介绍。 
SCP基本属性配置SCP功能开关参数配置为启用SCP功能。SCP按NF类型选择配置、SCP按FQDN选择配置的SCP模式参数配置为普通代理模式SCP。 
服务发现方式配置发现方式参数配置为动态或动态优先，RCP通过动态查询NRF发现目的NF。 
服务发现配置若启用了缓存发现结果的功能，路由寻址时根据携带的参数，优先到缓存中进行匹配，匹配失败后再进行动态查询。 
携带给SCP用于服务发现的参数参见表4。 
携带给SCP用于寻址的参数参见表5。 
######## 支持相同优先级负荷分担路由 
RCP作为服务提供者时，对于N7接口，根据smfid查询到服务信息后，若该服务注册时携带了多个IP，RCP选择IP时会进行轮选。 
RCP作为服务使用者时，对于N28、Nbsf、N36接口，动态发现并根据号段或者IP地址匹配到最高优先级的对端服务可能有多个时，对多个相同优先级的服务进行轮选，每个服务下面可能有多IP，在返回的多个服务实例间进行轮选。 
######## 支持主备路由 
CHF到NRF注册时，可能会注册多个CHF服务。RCP根据号段到NRF发现CHF时，可能查询到多个CHF服务，RCP选择优先级最高的CHF服务进行路由寻址。 
当主用CHF不可用时，RCP将消费限额请求发送到备用CHF（即优先级低的CHF）。当主用CHF恢复后，根据配置策略决定是否自动倒回 。 
######## 支持不同平面组网 
RCP、NRF、AMF、SMF等5GC网元在EPC网络平面，RCP通过NRF动态发现这些网元与服务。如果CHF网元不在EPC网络平面，RCP与CHF建链时，对CHF暴露的地址与暴露给其它EPC网元的地址可能不相同，配置静态对接时应遵循以下两点： 
与CHF建链的地址选择关联HTTP客户端模板配置选择客户端模板，确定使用客户端模板中配置的地址。 
反向通知URI中的地址选择若主机类型为IP，服务端模板ID从通知URI服务端模板配置中获取。若主机类型为FQDN，从服务基础配置中获取本服务的FQDN作为授权主机。 
######## 支持专网AMF/AMF接入 
RCP支持通过VPN（EDGE_SG）对接边缘SMF/AMF。在核心网SMF/AMF和边缘SMF/AMF以不同VPN接入到PCF时，PCF能在不同VPN将反向通知请求发送给核心网AMF和边缘AMF。
RCP与双网络平面SMF/AMF对接时，在选择客户端模板配置和构造location以及resuri时应遵循以下几点： 
读取服务基础配置，如果该VPN已配置，则认为是普通VPN，否则认为是专网VPN。 
普通VPN接入，对接核心网AMF，并且消息中的location以及resuri设置为核心网的IP、FQDN、端口、模式。 
专网VPN接入，对接边缘AMF，并且消息中的location以及resuri设置为专网的地址、端口、模式。 
######## 支持反向通知失败重选 
直连场景反向通知失败重选
当RCP业务收到反向通知请求客户端路由的应答时，如果SCP模式不为SCP_PROXY、SCP_C、SCP_D，即为目的NF产生的失败时，RCP可以根据状态码重选配置（若无配置，则流程失败，不再重选路由发送通知请求）决策是否重新路由发送。
直连场景N7会话失败重选流程如[图15](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zec2f0225e7ee434486f7733c38155472__a3c20887-a6f6-4091-b27f-fffedd4340b3)所示。
图15  直连场景N7会话失败重选流程
[]images/n7%E7%9B%B4%E8%BF%9E%E5%A4%B1%E8%B4%A5%E9%87%8D%E9%80%89.png)
直连场景N5会话失败重选流程如[图16](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zec2f0225e7ee434486f7733c38155472__e7cff73b-d506-429a-9320-264186e14975)所示。
图16  直连场景N5会话失败重选流程
[]images/n5%E7%9B%B4%E8%BF%9E%E5%A4%B1%E8%B4%A5%E9%87%8D%E9%80%89.png)
非直连场景反向通知失败重选
当RCP业务收到反向通知请求客户端路由的应答时，如果SCP模式为SCP_PROXY、SCP_C、SCP_D，且是目的NF/SCP产生的失败时，RCP可以根据状态码重选配置（若无配置，则流程失败，不再重选路由发送通知请求）决策是否重新路由发送。
非直连与直连场景反向通知失败重选的差异有两点： 
直连场景中，应答失败是目的NF返回的失败，非直连场景中，可能是SCP返回的失败，或者是目的NF返回的失败。 
直连场景中，不存在SCP路由发现参数，非直连场景中，存在是否携带SCP路由发现参数的情况。 
非直连场景N7会话失败重选流程如[图17](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zec2f0225e7ee434486f7733c38155472__7e912039-6333-427a-bde6-7c590acf7cdb)所示。
图17  非直连场景N7会话失败重选流程
[]images/n7%E9%9D%9E%E7%9B%B4%E8%BF%9E%E5%A4%B1%E8%B4%A5%E9%87%8D%E9%80%89.png)
非直连场景N5会话失败重选流程如[图18](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zec2f0225e7ee434486f7733c38155472__979aac35-a036-46b0-9678-ddecc3ee320a)所示。
图18  非直连场景N5会话失败重选流程
[]images/n5%E9%9D%9E%E7%9B%B4%E8%BF%9E%E5%A4%B1%E8%B4%A5%E9%87%8D%E9%80%89.png)
######## 支持SMF重定向 
RCP收到SMF回复策略通知应答消息时，携带错误码为307/308时，处理Location（可包含server、3gpp-Sbi-Target-Nf-Id等参数）后重新发送请求。 
RCP根据此错误应答的server头部携带内容为SMF类型（或不携带Server头部），视同为SMF重定向，根据重定向地址重新发送请求。 
容灾场景回复重定向时，RCP不会携带3gpp-Sbi-Binding头部，其它网元如SMF、AMF容灾时暂时没有携带。 
307为单次重定向，会话的后续请求仍发送至原有SMF。308为永久重定向，后续请求发送至重定向之后的SMF。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
无。 
##### 特性间交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System
3GPP|TS 23.502|Procedures for the 5G System
3GPP|TS 23.503|Policy and Charging Control Framework for the 5G System
3GPP|TS 29.500|Technical Realization of Service Based Architecture
##### 特性能力 
名称|指标
---|---
服务发现缓存NfProfile最大个数|2048
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.21.10|首次发布。
02|V7.23.10|新增：支持SCP路由转发功能。支持核心网/边缘SMF/AMF接入。
####### License要求 
本特性为RCP的基本特性，无需License支持。 
####### 对其他网元的要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
配置项表6  新增配置项命令项命令名称描述客户端模板配置ADD CLIENTPROFILE新增客户端模板配置SET CLIENTPROFILE修改客户端模板配置DELETE CLIENTPROFILE删除客户端模板配置SHOW CLIENTPROFILE查询客户端模板配置服务端模板配置ADD SERVERPROFILE新增服务端模板配置SET SERVERPROFILE修改服务端模板配置DELETE SERVERPROFILE删除服务端模板配置SHOW SERVERPROFILE查询服务端模板配置关联HTTP客户端模板配置ADD CLIENTPROFILE新增客户端模板配置SET CLIENTPROFILE修改客户端模板配置DELETE CLIENTPROFILE删除客户端模板配置SHOW CLIENTPROFILE查询客户端模板配置服务基础配置ADD PCFSERVICE新增服务基础配置SET PCFSERVICE修改服务基础配置DEL PCFSERVICE删除服务基础配置SHOW PCFSERVICE查询服务基础配置NRF服务器分组配置ADD SBINRFGROUP新增NRF服务器分组配置SET SBINRFGROUP修改NRF服务器分组配置DEL SBINRFGROUP删除NRF服务器分组配置SHOW SBINRFGROUP查询NRF服务器分组配置NRF服务器节点配置ADD SBINRFNODE新增NRF服务器节点配置SET SBINRFNODE修改NRF服务器节点配置DEL SBINRFNODE删除NRF服务器节点配置SHOW SBINRFNODE查询NRF服务器节点配置NRF服务器策略配置ADD SBINRFPOLICY新增NRF服务器策略配置SET SBINRFPOLICY修改NRF服务器策略配置DEL SBINRFPOLICY删除NRF服务器策略配置SHOW SBINRFPOLICY查询NRF服务器策略配置NRF服务器模板配置ADD SBINRFPROFILE新增NRF服务器模板配置SET SBINRFPROFILE修改NRF服务器模板配置DEL SBINRFPROFILE删除NRF服务器模板配置SHOW SBINRFPROFILE查询NRF服务器模板配置NRF服务器模板选择配置ADD SBINRFPROFILESEL新增NRF服务器模板选择配置SET SBINRFPROFILESEL修改NRF服务器模板选择配置DEL SBINRFPROFILESEL删除NRF服务器模板选择配置SHOW SBINRFPROFILESEL查询NRF服务器模板选择配置重选配置ADD SBIRESELECT新增重选配置SET SBIRESELECT修改重选配置DEL SBIRESELECT删除重选配置SHOW SBIRESELECT查询重选配置服务发现配置SET SBISRVDISCOVERY修改服务发现配置SHOW SBISRVDISCOVERY查询服务发现配置服务发现方式配置ADD SBISRVDISCOVERYMODE增加服务发现方式配置SET SBISRVDISCOVERYMODE修改服务发现方式配置DEL SBISRVDISCOVERYMODE删除服务发现方式配置SHOW SBISRVDISCOVERYMODE查询服务发现方式配置路由策略配置ADD SBIROUTEPOLICY新增路由策略配置SET SBIROUTEPOLICY修改路由策略配置DEL SBIROUTEPOLICY删除路由策略配置SHOW SBIROUTEPOLICY查询路由策略配置局向检测配置SET SBIOFFICEDETECT修改局向检测配置SHOW SBIOFFICEDETECT查询局向检测配置订阅条件配置ADD SBISUBCOND增加订阅条件配置SET SBISUBCOND修改订阅条件配置DEL SBISUBCOND删除订阅条件配置SHOW SBISUBCOND查询订阅条件配置SCP相关配置路由集配置ADD SBISCPROUTESET新增路由集配置SET SBISCPROUTESET修改路由集配置DEL SBISCPROUTESET删除路由集配置SHOW SBISCPROUTESET查询路由集配置服务器配置ADD SBISCPSERVER新增服务器配置SET SBISCPSERVER修改服务器配置DEL SBISCPSERVER删除服务器配置SHOW SBISCPSERVER查询服务器配置节点配置ADD SBISCPNODE新增节点配置SET SBISCPNODE修改节点配置DEL SBISCPNODE删除节点配置SHOW SBISCPNODE查询节点配置SCP基本属性配置SET SBISCPBASICATTRIBUTE修改SCP基本属性配置SHOW SBISCPBASICATTRIBUTE查询SCP基本属性配置SCP按NF类型选择配置ADD SBISCPSELBYNFTYPE新增SCP按NF类型选择配置SET SBISCPSELBYNFTYPE修改SCP按NF类型选择配置DEL SBISCPSELBYNFTYPE删除SCP按NF类型选择配置SHOW SBISCPSELBYNFTYPE查询SCP按NF类型选择配置SCP按FQDN选择配置ADD SBISCPSELBYFQDN新增SCP按FQDN选择配置SET SBISCPSELBYFQDN修改SCP按FQDN选择配置DEL SBISCPSELBYFQDN删除SCP按FQDN选择配置SHOW SBISCPSELBYFQDN查询SCP按FQDN选择配置SCP按IPv4地址范围选择配置ADD SBISCPSELBYIPV4RNG新增SCP按IPv4地址范围选择配置SET SBISCPSELBYIPV4RNG修改SCP按IPv4地址范围选择配置DEL SBISCPSELBYIPV4RNG删除SCP按IPv4地址范围选择配置SHOW SBISCPSELBYIPV4RNG查询SCP按IPv4地址范围选择配置SCP按IPv6地址范围选择配置ADD SBISCPSELBYIPV6RNG新增SCP按IPv6地址范围选择配置SET SBISCPSELBYIPV6RNG修改SCP按IPv6地址范围选择配置DEL SBISCPSELBYIPV6RNG删除SCP按IPv6地址范围选择配置SHOW SBISCPSELBYIPV6RNG查询SCP按IPv6地址范围选择配置SCP按NF实例选择配置ADD SBISCPSELBYNFINSTID新增SCP按NF实例选择配置SET SBISCPSELBYNFINSTID修改SCP按NF实例选择配置DEL SBISCPSELBYNFINSTID删除SCP按NF实例选择配置SHOW SBISCPSELBYNFINSTID查询SCP按NF实例选择配置SCP缺省选择配置SET SBISCPDEFAULTSELECTION修改SCP缺省选择配置SHOW SBISCPDEFAULTSELECTION查询SCP缺省选择配置本地NRF相关配置-CHFGPSI范围组编号配置ADD SBIGPSIRANGEARRID新增GPSI范围组编号配置DEL SBIGPSIRANGEARRID删除GPSI范围组编号配置SHOW SBIGPSIRANGEARRID查询GPSI范围组编号配置GPSI范围组参数配置ADD SBIGPSIRANGEARRPARAM新增GPSI范围组参数配置SET SBIGPSIRANGEARRPARAM修改GPSI范围组参数配置DEL SBIGPSIRANGEARRPARAM删除GPSI范围组参数配置SHOW SBIGPSIRANGEARRPARAM查询GPSI范围组参数配置CHF信息配置ADD SBICHFINFO新增CHF信息配置SET SBICHFINFO修改CHF信息配置DEL SBICHFINFO删除CHF信息配置SHOW SBICHFINFO查询CHF信息配置IPv4地址配置ADD SBIIPV4ADDR新增IPv4地址配置SET SBIIPV4ADDR修改IPv4地址配置DEL SBIIPV4ADDR删除IPv4地址配置SHOW SBIIPV4ADDR查询IPv4地址配置IPv6地址配置ADD SBIIPV6ADDR新增IPv6地址配置SET SBIIPV6ADDR修改IPv6地址配置DEL SBIIPV6ADDR删除IPv6地址配置SHOW SBIIPV6ADDR查询IPv6地址配置IP端点配置ADD SBIIPENDPOINT新增IP端点配置SET SBIIPENDPOINT修改IP端点配置DEL SBIIPENDPOINT删除IP端点配置SHOW SBIIPENDPOINT查询IP端点配置IP端点组编号配置ADD SBIIPENDPOINTARRID新增IP端点组编号配置DEL SBIIPENDPOINTARRID删除IP端点组编号配置SHOW SBIIPENDPOINTARRID查询IP端点组编号配置IP端点组参数配置ADD SBIIPENDPOINTARRPARAM新增IP端点组参数配置SET SBIIPENDPOINTARRPARAM修改IP端点组参数配置DEL SBIIPENDPOINTARRPARAM删除IP端点组参数配置SHOW SBIIPENDPOINTARRPARAM查询IP端点组参数配置NF服务版本组编号配置ADD SBINFSVERSIONARRID新增NF服务版本组编号配置DEL SBINFSVERSIONARRID删除NF服务版本组编号配置SHOW SBINFSVERSIONARRID查询NF服务版本组编号配置NF服务版本组参数配置ADD SBINFSVERSIONARRPARAM新增NF服务版本组参数配置SET SBINFSVERSIONARRPARAM修改NF服务版本组参数配置DEL SBINFSVERSIONARRPARAM删除NF服务版本组参数配置SHOW SBINFSVERSIONARRPARAM查询NF服务版本组参数配置对端NF基本信息配置ADD SBIPEERNFBASEINFO新增对端NF基本信息配置SET SBIPEERNFBASEINFO修改对端NF基本信息配置DEL SBIPEERNFBASEINFO删除对端NF基本信息配置SHOW SBIPEERNFBASEINFO查询对端NF基本信息配置对端NF扩展信息配置ADD SBIPEERNFEXTINFO新增对端NF扩展信息配置SET SBIPEERNFEXTINFO修改对端NF扩展信息配置DEL SBIPEERNFEXTINFO删除对端NF扩展信息配置SHOW SBIPEERNFEXTINFO查询对端NF扩展信息配置对端NF实例配置ADD SBIPEERNFSERVICEINSTANCE新增对端NF实例配置SET SBIPEERNFSERVICEINSTANCE修改对端NF实例配置DEL SBIPEERNFSERVICEINSTANCE删除对端NF实例配置SHOW SBIPEERNFSERVICEINSTANCE查询对端NF实例配置 
动态管理命令项命令名称描述动态发现cache管理SHOW NFPROFILE INFO查询NF Profile概要信息SHOW NFPROFILE DETAIL INFO查询本地cache中保存的动态发现的NF Profile详细信息DELETE NFPROFILE BY NFINSTANCEID根据NF实例ID删除本地cache中保存的动态发现的NF ProfileDELETE NFPROFILE BY NFTYPE根据NF类型删除本地cache中保存的动态发现的NF Profile本地NRF管理SHOW LOCALNRF NFINFO查询本地NRF内NF Profile概要信息SHOW LOCALNRF NFDETAILINFO查询本地NRF内NF Profile详细信息订阅管理SHOW CONFIG SUBINFO查询通过配置触发的订阅信息SHOW SRVDISCOVERY SUBINFO查询通过服务发现触发的订阅信息NRF服务器管理SHOW NRF INFO查询NRF信息SWP NRF SERVER倒换NRF Server状态检测管理SHOW BASEDETECTOBJ INFO查询基本检测对象概要信息SHOW BASEDETECTOBJ DETAIL INFO查询基本检测对象详细信息SHOW DETECT OFFICE INFO查询检测局向概要信息SHOW DETECT OFFICE DETAIL INFO查询检测局向详细信息 
软件参数表7  全局变量编号软件参数名称11231 HTTP重定向失败码21302 HTTP默认端口31320 热备重定向响应消息是否携带3gpp-Sbi-Target-Nf-Id 
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警与通知 
编号|告警名称
---|---
1|3506438156 目的端口不可用
2|3506438157 对端服务不可用
3|3506438167 SCP/SEPP节点不可用
4|3506438168 SCP/SEPP服务器不可用
5|3506438169 SCP/SEPP路由集不可用
####### 失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置动态路由寻址-RCP为服务提供方（SCP_C模式场景） 
###### 配置说明 
以N7接口为例，配置RCP为服务提供方（SCP_C模式场景）时动态路由寻址过程。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP为服务提供方（SCP_C模式场景）的动态路由寻址的配置流程，如[图1](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z1643cf7a1cff43ed87f1482bf723cfdb__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图1  配置流程
[]images/32354372a5574c678a9710a57473bf81.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
SCP配置。 
执行[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html)命令，进行SCP基本属性配置。
执行[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html)命令，进行路由集配置。
执行[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html)命令，进行服务器配置。
执行[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html)命令，进行节点配置。
进入策略管理页面，配置N7会话控制策略。 
###### 配置实例 
######## 数据规划 
HTTP客户端模板配置表1  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表2  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表3  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表4  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NPCF_SMPOLICYCONTROLHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号12描述信息NrfMasterNrfSlave 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参数名称参数值NF类型SMF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型SMF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型SMF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型SMF_TYPENF类型PCF_TYPE 
SCP基本属性配置参数名称参数值SCP功能开关SCP_ON回调请求路由模式SCP_C 
路由集配置参数名称参数值路由集ID2路由集名称2C模式下携带发现头部OPTION_NO 
服务器配置参数名称参数值服务器ID2服务器fqdnscp2.com.cn归属路由集ID2优先级100权重100 
节点配置参数名称参数值节点ID2服务器IP地址3224::1115服务器端口8080归属服务器ID2HTTP客户端模板编号4 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="SMF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="SMF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="SMF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
SCP配置。 
配置SCP基本属性。 
[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html):SCPSWITCH="SCP_ON",CALLBACKMODE="SCP_C"
新增路由集配置。 
[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html):ID=2,NAME="2",ADDDISCOVERY="OPTION_NO"
新增服务器配置。 
[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html):ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100
新增节点配置。 
[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html):ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4
配置策略。 
配置策略条件。 
条件1 
条件名称|参数|取值
---|---|---
usertype=1|选择策略变量|其他
策略变量类别|usertype=1|用户信息类
策略变量|usertype=1|用户类型
操作符|usertype=1|=
值类型|usertype=1|值
值|usertype=1|1
条件2 
条件名称|参数|取值
---|---|---
usertype=2|选择策略变量|其他
策略变量类别|usertype=2|用户信息类
策略变量|usertype=2|用户类型
操作符|usertype=2|=
值类型|usertype=2|值
值|usertype=2|2
配置动作参数 
动作1 
条件名称|参数|取值
---|---|---
N7sessact1|动作参数类型|N7会话参数集
会话规则名称|N7sessact1|N7sess1
会话AMBR上行速率（kbps）|N7sessact1|100
会话AMBR下行速率（kbps）|N7sessact1|100
动作2 
条件名称|参数|取值
---|---|---
N7sessact2|动作参数类型|N7会话参数集
会话规则名称|N7sessact2|N7sess2
会话AMBR上行速率（kbps）|N7sessact2|200
会话AMBR下行速率（kbps）|N7sessact2|200
配置规则 
条件1 
规则名称|参数|取值
---|---|---
N7sess1|优先级|10
动作类型|N7sess1|参数填充
日志开关|N7sess1|关闭
条件表达式|N7sess1|{用户类型 = 1}
选中动作参数名称|N7sess1|N7sessact1
条件2 
规则名称|参数|取值
---|---|---
N7sess2|优先级|1
动作类型|N7sess2|参数填充
日志开关|N7sess2|关闭
条件表达式|N7sess2|{用户类型 = 2}
选中动作参数名称|N7sess2|N7sessact2
配置场景 
场景名称|参数|取值
---|---|---
Scenario 3GPP|入口|入口类型|用户信息类
已选入口|Scenario 3GPP|入口|MSISDN
取值|Scenario 3GPP|入口|999999999999999
策略类型|Scenario 3GPP|N7会话控制策略|N7sess1
N7sess2|策略类型|Scenario 3GPP|N7会话控制策略
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置1 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
//NRF服务器节点配置1 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="SMF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="SMF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="SMF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//SCP基本属性配置 
SET SBISCPBASICATTRIBUTE:SCPSWITCH="SCP_ON",CALLBACKMODE="SCP_C" 
//新增路由集配置 
ADD SBISCPROUTESET:ID=2,NAME="2",ADDDISCOVERY="OPTION_NO" 
//新增服务器配置 
ADD SBISCPSERVER:ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100 
//新增节点配置 
ADD SBISCPNODE:ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4; 
##### 配置动态路由寻址-RCP为服务提供方（SCP_Proxy模式场景） 
###### 配置说明 
以N7接口为例，配置RCP为服务提供方（SCP_Proxy模式场景）时动态路由寻址过程。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务提供方（SCP_Proxy模式场景）的配置流程，如[图2](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new389383f5e0d6493791c2f49b907df107__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图2  配置流程
[]images/9169ded3d08041089406ce27066a233f.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
SCP配置。 
执行[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html)命令，进行SCP基本属性配置。
执行[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html)命令，进行路由集配置。
执行[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html)命令，进行服务器配置。
执行[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html)命令，进行节点配置。
进入策略管理页面，配置N7会话控制策略。 
###### 配置实例 
######## 数据规划 
HTTP客户端模板配置表5  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表6  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表7  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表8  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NPCF_SMPOLICYCONTROLHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号12描述信息NrfMasterNrfSlave 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参数名称参数值NF类型SMF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型SMF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型SMF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型SMF_TYPENF类型PCF_TYPE 
SCP基本属性配置参数名称参数值SCP功能开关SCP_ON回调请求路由模式SCP_PROXY 
路由集配置参数名称参数值路由集ID2路由集名称2C模式下携带发现头部OPTION_NO 
服务器配置参数名称参数值服务器ID2服务器fqdnscp2.com.cn归属路由集ID2优先级100权重100 
节点配置参数名称参数值节点ID2服务器IP地址3224::1115服务器端口8080归属服务器ID2HTTP客户端模板编号4 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="SMF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="SMF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="SMF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
SCP配置。 
配置SCP基本属性。 
[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html):SCPSWITCH="SCP_ON",CALLBACKMODE="SCP_PROXY"
新增路由集配置。 
[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html):ID=2,NAME="2",ADDDISCOVERY="OPTION_NO"
新增服务器配置。 
[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html):ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100
新增节点配置。 
[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html):ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4
配置策略。 
配置策略条件。 
条件1 
条件名称|参数|取值
---|---|---
usertype=1|选择策略变量|其他
策略变量类别|usertype=1|用户信息类
策略变量|usertype=1|用户类型
操作符|usertype=1|=
值类型|usertype=1|值
值|usertype=1|1
条件2 
条件名称|参数|取值
---|---|---
usertype=2|选择策略变量|其他
策略变量类别|usertype=2|用户信息类
策略变量|usertype=2|用户类型
操作符|usertype=2|=
值类型|usertype=2|值
值|usertype=2|2
配置动作参数 
动作1 
条件名称|参数|取值
---|---|---
N7sessact1|动作参数类型|N7会话参数集
会话规则名称|N7sessact1|N7sess1
会话AMBR上行速率（kbps）|N7sessact1|100
会话AMBR下行速率（kbps）|N7sessact1|100
动作2 
条件名称|参数|取值
---|---|---
N7sessact2|动作参数类型|N7会话参数集
会话规则名称|N7sessact2|N7sess2
会话AMBR上行速率（kbps）|N7sessact2|200
会话AMBR下行速率（kbps）|N7sessact2|200
配置规则 
条件1 
规则名称|参数|取值
---|---|---
N7sess1|优先级|10
动作类型|N7sess1|参数填充
日志开关|N7sess1|关闭
条件表达式|N7sess1|{用户类型 = 1}
选中动作参数名称|N7sess1|N7sessact1
条件2 
规则名称|参数|取值
---|---|---
N7sess2|优先级|1
动作类型|N7sess2|参数填充
日志开关|N7sess2|关闭
条件表达式|N7sess2|{用户类型 = 2}
选中动作参数名称|N7sess2|N7sessact2
配置场景 
场景名称|参数|取值
---|---|---
Scenario 3GPP|入口|入口类型|用户信息类
已选入口|Scenario 3GPP|入口|MSISDN
取值|Scenario 3GPP|入口|999999999999999
策略类型|Scenario 3GPP|N7会话控制策略|N7sess1
N7sess2|策略类型|Scenario 3GPP|N7会话控制策略
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置1 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
//NRF服务器节点配置1 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="SMF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="SMF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="SMF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//SCP基本属性配置 
SET SBISCPBASICATTRIBUTE:SCPSWITCH="SCP_ON",CALLBACKMODE="SCP_PROXY" 
//新增路由集配置 
ADD SBISCPROUTESET:ID=2,NAME="2",ADDDISCOVERY="OPTION_NO" 
//新增服务器配置 
ADD SBISCPSERVER:ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100 
//新增节点配置 
ADD SBISCPNODE:ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4 
##### 配置动态路由寻址-RCP为服务使用方（直连场景B模式） 
###### 配置说明 
以Nbsf接口为例，配置RCP为服务使用方（直连场景B模式）的动态路由寻址过程。 
用户上线建立N7会话触发BSF绑定，RCP信令路由决定消息发送。 
在特定DNN接入时，RCP需要向BSF写入PDU会话绑定信息，便于后续AF/NEF针对相同用户地址寻址到相同的PCF。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务使用方（直连B模式场景）的配置流程，如[图3](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newd64495546dcf4649866a36f41df270dc__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图3  配置流程
[]images/7a5a462ad2ca431f8f0bc86814a0dff1.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务，执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)，进行DNN启用BSF配置。
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
NRF网元地址：3224::1114 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv4模板1，关联HTTP客户端IPv6模板4。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
HTTP客户端模板配置表9  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表10  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表11  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表12  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NBSF_MGTHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号12描述信息NrfMasterNrfSlave 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型BSF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型BSF_TYPENF类型PCF_TYPE 
DNN启用BSF配置参数名称参数值DNNdnn1启用BSFENABLE 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="BSF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
配置DNN启用BSF。 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="dnn1",BSF="ENABLE"
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
//NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//DNN启用BSF配置 
ADD DNNBSF:DNN="dnn1",BSF="ENABLE" 
##### 配置动态路由寻址-RCP为服务使用方（SCP_C模式场景） 
###### 配置说明 
以Nbsf接口为例，配置RCP为服务使用方（SCP_C模式场景）的动态路由寻址过程。 
用户上线建立N7会话触发BSF绑定，RCP信令路由决定消息发送。RCP按FQDN选择C模式SCP向BSF进行注册绑定。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务使用方（SCP_C模式场景）的配置配置流程，如[图4](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newad5f2a2a1d35411e8524e675ca877b41__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图4  配置流程
[]images/d24079acb18b4300bed2d0ad630e8685.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务，执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)，进行DNN启用BSF配置。
SCP配置。 
执行[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html)命令，进行SCP基本属性配置。
执行[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html)命令，进行路由集配置。
执行[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html)命令，进行服务器配置。
执行[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html)命令，进行节点配置。
执行[ADD SBISCPSELBYFQDN](../../CommonS_HTTP_LB\zh-cn\mml\1223092.html)命令，进行SCP按FQDN选择配置。
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
NRF网元地址：3224::1114。 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv4模板1，关联HTTP客户端IPv6模板4。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
BSF-FQDN为：bsf1.com.cn 
HTTP客户端模板配置表13  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表14  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表15  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表16  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NBSF_MGTHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号1描述信息NrfMaster 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1 
NRF服务器模板选择配置参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型BSF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型BSF_TYPENF类型PCF_TYPE 
DNN启用BSF配置参数名称参数值DNNims启用BSFENABLE 
SCP基本属性配置参数名称参数值SCP功能开关SCP_ON 
路由集配置参数名称参数值路由集ID2路由集名称2C模式下携带发现头部OPTION_NO 
服务器配置参数名称参数值服务器ID2服务器fqdnscp2.com.cn归属路由集ID2优先级100权重100 
节点配置参数名称参数值节点ID2服务器IP地址3224::1115服务器端口8080归属服务器ID2HTTP客户端模板编号4 
SCP按FQDN选择配置参数名称参数值FQDNbsf1.com.cnSCP模式SCP_C路由集ID2 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="BSF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
配置DNN启用BSF 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="ims",BSF="ENABLE"
SCP配置。 
配置SCP基本属性。 
[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html):SCPSWITCH="SCP_ON"
新增路由集配置。 
[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html):ID=2,NAME="2",ADDDISCOVERY="OPTION_NO"
新增服务器配置。 
[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html):ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100
新增节点配置。 
[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html):ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4
新增SCP按FQDN选择配置。 
[ADD SBISCPSELBYFQDN](../../CommonS_HTTP_LB\zh-cn\mml\1223092.html):FQDN="bsf1.com.cn",SCPMODE="SCP_C",SCPROUTESET=2
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
//NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//DNN启用BSF配置 
ADD DNNBSF:DNN="ims",BSF="ENABLE" 
//SCP基本属性配置 
SET SBISCPBASICATTRIBUTE:SCPSWITCH="SCP_ON" 
//新增路由集配置 
ADD SBISCPROUTESET:ID=2,NAME="2",ADDDISCOVERY="OPTION_NO" 
//新增服务器配置 
ADD SBISCPSERVER:ID=2,FQDN="scp2.com.cn",ROUTESETID=2,PRIORITY=100,WEIGHT=100 
//新增节点配置 
ADD SBISCPNODE:ID=2,SERVERIPADDR="3224::1115",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=4 
//新增SCP按FQDN选择配置 
ADD SBISCPSELBYFQDN:FQDN="bsf1.com.cn",SCPMODE="SCP_C",SCPROUTESET=2 
##### 配置动态路由寻址-RCP为服务使用方（SCP_D模式场景） 
###### 配置说明 
以Nbsf接口为例，配置RCP为服务使用方（SCP_D模式场景）的动态路由寻址过程。 
用户上线建立N7会话触发BSF绑定，RCP信令路由决定消息发送。RCP按NF类型选择D模式SCP向BSF进行注册绑定。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务使用方（SCP_D模式场景）的配置流程，如[图5](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newa69d6432a6904d4fbbce56022905565e__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图5  配置流程
[]images/07bfb48e3308447d84d4b513ba589087.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务，执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)，进行DNN启用BSF配置。
SCP配置。 
执行[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html)命令，进行SCP基本属性配置。
执行[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html)命令，进行路由集配置。
执行[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html)命令，进行服务器配置。
执行[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html)命令，进行节点配置。
执行[ADD SBISCPSELBYNFTYPE](../../CommonS_HTTP_LB\zh-cn\mml\1223034.html)命令，进行SCP按NF类型选择配置。
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
NRF网元地址：3224::1114。 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv4模板1，关联HTTP客户端IPv6模板4。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
HTTP客户端模板配置表17  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表18  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表19  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表20  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NBSF_MGTHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号1描述信息NrfMaster 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1 
NRF服务器模板选择配置参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型BSF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型BSF_TYPENF类型PCF_TYPE 
DNN启用BSF配置参数名称参数值DNNims启用BSFENABLE 
SCP基本属性配置参数名称参数值SCP功能开关SCP_ON 
路由集配置参数名称参数值路由集ID1路由集名称1C模式下携带发现头部OPTION_NO 
服务器配置参数名称参数值服务器ID1服务器fqdnscp1.com.cn归属路由集ID1优先级100权重100 
节点配置参数名称参数值节点ID1服务器IP地址192.162.224.70服务器端口8080归属服务器ID1HTTP客户端模板编号1 
SCP按NF选择配置参数名称参数值目的NF类型BSF_TYPESCP模式SCP_D路由集ID1 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="BSF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
配置DNN启用BSF 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="ims",BSF="ENABLE"
SCP配置。 
配置SCP基本属性。 
[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html):SCPSWITCH="SCP_ON"
新增路由集配置。 
[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html):ID=1,NAME="1",ADDDISCOVERY="OPTION_NO"
新增服务器配置。 
[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html):ID=1,FQDN="scp1.com.cn",ROUTESETID=1,PRIORITY=100,WEIGHT=100
新增节点配置。 
[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html):ID=1,SERVERIPADDR="192.162.224.70",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1
新增SCP按NF类型选择配置。 
[ADD SBISCPSELBYNFTYPE](../../CommonS_HTTP_LB\zh-cn\mml\1223034.html):NFTYPE="BSF_TYPE",SCPMODE="SCP_D",SCPROUTESET=1
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
//NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//DNN启用BSF配置 
ADD DNNBSF:DNN="ims",BSF="ENABLE" 
//SCP基本属性配置 
SET SBISCPBASICATTRIBUTE:SCPSWITCH="SCP_ON" 
//新增路由集配置 
ADD SBISCPROUTESET:ID=1,NAME="1",ADDDISCOVERY="OPTION_NO" 
//新增服务器配置 
ADD SBISCPSERVER:ID=1,FQDN="scp1.com.cn",ROUTESETID=1,PRIORITY=100,WEIGHT=100 
//新增节点配置 
ADD SBISCPNODE:ID=1,SERVERIPADDR="192.162.224.70",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1 
//新增SCP按NF类型选择配置 
ADD SBISCPSELBYNFTYPE:NFTYPE="BSF_TYPE",SCPMODE="SCP_D",SCPROUTESET=1 
##### 配置动态路由寻址-RCP为服务使用方（SCP_Proxy模式场景） 
###### 配置说明 
以Nbsf接口为例，配置RCP为服务使用方（SCP_Proxy模式场景）的动态路由寻址过程。 
用户上线建立N7会话触发BSF绑定，RCP信令路由决定消息发送。RCP按NF实例选择Proxy模式SCP向BSF进行注册绑定。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务使用方（SCP_Proxy模式场景）的配置配置流程，如[图6](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newfbcab0dab388455ebc2b2815d3512961__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图6  配置流程
[]images/674bfedbfb0b43469c6899819f0238a3.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略此段配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务，执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)，进行DNN启用BSF配置。
SCP配置。 
执行[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html)命令，进行SCP基本属性配置。
执行[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html)命令，进行路由集配置。
执行[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html)命令，进行服务器配置。
执行[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html)命令，进行节点配置。
执行执行[ADD SBISCPSELBYNFINSTID](../../CommonS_HTTP_LB\zh-cn\mml\1223046.html)命令，进行SCP按NF实例选择配置。
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
NRF网元地址：3224::1114。 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv4模板1，关联HTTP客户端IPv6模板4。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
BSF实例ID为：160e6cfe-5eea-4036-8566-77744b5e7199，BSF名为bsf1。 
HTTP客户端模板配置表21  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000表22  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000 
HTTP服务端模板配置表23  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080表24  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NBSF_MGTHTTP IPv4模板ID1HTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置参数名称参数值NRF服务器组编号1描述信息NrfMaster 
NRF服务器节点配置参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemeHTTPHTTP客户端模板编号4通知时使用的HTTP服务端模板编号4NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1 
NRF服务器模板选择配置参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型BSF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型BSF_TYPENF类型PCF_TYPE 
DNN启用BSF配置参数名称参数值DNNims启用BSFENABLE 
SCP基本属性配置参数名称参数值SCP功能开关SCP_ON 
路由集配置参数名称参数值路由集ID1路由集名称1C模式下携带发现头部OPTION_NO 
服务器配置参数名称参数值服务器ID1服务器fqdnscp1.com.cn归属路由集ID1优先级100权重100 
节点配置参数名称参数值节点ID1服务器IP地址192.162.224.70服务器端口8080归属服务器ID1HTTP客户端模板编号1 
SCP按实例配置参数名称参数值NF实例标识160e6cfe-5eea-4036-8566-77744b5e7199NF名bsf1SCP模式SCP_PROXY路由集ID1 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="BSF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
配置DNN启用BSF 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="ims",BSF="ENABLE"
SCP配置。 
配置SCP基本属性。 
[SET SBISCPBASICATTRIBUTE](../../CommonS_HTTP_LB\zh-cn\mml\1223020.html):SCPSWITCH="SCP_ON"
新增路由集配置。 
[ADD SBISCPROUTESET](../../CommonS_HTTP_LB\zh-cn\mml\1223022.html):ID=1,NAME="1",ADDDISCOVERY="OPTION_NO"
新增服务器配置。 
[ADD SBISCPSERVER](../../CommonS_HTTP_LB\zh-cn\mml\1223026.html):ID=1,FQDN="scp1.com.cn",ROUTESETID=1,PRIORITY=100,WEIGHT=100
新增节点配置。 
[ADD SBISCPNODE](../../CommonS_HTTP_LB\zh-cn\mml\1223030.html):ID=1,SERVERIPADDR="192.162.224.70",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1
新增SCP按NF实例选择配置。 
[ADD SBISCPSELBYNFINSTID](../../CommonS_HTTP_LB\zh-cn\mml\1223046.html):NFINSTID="160e6cfe-5eea-4036-8566-77744b5e7199",NFNAME="bsf1",SCPMODE="SCP_PROXY",SCPROUTESET=1
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=1,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
//NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=4,NOTIFYSVRPROFILEID=4,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//DNN启用BSF配置 
ADD DNNBSF:DNN="ims",BSF="ENABLE" 
//SCP基本属性配置 
SET SBISCPBASICATTRIBUTE:SCPSWITCH="SCP_ON" 
//新增路由集配置 
ADD SBISCPROUTESET:ID=2,NAME="2",ADDDISCOVERY="OPTION_NO" 
//新增服务器配置 
ADD SBISCPSERVER:ID=1,FQDN="scp1.com.cn",ROUTESETID=1,PRIORITY=100,WEIGHT=100 
//新增节点配置 
ADD SBISCPNODE:ID=2,SERVERIPADDR="192.162.224.70",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1 
//新增SCP按NF实例选择配置 
ADD SBISCPSELBYNFINSTID:NFINSTID="160e6cfe-5eea-4036-8566-77744b5e7199",NFNAME="bsf1",SCPMODE="SCP_PROXY",SCPROUTESET=1 
##### 配置静态路由寻址-RCP为服务使用方（直连场景A模式） 
###### 配置说明 
以N28接口为例，配置RCP为服务使用方，与目的NF（CHF）直连场景（A模式）下的静态路由寻址过程。 
用户上线建立N7会话触发N28会话建立，PCF信令路由决定消息发送。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
RCP作为服务使用方（直连场景A模式）的配置流程，如[图7](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z53e2e723a7124afca8c480a4c5940774__6ec7e704-3b75-4be0-a6f0-2f0a2c7df172)所示。
图7  配置流程
[]images/%E7%BB%98%E5%9B%BE3-CHF%E9%9D%99%E6%80%81.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，进行关联的HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
CHF信息配置。 
根据用户关键字配置对应的SUPI或者GPSI号段。 
 说明： 
以GPSI举例说明，如需配置SUPI范围组，用命令[ADD SBISUPIRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220685.html)和[ADD SBISUPIRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220689.html)。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIGPSIRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220693.html)命令，进行GPSI范围组编号配置。
执行[ADD SBIGPSIRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220697.html)命令，进行GPSI范围组参数配置。
执行[ADD SBICHFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220961.html)命令，进行CHF信息配置。
NF相关配置。 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html)命令，进行IPv6地址配置。
执行[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html)命令，进行IP端点配置。
执行[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html)命令，进行IP端点组编号配置。
执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，进行IP端点组参数配置。
执行[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html)命令，进行NF服务版本组编号配置。
执行[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html)命令，进行NF服务版本组参数配置。
执行[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html)命令，进行对端NF基本信息配置。
执行[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html)命令，进行对端NF扩展信息配置。
执行[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html)命令，进行对端NF实例配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD USERPCID](../../Npcf_PolicyManagement\zh-CN\mml\1787606.html)命令，进展用户级策略计数器标识配置。
进入策略管理页面，配置N7会话策略。 
###### 配置实例 
######## 场景说明 
CHF通常按集群方式部署，对PCF暴露一个主机地址，CHF在集群内部实现主备或负荷分担。有时也存在局点部署CHF时，对PCF暴露主备主机地址，此时，需要PCF能够首选到主CHF进行消费限额控制。 
######## 数据规划 
RCP网元地址：4003::19:5。 
CHF网元地址为4003::19:3、4003::19:4。 
关联的HTTP客户端模板配置中，服务类型NCHF_SPENDLMTCONTROL，关联HTTP客户端IPv6模板1。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
备注：如果CHF和PCF不在同一平面，需增加通知URI服务端模板配置。 
HTTP客户端模板配置参数名称参数值编号1IP地址4003::19:5起始端口20000终止端口30000 
HTTP服务端模板配置参数名称参数值编号1IP地址4003::19:5端口8080 
关联HTTP客户端模板配置参数名称参数值服务类型NCHF_SPENDLMTCONTROLHTTP IPv6模板ID1 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
通知URI服务端模板配置（可选）参数名称参数值服务类型NCHF_SPENDLMTCONTROL服务端模板ID11 
GPSI范围组编号配置参数名称参数值GPSI范围组编号100 
GPSI范围组参数配置参数名称参数值配置索引100GPSI范围组编号100开始0000000000000结束9999999999999 
CHF信息配置参数名称参数值CHF信息编号100GPSI范围组编号100 
IPv6地址配置参数名称参数值IPv6地址编号100101IP地址4004::19:34004::19:4 
IP端点配置参数名称参数值IP端点编号100101端口80808080IPv6地址编号100101 
IP端点组编号配置参数名称参数值IP端点组编号100101 
IP端点组参数配置参数名称参数值配置索引100101IP端点组编号100101IP端点编号100101 
NF服务版本组编号配置参数名称参数值NF服务版本组编号100 
NF服务版本组参数配置参数名称参数值配置索引100NF服务版本组编号100API URI版本号v1API完整版本号v1 
对端NF基本信息配置参数名称参数值对端NF信息编号100101NF实例标识100101NF类型CHF_TYPECHF_TYPENF状态REGISTEREDREGISTEREDNF实例名称260e6cfe-5eea-4036-8566-77744b5e7101260e6cfe-5eea-4036-8566-77744b5e7199 
对端NF扩展信息配置参数名称参数值对端NF信息编号100101CHF信息编号100100 
对端NF实例配置参数名称参数值配置索引100101归属NF编号100101服务实例标识100101服务名称NCHF_SPENDINGLIMITCONTROLNCHF_SPENDINGLIMITCONTROL服务版本组编号100100协议模式HTTPHTTP服务实例状态REGISTEREDREGISTERED域名chf1.zte.com.cnchf2.zte.com.cnIP端点组编号100101优先级12 
重选配置参数名称参数值目的NF类型CHF_TYPE 
服务发现方式配置参数名称参数值目的NF类型CHF_TYPE发现方式STATIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型CHF_TYPENF类型PCF_TYPE 
用户策略计数器标识配置参数名称参数值用户级策略计数器标识配置编号1策略计数器标识11 
######## 配置步骤 
HTTP客户端版本配置 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
HTTP服务端版本配置 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
关联HTTP客户端模板配置 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=2,SERVICETYPE="NCHF_SPENDLMTCONTROL",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
服务基础配置 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
（可选）通知URI服务端模板配置 
[ADD NOTIURISVRTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788170.html):SERVICETYPE="NCHF_SPENDLMTCONTROL",SVRID1=1
CHF相关配置 
GPSI范围组编号配置 
[ADD SBIGPSIRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220693.html):ARRAYID=100
GPSI范围组参数配置 
[ADD SBIGPSIRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220697.html):INDEX=100,ARRAYID=100,START="0000000000000",END="9999999999999"
CHF信息配置 
[ADD SBICHFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220961.html):ID=100,GPSIRANGEARRAY=100
NF相关配置 
IPv6地址配置 
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=100,IP="4004::19:3"
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=101,IP="4004::19:4"
IP端点配置 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=100,IPV6=100,PORT=8080
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=101,IPV6=101,PORT=8080
IP端点组编号配置 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=100
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=101
IP端点组参数配置 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=100,ARRAYID=100,IPENDPOINT=100
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=101,ARRAYID=101,IPENDPOINT=101
NF服务版本组编号配置 
[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html):ARRAYID=100
NF服务版本组参数配置 
[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html):INDEX=100,ARRAYID=100,APIVERSIONINURI="v1",APIFULLVERSION="v1"
对端NF基本信息配置 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=100,NFINSTANCEID="100",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7101",PRIORITY=1
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=101,NFINSTANCEID="101",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7199",PRIORITY=2
对端NF扩展信息配置 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=100,CHFINFO=100
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=101,CHFINFO=100
对端NF实例配置 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=100,NFINDEX=100,SRVINSTANCEID="100",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf1.zte.com.cn",IPENDPOINTARRAY=100,PRIORITY=1
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=101,NFINDEX=101,SRVINSTANCEID="101",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf2.zte.com.cn",IPENDPOINTARRAY=101,PRIORITY=2
重选配置 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="CHF_TYPE"
服务发现方式配置 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="CHF_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
路由策略配置 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
用户级策略计数器标识配置 
[ADD USERPCID](../../Npcf_PolicyManagement\zh-CN\mml\1787606.html):ID=1,PCID1="1"
策略配置 
配置自定义策略变量 
自定义变量名称|策略变量|策略变量属性
---|---|---
pcid1|策略变量|字符型策略计数器状态(Sy)
策略计数器标识生成方式|pcid1|指定
策略计数器标识|pcid1|1
日志开关|pcid1|关闭
配置条件 
条件1 
条件名称|参数|取值
---|---|---
PCS=11|选择策略变量|其他
策略变量类别|PCS=11|自定义策略变量
策略变量|PCS=11|pcid1
操作符|PCS=11|=
值类型|PCS=11|值
值|PCS=11|11
条件2 
条件名称|参数|取值
---|---|---
PCS=22|选择策略变量|其他
策略变量类别|PCS=22|自定义策略变量
策略变量|PCS=22|pcid1
操作符|PCS=22|=
值类型|PCS=22|值
值|PCS=22|22
配置动作参数 
N7会话规则1动作参数 
动作参数名称|参数名称|取值
---|---|---
action_N7sess1|动作参数类型|N7会话参数集
会话规则名称|action_N7sess1|N7sess1
N7会话规则2动作参数 
动作参数名称|参数名称|取值
---|---|---
action_N7sess2|动作参数类型|N7会话参数集
会话规则名称|action_N7sess2|N7sess2
配置N7会话规则 
PCS=11时下发会话规则1。 
规则名称|规则参数|参数取值
---|---|---
rule_sess1|优先级|10
动作类型|rule_sess1|参数填充
日志开关|rule_sess1|关闭
条件表达式|rule_sess1|PCS=11
选中动作参数名称|rule_sess1|action_N7sess1
PCS=22时下发会话规则2。 
规则名称|规则参数|参数取值
---|---|---
rule_sess2|优先级|10
动作类型|rule_sess2|参数填充
日志开关|rule_sess2|关闭
条件表达式|rule_sess2|PCS=22
选中动作参数名称|rule_sess2|action_N7sess2
配置场景 
场景名称|参数|取值
---|---|---
Scenario 3GPP|入口1|入口类型|接入信息类
已选入口|Scenario 3GPP|入口1|接入类型
取值|Scenario 3GPP|入口1|3GPP接入
策略类型|Scenario 3GPP|N7会话控制策略|rule_sess1
rule_sess2|策略类型|Scenario 3GPP|N7会话控制策略
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=2,SERVICETYPE="NCHF_SPENDLMTCONTROL",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP" 
//通知URI服务端模板配置（可选） 
ADD NOTIURISVRTPROF:SERVICETYPE="NCHF_SPENDLMTCONTROL",SVRID1=1 
//GPSI范围组编号配置 
ADD SBIGPSIRANGEARRID:ARRAYID=100 
//GPSI范围组参数配置 
ADD SBIGPSIRANGEARRPARAM:INDEX=100,ARRAYID=100,START="0000000000000",END="9999999999999" 
//CHF信息配置 
ADD SBICHFINFO:ID=100,GPSIRANGEARRAY=100 
//IPv6地址配置 
ADD SBIIPV6ADDR:ID=100,IP="4004::19:3" 
ADD SBIIPV6ADDR:ID=101,IP="4004::19:4" 
//IP端点配置 
ADD SBIIPENDPOINT:INDEX=100,IPV6=100,PORT=8080 
ADD SBIIPENDPOINT:INDEX=101,IPV6=101,PORT=8080 
//IP端点组编号配置 
ADD SBIIPENDPOINTARRID:ARRAYID=100 
ADD SBIIPENDPOINTARRID:ARRAYID=101 
//IP端点组参数配置 
ADD SBIIPENDPOINTARRPARAM:INDEX=100,ARRAYID=100,IPENDPOINT=100 
ADD SBIIPENDPOINTARRPARAM:INDEX=101,ARRAYID=101,IPENDPOINT=101 
//NF服务版本组编号配置 
ADD SBINFSVERSIONARRID:ARRAYID=100 
//NF服务版本组参数配置 
ADD SBINFSVERSIONARRPARAM:INDEX=100,ARRAYID=100,APIVERSIONINURI="v1",APIFULLVERSION="v1" 
//对端NF基本信息配置 
ADD SBIPEERNFBASEINFO:ID=100,NFINSTANCEID="100",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7101",PRIORITY=1 
ADD SBIPEERNFBASEINFO:ID=101,NFINSTANCEID="101",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7199",PRIORITY=2 
//对端NF扩展信息配置 
ADD SBIPEERNFEXTINFO:ID=100,CHFINFO=100 
ADD SBIPEERNFEXTINFO:ID=101,CHFINFO=100 
//对端NF实例配置 
ADD SBIPEERNFSERVICEINSTANCE:INDEX=100,NFINDEX=100,SRVINSTANCEID="100",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf1.zte.com.cn",IPENDPOINTARRAY=100,PRIORITY=1 
ADD SBIPEERNFSERVICEINSTANCE:INDEX=101,NFINDEX=101,SRVINSTANCEID="101",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf2.zte.com.cn",IPENDPOINTARRAY=101,PRIORITY=2 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="CHF_TYPE" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="CHF_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//用户级策略计数器标识配置 
ADD USERPCID:ID=1,PCID1="1" 
##### 配置核心网SMF和边缘SMF接入 
###### 配置说明 
RCP与双网络平面对接，即N7、N15接口需同时对接核心网SMF/AMF和边缘SMF/AMF。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
###### 配置过程 
以对接核心网SMF和边缘SMF为例，介绍对接双网络平面的配置流程，如[图8](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new08e53ab232ca4576aa9f66479f15629e__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图8  配置流程
[]images/eede9ea0ce544f6ca05011485ae26ca1.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
执行[ADD PNHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1789109.html)命令，进行专用网络客户端模板配置。
进入策略管理页面，配置N7会话控制策略。 
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
核心网SMF接入（普通VPN接入），关联HTTP客户端模板配置中，服务类型NPCF_SMPOLICYCONTROL，关联HTTP客户端IPv6模板4。 
边缘SMF接入（专网VPN接入），专用网络客户端模板配置中，服务类型NPCF_SMPOLICYCONTROL，关联HTTP客户端IPv4模板1。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
HTTP客户端模板配置表25  IPv4模板参数名称参数值编号1IP地址192.162.224.10起始端口20000终止端口30000VPN ID11表26  IPv6模板参数名称参数值编号4IP地址3224::1111起始端口20000终止端口30000VPN ID0 
HTTP服务端模板配置表27  IPv4模板参数名称参数值编号1IP地址192.162.224.10端口8080VPNID11表28  IPv6模板参数名称参数值编号4IP地址3224::1111端口8080VPNID0 
关联HTTP客户端模板配置参数名称参数值服务类型NPCF_SMPOLICYCONTROLHTTP IPv6模板ID4 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
专用网络客户端模板配置参数名称参数值服务类型NPCF_SMPOLICYCONTROL专用网络标识11HTTP IPv4模板ID1 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=11,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=11,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=0,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1"&"4",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置专用网络客户端模板。 
[ADD PNHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1789109.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",SPNID=11,HTTP4CLTID=1
配置策略。 
配置策略条件。 
条件1 
条件名称|参数|取值
---|---|---
usertype=1|选择策略变量|其他
策略变量类别|usertype=1|用户信息类
策略变量|usertype=1|用户类型
操作符|usertype=1|=
值类型|usertype=1|值
值|usertype=1|1
条件2 
条件名称|参数|取值
---|---|---
usertype=2|选择策略变量|其他
策略变量类别|usertype=2|用户信息类
策略变量|usertype=2|用户类型
操作符|usertype=2|=
值类型|usertype=2|值
值|usertype=2|2
配置动作参数 
动作1 
条件名称|参数|取值
---|---|---
N7sessact1|动作参数类型|N7会话参数集
会话规则名称|N7sessact1|N7sess1
会话AMBR上行速率（kbps）|N7sessact1|100
会话AMBR下行速率（kbps）|N7sessact1|100
动作2 
条件名称|参数|取值
---|---|---
N7sessact2|动作参数类型|N7会话参数集
会话规则名称|N7sessact2|N7sess2
会话AMBR上行速率（kbps）|N7sessact2|100
会话AMBR下行速率（kbps）|N7sessact2|100
配置规则 
条件1 
规则名称|参数|取值
---|---|---
N7sess1|优先级|10
动作类型|N7sess1|参数填充
日志开关|N7sess1|关闭
条件表达式|N7sess1|{用户类型 = 1}
选中动作参数名称|N7sess1|N7sessact1
条件2 
规则名称|参数|取值
---|---|---
N7sess2|优先级|1
动作类型|N7sess2|参数填充
日志开关|N7sess2|关闭
条件表达式|N7sess2|{用户类型 = 2}
选中动作参数名称|N7sess2|N7sessact2
配置场景 
场景名称|参数|取值
---|---|---
xq1|入口|入口类型|用户信息类
已选入口|xq1|入口|MSISDN
取值|xq1|入口|999999999999999
策略类型|xq1|N7会话控制策略|N7sess1
N7sess2|策略类型|xq1|N7会话控制策略
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=192.162.224.10,STARTPORT=20000,ENDPORT=30000,VPNID=11,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
ADD CLIENTPROFILE:ID=4,IPADDR="3224::1111",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=192.162.224.10,PORT=8080,VPNID=11,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
ADD SERVERPROFILE:ID=4,IPADDR="3224::1111",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH=SWITCH_ON,HTTPVERSION=HTTP_2,VERIFYCLI=SWITCH_OFF,HTTP2_DSCP=0,ISSHORT=OPTION_NO,LINKAGINGTIME=0 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=0,HTTP6CLTID=4,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP" 
//专用网络客户端模板 
ADD PNHTTPCLTPROF:SERVICETYPE="NPCF_SMPOLICYCONTROL",SPNID=11,HTTP4CLTID=1 
##### 配置支持HTTPS协议 
###### 配置说明 
HTTPS协议的路由寻址的业务流程与HTTP协议的路由寻址的业务流程一样。 
以Nbsf接口为例，配置RCP为服务使用方（直连场景B模式），支持HTTPS协议的动态路由寻址过程。 
用户上线建立N7会话触发BSF绑定，RCP信令路由决定消息发送。 
###### 配置前提 
HTTP信令路由功能是RCP和相邻接口配合共同完成的，因此在配置此特性之前保证RCP和周边网元交互正常。 
已加载TLS证书套件，包含证书、秘钥对和根证书。参见“加载TLS证书套件”。 
###### 配置过程 
RCP作为服务使用方（直连B模式场景），支持HTTPS协议的配置流程，如[图9](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new7a27c46f48fc45a286ad67c96ce11860__0f1dbeda-d341-428a-98f5-8c2e28853153)所示。
图9  配置流程
[]images/d96f1caa36904a36bcfd6980daa449d8.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
（可选）NRF服务器相关配置。（注：如果已有NRF相关配置，可以忽略相关步骤配置） 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，进行重选配置。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，修改服务发现配置。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，进行路由策略配置。
选择Npcf_PolicyManagement_0 服务，执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)，进行DNN启用BSF配置。
###### 配置实例 
######## 数据规划 
RCP网元地址：192.162.224.10 / 3224::1111 
NRF网元地址：3224::1114 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv4模板2，关联HTTP客户端IPv6模板5。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
HTTP客户端模板配置表29  IPv4模板参数名称参数值编号2IP地址192.162.224.10起始端口40000终止端口50000TLS证书名client表30  IPv6模板参数名称参数值编号5IP地址3224::1111起始端口40000终止端口50000TLS证书名client 
HTTP服务端模板配置表31  IPv4模板参数名称参数值编号2IP地址192.162.224.10端口443TLS证书名serverTLS认证客户端开关SWITCH_ON表32  IPv6模板参数名称参数值编号5IP地址3224::1111端口443TLS证书名serverTLS认证客户端开关SWITCH_ON 
关联HTTP客户端模板配置参数名称参数值服务类型NBSF_MGTHTTP IPv4模板ID2HTTP IPv6模板ID5 
服务基础配置参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1HTTP服务端模板ID2、5 
NRF服务器分组配置参数名称参数值NRF服务器组编号12描述信息NrfMasterNrfSlave 
NRF服务器节点配置 说明：NRF支持TLS，URI scheme为HTTPS。参数名称参数值NRF服务器节点编号1NRF服务器IP地址3224::1114NRF服务器端口443NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemeHTTPSHTTP客户端模板编号5通知时使用的HTTP服务端模板编号5NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器策略配置 说明：NRF模式默认互备双活模式（DUAL_ACTIVE），如需要可配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型BSF_TYPE 
服务发现配置参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
路由策略配置参数名称参数值目的NF类型BSF_TYPENF类型PCF_TYPE 
DNN启用BSF配置参数名称参数值DNNdnn1启用BSFENABLE 
######## 配置步骤 
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=2,IPADDR=192.162.224.10,STARTPORT=40000,ENDPORT=50000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="client"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=5,IPADDR="3224::1111",STARTPORT=40000,ENDPORT=50000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="client"
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=2,IPADDR=192.162.224.10,PORT=443,VPNID=0,REQBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="server",VERIFYCLI="SWITCH_ON"
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=5,IPADDR="3224::1111",PORT=443,VPNID=0,REQBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="server",VERIFYCLI="SWITCH_ON"
关联HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=0,HTTP6CLTID=0,HTTPS4CLTID=2,HTTPS6CLTID=5,HTURI="IP"
配置服务基础。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="2"&"5",TOPHIDE="NOTHIDE",SCHEMA="HTTPS"
配置NRF服务器。 
配置NRF服务器分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="3224::1114",SERVERPORT=443,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTPS",APIVERSION="V1",CLIENTPROFILEID=5,NOTIFYSVRPROFILEID=5,PRIORITY=1,GROUPID=1
配置NRF服务器策略。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择。 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
配置重选。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="BSF_TYPE"
修改服务发现配置，其中订阅者NF类型为必选。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES
配置DNN启用BSF。 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="dnn1",BSF="ENABLE"
######## 配置脚本 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=2,IPADDR=192.162.224.10,STARTPORT=40000,ENDPORT=50000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="client" 
ADD CLIENTPROFILE:ID=5,IPADDR="3224::1111",STARTPORT=40000,ENDPORT=50000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="client" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=2,IPADDR=192.162.224.10,PORT=443,VPNID=0,REQBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="server",VERIFYCLI="SWITCH_ON" 
ADD SERVERPROFILE:ID=5,IPADDR="3224::1111",PORT=443,VPNID=0,REQBODYMAXLENGTH=2097152,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",TLSCERTNAME="server",VERIFYCLI="SWITCH_ON" 
//关联HTTP客户端模板配置 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="Nbsf_Management",HTTP4CLTID=0,HTTP6CLTID=0,HTTPS4CLTID=2,HTTPS6CLTID=5,HTURI="IP" 
//服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="2"&"5",TOPHIDE="NOTHIDE",SCHEMA="HTTPS" 
//NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
//NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="3224::1114",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=5,NOTIFYSVRPROFILEID=5,PRIORITY=1,GROUPID=1 
//NRF服务器策略配置 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//NRF服务器模板配置 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
//NRF服务器模板选择配置 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
//重选配置 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
//修改服务发现配置，其中订阅者NF类型为必选 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//服务发现方式配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443 
//路由策略配置 
ADD SBIROUTEPOLICY:TARGETNFTYPE="SMF_TYPE",NFTYPE="PCF_TYPE",NEEDTOKEN=NO,INNERAUTOBACK=AUTOBACK_INITANCHOR,FQDNINTARGETURI=NO,INNERDISASTERSWITCH=YES 
//DNN启用BSF配置 
ADD DNNBSF:DNN="dnn1",BSF="ENABLE" 
##### 测试用例 
测试条目|RCP为服务提供方SCP_C模式场景时的业务流程
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务提供方（SCP_C模式场景）”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri包含http及3224::1114地址，且头部携带Via:SCP-3224::1115:8080、3gpp-sbi-binding。从SPR获取签约和用量信息，其中UserType=1。PNR更新签约修改用户签约，其中UserType=2。SMF回复N7-UpdateNotify_Res响应。N7会话离线。
通过准则|N7会话上线成功，下发N7会话规则N7sess1，头域字段携带3gpp-sbi-binding。PNR更新签约成功，PCF返回PNA，触发UpdateNotify_Req重决策下发携带N7会话规则N7sess2。SBI-GW将请求发往3224::1115，请求中的url.apiroot取3224::1115，头域携带3gpp-sbi-callback、3gpp-sbi-binding、3gpp-sbi-routing-binding、3gpp-sbi-target-apiroot、user-agent。N7会话离线，数据区正常释放。
测试条目|RCP为服务提供方SCP_PROXY模式场景时的业务流程
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务提供方（SCP_Proxy模式场景）”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri包含http及3224::1114地址，且头部携带Via:SCP-3224::1115:8080，3gpp-sbi-binding，并从SPR获取签约和用量信息，其中UserType=1。PNR更新签约修改用户签约，其中UserType=2。SMF回复N7-UpdateNotify_Res响应。N7会话离线。
通过准则|N7会话上线成功，下发N7会话规则N7sess1。PNR更新签约成功，PCF返回PNA，触发UpdateNotify_Req重决策下发携带N7会话规则N7Sess2，SBI-GW将请求发往3224::1115，请求中的url.apiroot取3224::1114，头域携带：3gpp-sbi-callback，3gpp-sbi-binding，3gpp-sbi-routing-binding，user-agent。N7会话离线，数据区正常释放。
测试条目|直连（B模式）场景RCP向BSF发现注册绑定信息
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务使用方（直连场景B模式）”进行配置。
测试步骤|用户A在本地接入网络，携带DNN=ims。用户发起语音呼叫。用户下线。
通过准则|RCP收到用户上线请求后，检查DNN需要向BSF注册，本地未配置BSF信息，向NRF发送服务发现请求，请求发现BSF。收到NRF返回的BSF信息后，向BSF发送注册请求，RCP收到BSF的成功响应后向SMF返回上线成功。用户语音业务正常。用户下线，RCP向BSF发送注销请求。收到BSF返回的响应后向SMF返回下线成功。
测试条目|C模式通过FQDN确定SCP向BSF注册绑定消息
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务使用方（SCP_C模式场景）”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri包含http及IPv6地址，dnn=ims，3gpp-sbi-binding。SMF修改N7会话，携带UE地址为IPv4地址。SCP返回BSF Profile信息，其中BSF地址为bsfipv4。SCP返回正确初始绑定201响应，同时携带location和3gpp-Sbi-Binding头部信息。N7会话离线。
通过准则|N7会话上线成功。N7会话更新成功。SBI-GW根据当前类型分析为SCP-C模式，PCF发起NRF查询。SBI-GW根据服务发现结果中的FQDN在按FQDN路由SCP配置中查找，确定通过C模式SCP访问目的NF和使用的SCP路由集，发送BSF初始注册绑定请求。SBI-GW编码HTTP2业务请求，在url.apiroot携带SCP信息，头域中携带3gpp-Sbi-Target-apiRoot中携带targetNF信息、user-agentN7会话离线成功，并发送BSF注销绑定请求，头域携带3gpp-sbi-target-apiroot，user-agent，3gpp-sbi-routing-binding，BSF注销请求发送到SCPv4地址，携带3gpp-Sbi-Routing-Binding、3gpp-Sbi-Target-apiRoot（其中携带targetNF信息 ）
测试条目|D模式通过NFtype确定SCP向BSF注册绑定消息
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务使用方（SCP_D模式场景）”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri包含http及IPv6地址，dnn=ims。SMF修改N7会话，携带UE地址为IPv4地址。SCP返回正确初始绑定201响应，同时携带location，例如：http://$bsfipv4:8080/nbsf-management/v1/pcfBindings/123456789。N7会话离线。SCP返回注销绑定响应204。
通过准则|N7会话上线成功。N7会话更新成功。SBI-GW根据当前类型分析为SCP-D模式，发送BSF初始注册绑定请求。在url.apiroot携带SCP信息，3gpp-Sbi-Discovery-*头部携带业务查询参数，其中*包含以前正常发现时的参数（/nnrf-disc/v1/nf-instances?dnn=ims&requester-nf-instance-fqdn=pcf&requester-nf-instance-id=$NFInstanceID&requester-nf-type=PCF&service-names=nbsf-management&target-nf-type=BSF&ue-ipv4-address=$ipv4）:authority: [v6地址1]:80803gpp-Sbi-Discovery-requester-nf-instance-id: $NFInstanceID3gpp-Sbi-Discovery-target-nf-type: BSF3gpp-Sbi-Discovery-ue-ipv4-address: $ipv43gpp-Sbi-Discovery-service-names: nbsf-management3gpp-Sbi-Discovery-dnn: ims3gpp-Sbi-Discovery-requester-nf-type: PCF3gpp-Sbi-Discovery-requester-nf-instance-fqdn: pcf收到应答后，SB-GW回复给PCF业务。N7会话离线成功，并发送BSF注销绑定请求，头域携带user-agent直接发送到SCP地址。
测试条目|Proxy模式通过NF实例确定SCP向BSF注册绑定消息
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置动态路由寻址-RCP为服务使用方（SCP_Proxy模式场景）”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri包含http及IPv6地址，dnn=ims。SMF修改N7会话，携带UE地址为IPv4地址。SCP返回正确初始绑定201响应，同时携带location和3gpp-Sbi-Binding头部信息。N7会话离线。SCP返回注销绑定响应204。
通过准则|N7会话上线成功。N7会话更新成功。SBI-GW根据服务发现结果中的NFInstanceID在按NFInstanceId路由SCP配置中查找，确定通过Proxy模式SCP访问目的NF和使用的SCP路由集，发送BSF初始注册绑定请求。SBI-GW编码HTTP2业务请求，在url.apiroot携带选中的BSF信息。收到应答后，SB-GW回复给PCF业务。N7会话离线成功，并发送BSF注销绑定请求，头域携带user-agent，3gpp-sbi-routing-binding，直接发送到SCP地址。
测试条目|CHF静态路由寻址
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置静态路由寻址-RCP为服务使用方（直连场景A模式）”进行配置。
测试步骤|SMF与RCP间建立多个用户的PDU会话，请求消息携带的notificationUri包含FQDN为smf.com.cn。PCF触发N28，进行消费配额限制初始订阅。CHF返回PCS状态为11。CHF通知RCP用户消费状态变更为22。SMF与RCP间删除多个用户的PDU会话。
通过准则|RCP正确匹配到关联的HTTP客户端模板中NCHF_SPENDLMTCONTROL的记录，并选用主CHF4003::19:3地址发送HTTP消息，进行消费配额限制初始订阅。订阅HTTP消息中notificationUri为包含http://[4003::19:5]；消息头部URI包含主用CHF地址4003::19:3，如果主CHF主机地址4003::19:3不可用，可选用备用CHF主机地址4003::19:4进行消费配额限制初始订阅。CHF通知RCP用户消费状态变更，RCP重新决策需要下发新的策略给SMF，结合返回的结果决策通过4003::19:3地址发出通知消息。
测试条目|N7/N15接口需同时对接核心网SMF/AMF及边缘SMF/AMF
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置核心网SMF和边缘SMF接入”进行配置。
测试步骤|SMF创建N7会话，消息中携带的notificationUri为VPNID11对应地址，从VPNID为11对应的链路上线，构造的location为该链路对应服务端地址。并从SPR获取签约和用量信息，其中UserType=1。PNR更新签约修改用户签约，其中UserType=2。SMF回复N7-UpdateNotify_Res响应。N7会话离线。
通过准则|N7会话上线成功，下发N7会话规则N7Sess1。PNR更新签约成功，PCF返回PNA，触发UpdateNotify_Req重决策从VPNID11对应的链路下发携带N7会话规则N7Sess2。N7会话离线，数据区正常释放。
测试条目|RCP支持TLS
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置支持HTTPS协议”进行配置。
测试步骤|用户A在本地接入网络，携带DNN=ims。用户发起语音呼叫。用户下线。
通过准则|RCP收到用户上线请求后，检查DNN需要向BSF注册，本地未配置BSF信息，向NRF发送服务发现请求，请求发现BSF。收到NRF返回的BSF信息后，向BSF发送注册请求，RCP收到BSF的成功响应后向SMF返回上线成功。用户语音业务正常。用户下线，RCP向BSF发送注销请求。收到BSF返回的响应后向SMF返回下线成功。所有消息都走HTTPS格式。
#### 参考 
##### 加载TLS证书套件 
###### 摘要 
本节介绍如何加载服务端和客户端证书套件。 
###### 前提 
已在分层接入页面接入待加载证书的网元代理，且连接状态正常。 
已准备好TLS证书套件，包含证书、秘钥对和根证书。证书类别说明服务端证书套件套件名称：server证书：server.crt密钥对：server.key根证书：ca.crt客户端证书套件套件名称：client   证书：client.crt密钥对：client.key根证书：ca.crt 
###### 步骤 
登录EM，选择菜单维护→CN NF维护→网元证书管理
，进入网元证书管理页面，如[图1](1568947104006.html#z7c9973e659ca4aaa864dd02ce8f0cb11__8b6d00ff-3359-4da4-8836-09fbc7db37ba)所示。
图1  证书管理
[]images/1568948549410.png)
选中需要加载证书的网元，单击加载证书套件，打开加载证书套件页面，填写证书套件组名称，添加(根)证书文件、密钥对文件以及用户密钥信息。服务端证书加载页面如[图2](1568947104006.html#z7c9973e659ca4aaa864dd02ce8f0cb11__6ddfce5d-c43b-47a7-9c1e-c61e8e569ad3)所示，客户端证书加载页面如[图3](1568947104006.html#z7c9973e659ca4aaa864dd02ce8f0cb11__556eb148-0431-4e62-b1a0-4d965f619736)所示。
图2  加载服务端证书套件
[]images/fuwuduanzhengshu.png)
图3  加载客户端证书套件
[]images/kehuduan%20zhengshu.png)
单击确定按钮，通过FTP/SFTP上传密钥和(根)证书文件。
### 缩略语 
### 缩略语 
#### SCP 
Service Communication Proxy服务通讯代理
#### URI 
Uniform Resource Identifier统一资源标识符
### FL-07-01-002 中移策略报表 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|说明
---|---
POP|策略运营平台。根据各方信息制定合理的运营策略。
EDR日志|Event Data Record，事件日志记录。
##### 描述 
####### 特性定义 
中移报表功能是针对中国移动的定制化的策略分析功能。RCP提供分析报表给POP-D平台，用于PCC策略的效果评估和可视化呈现，方便运维人员在POP-D平台上查看策略实施后带来的收益，并据此优化调整，制定经准策略。
RCP支持策略数据查询功能、策略数据统计功能、上传统计文件失败时的SOAP通知功能。
策略数据查询功能用户通知历史信息查询策略生效统计信息查询业务变更历史信息查询策略签约趋势查询策略历史查询 
策略数据统计功能策略/规则的映射信息策略统计信息规则统计信息 
SOAP通知功能RCP支持SFTP方式上传策略数据统计文件到POP-D平台。当策略数据统计文件上传失败时，RCP支持通过SOAP方式通知POP-D平台。 
####### 背景知识 
RCP可根据协议接口的信令消息和配置的具体场景，感知用户发生的策略事件。当事件发生时，RCP支持实时记录相关信息，定期向POP-D平台上报周期内的各种统计数据，供运营商结合现网网络数据进行运营分析，优化业务部署，升运营效率。
RCP支持本网元作为SOAP服务端，为运营商POP-D平台提供实时查询服务。POP-D平台可实时获取用户的签约、策略等状态数据，方便运营商为终端用户优化服务提供更有效的数据支撑。
##### 应用场景 
网络业务分析运营商需要根据终端用户的用量信息、策略决策、用户事件、用户签约配额等信息进行统计分析以及趋势分析，用于后续的网络优化和业务部署。 
用户投诉处理通过详尽的EDR日志，记录用户行为数据的轨迹记录，便于用户投诉时作为依据向用户做详尽的解答，提升用户体验和信任度。 
故障定位日志记录也可以作为网络内部问题定位的数据使用。 
##### 客户收益 
对运营商和用户的收益说明参见[表1](d0e10.html#d0e151__2d7890c3-91d9-4a4d-bf7b-d7b54cef4ed9)。
收益方|收益描述
---|---
运营商|通过对日志进行网络业务分析，优化网络和部署业务。通过日志获取用户行为轨迹、用户偏好，提升用户体验。
用户|用户投诉有据可查。
##### 实现原理 
###### 系统架构 
中移策略报表架构如[图1](d0e10.html#d0e191__eb6663a6-c446-42f8-b3b0-57a2b2657b3c)所示。
图1  系统架构
[]images/1628164773201.png)
###### 各网元作用 
涉及的网元及其功能参见[表2](d0e10.html#d0e198__636d9ddb-3938-431d-9f4c-b49b60cc8ae7)。
网元|描述
---|---
POP-D|作为SOAP客户端向RCP查询相关分析/统计信息，包括用户通知历史信息、策略生效统计信息、业务变更历史信息、策略签约趋势、策略历史。作为SOAP服务端RCP通过SFTP方式上传统计文件到POP-D。当统计文件上传失败时，RCP通过SOAP消息向POP-D发送上传失败通知。作为SFTP服务端RCP通过SFTP方式上传统计文件到POP-D。统计文件包括策略/规则映射信息、策略统计信息、规则统计信息。
SPR|作为SFTP客户端，向RCP上传策略签约趋势和业务变更历史信息，供SOAP查询和分析使用。
RCP|产生各种策略日志文件、通知日志文件、业务历史日志文件、策略/规则映射信息，结合SPR上传的数据，生成POP-D所需的各种信息。作为SOAP服务端允许POP-D作为客户端，查询各种分析/统计信息。作为SOAP客户端向作为服务端的POP-D发送统计文件上传失败通知。作为SFTP服务端接收作为客户端的SPR提供的签约趋势和业务变更历史信息。作为SFTP客户端向作为服务端的POP-D上传各种统计文件。
###### 本网元实现 
######## 服务部署 
中移报表功能由Npcf_LOG服务和Npcf_LSU服务共同实现。当RCP支持中移报表功能时，需要部署Npcf_LOG、Npcf_LSU服务。 
部署信息参见[表3](d0e10.html#d0e1074__5b69e855-e223-4f7a-9ce9-66d1cc184c32)。
服务名称|部署虚机|部署方式
---|---|---
Npcf_LOG|LOG虚机|负荷分担方式，不支持弹缩，支持扩容。
Npcf_LSU|LSU虚机|负荷分担方式，不支持弹缩，不支持扩容。
######## 日志文件入库 
日志文件由RCP或SPR生成，存放在RCP指定路径中。日志文件种类参见[表4](d0e10.html#d0e1074__e911b762-b988-4a5c-a9db-e668b8e5ad3e)。
日志类型|来源|是否入库
---|---|---
通知日志|RCP生成|GBase数据库中建表存储数据。
策略日志|RCP生成|GBase数据库中建表存储数据。
业务事件日志|RCP、SPR生成|GBase数据库中建表存储数据。
签约趋势日志|SPR生成|GBase数据库中建表存储数据。
策略映射日志|RCP生成|只用于生成策略规则映射统计文件，不涉及查询功能，因此不需要入库。
日志文件入库要求： 
RCP系统设置时长为2分钟的循环定时器，定时入库通知日志、策略日志、业务事件日志和签约趋势日志路径下的日志文件。 
因SFTP服务或GBase数据库异常，导致入库失败的日志文件，下一个周期会再次尝试入库操作。 
已经入库的文件名会保存在数据库中，在老化周期内，相同文件名的日志文件，将不再入库。 
日志文件入库时，严格检查文件名的格式是否正确，格式错误的文件将会被删除。 
日志文件入库采取最大容忍策略：一个文件中的错误行将被放弃，这些行的数据将直接丢。但是原始的日志文件将会保留一定的周期。 
SPR生成的业务事件日志和签约趋势日志，通过SFTP方式上传到/temp目录，待RCP处理后存放到指定路径再入库。temp目录下相关日志的处理时间间隔固定为1小时，该时间不支持配置。 
######## 支持SOAP查询统计信息 
POP-D作为SOAP客户端，向RCP查询相关分析/统计信息。RCP通过对数据库的查询，将查询结果封装成SOAP消息，返回给POP-D。 
目前支持： 
用户通知历史信息查询 
策略生效统计信息查询 
业务变更历史信息查询 
策略签约趋势查询 
策略历史查询 
RCP响应消息说明： 
具体的SOAP请求和响应消息格式，参见“[业务流程](d0e10.html#d0e272)”。
策略生效统计信息中，仅显示有记录的项，缺失项以0代替。 
对于查询请求消息参数非法的情况，统一输出无记录响应消息。 
批量用户查询中，如果只有部分用户有记录，则只返回有记录的用户。如果所有用户都没有记录，则输出无记录响应消息。 
一次查询的响应最多返回64条记录，多余的记录将会被丢弃。 
######## 支持SFTP上传统计文件 
RCP作为SFTP客户端，定期采集“策略与规则映射信息”、“策略统计信息”、“规则统计信息”这些统计数据，生成统计文件，上传到POP-D。 
RCP成功上传文件后，会把本地的统计文件删除。如果上传失败，则在下一个周期尝试再次上传，直到成功 。 
如果上传失败，RCP通过SOAP消息通知POP-D。在SFTP异常恢复之前，每次上传失败，都通过SOAP消息通知一次，每次只上报当前上传失败的文件信息。 
统计文件包括下列三类统计数据： 
策略与规则映射信息策略与规则映射信息不需要从GBase库中采集，只需要将策略规则映射的日志文件（例如：EDR07_RCP[RCPID]_20491231235959_000100010001.csv.gz）解压后重命名，并放置到指定路径即可。文件名：Policy&Rule_MapingTable_SS_PCRFID_yyyymmddhhmmss.csv字段名长度类型字段描述PackNameString100策略编号RulenameString127规则名 
策略统计信息策略统计信息需要从GBase库中的指定RCP的表中获取。文件名：Policy_StatisticsTable_SS_PCRFID_yyyymmddhhmmss.csv字段名描述Policy ID策略标识。NSubscriber策略签约用户数。统计日志生成时间节点的各策略的签约用户总数。NUsrExaustedBOSS用户配额耗尽用户数。在一个统计周期内，BOSS侧因配额耗尽而触发usrStatus状态为套外的用户数量。NUsrRechargeBOSS用户配额充值用户数。在一个统计周期内，BOSS侧因用户充值或升舱套餐而触发usrStatus状态为套内的用户数量（跨起帐日的状态变更，不统计为配额充值）。NServiceExaustedBOSS业务配额耗尽用户数。在一个统计周期内，BOSS侧因业务配额耗尽而触发ServiceUsageState状态为业务流量包外的用户数量。NServiceRechargeBOSS业务配额充值用户数。在一个统计周期内，BOSS侧因业务配额充值而触发ServiceUsageState状态变更为业务流量包内的用户数量（跨起帐日的状态变更，不统计为配额充值）。TPolicy策略生效次数。在一个统计周期内，各策略被命中并触发执行的次数统计。TMessage策略通知消息下发次数。一个统计周期内，各策略触发的通知消息的次数统计。NMessage策略通知下发用户数。一个统计周期内，各策略所通知的用户数量统计（一个用户被多次下发消息，按一个用户统计）。NPolicy策略命中用户数。在一个统计周期内，各策略因各种触发条件满足而命中（包含命中后生效以及命中但未生效）的用户数量统计。 
规则统计信息规则统计信息需要从GBase库中的指定RCP的表中获取。文件名：Rule_StatisticsTable_SS_PCRFID_yyyymmddhhmmss.csv字段名描述RuleName规则标识。TRule规则下发次数。在一个统计周期内，因各种触发条件满足而导致各规则下发的次数统计。NRule规则命中用户数。在一个统计周期内，各规则因各种触发条件满足而命中（包含命中后生效以及命中但未生效）的用户数量统计。 
######## 数据老化 
为了防止GBase库中的数据和指定路径下存放的文件数据无限堆积，需要定期对这两种数据进行老化处理。RCP会在每天凌晨5:00主动发起老化流程，数据的默认保留周期为93天。 
GBase库中数据老化通过计算表记录中的时间字段值与系统当前时间值之间的差值，比较该差值与数据保留周期，删除超出保留周期的表记录，实现GBase库中数据的老化。 
文件数据老化通过计算文件名中的时间值与系统当前时间之间的差值，比较该差值与数据保留周期，删除超出保留周期的文件，实现文件数据的老化。 
###### 业务流程 
######## SPR向RCP上传日志文件 
SPR向RCP上传业务历史日志文件和签约趋势日志文件的流程如[图2](d0e10.html#d0e272__fb07cbbc-8951-4eed-8eed-cab07f66bf18)所示。
图2  SPR上传日志文件
[]images/%E6%8A%A5%E8%A1%A8-SPR%E4%B8%9A%E5%8A%A1%E5%8E%86%E5%8F%B2%E6%97%A5%E5%BF%97.png)
RCP开启SFTP服务端。
SPR开启SFTP客户端。 
SPR通过SFTP文件传输协议向RCP上传业务历史日志、签约趋势日志文件。 
SPR使用SFTP PUT方式传送日志文件。业务历史日志文件推送到路径Provlog_temp下，RCP进行格式处理后，放入路径Provlog下，再入GBase数据库。签约趋势日志文件推送到路径Subscribelog_temp下，经过格式处理后，放入路径Subscribelog下面，再入GBase数据库。
######## POP-D向RCP查询信息 
POP-D通过SOAP消息向RCP查询相关信息的流程如[图3](d0e10.html#d0e272__9ca0ed29-84ce-4420-9728-d7034fb1451b)所示。
图3  SOAP查询
[]images/%E6%8A%A5%E8%A1%A8-POPD%20SOAP%E6%9F%A5%E8%AF%A2.png)
RCP开启SOAP服务端。
POP-D开启SOAP客户端。
POP-D发送SOAP消息到RCP，查询相关信息。 
RCP向POP-D返回查询结果。 
可查询信息如下： 
用户通知历史信息用于查询某段时间内RCP给单个用户或一批用户发送通知的形式（例如：短信SMS、电子邮件Email）和结果。查询请求消息：包含查询的用户的号码以及查询记录的开始时间和截止时间。若一次性查询一批用户数，需携带该批次多个用户的号码信息。查询结果反馈：RCP给该用户在查询时间窗口内的发送通知的时间、形式和结果。如果存在多次发送记录，则将各条记录逐次反馈。如果查询的是一批用户，则按照查询先后顺序，依次反馈各用户的通知历史信息。如果在查询时间段内无记录信息，则反馈结果0。如果在批量用户查询中，某单一用户无查询结果，则该用户对应的结果信息均以0反馈。 
策略生效统计信息用于查询某段时间内单个用户或一批用户的策略配置信息、策略生效时间、策略生效原因等策略相关历史记录。查询请求消息：包含查询的用户的号码以及查询记录的开始时间和截止时间。若一次性查询一批用户数，需携带该批次多个用户的号码信息。查询结果反馈：该用户在查询时间窗口内的生效策略的ID、策略生效时间以及策略生效原因（用户等级、当前时间、当前位置、访问业务、BOSS用户配额状态、BOSS业务配额状态、PCF套餐配额状态、终端类型等信息）。如果存在多个策略生效记录，则将各条记录逐次反馈。如果查询的是一批用户，则按照查询先后顺序，依次反馈各用户的策略生效信息。如果在查询时间段内无记录信息，则反馈结果0。如果策略生效原因仅为其中一项或若干项，则缺失项以0代替。如果在批量用户查询中，某单一用户无查询结果，则该用户对应的结果信息中均以0反馈。 
业务变更历史信息用于查询某段时间内单个用户或一批用户的业务变更详情。查询请求消息：包含查询的用户的号码以及查询记录的开始时间和截止时间。若一次性查询一批用户数，需携带该批次多个用户的号码信息。查询结果反馈：该用户在查询时间窗口内的业务变更时间以及业务变更类型。如果存在多次发送记录，则将各条记录逐次反馈。如果查询的是一批用户，则按照查询先后顺序，依次反馈各用户的业务变更历史信息。如果在查询时间段内无记录信息，则反馈结果0。 
策略签约趋势用于查询某段时间内每个业务的签约用户数的变化情况。查询请求消息：包含待查业务的业务标识以及查询记录的开始时间和截止时间。查询结果反馈：该业务在查询时间窗口内的签约用户变化情况。查询记录以天为单位形成一条记录，如果查询时间段为多天，则反馈期间内每天的业务签约用户数值情况。在查询时间段内无记录信息，则反馈结果0。 
策略历史用于查询某段时间内，某一策略的生效执行情况。查询请求消息：包含待查策略的策略编号以及查询记录的开始时间和截止时间。其中策略编号可以是业务策略的ServiceCode，也可以是用户策略的usrSessionPolicyCode。查询结果反馈：该策略在查询时间窗口内，各次生效记录信息，包括生效用户标识及策略生效原因（用户等级、当前时间、当前位置、访问业务、BOSS用户配额状态、BOSS业务配额状态、PCRF套餐配额状态、终端类型等信息）。如果存在多个策略生效记录，则将各条记录逐次反馈。如果在查询时间段内无记录信息，则反馈结果0。如果策略生效原因仅为其中一项或若干项，缺失项以0代替。 
######## RCP向POP-D上报统计信息成功 
RCP定期向POP-D上报相关统计信息成功的流程如[图4](d0e10.html#d0e272__1b7a12c8-41d7-474f-8e54-ddace73ed0fd)所示。
图4  RCP上报统计信息成功
[]images/%E6%8A%A5%E8%A1%A8-RCP%E4%B8%8A%E6%8A%A5%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E6%88%90%E5%8A%9F.png)
POP-D开启SFTP服务端。
RCP开启SFTP客户端。
RCP定期通过SFTP向POP-D发送统计文件。 
统计文件是对每个RCP分别进行统计的。上报周期（默认为周一）和上报时间点（默认为5:00）可在网管上进行配置。默认情况下，每周一的5：00会生成统计文件并上报到POP-D。 
当前支持上报的统计信息包括策略与规则映射信息、策略统计信息、规则统计信息。统计信息内容详见[本网元实现](d0e10.html#d0e1074)中的”支持SFTP上传统计文件“。
POP-D向RCP返回SFTP接收统计文件的结果，显示成功，流程结束。 
######## RCP向POP-D上报统计信息失败 
RCP向POP-D上报统计信息失败的流程如[图5](d0e10.html#d0e272__e3d64cae-7ed7-41e7-83eb-3b6d134bda61)所示。
图5  RCP上报统计信息失败
[]images/%E6%8A%A5%E8%A1%A8-RCP%E4%B8%8A%E6%8A%A5%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E5%A4%B1%E8%B4%A5.png)
POP-D开启SFTP、SOAP服务端。
RCP开启SFTP、SOAP客户端。 
RCP定期通过SFTP向POP-D发送统计文件。 
POP-D向RCP返回SFTP接收统计文件的结果，结果为失败。 
RCP通过SOAP消息通知POP-D：SFTP上传文件失败。 
POP-D返回SOAP ACK。 
##### 系统影响 
该特性开启时，由于记录日志，会导致CPU占用率升高。
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
其他特性|交互关系
---|---
ZUF-59-51-040 策略日志|策略日志特性负责生成原始的EDR日志文件。中移策略报表特性根据中移的规范，负责对这些原始文件进行后期处理：包括入数据库、提供SOAP查询、报表文件上传等。
##### 遵循标准 
本特性采用中兴通讯内部的接口和协议，不涉及标准协议。 
##### 特性能力 
名称|指标
---|---
RCP上传统计文件到POP-D平台|只支持SFTP方式。
SOAP响应最大返回的记录条数|目前只支持64条。
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性需要申请了License许可后，运营商才能获得该特性的服务。 
该特性对应License文件中的项目为LIC_RCP_FUNC_SYSLOG（策略日志），此项目显示为ON，表示ZXUN RCP支持策略日志特性。 
####### 对其他网元的要求 
该特性需要SPR向RCP提供签约趋势日志、业务历史日志。 
##### O&M相关 
####### 命令 
配置项表5  新增配置命令配置项配置命令描述数据分析基础配置SHOW DABASE查询数据分析基础。SET DABASE修改数据分析基础。数据库地址配置SHOW DATABASEIP新增数据库地址。SET DATABASEIP修改数据库地址。DEL DATABASEIP删除数据库地址。SHOW DATABASEIP查询数据库地址。对端SFTP服务器配置ADD DAPEERSFTPSRV增加对端SFTP服务器。SET DAPEERSFTPSRV修改对端SFTP服务器。DEL DAPEERSFTPSRV删除对端SFTP服务器。SHOW DAPEERSFTPSRV查询对端SFTP服务器。SFTP客户端配置ADD DASFTPCLIENT新增SFTP客户端。SET DASFTPCLIENT修改SFTP客户端。DEL DASFTPCLIENT删除SFTP客户端。SHOW DASFTPCLIENT查询SFTP客户端。本端SFTP服务器配置ADD DALOCSFTPSERVER新增本端SFTP服务器。SET DALOCSFTPSERVER修改本端SFTP服务器。DEL DALOCSFTPSERVER删除本端SFTP服务器。SHOW DALOCSFTPSERVER查询本端SFTP服务器。SOAP服务类型配置ADD SOAPSRVTYPE新增SOAP服务类型。SET SOAPSRVTYPE修改SOAP服务类型。DEL SOAPSRVTYPE删除SOAP服务类型。SHOW SOAPSRVTYPE查询SOAP服务类型。SOAP接入局配置ADD SOAPACC新增SOAP接入局。SET SOAPACC修改SOAP接入局。DEL SOAPACC删除SOAP接入局。SHOW SOAPACC查询SOAP接入局。 
动态管理表6  动态管理命令名称参数描述CLOSE LOGFILE无关闭所有PCF正在写的策略日志文件，进行入库。DELETE LOGFILETIME删除指定时间之前的日志文件。RELOAD_ULFILE无重新加载上传文件。SHOW_UPLOAD_INFO无查询上传相关信息。CLOSE_SFTP_TRANS_LOG无关闭SFTP上传结果文件。GBASE_INSTALL无安装GBASE数据库。GBASE_UNINSTALL无卸载GBASE数据库。SHOW_GBASE_STATUS无查询GBASE工作状态。 
####### 性能统计 
本特性不涉及性能统计的变化。 
####### 告警和通知 
编号|告警名称
---|---
1|2986738690 SFTP上传失败
2|2986738691 SFTP客户端未配置
3|2986738692 SFTP服务端开启失败
4|3339060242 数据库节点状态异常
5|3339060243 数据库集群状态异常
6|3340370199 数据库空间不足一级告警
7|3341418775 数据库空间不足二级告警
8|3342467351 数据库空间不足三级告警
9|2987525121 磁盘剩余空间不足一级告警
11|2988573697 磁盘剩余空间不足二级告警
12|2989622273 磁盘剩余空间不足三级告警
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 
#### 特性配置 
##### 配置中移策略报表 
###### 配置说明 
新增一个日志服务（LOG），配置本端为SFTP客户端，对外提供EDR日志数据服务，同时处理业务报表事务。 
新增一个LSU服务，单独部署GBase数据库。 
###### 配置前提 
中移报表功能是RCP、SPR和POP-D配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常，包括SFTP/SOAP服务器地址、端口和账号信息等。
###### 配置过程 
中移策略报表特性配置包括RCP侧相关配置和SPR侧相关配置。 
RCP侧配置配置过程 PCF侧配置流程如图1所示。图1  RCP侧配置流程配置步骤：登录EM客户端，打开配置→命令处理页面，选择Npcf_PolicyManagement_0 服务。执行SET SYS GLOBPARA命令，设置全局变量。执行SET POLICYLOG命令，设置日志基本参数。执行SHOW PKGINFO命令，查询套餐基本配置。配置数据分析。执行SET DABASE命令，设置数据分析基础配置。执行ADD DATABASEIP命令，新增数据库地址。执行ADD DAPEERSFTPSRV命令，新增对端SFTP服务器配置。执行ADD DASFTPCLIENT命令，新增对端SFTP客户端配置。执行ADD DALOCSFTPSERVER命令，新增本端SFTP服务器。配置SOAP客户端。执行ADD SOAPSRVTYPE命令，新增SOAP服务类型。执行ADD SOAPACC命令，新增SOAP接入局。 
SPR侧配置SPR侧侧配置流程如图2所示。图2  SPR侧配置流程配置步骤：执行SET SPROPT命令，修改SPR业务支持选项配置，设置SPR支持中移SOAP接口。执行SET GLBOPT命令，修改全局业务选项配置，打开支持按套餐统计用户数开关。执行SET SPRPAKINFO命令，修改SPR套餐信息配置，设置套餐关联用户业务状态。执行SET AGTLOGCLEAR命令，修改受理日志上报参数设置。执行ADD AGTFTPINFO命令，新增受理FTP服务器配置。配置性能统计上报配置。 
###### 配置实例 
######## 场景说明 
RCP业务产生的策略日志、通知日志、业务历史日志等直接扫描入库，同时作为SFTP服务器接收SPR侧上传的签约趋势日志和业务历史日志并把相应的记录入库。 
RCP作为SFTP客户端向POP-D推送相关统计文件。 
######## 数据规划 
RCP侧数据规划
全局变量开关编号取值1044用量穿越日志开关，配置为1。1045策略日志开关，配置为1。1046事件日志开关，配置为0。1047用量日志开关，配置为0。1048通知日志开关，配置为1。1049业务历史日志开关，配置为1。1050规则配置导出开关，此开关配置为1。1122中移报表开关，配置为1。1125策略日志记录无策略上线和下线事件开关，配置为1。 
日志基本参数日志题头开关配置项应配置为不包含。 
报表相关参数类别IP地址服务端口账户信息根目录说明数据库10.43.113.11310.43.113.11410.43.113.1155258用户名：rcp 密码：Pwd123--对端SFTP服务器10.47.171.13022用户名：impserv密码：impserv未配置则默认根目录统计数据上报POP-D平台。对端SFTP客户端10.43.113.11231---本端SFTP服务器10.43.113.11227用户名：pcflsu 密码：ZTE_ossdbg1/IDE0SPR向本地上传文件。SOAP服务类型----SOAP服务器类型：日志报告。SOAP命名空间：PCF。SOAP接入局10.43.113.1168090--POP-D向本地发送http查询消息。 
SPR侧数据规划
打开中移SOAP开关。 
打开支持按套餐统计用户数开关。 
######## 配置步骤 
RCP侧配置
配置全局变量。 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1045,CURVAL="1",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1046,CURVAL="0",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1047,CURVAL="0",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1048,CURVAL="1",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1049,CURVAL="1",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1050,CURVAL="1",EXTFLAG=1;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1122,CURVAL="1",EXTFLAG=0;
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1125,CURVAL="1",EXTFLAG=0;
设置日志基本参数。 
[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html):HEADERFLAG="OFF";
配置套餐基本。 
执行[SHOW PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787193.html)检查套餐基本配置的“套餐名称”，需要对齐PUDR套餐信息配置[SHOW PUDRPAKINFO](None)的“套餐名称”。
配置数据分析。 
设置数据分析基础配置。 
[SET DABASE](../../Npcf_PolicyManagement\zh-CN\mml\1788178.html):STATUS="ON",DBPWD="ZTE_ossdbg1",PUSHCYCLE="DAY",GEOPOSITION="HBBADhePCFPLS01BZX",PROVINCEID="HE",SPRNEIDNEID=101;
配置数据库地址。 
[ADD DATABASEIP](../../Npcf_PolicyManagement\zh-CN\mml\1788209.html):ID=1,IPADDR="10.43.113.113"
配置对端SFTP服务器。 
[ADD DAPEERSFTPSRV](../../Npcf_PolicyManagement\zh-CN\mml\1788180.html):TYPE="POP-D",SERVERIPADDR="10.47.171.130",SERVERPORT=22,USERNAME="POPDftp",PWD="impserv",VPNID=19,SCANINTERVAL=3600,UPLOADDIR="/var/hy/data/log/"
配置对端SFTP客户端。 
[ADD DASFTPCLIENT](../../Npcf_PolicyManagement\zh-CN\mml\1788184.html):TYPE="POP-D",CLIENTIPADDR="10.43.113.112,CLIENTPORT=31,PORTNUM=10,CLIENTENCRY="AES",CLIENTHASH="SHA1",VPNID=19
配置本端SFTP服务器。 
[ADD DALOCSFTPSERVER](../../Npcf_PolicyManagement\zh-CN\mml\1788188.html):SERVERIPADDR="10.43.113.112",SERVERPORT=27,USERNAME="pcflsu",PWD="ZTE_ossdbg1",VPNID=19,DIRECTORY="/IDE0"
配置SOAP客户端。 
配置SOAP服务类型。 
[ADD SOAPSRVTYPE](../../Npcf_PolicyManagement\zh-CN\mml\1788192.html):SOAPSERVID=1,SVCTYPE="LOG_REPORT",SOAPNAME="PCF"
配置SOAP接入局。 
[ADD SOAPACC](../../Npcf_PolicyManagement\zh-CN\mml\1788196.html):SOAPSERVID=1,IPADDR="10.43.113.112",PORT=8090,FQDN="/pop-web/services/ChinaMobilePOPSoapServiceEndPoint",CLTID=4
SPR侧相关配置
设置开关。 
打开中移SOAP开关。 
SET SPROPT:SPTCHINAMOBILESOAP="YES"; 
打开支持按套餐统计用户数开关。 
SET GLBOPT:ID=19016,VALUE="1"; 
设置套餐关联用户业务状态。 
如果修改用户配额时，需要上报该套餐的充值或耗尽用户配额事件，则该套餐需要配置为RLTUSRSTATUS=”YES”。 
SET SPRPAKINFO:PAKID=1,NAME=xx,RLTUSRSTATUS="YES"; 
配置受理日志上报。 
SET AGTLOGCLEAR:SUPPORTAGTLOG="YES",SUPPORTDIARYLOG="YES",ORIGINALFILEEXPORTTIME=2,ORIGINALFILECLEANTTIME=3,SUPPORTBACKUP="YES",FILETYPE="TXT",EXPORTTYPE="NOTDISTINBOSS; 
配置外部FTP服务器。 
ADD AGTFTPINFO:TYPE="SFTP",IP="10.43.113.112",PORT=27,USER="pcflsu",PWD="ZTE_ossdbg1",DIR="/IDE0/rcp/log/servhistorylog_temp" 
参数说明参见[表1](d0e2297.html#d0e2326__8907ffc5-22ad-45e5-af2f-ae483bbc2871)。
参数名称|参数配置
---|---
类型|SFTP。
IP|PCF提供，对应RCP侧“本端SFTP服务器配置”的服务器IP地址。
端口|PCF提供，对应RCP侧“本端SFTP服务器配置”的服务器端口。
用户名|PCF提供，对应RCP侧“本端SFTP服务器配置”的用户名。
密码|PCF提供，对应RCP侧“本端SFTP服务器配置”的密码。
路径|/IDE0/rcp/log/servhistorylog_temp，须配置SFTP的绝对路径。
配置性能统计上报。 
新建测量任务。 
EM上选择菜单性能→测量任务→新建
，新建按套餐统计SPR签约数的测量任务，页面如[图3](d0e2297.html#d0e2326__34bae4ae-7144-4f47-acad-2a13cadb048a)所示。
图3  新建测量任务
[]images/image.png)
新建查询模板。 
EM上选择菜单性能→性能查询→性能对象模板→新建
，新建测量对象类型为按套餐统计SPR签约数的测量查询模板，页面如[图4](d0e2297.html#d0e2326__c784627e-3fb1-4388-ba1d-fc1bbf28e766)所示。
图4  新建测量对象模板
[]images/1628250211884.png)
新建定时导出任务关联查询模板。 
EM上选择菜单性能→性能查询→定时导出任务→新建
，新建定时导出任务。
单击下一步，切换到选择对象页签，设置对象汇总为测量对象，对象范围选择目标PUDR主局。
单击下一步，切换到选择时间页签，设置设置性能数据的汇总粒度和执行周期（例如：粒度为1天，执行周期1天，时间00:05分）。
单击下一步，切换到用户定制页签，设置SFTP参数。
根据RCP侧“本端SFTP服务器配置”提供的参数设置SFTP的IP地址、端口、用户名密码和相对路径。 
参数说明参见[表2](d0e2297.html#d0e2326__02b623fc-b157-450a-bcff-44ccebc5fa4f)。
参数名称|参数配置
---|---
协议类型|SFTP。
IP地址|PCF提供，对应RCP侧”本端SFTP服务器配置“的服务器IP地址。
目录路径|rcp/log/subscribelog_temp。
端口|PCF提供，对应RCP侧“本端SFTP服务器配置”的服务器端口。
用户名|PCF提供，对应RCP侧“本端SFTP服务器配置”的用户名。
密码|PCF提供，对应RCP侧“本端SFTP服务器配置”的密码。
 说明： 
SFTP的相对路径要和SFTP服务端确认一致。 
例如：SFTP服务端绝对路径为/IDE0/rcp/log/subscribelog_temp，相对路径配置rcp/log/subscribelog_temp）。
设置完后要先测试连接，正常连接后再单击确定。
##### 测试用例 
测试条目|查询用户的通知历史记录/策略生效历史记录/业务历史记录/签约趋势日志
---|---
预置条件|PCF系统正常运行。PCF和PCEF之间通讯正常。中移报表相关配置均已完成。生成多个用户的多个通知日志、策略日志、业务事件日志和签约趋势日志。并分别通过SFTP传送到LOG服务/IDE0/rcp/log/下的noticelog、policylog、servhistorylog和subscribelog目录。
测试步骤|各日志文件上传至LOG服务器中。POP向PCF查询单用户、多用户的通知历史记录。POP向PCF查询单用户、多用户的策略生效历史记录。POP向PCF查询单用户、多用户的业务事件历史记录。POP向PCF查询某个策略的生效历史记录。POP向PCF查询某个策略的签约趋势历史记录。
通过准则|扫描周期到，各日志文件能正常入库至Gbase数据库中。http消息返回成功响应，http响应消息中的各字段值均正确，和数据库中一致。http消息返回成功响应，http响应消息中的各字段值均正确，和数据库中一致。http消息返回成功响应，http响应消息中的各字段值均正确，和数据库中一致。http消息返回成功响应，检查http响应消息中的各字段值均正确，和数据库中一致。http消息返回成功响应，查询时按天返回记录，有几天返回几条记录，返回当天总用户数，检查http响应消息中的各字段值均正确，和数据库中一致。
测试条目|统计数据上报POP平台
---|---
预置条件|PCF系统正常运行。PCF和PCEF之间通讯正常。中移报表相关配置均已完成。生成多个用户的多个通知日志、策略日志、业务事件日志和签约趋势日志。并分别通过SFTP传送到LOG服务/IDE0/rcp/log/下的noticelog、policylog、servhistorylog和subscribelog目录，并已入库。策略与规则配置文件每天定时导出，并生成到/IDE0/rcp/log/ruleconfig目录。
测试步骤|上报周期配置为天。上报时间点配置为8。
通过准则|每天8点，统计数据上报给POP平台，其中文件名为（其中文件名中的时间为文件生成的时间）：策略/规则映射表：Policy&Rule_MapingTable_SS_PCFID_yyyymmddhhmmss.csv注：此文件名不是EDR生成的，需要重命名。策略统计信息表：Policy_StatisticsTable_SS_PCFID_yyyymmddhhmmss.csv规则统计信息表：Rule_StatisticsTable_SS_PCFID_yyyymmddhhmmss.csv检查上报文件中的各个字段值正确。扫描周期到，日志文件能正常入库（策略与规则映射日志文件不入库）。3个待上传到POP的统计文件，存放在如下路径（相对路径）：rcp/upload。upload_temp供策略统计文件和规则统计文件使用（只用作统计时临时存放，文件生成后放到upload中）。如上传失败则会向POP推送SOAP消息提示。
### FL-07-01-003 EMSPlus接口 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
CHR|呼叫历史记录。
##### 描述 
####### 定义 
PCF支持三类通用日志，即业务日志，审计日志和运行日志。 
业务日志：指业务处理过程中产生的日志，如PCF的失败日志。 
审计日志：指操作记录日志，如OMM的操作日志。 
运行日志：指系统运行状态事件及异常情况记录，如异常重启。 
CHR日志属于业务日志。PCF采集业务处理过程的日志，特别是业务处理失败的过程日志，包括用户信令的关键参数等信息，并实时将这些信息上报到EMSPlus上。 
维护人员在EMSPlus上，根据PCF上报的CHR日志，并结合其它网元（如SMF、UPF等）上报的CHR日志，综合分析终端行为，进行网络监控、网络运行状态分析等操作。同时，这些日志数据也可以作为故障分析的依据，用来分析故障期间的用户行为，定位发生故障的原因。 
####### 背景知识 
PCF支持业务失败观察功能，可实时跟踪当前系统业务失败情况，但失败观察受限于性能、系统稳定性等原因不能一直开启，属于后验性故障分析功能。如果想分析系统开启失败观察功能前的故障，或者想整体了解系统运行某段时间的失败情况，往往不易获取此类数据。 
CHR日志功能则可以记录业务失败流程的用户关键信息，例如流程类型、错误码、用户信息、无线接入类型等流程中的关键信息。根据CHR日志记录的业务失败信息，可从微观上分析已发生故障的原因，也可从宏观上根据已发生故障类型分析系统及网络运行情况，从而优化系统和网络。 
##### 应用场景 
运维分析维护人员可以在EMSPlus上分析系统某段时间的失败情况，并根据这些信息来优化业务配置和网络配置。 
故障定位维护人员可以根据PCF上报的CHR失败日志，也可以结合其他网元上报的CHR日志信息，实现整个业务路径上各个节点的业务信息的可视化，以便快速定位、隔离、排除故障。 
##### 客户收益 
收益方|收益描述
---|---
运营商|根据网元上报的数据，分析系统网络状况，提高运维效率，降低运维成本，方便网络运行监测。快速定位故障，高效处理用户的疑问/投诉。
终端用户|本特性对用户不可见。

##### 实现原理 

###### 系统架构 
本特性所涉及的系统架构如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new97e59b3f10ca4b3fa6ea24ed992aa3e9__4f2133f8-66d1-4771-b6a3-5a1696930976)所示，RCP与EMSPlus之间通过ZTE自定义接口上报CHR日志。
图1  系统架构
[]images/image.png)
涉及的网元及其作用参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new97e59b3f10ca4b3fa6ea24ed992aa3e9__0ce62a65-a415-4ef1-aa66-acf08ad480e8)。
网元|说明
---|---
EMSPlus|收集、存储、分析PCF上报的用户CHR日志数据。
PCF|向EMSPlus上报CHR日志数据，主要是异常流程数据。
###### 业务流程 
PCF向EMSPlus上报CHR日志，不涉及业务信令流程。 
###### 本网元实现 
PCF与EMSPlus独立部署，PCF通过自定义接口将用户的CHR数据上报到EMSPlus，数据格式为ZTE自定义格式。 
PCF上报数据时，不同的业务模块使用不同的源端口与EMSPlus通信，以便EMSPlus能够按照端口进行负荷分担。 
为了防止PCF上报的CHR日志数据量过大，PCF发送日志时可按照配置的速率进行控制，控制粒度按每SC控制。
对于VoLTE会话场景，为了方便定位问题，需要CHR日志上报PCF主要流程的重要信息和失败信息，包括： 
SMF主动发起的N7/Gx接口上下线流程 
PCF主动发起的N7/Gx下线流程 
AF触发的N5/Rx接口各种流程 
PCF主动发起的N5/Rx下线流程 
PCF主动发起的N5/Rx接口RAR流程 
BSF注册状态变更流程 
######## 上报时机 
EMSPlus日志是否上报由“EMS+日志上报配置
”
中的上报开关参数控制，其中的失败链字段由失败链信息参数控制。
其中，VoLTE会话场景和数据会话场景中的子流程分别由“EMS+日志开关配置
”
中的事件参数控制。
流程包括： 
Volte失败流程                       
数据失败流程                        
Volte Gx/N7初始流程（成功）         
Volte Gx/N7 更新流程（成功）        
Volte Gx/N7释放流程（成功）         
Volte Gx/N7 RCP主动释放流程（成功） 
Volte Gx/N7通知流程（成功）         
Volte Rx/N5初始流程（成功）         
Volte Rx/N5释放流程（成功）         
Volte Rx/N5 RCP主动释放流程（成功） 
Volte Rx/N5通知流程（成功）         
Volte Rx/N5更新流程（成功）         
数据Gx/N7初始流程（成功）           
数据Gx/N7更新流程（成功）           
数据Gx/N7释放流程（成功）           
数据Gx/N7通知流程（成功）           
数据Rx/N5初始流程（成功）           
数据Rx/N5更新流程（成功）           
数据Rx/N5释放流程（成功）           
数据Rx/N5通知流程（成功）           
数据Gx/N7 RCP主动释放流程（成功）   
数据Rx/N5 RCP主动释放流程（成功）  
在VoLTE会话场景中，主要上报点汇总如下： 
N7/Gx上线、更新、释放流程，在收到请求后，发送应答时上报CHR日志，包括处理成功流程和失败流程。 
N7/Gx主动发送通知流程，在收到响应（包括响应和超时）时上报CHR日志。 
N7/Gx主动发送释放通知（包括策略释放、数据不兼容释放）流程，在收到响应（包括响应和超时）时上报CHR日志。 
N7/Gx异常释放流程，在发送释放通知时上报CHR日志，包括数据不兼容、强制释放、解码失败、拨测释放重传、会话数据区挂死释放、IPS会话重复释放、NBSF注册/注销失败等流程。PCF收到AN_INFO事件后没有触发通知Rx-RAR时，网管主动释放会话。 
N5/Rx上线、更新、释放流程，在收到请求后，发送应答的时候上报CHR日志，包括处理成功流程和失败流程。 
N5/Rx主动发送通知流程，在收到响应（包括响应和超时）时上报CHR日志，包括N7接入信息等变更导致的通知、TSN NEWBRIDGE触发的通知。 
N7/Gx主动发送ASR释放通知流程，在收到RAA响应（包括响应和超时）时上报CHR日志，包括N7/Gx释放触发的N5/RX释放、数据不兼容释放等流程。 
######## 上报内容 
在VoLTE场景中，上报字段只要能取到都要上报。 
对于Gx/N7流程触发的上报，要把向EMSPlus上报字段中关于Gx、N7能取到的字段都上报。 
对于Rx/N5流程触发的上报，要把向EMSPlus上报字段中关于Rx、N5能取到的字段都上报。只要会话绑定成功，绑定的Gx、N7会话能取到的字段也都要上报。 
VoLTE场景主要上报字段参见[表2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new7ee73d6e64214837bc082463a74842d8__ffefba8c-bf12-4bf6-b9e3-13222adcc6c6)。
字段名|中文显示名|英文显示名|备注
---|---|---|---
GxSessionID|Gx接口SessionID|Gx SessionID|Gx接口SessionID。
N7smPolicyId|N7接口smPolicyId|N7smPolicyId|N7接口SmPolicyId。
N7notifUri|N7notifUri|N7notifUri|N7接口带过来的对端NotificationUri。
ReportEventTrigger|ReportEventTrigger|ReportEventTrigger|Gx、N7接口CCR_U流程需要上报。
USERNEID|USERNEID|USERNEID|用户归属局局向号。
IPV4BandingID|IPV4BandingID|IPV4BandingID|BSF返回的IPV4BandingID。
BSFIPV4RegResult|BSF IPV4注册结果|BSF IPV4 Reg Result|向BSF注册IPv4的结果。1：成功2：失败3：超时
IPV6BandingID|IPV6BandingID|IPV6BandingID|BSF返回的IPV6BandingID。
BSFIPV6RegResult|BSF IPV6注册结果|BSF IPV6 Reg Result|向BSF注册IPv6的结果。1：成功2：失败3：超时
ReleaseCause|释放原因|ReleaseCause|会话释放原因。1：对端网元释放消息触发的释放2：规则决策3：网管人机命令触发的主动释放4：数据区挂死5：重复会话检查导致的释放6：系统状态为拒绝态7：数据不兼容8：对端无会话9：SPR会话汇聚功能导致的释放10：BSF交互失败触发的释放41：IPS会话释放导致的AF会话释放42：IPS会话修改导致的AF会话释放43：IPS会话不存在导致的AF会话释放44：规则安装失败导致的AF会话释放255：其它原因
RxSessionID|Rx接口SessionID|Gx SessionID|Rx接口SessionID。AF接口流程触发的正常、异常上报都上报此字段。
N5appSessionId|N5接口appSessionId|N5appSessionId|N5接口appSessionId。AF接口正常流程触发的上报都上报此字段。AF接口异常初始消息流程，如果未产生此字段，则不用上报。其他的异常流程，只要已经产生此字段，都上报。
AFHostName|AF主机名|AF HostName|AF主机名。
N5notifUri|N5notifUri|N5notifUri|N5接口带过来的对端NotificationUri。
SpecificAction|SpecificAction|SpecificAction|Rx/N5接口事件。
##### 系统影响 
系统开启CHR上报后，会增加业务处理模块的负荷。开启失败日志开关对系统性能影响小于5%。 
##### 应用限制 
PCF向EMSPlus上报的单条日志记录不超过8k字节。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
本特性采用中兴通讯内部的接口和协议，不涉及标准协议。 
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.21.31|首次发布。
####### License要求 
该特性为PCF故障分析特性，无需License支持。 
####### 对其他网元的要求 
无特殊要求。 
##### O&M相关 
###### 配置命令 
新增命令表3  新增的配置命令配置项配置命令描述EMS+链路配置ADD EMSPLSLINK新增EMSPlus链路配置。SET EMSPLSLINK修改EMSPlus链路配置。DEL EMSPLSLINK删除EMSPlus链路配置。SHOW EMSPLSLINK查询EMSPlus链路配置。EMS+日志上报配置SET EMSPLSREPORT修改EMSPlus日志上报配置。SHOW EMSPLSREPORT查询EMSPlus日志上报配置。EMS+日志开关配置SET LOGSWITCH修改EMSPlus日志开关配置。SHOW LOGSWITCH查询EMSPlus日志开关配置。EMS+日志管理SHOW_EMSPLS_LINK查询EMSPlus链接信息。 
全局变量表4  全局变量参数名称系统缺省值说明1380 EMS+服务器接收心跳端口15000设置EMSPlus接收心跳的端口。 
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
序号|告警名称
---|---
1|3339321601 EMS+日志服务器连接失败
###### 业务观察/失败观察 
本特性不涉及业务观察/失败观察的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置特性 
###### 配置说明 
PCF可以将包含用户信令参数的业务日志，通过内部CHR接口实时上报至EMSPlus，EMSPlus综合各网元上报的业务日志，进行故障分析。 
EMSPlus链路配置需要根据规划，配置PCF本端地址及端口、EMSPlus的地址及端口、网络VPN等链路信息。 
启用EMSPlus日志上报功能后，PCF通过CHR接口根据配置的链路，向EMSPlus上报业务日志。 
###### 配置前提 
已规划好网络，并且在Rosng配置管理中配置完成，并且网络正常。 
EMSPlus链路配置，需要由PCF和EMSPlus按照规划分别配置完成。 
###### 配置过程 
EMSPlus接口特性配置流程如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424918__8c507b82-63aa-42ea-a71f-a3a858040f50)所示。
图1  配置流程
[]images/ems+%E6%8E%A5%E5%8F%A3%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE1.png)
配置步骤： 
执行[ADD EMSPLSLINK](../../Npcf_PolicyManagement\zh-CN\mml\1788265.html)命令，增加EMS+链路配置，配置EMSPlus服务器地址及端口、PCF本端地址及端口和网络VPN。
执行[SET EMSPLSREPORT](../../Npcf_PolicyManagement\zh-CN\mml\1788269.html)命令，修改 EMS+日志上报配置，启用日志上报功能，启用失败链信息上报和配置上报最大速率。
###### 配置实例-向EMSPlus上报日志 
######## 配置场景 
本实例旨在说明ZXUN RCP如何向EMSPlus上报相应流程的日志。
######## 数据规划 
基本数据规划
参数|取值
---|---
PCF IP地址|10.36.26.53
PCF起始端口|30000
VPNID|11
主用EMSPlus IP地址|10.28.31.45
主用EMSPlus端口|15000
备用EMSPlus IP地址|10.28.32.45
备用EMSPlus端口|15000
EMS+链路配置
参数|取值
---|---
地址类型|IPv4
主用EMS+日志服务器IP地址|10.28.31.45
主用EMS+日志服务器端口|15000
备用EMS+日志服务器IP地址|10.28.32.45
备用EMS+日志服务器端口|15000
本端IP地址|10.36.26.53
本端开始端口号|30000（默认值）
VPN号|11
心跳时长|3（默认值）
连续检测不可用次数|3（默认值）
EMS+日志上报配置
参数|取值
---|---
上报开关|打开
失败链信息|上报
CHR上报最大速率（包/秒）|200
EMS+日志开关配置
参数|取值
---|---
事件|Volte失败流程
日志开关|打开
######## 配置步骤 
增加EMS+链路配置。 
[ADD EMSPLSLINK](../../Npcf_PolicyManagement\zh-CN\mml\1788265.html):ADDRTYPE=IPV4,MSTIPADDR="10.28.31.45",MSTPORT=15000,SLVIPADDR="10.28.32.45",SLVPORT=15000,LOCALIP="10.36.26.53",LOCALPORT=30000,VPN=11,HBTIME=3,CHKTIMES=3
修改EMS+日志上报配置。 
[SET EMSPLSREPORT](../../Npcf_PolicyManagement\zh-CN\mml\1788269.html):RPTSWITCH="Notification",MAXREPORTPPS="200",FAILLINK="REPORT"
配置EMS+日志开关。 
[SET LOGSWITCH](../../Npcf_PolicyManagement\zh-CN\mml\1789093.html):EVENT="VOLTE_FAIL",FLAG="OPEN"
传表。 
[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)
查询EMS+链路，确认链路状态正常。 
[SHOW_EMSPLS_LINK](../../Npcf_SMPolicyControl\zh-cn\mml\1137515.html)
######## 配置脚本 
//EMS+链路配置，若无备EMS Plus可不配置备EMS Plus地址和端口。地址类型、IP地址、服务器端口、VPN按实际规划填写。 
ADD EMSPLSLINK:ADDRTYPE=IPV4,MSTIPADDR="10.28.31.45",MSTPORT=15000,SLVIPADDR="10.28.32.45",SLVPORT=15000,LOCALIP="10.36.26.53",LOCALPORT=30000,VPN=11,HBTIME=3,CHKTIMES=3 
//EMS+日志上报配置。 
SET EMSPLSREPORT:RPTSWITCH="Notification",MAXREPORTPPS="200",FAILLINK="REPORT" 
//EMS+日志开关配置 
SET LOGSWITCH:EVENT="VOLTE_FAIL",FLAG="OPEN" 
//传表，如上配置为离线配置，配置完成后需要进行传表。 
SYNA 
##### 测试用例 
测试条目|Gx/N7会话更新未查询到会话，会话更新失败，向EMSPlus上报业务失败日志
---|---
预置条件|PCF系统正常运行。PCF与EMSPlus及周边NF之间通讯正常。EMSPlus日志上报相关配置均已完成，执行SHOW_EMSPLS_LINK命令，返回结果中有链路记录，并且链路状态为激活状态。PCF已完成基础数据配置。
测试步骤|发起Gx/N7会话更新。登录EMSPlus客户端，查询PCF上报的日志记录。
通过准则|Gx/N7会话更新失败，响应码404，并向EMSPlus上报失败日志。EMSPlus上可以查询到PCF上报的日志记录，并且上报字段与用户会话信息一致。
测试条目|Rx/N5会话更新未匹配上应用标识，会话更新失败，向EMSPlus上报业务失败日志
---|---
预置条件|PCF系统正常运行。PCF与EMSPlus及周边NF之间通讯正常。EMSPlus日志上报相关配置均已完成，执行SHOW_EMSPLS_LINK命令，返回结果中有链路记录，并且链路状态为激活状态。PCF已完成基础数据配置。其中，AF应用标识映射：ADD AFAPPMEDIA:ID=1,AFAI="1",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1001ADD AFAPPMEDIA:ID=2,AFAI="1",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1001
测试步骤|建立N7会话。创建Rx/N5会话，消息中携带媒体1信息：AFAI为1、媒体类型为AUDIO、媒体子部件包含上下行的NOINFO流。更新Rx/N5会话，消息中携带媒体2信息：AFAI为3、媒体类型为OTHER、媒体子部件包含上下行的NOINFO流。释放Rx/N5会话、N7会话。登录EMSPlus客户端，查询PCF上报的日志记录。
通过准则|用户成功上线。Rx/N5会话建立成功。Rx/N5会话更新失败，响应码403，并向EMSPlus上报失败日志。EMSPlus上可以查询到PCF上报的日志记录，并且上报字段与用户会话信息一致。
### 缩略语 
### 缩略语 
#### CHR 
Call History Record呼叫历史记录
#### SC 
Service Component服务组件
#### ZTE 
Zhongxing Telecommunications Equipment中兴通讯
### FL-07-01-004 PPM接口 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
采控平台|中国电信销售品生命周期管理的核心系统。
PPM接口|PPM接口是采控平台和RCP之间的接口。
##### 描述 
####### 定义 
采控平台是中国电信销售品生命周期管理的核心系统。 
统一全程全网销售品信息配置管理及信息共享支撑。 
统一企业销售品系统视图、集成一键高效配置。   
负责销售品的流量识别规则等相关信息的统一管控、配置及分发。 
采控平台与RCP通过PPM接口的交互工作过程如下：
采控平台完成销售品规格数据、系统级规则数据配置流程的管控与维护，包括数据的生成、修改、删除。 
采控平台通过PPM接口将销售品规格数据、系统级规则数据同步给RCP，RCP将相关数据转化为网元内部配置信息。 
在用户上网过程中，RCP依据销售品规格数据、系统级规则数据生成该用户特有的控制策略。 
####### 背景知识 
PPM接口是为了实现电信5G业务开通保障系统与RCP网元的标准化对接。 
目前PPM接口可以传递达量降速套餐，定向流量套餐的控制信息，以减少这些套餐在RCP系统上的配置工作量。 
##### 应用场景 
PPM接口适用于电信增加、修改、删除达量降速套餐及定向流量套餐。
##### 客户收益 
受益方|受益描述
---|---
运营商|无需在SPR、RCP上新增、修改、删除达量降速套餐和定向流量（内容计费）套餐可，直接由采控平台通过PPM接口下发配置，减少维护工作量。
终端用户|该特性对终端用户不可见。

##### 实现原理 

###### 系统架构 
 
###### 涉及的网元 
网元|描述
---|---
采控平台|采控平台通过PPM接口下发消息给RCP。采控平台接收RCP返回的PPM接口响应。
###### 业务流程 
######## 概述 
目前采控平台和RCP之间的PPM接口总共有3对接口：
系统级规则同步接口：主要用于采控平台向RCP传递PCID（Policy Counter Identifier，策略计数器）对应的PCS（Policy Counter Status，策略计数器状态）的带宽信息。 
销售品规格同步接口：主要用于采控平台向RCP传递套餐对应的PCID和RG信息。 
完成配置通知接口：主要用于RCP反向通知采控平台系统级规则同步接口和销售品规格同步接口的处理结果。 
######## 系统级规则同步接口 
[]images/%E9%94%80%E5%94%AE%E5%93%81.png)采控平台发送系统级规则同步请求消息给RCP。消息中主要携带POLICY_COUNTER_ID、POLICY_COUNTER_STATUS、RATE、RATE_UNIT等信息。 
RCP将采控平台传递过来的数据存储到本地，通过系统级规则同步响应消息返回处理结果。 
接口协议
接口编码|pcfOfferSysRule
---|---
接口名称|PCF_系统级规则同步接口
接口功能描述|采控平台向PCF同步系统级规则
提供者|集团采控平台、PCF
使用者|集团采控平台
接口类型|同步小数据量
交互频度|非周期
接口协议|HTTP协议
响应时间要求|5s
Accept|application/json
请求方法|POST
请求地址|http://server:port/basePath/pcfOfferSysRule
备注|-
接口输入 
序号|属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---|---
1|省份编码|-|AREA_CODE|STRING|4|1|省会区号，如北京（010），南京（025），主要用于采控平台推送给指定省份的PCF。
2|策略关系信息|-|RELA_INFO|-|-|1..N|策略计数标识中策略状态与速率的关系信息。
2.1|动作类型|RELA_INFO|ACTION_TYPE|String|1|1|1.增加2.删除
2.2|策略计数器标识|RELA_INFO|POLICY_COUNTER_ID|STRING|64|1|各省自行定义，此信息需与销售品中达量降速策略绑定。
2.3|策略状态组|RELA_INFO|POLICY_CNTSTATUS_INFO|ARRAY|-|1…N|-
2.3.1|策略状态|POLICY_COUNTER_INFO|POLICY_COUNTER_STATUS|STRING|64|1|各省自行定义，如0为不限速，1为一档限速等。
2.3.2|速率值|POLICY_COUNTER_INFO|RATE|STRING|18|1|通过速率值（RATE）*速率换算单位（RATE_UNIT）获取到速率单位为bit/s的速率信息，如1Mbps=1(RATE)* 1048576(RATE_UNIT)
2.3.3|速率换算单位|POLICY_COUNTER_INFO|RATE_UNIT|STRING|10|1|通过速率值（RATE）*速率换算单位（RATE_UNIT）获取到速率单位为bit/s的速率信息，如1Mbps=1(RATE)* 1048576(RATE_UNIT)
接口输出
属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---
处理结果标识|-|RESULTCODE|String|1..4|1..1|-
返回结果信息|-|RESULTDESC|String|1024|0..1|-
######## 销售品规格同步接口 
[]images/1638758165576.png)采控平台发送销售品规格同步请求消息给RCP。消息中主要携带PROD_OFFER_ID、OFFER_NAME、POLICY_COUNTER_ID、RATING_GROUP等信息。 
RCP通过销售品规格同步响应消息返回处理结果。 
接口协议
接口编码|pcfOfferRateData
---|---
接口名称|PCF_销售品与流量识别标识关系同步接口
接口功能描述|采控平台向PCF同步销售品与流量识别标识关系
提供者|集团采控平台、PCF
使用者|集团采控平台
接口类型|同步小数据量
交互频度|非周期
接口协议|HTTP协议
响应时间要求|5s
Accept|application/json
请求方法|POST
请求地址|http://server:port/basePath/pcfOfferRateData
备注|-
接口输入
序号|属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---|---
1|省份编码|-|AREA_CODE|STRING|4|1|省会区号，如北京（010），南京（025），主要用于采控平台推送给指定省份的PCF。
2|销售品关系信息|-|RELA_INFO|-|-|1..N|销售品与流量识别标识以及策略关系信息。
2.1|动作类型|RELA_INFO|ACTION_TYPE|String|1|1|1. 全量新增，表示全新配置套餐及其关联的定向流量和（或）达量降速策略。2. 全量删除，表示删除套餐及其关联的定向流量和（或）达量降速策略。3. 修改销售品名称。4. 部分新增，表示增量追加套餐关联的定向流量和（或）达量降速。5. 部分删除，表示删除套餐关联的部分定向流量和（或）达量降速。
2.2|销售品名称|RELA_INFO|OFFER_NAME|String|250|1|销售品名称
2.2|销售品ID/编码|RELA_INFO|PROD_OFFER_ID|String|64|1|确保和本省销售品实例接口保持一致
2.3|策略信息组|RELA_INFO|POLICY_COUNTER_INFO|ARRAY|-|0..N|销售品中包含的达量降速策略规则信息
2.3.1|策略计数器标识|POLICY_COUNTER_INFO|POLICY_COUNTER_ID|STRING|64|-|通过达量资费模板标识获取对应的策略标识
2.4|内容识别规则信息组|RELA_INFO|RATING_GROUP_INFO|ARRAY|-|0..N|销售品中包含的内容识别规则信息
2.4.1|费率组（流量识别标识）|RATING_GROUP_INFO|RATING_GROUP|STRING|10|1|费率组（流量识别标识）。采用10位十进制数值，取值范围0-4294967295。
接口输出
属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---
处理结果标识|-|RESULTCODE|String|1..4|1..1|-
返回结果信息|-|RESULTDESC|String|1024|0..1|-
######## 完成配置通知接口 
[]images/%E5%AE%8C%E6%88%90%E9%85%8D%E7%BD%AE.png)针对系统级规则同步和销售品规格同步消息，RCP处理完成之后，通过完成配置通知接口通知采控平台处理结果。 
采控平台返回完成配置通知响应给RCP。 
接口协议
接口编码|asyncFeedBack
---|---
接口名称|完成配置通知接口
接口功能描述|PCF通过集团采控平台向CPCP反馈配置结果
提供者|集团采控平台、CPCP
使用者|PCF、集团采控平台
接口类型|同步小数据量
交互频度|非周期
接口协议|HTTP协议
响应时间要求|5s
Accept|application/json
请求方法|POST
请求地址|http://server:port/basePath/asyncFeedBack
备注|-
接口输入
序号|属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---|---
1|统一异步反馈标识|-|notificationId|integer|18|0..1|可填
2|操作业务时间|-|notifyTime|string|12|0..1|可填，date-time格式，如2020-07-17T07:27:02.070Z
4|应答类型|-|reasonType|string|1|1|0-成功1-失败
5|应答编码|-|reasonCode|string|10|0..1|0000 配置成功9000 其他错误
6|应答描述|-|reasonDesc|string|-|0..1|-
7|原交易流水|-|old-X-CTG-Request-ID|string|-|1|系统规则同步或销售品规格同步Http Header中X-CTG-Request-ID
接口输出
属性名称|父属性|属性编码|数据类型|长度|出现次数|说明
---|---|---|---|---|---|---
处理结果标识|-|RESULTCODE|String|1..4|1..1|-
返回结果信息|-|RESULTDESC|String|1024|0..1|-
######## SM策略关联建立流程 
此处以会话建立流程为例来描述一下PPM接口传递过来的信息如何影响RCP决策的。 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E5%9B%BE.png)流程说明如下： 
PPM数据已经存储在RCP中。在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向PCF发送Npcf_SMPolicyControl_Create请求。 
如果RCP判断对该PDU会话策略控制需要用到该用户的SPR签约信息，并且RCP本地没有该用户的SPR签约信息，则RCP向SPR发生Sp接口UDR消息，请求获取该用户的签约信息。 
SPR在Sp接口UDA中返回用户签约。 
RCP再向SPR发送Sp'接口UDR消息，请求获取该用户的用量信息。 
SPR在Sp'接口UDA中返回用户用量。 
RCP生成需要订阅的PCID，需要订阅的PCID包括： 
RCP本地的配置的PCID。 
RCP使用用户签约的套餐ID，通过PPM接口传递过来的套餐ID和PCID的对应关系，获取到的PCID。 
如果需要向CHF订阅PCID信息，则PCF发送HTTP POST请求，使用"{apiRoot}/nchf-spendinglimitcontrol/v1/subscriptions"向CHF订阅，订阅请求包括： 
用户永久标识 (SUPI) 
通知关联的目标地址 (notifUri) 
公共用户标识 (GPSI) 
策略计数器标识列表（PCIDs） 
收到此HTTP POST请求后，CHF将创建一个新的订阅信息，生成一个订阅关联ID，存储订阅信息，并且回复 "201 Created"响应。 
在响应消息头部Location字段携带‘{apiRoot}/nchf-spendinglimitcontrol/v1/subscriptions/{subscriptionId}'， 并包括如下内容： 
请求的策略计数器标识列表状态 
可能包括策略计数器的未来状态和未来激活时间 
RCP根据会话接入信息、用户签约、用量信息，CHF返回的策略计数器状态，以及PPM接口传递过来的信息等进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。如果会话决策，承载决策的结果是拒绝，则直接拒绝会话；如果决策结果是接纳会话，则会话APN带宽，以及pccRuleId的决策逻辑如下： 
会话APN带宽的决策逻辑优先判断PPM接口传递过来的套餐ID、PCID、PCS、APN带宽对应关系是否有和当前用户相匹配的记录，如果有，则取此值下发。如果没有，则取会话决策输出的APN带宽进行下发。 
pccRuleID的决策逻辑正常进行业务决策，套餐预定义决策，生成需要下发的pccRuleId。判断PPM接口传递过来的套餐ID，RATING_GROUP对应关系是否有和当前用户相匹配的记录，如果有，则将RATING_GROUP作为pccRuleId。同时下发上述两种决策输出的pccRuleID。 
决策结束向SMF发送Npcf_SMPolicyControl_Create响应，响应消息的HTTP头域Location字段中包含RCP为此SM策略关联生成的ResourceURI，json正文中包含SmPolicyDecision相关参数： 
参数|参数
---|---
HTTP Header关键参数|:status: 201 Created —— http头域的status类似于diameter响应的Result-Code:location: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}，其中smPolicyId为PCF根据supi+pduSessionId+时间戳等信息生成的SM策略关联ID，例如：http://[2409:8069:5003:803::2:121]:80/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f.
sessRules|SessionRule列表，每个SessionRule主要包含：authSessAmbr：授权的会话聚合带宽，如果有PPM接口传递过来的信息，则APN带宽可能是从PPM接口传递过来的RATE*RATE_UNIT。PPM接口传递过来的APN带宽信息优先级高于RCP决策出来的APN带宽。authDefQos：授权的缺省QoSsessRuleId：会话规则IDrefUmData：引用的用量数据refCondData：引用的条件数据
pccRules|PccRule列表，每个PccRule主要包含：flowInfos：流信息appId：应用标识pccRuleId：PCC规则标识，最终下发的pccRuleId为RCP系统决策出来的业务规则ID，以及PPM接口传递过来的部分RATING_GROUPprecedence：优先级refQosData：引用的QoS Data的qosIdrefTcData：引用的TrafficControlData的tcIdrefChgData：引用的ChargingData的chgIdrefUmData：引用的UsageMonitoringData的umIdrefCondData：引用的ConditionData的condId
###### 本网元实现 
######## 通过开关控制RCP获取PCS的方式 
采控平台通过PPM接口向RCP传递不同PCS对应的带宽信息。用户达量后RCP收到降速通知，RCP将通知消息中携带的PCS与PPM接口传递的PCS进行匹配，重新决策下发限速策略。 
RCP有两种获取降速通知的途径： 
Sy/N28接口：用户达量后的降速通知由OCS/CHF直接通过Sy/N28接口下发给RCP。 
SPR扩展属性：用户达量后的降速通知从SPR扩展属性中获取，SPR扩展属性通过Sp/Sp'受理签约接口经UDR通知到RCP。 
RCP通过配置1358开关值，控制RCP获取PCS的方式。 
0-通过Sy/N28接口获取      
1-通过SPR扩展属性获取   
2-可以通过Sy/N28或者SPR扩展属性获取，优先从Sy/N28接口获取。 
默认取值为0。 
######## PCF数据处理 
系统级规则同步接口 
此接口为全量接口，每次消息带过来的POLICY_COUNTER_ID的信息即为此POLICY_COUNTER_ID的全量信息。在存储之前，先将原PCID应对的所有信息删除，再存储新的内容。 
全量新增记录 
全量删除POLICY_COUNTER_ID对应的POLICY_COUNTER_STATUS、RATE、RATE_UNIT的所有记录。 
新增此次传递过来的POLICY_COUNTER_ID对应的POLICY_COUNTER_STATUS、RATE、RATE_UNIT的信息。 
全量删除记录 
全量删除POLICY_COUNTER_ID对应的POLICY_COUNTER_STATUS、RATE、RATE_UNIT的所有记录。 
销售品规格同步接口 
全量新增记录 
全量删除PROD_OFFER_ID对应的POLICY_COUNTER_ID的所有记录、PROD_OFFER_ID对应的RATING_GROUP的所有记录、PROD_OFFER_ID对应的OFFER_NAME的所有记录。 
新增此次传递过来的PROD_OFFER_ID对应的POLICY_COUNTER_ID、PROD_OFFER_ID对应的RATING_GROUP、PROD_OFFER_ID对应的OFFER_NAME的信息。 
全量删除记录 
全量删除PROD_OFFER_ID对应的POLICY_COUNTER_ID的所有记录、PROD_OFFER_ID对应的RATING_GROUP的所有记录、PROD_OFFER_ID对应的OFFER_NAME的所有记录。 
修改销售品名称 
修改PROD_OFFER_ID对应的OFFER_NAME的信息。 
增量新增记录 
新增PROD_OFFER_ID对应的POLICY_COUNTER_ID的信息、PROD_OFFER_ID对应的RATING_GROUP的信息、PROD_OFFER_ID对应的OFFER_NAME的信息。 
增量删除记录 
删除PROD_OFFER_ID对应的POLICY_COUNTER_ID的记录、PROD_OFFER_ID对应的RATING_GROUP的记录。如果PROD_OFFER_ID对应的POLICY_COUNTER_ID和PROD_OFFER_ID都被删除，则PROD_OFFER_ID对应的OFFER_NAME记录也会被删除。 
######## PCF数据存储 
系统级规则同步接口 
名称|类型|说明
---|---|---
POLICY_COUNTER_ID|字符串1-65|对应RCP中PCID字段
POLICY_COUNTER_STATUS|字符串1-65|对应RCP中PCS字段
RATE|字符串1-19|RATE*RATE_UNIT对应RCP中会话APN带宽
RATE_UNIT|DWORD|RATE*RATE_UNIT对应RCP中会话APN带宽
表记录唯一关键字：POLICY_COUNTER_ID+POLICY_COUNTER_STATUS 
表记录非唯一关键字：POLICY_COUNTER_ID 
销售品规格同步接口 
名称|类型|说明
---|---|---
PROD_OFFER_ID|字符串1-33|对应RCP中套餐ID字段
POLICY_COUNTER_ID|字符串1-65|对应RCP中PCID字段
表记录唯一关键字：PROD_OFFER_ID+POLICY_COUNTER_ID 
表记录非唯一关键字：PROD_OFFER_ID 
名称|类型|说明
---|---|---
PROD_OFFER_ID|字符串1-33|对应RCP中套餐ID字段
RATING_GROUP|DWORD|对应RCP中预定义规则中pccRuleId/ChargingRuleName字段
表记录唯一关键字：PROD_OFFER_ID+RATING_GROUP 
表记录非唯一关键字：PROD_OFFER_ID 
名称|类型|说明
---|---|---
PPM_PKG_ID|字符串1-33|对应RCP中套餐ID字段
PPM_PKG_NAME|字符串1-251|-
表记录唯一关键字：PPM_PKG_ID 
######## PCF处理响应码 
响应代码|代码描述|处理建议
---|---|---
0|操作成功|-
1001|输入参数错误|检查头部或者消息体中是否存在不符合协议的内容
1002|输入参数不全|检查头部或者消息体中是否缺少必选内容
1006|系统超时|建议重试，如果消息体中携带的新增信息过多，建议使用增量接口进行多次增量新增
1|其他错误|建议重试
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
中国电信集团有限公司企业标准|Q/CT X-2013|中国电信5G核心网PCF网元销售品规格数据同步接口技术要求V1.1
##### 特性能力 
名称|指标
---|---
消息大小限制|由于V7平台HTTP 2.0限制最大包长度是64KB，如果采控平台发送的消息体长度超过64KB， 会导致RCP消息处理失败。
记录数限制|销售品规格同步接口中，一次全量新增的RG和PCID总数超过7条，可能会出现超时 。如果需要新增的RG和PCID总数超过7条，建议使用增量新增的方式。
RG个数限制|RCP最多支持下发60个RG。
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.20|首次发布。
02|V7.21.32|加入增量逻辑以及修改名称的相关功能。
####### License要求 
该特性为RCP网元的基本特性，无需License支持 。 
####### 对其他网元的要求 
该特性由本网元单独实现，对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
可使用如下命令查询PPM存储的对端携带的信息，不建议手动新增或修改。
命令|说明
---|---
SHOW PKGPCID|查询销售品ID和策略计数器标识的对应关系
SHOW PPMRG|查询销售品ID和费率组的对应关系
SHOW PCSRATE|查询策略计数器标识和策略状态的对应关系
SHOW PPMPKGINFO|查询销售品ID和销售品名称信息
####### 性能统计 
编号|性能计数器名称
---|---
1|C520090001 收到PPM接口请求次数
2|C520090002 发送PPM接口响应次数
3|C520090003 发送PPM接口成功响应次数
4|C520090007 收到系统级规则请求次数
5|C520090008 发送系统级规则响应次数
6|C520090009 发送系统级规则成功响应次数
7|C520090010 发送系统级规则配置通知接口请求次数
8|C520090011 发送系统级规则配置通知接口成功请求次数
9|C520090012 收到系统级规则配置通知接口响应次数
10|C520090013 收到销售品与流量识别标识关系请求次数
11|C520090014 发送销售品与流量识别标识关系响应次数
12|C520090015 发送销售品与流量识别标识关系成功响应次数
13|C520090016 发送销售品配置通知接口请求次数
14|C520090017 发送销售品配置通知接口成功请求次数
15|C520090018 收到销售品配置通知接口响应次数
####### 告警和通知 
编号|告警名称|描述
---|---|---
1|2988048654 数据区容量一级负荷|PPM数据区容量占用率超过阈值
2|2989097230 数据区容量二级负荷|PPM数据区容量占用率超过阈值
3|2990145806 数据区容量三级负荷|PPM数据区容量占用率超过阈值
#### 特性配置 

#### 特性配置 

##### 配置系统级规则和销售品规格同步接口特性 
###### 配置说明 
PCF通过配置HTTP2的服务端模板，使得采控平台能够发送PPM消息至PCF。
###### 配置前提 
PCF的网络可以和采控平台的网络连通。
###### 配置过程 
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，添加HTTP2的服务端模板配置，用于接收PPM接口消息。
 说明： 
建议使用Rosng中LOG平面的业务地址和PPM进行对接。此处服务端配置的地址即为LOG平面中新增的地址。 
###### 配置实例 
######## 场景说明 
PCF通过配置，可以接收采控平台发送的请求消息。 
######## 数据规划 
类别|参数|取值
---|---|---
HTTP服务端模板配置|ID|1
IPADDR|HTTP服务端模板配置|1.1.1.1
PORT|HTTP服务端模板配置|8090
VPNID|HTTP服务端模板配置|0
HTTPVERSION|HTTP服务端模板配置|HTTP_2
######## 配置步骤 
添加HTTP2的服务端模板配置 
其中，ID、IPADDR、PORT和VPNID参数值根据现场实际规划配置。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR="1.1.1.1",PORT=8090,VPNID=0,HTTPVERSION="HTTP_2"
 说明： 
如果部分用户无权限进行传表操作，请检查集中安全是否开启。如未开启，请开启集中安全。操作过程如下： 
登录EM客户端，选择菜单拓扑→分层接入
，在分层接入页面的操作列中选择查看相应代理。在弹出的查看页面中检查参数设置，其中支持集中安全参数配置为否。
返回分层接入页面，在该代理的操作列中选择停止，停止该代理。
在该代理的操作列中选择更多→修改
，在弹出的修改代理页面中配置支持集中安全参数为是。
返回分层接入页面，在该代理的操作列中选择启动，开启集中安全。
如果采控平台携带的套餐ID长度超过10位，请联系SPR网元侧评估是否可以打开PPM开关。

##### 配置RCP获取PCS方式的开关 


 

###### 配置说明 
RCP通过配置1358开关的值，修改获取PCS的方式。 
###### 配置前提 
组网中有OCS/CHF网元：1358开关配置为0，PCS从Sy/N28接口获取。    
组网中没有OCS/CHF网元：1358开关配置为1，PCS从SPR扩展属性获取。 
组网中不确定是否有OCS/CHF网元：1358开关配置为2，PCS从Sy/N28接口或者SPR扩展属性获取，优先从Sy/N28接口获取。 
###### 配置过程 
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改获取PCS的方式。
###### 配置实例 
######## 场景说明 
配置1358开关，通过SPR扩展属性获取PCS。 
######## 数据规划 
类别|参数|取值
---|---|---
修改系统全局变量|DX|1358
CURVAL|修改系统全局变量|1
EXTFLAG|修改系统全局变量|ADVANCED
######## 配置步骤 
修改开关1358配置 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1358,CURVAL="1",EXTFLAG="ADVANCED";
 说明： 
如果现场的PCS是通过Sy/N28接口获取的，则不需要进行该配置。 
##### 测试用例 
类别|参数|取值
---|---|---
系统级规则数据|动作类型|1
策略计数器标识1|系统级规则数据|101
策略状态1|系统级规则数据|201
速率值1|系统级规则数据|301
速率转换单位1|系统级规则数据|401
动作类型|系统级规则数据|1
策略计数器标识2|系统级规则数据|102
策略状态2|系统级规则数据|202
速率值2|系统级规则数据|302
速率转换单位2|系统级规则数据|402
类别|参数|取值
---|---|---
销售品规则数据|动作类型|1
销售品标识 1|销售品规则数据|1001
销售品名称1|销售品规则数据|销售品名称：1001
RG1|销售品规则数据|3001
策略计数器标识1|销售品规则数据|101
动作类型|销售品规则数据|1
销售品标识 2|销售品规则数据|1002
销售品名称2|销售品规则数据|销售品名称：1002
RG2|销售品规则数据|3002
策略计数器标识2|销售品规则数据|102
测试条目|基本系统级规则和销售品规则
---|---
预置条件|RCP上无PCID和规则配置。采控平台已完成系统级规则数据和销售品规则数据配置，参见表1和表2。
测试步骤|采控平台通过PPM接口向RCP下发系统级规则数据。采控平台通过PPM接口向RCP下发销售品规则数据。用户上线，签约套餐1001。
通过准则|RCP收到PPM系统级规则请求消息后返回成功响应消息，发送完成配置通知。RCP收到PPM销售品规则请求消息后返回成功响应消息，发送完成配置通知。RCP根据销售品规格数据、系统级规则数据生成用户控制策略。用户上线成功，触发N28/Sy会话建立流程，并在N28/Sy会话建立请求消息中携带PCID 101。CHF/OCS接收N28/Sy会话建立请求后，给RCP发送响应消息，携带PCID 101的PCS为201。RCP根据PPM接口携带的系统级规则数据、销售品规则数据和OCS返回的PCS信息，决策并下发ambr为301Mbps，defqos取用户上线请求中的值，下发预定义规则3001。检查PPM接口系统级规则请求消息和销售品规则请求消息的相关信息符合预期，跟踪详细信息、各类概要信息显示正确。系统级规则请求消息请求响应销售品规则请求消息请求响应
信令流程|
### 缩略语 
### 缩略语 
#### EM 
Element Management网元管理
#### PCF 
Policy Control Function策略控制功能
#### PPM 
Product and Package Management产品与套餐管理
#### RCP 
Resource Control Platform资源控制平台
#### RG 
Rating Group费率组
#### SPR 
Subscription Profile Repository用户签约数据库
### ZUF-59-41-001 Diameter Gx接口 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|含义
---|---
PDU会话|UE通过PCEF和数据网建立的一个连接，用于传输数据报文。
##### 描述 
####### 特性定义 
RCP的Diameter Gx接口遵循3GPP TS 29.212协议，使得RCP能够通过Gx接口对PCEF实施动态的策略和计费控制，主要功能包括：
PCEF为每个IP-CAN会话向RCP请求建立Gx会话。 
PCEF或RCP发起Gx会话修改或释放。 
PCEF通过Gx会话上报用户标识、用户IP地址、接入信息和用户位置信息等。 
RCP通过Gx会话向PCEF下发PCC规则、承载QoS、APN-AMBR、会话级计费参数，以及订阅相关事件等。 
RCP对Gx会话实施会话级或业务级用量监控。 
RCP通过Gx会话向PCEF订阅应用发生停止事件，根据PCEF上报的应用发生停止事件及相关业务流信息进行策略决策。 
RCP具备处理Gx会话事务冲突的能力，在本端事务冲突时能够拒绝会话内更新请求，在对端事务冲突时能够重试授权请求。 
####### 背景知识 
Gx接口是PCC架构的基础接口，RCP部署其他特性都需要以此特性为基础。 
##### 应用场景 
Gx接口用于PCEF向RCP请求PDU会话策略控制。
##### 客户收益 
受益方|受益描述
---|---
运营商|RCP通过Gx接口对PCEF的PDU会话实施动态的、差异化的策略控制，能够使运营商更有效的利用无线网络资源满足不同用户或不同业务需求。
用户|网络资源被合理分配，不会因为少量用户过度占用网络资源而影响大多数用户的上网体验。使用增值业务（如VoLTE）时能获得QoS保障。

##### 实现原理 


 

###### 系统架构 
本接口所涉及的系统架构如[图1](1665304702336.html#z8b7b36acc4d54cb2917f03b39b2a026c__8e46d221-7173-48af-bc27-cc053e05cd3c)所示。RCP通过Gx接口对PCEF的PDU会话实施动态的、差异化的策略控制。
图1  系统架构
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|说明
---|---
RCP|根据业务特性或用户属性，制定并下发控制与计费策略给PCEF。
PCEF|检测业务数据流，从RCP获取并执行基于业务的控制与计费策略。
AF|向RCP请求业务授权和资源预留。
SPR|提供用户个性化签约，存储用户动态数据。
BOSS|受理用户个性化签约。
###### 协议栈 
Gx接口标识PCRF与PCEF之间的逻辑通信路径，该接口基于Diameter协议进行通信，用于RCP的策略控制。其协议栈结构如[图2](1665304702336.html#zf68968eed77240e1adfd20ca16d4ea12__eb062067-5c5b-4a21-a9be-440353d5aeb7)所示。
图2  协议栈
[]images/%E5%8D%8F%E8%AE%AE%E6%A0%88.png)
###### 业务流程 
######## IP-CAN会话建立流程 
当PCEF收到用户发起的IP-CAN会话建立请求时，触发Gx接口上的IP-CAN会话建立流程。
PCEF发起的IP-CAN会话建立流程如[图3](1665304702336.html#zb1e09712656b4352ad0d6a968036ba9a__2ff9f518-6c4d-43ae-b813-4d81a4c214a5)所示。
图3  IP-CAN会话建立流程
[]images/ip-can%E4%BC%9A%E8%AF%9D%E5%BB%BA%E7%AB%8B%E6%B5%81%E7%A8%8B.png)
用户上线通过PCEF向RCP发送CCR-I请求建立会话，其中CCR-I中会携带CC-Request-Type、Session-Id、Subscription-Id、Framed-IP-Address、3GPP-User-Location-Info、Access-Network-Charging-Identifier-Gx等会话信息。
RCP根据用户标识User-name向SPR获取用户的签约信息，如果用户上线时不需要获取用户签约信息则跳过此步骤，执行第6步。
SPR返回RCP请求的用户签约信息。 
RCP根据用户标识User-name向SPR获取用户的用量信息。 
SPR返回RCP请求的用户用量信息。 
RCP根据用户的签约、用量、会话等信息进行策略决策，生成规则，通过CCA-I发送给PCEF，PCEF根据授权结果安装规则。CCA-I中会包含Charging-Rule-Install、QoS-Information、Event-Trigger等信息。
######## PCEF发起的IP-CAN会话修改流程 
当PCEF检测到需要修改用户的IP-CAN会话时（如用户发起IP-CAN承载QoS更新、资源修改申请、RCP订阅的相关事件发生等），PCEF触发Gx接口上的IP-CAN会话修改。
PCEF发起的IP-CAN会话修改流程如[图4](1665304702336.html#zb1e09712656b4352ad0d6a968036ba9a__80c558cd-b39b-40eb-b09d-e82ad98213d1)所示。
图4  PCEF发起的IP-CAN会话修改流程
[]images/pcef%E5%8F%91%E8%B5%B7%E7%9A%84ip-can%E4%BC%9A%E8%AF%9D%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B.png)
当RCP订阅的事件发生时，PCEF发送CCR-U消息给RCP，CCR-U中会携带CC-Request-Type、对应的Event-Trigger以及该事件的相关信息。
RCP根据上报的信息以及用户的签约、用量、会话等信息，重新进行策略决策，生成新的规则，通过CCA-U消息将新的规则下发给PCEF。PCEF安装新的规则。 
######## RCP发起的IP-CAN会话修改流程 
当RCP检测到预置条件触发时，如预置时间更新QoS、更新PCC规则等，RCP触发Gx接口上的IP-CAN会话修改。
RCP发起的IP-CAN会话修改流程如下图所示： 
图5  RCP发起的IP-CAN会话修改流程
[]images/rcp%E5%8F%91%E8%B5%B7%E7%9A%84ip-can%E4%BC%9A%E8%AF%9D%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B.png)
当RCP本地事件触发，或者外部网元触发时，RCP会重新进行策略判断，生成新的规则，通过RAR消息下发给PCEF。
PCEF安装新的规则，给RCP返回RAA消息。
######## PCEF发起的IP-CAN会话中止流程 
当PCEF收到来自UE的IP-CAN会话删除请求，触发Gx接口上的IP-CAN会话终止流程。 
PCEF发起的IP-CAN会话中止流程如[图6](1665304702336.html#zb1e09712656b4352ad0d6a968036ba9a__d448783d-48a7-41c0-bf3b-f6513959d65b)所示。
图6  PCEF发起的IP-CAN会话中止流程
[]images/pcef%E5%8F%91%E8%B5%B7%E7%9A%84ip-can%E4%BC%9A%E8%AF%9D%E4%B8%AD%E6%AD%A2%E6%B5%81%E7%A8%8B.png)
用户下线时，通过PCEF向RCP发送CCR-T消息请求结束会话。
RCP释放会话资源，给PCEF回CCA-T响应消息。PCEF释放会话资源。
RCP判断是否有用量/短信信息变更，如果有则通过Sp'-UDR向SPR同步用量/短信的变更信息。如果没有变更信息则跳过此步骤，执行第5步。
SPR通过Sp'-UDA向RCP返回响应信息。
RCP通过Sp-UDR通知SPR用户下线，如果用户上线时不需要获取用户签约信息则在中止会话时跳过此步骤和步骤6。 
SPR通过Sp-UDA向RCP返回响应信息。 
######## RCP发起的IP-CAN会话中止流程 
当RCP检测到需要删除用户的IP-CAN会话时，如用户用量用尽或BOSS通知RCP该用户欠费，触发Gx接口上的IP-CAN会话终止流程。 
RCP发起的IP-CAN会话中止流程如[图7](1665304702336.html#zb1e09712656b4352ad0d6a968036ba9a__3697dbd1-587d-4f64-b251-5e002b51beca)所示。
图7  RCP发起的IP-CAN会话中止流程
[]images/rcp%E5%8F%91%E8%B5%B7%E7%9A%84ip-can%E4%BC%9A%E8%AF%9D%E4%B8%AD%E6%AD%A2%E6%B5%81%E7%A8%8B.png)
RCP基于签约修改、签约删除或时间等检测到需要终止IP-CAN会话时，发送RAR消息给PCEF来终止IP-CAN会话，RAR消息中包括会话释放原因。 
PCEF删除应用于该IP-CAN会话的所有PCC规则并发送RAA消息给RCP作为响应。 
PCEF发送CCR-T给RCP指示IP-CAN会话终止。 
RCP向PCEF发送CCA-T告知Gx会话已终止。 
RCP判断是否有用量/短信信息变更，如果有则通过Sp'-UDR向SPR同步用量/短信的变更信息。如果没有变更信息则跳过此步骤，执行第7步。 
SPR通过Sp'-UDA向RCP返回响应信息。 
RCP通过Sp-UDR通知SPR用户下线，如果用户上线时不需要获取用户签约信息则在中止会话时跳过此步骤和步骤8。 
SPR通过Sp-UDA向RCP返回响应信息。 
######## RCP作为服务端处理IP-CAN会话事务冲突流程 
当RCP在处理由第三方网元触发的IP-CAN会话更新时，收到了IP-CAN会话的更新请求并无法处理，则拒绝该次更新请求。在PCEF重新发送更新请求后再处理。 
RCP作为服务端处理IP-CAN会话事务冲突流程如[图8](1665304702336.html#zb1e09712656b4352ad0d6a968036ba9a__d1668a2d-7a88-4080-a0b0-215d8acce27e)所示。
图8  RCP作为服务端处理IP-CAN会话事务冲突流程
[]images/rcp%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86ip-can%E4%BC%9A%E8%AF%9D%E4%BA%8B%E5%8A%A1%E5%86%B2%E7%AA%81%E6%B5%81%E7%A8%8B.png)
用户上线后使用IMS业务，AF向RCP发送AAR消息，触发AF会话建立，携带媒体部件等信息。
RCP建立AF会话，存储媒体等信息，并向AF回复成功AAA响应。
RCP对VoLTE业务进行决策，生成PCC规则，向PCEF发送RAR消息请求资源授权。
同时，PCEF向RCP发送CCR-U请求会话信息更新。
RCP检测到本端处于事务冲突的状态，不处理该CCR-U，向PCEF回复错误CCA-U响应携带DIAMETER_PENDING_TRANSACTION（4144）。
PCEF也检测到会话处于事务冲突的状态，向RCP回复错误RAA响应携带DIAMETER_PENDING_TRANSACTION（4144）。此时RCP检测到双方网元事务冲突，不尝试重新发送RAR请求。 
PCEF重新发送CCR-U请求会话信息更新。 
RCP处理该CCR-U请求，并根据最新的会话信息及本地配置能力对VoLTE业务进行决策，在CCA里下发所有最新的规则。 
若本地配置能力不支持在重试的CCA中下发VoLTE相关规则，则再次发送RAR消息请求资源授权。
PCEF处理该RAR请求，并返回成功RAA响应。
###### 本网元实现 
######## 用户会话重复性校验 
用户上线时，PCEF会重新给用户会话分配IP地址。当 PCEF发生异常重启后，新上线的会话的IP+IP-Domain-ID或IP+APN+PCEF邻接局编号可能与之前未正常下线的会话重复，即认为这些已在线的会话为挂死会话。为了删除这些挂死会话，RCP在用户建立会话时会根据IP+IP-Domain-ID或IP+APN+PCEF邻接局编号进行重复性校验，有IP-Domain-ID时优先使用IP+IP-Domain-ID做重复性校验。 
如果查找到重复的会话，则内部删除这些挂死会话，根据新的请求消息建立会话。 
 说明： 
RCP只能在每个模块内对Gx会话做IP重复性校验，如果两个Gx会话分发到不同模块，即使IP重复，也无法做重复性校验。 
RCP V7.22.10版本及之后，可按“DNN属性配置”确定每个APN（DNN和APN的概念相同）是否允许不同会话IP地址重复。“DNN属性配置”包含“DNN”和“是否允许IP重复”字段，并包含一条通配DNN（DNN="*"）的默认记录。 
如果一个APN在“DNN属性配置”中没有自己的记录，则匹配默认记录。对允许IP重复的APN，RCP不对相关会话做IP地址重复性校验（RCP不会因此类会话携带的IP地址和其他会话中携带的IP地址重复而释放别的会话，也不会因别的会话中携带的IP地址和此类会话携带的IP地址重复而释放此类会话）。 
如果Rx会话绑定多个Gx会话且其中存在APN允许IP重复的会话，则绑定失败，在AAA消息中返回5065-DIAMETER_UNALBE_TO_COMPLY失败码。 
RCP V7.22.20.B2版本之前，用户会话上线时如果查找到重复的会话，则内部删除这些挂死会话，根据新的请求消息建立会话。不会触发外部消息通知PCEF进行会话下线。 
RCP V7.22.20.B2版本及之后，新增了Gx接口判重释放会话可配是否通知PGW功能： 
通过软件参数“1361 Gx接口判重释放会话是否通知PGW”控制Gx重复会话释放是否通知PGW。 
1361开关为0-不通知（默认）：Gx接口重复会话释放不通知PGW，和本特性修改前处理一致。 
1361开关为1-通知：Gx接口重复会话释放会通知PGW。 
重复会话的释放为强制释放，不论和PCEF的消息交互是否正常，该重复会话最终都会被删除。 
######## 会话保活 
为了防止RCP与PCEF之间由于消息丢失等异常情况造成会话资源挂死，RCP利用现有RAR消息实现会话保活功能。当“网元间保活检测配置”存在“资源类型”为“DPI IP-CAN会话”且“保活方式”为“网元间保活”的配置记录，且当RCP与PCEF之间的Gx接口链路在一定时间内没有消息交互时，RCP构造不携带任务业务信息的RAR消息发送至PCEF，根据PCEF返回的结果码来检测会话是否存在： 
如果PCEF返回的RAA中结果码为DIAMETER_SUCCESS（2001）时，RCP认为该PDU会话有效，保活成功。 
如果PCEF返回的RAA中结果码为DIAMETER_UNKNOWN_SESSION_ID（5002）时，RCP就释放该PDU会话资源。 
其它情况，RCP按“网元间保活检测配置”的“保活周期”（默认4小时）重试会话保活。如果会话在PCEF/RCP无成功交互时长超过“资源扫描配置”中“资源类型”为“DPI IP-CAN会话”的配置记录的“强制释放时长”所规定的时长，则RCP强制释放该会话，不通知PCEF。 
######## 会话重授权 
RCP可以下发Revalidation-Time（简称RT）给PCEF，RT是一个绝对时间点（精确到年月日时分秒）。PCEF需在此时间点发送Update请求携带REVALIDATION_TIMEOUT事件，触发RCP重新进行策略决策，并可能生成新的策略规则和新的RT，在响应中下发给PCEF，起到会话重授权的作用。如果RCP侧会话已异常释放（未通知到PCEF），RCP在响应中回复DIAMETER_UNKNOWN_SESSION_ID（5002），也可以促使PCEF删除对应会话，保证PCEF/RCP双方会话一致。 
Revalidation-Time相关配置参见“ZUF-59-52-001 基于时段的策略
”实现原理的本网元实现章节的会话授权时长和revalidationTime相关描述。
######## 用户会话数量限制 
RCP允许一个用户并发的Gx+N7会话数上限为11个，达到上限后RCP会拒绝新会话建立。此外，RCP根据“同用户同DNN多会话审计配置”检测用户多会话时是否有挂死会话并进行清理，“同用户同DNN多会话审计配置”各字段含义及RCP的对应处理如下： 
字段名|类型|取值范围|默认值|作用
---|---|---|---|---
会话数门限|整型|1~11|2|N7/Gx会话建立或RCP容灾接管从CDB加载用户数据时，RCP检查“同用户同DNN会话数 ≥ 会话数门限 &（该用户该DNN最久未交互会话的最后更新时间点 - 当前时间点 > 静默时长门限）”时，对此用户此DNN最久未交互会话做一次审计（主动保活）。确定是否相同用户时只看主用户标识（即由“用户标识类型优先级配置”的“首选用户标识类型”确定）。取值1代表RCP不启用同用户同DNN多会话审计功能。
静默时长门限（秒）|整型|0~65535|6|静默时长门限和会话数门限一起作为同用户同DNN多会话审计的触发条件。某些UE上线后立即在某个DNN上同时发起多会话，设置静默时长门限是为了减少此类场景下RCP触发老会话审计，减少SMF/PGW侧事务冲突。
初始间隔（秒）|整型|3~3600|12|老会话（最久未交互会话）满足上述审计条件后，RCP在【初始间隔，初始间隔+离散区间】内产生一个随机值（按毫秒），按此随机值设置定时器，定时器到期后，触发对老会话的主动保活。这样可以平滑RCP主动保活信令量冲高，例如DC倒换后，Gx会话批量重建信令量冲高，引发PCF老会话审计保活到DRA的信令量冲高。初始间隔设置为12s以上，是因为：现网最常见的4G切3G失败导致会话挂死重建，SMF侧挂死会话释放时长为10s，PCF设置为12s秒可以尽量让SMF自己先释放挂死会话，减少PCF的老会话审计保活。5G接入N7会话Create后立即会有Update，将老会话审计延迟12s以上，可以先处理新会话的Update，避免老会话审计影响新会话Update时延。
离散区间（秒）|整型|0~3600|120|用于平滑新会话建立TPS冲高引发的老会话反向保活TPS冲高。
重试间隔（秒）|整型|30~3600|120|老会话审计时，RCP主动保活老会话，若保活成功（收到Diameter2001/2002/http2xx）则维持老会话，若保活失败（保活请求发送失败，或响应超时，或收到失败响应但非5002/404且非例外失败码），则可配再保活一次。本参数指示下次重试保活前的间隔。若保活收到例外失败码，此时无法判断SMF有没有被保活会话，视为保活成功，不再重试保活，但也不刷新会话更新时间戳，此类会话若长时间无交互，则根据RCP资源扫描配置，默认24小时释放。若保活收到响应5002/404，直接释放老会话。老会话审计的初次或下次保活前，若相同用户+DNN上有新会话建立，则新会话建立后立即触发老会话保活。老会话审计的初次或下次保活前，若老会话因其它业务流程刷新了会话最后更新时间，则取消老会话保活。
重试次数|整型|0~5|1|会话审计保活失败后重试次数。重试达上限后仍失败则直接释放会话，不再发释放通知给SMF/PGW。
例外失败码|字符串|长度0~64（含'\0'）|400,429,503,3004|若保活收到例外失败码，视为保活成功，不再重试保活，但也不刷新会话更新时间戳。本字段为字符串，只允输入数字和英文逗号。多个失败码间用逗号隔开。Diameter失败码和http失败码可以混在一起配，3位数的为http失败码，4位数的为Diameter失败码。缺省值：400（针对SMF不兼容RCP主动活请求的场景）和429/503/3004（针对SMF/PGW过负荷场景）。
######## 事件订阅 
RCP能够基于PCEF上报的用户信息、承载事件及状态等，进行规则决策。PCEF上报的大部分事件依赖于RCP的订阅。 
RCP支持事件订阅功能，可通过“默认上报事件配置”和“上报事件配置”实现： 
默认上报事件通过命令SET DEFPCEFEVENT配置，该配置适用于所有用户会话，可在需要对本网元的用户会话进行统一配置时使用。 
上报事件通过命令ADD PCEFEVENT配置，该配置适用于特定类型的用户或使用特定业务的用户，可在需要对用户进行定制化配置订阅事件时使用。配置中通过“应用标识+用户类型”来确定特定类型的用户，通过“套餐”来确定使用特定业务的用户。 
由于订阅事件过多会造成RCP和PCEF网元间信令交互的增加，加剧网络负荷，所以建议默认关闭所有事件订阅，根据运营需求开启需要的事件。 
######## UE资源修改 
当PCEF具备DPI（深度报文识别）功能，用户使用某种业务时，PCEF可以通过CCR消息中的Packet-Filter-Information和Packet-Filter-Operation给RCP上报业务的五元组信息及动作。RCP可基于此业务信息进行决策，对业务进行策略控制。 
若此业务五元组信息中的服务端IP和Port是预先可配置的，RCP可通过配置在业务流特征配置（ADD SVCFLOWCHR）中配置服务端地址对应的应用标识。 
若此业务五元组信息中的服务端IP和Port是预先无法感知的，RCP可通过未知业务流的应用标识配置（ADD UNKNOWNAPPID）来映射对应的应用标识。 
RCP可根据上述两种方式映射出来的应用标识进行决策，下发对应的PCC规则。 
PCEF可通过Packet-Filter-Operation值置为修改（MODIFICATION）上报业务发生修改动作，RCP根据最新业务信息更新PCC规则；PCEF也可以通过Packet-Filter-Operation值置为删除（DELETION）上报业务停止，RCP可删除对应的PCC规则。 
######## Gx会话事务冲突处理能力 
RCP具备处理Gx会话事务冲突的能力，体现在如下几个场景： 
若某个Gx会话收到一个CCR-U更新请求时，RCP会检测该会话是否有正在进行的事务（例如对VoLTE业务进行决策下发RAR，等待响应中）。若没有正在进行的事务，则正常处理该CCR-U请求。若存在正在进行的事务，RCP支持拒绝该CCR-U请求，携带Experimental-Result AVP，设置其值为DIAMETER_PENDING_TRANSACTION（4144）。若存在正在进行的事务，RCP也支持等待正在进行的事务完成后（即处理RAR的流程结束）再处理该CCR-U请求。但等待正在进行的事务超时后，RCP仍会使用4144响应拒绝该请求。RCP可通过配置全局开关“1117 RCP处理IPS会话信令冲突的能力”来控制对于存在事务冲突的Gx会话的处理方式。 
若RCP向PCEF发送RAR更新某个会话的策略授权时，PCEF使用4144响应回复时，RCP支持重新发送该RAR请求。RCP可通过配置全局开关“1118 RCP收到信令冲突响应时重试请求的最大次数”来控制重新发送该请求的次数。 
若RCP收到PCEF回复的4144响应时，已经拒绝过PCEF的一个更新请求，则不再重新发送RAR请求。RCP会等待PCEF重新发送更新请求进行处理；在回复请求消息时，RCP支持：在CCA响应中合并下发之前RAR请求里的策略。在CCA响应之后再次下发之前RAR请求里的策略。RCP可通过配置全局开关“1121 信令防冲突功能规则合并方式”来控制此种场景下规则下发的方式。 
######## Gx接口3GPP-Charging-Characteristics处理 
Gx接口CCR-I可选携带3GPP-Charging-Characteristics参数，用于PCEF向RCP上报用户计费特性，例如用户是否启用在线或离线计费。3GPP-Charging-Characteristics取值是4字节16进制数字字符串，常见的取值有0400、0800、0A00。3GPP-Charging-Characteristics取值可展开为16个bit，每个bit取值0或1表示该bit对应的计费特性启用或关闭，每个bit位所对应的计费特性含义由运营商自定义。 
当用户SPR签约无Charging-Type参数时，RCP策略配置的业务键“付费类型”（USER_CHARGING_TYPE）或用户级策略计数器标识配置/套餐级策略计数器标识配置的“计费类型”可以从Gx接口3GPP-Charging-Characteristics取值，全局开关“1390 Gx接口3GPP-Charging-Characteristics处理方式
”控制该场景下取值方式，默认取值0，兼容旧版本处理方式。1390开关具体取值如下：
取值0：仅将3GPP-Charging-Characteristics取值左起第2字节当做10进制字符（0-9），转换为10进制数值使用。若左起第2字节非10进制字符，则转换后取值为0。 
取值1：将3GPP-Charging-Characteristics取值当4字节16进制数字字符串，转换为10进制数值使用。若非4字节16进制数字字符串，则转换后取值为0。如果需要基于3GPP-Charging-Characteristics取值做策略控制，建议1390开关取值改为1，对齐3GPP标准。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
一个用户同时建立的IP-CAN会话数最多为11个。 
单会话最多支持140个业务规则。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准名称|标准用途
---|---|---
3GPP|3GPP TS 29.212 Gx reference point|定义PCEF和RCP之间的参考点。
##### 特性能力 
名称|指标
---|---
一个用户最多同时建立的IP-CAN会话数|11
单会话最多支持的业务规则数|140
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.21|首次发布。
####### License要求 
该特性为RCP与PCEF网元的基本特性，无需License支持。
####### 对其他网元的要求 
Gx接口特性需要PCEF和RCP网元配合完成。其中，PCEF和RCP需要具有支持Gx接口功能。 

##### O&M相关 


 

###### 命令 
######## 配置项 
编号|命令项|命令名称|描述
---|---|---|---
1|承载能力配置|ADD BEARABILITY|增加承载能力
SET BEARABILITY|1|承载能力配置|修改承载能力
DEL BEARABILITY|1|承载能力配置|删除承载能力
SHOW BEARABILITY|1|承载能力配置|查询承载能力
2|应用标识配置|ADD APPSUBS|增加应用标识
SET APPSUBS|2|应用标识配置|修改应用标识
DEL APPSUBS|2|应用标识配置|删除应用标识
SHOW APPSUBS|2|应用标识配置|查询应用标识
3|业务流特征配置|ADD SVCFLOWCHR|增加业务流特征
SET SVCFLOWCHR|3|业务流特征配置|修改业务流特征
DEL SVCFLOWCHR|3|业务流特征配置|删除业务流特征
SHOW SVCFLOWCHR|3|业务流特征配置|查询业务流特征
4|未知业务流的应用标识配置|ADD UNKNOWNAPPID|增加未知业务流的应用标识
SET UNKNOWNAPPID|4|未知业务流的应用标识配置|修改未知业务流的应用标识
DEL UNKNOWNAPPID|4|未知业务流的应用标识配置|删除未知业务流的应用标识
SHOW UNKNOWNAPPID|4|未知业务流的应用标识配置|查询未知业务流的应用标识
5|上报事件配置|ADD PCEFEVENT|增加上报事件
SET PCEFEVENT|5|上报事件配置|修改上报事件
DEL PCEFEVENT|5|上报事件配置|删除上报事件
SHOW PCEFEVENT|5|上报事件配置|查询上报事件
6|默认上报事件配置|SET DEFPCEFEVENT|修改默认上报事件
SHOW DEFPCEFEVENT|6|默认上报事件配置|查询默认上报事件
7|DNN属性配置|ADD DNNATTR|增加DNN属性配置
SET DNNATTR|7|DNN属性配置|修改DNN属性配置
DEL DNNATTR|7|DNN属性配置|删除DNN属性配置
SHOW DNNATTR|7|DNN属性配置|查询DNN属性配置
######## 定时器 
定时器编号|定时器名称|系统缺省值（毫秒）|建议
---|---|---|---
2050|FSWAITBEARER|6000|不建议修改
2051|FSWAITRELEASE|8000|不建议修改
######## 全局变量 
参数名称|系统缺省值|建议
---|---|---
1000 MSISDN获取来源|1|不建议修改
1014 时区和夏令时获取来源|1|不建议修改
1059 规则激活/去激活时间区间开关|0|不建议修改
1070 Gx接口中下发ARP计费地址时，是否支持用量监控|1|不建议修改
1074 Gx支持相同IMSI和APN的会话个数|1|不建议修改
1117 RCP处理IPS会话信令冲突的能力|0|不建议修改
1118 RCP收到信令冲突响应时重试请求的最大次数|1|不建议修改
1121 信令防冲突功能规则合并方式|0|不建议修改
1390 Gx接口3GPP-Charging-Characteristics处理方式|0|不建议修改
######## 动态管理 
释放IMSI为“46002010106000”的Gx会话：REL_SESS:SESSIONTYPE="GxSess",USERKEYTYPE="IMSI",USERKEY="46002010106000"; 
查询IMSI为“46002010106000”的DPI-IPCAN会话的详细信息：SHOW_DPI_IPCAN_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="46002010106000"; 
###### 性能统计 
编号|性能计数器名称
---|---
1|C000200069 在线数据APN的Gx会话数|C000200069 在线数据APN的Gx会话数
2|C000200070 在线数据APN的Gx会话数均值|C000200070 在线数据APN的Gx会话数均值
3|C000200071 在线数据APN的Gx会话数峰值|C000200071 在线数据APN的Gx会话数峰值
4|C000200072 在线IMS APN的Gx会话数|C000200072 在线IMS APN的Gx会话数
5|C000200073 在线IMS APN的Gx会话数均值|C000200073 在线IMS APN的Gx会话数均值
6|C000200074 在线IMS APN的Gx会话数峰值|C000200074 在线IMS APN的Gx会话数峰值
###### 告警和通知 
该特性不涉及告警消息的变化。 
###### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


 

##### 动态规则特性配置 
###### 配置说明 
通过增加上报事件配置，在用户上线时，RCP将订阅的上报事件下发给PCEF；当事件发生时，RCP根据PCEF上报的订阅事件号和事件进行重决策。
通过增加业务流特征配置，实现业务流与应用标识的映射，当用户上线携带了业务流时，RCP根据流信息和业务流特征配置映射对应的应用标识，并根据映射的应用标识进行策略决策，下发对应的规则。 
###### 配置前提 
Gx接口的配置，需要RCP和PCEF共同配合完成，因此在配置此特性之前，RCP与PCEF需要协商好互联数据，包括链路配置和路由数据配置。
###### 配置过程 
图1  动态规则配置流程
[]images/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
在EM客户端的配置界面，执行[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html)命令，配置Gx接口的承载能力。
在EM客户端的配置界面，执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息（如果此套餐已存在，则跳过此步）。
在EM客户端的配置界面，执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，配置应用标识属性（如果此应用标识已存在，则跳过此步）。
在EM客户端的配置界面，执行[ADD SVCFLOWCHR](../../Npcf_PolicyManagement\zh-CN\mml\1787321.html)命令，配置业务特征流。
在EM客户端的配置界面，执行[ADD PCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787143.html)命令，配置上报事件。
在EM客户端的配置界面，选择RCP策略管理，进入策略管理页面，配置基于UE资源修改的控制策略。
在EM客户端的配置界面，选择RCP策略管理，进入策略管理页面，提交配置的策略数据。
###### 配置实例 
######## 配置场景 
用户上线，携带业务流信息，RCP根据业务流信息映射的应用标识进行策略决策，通过CCA将决策的规则和订阅的事件下发给PCEF。 
######## 数据规划 
数据规划参见下表： 
类别|参数|取值
---|---|---
承载能力|邻接主机组编号|1
接口能力|承载能力|PGW
业务标识方式|承载能力|业务标识
套餐|套餐标识|1
套餐类型|套餐|用户套餐
应用标识|应用标识|1001
业务特征流配置|业务特征流配置编号|1
服务器IP|业务特征流配置|192.169.0.15
服务器最小端口|业务特征流配置|8888
应用标识|业务特征流配置|1001
上报事件配置|UE发起承载资源变更|YES
策略规划参见下表： 
类别|条件|动作参数
---|---|---
业务规则|Gx应用标识 = 1001|SVC_UE_resourse_change_1001
######## 配置步骤 
承载能力配置 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):INTERFACE="PGW",SERVMODE="SERVICEID";
套餐配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
应用标识配置 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
业务流特征配置 
[ADD SVCFLOWCHR](../../Npcf_PolicyManagement\zh-CN\mml\1787321.html):ID=1,SERVERIPADDR="192.169.0.15",SERVERPORT=8888,SERVERPORTMAX=8888,APPID=1001;
上报事件配置 
[ADD PCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787143.html):ID=1,PKGID="1",RESOURCEMODREQ="YES";
基于UE资源修改的控制策略配置 
规则条件配置 
条件名称|参数|取值
---|---|---
UE_resourse_change_1001|选择策略变量|其他
策略变量类别|UE_resourse_change_1001|IP-CAN会话信息类
策略变量|UE_resourse_change_1001|Gx应用标识
操作符|UE_resourse_change_1001|=
参考值|UE_resourse_change_1001|1001
规则动作参数配置 
业务控制策略动作参数： 
动作参数名称|参数名称|取值
---|---|---
SVC_UE_resourse_change_1001|参数类型|PCC规则参数集
业务规则类型|SVC_UE_resourse_change_1001|动态规则
规则名|SVC_UE_resourse_change_1001|UE_resourse_change_1001
应用标识|SVC_UE_resourse_change_1001|1001
QoS等级标识|SVC_UE_resourse_change_1001|1
请求的上行流带宽|SVC_UE_resourse_change_1001|5242880
请求的下行流带宽|SVC_UE_resourse_change_1001|5242880
容忍的上行流带宽|SVC_UE_resourse_change_1001|102400
容忍的下行流带宽|SVC_UE_resourse_change_1001|102400
ARP优先级|SVC_UE_resourse_change_1001|1
ARP抢占能力|SVC_UE_resourse_change_1001|开启
ARP被抢占能力|SVC_UE_resourse_change_1001|开启
优先级|SVC_UE_resourse_change_1001|2
场景配置 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
Role_resourse_change|入口|入口类型|用户信息类
已选入口|Role_resourse_change|入口|用户套餐
取值|Role_resourse_change|入口|1
策略类型|Role_resourse_change|业务控制策略|Rule_UE_resourse_change_1001
业务控制策略规则配置： 
规则名称|参数|取值
---|---|---
Rule_UE_resourse_change_1001|优先级|1
动作类型|Rule_UE_resourse_change_1001|参数填充
日志开关|Rule_UE_resourse_change_1001|关
条件表达式|Rule_UE_resourse_change_1001|{Gx应用标识 = 1001}
动作参数名称|Rule_UE_resourse_change_1001|SVC_UE_resourse_change_1001
提交配置的策略数据   
在EM客户端的配置界面，选择“RCP策略管理”，进入策略管理页面，提交配置的策略数据。 
[]images/%E6%AD%A5%E9%AA%A47.png)
##### Gx接口判重释放会话通知PGW特性配置 
###### 配置说明 
Gx按DNN判重时，通知PGW释放旧会话。 
###### 配置前提 
整个消息流程需要RCP和PCEF共同配合完成，因此在配置此特性之前，RCP与PCEF需要协商好互联数据，包括链路配置和路由数据配置。 
该功能由软件参数1361控制，1361开关为0时保持和原有流程逻辑一致，即Gx会话判重不会通知PGW；1361开关为1时，当Gx会话按DNN判重时，Gx接口发送消息通知PGW下线。
###### 配置过程 
目前Gx接口按DNN判重分为以下两种情况。 
DNN属性配置为不允许重复时，用户重复会话判重释放会话通知PGW。在EM客户端的配置界面，执行SET SYS GLOBPARA:IDX=1361,CURVAL="1"命令，开启Gx接口判重释放会话可配是否通知PGW的功能，置为0则该功能不可以使用。在EM客户端的配置界面，执行ADD DNNATTR命令，配置DNN属性。 
相同的用户号IMSI下一个DNN只存在一个会话时，用户重复会话判重释放会话通知PGW。在EM客户端的配置界面，执行SET SYS GLOBPARA:IDX=1361,CURVAL="1"命令，开启Gx接口判重释放会话可配是否通知PGW的功能，置为0则该功能不可以使用。在EM客户端的配置界面，执行SET SYS GLOBPARA:IDX=1074,CURVAL="1"命令，设置相同的用户号IMSI下一个DNN只存在一个会话。在EM客户端的配置界面，执行ADD DNNATTR命令，配置DNN属性。 
###### 配置实例1-DNN属性配置为不允许重复时，用户重复会话判重释放会话通知PGW 
######## 配置场景 
DNN属性配置为不允许重复，当用户使用不同的用户号码，相同的APN+IP上线新的会话时，会将会话判定为重复会话。 
######## 数据规划 
全局变量： 
开关编号|取值
---|---
1361|1
配置规划： 
类别|参数|取值
---|---|---
DNN属性配置|DNN|cmnet
DIP|DNN属性配置|NO
######## 配置步骤 
全局开关配置 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1361,CURVAL="1";
该配置开启Gx接口判重释放会话可配是否通知PGW的功能。 
DNN属性配置 
[ADD DNNATTR](../../Npcf_PolicyManagement\zh-CN\mml\1789089.html):DNN="cmnet",DIP="NO";
具体DNN根据实际情况填写。 
###### 配置实例2-相同的用户号IMSI下一个DNN只存在一个会话时，用户重复会话判重释放会话通知PGW 
######## 配置说明 
当软件参数1074为1时，只允许相同的用户号IMSI下一个DNN只存在一个会话，此时用户使用同一个IMSI和DNN，不同的IP上线新的会话，会将会话判定为重复会话。 
######## 数据规划 
全局变量： 
开关编号|取值
---|---
1361|1
1074|1
配置规划： 
类别|参数|取值
---|---|---
DNN属性配置|DNN|cmnet
######## 配置步骤 
全局开关配置 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1361,CURVAL="1";
该配置开启Gx接口判重释放会话可配是否通知PGW的功能。 
全局开关配置 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1074,CURVAL="1";
设置相同的用户号IMSI下一个DNN只存在一个会话。 
DNN属性配置 
[ADD DNNATTR](../../Npcf_PolicyManagement\zh-CN\mml\1789089.html):DNN="cmnet";
具体DNN根据实际情况填写。 
##### 测试用例 
测试项目|PCEF发起的UE资源修改流程
---|---
预置条件|PCC网络中各网元系统及操作维护台运行正常；预备LTE接入终端一款，接入无线信号正常。用户在SPR中已签约业务。在RCP及PCEF上建立Gx接口跟踪。网管基本业务、默认上报事件、业务特征流及规则配置已完成。
测试步骤|用户上线通过PCEF向RCP发送CCR-I请求建立会话，检测CCR-I携带的相关AVPs。如：Session-Id、Subscription-Id、Framed-IP-Address、Packet-Filter-Information、Packet-Filter-Operation。RCP向SPR获取签约、用量信息，并通过业务流信息匹配应用标识，根据用户的签约、会话等信息进行策略决策，返回CCA-I消息将规则及订阅事件下发给PCEF。PCEF通过CCR-U向RCP发起会话修改请求，携带Packet-Filter-Information、Packet-Filter-Operation、Event-Trigger等AVP。RCP根据携带的流、Packet-Filter-Information、Packet-Filter-Operation等信息进行策略重决策，通过CCA-U将决策信息下发给PCEF。PCEF向RCP发送CCR-T，释放会话。
通过准则|用户上线，RCP能够正确的下发授权QoS、Flow-Information、Precedence、Event-Trigger等规则信息。PCEF携带Packet-Filter-Information、Packet-Filter-Operation等信息更新流信息，RCP能正确的下发更新后的Flow-Information。用户正常下线。消息跟踪能够跟踪到相应的消息，流程正确，符合信令流程图及其描述，符合3GPP TS29.212 R9规范要求的AVP取值。
信令流程|
### 缩略语 
### 缩略语 
#### AAA 
Answer-Auth-Answer应答鉴权响应
#### AAR 
Auth-Application Request鉴权应用请求
#### AF 
Application Function应用功能
#### AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
#### APN 
Access Point Name接入点名称
#### ARP 
Allocation and Retention Priority分配保持优先级
#### BBERF 
Bearer Binding and Event Reporting Function承载绑定和事件上报功能
#### BOSS 
Business and Operation Support System运营和运维支撑系统
#### CCA-I 
Credit Control Answer-Initial初始信用控制应答
#### CCA-T 
Credit Control Answer-Terminate终止信用控制应答
#### CCA-U 
Credit Control Answer-Update更新信用控制应答
#### CCA 
Credit Control Answer信用控制应答
#### CCR-I 
Credit Control Request-Initial初始信用控制请求
#### CCR-T 
Credit Control Request-Terminate终止信用控制请求
#### CCR-U 
Credit Control Request-Update更新信用控制请求
#### DNN 
Data Network Name数据网名称
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### IP-CAN 
IP Connectivity Access NetworkIP连通接入网
#### MSISDN 
Mobile Station International Subscriber Directory Number移动台国际用户目录号
#### PCC 
Policy and Charging Control计费和策略控制
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PCRF 
Policy and Charging Rules Function策略和计费规则功能
#### PDU 
Packet Data Unit分组数据单元
#### PGW 
PDN Gateway分组数据网网关
#### QoS 
Quality of Service服务质量
#### RAA 
Re-Auth-Answer重新鉴权响应
#### RAR 
Re-Auth-Request重新鉴权请求
#### RCP 
Resource Control Platform资源控制平台
#### SPR 
Subscription Profile Repository用户签约数据库
#### UDA 
User-Data-Answer用户数据响应
#### UDR 
User Data Request用户数据（读取）请求
#### UE 
User Equipment用户设备
#### VoLTE 
Voice over LTELTE语音
### ZUF-59-41-051 N7接口 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|说明
---|---
PDU会话|UE通过SMF/UPF和数据网建立的一个连接，用于传输数据报文（Packet Data Unit）。
##### 描述 
####### 特性定义 
N7接口是SMF和PCF之间的接口，用于SMF和PCF之间的消息交互。SMF可以通过N7接口向PCF请求SM策略控制，或上报SM策略控制相关事件。PCF可以通过N7接口向SMF推送最新的SM策略，并订阅SM策略控制相关事件。
####### 背景知识 
N7接口遵循3GPP TS 29.512协议，采用基于HTTP/2 + JSON的服务化接口，SMF + PGW-C通过N7接口调用PCF的Npcf_SMPolicyControl服务。 
##### 应用场景 
N7接口用于SMF向PCF请求PDU会话策略控制，具体应用场景参见“ZUF-59-53-052 PDU会话策略控制
”。
PDU会话策略控制的主要应用场景包括： 
运营商期望提供多种类型的套餐满足不同用户需求。不同类型的套餐可以提供不同的带宽，包含不同的用量门限，超过用量门限要对用户限速或禁止上网。有的套餐是通用套餐，适用于任何流量；有的套餐是定向套餐，只能访问特定的业务。有的套餐适用于任何区域，有的套餐只能在非漫游或漫游适用。运营商可以在PCF上按每个套餐的具体策略要求来配置策略规则，在UDR中存放每个用户的策略签约信息（其中包含套餐签约信息）。 
运营商期望当用户使用特定业务时，能对该业务提供QoS保障。例如，当用户使用VoNR时，能够获得较好的通话质量。为此，IMS中的P-CSCF充当AF。在用户发起VoNR通话时，将VoNR媒体流信息和QoS要求发送给PCF，触发PCF构造PCC规则下发给SMF。SMF收到PCC规则后，通知UPF为VoNR媒体流建立专门的QoS Flow，为VoNR媒体流传输提供保障带宽和较高的转发优先级。 
运营商期望对用户实施动态的计费控制。例如，对于后付费用户，在非漫游时实施离线计费，在漫游时实施在线计费。 
##### 客户收益 
受益方|受益描述
---|---
运营商|PCF通过N7接口对SMF的PDU会话实施动态的、差异化的策略控制，能够使运营商更有效的利用无线网络资源满足不同用户或不同业务需求。
用户|网络资源被合理分配，不会因为少量用户过度占用网络资源而影响大多数用户的上网体验。使用增值业务（如VoNR）时能获得QoS保障。
##### 实现原理 
###### 系统架构 
本特性涉及的系统架构如[图1](1569726695302.html#z284dcd763e8144b1a94a5f0c8396e330__3c08ee4b-a835-4f20-90cc-570e44bf2dfe)所示。RCP作为PCF，N7接口为SMF和RCP之间的接口。
图1  系统架构
[]images/5GC%E7%89%B9%E6%80%A7-%E6%9E%B6%E6%9E%84%E5%9B%BE-PCF.png)
###### 涉及的网元 
网元|描述
---|---
RCP|向SMF提供SM策略，并订阅相关事件。
SMF|执行PCF提供的SM策略，向PCF上报相关事件。
###### 协议栈 
SMF和PCF间的N7接口协议栈如下图所示。 
图2  N7接口协议栈
[]images/1625195103678.png)
 说明： 
协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。
###### 消息描述 
SMF和PCF通过服务操作的调用，实现消息交互。PCF在N7接口提供的服务操作如下：
NF|服务|操作|操作语义|说明
---|---|---|---|---
PCF|Npcf_SMPolicyControl|Create|Request/Response|SMF为新建立的PDU会话向PCF请求建立SM策略关联，PCF在响应中下发SM策略，并订阅SM策略控制相关事件。
Update|PCF|Npcf_SMPolicyControl|Request/Response|SMF向PCF上报SM策略控制相关事件，PCF在响应中可能更新SM策略及订阅的事件列表。
Delete|PCF|Npcf_SMPolicyControl|Request/Response|SMF在PDU会话释放时向PCF请求删除SM策略关联。
UpdateNotify|PCF|Npcf_SMPolicyControl|Subscribe/Notify|PCF因为内部或外部事件触发，主动向SMF更新SM策略。SM策略更新通知操作不需要显式的订阅操作，在SMF调用Create操作请求PCF建立SM策略关联时，PCF就认为SMF订阅了SM策略更新通知。
##### 其他内容 
N7接口的其他内容参见“ZUF-59-53-052 PDU会话策略控制
”。
#### 特性配置 
#### 特性配置 
N7接口的特性配置参见“ZUF-59-53-052 PDU会话策略控制
”。
### 缩略语 
### 缩略语 
#### AF 
Application Function应用功能
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCC 
Policy and Charging Control计费和策略控制
#### PCF 
Policy Control Function策略控制功能
#### PDU 
Packet Data Unit分组数据单元
#### RCP 
Resource Control Platform资源控制平台
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### TLS 
Transport Layer Security传输层安全
#### UE 
User Equipment用户设备
#### UPF 
User Plane Function用户平面功能
#### VoNR 
Voice over New Radio新空口承载语音
### ZUF-59-51-004 Diameter Sy接口 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
策略计数器编号（Policy-Counter-Identifier，简称PCID）|不同PCID代表不同的策略计数器，RCP和OCS要约定每个策略计数器的PCID，例如PCID=1表示套餐1累计流量，PCID=2表示套餐2累计流量。OCS维护每个策略计数器的状态，例如当套餐1累计流量超过该套餐限速门限时，将PCID=1的状态设置为超限状态。RCP从OCS获取各策略计数器状态，根据策略计数器状态实施策略控制。
策略计数器状态（Policy-Counter-Status，简称PCS）|每个PCID的PCS可以有多个取值，例如PCS=1表示相关PCID对应的累计项未超相应门限的50%，PCS=2表示超50%但未超80%，PCS=3表示超100%。不同PCID的PCS可以有不同取值和不同含义，RCP和OCS要约定每个PCID的每个PCS取值含义。
##### 描述 
####### 特性定义 
Sy接口位于OCS（Online Charging System，在线计费系统）与RCP之间，是基于Diameter协议的接口，用于RCP从OCS获取策略计数器状态，基于策略计数器状态实施策略控制。 
####### 背景知识 
在未引入Sy接口前，PCEF分别向OCS和RCP上报用量。OCS累计用量进行配额管理（例如套餐配额耗尽后阻断业务或调整资费），RCP累计用量进行策略控制（例如用量超门限后限速）。如果OCS和RCP间因网络故障等原因导致用量累计不一致，则OCS配额管理和RCP策略控制将会不匹配，可能影响用户体验。
##### 应用场景 
本特性用于RCP基于用户消费信息（即OCS提供的各策略计数器状态）动态调整策略控制的场景，例如： 
用户本地套餐在一个账期内的流量达到套餐配额后需要限速。 
用户的漫游套餐达到用量上限后需要重定向到门户网站购买新的漫游套餐。 
用户的套餐累计流量达到上限的50%、80%、100%时需要发送SMS通知用户。 
用户漫游时，如果没有签漫游套餐，而是采用PayAsYouGo的消费模式（即用多少付多少，实时扣费），当其日流量消费达到50美元，或其账户余额不足10美元时，需要通过重定向提醒用户购买漫游套餐或充值。 
##### 客户收益 
受益方|受益描述
---|---
运营商|使PCRF的策略控制和OCS的配额管理保持一致。 达到消费门限时及时通知用户，防止用户欠费。 达到消费门限时对用户限速或将用户重定向到充值页面购买新套餐，实现公平用量策略，增加运营商收益。
终端用户|用户签约业务关联的配额累计唯一，提升用户体验。 及时收到消费门限提醒，防止欠费。

##### 实现原理 

###### 系统架构 
Sy接口的系统架构如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new1dccd00e031745f4b5b4310a90d06802__0d1a1c94-9b77-4878-be56-6158308b8872)所示。Sy接口主要用于RCP对Gx接口会话向OCS获取PCS信息，以便RCP基于PCS信息对Gx接口会话实施策略控制。
图1  系统架构
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
对于N7接口会话，RCP一般使用N28接口向CHF获取PCS信息。如果N7接口会话启用时OCS还未改造为CHF，RCP也可以对N7接口会话使用Sy接口向OCS获取PCS信息。
在OCS改造为CHF后，Sy接口将被N28接口替换。 
###### 涉及的网元 
网元|说明
---|---
RCP|作为EPC的PCRF，通过Sy接口向OCS获取PCS信息，基于PCS信息实施策略控制。作为5GC或4/5G融合5GC的PCF，在OCS未改造为CHF前，通过Sy接口向OCS获取PCS信息，基于PCS信息实施策略控制。在OCS改造为CHF后，通过N28接口向CHF获取PCS信息。
SPR|存放RCP策略控制所需的用户签约，这些签约可以被RCP用于判断是否要建立Sy/N28会话访问OCS/CHF，以及在Sy/N28会话中向OCS/CHF请求哪些PCID的PCS信息。
BOSS|BOSS是综合业务运营和管理平台，向SPR/OCS/CHF下发用户签约。
OCS|EPC中的在线计费系统，实时统计用户各套餐业务用量，向RCP提供PCS信息。
CHF|5GC中的计费功能，实时统计用户各套餐业务用量，向RCP提供PCS信息。
SMF/PGW-C/PCEF|SMF是5GC或4/5G融合5GC的会话管理功能，通过N7接口向PCF请求策略控制，通过N40/Sy接口向CHF/OCS获取用量配额并上报累计用量。PGW-C是EPC的会话管理功能，其中包含PCEF（Policy and Charging Enforement Function，策略和计费执行功能），通过Gx接口向PCRF请求策略控制，通过Sy接口向OCS获取用量配额并上报累计用量。
UPF/PGW-U|UPF是5GC或4/5G融合5GC的用户面功能。PGW-U是EPC的用户面功能。PGW-U也可以和PGW-C合一为PGW。UPF/PGW-U转发用户数据报文，同时执行SMF/PGW-C/PCEF下发的策略。
###### 协议栈 
图2  协议栈
[]images/%E5%8D%8F%E8%AE%AE%E6%A0%88.png)
RCP与OCS之间采用Sy接口，包含的消息如下： 
SLR（Spending-Limit-Request）：该消息由RCP发送给OCS，通过该消息RCP可以请求建立或更新Sy会话，向OCS获取用户的配额状态。 
SLA（Spending-Limit-Answer）：该消息由OCS发送给RCP，是SLR的应答消息。 
SNR（Spending-Status-Notification-Request）：该消息由OCS发送给RCP，通过该消息OCS将发生变化的配额状态发送给RCP。 
SNA（Spending-Status-Notification-Answer）：该消息由RCP发送给OCS，是SNR的应答消息。 
STR（Session-Termination-Request）：该消息由RCP发送给OCS，通过该消息RCP可以请求OCS终止Sy会话。 
STA（Session-Termination-Answer）：该消息由OCS发送给RCP，是STR的应答消息。 
###### 业务流程 
######## 描述 
现网中，RCP的Sy接口交互绝大部分是Gx接口会话触发的，所以下面的业务流程以Gx接口会话触发的Sy接口交互做示例阐述。对于N7接口会话触发的Sy接口交互，流程是类似的，只需把PCEF换成SMF，把Gx接口的CCR-I/CCA-I、CCR-U/CCA-U、CCR-T/CCA-T、RAR/RAA交互替换为N7接口的Create请求/响应、Update请求/响应、Delete请求/响应、UpdateNotify请求/响应。
######## PCRF向OCS请求订阅用户消费提醒 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B1.png)用户在本地接入，PCEF通过CCR-I携带Subscription-Id等信息发起Gx会话建立。 
RCP在Sp接口通过UDR消息携带User-Name等信息查询本用户的签约情况。
SPR在Sp接口通过UDA携带User-Profile-Info等信息返回该用户的签约信息。
RCP在Sp'接口通过UDR消息查询本用户的累计用量等信息。 
SPR在Sp'接口通过UDA返回该用户的累计用量等信息。 
RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR携带Policy-Counter-Identifier等信息向OCS发起会话建立请求。 
OCS通过SLA携带Policy-Counter-Status-Report等信息返回相关PCS状态，Sy会话建立。 
RCP根据接入信息、用户签约信息及用量等信息进行决策，向PCEF下发规则。 
######## OCS向PCRF通知用户的消费状态 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B2.png)OCS发现PCID的状态有改变，通过SNR携带PCS信息，告知RCP PCID的状态已变。
RCP向OCS回复SNA。
RCP根据接入信息、用户签约信息、用量信息、PCS状态等信息进行决策，通过RAR向PCEF下发新的规则。 
PCEF向PCRF回复RAA，并执行最新规则。 
######## PCRF向OCS请求取消订阅用户消费状态 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B3.png)PCEF通过CCR-T携带Subscription-Id等信息发起Gx会话释放。 
RCP向PCEF返回用户离线响应CCA-T。 
RCP检测到用户所有承载会话（Gx会话及N7会话）都已下线，向RCP发送STR请求到OCS，请求取消订阅用户消费状态并释放Sy会话。 
OCS向RCP返回取消订阅响应STA。 
如果RCP还有累计用量未同步给SPR，RCP通过Sp'接口UDR消息上报给SPR。 
SPR回复Sp'接口UDA消息。 
RCP向SPR发送Sp接口UDR用户离线消息。 
SPR回复Sp接口UDA消息。 
###### 本网元实现 
######## RCP向OCS发起策略计费会话建立 
策略计费会话触发时机RCP只会为一个用户建立一个策略计费会话。当用户上线RCP获取到签约信息后，可以通过签约的套餐、扩展属性、计费类型等在“用户级策略计数器标识配置”和“套餐级策略计数器标识配置”中获取到当前用户需要订阅的PCID列表。PCID可分为用户级PCID和套餐级PCID，这两种类型的定义主要取决于OCS与RCP规划用量配额是用户级还是套餐级：OCS与RCP规划关注用户级用量配额，则定义用户级PCID。OCS与RCP规划关注套餐级用量配额，则定义套餐级PCID。套餐级PCID可以指定生成，也可以根据套餐实例号生成 。当RCP决策出需要订阅的PCID列表时，则会去判断是否需要通过Sy接口建立OCS会话。 
RCP选择OCS或CHF获取策略计费信息RCP支持为4/5G用户通过OCS或CHF获取策略计费信息。RCP主要根据开关“1255 Sy/N28选择方式”、用户签约信息来判断，具体选择场景参见下表。1255开关值用户签约携带networkType未携带networkType指示为5G用户指示为4G用户0N28SySy1N28SyN282Sy3N284优选N28，次选Sy5优选Sy，次选N28当符合上述表格里选择Sy接口的条件时，例如：1255设置为0，当用户签约携带networkType指示为4G用户时，RCP就会向OCS发起策略计费会话的建立。 说明：开关值4或5时，优选次选的含义是未获取到优选对应网元的局向地址信息时，则去获取次选对应网元的局向地址信息。1255开关默认值为5，如果不希望启用Sy接口，必须删除OCS号码段分析配置。 
######## OCS地址信息的选择 
为了保证在某个特定号段的IMSI或MSISDN可以找到正确的OCS，涉及到邻接主机配置、号码分析配置、号段分析配置： 
[]images/%E6%9C%AC%E7%BD%91%E5%85%83%E5%AE%9E%E7%8E%B0.png)根据用户的IMSI或MSISDN，进行号码段分析（OCS接入局IMSI/MSISDN分析），得出号码段分析结果。 
上一步的分析结果，即为“OCS接入局配置编号”，根据该编号，即可得到“邻接主机编号”。 
根据“邻接主机编号”，即得到了对应的OCS信息。 
######## 策略计费会话的更新 
RCP会在以下几种场景触发策略计费会话的更新流程：由于套餐变更等原因，RCP对于当前用户需要订阅的PCID列表存在新增的PCID时，则会触发策略计费会话的更新流程，携带完整的PCID列表订阅信息。跨账期后RCP主动发起PCS查询：针对部分和RCP对接的OCS，不能在跨账期时主动推送新的PCS（如果有变化）到RCP。此种场景下，可以在“限速策略计数器状态配置”中配置PCID+PCS，当RCP主动查询到当前用户的PCID+PCS在配置中存在时，则会在用户级账期发生切换后的N分钟（全局开关1072的值）后，主动发起策略计费会话更新流程，查询所有需要订阅的PCID的PCS。 
OCS会在以下场景触发策略计费会话的状态更新通知流程：当OCS检测到RCP订阅的某个PCID对应的状态发生变化时，则会触发给RCP的通知流程，携带状态发生变化的PCID及其最新的状态信息。 
######## 策略计费会话的释放 
RCP会在以下几种场景触发策略计费会话的释放流程： 
用户的最后一个承载会话下线时，RCP会触发当前用户的策略计费会话释放流程。 
由于套餐变更等原因，对于当前用户不再需要订阅任何PCID时，RCP会触发当前用户的策略计费会话释放流程。 
######## 未来时间点的PCS 
OCS返回PCID的PCS时，可能会携带未来时间点的PCS给RCP（通过Pending_Policy_Count_Info）。RCP支持每PCID最多保存两个PCS状态切换的时间点，并在该时间点之后，触发用户进行重决策，RCP基于最新的PCS状态决策出用户新的策略。 
######## Sy接口相关的业务键 
RCP基于OCS返回的策略计数器的状态进行决策，可使用如下三个业务健作为决策的条件： 
自定义变量字符型策略计数器状态 (Sy) / String Policy Counter Status (Sy)：指定PCID对应的字符型PCS数值型策略计数器状态 (Sy) / Numeric Policy Counter Status (Sy)：指定PCID对应的数值型PCS 
用户信息类用户所有策略计数器状态 (Sy) / User Owned  Policy Counter Status (Sy)：用户当前的有效PCS中是否含有指定的PCS 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 29.219|Spending Limit Reporting over Sy reference point
##### 特性能力 
名称|指标
---|---
每个套餐最多配置的PCID个数|8
每个用户的策略计费会话最多支持的PCID个数|64
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.23.10|首次发布。
####### License要求 
该特性需要申请了License许可后，运营商才能获得该特性的服务。 
该特性对应License文件中的项目为“Sy接口”，此项目显示为ON，表示RCP支持Sy接口特性。 
####### 对其他网元的要求 
Sy接口特性需要OCS配合完成。其中，OCS向PCF提供策略计数器状态，PCF根据实时的策略计数器状态，对用户的数据业务消费限额进行控制。 

##### O&M相关 

###### 命令 
######## 配置项 
新增命令： 
编号|命令项|命令名称|描述
---|---|---|---
1|OCS接入局配置|ADD OCSACC|增加OCS接入局
SET OCSACC|1|OCS接入局配置|修改OCS接入局
DEL OCSACC|1|OCS接入局配置|删除OCS接入局
SHOW OCSACC|1|OCS接入局配置|查询OCS接入局
2|用户级策略计数器标识配置|ADD USERPCID|新增用户级策略计数器标识
SET USERPCID|2|用户级策略计数器标识配置|修改用户级策略计数器标识
DEL USERPCID|2|用户级策略计数器标识配置|删除用户级策略计数器标识
SHOW USERPCID|2|用户级策略计数器标识配置|查询用户级策略计数器标识
3|套餐级策略计数器标识配置|ADD PCID|新增套餐级策略计数器标识
SET PCID|3|套餐级策略计数器标识配置|修改套餐级策略计数器标识
DEL PCID|3|套餐级策略计数器标识配置|删除套餐级策略计数器标识
SHOW PCID|3|套餐级策略计数器标识配置|查询套餐级策略计数器标识
4|限速策略计数器状态配置|ADD SPDPCS|增加限速策略计数器状态
DEL SPDPCS|4|限速策略计数器状态配置|删除限速策略计数器状态
SHOW SPDPCS|4|限速策略计数器状态配置|查询限速策略计数器状态
修改命令： 
编号|命令项|命令名称|描述
---|---|---|---
1|邻接主机配置|ADD ADJHOST|“邻接主机类型”新增枚举值：OCS(OCS)
2|号码段分析配置|ADD NUMANA|“号码段分析类型”新增枚举值：OCS接入局IMSI分析(OCSACC_IMSI)OCS接入局MSISDN分析(OCSACC_MSISDN)
新增策略变量（GUI配置）： 
所属类别|新增项名称/修改项名称|描述
---|---|---
自定义策略变量|字符型策略计数器状态|表示OCS与PCRF之间约定的用户级或套餐级的策略计数器状态，若约定为字符型策略计数器状态，则使用本策略变量，如PCS为“Usage of PKG1 exceeds 80%”。
自定义策略变量|数字型策略计数器状态|表示OCS与PCRF之间约定的用户级或套餐级的策略计数器状态，若约定为数字型策略计数器状态，则使用本策略变量，如PCS取值为8，表示用户配额消耗超过80%。
######## 定时器 
新增定时器： 
定时器编号|默认值（毫秒）|描述
---|---|---
2070|3000|PCRF发消息到OCS后，等待OCS回响应的时长。
######## 全局变量 
开关名称|描述|使用方法
---|---|---
1072 跨月清零时间点延迟发送SLR的分钟数|开关取值为0~720，单位分钟。默认值为30|通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1072,END=1072,EXTFLAG="BASIC"，查看“1072 跨月清零时间点延迟发送SLR的分钟数”的取值。通过命令SET SYS GLOBPARA:IDX=1072,CURVAL="30",EXTFLAG="BASIC"，修改“1072 跨月清零时间点延迟发送SLR的分钟数”的取值。
1073 是否支持无PCID触发Sy接口消息的开关|开关取值为1~2，默认值为2，含义如下：1：表示发送SLR消息，消息中无PCID2：表示发送SLR消息，消息中携带PCID|通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1073,END=1073,EXTFLAG="BASIC"，查看“1073 是否支持无PCID触发Sy接口消息的开关”的取值。通过命令SET SYS GLOBPARA:IDX=1073,CURVAL="2",EXTFLAG="BASIC"，修改“1073 是否支持无PCID触发Sy接口消息的开关”的取值。
1255 Sy/N28选择方式|开关取值为0~5，默认值为5，含义如下：0：按networkTYPE指示4G或5G用户进行选择，无networkTYPE选Sy1：按networkTYPE指示4G或5G用户进行选择，无networkTYPE选N282：全选Sy3：全选N284：优选N28，次选Sy5：优选Sy，次选N28|通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1255,END=1255,EXTFLAG="BASIC"，查看“1255 Sy/N28选择方式”的取值。通过命令SET SYS GLOBPARA:IDX=1255,CURVAL="5",EXTFLAG="BASIC"，修改“1255 Sy/N28选择方式”的取值。
######## 动态管理 
通过命令[SHOW_SY_SESS](../../Npcf_SMPolicyControl\zh-cn\mml\1137901.html)、[REL_SY_SESS](../../Npcf_SMPolicyControl\zh-cn\mml\1137902.html)查询或释放在线的用户Sy会话信息：
查询在线用户CHF会话信息的命令是SHOW_SY_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460060601020000" 
删除在线用户CHF会话信息的命令是REL_SY_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460060601020000" 
###### 性能统计 
######## 性能计数器 
测量类型|计数器名称
---|---
Diameter协议统计|C000160031 Sy发送SLR的总数C000160032 Sy接收SLA的总数C000160033 Sy发送STR的总数C000160034 Sy接收STA的总数C000160035 Sy接收SNR的总数C000160036 Sy发送SNA的总数C000160057 Sy代理转发SNR的总数C000160058 Sy代理转发SNA的总数
Diameter按主机名统计|C000170129 Sy发送SLR的总数C000170130 Sy接收SLA的总数C000170131 Sy接收失败SLA的总数C000170132 Sy发送STR的总数C000170133 Sy接收STA的总数C000170134 Sy接收失败STA的总数C000170135 Sy接收SNR的总数C000170136 Sy发送SNA的总数C000170137 Sy发送失败SNA的总数C000170214 Sy接收失败SLA的总数（5002 未知会话标识）C000170215 Sy接收失败SLA的总数（5004 非法的属性值对）C000170216 Sy发送失败SNA的总数（5001 未知用户）C000170217 Sy发送失败SNA的总数（5002 未知会话标识）C000170218 Sy发送失败SNA的总数（5003 授权拒绝）C000170219 Sy发送失败SNA的总数（5004 非法的属性值对）C000170220 Sy发送失败SNA的总数（5005 缺失属性值对）C000170221 Sy接收失败STA的总数（5002 未知会话标识）
RCP业务按主机名统计|C000180140 Sy发送SLR的总数C000180141Sy接收SLA的总数C000180142 Sy接收失败SLA的总数C000180143 Sy发送SLR-I的总数C000180144 Sy接收SLA-I的总数C000180145 Sy接收失败SLA-I的总数C000180146 Sy发送SLR-U的总数C000180147 Sy接收SLA-U的总数C000180148 Sy接收失败SLA-U的总数C000180149 Sy发送STR的总数C000180150 Sy接收STA的总数C000180151 Sy接收失败STA的总数C000180152 Sy接收SNR的总数C000180153 Sy发送SNA的总数C000180154 Sy发送失败SNA的总数C000180201 Sy接收失败SLA的总数（5002 未知会话标识）C000180202 Sy接收失败SLA的总数（5004 非法的属性值对）C000180203 Sy接收失败SLA-I的总数（5002未知会话标识）C000180204 Sy接收失败SLA-I的总数（5004 非法的属性值对）C000180205 Sy接收失败SLA-U的总数（5002未知会话标识）C000180206 Sy接收失败SLA-U的总数（5004 非法的属性值对）C000180207 Sy发送失败SNA的总数（5001未知用户）C000180208 Sy发送失败SNA的总数（5002 未知会话标识）C000180209 Sy发送失败SNA的总数（5003授权拒绝）C000180210 Sy发送失败SNA的总数（5004 非法的属性值对）C000180211Sy发送失败SNA的总数（5005 缺失属性值对）C000180212 Sy接收失败STA的总数（5002 未知会话标识）C000180289 Sy发送失败SNA的总数（4002 资源不足）C000180297 Sy发送失败SNA的总数（3006重定向）C000180352 Sy接收SLA消息超时数C000180353 Sy接收SLAI消息超时数C000180354 Sy接收SLAU消息超时数C000180355 Sy接收STA消息超时数C000180368Sy发送释放STR消息总数（不兼容）
Diameter按链路号统计|C000190127 Sy发送SLR的总数C000190128 Sy接收SLA的总数C000190129 Sy接收失败SLA的总数C000190130 Sy发送STR的总数C000190131 Sy接收STA的总数C000190132 Sy接收失败STA的总数C000190133 Sy接收SNR的总数C000190134 Sy发送SNA的总数C000190135 Sy发送失败SNA的总数C000190214 Sy接收失败SLA的总数（5002 未知会话标识）C000190215 Sy接收失败SLA的总数（5004 非法的属性值对）C000190216 Sy发送失败SNA的总数（5001 未知用户）C000190217 Sy发送失败SNA的总数（5002 未知会话标识）C000190218 Sy发送失败SNA的总数（5003 授权拒绝）C000190219 Sy发送失败SNA的总数（5004 非法的属性值对）C000190220 Sy发送失败SNA的总数（5005 缺失属性值对）C000190221 Sy接收失败STA的总数（5002 未知会话标识）
RCP系统资源统计|C000200016 在线Sy会话数C000200017 在线Sy会话数均值C000200018 在线Sy会话数峰值
RCP容灾按局向号统计|C520110012 Sy发送3006重定向SNA的总数C520110051 Sy发送3006本地处理它局SNA的总数C520110074 Sy代理转发SNR的总数C520110075 Sy代理转发SNA的总数C520110124 Sy本地处理它局SNR的总数
######## 性能指标 
测量类型|性能指标名称
---|---
Diameter协议统计|（000169005）Sy每秒事务处理量（TPS）
Diameter按主机名统计|（000179017）Diameter Sy发起成功率（%）（000179018）Diameter Sy结束成功率（%）
RCP业务按主机名统计|（000189017）Sy发起成功率（%）（000189018）Sy结束成功率（%）
Diameter按链路号统计|（000199017）Sy发起成功率（%）（000199018）Sy结束成功率（%）
RCP系统资源统计|（000209008）Sy会话容量占用率峰值（%）（000209036）Sy会话比例均值（%）（000209037）Sy会话比例峰值（%）
###### 告警和通知 
该特性不涉及告警消息的变化。 
###### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置特性 

###### 配置说明 
通过该特性的配置，能根据OCS返回的各种PCID的PCS状态，实现不同的策略控制。 
限速策略，当OCS返回PCS状态达到一定配额限速时，PCF决策下发限速策略。 
短信/邮件通知，当OCS返回PCS状态表示用户消费额度达到一定量（如80%）时，PCF发送短信/邮件通知用户当前的消费情况。 
###### 配置前提 
PCF与OCS需要协商好互联数据，共同完成Sy接口IP协议栈的配置。 
完成PCF与短信中心的链路配置。 
###### 配置过程 
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)配置过程包含如下几个步骤： 
邻接主机配置：使用[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html)命令配置OCS邻接主机。
OCS接入局配置：使用[ADD OCSACC](../../Npcf_PolicyManagement\zh-CN\mml\1787545.html)命令配置OCS接入局。
号码段分析配置：使用[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令配置号码段与OCS接入局间的对应关系。
套餐配置：若PCID与套餐相关时，则使用[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令配置对应的套餐。
PCID配置：使用[ADD PCID](../../Npcf_PolicyManagement\zh-CN\mml\1787549.html)命令配置策略计数器，用于PCRF向OCS查询该PCID的配额状态。
PCS自定义变量配置：在EM的RCP策略管理窗口中，选择菜单基本数据配置→自定义变量
，配置PCS自定义状态变量。
条件配置：在EM的RCP策略管理窗口中，选择菜单基本数据配置→自定义变量
，配置PCS自定义状态变量条件。
动作参数配置：在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置动作参数，包括预下发业务参数集、N7会话参数集、QoS参数集、TC参数集和N7PCC规则参数集。
规则配置：在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置规则，包括业务预下发控制策略、N7会话控制策略、N7业务控制策略和通知策略。
场景配置：在EM的RCP策略管理窗口中，选择菜单策略元素配置→场景
，配置场景，包括场景入口配置和控制策略配置。
###### 配置实例1 - 基础套餐达量限速实例配置 
######## 场景说明 
套餐1用量小于80％时，对套餐1业务带宽保障在500M bps。 
套餐1用量超过80％时，对套餐1业务进行限速至300M bps。 
套餐1用量超过80％时，短信通知用户。 
套餐1用量超过100％时，对套餐1的HTTP业务进行地址重定向。 
套餐1用量超过100％时，短信通知用户。 
######## 数据规划 
网元|主机名|域名|IP地址|端口
---|---|---|---|---
PCF|rcp.zte.com.cn|zte.com.cn|10.6.108.1|3990
OCS|ocs.zte.com.cn|zte.com.cn|10.6.109.1|3990
参数名称|取值
---|---
SCTP标识|10
名称|to ocs
模块号|1
应用类型|CLIENT
本端IP|10.6.108.1
本端端口|3990
对端IP|10.6.109.1
对端端口|3990
参数名称|取值
---|---
链路号|10
本端主机名称|rcp.zte.com.cn
本端域名|zte.com.cn
对端主机名称|ocs.zte.com.cn
对端域名|zte.com.cn
承载链路|10
承载协议类型|SCTP
链路名称|to ocs
参数名称|取值
---|---
路由编号|10
本地动作|RELAY
主用链路|10
支持应用|Sy
目的URI|ocs.zte.com.cn
类别|参数名称|取值
---|---|---
邻接主机|邻接主机编号|10
邻接主机类型|邻接主机|OCS（OCS）
OCS接入局|OCS接入局配置编号|20
邻接主机编号|OCS接入局|10
号码段分析|号码段分析类型|OCS接入局IMSI分析（OCSACC_IMSI）
起始号码|号码段分析|460020000000000
结束号码|号码段分析|460029999999999
号码段分析结果|号码段分析|20
类别|参数名称|取值
---|---|---
套餐|套餐标识|1
套餐类型|套餐|用户套餐
PCID|套餐标识|1
策略计数器标识生成方式|PCID|指定
策略计数器标识1|PCID|PKG1
PCS|取值|取值为1，表示用量未达80%，正常保证业务带宽。取值为2，表示用量已达80%，需要限制业务带宽。取值为3，表示用量已达100%，需要HTTP业务重定向，重定向到充值网站，充值后方可使用。
策略类型|规则名称|动作
---|---|---
业务预下发控制策略|Sy_PCS1_SvcPre|预下发HTTP业务。
会话控制策略|Sy_PCS1_Normal_speed|会话级带宽限制，最大带宽限制为500Mbps。
Sy_PCS1_limit_speed>=80%|会话控制策略|会话级带宽限制，最大带宽限制为300Mbps。
业务控制策略|Sy_PCS1_exhaust_redirect|HTTP业务重定向，重定向到http://confirm.mobile.com。
通知策略|Sy_PCS1_sms>=80%|发送短信提醒用户消费配额已达80%。
Sy_PCS1_sms>=100%|通知策略|发送短信提醒用户消费配额已耗尽。
######## 配置步骤 
配置基础链路
配置RCP与短信中心之间的链路，参见“ZUF-59-53-003 短信通知
”。
配置RCP与OCS之间的SCTP链路。 
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=1,NAME="to OCS",LOCPORT=3900,REMPORT=3900,LOCADDR1="10.6.108.1",REMADDR1="10.6.109.1";
 说明： 
要求对端OCS同步配置SCTP链路和Diameter链路。 
配置基础信息
配置RCPF的Diameter主机名和域名。 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=5,HOSTNAME="rcp.hatt.zte.com.cn",REALM="hatt.zte.com.cn",TENANTNAME="PCF",PUBTENANTNAME="PCF"
配置OCS邻接主机。 
[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html):ADJHOSTID=10,HOSTNAME="ocs.zte.com.cn",REALM="zte.com.cn",HOSTTYPE="OCS";
配置Diameter链路。 
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=10,LOCALHOSTNAME="rcp.zte.com.cn",LOCALREALM="zte.com.cn",DSTHOSTNAME="ocs.zte.com.cn",DSTREALM="zte.com.cn",CONNID=10,PROTOCOL="SCTP",NAME="to ocs";
配置路由。 
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=10,LOCALPROCESSID="RELAY",MASTERLINKNO=10,ROUTEAPPID="Sy",DESTURI="ocs.hatt.zte.com.cn";
配置OCS接入局。 
[ADD OCSACC](../../Npcf_PolicyManagement\zh-CN\mml\1787545.html):ID=20,ADJHOSTID=10;
配置号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=30,ANATYPE="OCSACC_IMSI",NUMBEGIN="460020000000000",NUMEND="460029999999999",RESULTID=20;
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置套餐业务。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="1",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
配置套餐级策略计数器。 
[ADD PCID](../../Npcf_PolicyManagement\zh-CN\mml\1787549.html):ID=1,PKGID="1",PCID1="PKG1";
配置规则基础数据
在EM的RCP策略管理窗口中，选择菜单基本数据配置→自定义变量
，配置自定义变量。
自定义变量名称|策略变量|策略变量属性
---|---|---
Sy_PCS1|策略变量|数值型策略计数器状态（Sy）
策略计数器标识生成方式|Sy_PCS1|指定
套餐标识|Sy_PCS1|/
策略计数器标识|Sy_PCS1|PKG1
日志开关|Sy_PCS1|关闭
在EM的RCP策略管理窗口中，选择基本数据配置→通知
，配置通知数据。
通知名称|参数名称|取值
---|---|---
Sy_PCS1_sms>=80%|通知语言|中文（中华人民共和国）
通知内容|Sy_PCS1_sms>=80%|尊敬的用户您好，您购买的套餐使用量百分比已超过80%。
Sy_PCS1_sms>=100%|通知语言|中文（中华人民共和国）
通知内容|Sy_PCS1_sms>=100%|尊敬的用户您好，您购买的套餐使用量已耗尽，请尽快充值。
配置条件
在EM的RCP策略管理窗口中，选择菜单策略元素配置→条件
，配置策略计数器标识状态条件。
条件名称|参数名称|取值
---|---|---
Sy_PCS1_Normal_speed|选择策略变量|其他
策略变量类别|Sy_PCS1_Normal_speed|自定义策略变量
策略变量|Sy_PCS1_Normal_speed|Sy_PCS1
操作符|Sy_PCS1_Normal_speed|=
值|Sy_PCS1_Normal_speed|1
Sy_PCS1 >=80%|选择策略变量|其他
策略变量类别|Sy_PCS1 >=80%|自定义策略变量
策略变量|Sy_PCS1 >=80%|Sy_PCS1
操作符|Sy_PCS1 >=80%|=
值|Sy_PCS1 >=80%|2
Sy_PCS1 >=100%|选择策略变量|其他
策略变量类别|Sy_PCS1 >=100%|自定义策略变量
策略变量|Sy_PCS1 >=100%|Sy_PCS1
操作符|Sy_PCS1 >=100%|=
值|Sy_PCS1 >=100%|3
在EM的RCP策略管理窗口中，选择菜单策略元素配置→条件
，配置应用标识条件。
条件名称|参数名称|取值
---|---|---
Appid=1001|选择策略变量|其他
策略变量类别|Appid=1001|会话信息类
策略变量|Appid=1001|Gx应用标识
操作符|Appid=1001|=
参考值|Appid=1001|1001
配置动作参数
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置通知策略动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS1_Act_sms>=80%|参数类型|通知参数集
全局通知编号|Sy_PCS1_Act_sms>=80%|1
通知类型|Sy_PCS1_Act_sms>=80%|SMS/EMAIL&SOAP
私人短信通知内容|Sy_PCS1_Act_sms>=80%|Sy_PCS1_sms>=80%
Sy_PCS1_Act_sms>=100%|参数类型|通知参数集
全局通知编号|Sy_PCS1_Act_sms>=100%|2
通知类型|Sy_PCS1_Act_sms>=100%|SMS/EMAIL&SOAP
私人短信通知内容|Sy_PCS1_Act_sms>=100%|Sy_PCS1_sms>=100%
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置预下发业务动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS1_Act_SvcPre|参数类型|预下发业务参数集
应用标识|Sy_PCS1_Act_SvcPre|1001
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置会话控制策略动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS1_Act_Normal_speed|参数类型|N7会话参数集
会话规则名称|Sy_PCS1_Act_Normal_speed|N7_SESSRULE_NORMAL_SPEED
会话AMBR上行速率（kbps）|Sy_PCS1_Act_Normal_speed|500000
会话AMBR下行速率（kbps）|Sy_PCS1_Act_Normal_speed|500000
Sy_PCS1_Act_limit_speed>=80%|参数类型|N7会话参数集
会话规则名称|Sy_PCS1_Act_limit_speed>=80%|N7_SESSRULE_LIMIT_SPEED
会话AMBR上行速率（kbps）|Sy_PCS1_Act_limit_speed>=80%|300000
会话AMBR下行速率（kbps）|Sy_PCS1_Act_limit_speed>=80%|300000
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置TC动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy1_exhaust_TC|流量控制策略ID|1
重定向能力|Sy1_exhaust_TC|是
重定向地址类型|Sy1_exhaust_TC|URL
重定向地址|Sy1_exhaust_TC|http://confirm.mobile.com
重定向类型|Sy1_exhaust_TC|一次重定向
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置N7 PCC规则动作参数。
 说明： 
仅列举本特性常用的动作参数，其他参数可根据实际情况填写。 
动作参数名称|参数名称|取值
---|---|---
Sy_PCS1_Act_exhaust_redirect|参数类型|N7 PCC规则参数集
PCC规则名|Sy_PCS1_Act_exhaust_redirect|Sy1_exhaust_redirect
PCC规则类型（*）|Sy_PCS1_Act_exhaust_redirect|动态规则
优先级|Sy_PCS1_Act_exhaust_redirect|1
流量控制策略ID|Sy_PCS1_Act_exhaust_redirect|Sy1_exhaust_TC
配置规则
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置通知策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS1_sms>=80%|优先级|1
策略类型|Sy_PCS1_sms>=80%|通知策略
动作类型|Sy_PCS1_sms>=80%|立即发送
日志开关|Sy_PCS1_sms>=80%|关闭
条件表达式|Sy_PCS1_sms>=80%|Sy_PCS1 >=80%
动作参数名称|Sy_PCS1_sms>=80%|Sy_PCS1_Act_sms>=80%
Sy_PCS1_sms>=100%|优先级|1
策略类型|Sy_PCS1_sms>=100%|通知策略
动作类型|Sy_PCS1_sms>=100%|立即发送
日志开关|Sy_PCS1_sms>=100%|关闭
条件名称|Sy_PCS1_sms>=100%|Sy_PCS1>=100%
动作参数名称|Sy_PCS1_sms>=100%|Sy_PCS1_Act_sms>=100%
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置业务预下发控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS1_SvcPre|优先级|1
动作类型|Sy_PCS1_SvcPre|业务预下发控制策略
动作类型|Sy_PCS1_SvcPre|参数填充
日志开关|Sy_PCS1_SvcPre|关闭
条件表达式|Sy_PCS1_SvcPre|/
动作参数名称|Sy_PCS1_SvcPre|Sy_PCS1_Act_SvcPre
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置N7会话控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS1_Normal_speed|优先级|1
策略类型|Sy_PCS1_Normal_speed|N7会话控制策略
动作类型|Sy_PCS1_Normal_speed|参数填充
日志开关|Sy_PCS1_Normal_speed|关闭
条件表达式|Sy_PCS1_Normal_speed|Sy_PCS1_Normal_speed
动作参数名称|Sy_PCS1_Normal_speed|Sy_PCS1_Act_Normal_speed
Sy_PCS1_limit_speed>=80%|优先级|1
策略类型|Sy_PCS1_limit_speed>=80%|N7会话控制策略
动作类型|Sy_PCS1_limit_speed>=80%|参数填充
日志开关|Sy_PCS1_limit_speed>=80%|关闭
条件表达式|Sy_PCS1_limit_speed>=80%|Sy_PCS1>=80%
动作参数名称|Sy_PCS1_limit_speed>=80%|Sy_PCS1_Act_limit_speed>=80%
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置N7业务控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS1_exhaust_redirect|优先级|10
策略类型|Sy_PCS1_exhaust_redirect|N7业务控制策略
动作类型|Sy_PCS1_exhaust_redirect|参数填充
日志开关|Sy_PCS1_exhaust_redirect|关闭
条件表达式|Sy_PCS1_exhaust_redirect|Sy_PCS1>=100% & Appid=1001
动作参数名称|Sy_PCS1_exhaust_redirect|Sy_PCS1_Act_exhaust_redirect
配置场景
在EM的RCP策略管理窗口中，选择菜单策略元素配置→场景
，配置场景规则关联。
场景名称|参数名称|取值
---|---|---
Sy_PCS1_Limit_Speed|入口1|入口类型|全部
已选入口|Sy_PCS1_Limit_Speed|入口1|用户套餐
取值|Sy_PCS1_Limit_Speed|入口1|1
策略类型|Sy_PCS1_Limit_Speed|通知策略|Sy_PCS1_sms>=80%
Sy_PCS1_sms>=100%|策略类型|Sy_PCS1_Limit_Speed|通知策略
业务预下发控制策略|策略类型|Sy_PCS1_Limit_Speed|Sy_PCS1_SvcPre
会话控制策略|策略类型|Sy_PCS1_Limit_Speed|Sy_PCS1_Normal_speed
Sy_PCS1_limit_speed>=80%|会话控制策略|策略类型|Sy_PCS1_Limit_Speed
业务控制策略|策略类型|Sy_PCS1_Limit_Speed|Sy_PCS1_exhaust_redirect
###### 配置实例2 - 漫游重定向实例配置 
######## 场景说明 
用户漫游时，如果没有签漫游套餐，而是采用PayAsYouGo的数据消费模式，当其日流量消费达到50美元，或其账户余额不足10美元时，需要通过重定向提醒用户购买漫游套餐或充值。 
######## 数据规划 
网元|主机名|域名|IP地址|端口
---|---|---|---|---
PCF|rcp.zte.com.cn|zte.com.cn|10.6.108.1|3990
OCS|ocs.zte.com.cn|zte.com.cn|10.6.109.1|3990
参数名称|取值
---|---
SCTP标识|10
名称|to ocs
模块号|1
应用类型|CLIENT
本端IP|10.6.108.1
本端端口|3990
对端IP|10.6.109.1
对端端口|3990
参数名称|取值
---|---
链路号|10
本端主机名称|rcp.zte.com.cn
本端域名|zte.com.cn
对端主机名称|ocs.zte.com.cn
对端域名|zte.com.cn
承载链路|10
承载协议类型|SCTP
链路名称|to ocs
参数名称|取值
---|---
路由编号|10
本地动作|RELAY
主用链路|10
支持应用|Sy
目的URI|ocs.zte.com.cn
类别|参数名称|取值
---|---|---
邻接主机|邻接主机编号|10
邻接主机类型|邻接主机|OCS（OCS）
OCS接入局|OCS接入局配置编号|20
邻接主机编号|OCS接入局|10
号码段分析|号码段分析类型|OCS接入局IMSI分析（OCSACC_IMSI）
起始号码|号码段分析|460020000000000
结束号码|号码段分析|460029999999999
号码段分析结果|号码段分析|20
策略数据规划 
类别|参数名称|取值
---|---|---
PCID|PCID类型|用户级
策略计数器标识生成方式|PCID|指定
策略计数器标识1|PCID|10000
PCS|取值|取值为Sy_PCS10000_normal，表示消费卡余额充足，正常保证业务带宽。取值为Sy_PCS10000_exhaust，表示日流量消费达到50美元，或其账户余额不足10美元，需要业务重定向，充值后方可使用。
策略类型|规则名称|动作
---|---|---
业务预下发控制策略|Sy_PCS10000_SvcPre|预下发HTTP业务。
会话控制策略|Sy_PCS10000_Normal_speed|会话级带宽限制，最大带宽限制为500Mbps。
业务控制策略|Sy_PCS10000_exhaust_redirect|HTTP业务重定向，重定向到http://confirm.telcom.com。
通知策略|Sy_PCS10000_sms>=100%|发送短信提醒用户消费配额已耗尽。
######## 配置步骤 
配置基础链路
配置RCP与短信中心之间的链路，参见“ZUF-59-53-003 短信通知
”。
配置RCP与OCS之间的SCTP链路。 
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=1,NAME="to OCS",LOCPORT=3900,REMPORT=3900,LOCADDR1="10.6.108.1",REMADDR1="10.6.109.1";
 说明： 
要求对端OCS同步配置SCTP链路和Diameter链路。 
配置基础信息
配置RCP的Diameter主机名和域名。 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=5,HOSTNAME="rcp.hatt.zte.com.cn",REALM="hatt.zte.com.cn",TENANTNAME="PCF",PUBTENANTNAME="PCF"
配置OCS邻接主机。 
[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html):ADJHOSTID=10,HOSTNAME="ocs.zte.com.cn",REALM="zte.com.cn",HOSTTYPE="OCS";
配置Diameter链路。 
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=10,LOCALHOSTNAME="rcp.zte.com.cn",LOCALREALM="zte.com.cn",DSTHOSTNAME="ocs.zte.com.cn",DSTREALM="zte.com.cn",CONNID=10,PROTOCOL="SCTP",NAME="to
ocs";
配置路由。 
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=10,LOCALPROCESSID="RELAY",MASTERLINKNO=10,ROUTEAPPID="Sy",DESTURI="ocs.hatt.zte.com.cn";
配置OCS接入局。 
[ADD OCSACC](../../Npcf_PolicyManagement\zh-CN\mml\1787545.html):ID=20,ADJHOSTID=10;
配置号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=30,ANATYPE="OCSACC_IMSI",NUMBEGIN="460020000000000",NUMEND="460029999999999",RESULTID=20;
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=10001,APPDESC="10001",SUBSID="10001",SUBSDESC="10001"
,PREPROV="YES";
配置修改承载能力。 
[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html):ADJHOSTGRPID=1,ROAMCOND="IP";
配置GGSN IP接入。 
[ADD SGSNIPACC](../../Npcf_PolicyManagement\zh-CN\mml\1787168.html):ID=1,ADJHOSTGRPID=1,IPADDR="10.6.100.31",MASK="255.255.252.0",ACCATTR="1";
配置漫游属性。 
[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html):ACCATTR="1",ROAMFLAG="YES",ACCTYPE="IP";
配置用户级策略计数器标识。 
[ADD USERPCID](../../Npcf_PolicyManagement\zh-CN\mml\1787606.html):ID=1,PCID1="1",PCID1="2";
配置规则基础数据
在EM的RCP策略管理窗口中，选择菜单基本数据配置→自定义变量
，配置自定义变量。
自定义变量名称|策略变量|策略变量属性
---|---|---
Sy_PCS10000|策略变量|字符型策略计数器状态（Sy）
策略计数器标识生成方式|Sy_PCS10000|指定
策略计数器标识|Sy_PCS10000|10000
日志开关|Sy_PCS10000|关闭
在EM的RCP策略管理窗口中，选择菜单基本数据配置→通知
，配置通知数据。
通知名称|参数名称|取值
---|---|---
Sy_PCS10000_sms>=100%|通知语言|中文（中华人民共和国）
通知内容|Sy_PCS10000_sms>=100%|尊敬的用户您好，您购买的套餐使用量已耗尽，请尽快充值。
配置条件
在EM的RCP策略管理窗口中，选择菜单策略元素配置→条件
，配置策略计数器标识状态条件。
条件名称|参数名称|取值
---|---|---
Sy_PCS10000_Normal_speed|选择策略变量|其他
策略变量类别|Sy_PCS10000_Normal_speed|自定义策略变量
策略变量|Sy_PCS10000_Normal_speed|Sy_PCS10000
操作符|Sy_PCS10000_Normal_speed|=
参考值|Sy_PCS10000_Normal_speed|Sy_PCS10000_normal
Sy_PCS10000 >=100%|选择策略变量|其他
策略变量类别|Sy_PCS10000 >=100%|自定义策略变量
策略变量|Sy_PCS10000 >=100%|Sy_PCS10000
操作符|Sy_PCS10000 >=100%|=
参考值|Sy_PCS10000 >=100%|Sy_PCS10000_exhaust
在EM的RCP策略管理窗口中，选择菜单策略元素配置→条件
，配置应用标识条件。
条件名称|参数名称|取值
---|---|---
Appid=10001|选择策略变量|其他
策略变量类别|Appid=10001|会话信息类
策略变量|Appid=10001|Gx应用标识
操作符|Appid=10001|=
参考值|Appid=10001|10001
配置动作参数
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置通知策略动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS10000_Act_sms>=100%|参数类型|通知参数集
全局通知编号|Sy_PCS10000_Act_sms>=100%|3
通知类型|Sy_PCS10000_Act_sms>=100%|SMS/EMAIL&SOAP
私人短信通知内容|Sy_PCS10000_Act_sms>=100%|Sy_PCS10000_sms>=100%
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置预下发业务动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS10000_Act_SvcPre|应用标识|10001
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置N7会话控制策略动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy_PCS10000_Act_Normal_speed|参数类型|N7会话参数集
会话规则名称|Sy_PCS10000_Act_Normal_speed|N7_SESSRULE_NORMAL_SPEED
会话AMBR上行速率（kbps）|Sy_PCS10000_Act_Normal_speed|50000
会话AMBR下行速率（kbps）|Sy_PCS10000_Act_Normal_speed|50000
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置TC动作参数。
动作参数名称|参数名称|取值
---|---|---
Sy10000_exhaust_TC|流量控制策略ID|1
重定向能力|Sy10000_exhaust_TC|是
重定向地址类型|Sy10000_exhaust_TC|URL
重定向地址|Sy10000_exhaust_TC|http://confirm.mobile.com
重定向类型|Sy10000_exhaust_TC|一次重定向
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置N7 PCC规则动作参数。
 说明： 
仅列举本特性常用的动作参数，其他参数可根据实际情况填写。 
动作参数名称|参数名称|取值
---|---|---
Sy_PCS10000_Act_exhaust_redirect|参数类型|N7 PCC规则参数集
PCC规则名|Sy_PCS10000_Act_exhaust_redirect|Sy10000_exhaust_redirect
PCC规则类型（*）|Sy_PCS10000_Act_exhaust_redirect|动态规则
优先级|Sy_PCS10000_Act_exhaust_redirect|1
流量控制策略ID|Sy_PCS10000_Act_exhaust_redirect|Sy10000_exhaust_TC
配置规则
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置通知策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS10000_sms>=100%|优先级|10
策略类型|Sy_PCS10000_sms>=100%|通知策略
动作类型|Sy_PCS10000_sms>=100%|立即发送
日志开关|Sy_PCS10000_sms>=100%|关闭
条件表达式|Sy_PCS10000_sms>=100%|Sy_PCS10000>=100% & Appid=10001
动作参数名称|Sy_PCS10000_sms>=100%|Sy_PCS10000_Act__sms>=100%
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置业务预下发控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS10000_SvcPre|优先级|10
策略类型|Sy_PCS10000_SvcPre|业务预下发控制策略
动作类型|Sy_PCS10000_SvcPre|参数填充
日志开关|Sy_PCS10000_SvcPre|关闭
条件表达式|Sy_PCS10000_SvcPre|Appid=10001
动作参数名称|Sy_PCS10000_SvcPre|Sy_PCS10000_Act_SvcPre
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置N7会话控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy_PCS10000_Normal_speed|优先级|1
策略类型|Sy_PCS10000_Normal_speed|N7会话控制策略
动作类型|Sy_PCS10000_Normal_speed|参数填充
日志开关|Sy_PCS10000_Normal_speed|关闭
条件表达式|Sy_PCS10000_Normal_speed|Sy_PCS10000_Normal_speed
动作参数名称|Sy_PCS10000_Normal_speed|Sy_PCS10000_Act_Normal_speed
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置N7业务控制策略规则。
规则名称|参数名称|取值
---|---|---
Sy1_exhaust_redirect|优先级|10
策略类型|Sy1_exhaust_redirect|N7业务控制策略
动作类型|Sy1_exhaust_redirect|参数填充
日志开关|Sy1_exhaust_redirect|关闭
条件表达式|Sy1_exhaust_redirect|Sy_PCS10000>=100% & Appid=10001
动作参数名称|Sy1_exhaust_redirect|Sy_PCS10000_Act_exhaust_redirect
配置场景
在EM的RCP策略管理窗口中，选择菜单策略元素配置→场景
，配置场景规则关联。
场景名称|参数名称|取值
---|---|---
Sy_PCS10000_Limit_Speed|入口1|入口类型|接入信息类
已选入口|Sy_PCS10000_Limit_Speed|入口1|漫游标识
取值|Sy_PCS10000_Limit_Speed|入口1|漫游
策略类型|Sy_PCS10000_Limit_Speed|业务预下发控制策略|Sy_PCS10000_SvcPre
通知策略|策略类型|Sy_PCS10000_Limit_Speed|Sy_PCS10000_sms>=100%
会话控制策略|策略类型|Sy_PCS10000_Limit_Speed|Sy_PCS10000_Normal_speed
业务控制策略|策略类型|Sy_PCS10000_Limit_Speed|Sy_PCS10000_exhaust_redirect
###### 配置实例3 - 基于用户所有策略计数器状态进行策略控制实例配置 
######## 场景说明 
用户所有策略计数器状态为某个值时，进行带宽控制。 
######## 数据规划 
网元|主机名|域名|IP地址|端口
---|---|---|---|---
PCF|rcp.zte.com.cn|zte.com.cn|10.6.108.1|3990
OCS|ocs.zte.com.cn|zte.com.cn|10.6.109.1|3990
参数名称|取值
---|---
SCTP标识|10
名称|to ocs
模块号|1
应用类型|CLIENT
本端IP|10.6.108.1
本端端口|3990
对端IP|10.6.109.1
对端端口|3990
参数名称|取值
---|---
链路号|10
本端主机名称|rcp.zte.com.cn
本端域名|zte.com.cn
对端主机名称|ocs.zte.com.cn
对端域名|zte.com.cn
承载链路|10
承载协议类型|SCTP
链路名称|to ocs
参数名称|取值
---|---
路由编号|10
本地动作|RELAY
主用链路|10
支持应用|Sy
目的URI|ocs.zte.com.cn
类别|参数名称|取值
---|---|---
邻接主机|邻接主机编号|10
邻接主机类型|邻接主机|OCS（OCS）
OCS接入局|OCS接入局配置编号|20
邻接主机编号|OCS接入局|10
号码段分析|号码段分析类型|OCS接入局IMSI分析（OCSACC_IMSI）
起始号码|号码段分析|460020000000000
结束号码|号码段分析|460029999999999
号码段分析结果|号码段分析|20
类别|参数名称|取值
---|---|---
PCID|PCID类型|用户级
策略计数器标识生成方式|PCID|指定
策略计数器标识1|PCID|1
策略计数器标识2|PCID|2
PCS|取值|取值为REACH，表示超过后低业务带宽。取值为NOTREACH，表示正常保证高业务带宽。
策略类型|规则名称|动作
---|---|---
承载控制策略|Sy_PCS_REACH|承载级带宽限制，最大带宽限制为10Mbps
Sy_PCS_NOTREACH|承载控制策略|承载级带宽限制，最大带宽限制为200Mbps
######## 配置步骤 
配置基础链路
配置RCP与短信中心之间的链路，参见“ZUF-59-53-003 短信通知
”。
配置RCP与OCS之间的SCTP链路。 
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=1,NAME="to OCS",LOCPORT=3900,REMPORT=3900,LOCADDR1="10.6.108.1",REMADDR1="10.6.109.1";
 说明： 
要求对端OCS同步配置SCTP链路和Diameter链路。 
配置基础信息
配置RCP的Diameter主机名和域名。 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=5,HOSTNAME="rcp.hatt.zte.com.cn",REALM="hatt.zte.com.cn",TENANTNAME="PCF",PUBTENANTNAME="PCF"
配置OCS邻接主机。 
[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html):ADJHOSTID=10,HOSTNAME="ocs.zte.com.cn",REALM="zte.com.cn",HOSTTYPE="OCS";
配置Diameter链路。 
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=10,LOCALHOSTNAME="rcp.zte.com.cn",LOCALREALM="zte.com.cn",DSTHOSTNAME="ocs.zte.com.cn",DSTREALM="zte.com.cn",CONNID=10,PROTOCOL="SCTP",NAME="to
ocs";
配置路由。 
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=10,LOCALPROCESSID="RELAY",MASTERLINKNO=10,ROUTEAPPID="Sy",DESTURI="ocs.hatt.zte.com.cn";
配置OCS接入局。 
[ADD OCSACC](../../Npcf_PolicyManagement\zh-CN\mml\1787545.html):ID=20,ADJHOSTID=10;
配置号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=30,ANATYPE="OCSACC_IMSI",NUMBEGIN="460020000000000",NUMEND="460029999999999",RESULTID=20;
配置用户级策略计数器标识。 
[ADD USERPCID](../../Npcf_PolicyManagement\zh-CN\mml\1787606.html):ID=1,PCID1="1",PCID1="2";
配置规则条件
在EM的RCP策略管理窗口中，选择菜单策略元素配置→条件
，配置策略计数器标识状态条件。
条件名称|参数名称|取值
---|---|---
Cond_PCS_REACH|策略变量类别|用户信息类
策略变量|Cond_PCS_REACH|用户所有策略计数器状态
操作符|Cond_PCS_REACH|IfHave
参考值|Cond_PCS_REACH|REACH
Cond_PCS_NOTREACH|策略变量类别|用户信息类
策略变量|Cond_PCS_NOTREACH|用户所有策略计数器状态
操作符|Cond_PCS_NOTREACH|IfHave
参考值|Cond_PCS_NOTREACH|NOTREACH
配置动作参数
在EM的RCP策略管理窗口中，选择菜单策略元素配置→动作参数
，配置N7会话控制策略动作参数。
 说明： 
仅列举本特性常用的动作参数，其他参数可根据实际情况填写。 
动作参数名称|参数名称|取值
---|---|---
Act_PCS_NOTREACH|参数类型|N7会话参数集
会话规则名称|Act_PCS_NOTREACH|N7_SESSRULE_NOTREACH
会话AMBR上行速率（kbps）|Act_PCS_NOTREACH|500000
会话AMBR下行速率（kbps）|Act_PCS_NOTREACH|500000
默认最大上行带宽（kbps）|Act_PCS_NOTREACH|200000
默认最大下行带宽（kbps）|Act_PCS_NOTREACH|200000
Act_PCS_REACH|参数类型|N7会话参数集
会话规则名称|Act_PCS_REACH|N7_SESSRULE_REACH
会话AMBR上行速率（kbps）|Act_PCS_REACH|300000
会话AMBR下行速率（kbps）|Act_PCS_REACH|300000
默认最大上行带宽（kbps）|Act_PCS_REACH|100000
默认最大下行带宽（kbps）|Act_PCS_REACH|100000
配置规则
在EM的RCP策略管理窗口中，选择菜单策略元素配置→规则
，配置N7会话控制策略规则。
规则名称|参数名称|取值
---|---|---
Rule_PCS_NOTREACH|优先级|1
策略类型|Rule_PCS_NOTREACH|N7会话控制策略
动作类型|Rule_PCS_NOTREACH|参数填充
日志开关|Rule_PCS_NOTREACH|关闭
条件表达式|Rule_PCS_NOTREACH|Cond_PCS_NOTREACH
动作参数名称|Rule_PCS_NOTREACH|Act_PCS_NOTREACH
Rule_PCS_REACH|优先级|1
策略类型|Rule_PCS_REACH|N7会话控制策略
动作类型|Rule_PCS_REACH|参数填充
日志开关|Rule_PCS_REACH|关闭
条件表达式|Rule_PCS_REACH|Cond_PCS_REACH
动作参数名称|Rule_PCS_REACH|Act_PCS_REACH
配置场景
在EM的RCP策略管理窗口中，选择菜单策略元素配置→场景
，配置场景规则关联。
场景名称|参数名称|取值
---|---|---
Sy_PCS_Limit_Speed|入口|入口类型|用户信息类
已选入口|Sy_PCS_Limit_Speed|入口|用户套餐
取值|Sy_PCS_Limit_Speed|入口|1
策略类型|Sy_PCS_Limit_Speed|N7会话控制策略|Rule_PCS_REACH
Rule_PCS_NOTREACH|策略类型|Sy_PCS_Limit_Speed|N7会话控制策略
##### 测试用例 
####### 基础套餐达量限速功能 
测试条目|基础套餐达量限速功能
---|---
预置条件|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。
测试步骤|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为1，以查询其对应的PCS状态。OCS通过SLA返回Policy-Counter-Identifier取值为1的状态为1，即该用户的消费额度尚未达到80%。RCP根据PCS状态为1时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为2（用量达到80%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为2。RCP根据PCS状态为2时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到策略调整后，按照新的带宽进行限速。同时，RCP通过短信中心通知用户，提醒其消费使用额度已达80%。当OCS检测到PCS状态修改为3（用量达到100%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为3。RCP根据PCS状态为3时，决策下发重定向业务规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com ，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。OCS在月初进行用量清零后，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为1。RCP根据PCS状态为1时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为1，以查询其对应的PCS状态。OCS通过SLA返回Policy-Counter-Identifier取值为1的状态为1，即该用户的消费额度尚未达到80%。RCP根据PCS状态为1时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为2（用量达到80%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为2。RCP根据PCS状态为2时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到策略调整后，按照新的带宽进行限速。同时，RCP通过短信中心通知用户，提醒其消费使用额度已达80%。当OCS检测到PCS状态修改为3（用量达到100%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为3。RCP根据PCS状态为3时，决策下发重定向业务规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com ，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。OCS在月初进行用量清零后，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为1。RCP根据PCS状态为1时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为1，以查询其对应的PCS状态。OCS通过SLA返回Policy-Counter-Identifier取值为1的状态为1，即该用户的消费额度尚未达到80%。RCP根据PCS状态为1时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为2（用量达到80%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为2。RCP根据PCS状态为2时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到策略调整后，按照新的带宽进行限速。同时，RCP通过短信中心通知用户，提醒其消费使用额度已达80%。当OCS检测到PCS状态修改为3（用量达到100%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为3。RCP根据PCS状态为3时，决策下发重定向业务规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com ，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。OCS在月初进行用量清零后，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为1。RCP根据PCS状态为1时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为1，以查询其对应的PCS状态。OCS通过SLA返回Policy-Counter-Identifier取值为1的状态为1，即该用户的消费额度尚未达到80%。RCP根据PCS状态为1时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为2（用量达到80%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为2。RCP根据PCS状态为2时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到策略调整后，按照新的带宽进行限速。同时，RCP通过短信中心通知用户，提醒其消费使用额度已达80%。当OCS检测到PCS状态修改为3（用量达到100%）时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为3。RCP根据PCS状态为3时，决策下发重定向业务规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com ，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。OCS在月初进行用量清零后，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为1。RCP根据PCS状态为1时，决策重新下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessRules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。
通过准则|当OCS返回PCS状态为1时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为2时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。当OCS返回PCS状态为3时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com。|当OCS返回PCS状态为1时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为2时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。当OCS返回PCS状态为3时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com。|当OCS返回PCS状态为1时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为2时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。当OCS返回PCS状态为3时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com。|当OCS返回PCS状态为1时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为2时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。当OCS返回PCS状态为3时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.mobile.com。
信令流程||||
业务流程||用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息。OCS累计业务套餐用量，发现已达该用户消费门限的80%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达80%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为300M bps，并发短信提醒用户套餐用量剩余不多，SMF按照RCP下发的带宽进行限速。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态进行策略决策，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户套餐用量余额不足。月初时用户自动签约新的用量，OCS清零PCS状态，通过SNR携带PCS信息，告知RCP该业务套餐门限为0%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为500M bps，SMF按照RCP下发的带宽进行限速。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息。OCS累计业务套餐用量，发现已达该用户消费门限的80%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达80%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为300M bps，并发短信提醒用户套餐用量剩余不多，SMF按照RCP下发的带宽进行限速。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态进行策略决策，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户套餐用量余额不足。月初时用户自动签约新的用量，OCS清零PCS状态，通过SNR携带PCS信息，告知RCP该业务套餐门限为0%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为500M bps，SMF按照RCP下发的带宽进行限速。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息。OCS累计业务套餐用量，发现已达该用户消费门限的80%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达80%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为300M bps，并发短信提醒用户套餐用量剩余不多，SMF按照RCP下发的带宽进行限速。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态进行策略决策，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户套餐用量余额不足。月初时用户自动签约新的用量，OCS清零PCS状态，通过SNR携带PCS信息，告知RCP该业务套餐门限为0%。RCP根据消费门限的PCS状态进行策略决策，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发新的会话决策信息，最大带宽为500M bps，SMF按照RCP下发的带宽进行限速。
测试结果||测试结果||
####### 漫游用户未签漫游套餐功能 
测试条目|漫游用户未签漫游套餐功能
---|---
预置条件|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和短信中心之间通讯正常。RCP和OCS之间通讯正常。
测试步骤|用户在漫游地上线， SPR返回用户的签约信息，UDA未携带相关漫游套餐。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为10000，以查询其对应的PCS状态。OCS通过SLA返回PCID10000的状态为Sy_PCS10000_normal，即该用户消费卡余额正常，需要保证其正常带宽。RCP根据PCS状态为Sy_PCS10000_normal时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当 OCS检测用户消费卡余额不足时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-Report AVP，其中Policy-Counter-Identifier取值为10000，Policy-Counter-Status取值为Sy_PCS10000_exhaust。RCP根据PCS状态为Sy_PCS10000_exhaust时，决策下发重定向规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。|用户在漫游地上线， SPR返回用户的签约信息，UDA未携带相关漫游套餐。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为10000，以查询其对应的PCS状态。OCS通过SLA返回PCID10000的状态为Sy_PCS10000_normal，即该用户消费卡余额正常，需要保证其正常带宽。RCP根据PCS状态为Sy_PCS10000_normal时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当 OCS检测用户消费卡余额不足时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-Report AVP，其中Policy-Counter-Identifier取值为10000，Policy-Counter-Status取值为Sy_PCS10000_exhaust。RCP根据PCS状态为Sy_PCS10000_exhaust时，决策下发重定向规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。|用户在漫游地上线， SPR返回用户的签约信息，UDA未携带相关漫游套餐。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为10000，以查询其对应的PCS状态。OCS通过SLA返回PCID10000的状态为Sy_PCS10000_normal，即该用户消费卡余额正常，需要保证其正常带宽。RCP根据PCS状态为Sy_PCS10000_normal时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当 OCS检测用户消费卡余额不足时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-Report AVP，其中Policy-Counter-Identifier取值为10000，Policy-Counter-Status取值为Sy_PCS10000_exhaust。RCP根据PCS状态为Sy_PCS10000_exhaust时，决策下发重定向规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。|用户在漫游地上线， SPR返回用户的签约信息，UDA未携带相关漫游套餐。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值为10000，以查询其对应的PCS状态。OCS通过SLA返回PCID10000的状态为Sy_PCS10000_normal，即该用户消费卡余额正常，需要保证其正常带宽。RCP根据PCS状态为Sy_PCS10000_normal时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当 OCS检测用户消费卡余额不足时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-Report AVP，其中Policy-Counter-Identifier取值为10000，Policy-Counter-Status取值为Sy_PCS10000_exhaust。RCP根据PCS状态为Sy_PCS10000_exhaust时，决策下发重定向规则，在Npcf_SMPolicyControlUpdateNotifyrequest中携带pccRules，其中包含traffContDecs，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com，SMF收到重定向规则后，对后续的HTTP业务重定向到相应的重定向地址。同时，RCP通过短信中心通知用户，提醒其消费使用额度已耗尽。
通过准则|当OCS返回PCS状态为“Sy_PCS10000_normal”时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为“Sy_PCS10000_exhaust”时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com。|当OCS返回PCS状态为“Sy_PCS10000_normal”时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为“Sy_PCS10000_exhaust”时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com。|当OCS返回PCS状态为“Sy_PCS10000_normal”时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为“Sy_PCS10000_exhaust”时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com。|当OCS返回PCS状态为“Sy_PCS10000_normal”时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为“Sy_PCS10000_exhaust”时，RCP在SmPolicyDecision中携带pccRules，其中redirectAddressType为URL，设置其地址redirectServerAddress为http://confirm.telcom.com。
信令流程||||
业务流程||用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。
测试结果||测试结果||
####### 基于用户所有策略计数器状态进行策略控制 
测试条目|基于用户所有策略计数器状态进行策略控制
---|---
预置条件|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和OCS之间通讯正常。|RCP系统正常运行。前后台通讯正常。RCP和SMF之间通讯正常。RCP和OCS之间通讯正常。
测试步骤|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值分别为1和2，以查询对应的PCS状态。OCS通过SLA返回PCID1的状态为NOTREACH、PCID2的状态为REACH1，即该用户下所有策略计数器状态有值为NOTREACH。RCP根据遍历查询当前用户下所有计数器状态有NOTREACH时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为REACH时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为REACH。RCP根据PCS状态为REACH时，重新决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessrules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到带宽调整后，按照新的带宽进行限速。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值分别为1和2，以查询对应的PCS状态。OCS通过SLA返回PCID1的状态为NOTREACH、PCID2的状态为REACH1，即该用户下所有策略计数器状态有值为NOTREACH。RCP根据遍历查询当前用户下所有计数器状态有NOTREACH时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为REACH时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为REACH。RCP根据PCS状态为REACH时，重新决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessrules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到带宽调整后，按照新的带宽进行限速。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值分别为1和2，以查询对应的PCS状态。OCS通过SLA返回PCID1的状态为NOTREACH、PCID2的状态为REACH1，即该用户下所有策略计数器状态有值为NOTREACH。RCP根据遍历查询当前用户下所有计数器状态有NOTREACH时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为REACH时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为REACH。RCP根据PCS状态为REACH时，重新决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessrules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到带宽调整后，按照新的带宽进行限速。|用户上线，SPR返回用户的签约信息，UDA携带User-Profile-Info AVP， 其中Package-ID取值为1。RCP发起SLR携带Policy-Counter-Identifier AVP，其取值分别为1和2，以查询对应的PCS状态。OCS通过SLA返回PCID1的状态为NOTREACH、PCID2的状态为REACH1，即该用户下所有策略计数器状态有值为NOTREACH。RCP根据遍历查询当前用户下所有计数器状态有NOTREACH时，决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlCreaterespone中携带sessrules，其中authSessAmbr downlink设置为500Mbps，authSessAmbrdownlink设置为500Mbps。当OCS检测到PCS状态修改为REACH时，通过SNR消息返回给RCP，SNR消息内容包含Policy-Counter-Status-ReportAVP，其中Policy-Counter-Identifier取值为1，Policy-Counter-Status取值为REACH。RCP根据PCS状态为REACH时，重新决策下发SmPolicyDecision信息，在Npcf_SMPolicyControlUpdateNotifyrequest中携带sessrules，其中authSessAmbr downlink设置为300Mbps，authSessAmbrdownlink设置为300Mbps，SMF收到带宽调整后，按照新的带宽进行限速。
通过准则|当OCS返回PCS状态为NOTREACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为REACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。|当OCS返回PCS状态为NOTREACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为REACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。|当OCS返回PCS状态为NOTREACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为REACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。|当OCS返回PCS状态为NOTREACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为500Mbps，authSessAmbr downlink设置为500Mbps。当OCS返回PCS状态为REACH时，RCP在SmPolicyDecision中携带sessRules，其中authSessAmbrdownlink设置为300Mbps，authSessAmbr downlink设置为300Mbps。
信令流程||||
业务流程|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。|用户在漫游地上线，SMF通过Npcf_SMPolicyControlCreate request发起N7会话建立。RCP在Sp接口通过UDR消息查询本用户的签约信息。SPR在Sp接口通过UDA返回该用户的签约信息，但未携带相关漫游套餐。RCP根据签约情况和本地配置信息，判断需要建立Sy会话，通过SLR向OCS发起会话建立请求。OCS通过SLA返回相关PCS状态，Sy会话建立。RCP根据接入信息、用户签约信息及用量信息进行决策，向SMF下发会话决策信息，最大带宽为500M bps。OCS累计业务套餐用量，发现已达该用户消费门限的100%，通过SNR携带PCS信息，告知RCP该业务套餐门限已达100%。RCP根据消费门限的PCS状态，对HTTP业务进行业务重定向，通过Npcf_SMPolicyControlUpdateNotify request消息向SMF下发业务重定向地址，并发短信通知用户需要充值。
测试结果||||
### ZUF-59-41-052 Nnrf接口 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
NRF|网络功能存储功能。用于接收服务提供者的注册信息，供服务使用者发现服务提供者。
##### 描述 
####### 定义 
Nnrf接口是NRF提供的服务化接口，用于NRF和5GC各网络功能（NF）之间的消息交互。 
PCF通过Nnrf接口完成如下功能： 

通过Nnrf对外提供服务PCF向NRF注册本网元和服务的注册信息，以及允许哪些网元和服务访问本网元和服务的授权信息。PCF向NRF更新本网元和服务的注册信息，以及允许哪些网元和服务访问本网元和服务的授权信息。PCF向NRF注销本网元和服务的注册信息。PCF与NRF保持心跳，使得NRF可以监控到本网元状态变更。 
从Nnrf获取其它服务信息PCF向NRF发现其它网元和服务的注册信息。PCF向NRF订阅或取消订阅其它关联网元的状态变更通知。PCF处理NRF通知的订阅关联网元的状态变更。PCF从NRF获取目标网元或服务的访问令牌。 
####### 背景知识 
随着核心网络的演进以及产品能力的不断增强，5G核心网提供了更多更丰富的网络功能服务（NFS）。如果通过传统的工程手段来维护这些NFS，会极大推高管理运维成本，如果能够动态感知新接入的NFS，自动化管理、维护这些NFS，则会大大降低运维成本。 
5G核心网基于NFS自治、自动化管理的目的，引入了NRF这个自动化管理的关键网元。NRF提供一系列注册/更新注册/注销、订阅/取消订阅状态通知等服务化接口，维护整个网络内所有NFS的实时信息，类似一个容纳这些NFS的实时仓库。NRF也提供了服务发现接口，供服务使用者发现已在NRF注册的NFS信息。 
##### 应用场景 
在服务化网络架构下，Nnrf接口是服务提供者、服务使用者与NRF之间的标准接口。PCF的Nnrf接口的应用场景如下： 
PCF向NRF注册服务，便于AMF、SMF、AF等NF发现PCF服务。 
PCF发现并订阅CHF、UDR、BSF、AMF、SMF等服务，获得计费、用户签约信息以及业务相关信息。 
应用场景参见[表1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new019c3b07b0e446eb9d0998fe74526763__7566c895-c297-4f03-80cc-28dd43354eec)。
场景|场景描述
---|---
PCF向其它NF提供策略服务|PCF作为服务提供者，向NRF注册各种服务，供服务使用者访问：向NRF注册AM策略控制服务，供AMF实施接入控制策略。向NRF注册SM策略控制服务，供SMF实施QoS保障策略、计费策略等服务。向NRF注册策略授权控制服务，供AF/NEF实施应用控制和边缘计算等策略服务。
PCF访问其它NF提供的服务|PCF作为服务使用者，向NRF查询需要访问的各种服务：向NRF查询消费限额服务，PCF根据消费限额决策，向SMF下发各种QoS保障策略、计费策略等服务。向NRF查询绑定支持服务，PCF向BSF写入终端的绑定信息，供后续AF/NEF访问到相同PCF。向NRF查询用户数据服务，PCF根据用户签约等信息决策，向SMF下发各种Qos保障策略、计费策略等服务。
##### 客户收益 
运营商和终端用户的收益说明参见[表2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0feabb04e324491a3a8c7b6c825d9b5__XXX%E7%89%B9%E6%80%A7%E6%94%B6%E7%9B%8A%E8%AF%B4%E6%98%8E-486D0F21)。
收益方|收益说明
---|---
运营商|本接口提供服务发现能力。可自动构建服务化网络结构，简化网络维护。自动维护服务可用性，提升网络服务质量。
终端用户|不感知网络结构变化，享受更高质量的网络服务。
##### 实现原理 
###### 系统架构 
PCF与NRF的拓扑关系如[图1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z726c0951863c405d94f309a09ad7a4a9__94615549-c76c-427a-bbb5-b6c7adb2d1d7)所示。
图1  系统架构
[]images/1627272466107.png)
###### 各网元作用 
涉及的网元及其功能参见[表3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7bf260e2751b423d974e1b95901b6c74__f37bf42b-e7f2-4b4c-b9fc-e400b4970425)。
网元|描述
---|---
PCF|向NRF注册、更新或注销本网元和服务的注册信息，以及允许哪些网元和服务访问本网元和服务的授权信息。向NRF查询其它网元和服务的注册信息。和NRF保持心跳，使得NRF可以监控到本网元状态变更。向NRF订阅或取消订阅其它关联网元的状态变更通知。从NRF获取目标网元或服务的访问令牌。
NRF|接收和保存网元和服务的注册信息和授权信息。接收网元和服务查询请求，返回查询结果。和网元保持心跳，监控网元状态。处理网元状态订阅请求，当被订阅方网元状态变化时，向订阅方网元返回最新的被订阅方网元状态。处理PCF获取目标网元和服务的访问令牌的请求，返回访问令牌。
###### 协议栈 
PCF与NRF间的Nnrf接口协议栈如[图2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf70083e9c6384d38854396b247ead853__ec6a22cf-b72e-42c8-aaf3-4b273e2c712f)所示。
协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。 
图2  Nnrf接口协议栈
[]images/1627272789182.png)
###### 本网元实现 
######## 消息描述 
Nnrf接口支持的消息参见[表4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze363c3abfd2e49feacfa84fcad69cecd__e242ca04-e130-4517-bf90-6bf5c33f8415)。
NF|服务|操作|操作语义|说明
---|---|---|---|---
NRF|Nnrf_NFManagement|NFRegister|Request/Response|PCF向NRF注册本网元和服务信息。
NFUpdate|NRF|Nnrf_NFManagement|Request/Response|PCF向NRF更新本网元和服务信息。
NFDeregister|NRF|Nnrf_NFManagement|Request/Response|PCF向NRF注销本网元和服务信息。
NFStatusSubscribe|NRF|Nnrf_NFManagement|Subscribe/Notify|PCF向NRF订阅关联网元和服务的状态变更通知。
NFStatusNotify|NRF|Nnrf_NFManagement|Subscribe/Notify|NRF向PCF通知PCF所订阅的关联网元和服务的状态变更。
NFStatusUnSubscribe|NRF|Nnrf_NFManagement|Subscribe/Notify|PCF向NRF取消订阅关联网元和服务的状态变更通知。
Nnrf_NFDiscovery|NRF|Request|Request/Response|PCF向NRF查询关联的网元和服务。
Nnrf_AccessToken|NRF|Get|Request/Response|PCF从NRF获取目标网元和服务的访问令牌。
######## PCF向NRF注册NF/NFS信息 
PCF通过NFRegister操作向Nnrf_NFManagement服务请求注册本网元和服务信息。 
注册的触发时机： 
自动注册自动注册是PCF部署完成且业务进程正常上电，当检测到NF和各个NFS的注册能力都具备后，会向NRF发起注册请求，NRF返回注册成功响应后完成注册流程。在NF和NFS的服务能力未完整具备前，业务会重复这个检测流程直至PCF向NRF注册完成。自动注册需要满足以下所有条件：Npcf_PolicyManagement中存在本局配置（Diameter主机名和Diameter域名），CommonS_TMSP中有PCF的NFID。服务号段配置不为空或者NRF策略配置允许无号段注册。服务配置中必须配置基础服务NPcf，且至少配置一个PCF服务，例如，Npcf_SMPolicyControl。 
重新注册重新注册是指在PCF锚定的注册容器发生切换，或者NRF服务器回复心跳失败应答，或者NRF回复注册更新失败应答时，PCF向NRF服务器发起重新注册。 
手动注册手动注册是通过执行人机命令注册，用于异常场景（例如，有故障或网络问题等导致PCF与NRF服务器的注册信息不一致）下强制注册。如果执行过人机命令手动注销，此时PCF不会自动再向NRF注册，必须使用人机命令手动注册。 
######## PCF向NRF更新NF/NFS信息 
PCF通过NFUpdate操作向Nnrf_NFManagement服务请求更新本网元和服务信息。 
更新分为全量更新和增量更新。 
在已注册成功的情况下，执行人机命令手动注册是全量更新。其他更新操作是全量更新还是增量更新，取决于CommonS_HTTP_LB服务的全局参数60开关配置，默认值为1（0-更新数组内变更，1-PUT更新整个NFProfile，2-更新整个数组）。 
更新的触发时机： 
PCF本身的参数发生变化时，例如：本局配置中的FQDN、优先级等信息。 
PCF各个服务属性发生变化时，例如：服务管理配置中的服务配置参数发生变化时。 
PCF与NRF间的心跳检测发生时。 
######## PCF向NRF去注册NF/NFS信息 
PCF通过NFDeregister操作向Nnrf_NFManagement服务请求注销本网元和服务信息。 
去注册的触发时机： 
PCF网元的关键信息发生变化时，会触发去注册后再注册，例如：PCF的NFID发生变化。 
PCF网元人机交互命令，人为去注册本局的注册信息。 
NRF策略配置中无号段时允许注册参数设置为否，且没有配置服务号段。 
删除服务配置中的基础服务Npcf。 
服务配置中没有配置任何类型的NF服务。 
######## PCF向NRF订阅其他NF信息 
PCF通过NFStatusSubscribe操作向Nnrf_NFManagement服务订阅关联网元和服务的状态变更。 
订阅类型有如下两种： 
服务发现后自动订阅：在服务发现NF后，PCF会按NF实例ID订阅某个NF。 
手动增加订阅配置：手动增加订阅配置触发PCF订阅其它NF，订阅配置条件主要是NF类型。 
订阅的触发时机： 
当PCF的服务需要感知对端某个NF或者NFS的变化时，需要触发向NRF订阅该NF或者NFS的变更。 
######## PCF向NRF取消NF的订阅信息 
PCF通过NFStatusUnSubscribe操作向Nnrf_NFManagement服务取消订阅某个网元的变更通知。 
取消订阅的触发时机： 
本地缓存的NF数据老化时。 
删除订阅配置时。 
######## PCF向NRF发现其他关联NF的服务信息 
PCF通过Nnrf_NFDiscovery Request向NRF发起服务发现请求，携带查询过滤条件，Nnrf_NFDiscovery服务通过响应消息返回满足条件的服务列表。 
目前常见需要PCF主动发现的服务是UDR网元的"nudr-dr"和BSF网元的"nbsf-management"服务，分别为PCF提供签约数据能力和会话绑定能力。 
服务发现请求除了携带主要常见参数，还可以携带优选区域参数（preferred-locality）。 
目前针对服务发现返回的数据，PCF在本地做了缓存，以提高发现的性能和效率。 
缓存的有效性保障： 
依赖于缓存设置的老化时间。当老化时间到期，老化缓存记录，PCF向NRF发送发现请求，收到NRF返回的响应后，重新缓存发现的数据。 
依赖于PCF对关联网元的订阅事件。当PCF订阅了关联网元的变化后，在对端网元信息发生变化时，NRF会触发变更通知给PCF，PCF针对变更信息的具体内容更新本地缓存。 
###### 业务流程 
######## 注册流程 
为了让服务使用者能够发现PCF服务，当PCF状态可用时，需要向NRF注册其属性信息，流程如[图3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__5d504d8c-dc36-4b62-b25d-bf3a7c2d5d5d)所示。
图3  注册流程
[]images/1627278722006.png)
PCF以PUT方式向NRF发送Nnrf_NF Management_NF Register消息，同时在消息中携带NF实例的属性信息NFProfile。 
NFProfile包括： 
常用属性，例如：网元标识、网元状态、网元类型、网元IP、FQDN、负荷、优先级、心跳时长等。 
可选属性，例如：plmnList、sNssais。 
其他NF实例发现PCF时需要的鉴权信息，例如：pcfInfo、allowedNfDomains、allowedPlmns、allowedNssais。 
参数|说明
---|---
HTTP Header关键参数|:method: PUT:scheme: http 或https:path: /nnrf-nfm/v1/nf-instances/{nfInstanceID}:authority: NRF主机:端口。主机名可以是IPv4/IPv6地址或FQDN，端口可选，默认80。例如[2409:8069:5003:803::2:121]:80
nfInstanceId|NF实例的唯一标识，用于PCF实例向NRF服务器注册的关键字。
nfStatus|PCF网元实例向NRF注册的网元状态：REGISTERED为可用状态，其它状态为不可用状态。
nfType|PCF网元实例向NRF注册的网元类型：PCF。
ipv4Addresses|部署PCF网元实例的IPv4地址。
ipv6Addresses|部署PCF网元实例的网元IPv6地址。
fqdn|规划PCF网元实例的FQDN。
load|本PCF实例的动态负荷信息，取值范围为0~100，表示PCF的当前负荷百分比。
priority|本PCF实例相对于其它PCF的优先级，范围为0~65535，主要用于服务使用者（如AMF/SMF）选择PCF。优先级值越小表示优先级越高。优先级也可出现在nfServiceList 中，并且nfServiceList 的优先级优于本PCF实例的优先级。
capacity|本PCF实例的静态容量信息，取值范围为0~65535，表示本PCF实例相对于其它PCF的相对权重。容量信息也可出现在nfServiceList 中，并且nfServiceList 的容量信息优于本PCF实例的容量信息。
heartBeatTimer|PCF实例与NRF间连续2个心跳的间隔秒数。响应消息中包含这个参数，后续PCF实例按此间隔周期性向NRF发送心跳消息。
plmnList|PCF实例支持的PLMN列表。
sNssais|PCF实例支持的切片列表。
locality|运营商定义PCF实例实际的部署位置，如数据中心。
servingScope|PCF实例支持的服务区域，即为哪些特定区域或省份的用户提供服务。
recoveryTime|PCF实例启动（或重启）的时间，主要用于服务使用者释放挂死会话。
pcfInfo|PCF实例包含的特有参数：groupId：表示本PCF实例归属的PCF组，主要用于PCF Pool组网。dnnList：表示本PCF实例支持的DNN列表。supiRanges：表示本PCF实例支持的SUPI段。gpsiRanges：表示本PCF实例支持的GPSI段。rxDiamHost：如果本PCF实例支持Rx接口，则指示本PCF的Diameter主机名。rxDiamRealm：如果本PCF实例支持Rx接口，则指示本PCF的Diameter域名。
allowedNfDomains|注册到NRF后，NRF允许访问本PCF实例的NF域名。
allowedPlmns|注册到NRF后，NRF允许访问本PCF实例的PLMN列表。
allowedNssais|注册到NRF后，NRF允许访问本PCF实例的切片列表。
如果在注册PCF网元的同时还注册了服务，则注册消息中还会携带服务的属性信息nfServices。 
nfServices包括： 
常用属性，例如：serviceInstanceId、nfServiceStatus、serviceName、ipEndPoints、versions、fqdn、priority。 
可选属性，例如：allowedNfDomains、allowedPlmns、allowedNssais。 
参数|说明
---|---
nfServices|本PCF实例包含的NF服务实例。
serviceInstanceId|PCF实例下的唯一服务实例标识。
nfServiceStatus|服务实例的服务状态：REGISTERED为可用状态，其它状态为不可用状态。
scheme|服务实例的URI模式，如http、 https。
serviceName|服务实例的服务名称，每个服务实例归属的服务名称为下列之一：npcf-smpolicycontrolnpcf-am-policy-controlnpcf-ue-policy-controlnpcf-policyauthorization
ipEndPoints|服务实例提供的侦听业务请求的IP/PORT。
versions|服务实例支持的版本信息。
fqdn|服务实例的FQDN。
sNssais|服务实例支持的切片列表，可为PCF实例支持的切片列表子集。
load|服务实例的动态负荷信息，取值范围为0~100，表示本服务实例的当前负荷百分比。
priority|服务实例相对于本服务类型下其它服务实例的优先级，范围为0~65535。
capacity|服务实例的静态容量信息，取值范围为0~65535，表示本服务实例相对于本服务类型下其它服务实例的相对权重。
allowedNfDomains|注册到NRF后，NRF允许访问本服务实例的NF域名。
allowedPlmns|注册到NRF后，NRF允许访问本服务实例的PLMN列表。
allowedNssais|注册到NRF后，NRF允许访问本服务实例的切片列表。
recoveryTime|服务实例启动（或重启）的时间，主要用于服务使用者释放挂起的会话。
注册成功后，NRF会返回Nnrf_NFManagement_NFRegister Response消息，HTTP响应码为201，消息中携带PCF的属性信息，PCF收到消息后，取NRF服务器返回的心跳时长更新本地心跳间隔时长。 
######## 服务更新流程 
当PCF自身属性或者服务属性发生变化时，会向NRF发送服务更新信息，流程如[图4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__4f97edf0-3979-461e-a7a1-ed4933474a12)所示。
图4  服务更新流程
[]images/1627278774379.png)
服务更新有全量更新和增量更新两种方式。 
全量更新，PCF以PUT方式向NRF发送Nnrf_NFManagement_NFUpdate消息，同时在消息中携带最新的PCF属性信息。 
增量更新，PCF以PATCH方式向NRF发送Nnrf_NFManagement_NFUpdate消息，同时在消息中只携带发生了变化的属性信息。 
更新成功后，NRF会返回Nnrf_NFManagement_NFUpdate Response消息，HTTP响应码为200，消息中携带PCF的最新属性信息。 
######## 注销流程 
当PCF退出服务，会向NRF发送注销请求，流程如[图5](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__d19d3468-1551-46e7-b8fa-5a2422a1a0d8)所示。
图5  注销流程
[]images/1627278810481.png)
PCF以DELETE方式向NRF发送Nnrf_NFManagement_NFDeregister消息，并在消息中携带nfInstanceID。 
注销成功后，NRF会返回Nnrf_NFManagement_NFDeregister Response消息，HTTP响应码为204。 
######## 订阅流程 
当PCF关注某服务的变更时，会发起订阅，订阅流程如[图6](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__5bd98570-0ded-477e-bbac-9d422921027e)所示。
图6  订阅流程
[]images/1627278858691.png)
PCF以POST方式向NRF发送Nnrf_NFManagement_NFStatusSubscribe消息，消息中携带的属性信息有自身NF类型（reqNFType）、FQDN、回调URI、目标NF类型、订阅的通知事件（reqNotifEvents）等。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /nnrf-nfm/v1/subscriptions:authority: NRF主机:端口，主机可以是IPv4/IPv6地址或FQDN，端口可选，默认80。例如：[2409:8069:5003:803::2:121]:80
nfStatusNotificationUri|NRF通知PCF订阅NF状态变更时的URI，其中主机部分为PCF的主机信息，例如："nfStatusNotificationUri":"http://192.162.120.1:8080/nf-notification/2735d1f1-bcaa-4753-bdcd-94ad371e18e0/BSF"
subscrCond|包含订阅条件信息，PCF目前包括两种订阅方式：按NF实例订阅按被订阅NF实例订阅，例如："subscrCond":{"nfInstanceId":"160e6cfe-5eea-4036-8566-77744b5e7199"}按NF类型订阅按被订阅NF类型订阅，例如："subscrCond":{"nfType":"BSF"}
reqNfFqdn|请求订阅的NF的FQDN，即PCF的FQDN。例如："reqNfFqdn":"pcf.zte.com.cn"
reqNfType|请求订阅的NF类型，即PCF的NFType。例如："reqNfType":"PCF"
reqNotifEvents|请求订阅通知的事件类型。例如："reqNotifEvents":["NF_REGISTERED","NF_DEREGISTERED","NF_PROFILE_CHANGED"]
订阅成功后，NRF会返回Nnrf_NFManagement_NFStatusSubscribe消息，HTTP响应码为201，消息中携带订阅资源ID（SubscriptionID）。 
######## 订阅事件通知流程 
PCF订阅的事件发生时，NRF会向PCF通知该事件，流程如[图7](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__84230430-38e5-4210-9fec-ca8cf3be1ceb)所示。
图7  订阅事件通知流程
[]images/1627278910407.png)
NRF以POST方式向PCF发送Nnrf_NFManagement_NFStatusNotify消息，通知PCF订阅的NF实例的状态发生了变化，消息中会携带event（通知事件类型），nfInstanceURI（与通知事件关联的NF的URI），NFProfile（与通知事件关联的NF的属性信息）等。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /nnrf-nfm/v1/{nfStatusNotificationUri}/:authority: PCF主机:端口，主机可以是IPv4/IPv6地址或FQDN，端口可选，默认80。例如：[2409:8069:5003:803::2:121]:80
event|通知的事件类型。例如："event": "NF_PROFILE_CHANGED"
nfInstanceURI|通知事件关联的NF URI。例如："nfInstanceUri": ".../nf-instances/4947a69a-f61b-4bc1-b9da-47c9c5d14b64"
NFProfile|请求订阅的NF的FQDN，即PCF的FQDN。例如："reqNfFqdn":"pcf.zte.com.cn"
收到通知后，PCF会返回Nnrf_NFManagement_NFStatusNotify Response消息，HTTP响应码为204，并根据改变的事件调整该服务的使用。 
######## 取消订阅流程 
若PCF不再关注某服务的变更，会向NRF取消对该服务的订阅，取消订阅NF实例的状态，流程如[图8](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__40a83635-2eda-4a5c-a63f-7149dcdca506)所示。
图8  取消订阅流程
[]images/1627278967732.png)
PCF以DELETE方式向NRF发送Nnrf_NFManagement_NFStatusUnsubscribe消息，消息中携带订阅资源ID（SubscriptionID）。 
取消订阅成功后，NRF会返回Nnrf_NFManagement_NFStatusUnsubscribe Response消息，HTTP响应码为204。 
######## 发现其他服务流程 
当PCF需要发现NRF中注册的其他服务时，会向NRF发送发现服务的请求，流程如[图9](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__91fefb43-5309-4484-b191-2258e425e717)所示。
图9  发现其他服务流程
[]images/1627279033317.png)
PCF以GET方式向NRF发送Nnrf_NFDiscovery_Request消息，消息中携带target-nf-type、req-nf-type、FQDN、SUPI、IP等。发现请求只有HTTP Header，不携带Body信息。 
参数|说明
---|---
HTTP Header关键参数|:method: GET:scheme: http 或https:path: /nnrf-disc/v1/nf-instances?dnn=ims&requester-nf-instance-fqdn=pcf&preferred-locality={Loc}&requester-nf-instance-id={NFInstanceID}&requester-nf-type=PCF&service-names=nbsf-management&target-nf-type=BSF&ue-ipv4-address=192.168.0.1例如，发现BSF携带的参数有：       用户IPv4地址和/或IPv6地址前缀。例如：ue-ipv4-address=192.168.0.1位置优选参数（可选）。例如：preferred-locality={Loc}请求查询的NF的FQDN，即PCF的FQDN。例如：requester-nf-instance-fqdn=pcf请求查询的NF实例号，即PCF的nfInstanceId。例如：requester-nf-instance-id={NFInstanceID}请求查询的NF类型，即PCF的NFType。例如：requester-nf-type=PCF查询目标NF的服务名。例如：service-names=nbsf-management查询目标NF的类型。例如：target-nf-type=BSFDNN:authority: NRF主机:端口，主机可以是IPv4/IPv6地址或FQDN，端口可选，默认80。例如：[2409:8069:5003:803::2:121]:80。
发现成功后，NRF会返回Nnrf_NFDiscovery_Request Response消息，HTTP响应码为200，消息中携带nfinstance（符合查询条件的NF实例的配置信息）。 
######## 网元认证流程 
为支持基于OAuth2.0的授权服务，PCF向NRF请求获取access token，基于该access token，向服务提供者发起服务调用申请，流程如[图10](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#ze77aaa000668403d82b68ab64a7220bc__67bd9eeb-1703-4141-b64c-95e0a9b8c209)所示。
图10  网元认证流程
[]images/1627279086065.png)
PCF以POST方式向NRF发送Nnrf_AccessToken_Get Request消息，同时在消息中携带AccessTokenReq参数，其中包括一些常用属性，例如：授权类型、网元实例、网元类型、范围、目标网元类型、目标网元实例、请求切片等参数。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /oauth2/token:authority: NRF主机:端口，主机可以是IPv4/IPv6地址，端口可选，默认80。例如：[2409:8069:5003:803::2:121]:80
grant_type|grant_type为固定值。例如：client_credentials。
nfInstanceId|PCF实例的唯一标识，用于PCF实例向NRF服务器获取目标NF令牌。例如：nfInstanceId={NFInstanceID}。
nfType|PCF网元实例的网元类型：PCF。
scope|授权范围，包含服务列表和操作级别。
targetNfInstanceId|目标网元实例。
requesterPlmn|PCF网元实例的PLMN。
requesterSnssaiList|PCF网元实例支持的切片列表。
requesterFqdn|PCF网元实例的FQDN。
targetPlmn|目标网元实例的PLMN。
targetSnssaiList|目标网元实例支持的切片列表。
NRF向PCF发送Nnrf_AccessToken_Get Response消息，同时在消息中携带AccessTokenRsp参数，其中包括一些常用属性，例如：授权令牌、授权类型、范围、到期时间等参数。 
参数|说明
---|---
access_token|授权令牌。
token_type|授权类型，例如"Bearer"。
expires_in|到期时间，指令牌从现在到期的秒数。
scope|授权范围，包括服务名称等。
##### 系统影响 
启用Nnrf接口，会在每个服务实例按实际发现的对端NFProfile个数（每个NFProfile最多消耗2M内存）动态分配内存，用于缓存服务提供者信息。 
服务动态发现过程也会增加信令交互，延长流程完成时间。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性间交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System
3GPP|TS 23.502|Procedures for the 5G System
3GPP|TS 29.510|Network Function Repository Services
##### 特性能力 
能力名称|指标
---|---
注册的SUPI最大个数|17000
注册的GPSI最大个数|17000
注册的DNN最大个数|1024
注册的S-NSSAI最大个数|1024
发现缓存的最大NFProfile个数|2048
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性为RCP的基本特性，无需License支持。 
####### 对其他网元的要求 
OAuth2.0功能，需要服务提供者、服务使用者、NRF共同完成，需要三方同时支持此功能。 
其中，NRF对服务使用者进行认证和授权签名。服务使用者请求认证并在服务请求中携带认证信息。服务提供者对认证信息校验通过后才提供服务。 
##### O&M相关 
####### 命令 
配置项新增配置项参见表5。表5  新增命令命令项命令名称描述服务基础配置ADD PCFSERVICE增加服务基础SET PCFSERVICE修改服务基础DEL PCFSERVICE删除服务基础SHOW PCFSERVICE查询服务基础服务号段配置ADD SERVNUM增加服务号段SET SERVNUM修改服务号段DEL SERVNUM删除服务号段SHOW SERVNUM查询服务号段切片配置ADD NSSAIS增加切片配置DEL NSSAIS删除切片配置SHOW NSSAIS查询切片配置DNN配置ADD DNN增加DNN配置SET DNN修改DNN配置DEL DNN删除DNN配置SHOW DNN查询DNN配置PLMN配置ADD NFPLMN新增NFPLMNSET NFPLMN修改NFPLMNDEL NFPLMN删除NFPLMNSHOW NFPLMN查询NFPLMN服务区配置ADD SERVEDAREAS增加服务区配置DEL SERVEDAREAS删除服务区配置SHOW SERVEDAREAS查询服务区配置允许的NF域配置ADD ALLOWEDDOMAINS增加允许的NF域SET ALLOWEDDOMAINS修改允许的NF域DEL ALLOWEDDOMAINS删除允许的NF域SHOW ALLOWEDDOMAINS查询允许的NF域允许的切片配置ADD ALLOWEDNSSAIS增加允许的切片DEL ALLOWEDNSSAIS删除允许的切片SHOW ALLOWEDNSSAIS查询允许的切片允许的PLMN配置ADD ALLOWEDPLMNS增加允许的PLMNSET ALLOWEDPLMNS修改允许的PLMNDEL ALLOWEDPLMNS删除允许的PLMNSHOW ALLOWEDPLMNS查询允许的PLMNNRF策略配置SET NRFPATTERN修改NRF策略配置SHOW NRFPATTERN查询NRF策略配置NRF服务器分组配置ADD SBINRFGROUP增加服务器分组SET SBINRFGROUP修改服务器分组DEL SBINRFGROUP删除服务器分组SHOW SBINRFGROUP查询服务器分组NRF服务器节点配置ADD SBINRFNODE增加服务器节点SET SBINRFNODE修改服务器节点DEL SBINRFNODE删除服务器节点SHOW SBINRFNODE查询服务器节点NRF服务器策略配置ADD SBINRFPOLICY增加服务器策略SET SBINRFPOLICY修改服务器策略DEL SBINRFPOLICY删除服务器策略SHOW SBINRFPOLICY查询服务器策略NRF服务器模板配置ADD SBINRFPROFILE增加服务器模板SET SBINRFPROFILE修改服务器模板DEL  SBINRFPROFILE删除服务器模板SHOW SBINRFPROFILE查询服务器模板重选配置ADD SBIRESELECT增加重选配置SET SBIRESELECT修改重选配置DEL  SBIRESELECT删除重选配置SHOW SBIRESELECT查询重选配置重选状态码配置ADD SBIRESELECTSTATUSCODE增加重选状态码SET SBIRESELECTSTATUSCODE修改重选状态码DEL  SBIRESELECTSTATUSCODE删除重选状态码SHOW SBIRESELECTSTATUSCODE查询重选状态码服务发现配置SET SBISRVDISCOVERY修改服务发现配置SHOW SBISRVDISCOVERY查询服务发现配置服务发现方式配置ADD SBISRVDISCOVERYMODE增加服务发现方式SET SBISRVDISCOVERYMODE修改服务发现方式DEL SBISRVDISCOVERYMODE删除服务发现方式SHOW SBISRVDISCOVERYMODE查询服务发现方式NRF服务器模板选择配置ADD SBINRFPROFILESEL增加服务器模板选择SET SBINRFPROFILESEL修改服务器模板选择DEL SBINRFPROFILESEL删除服务器模板选择SHOW SBINRFPROFILESEL查询服务器模板选择路由策略配置ADD SBIROUTEPOLICY增加路由策略SET SBIROUTEPOLICY修改路由策略DEL SBIROUTEPOLICY删除路由策略SHOW SBIROUTEPOLICY查询路由策略局向检测配置SET SBIOFFICEDETECT修改局向检测SHOW SBIOFFICEDETECT查询局向检测订阅条件配置ADD SBISUBCOND增加订阅条件SET SBISUBCOND修改订阅条件DEL SBISUBCOND删除订阅条件SHOW SBISUBCOND查询订阅条件修改配置项参见表6。表6  修改配置项配置项命令新增字段本局配置SET NFINFO网元组编号（GROUPID）、网元位置（LOCALITY）。 
全局变量通过SHOW GLOBAL PARAMETER命令查看。参数编号参数名称系统缺省值描述52重试时间最大值（单位秒）600若响应中retry_after携带的值大于该值，则使用该配置，否则使用响应中携带的retry-after的值。53订阅的有效时长（单位分钟）60若订阅流程的响应中携带的validityTime值小于当前时间，为了避免订阅风暴，将订阅到期时间设置为当前时间+该全局参数的值，否则使用响应中的validityTime的值。60注册更新数组变更方式1注册更新数组变更方式取值包括：0：更新数组内变更。1：PUT更新整个NFProfile。2：更新整个数组。 
动态管理命令项命令名称描述NRF注册NRF_REGISTRATION手动触发向NRF进行注册。NRF去注册NRF_DEREGISTRATION手动触发向NRF去注册，当执行了此命令后，下次注册必须使用NRF_REGISTRATION手动注册。动态发现cache管理SHOW NFPROFILE INFO查询NF Profile的概要信息。当需要查询NF Profile的概要信息时，使用该命令。查询NF Profile的概要信息成功后，显示该NF Profile的概要信息，包括NF的类型，实例ID和实例名称。SHOW NFPROFILE DETAIL INFO查询本地cache中保存动态发现的NF Profile的详细信息。cache的内容是动态变化的，所以需要实时了解当前cache内profile的详细信息时，可使用该命令。DELETE NFPROFILE BY NFINSTANCEID根据NF实例ID删除本地cache中保存的动态发现的NF Profile。当本地调试需要向NRF Server触发查询，但不想在本地cache中查询时，可使用该命令将对应的NF Profile删除。DELETE NFPROFILE BY NFTYPE根据NF类型去删除本地cache中保存的动态发现的NF Profile。当本地调试需要向NRF Server触发查询，不想在本地cache中查询时，可使用该命令将对应的NF Profile删除。本地NRF管理SHOW LOCALNRF NFINFO查询本地NRF内NF Profile概要信息。SHOW LOCALNRF NFDETAILINFO查询本地NRF内NF Profile详细信息。订阅管理SHOW CONFIG SUBINFO查询通过配置触发的订阅信息。SHOW SRVDISCOVERY SUBINFO查询服务发现触发的订阅信息。注册管理SHOW REGISTER INFO查询注册信息。Special SC上维护了业务注册的信息和状态，当需要实时查看所有的注册信息时，可用该命令。SHOW REGISTER DETAIL INFO查询注册的详细信息。NRF服务器管理SHOW NRF INFO查询NRF信息。当需要实时了解当前NF锚定的NRF服务器组及其可用情况时，使用该命令。SWP NRF SERVER倒换NRF Server。当需要切换NF当前锚定的NRF服务器组时使用。命令执行成功后，NF将锚定到相关的另一个NRF服务器组状态检测管理SHOW BASEDETECTOBJ INFO查询基本检测对象概要信息。SHOW BASEDETECTOBJ DETAIL INFO查询基本检测对象详细信息。SHOW DETECT OFFICE INFO查询检测局向概要信息。SHOW DETECT OFFICE DETAIL INFO查询检测局向详细信息。 
####### 告警与通知 
告警名称|描述
---|---
3506438154 主备NRF均不可用|主备NRF均不可用时产生。
3506438160 NRF节点组不可用|NRF节点组不可用时产生。
3506438159 NRF节点不可用|NRF节点不可用时产生。
####### 失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置Nnrf接口 
###### 配置说明 
配置RCP与NRF之间注册、注销、服务发现等流程。 
###### 配置前提 
RCP与NRF之间的HTTP2链路配置完成。 
###### 配置过程 
Nnrf接口配置流程如[图1](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z79d99412da534344af5552e043365c4c__d650f364-fe6e-4076-a582-d324eaae15f4)所示。
图1  配置流程
[]images/NRF.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0 服务。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
选择Npcf_PolicyManagement_0 服务。 
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
NF 服务配置。 
执行[ADD SERVNUM](../../Npcf_PolicyManagement\zh-CN\mml\1787182.html)命令，增加服务号段。
执行[ADD NSSAIS](../../Npcf_PolicyManagement\zh-CN\mml\1788104.html)命令，增加切片配置。
执行[ADD DNN](../../Npcf_PolicyManagement\zh-CN\mml\1788107.html)命令，增加DNN配置。
执行[ADD SERVEDAREAS](../../Npcf_PolicyManagement\zh-CN\mml\1788100.html)命令，增加服务区配置。
执行[ADD NFPLMN](../../Npcf_PolicyManagement\zh-CN\mml\1788205.html)命令，增加PLMN配置。
（可选）执行[ADD ALLOWEDDOMAINS](../../Npcf_PolicyManagement\zh-CN\mml\1787194.html)命令，增加允许的NF域。
（可选）执行[ADD ALLOWEDNSSAIS](../../Npcf_PolicyManagement\zh-CN\mml\1787202.html)命令，增加允许的切片。
（可选）执行[ADD ALLOWEDPLMNS](../../Npcf_PolicyManagement\zh-CN\mml\1787284.html)命令，增加允许的PLMN。
NRF服务器相关配置。 
选择CommonS_HTTP_LB_0 服务。 
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，配置重选信息。
###### 配置实例 
######## 场景说明 
RCP支持向NRF注册、更新或注销本网元和服务的注册信息，以供其它NF发现RCP提供的服务能力。 
######## 数据规划 
RCP网元地址为3.3.3.3，NRF网元地址为1.1.1.1/2.2.2.2，互备双活模式。 
HTTP客户端模板配置参数名称参数值编号1IP地址3.3.3.3起始端口20000终止端口30000 
HTTP服务端模板配置参数名称参数值编号1IP地址3.3.3.3端口8080 
服务基础配置参数名称参数值服务类型NpcfNpcf_SMPolicyControlNpcf_AMPolicyControlFqdnpcf.zte.com.cnpcf.zte.com.cnpcf.zte.com.cn版本v1v1v1优先级111 
服务号段配置参数名称参数值服务号段配置编号1号码段类型SUPI起始号码520035036000000结束号码520035036099999 
切片配置参数名称参数值Sst1sd111111 
DNN配置参数名称参数值编号1DNNinternet.5g 
服务区配置参数名称参数值服务区域1 
PLMN配置参数名称参数值ID1MCC460MNC111 
允许的NF域（可选）参数名称参数值允许的NF域配置编号1服务类型NPCF_SMPOLICYCONTROLNF域A 
允许的切片（可选）参数名称参数值服务类型NPCF_SMPOLICYCONTROLSst2sd222222 
允许的PLMN（可选）参数名称参数值允许的PLMN配置编号1服务类型NPCF_SMPOLICYCONTROLMCC461MNC222 
NRF服务器分组配置参数名称参数值NRF服务器组编号12描述信息NrfMasterNrfSlave 
NRF服务器节点配置参数名称参数值NRF服务器节点编号12NRF服务器IP地址1.1.1.12.2.2.2NRF服务器端口80808080NRF服务器FQDNnrf1.hatt.zte.com.cnnrf2.hatt.zte.com.cnURI schemehttphttpHTTP客户端模板编号11通知时使用的HTTP服务端模板编号11NRF服务器节点优先级12归属的NRF服务器组编号12 
NRF服务器策略配置NRF模式默认是互备双活模式（DUAL_ACTIVE），如需要可以配置成主备模式（MAIN_STANDBY）。参数名称参数值NRF服务器策略编号1NRF模式DUAL_ACTIVE 
NRF服务器模板配置参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参数名称参数值NF类型PCF_TYPENRF服务器模板编号1 
重选配置参数名称参数值目的NF类型ALL 
######## 配置步骤 
配置HTTP客户端/服务端模板 
HTTP客户端版本配置 ： 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=3.3.3.3,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
HTTP服务端版本配置： 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=3.3.3.3,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置需要注册到NRF的基础服务 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP";
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF_AMPOLICYCONTROL",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP";
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP";
设置NF服务配置 
配置服务号段 
[ADD SERVNUM](../../Npcf_PolicyManagement\zh-CN\mml\1787182.html):ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999"
配置切片 
[ADD NSSAIS](../../Npcf_PolicyManagement\zh-CN\mml\1788104.html):SST="1",SD="111111"
配置DNN 
[ADD DNN](../../Npcf_PolicyManagement\zh-CN\mml\1788107.html):ID=1,DNN="internet.5g"
配置服务区 
[ADD SERVEDAREAS](../../Npcf_PolicyManagement\zh-CN\mml\1788100.html):SERVEDAREA="1"
配置PLMN 
[ADD NFPLMN](../../Npcf_PolicyManagement\zh-CN\mml\1788205.html):ID=1,MCC="460",MNC="111"
（可选）增加允许的NF域 
其他NF在通过NRF发现PCF时，需要在允许的NF域配置列表里才能正常发现PCF服务。 
[ADD ALLOWEDDOMAINS](../../Npcf_PolicyManagement\zh-CN\mml\1787194.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="A"
（可选）增加允许的切片 
其他NF在通过NRF发现PCF时，需要在允许的切片配置列表里才能正常发现PCF服务。 
[ADD ALLOWEDNSSAIS](../../Npcf_PolicyManagement\zh-CN\mml\1787202.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",SST=2,SD="222222"
（可选）增加允许的PLMN 
其他NF在通过NRF发现PCF时，需要在允许的PLMN配置列表里才能正常发现PCF服务。 
[ADD ALLOWEDPLMNS](../../Npcf_PolicyManagement\zh-CN\mml\1787284.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",MCC="461",MNC="222"
设置NRF服务器相关配置 
增加NRF服务器分组配置 
本命令用于新增NRF服务器分组配置。在NRF服务器模板中需引用该分组。 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
增加NRF服务器节点配置 
本命令用于新增NRF服务器节点，即NRF Server的地址和端口信息等。该命令需配置HTTP客户端模板编号，该参数用于设置向NRF服务器发送请求时使用的HTTP客户端模板编号，一定要引用能和NRF Server建链成功的客户端模板，否则注册，服务发现等流程会失败。 
若URI scheme选择HTTPS方式，则引用的HTTP客户端模板编号一定要配置TLS证书，否则注册、服务发现等流程会失败。NRF服务器节点优先级默认值为0，0代表优先级最高，值越大，优先级越低。现场若未开通FQDN，SERVERFQDN参数可不填。 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="1.1.1.1",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=2,SERVERIPADDR="2.2.2.2",SERVERPORT=8080,SERVERFQDN="nrf2.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=2,GROUPID=2
增加NRF服务器策略配置 
NRF模式默认为互备双活模式（ DUAL_ACTIVE），可根据现场组网需求更改为主备模式（ MAIN_STANDBY）。 
本命令中的重定向次数只针对临时重定向（失败码307），永久重定向（失败码308）只可永久重定向1次。 
心跳间隔默认值为60S，可根据需求修改，若NRF Server回送的注册响应中不携带heartBeatTimer参数，则PCF与NRF之间的心跳间隔以该配置为准。 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
增加NRF服务器模板配置 
本命令用于新增NRF服务器模板配置，该配置需引用NRF服务器策略编号以及主用、备用NRF服务器组号（备用NRF服务器组号可不填，同一个NRF服务器分组ID只能在一个NRF服务器模板中出现一次）。至少要配置一个NRF服务器节点，引用此配置中的主用NRF服务器组号，否则锚定主节点失败。关于主备节点的判断：针对某NRFProfile，主用NRF服务器组下的节点为主用节点，备用NRF服务器组下的节点为备用节点。 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
增加NRF服务器模板选择配置 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE=PCF_TYPE,NRFPROFILEID=1
设置NRF重选配置 
本命令主要用于新增重选配置，当前锚定节点不可用时，NRFClient超时时，可根据此配置进行重选，NRFClient的超时时间即为重选等待时长。 
SBI-GW在使用选定节点和链路访问NRF服务失败时，则先进行链路失败重选，当链路失败重选达到次数时，则通过路由选择重选访问节点，并重新使用该节点访问NRF服务。当节点重选测试达到允许次数时，则本次访问NRF服务失败。链路重选是设置同一个目的IP的不同链路重选次数，IP重选是用于设置同一个NF的不同IP重选次数；IP重选次数除受限于该配置，还受限于当前NF下的NRFNode的数量，最多可重选当前NF下的NRFNode的数量减1；NF重选次数除受限于该配置还受限于NF的个数。 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE=ALL
（可选）配置无号段允许注册。 
纯语音局点才需要改为YES： 
[SET NRFPATTERN](../../Npcf_PolicyManagement\zh-CN\mml\1788126.html):NOSEGREG="YES"
（可选）配置服务发现。 
现场若未开通FQDN，SUBREQFQDN参数可不填，当NRF需要动态发现BSF/CHF时，SUBREQNFTYPE必须配置为PCF。 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):CACHEFLAG="true",SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
（可选）配置服务发现方式。 
需要用到NRF动态发现BSF/CHF时配置。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="ALL",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443;
（可选）配置重选状态码。 
一般无需配置。当主用NRF返回某种失败（特定状态码为403）时，需要重选备用NRF时配置。 
[ADD SBIRESELECTSTATUSCODE](../../CommonS_HTTP_LB\zh-cn\mml\1220521.html):ID=1,TARGETNFTYPE="ALL",STATUSCODE=403
######## 配置脚本 
//1、配置HTTP客户端/服务端模板 
//HTTP客户端版本配置 
ADD CLIENTPROFILE:ID=1,IPADDR=3.3.3.3,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2" 
//HTTP服务端版本配置 
ADD SERVERPROFILE:ID=1,IPADDR=3.3.3.3,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF" 
//2、配置哪些服务需要注册到NRF 
//配置服务基础配置 
ADD PCFSERVICE:SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"; 
ADD PCFSERVICE:SERVICETYPE="NPCF_AMPOLICYCONTROL",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"; 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"; 
//3、配置NF服务配置 
//必选配置： 
//a.配置服务号段 
ADD SERVNUM:ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999" 
//b.配置切片 
ADD NSSAIS:SST="1",SD="111111" 
//c.配置DNN 
ADD DNN:ID=1,DNN="internet.5g" 
//d.配置服务区 
/ADD SERVEDAREAS:SERVEDAREA="1" 
//e.配置PLMN 
ADD NFPLMN:ID=1,MCC="460",MNC="111" 
//可选配置： 
//a.增加允许的NF域：其他NF在通过NRF发现PCF时，需要在允许的NF域配置列表里才能正常发现PCF服务 
ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="A" 
//b.增加允许的切片：其他NF在通过NRF发现PCF时，需要在允许的PLMN配置列表里才能正常发现PCF服务 
ADD ALLOWEDNSSAIS:SERVICETYPE="NPCF_SMPOLICYCONTROL",SST=2,SD="222222" 
//c.增加允许的PLMN：其他NF在通过NRF发现PCF时，需要在允许的PLMN配置列表里才能正常发现PCF服务 
ADD ALLOWEDPLMNS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",MCC="461",MNC="222" 
//4、配置NRF服务器相关配置 
//必选配置： 
//a.NRF服务器分组配置 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
//说明：本命令用于新增NRF服务器分组配置。在NRF服务器模板中需引用该分组。 
//b.NRF服务器节点配置 
ADD SBINRFNODE:ID=1,SERVERIPADDR="1.1.1.1",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1 
ADD SBINRFNODE:ID=2,SERVERIPADDR="2.2.2.2",SERVERPORT=8080,SERVERFQDN="nrf2.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=2,GROUPID=2 
//说明：本命令用于新增NRF服务器节点，即NRF Server的地址和端口信息等。该命令需配置HTTP客户端模板编号，该参数用于设置向NRF服务器发送请求时使用的HTTP客户端模板编号，一定要引用能和NRF Server建链成功的客户端模板，否则注册，服务发现等流程会失败。若URI scheme选择HTTPS方式，则引用的HTTP客户端模板编号一定要配置TLS证书，否则注册，服务发现等流程会失败。NRF服务器节点优先级默认值为0,0代表优先级最高，值越大，优先级越低。现场若未开通FQDN，SERVERFQDN参数可不填。 
//c.NRF服务器策略配置 
//说明：NRF模式默认为互备双活模式 DUAL_ACTIVE，可根据现场组网需求更改为主备模式 MAIN_STANDBY。
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
//d.配置NRF服务器模板 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
//说明：本命令用于新增NRF服务器模板配置，该配置需引用NRF服务器策略编号以及主用、备用NRF服务器组号（备用NRF服务器组号可不填，同一个NRF服务器分组ID只能在一个NRF服务器模板中出现一次）。至少要配置一个NRF服务器节点引用此配置中的主用NRF服务器组号，否则锚定主节点失败。关于主备节点的判断：针对某NRFProfile，主用NRF服务器组下的节点为主用节点，备用NRF服务器组下的节点为备用节点。 
//e.配置NRF服务器模板选择 
ADD SBINRFPROFILESEL:NFTYPE=PCF_TYPE,NRFPROFILEID=1 
//f.配置NRF重选配置 
ADD SBIRESELECT:TARGETNFTYPE=ALL 
//说明：本命令主要用于新增重选配置，当前锚定节点不可用时，NRFClient超时时，可根据此配置进行重选，NRFClient的超时时间即为重选等待时长。SBI-GW在使用选定节点和链路访问NRF服务失败时，则先进行链路失败重选，当链路失败重选达到次数时，则通过路由选择重选访问节点，并重新使用该节点访问NRF服务。当节点重选测试达到允许次数时，则本次访问NRF服务失败。链路重选是设置同一个目的IP的不同链路重选次数，IP重选是用于设置同一个NF的不同IP重选次数；IP重选次数除受限于该配置，还受限于当前NF下的NRFNode的数量，最多可重选当前NF下的NRFNode的数量减1；NF重选次数除受限于该配置还受限于NF的个数。 
//可选配置： 
//a.配置无号段允许注册，纯语音局点才需要改为YES 
SET NRFPATTERN:NOSEGREG="YES" 
//b.服务发现配置，现场若未开通FQDN，SUBREQFQDN参数可不填，当NRF需要动态发现BSF/CHF时，SUBREQNFTYPE必须配置为PCF 
SET SBISRVDISCOVERY:CACHEFLAG="true",SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn" 
//c.配置服务发现方式，需要用到NRF动态发现BSF/CHF时配置 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="ALL",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443; 
//d.重选状态码配置，一般无需配置，有特殊需要（如特定状态码403）时，需重选备用NRF时配置 
ADD SBIRESELECTSTATUSCODE:ID=1,TARGETNFTYPE="ALL",STATUSCODE=403 
##### 测试用例 
测试条目|RCP向NRF号段注册
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“ 配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“ 配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“ 配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“ 配置实例”进行配置。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。
通过准则|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。
测试条目|RCP向NRF无号段注册
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置，但不执行如下配置。ADD SERVNUM:ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999"。配置无号段允许注册。SET NRFPATTERN:NOSEGREG="YES"。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置，但不执行如下配置。ADD SERVNUM:ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999"。配置无号段允许注册。SET NRFPATTERN:NOSEGREG="YES"。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置，但不执行如下配置。ADD SERVNUM:ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999"。配置无号段允许注册。SET NRFPATTERN:NOSEGREG="YES"。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置，但不执行如下配置。ADD SERVNUM:ID=1,ANATYPE="SUPI",NUMBEGIN="520035036000000",NUMEND="520035036099999"。配置无号段允许注册。SET NRFPATTERN:NOSEGREG="YES"。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中不携带gpsiRanges和supiRanges。
通过准则|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。|RCP实例正常后，作为服务请求者自动向NRF发送注册请求（PUT/nnrf-nfm/v1/nf-instances/{nfInstanceID}），请求执行NF服务注册。NRF通过“201 Created”消息，通知NF服务注册已经完成。
测试条目|RCP向NRF去注册
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。执行DEL SERVNUM:ID=1命令，手动删除号段，RCP向NRF发起服务去注册请求。NRF回复“204 No Content”消息。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。执行DEL SERVNUM:ID=1命令，手动删除号段，RCP向NRF发起服务去注册请求。NRF回复“204 No Content”消息。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。执行DEL SERVNUM:ID=1命令，手动删除号段，RCP向NRF发起服务去注册请求。NRF回复“204 No Content”消息。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。执行DEL SERVNUM:ID=1命令，手动删除号段，RCP向NRF发起服务去注册请求。NRF回复“204 No Content”消息。
通过准则|RCP不再提供服务时，向NRF发送DELETE消息请求执行NF服务去注册，其中携带网元实例标识nfInstanceID。NRF返回“204 No Content”消息，响应NF服务去注册已经完成。|RCP不再提供服务时，向NRF发送DELETE消息请求执行NF服务去注册，其中携带网元实例标识nfInstanceID。NRF返回“204 No Content”消息，响应NF服务去注册已经完成。|RCP不再提供服务时，向NRF发送DELETE消息请求执行NF服务去注册，其中携带网元实例标识nfInstanceID。NRF返回“204 No Content”消息，响应NF服务去注册已经完成。|RCP不再提供服务时，向NRF发送DELETE消息请求执行NF服务去注册，其中携带网元实例标识nfInstanceID。NRF返回“204 No Content”消息，响应NF服务去注册已经完成。
测试条目|RCP向NRF更新注册（全量更新）
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为1，PUT更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为1，PUT更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为1，PUT更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为1，PUT更新整个NFProfile。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。更新DNN配置：ADD DNN:ID=2,DNN="dnn2"。RCP发起全量更新，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。更新DNN配置：ADD DNN:ID=2,DNN="dnn2"。RCP发起全量更新，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。更新DNN配置：ADD DNN:ID=2,DNN="dnn2"。RCP发起全量更新，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201）并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。更新DNN配置：ADD DNN:ID=2,DNN="dnn2"。RCP发起全量更新，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。
通过准则|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。
测试条目|RCP向NRF更新注册（更新数组内变更部分）
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量参数注册更新数组变更方式值为0，更新数组内变更。注：60号全局参数，该参数为注册更新数组变更方式。注册更新数组变更方式取值包括：0-更新数组内变更；1-PUT更新整个NFProfile；2-更新整个数组。默认取值为1， 更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量参数注册更新数组变更方式值为0，更新数组内变更。注：60号全局参数，该参数为注册更新数组变更方式。注册更新数组变更方式取值包括：0-更新数组内变更；1-PUT更新整个NFProfile；2-更新整个数组。默认取值为1， 更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量参数注册更新数组变更方式值为0，更新数组内变更。注：60号全局参数，该参数为注册更新数组变更方式。注册更新数组变更方式取值包括：0-更新数组内变更；1-PUT更新整个NFProfile；2-更新整个数组。默认取值为1， 更新整个NFProfile。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量参数注册更新数组变更方式值为0，更新数组内变更。注：60号全局参数，该参数为注册更新数组变更方式。注册更新数组变更方式取值包括：0-更新数组内变更；1-PUT更新整个NFProfile；2-更新整个数组。默认取值为1， 更新整个NFProfile。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，携带增加允许的NF域。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，携带增加允许的NF域。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，携带增加允许的NF域。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，携带增加允许的NF域。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。
通过准则|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。
测试条目|RCP向NRF更新注册（更新整个数组）
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为2，更新整个数组。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为2，更新整个数组。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为2，更新整个数组。|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。设置60号全局变量的参数注册更新数组变更方式值为2，更新整个数组。
测试步骤|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，更新允许的NF域所在的整个数组。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，更新允许的NF域所在的整个数组。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，更新允许的NF域所在的整个数组。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。|RCP向NRF发起服务注册请求，携带IPv4/IPv6地址、nfServices、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。NRF返回响应消息（响应码为201），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带gpsiRanges和supiRanges。增加允许的NF域配置：ADD ALLOWEDDOMAINS:ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",DOMAIN="1"。RCP发起更新注册，更新允许的NF域所在的整个数组。NRF返回响应消息（响应码为200），并携带IPv4/IPv6地址、nfStatus为REGISTERED、nfType为pcf以及pcfInfo中携带dnnList、gpsiRanges和supiRanges。
通过准则|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。|RCP服务有更新，自动向NRF发送注册更新请求。NRF通过“200 OK”消息，通知NF服务注册更新已经完成。
测试条目|RCP向NRF查询BSF网元和服务
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。配置服务发现方式。ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_FIRST",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=80,DEFAULTPORTFORHTTPS=443|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。配置服务发现方式。ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_FIRST",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=80,DEFAULTPORTFORHTTPS=443|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。配置服务发现方式。ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_FIRST",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=80,DEFAULTPORTFORHTTPS=443|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例”进行配置。配置服务发现方式。ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_FIRST",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=80,DEFAULTPORTFORHTTPS=443
测试步骤|N7会话正常上线。RCP向NRF发起查询BSF网元和服务，携带URL。NRF返回响应消息（响应码为200），并携带nfInstances中含有nfServices，nfServices中包含一个或多个ipEndPoints。RCP按照优先级及链路状态，综合判断选择一个BSF发送获取签约及订阅请求。|N7会话正常上线。RCP向NRF发起查询BSF网元和服务，携带URL。NRF返回响应消息（响应码为200），并携带nfInstances中含有nfServices，nfServices中包含一个或多个ipEndPoints。RCP按照优先级及链路状态，综合判断选择一个BSF发送获取签约及订阅请求。|N7会话正常上线。RCP向NRF发起查询BSF网元和服务，携带URL。NRF返回响应消息（响应码为200），并携带nfInstances中含有nfServices，nfServices中包含一个或多个ipEndPoints。RCP按照优先级及链路状态，综合判断选择一个BSF发送获取签约及订阅请求。|N7会话正常上线。RCP向NRF发起查询BSF网元和服务，携带URL。NRF返回响应消息（响应码为200），并携带nfInstances中含有nfServices，nfServices中包含一个或多个ipEndPoints。RCP按照优先级及链路状态，综合判断选择一个BSF发送获取签约及订阅请求。
通过准则|RCP发起业务流程，根据不同的业务场景向NRF发起查询关联的网元和服务。NRF通过“200 OK”消息，通返回关联网元的IP地址。RCP根据NRF返回的地址，向关联网元发起业务请求。|RCP发起业务流程，根据不同的业务场景向NRF发起查询关联的网元和服务。NRF通过“200 OK”消息，通返回关联网元的IP地址。RCP根据NRF返回的地址，向关联网元发起业务请求。|RCP发起业务流程，根据不同的业务场景向NRF发起查询关联的网元和服务。NRF通过“200 OK”消息，通返回关联网元的IP地址。RCP根据NRF返回的地址，向关联网元发起业务请求。|RCP发起业务流程，根据不同的业务场景向NRF发起查询关联的网元和服务。NRF通过“200 OK”消息，通返回关联网元的IP地址。RCP根据NRF返回的地址，向关联网元发起业务请求。
### ZUF-59-41-002 Diameter Sp和Sp'接口 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|含义
---|---
签约信息（User profile information）|SPR中存储的用户签约信息，包括用户类型、签约的业务等。
签约检查（Profile Check）|把用户请求信息和用户签约信息进行比较，判断用户请求是否被接纳。
##### 描述 
####### 特性定义 
Diameter Sp/Sp'接口是中兴通讯RCP和SPR之间的私有化接口，RCP通过Sp和Sp'两个接口能够从SPR获取用户签约和用户动态数据。 
RCP与SPR之间的接口有两种交互模式： 
仅有用量交互：RCP不向SPR获取签约信息，只交互用量信息。此模式下，只存在通过Sp'接口的交互信息。 
签约和用量都有交互：RCP向SPR获取签约信息，并且交互用量、短信、状态等动态信息。此模式下，既存在通过Sp接口的交互信息，又存在通过Sp'接口的交互信息。 
用户上线时，RCP从SPR获取用户签约及动态数据，用于IP-CAN会话的控制策略决策。
####### 背景知识 
用户在运营商实体或网络营业厅开户，并购买套餐时，BOSS会产生用户个性化签约，并将用户个性化签约存储在SPR网元中。
PCC架构中，RCP能够根据用户个性化签约为用户提供差异化的控制策略和服务，提升客户满意度。 
用户在线过程中，会产生套餐使用流量等动态数据。RCP不支持动态数据的持久化存储，因此需要将用户在线期间统计的用量等动态信息存储到SPR。 
##### 应用场景 
该特性推荐的应用场景如下： 
用户上线时，RCP通过Sp接口从SPR获取用户签约。 
用户上线时，RCP通过Sp'接口从SPR获取用户动态数据。 
用户在线过程中，RCP通过Sp'接口向SPR保存用户动态数据。 
用户在线过程中，如果SPR签约改变，SPR通过Sp接口将最新用户签约推送给RCP。 
用户在线过程中，当IT系统通过SPR查询或重置用量时，SPR通过Sp'接口向RCP查询或重置用量。 
用户下线时，RCP通过Sp接口通知SPR用户下线。 
用户下线时，RCP通过Sp'接口向SPR保存最后用量。 
##### 客户收益 
受益方|受益描述
---|---
运营商|RCP/SPR分设，SPR能够集中存储用户数据，多个RCP能够共享SPR用户数据。
用户|该特性对用户不可见。

##### 实现原理 


 

###### 系统架构 
ZXUN RCP通过Sp和Sp'接口能够从SPR获取用户签约和用户动态数据。
ZXUN RCP系统架构如[图1](1650354407872.html#z64ecbae05acb469a89873caae3ad7db2__7e8f8e6f-6d83-4da9-aaa9-31cc9113ea4c)所示。
图1  ZXUN RCP系统架构
[]images/rcp%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|描述
---|---
RCP|用户上线时，RCP从SPR获取用户个性化签约和用量等动态数据，用于用户IP-CAN会话的策略决策。用户在线期间，RCP通过Sp'接口将用量等动态数据存储到SPR。
SPR|提供用户个性化签约，存储用户动态数据。
BOSS|受理用户个性化签约。
###### 业务流程 
######## RCP请求用户签约数据，用户上线 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B1.png)业务流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求。 
RCP在下面的场景下会通过Sp接口向SPR发送UDR消息请求获取用户签约数据。 
以下两种场景RCP会触发用户上线获取签约的流程： 
当前用户尚未上线。 
用户已上线，但上次查询SPR返回用户为非PCC用户，并且“用户（组）资料接入局配置”中的“自动开通功能开关”打开。 
Sp UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示查询用户签约信息。 
如果“用户（组）资料接入局配置”中的“自动开通功能开关”打开，则RCP会将RATType、IMSI、IMEI、DNN、UserLocation等信息，通过UDR消息中的Extended-Attribute AVP发送给SPR。 
如果“容灾全局配置” 中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR将用户的签约数据通过Sp UDA消息返回给RCP。 
Sp UDA中关键AVP： 
User-Name：用户关键字。 
User-Type：用户类别。 
Charging-Type：计费类型，预付费还是后付费。 
Charging-Begin-Time：用户启帐日。 
User-Profile-Info：签约信息，主要包含用户层的个性化HomeZone信息、用户层的附加属性、套餐签约信息等。 
RCP通过Sp'接口向SPR请求获取动态数据（动态用量等信息）。 
Sp' UDR中关键AVP： 
User-Name：携带用户关键字。 
Flag：设置为0x00020002，表示查询用户动态数据。 
如果“容灾全局配置” 中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR根据用户关键字查询用户动态数据，将查询结果通过Sp' UDA消息返回给RCP。 
RCP根据用户的签约数据和会话信息，及策略配置数据（通过RCP Web GUI配置）进行策略决策，生成规则，向SMF发送Npcf_SMPolicyControl_Create响应。 
对端网元收到消息后，根据消息内容安装规则。 
######## RCP通知SPR用户下线 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B2.png)业务流程描述如下： 
在UE或SMF发起的PDU会话释放流程中，SMF查找到某PDU会话有相关的SM策略关联，向RCP发送Npcf_SMPolicyControl_Delete请求，请求RCP删除SM策略关联。若当前用户无其他会话在线，则用户离线。 
RCP向SMF发送Npcf_SMPolicyControl_Delete响应。 
RCP检查是否有动态数据待同步到SPR，比如：动态用量。 
若有动态数据待同步，则RCP将用量等动态数据打包到Sp' UDR中，通过Sp'接口发送给SPR。 
Sp' UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示上传用户动态数据。 
Used-Service-Info-Report： 用于携带用户动态数据。 
如果“容灾全局配置” 中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR收到消息后将动态数据保存到数据库中，并返回Sp' UDA消息给RCP。 
RCP通过Sp接口发送Sp UDR消息通知SPR用户离线。 
Sp UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00020002，表示通知用户下线。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR返回Sp UDA响应消息给RCP。 
######## SPR推送用户签约数据 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B3.png)业务流程描述如下： 
用户购买新套餐或修改套餐，通过BOSS推送MML命令Mod Base给SPR，通知更新用户签约。 
SPR返回ACK响应消息给BOSS。 
SPR中用户签约数据发生变更。SPR通过Sp接口发送PNR将用户签约信息通知给RCP。 
Sp PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示通知更新用户签约信息。 
User-Type：用户类别。 
Charging-Type：计费类型，预付费还是后付费。 
Charging-Begin-Time：用户启帐日。 
User-Profile-Info：签约信息，主要包含用户层的个性化HomeZone信息、用户层的附加属性、套餐签约信息等。 
RCP返回Sp PNA消息给SPR。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在PNA消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
RCP根据用户的签约数据和会话信息，及策略配置数据（通过RCP Web GUI配置）进行策略决策，生成规则。 
若策略发生变化，则RCP通过Npcf_SMPolicyControl_UpdateNotify请求消息将最新的策略下发给SMF网元。 
SMF返回Npcf_SMPolicyControl_UpdateNotify响应消息给RCP。 
######## SPR通知用户下线 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B4.png)业务流程描述如下： 
运维人员通过BOSS推送MML命令DeReg SPRUser给SPR，通知指定用户下线。 
SPR检查用户在线，通过Sp接口发送PNR消息给RCP，通知RCP用户下线。 
Sp PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00080008，表示通知用户下线。 
RCP返回PNA给SPR。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在PNA消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR返回ACK响应给BOSS。 
RCP对该用户下的每个在线会话，RCP发送Npcf_SMPolicyControl_UpdateNotify通知对端网元释放会话。 
Npcf_SMPolicyControl_UpdateNotify中关键信息：pduSessRelCause。 
SMF返回响应消息Npcf_SMPolicyControl_UpdateNotify响应消息给RCP。 
SMF发送Npcf_SMPolicyControl_Delete请求消息至RCP，通知RCP释放会话。 
RCP释放会话后返回Npcf_SMPolicyControl_Delete响应消息给SMF。 
RCP将需要同步的用量编码到SP' UDR中，通过Sp'接口同步到SPR。 
Sp' UDR中关键AVP： 
User-Name：用户关键字。 
Flag： 设置为0x00010001，表示上传用户动态数据。 
Used-Service-Info-Report：用于携带用户动态数据。 
SPR保存动态数据后，发送响应消息Sp' UDA给RCP。 
######## SPR注销用户 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B5.png)业务流程描述如下： 
用户注销，通过BOSS推送MML命令Del Base给SPR，通知指定用户销户。 
SPR检查该用户在线，通过Sp接口发送PNR消息给RCP，通知RCP注销用户。 
Sp PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00020002，表示通知用户注销。 
RCP返回PNA给SPR。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在PNA消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR删除用户信息，并返回ACK响应消息给BOSS。 
对该用户下的每个在线会话，RCP发送Npcf_SMPolicyControl_UpdateNotify请求消息通知SMF释放会话。 
Npcf_SMPolicyControl_UpdateNotify中关键信息：pduSessRelCause。 
SMF返回响应消息Npcf_SMPolicyControl_UpdateNotify响应消息给RCP。 
SMF发送Npcf_SMPolicyControl_Delete请求消息至RCP，通知RCP释放会话。 
RCP释放会话后返回Npcf_SMPolicyControl_Delete响应消息给SMF。 
######## RCP向SPR同步动态用量 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B6.png)业务流程描述如下： 
外部消息或内部事件触发RCP检查是否要向SPR同步用量，若需要同步，则RCP将需要同步的用量编码到SP' UDR中，通过Sp'接口同步到SPR。 
Sp' UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示上传用户动态数据。 
Used-Service-Info-Report：用于携带用户动态数据。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
以下场景会触发RCP检查是否向SPR同步用量。 
用户在线，SMF发送Npcf_SMPolicyControl_Create上报用量给RCP；或Npcf_SMPolicyControl_Delete释放用户的最后一个会话，用户离线。如果“当前累计用量值-上次向SPR同步的用量>设定的同步阈值”或者“当前时间–上次向SPR同步时的时间>设定的同步间隔”，这两种情况都需要触发向SPR同步用量。 
用户下线过程（Npcf_SMPolicyControl_Delete释放用户的最后一个会话，或SPR通知用户下线，或通过RCP网管人机命令使用户下线等），若有未同步给SPR的动态数据，则需要向SPR同步动态数据。 
SPR保存动态数据后，发送响应消息Sp' UDA给RCP。 
######## SPR更新在线用户动态用量 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B7.png)业务流程描述如下： 
运维人员通过BOSS修改用户的动态用量，通过BOSS推送MML命令SET DYNUSAGE给SPR，携带需修改的动态用量信息。 
SPR返回ACK响应消息给BOSS。 
SPR检查用户在线。SPR将修改过的用量通过Sp' PNR通知到RCP。 
Sp' PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示通知用户动态数据。 
Used-Service-Info-Notify：用于携带用户动态数据。 
RCP返回Sp' PNA消息给SPR。 
RCP根据消息内容，修改在线用户的动态用量，并触发该用户的策略决策。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在PNA消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
若策略决策出的内容与本次在线期间前一次下发给SMF的策略有变化，则RCP将更新的策略内容通过Npcf_SMPolicyControl_UpdateNotify请求消息发送给SMF。 
SMF返回Npcf_SMPolicyControl_UpdateNotify响应消息给RCP。 
######## 实时查询在线用户用量 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B8.png)业务流程描述如下： 
实时查询用户的动态用量，运维人员通过BOSS推送MML命令QRY BASE:IMSI=xxx,REALTIMEFLAG=1;给SPR。 
SPR检查出用户在线，发送查询实时用量Sp' PNR给RCP。 
Sp' PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00020002，表示查询实时用量。 
RCP发起请求上报用量（携带lastReqUsageData）的Npcf_SMPolicyControl_UpdateNotify请求消息给SMF。 
SMF返回成功的Npcf_SMPolicyControl_UpdateNotify响应消息。 
SMF发送用量上报的Npcf_SMPolicyControl_Update请求消息给RCP。 
RCP根据SMF上报的信息累计用量，返回成功的Npcf_SMPolicyControl_Update响应消息给PCEF。 
RCP处理需要查询的用量信息，通过PNA消息中的Used-Service-Info-Query AVP返回RCP上当前用户的所有用量信息给SPR（返回的消息中仅需携带Info-Type为1的用量信息）。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在PNA消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR将查询结果通过ACK消息返回给BOSS。 
######## 容灾相关—SPR支持RCP容灾倒换时更新局向上线请求 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B9.png)业务流程描述如下： 
用户在线，RCP容灾倒换。SMF发送Npcf_SMPolicyControl_Update请求消息给RCP。 
RCP返回Npcf_SMPolicyControl_Update响应消息给SMF。 
RCP触发SP接口UDR消息发送用户上线通知，更新局向。 
SPR根据Sp UDR的指示，更新用户的局向信息，SPR收到更新库成功响应，填写并发送Sp UDA消息，通知RCP上线成功。 
Sp UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00100010，表示更新局向。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
######## 容灾相关—RCP容灾时UDR下线消息优化 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B10.png)业务流程描述如下： 
用户在线时RCP容灾倒换。SMF发送Npcf_SMPolicyControl_Delete通知容灾RCP释放会话。 
容灾RCP返回Npcf_SMPolicyControl_Delete响应给SMF。 
容灾RCP将动态用量等用户动态数据通过Sp' UDR消息发送给SPR。 
SPR保存动态数据后，发送响应消息Sp' UDA给RCP。 
容灾RCP触发SP接口UDR消息发送用户下线和更新局向请求给SPR。 
Sp UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00120012，表示备局RCP通知用户下线。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则容灾RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
SPR根据Sp UDR消息中的flag第2和5位标志置1，判断业务类型为容灾RCP发送的用户下线和更新局向请求，直接复位局向字段。 
SPR发送UDA消息，通知PCRF下线成功。 
######## SPR会话汇聚功能—RCP状态检测 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B11.png)业务流程描述如下： 
SPR定时发动PNR消息给RCP，检测RCP的状态。 
Sp PNR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00200020，表示查询RCP的状态。 
RCP返回PNA响应给SPR。RCP上如果配置状态为维护状态，则RCP给PNA返回失败响应，响应码5003；否则给PNA返回成功响应。 
######## SPR会话汇聚功能—上线流程SPR返回了Master-PCF-HostName 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B12.png)业务流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求。 
RCP在下面的场景下会通过Sp接口向SPR发送UDR消息请求获取用户签约数据。 
以下两种场景RCP会触发用户上线获取签约的流程： 
当前用户尚未上线。 
用户已上线，但上次查询SPR返回用户为非PCC用户，并且“用户（组）资料接入局配置”中的“自动开通功能开关”打开。 
Sp UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示查询用户签约信息。 
如果“用户（组）资料接入局配置”中的“自动开通功能开关”打开，则RCP会将RATType、IMSI、IMEI、DNN、UserLocation等信息，通过UDR消息中的Extended-Attribute AVP发送给SPR。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
由于RCP携带了Session-Aggregation-Flag AVP并且为1，SPR会先进行局向检查。如果SPR中针对此用户已有RCP记录，并且和当前请求上线的RCP不一致，SPR不会更新已存储的RCP局向信息，并且会将SPR已存储RCP主机名以及状态信息通过Sp UDA消息将返回给RCP，UDA消息携带错误码5003。 
Sp UDA中关键AVP： 
User-Name：用户关键字。 
Master-PCF-HostName：用户所在RCP的主机名。 
Master-PCF-Status：用户所在RCP的状态。 
RCP判断SPR返回的Master-PCF-HostName对应的PCF状态Master-PCF-Status。 
场景1： 
4a. 如果SPR返回Master-PCF-Status状态为正常状态（1），则RCP会回复重定向响应给SMF。 
场景2： 
4b. 如果SPR返回Master-PCF-Status状态为非正常状态（0），则RCP会发送强制更新局向的UDR消息到SPR。 
      Flag：设置为0x00110011，表示强制更新局向并且查询用户签约信息。 
5b. SPR更新已存储的RCP局向信息，返回UDA成功响应给RCP。RCP继续后续的正常用户上线流程。 
######## SPR会话汇聚功能—SP'接口UDA返回了Master-PCF-HostName 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B13.png)业务流程描述如下： 
外部消息或内部事件触发RCP检查是否要向SPR同步用量，若需要同步，则RCP将需要同步的用量编码到SP' UDR中，通过Sp'接口同步到SPR。 
Sp' UDR中关键AVP： 
User-Name：用户关键字。 
Flag：设置为0x00010001，表示上传用户动态数据。 
Used-Service-Info-Report：用于携带用户动态数据。 
如果“容灾全局配置”中的“SPR用户会话汇聚功能开关”打开，则RCP会在UDR消息中携带Session-Aggregation-Flag AVP，并且取值为1。 
以下场景会触发RCP检查是否向SPR同步用量。 
用户在线，PCEF或TDF发送CCR-U上报用量给RCP，或CCR-Terminal释放用户的最后一个会话，用户离线。如果“当前累计用量值-上次向SPR同步的用量>设定的同步阈值”或者“当前时间–上次向SPR同步时的时间>设定的同步间隔”，这两种情况都需要触发向SPR同步用量。 
用户下线过程（CCR-Terminal释放用户的最后一个会话，或SPR通知用户下线，或通过RCP网管人机命令使用户下线等），若有未同步给SPR的动态数据，则需要向SPR同步动态数据。 
由于RCP携带了Session-Aggregation-Flag AVP并且为1，SPR会先进行局向检查。如果SPR中针对此用户有RCP记录，并且和当前上报用量的RCP不一致，SPR不会更新用量信息，并且会将SPR已存储RCP主机名以及状态信息通过Sp' UDA消息将返回给RCP，UDA消息携带错误码5003。 
Sp' UDA中关键AVP： 
User-Name：用户关键字。 
Master-PCF-HostName：用户所在RCP的主机名。 
Master-PCF-Status：用户所在RCP的状态。 
RCP判断SPR返回的响应为5003，触发用户离线。 
###### 本网元实现 
######## 用户关键字 
用户关键字可以是IMSI、MSISDN、IP、CUI。当一个用户同时携带多个用户标识（比如：同时携带IMSI和MSISDN），通过在RCP网管上配置“用户标识类型优先级”来决定优先采用何种标识作为用户关键字。 
######## 用户签约数据的管理及模型 
用户放号后的个性化签约数据存储在SPR网元中。 
SPR提供用户和个性化签约信息管理，主要包括对用户与用户所签约业务之间关系的管理，具体操作包括且不限于：对用户进行开户、销户、修改、查询、签约等操作。 
用户上线时RCP通过Sp接口向SPR获取用户个性化签约，在线期间若签约发生变化，SPR通过Sp接口通知RCP更新签约。 
用户签约信息主要包括：用户层签约、套餐签约、业务签约。 
用户层签约用户号码（比如IMSI）、用户类型、用户启帐日、用量签约信息、用户层的HomeZone信息以及用户的套餐签约信息等。 
套餐签约套餐ID、优先级、套餐有效期信息、套餐购买次数、套餐用量签约信息、套餐的HomeZone信息以及套餐的业务信息等。 
业务签约业务标识SI、优先级、业务有效期信息、业务等级、业务用量签约信息等。 
用户签约数据结构如下图所示。 
[]images/%E7%94%A8%E6%88%B7%E7%AD%BE%E7%BA%A6%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png)
######## 用户动态数据 
RCP支持多种用户动态数据的统计，用户离线前将动态数据通过Sp'接口存储到SPR中。 
RCP支持的用户动态数据包括以下类型： 
用量 
短信 
状态信息 
金额 
Rollover用量 
历史用量信息（history usage） 
附加属性生效时间 
套餐激活时间 
重定向确认信息 
######## 获取签约用量配置流程 
获取签约用量配置说明如下： 
[]images/%E8%8E%B7%E5%8F%96%E7%AD%BE%E7%BA%A6%E7%94%A8%E9%87%8F%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)使用[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html)命令增加SPR邻接主机配置，邻接主机类型选择“SPR”。
使用[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html)\[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html)\[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html)命令分别增加和SPR网元连接的SCTP\链路\路由配置。
使用[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html)命令增加接入配置，签约和用量接口交互模式选择“签约和用量都有交互”，如果选择“仅有用量交互”，用户上线只会发送Sp' UDA。
使用[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令增加号码分析配置，号码段分析类型可选择“用户资料接入局IMSI分析”或“用户资料接入局MSISDN分析”。
######## 用户上线获取签约用量和用户下线离线信令以及消息 
用户上线获取签约用量和用户下线离线信令以及消息的具体信令如下图所示。 
[]images/%E7%94%A8%E6%88%B7%E4%B8%8A%E7%BA%BF%E8%8E%B7%E5%8F%96%E7%AD%BE%E7%BA%A6%E7%94%A8%E9%87%8F1.png)Sp UDR上线消息 
Sp UDA上线消息，携带套餐和扩展属性 
Sp' UDR上线消息 
Sp' UDA消息，携带用量信息 
######## Sp/Sp'接口其他特性 
默认签约信息参见下表。 
名称|场景|备注
---|---|---
签约未说明时用户(组)类型|当Sp UDA返回了有效的用户签约但没有携带用户类型。|
SPR返回用户未知时默认套餐|当Sp UDA返回用户签约信息未知时（Sp UDA消息Experimental_Result_Code为5001）。用户（组）资料接入局配置为仅有用量交互。|未知用户处理方式开关1003为1
SPR返回用户未知时用户类型|当Sp UDA返回用户签约信息未知时（Sp UDA消息Experimental_Result_Code为5001）。用户（组）资料接入局配置为仅有用量交互。|未知用户处理方式开关1003为1
SPR中未签约套餐时默认套餐|当Sp UDA返回用户没有签约套餐、用户签约的套餐都不在有效期内或用户签约的套餐标记都是不可用。|最多可以配置5个
SPR宕机时用户类型|当和SPR链路不通时。|
SPR宕机时默认套餐|当和SPR链路不通时。|最多可以配置5个
未配置SPR时默认用户类型|用户（组）接入局配置为同SPR无交互，同时1079开关配置为0。根据用户关键查找SPR失败，同时存在默认套餐。|
未配置SPR时默认套餐|用户（组）接入局配置为同SPR无交互，同时1079开关配置为0。根据用户关键查找SPR接入局失败，同时存在默认套餐。|最多可以配置5个
SPR签约正常时默认套餐|当SPR返回了有效的用户签约时。|最多可以配置5个
默认签约特性指导书：ZUF-59-42-001 基于默认签约的策略
基本套餐特性指导书：《ZUF-59-55-001 基础套餐特性指导》
业务套餐特性指导书：《ZUF-59-55-003 业务套餐特性指导》
######## PCF冷备场景下用户多会话汇聚 
PCF冷备组PooL场景中，PCF之间数据不备份，并且PCF不部署CGW，多PCF之间无数据交互。 
为了实现一个用户的多个会话能存储到一个PCF中，PCF采用重定向的方式来实现多会话汇聚。 
新增接口AVP定义如下： 
SP和SP'接口UDR消息中增加Session-Aggregation-Flag AVP。Session-Aggregation-Flag410861003902Unsigned32401 
SP和SP'接口UDA消息中增加Master-PCF-HostName AVP。Master-PCF-HostName410871003902DiameterIdentity25601 
SP接口PNA消息中增加Session-Aggregation-Flag AVP。Session-Aggregation-Flag410861003902Unsigned32401 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
编号|关联特性|说明
---|---|---
1|签约和用量相关|与签约和用量相关的特性都有交互。
##### 遵循标准 
该特性采用中兴通讯内部的接口和协议，不涉及标准协议。 
##### 特性能力 
名称|指标
---|---
Sp接口，每个用户可签约的套餐个数|50
Sp接口，每个用户可签约的业务个数|16
Sp'接口，每个用户一次最多可安装/更新、删除用量个数|40
Sp'接口，一个用户的动态数据最大个数|256
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
基本接口Sp、Sp'是RCP网元与SPR网元之间的接口，业务流程需要RCP与SPR配置和完成。 
其中，SPR对接口Sp、Sp'需遵循中兴通讯私有协议，SPR需要支持受理放号、存储用户静态动态数据。 

##### O&M相关 


 

###### 命令 
######## 配置项 
编号|命令项|命令名称|描述
---|---|---|---
1|模块处理能力|SET MODULECAP|修改模块处理能力
SHOW MODULECAP|1|模块处理能力|查询模块处理能力
2|邻接SPR主机配置|ADD ADJHOST|新增邻接主机，可配置SPR邻接主机。
SET ADJHOST|2|邻接SPR主机配置|修改邻接主机，可修改SPR邻接主机。
DEL ADJHOST|2|邻接SPR主机配置|删除邻接主机，可删除SPR邻接主机。
SHOW ADJHOST|2|邻接SPR主机配置|查询邻接主机，可查询SPR邻接主机。
3|用户资料接入局配置|ADD USERACC|新增用户资料接入局，指定RCP与SPR之间的接口交互模式。
SET USERACC|3|用户资料接入局配置|修改用户资料接入局，修改RCP与SPR之间的接口交互模式。
DEL USERACC|3|用户资料接入局配置|删除用户资料接入局，删除RCP与SPR之间的接口交互模式。
SHOW USERACC|3|用户资料接入局配置|查询用户资料接入局，查询RCP与SPR之间的接口交互模式。
4|号码段分析配置|ADD NUMANA|新增号码段分析配置，可用于配置用户资料接入局IMSI分析、MSISDN分析、CUI分析、Group ID分析。
SET NUMANA|4|号码段分析配置|修改号码段分析配置。
DEL NUMANA|4|号码段分析配置|删除号码段分析配置。
SHOW NUMANA|4|号码段分析配置|查询号码段分析配置。
5|用户标识类型优先级配置|SET USERKEYPRI|修改用户标识类型优先级。
SHOW USERKEYPRI|5|用户标识类型优先级配置|查询用户标识类型优先级。
######## 定时器 
定时器编号|定时器名称|系统缺省值（毫秒）|其他
---|---|---|---
2050|FSWAITBEARER|6000|RCP等查询用量RAA响应消息定时器。说明：实时用量查询定时器时长 = 2050定时器时长 + 2051定时器时长 + 1秒
2051|FSWAITRELEASE|8000|RCP等用量上报CCR消息定时器。
2052|FSWAITSPR|6000|Sp接口等响应消息定时器。不建议修改。
2054|FSWAITUSAGE|6000|Sp'接口等响应消息定时器。不建议修改。
######## 全局变量 
参数|参数名称|系统缺省值|其他
---|---|---|---
1002|用户签约来源|1|不建议修改
1003|未知用户处理方式|1|
1009|SPR执行失败处理方式|2|不建议修改
1062|用户上线签约UDA返回5001时用量的处理开关|0|1003的值为1（使用默认签约）时才生效
1075|用户在线期间Sp' UDR无响应时重发次数|0|不建议修改
1076|用户离线Sp' UDR无响应时重发次数|1|不建议修改
1079|用户未配置SPR处理方式|0|
######## 动态管理 
执行[SHOW_PROFILE](../../Npcf_SMPolicyControl\zh-cn\mml\1137506.html)命令， 查询在线用户签约信息。
例如，根据IMSI查询在线用户的签约信息，命令如下： 
[SHOW_PROFILE](../../Npcf_SMPolicyControl\zh-cn\mml\1137506.html):DATATYPE="RCP_CM_UC_USER_PROF_DATA",USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460060601020000";
执行[SHOW_USAGE](../../Npcf_SMPolicyControl\zh-cn\mml\1137507.html)命令，查询在线用户动态用量信息。
例如，根据MSISDN查询在线用户的动态用量，命令如下： 
[SHOW_USAGE](../../Npcf_SMPolicyControl\zh-cn\mml\1137507.html):DATATYPE="RCP_CM_USER_UA_DATA",USERTYPE="RCP_QUERY_TYPE_MSISDN",USERID="8606060102000";
###### 告警和通知 
该特性不涉及告警消息的变化。 
#### 特性配置 

#### 特性配置 


 

##### 配置说明 
RCP从SPR获取用户签约及动态数据，为运营商提供差异化的控制策略和服务。 
##### 配置前提 
组网环境稳定，网络正常，协议栈配置正常。 
RCP和SPR网元状态正常。 
SPR需根据规划与RCP共同完成配置。 
##### 配置过程 
[]images/%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)配置说明如下： 
使用[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html)命令增加SPR邻接主机配置，邻接主机类型选择“SPR”。
使用[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html)命令增加接入配置，签约和用量接口交互模式选择“签约和用量都有交互”，如果选择“仅有用量交互”，用户上线只会发送Sp' UDR消息。
使用[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令增加号码分析配置，号码段分析类型可选择“用户资料接入局IMSI分析”或“用户资料接入局MSISDN分析”。
使用[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html)\[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html)\[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html)\[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html)命令分别增加和SPR网元连接的SCTP\链路\路由组\路由配置。
使用[SET USERKEYPRI](../../Npcf_PolicyManagement\zh-CN\mml\1787565.html)命令修改用户标识类型优先级，当一个用户同时携带多个用户标识时，通过此配置来决定优先采用何种标识作为用户关键字。
##### 配置实例 
####### 场景说明 
RCP与主备SPR对接开通。 
####### 数据规划 
配置前获取本网元及主备SPR的主机名、域名、IP地址等信息。 端口号需通过双方商议协定。 
基本数据规划：参数名称参数值本端主机名rcp.hatt.zte.com.cn本端域名hatt.zte.com.cn本端IP地址4003:4::104、4003:4::105（一般为SIG平面loopback地址）VPNID11主用PUDR（SPR）主机名spr1.hatt.zte.com.cn主用PUDR（SPR）域名hatt.zte.com.cn主用PUDR（SPR） IP地址4003:5::3001、4003:5::3002备用PUDR（SPR）主机名spr2.hatt.zte.com.cn备用PUDR（SPR）域名hatt.zte.com.cn备用PUDR（SPR） IP地址4003:5::3101、4003:5::3102 
邻接主机配置（主用SPR）参数名称参数值邻接主机编号301主机名spr1.hatt.zte.com.cn域名hatt.zte.com.cn邻接主机类型SPR邻接主机组编号0（默认值）连接DRA设备NO备注主用PUDR 
邻接主机配置（备用SPR）参数名称参数值邻接主机编号302主机名spr2.hatt.zte.com.cn域名hatt.zte.com.cn邻接主机类型SPR邻接主机组编号0（默认值）连接DRA设备NO备注备用PUDR 
用户（组）资料接入局配置参数名称参数值用户（组）资料接入局配置编号1邻接主机编号301签约和用量接口交互模式SUBS_USG（默认值）自动开通功能开关CLOSE（默认值） 
号码段分析配置参数名称参数值号码段分析配置编号1号码段分析类型USERACC_MSISDN起始号码0000000000000结束号码9999999999999号码段分析结果1 
SCTP偶联配置（到主SPR的4条SCTP偶联）参数名称参数值参数名称参数值参数名称参数值参数名称参数值SCTP标识101SCTP标识102SCTP标识103SCTP标识104别名PUDR1-SCTP21别名PUDR1-SCTP22别名PUDR1-SCTP23别名PUDR1-SCTP24本端端口3868本端端口3869本端端口3870本端端口3871对端端口3868对端端口3869对端端口3870对端端口3871VPNID111VPNID111VPNID111VPNID111本端IP地址14003:4::104本端IP地址14003:4::105本端IP地址14003:4::104本端IP地址14003:4::105对端IP地址14003:5::3001对端IP地址14003:5::3002对端IP地址14003:5::3001对端IP地址14003:5::3002VPNID211VPNID211VPNID211VPNID211本端IP地址24003:4::105本端IP地址24003:4::104本端IP地址24003:4::105本端IP地址24003:4::104对端IP地址24003:5::3002对端IP地址24003:5::3001对端IP地址24003::3002对端IP地址24003:5::3001应用属性CLT应用属性CLT应用属性CLT应用属性CLT应用协议类型DIAMETER应用协议类型DIAMETER应用协议类型DIAMETER应用协议类型DIAMETER 
SCTP偶联配置（到备SPR的4条SCTP偶联）参数名称参数值参数名称参数值参数名称参数值参数名称参数值SCTP标识151SCTP标识152SCTP标识153SCTP标识154别名PUDR2-SCTP31别名PUDR2-SCTP32别名PUDR2-SCTP33别名PUDR2-SCTP34本端端口4868本端端口4869本端端口4870本端端口4871对端端口4868对端端口4869对端端口4870对端端口4871VPNID111VPNID111VPNID111VPNID111本端IP地址14003:4::104本端IP地址14003:4::105本端IP地址14003:4::104本端IP地址14003:4::105对端IP地址14003:5::3101对端IP地址14003:5::3102对端IP地址14003:5::3101对端IP地址14003:5::3102VPNID211VPNID211VPNID211VPNID211本端IP地址24003:4::105本端IP地址24003:4::104本端IP地址24003:4::105本端IP地址24003:4::104对端IP地址24003:5::3102对端IP地址24003:5::3101对端IP地址24003:5::3102对端IP地址24003:5::3101应用属性CLT应用属性CLT应用属性CLT应用属性CLT应用协议类型DIAMETER应用协议类型DIAMETER应用协议类型DIAMETER应用协议类型DIAMETER 
DIAMETER链路配置（到主SPR的4条Diameter链路）参数名称参数值参数名称参数值参数名称参数值参数名称参数值链路号101链路号102链路号103链路号104本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn对端主机名称spr1.hatt.zte.com.cn对端主机名称spr1.hatt.zte.com.cn对端主机名称spr1.hatt.zte.com.cn对端主机名称spr1.hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn邻接局类型SPR邻接局类型SPR邻接局类型SPR邻接局类型SPRSCTP/TCP承载链路101SCTP/TCP承载链路102SCTP/TCP承载链路103SCTP/TCP承载链路104承载协议类型SCTP承载协议类型SCTP承载协议类型SCTP承载协议类型SCTP链路名称PUDR1-1链路名称PUDR1-2链路名称PUDR1-3链路名称PUDR1-4 
DIAMETER链路配置（到备SPR的4条Diameter链路）参数名称参数值参数名称参数值参数名称参数值参数名称参数值链路号151链路号152链路号153链路号154本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端主机名称rcp.hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn本端域名hatt.zte.com.cn对端主机名称spr2.hatt.zte.com.cn对端主机名称spr2.hatt.zte.com.cn对端主机名称spr2.hatt.zte.com.cn对端主机名称spr2.hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn对端域名hatt.zte.com.cn邻接局类型SPR邻接局类型SPR邻接局类型SPR邻接局类型SPRSCTP/TCP承载链路151SCTP/TCP承载链路152SCTP/TCP承载链路153SCTP/TCP承载链路154承载协议类型SCTP承载协议类型SCTP承载协议类型SCTP承载协议类型SCTP链路名称PUDR2-1链路名称PUDR2-2链路名称PUDR2-3链路名称PUDR2-4 
DIAMETER路由组属性配置（到主SPR配置2个路由组）参数名称参数值参数名称参数值路由组编号11路由组编号12路由组名称PUDR1-Sp路由组名称PUDR1-Sp'路由组属性LOADBALANCE路由组属性LOADBALANCE 
DIAMETER路由组属性配置（到备SPR配置2个路由组）参数名称参数值参数名称参数值路由组编号13路由组编号14路由组名称PUDR2-Sp路由组名称PUDR2-Sp'路由组属性LOADBALANCE路由组属性LOADBALANCE 
DIAMETER路由配置（到主SPR配置4条路由，用于SP）参数名称参数值参数名称参数值参数名称参数值参数名称参数值路由编号601路由编号602路由编号603路由编号604主用链路101主用链路102主用链路103主用链路104路由优先级MIDDLE路由优先级MIDDLE路由优先级MIDDLE路由优先级MIDDLE支持应用E4/Sp支持应用E4/Sp支持应用E4/Sp支持应用E4/Sp目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn路由组编号11路由组编号11路由组编号11路由组编号11 
DIAMETER路由配置（到主SPR配置4条路由，用于SP'）参数名称参数值参数名称参数值参数名称参数值参数名称参数值路由编号651路由编号652路由编号653路由编号654主用链路101主用链路102主用链路103主用链路104路由优先级MIDDLE路由优先级MIDDLE路由优先级MIDDLE路由优先级MIDDLE支持应用Sp'支持应用Sp'支持应用Sp'支持应用Sp'目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn路由组编号12路由组编号12路由组编号12路由组编号12 
DIAMETER路由配置（到备SPR配置4条路由，用于SP）参数名称参数值参数名称参数值参数名称参数值参数名称参数值路由编号701路由编号702路由编号703路由编号704主用链路151主用链路152主用链路153主用链路154路由优先级LOW路由优先级LOW路由优先级LOW路由优先级LOW支持应用E4/Sp支持应用E4/Sp支持应用E4/Sp支持应用E4/Sp目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn路由组编号13路由组编号13路由组编号13路由组编号13 
DIAMETER路由配置（到备SPR配置4条路由，用于SP'）参数名称参数值参数名称参数值参数名称参数值参数名称参数值路由编号751路由编号752路由编号753路由编号754主用链路151主用链路152主用链路153主用链路154路由优先级LOW路由优先级LOW路由优先级LOW路由优先级LOW支持应用Sp'支持应用Sp'支持应用Sp'支持应用Sp'目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn目的URIhatt.zte.com.cn路由组编号14路由组编号14路由组编号14路由组编号14 
用户标识类型优先级配置参数名称参数值首选用户标识类型MSISDN次选用户标识类型IMSI 
####### 配置步骤 
SPR邻接主机配置。 
增加SPR邻接主机。按照局方规划的域名配置。 
ADD ADJHOST:ADJHOSTID=301,HOSTNAME="spr1.hatt.zte.com.cn",REALM="hatt.zte.com.cn",HOSTTYPE="SPR",ADJHOSTGRPID=0,CONNECTDRA="NO",REMARK="主用PUDR" 
ADD ADJHOST:ADJHOSTID=302,HOSTNAME="spr2.hatt.zte.com.cn",REALM="hatt.zte.com.cn",HOSTTYPE="SPR",ADJHOSTGRPID=0,CONNECTDRA="NO",REMARK="备用PUDR" 
用户（组）资料接入局配置，仅需配置主用SPR局用户资料接入。 
增加主用局用户（组）资料接入局配置。关键参数：邻接主机编号。 
ADD USERACC:ID=1,ADJHOSTID=301,ACTMODE="SUBS_USG",AUTOPROVSWITCH="CLOSE" 
号码段分析配置。 
增加SPR号码段分析配置。关键参数：号码段分析类型，号码段分析结果（和SHOW USERACC命令的“用户（组）资料接入局配置编号”保持一致），起始号码一般全0、结束号码一般全9。 
ADD NUMANA:ID=1,ANATYPE="USERACC_MSISDN",NUMBEGIN="0000000000000",NUMEND="9999999999999",RESULTID=1 
RCP与SPR间SCTP偶联配置。每套SPR至少配置4条SCTP偶联。 
增加到SPR1的4条SCTP偶联，VPNID以实际配置为准。 
ADD SCTP:ID=101,NAME="PUDR1-SCTP21",LOCPORT=3868,REMPORT=3868,VPNID1=11,LOCADDR1="4003:0004::104",REMADDR1="4003:0005::3001",VPNID2=11,LOCADDR2="4003:0004::105",REMADDR2="4003:0005::3002",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=102,NAME="PUDR1-SCTP22",LOCPORT=3869,REMPORT=3869,VPNID1=11,LOCADDR1="4003:0004::105",REMADDR1="4003:0005::3002",VPNID2=11,LOCADDR2="4003:0004::104",REMADDR2="4003:0005::3001",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=103,NAME="PUDR1-SCTP23",LOCPORT=3870,REMPORT=3870,VPNID1=11,LOCADDR1="4003:0004::104",REMADDR1="4003:0005::3001",VPNID2=11,LOCADDR2="4003:0004::105",REMADDR2="4003:0005::3002",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=104,NAME="PUDR1-SCTP24",LOCPORT=3871,REMPORT=3871,VPNID1=11,LOCADDR1="4003:0004::105",REMADDR1="4003:0005::3002",VPNID2=11,LOCADDR2="4003:0004::104",REMADDR2="4003:0005::3001",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
增加到SPR2的4条SCTP偶联，VPNID以实际配置为准。 
ADD SCTP:ID=151,NAME="PUDR2-SCTP31",LOCPORT=4868,REMPORT=4868,VPNID1=11,LOCADDR1="4003:0004::104",REMADDR1="4003:5::3101",VPNID2=11,LOCADDR2="4003:0004::105",REMADDR2="4003:5::3102",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=152,NAME="PUDR2-SCTP32",LOCPORT=4869,REMPORT=4869,VPNID1=11,LOCADDR1="4003:0004::105",REMADDR1="4003:5::3102",VPNID2=11,LOCADDR2="4003:0004::104",REMADDR2="4003:5::3101",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=153,NAME="PUDR2-SCTP33",LOCPORT=4870,REMPORT=4870,VPNID1=11,LOCADDR1="4003:0004::104",REMADDR1="4003:5::3101",VPNID2=11,LOCADDR2="4003:0004::105",REMADDR2="4003:5::3102",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
ADD SCTP:ID=154,NAME="PUDR2-SCTP34",LOCPORT=4871,REMPORT=4871,VPNID1=11,LOCADDR1="4003:0004::105",REMADDR1="4003:5::3102",VPNID2=11,LOCADDR2="4003:0004::104",REMADDR2="4003:5::3101",ROLE="CLT",PROTOCALTYPE="DIAMETER" 
RCP与SPR间Diameter链路配置。每套SPR至少配置4条Diameter链路。 
增加到PUDR（SPR）1的4条Diameter链路。 
ADD DIM RCPLINK:LINKNO=101,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr1.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=101,PROTOCOL="SCTP",NAME="PUDR1-1" 
ADD DIM RCPLINK:LINKNO=102,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr1.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=102,PROTOCOL="SCTP",NAME="PUDR1-2" 
ADD DIM RCPLINK:LINKNO=103,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr1.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=103,PROTOCOL="SCTP",NAME="PUDR1-3" 
ADD DIM RCPLINK:LINKNO=104,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr1.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=104,PROTOCOL="SCTP",NAME="PUDR1-4" 
增加到SPR2的4条Diameter链路。 
ADD DIM RCPLINK:LINKNO=151,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr2.hatt.zte.com.cn",ADJTYPE="SPR",CONNID=151,PROTOCOL="SCTP",NAME="PUDR2-1" 
ADD DIM RCPLINK:LINKNO=152,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr2.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=152,PROTOCOL="SCTP",NAME="PUDR2-2" 
ADD DIM RCPLINK:LINKNO=153,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr2.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=153,PROTOCOL="SCTP",NAME="PUDR2-3" 
ADD DIM RCPLINK:LINKNO=154,LOCALHOSTNAME="rcp.hatt.zte.com.cn",LOCALREALM="hatt.zte.com.cn",DSTHOSTNAME="spr2.hatt.zte.com.cn",DSTREALM="hatt.zte.com.cn",ADJTYPE="SPR",CONNID=154,PROTOCOL="SCTP",NAME="PUDR2-4" 
RCP到SPR的路由组配置。 
增加Diameter路由组，到每套SPR配置2个路由组，分别对应Sp和Sp'共4个路由组。路由组属性：负荷分担。 
ADD DIM ROUTEGRPPTY:GROUPNO=11,GROUPNAME="PUDR1-Sp",GROUPPTY="LOADBALANCE" 
ADD DIM ROUTEGRPPTY:GROUPNO=12,GROUPNAME="PUDR1-Sp'",GROUPPTY="LOADBALANCE" 
ADD DIM ROUTEGRPPTY:GROUPNO=13,GROUPNAME="PUDR2-Sp",GROUPPTY="LOADBALANCE" 
ADD DIM ROUTEGRPPTY:GROUPNO=14,GROUPNAME="PUDR2-Sp'",GROUPPTY="LOADBALANCE" 
RCP到SPR的路由配置。 
增加Diameter路由。到主用SPR链路的优先级为中，到主用PUDR（SPR）每条链路都Sp和Sp'路由，路由组为主用SPR的Sp和Sp'路由组。 
如：PUDR1链路号为21-24，则链路号21-24配置“支持应用”为SP的路由（如路由组1）、“支持应用”为SP'路由（如路由组2），共8条Diameter路由配置，2个路由组，“路由优先级”为中。 
到备用SPR链路为优先级为低，到备用SPR每条链路都Sp和Sp'路由，路由组为备用SPR的Sp和Sp'路由组。 
如：SPR1链路号为31-34，则链路号31-34配置“支持应用”为SP路由（如路由组3）、“支持应用”为SP'路由（如路由组4），共8条Diameter路由配置，2个路由组，“路由优先级”为低。 
ADD DIM ROUTE:ROUTENO=601,MASTERLINKNO=101,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=11 
ADD DIM ROUTE:ROUTENO=602,MASTERLINKNO=102,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=11 
ADD DIM ROUTE:ROUTENO=603,MASTERLINKNO=103,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=11 
ADD DIM ROUTE:ROUTENO=604,MASTERLINKNO=104,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=11 
ADD DIM ROUTE:ROUTENO=651,MASTERLINKNO=101,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=12 
ADD DIM ROUTE:ROUTENO=652,MASTERLINKNO=102,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=12 
ADD DIM ROUTE:ROUTENO=653,MASTERLINKNO=103,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=12 
ADD DIM ROUTE:ROUTENO=654,MASTERLINKNO=104,ROUTEPRIORITY="MIDDLE",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=12 
ADD DIM ROUTE:ROUTENO=701,MASTERLINKNO=151,ROUTEPRIORITY="LOW",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=13 
ADD DIM ROUTE:ROUTENO=702,MASTERLINKNO=152,ROUTEPRIORITY="LOW",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=13 
ADD DIM ROUTE:ROUTENO=703,MASTERLINKNO=153,ROUTEPRIORITY="LOW",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=13 
ADD DIM ROUTE:ROUTENO=704,MASTERLINKNO=154,ROUTEPRIORITY="LOW",ROUTEAPPID="E4/Sp",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=13 
ADD DIM ROUTE:ROUTENO=751,MASTERLINKNO=151,ROUTEPRIORITY="LOW",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=14 
ADD DIM ROUTE:ROUTENO=752,MASTERLINKNO=152,ROUTEPRIORITY="LOW",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=14 
ADD DIM ROUTE:ROUTENO=753,MASTERLINKNO=153,ROUTEPRIORITY="LOW",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=14 
ADD DIM ROUTE:ROUTENO=754,MASTERLINKNO=154,ROUTEPRIORITY="LOW",ROUTEAPPID="Sp'",DESTURI="hatt.zte.com.cn",ROUTEGROUPNO=14 
用户标识类型优先级配置。 
根据运营商要求设置IMSI或MSISDN优先，要和PUDR（SPR）保持一致，一般是MSISDN，默认为MSISDN优先。 
SET USERKEYPRI:USERKEYTYPE="MSISDN",USERKEYTYPE1="IMSI" 
传表，如上配置为离线配置，配置完成后需要进行传表。 
SYNA 
执行SHOW DIMLNKSTAT命令，查询Diameter链路，确认链路状态正常。 
##### 测试用例 
测试条目|用户上线，RCP请求用户签约和动态数据
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上参见“配置实例”进行配置。
测试步骤|PDU会话建立，SMF向RCP发送Npcf_SMPolicyControl_Create请求。RCP通过Sp接口向SPR发送UDR消息请求获取用户签约数据。SPR将用户的签约数据通过Sp UDA消息返回给RCP，携带User-Name、User-Type、Charging-Type、Charging-Begin-Time、User-Profile-Info等。RCP通过Sp'接口向SPR发送UDR消息请求获取动态数据（动态用量等信息）。SPR根据用户关键字查询用户动态数据，将查询结果通过Sp' UDA消息返回给RCP。RCP根据用户的签约数据和会话信息，及策略配置数据进行策略决策，生成规则，向SMF发送Npcf_SMPolicyControl_Create响应。
通过准则|RCP可以正常向SPR发送Sp UDR消息获取签约数据，携带User-Name、Flag等，其中Flag为0x00010001，表示查询用户签约信息。RCP可以正常向SPR发送Sp' UDR消息获取动态数据，携带User-Name、Flag等，其中Flag为0x00020002，表示查询用户动态数据。
测试条目|用户下线，RCP向SPR同步动态数据并通知用户下线
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上参见“配置实例”进行配置。PDU会话在线且存在动态数据待同步，比如：动态用量。
测试步骤|PDU会话释放，SMF向RCP发送Npcf_SMPolicyControl_Delete请求。RCP向SMF发送Npcf_SMPolicyControl_Delete响应。RCP将用量等动态数据打包到Sp' UDR中，通过Sp'接口发送给SPR。SPR收到消息后将动态数据保存到数据库中，并返回Sp' UDA消息给RCP。RCP通过Sp接口发送Sp UDR消息通知SPR用户离线。SPR返回Sp UDA响应消息给RCP。
通过准则|RCP可以正常向SPR发送Sp' UDR消息同步动态数据，携带User-Name、Flag、Used-Service-Info-Report等，其中Flag为0x00010001，表示上传用户动态数据。RCP可以正常向SPR发送Sp UDR消息通知用户离线，携带User-Name、Flag等，其中Flag为0x00020002，表示通知用户下线。
测试条目|用户购买新套餐或修改套餐，SPR推送用户签约数据
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上参见“配置实例”进行配置。用户正常上线，RCP已成功获取到用户签约数据。策略配置：签约信息修改前无策略下发，修改后下发会话策略。
测试步骤|用户购买新套餐或修改套餐，通过BOSS推送MML命令Mod Base给SPR，通知更新用户签约。SPR返回ACK响应消息给BOSS。SPR中用户签约数据发生变更，SPR通过Sp接口发送PNR将用户签约信息通知给RCP，携带User-Name、Flag、User-Type、Charging-Type、Charging-Begin-Time、User-Profile-Info等，其中Flag设置为0x00010001，表示通知更新用户签约信息。RCP返回Sp PNA消息给SPR。RCP通过Npcf_SMPolicyControl_UpdateNotify请求消息将最新的策略下发给SMF网元。SMF返回Npcf_SMPolicyControl_UpdateNotify响应消息给RCP。
通过准则|RCP可以正常向SPR发送Sp PNA消息响应变更通知。RCP可以根据变更后的签约信息重新决策，并将最新的策略通过Npcf_SMPolicyControl_UpdateNotify请求消息下发给SMF网元。
### ZUF-59-51-040 策略日志 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
EDR|EDR是RCP网元输出的事件记录日志，包括策略日志、用量日志、事件日志、业务历史日志、用量穿越日志、通知日志等。
##### 描述 
####### 定义 
策略日志功能是指RCP支持以EDR文件形式记录系统策略的执行情况，并支持将EDR文件传输给第三方日志分析系统。 
EDR文件的类型参见[表1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new40a95b24cda240a19dc95c1ddbc62789__5cef6093-0e63-43db-b64a-da88c5b708ad)。
日志类型|记录内容
---|---
策略日志|记录策略运行情况的EDR文件。
通知日志|记录通知发送情况的EDR文件。
用量日志|记录用量数值变化、用量状态变化的EDR文件。
事件日志|记录事件发生的EDR文件。
业务历史日志|记录用户配额复位和配额耗尽的EDR文件。
用量穿越日志|记录用量阈值穿越事件的EDR文件。
传输日志|记录上述EDR文件传输情况的日志文件。
RCP支持两种方式的文件传输功能： 
支持作为SFTP服务端，供第三方日志分析网元主动到RCP下载日志文件。 
支持作为SFTP客户端，向第三方日志分析网元上传日志文件。 
####### 背景知识 
RCP通过与对接网元的信令交互，感知用户用量信息、用户用量状态、业务策略、用户配额状态的变化、事件发生等相关信息，并实时生成EDR文件记录相关信息，作为运营商网络状况分析和处理客户投诉的数据依据。 
第三方日志分析网元可以通过SFTP接口从RCP获取日志文件。
##### 应用场景 
网络业务分析运营商需要根据用户用量信息、策略决策、用户事件、用户签约配额等信息进行统计分析以及趋势分析，用于后续的网络优化和业务部署。 
用户投诉处理通过详尽的日志文件，记录用户行为数据轨迹，便于用户投诉时作为依据向用户做详尽的解答，提升用户体验和信任度。 
网络问题定位日志文件也可以作为网络内部问题定位的数据使用。 
##### 客户收益 
对运营商和用户的收益说明参见[表2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new6f75195365194df9bdeea093d3f60a3a__XXX%E7%89%B9%E6%80%A7%E6%94%B6%E7%9B%8A%E8%AF%B4%E6%98%8E-486D0F21)。
收益方|收益说明
---|---
运营商|根据日志文件记录的信息，进行网络业务分析，优化网络和部署业务。根据日志文件记录的信息，获取用户行为轨迹、用户偏好，提升用户体验。
终端用户|用户投诉有据可查。
##### 实现原理 
###### 系统架构 
RCP在系统中的位置如[图1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z93d417b6377247e98b808f0616993e9d__84be23c6-7d19-4c55-aedb-e0d5ecdfec79)所示。
图1  架构图
[]images/1627865591475.png)
###### 各网元作用 
涉及的网元及其功能参见[表3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z12ab84d754dc4e11838f2c12085bc31e__ed1ffd76-4be8-4429-ae50-df9d3f423473)。
网元|描述
---|---
第三方日志分析网元|从RCP获取日志文件并进行分析。
UDR/SPR|UDR/SPR提供用户签约信息，包括用户属于的群组，以及群组签约的群组套餐。
PCEF/SMF|PCEF/SMF上报用户使用的群组套餐的用量，并执行RCP下发的策略。
OCS/CHF|OCS/CHF提供用户计费相关的策略计数器以及策略计数器状态。
###### 本网元实现 
######## 日志服务部署 
日志功能由Npcf_LOG服务负责提供，Npcf_LOG服务部署在LOG虚机上。RCP不支持LOG虚机的自动弹缩，支持LOG虚机的容量调整。 
######## 日志文件生成 
日志文件生成方式参见[表4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#za54e011012dc4e6587bf577309021d2b__0dad3dd3-127a-45f2-91ba-f0be62f84d1c)。
日志类型|生成方式
---|---
策略日志|RCP对决策输出的PCC规则、承载QoS规则、APN-AMBR信息、黑白名单信息、通知信息生成策略日志。策略日志中会记录各种决策的输入条件、输出参数、时间戳等信息。
通知日志|当RCP发送短信通知时，RCP生成通知日志，记录短信通知内容、是否发送成功标记、时间戳等信息。
用量日志|当SMF/PCEF上报新的用量时，RCP生成用量数值变化日志，记录最新的累计用量和时间戳等信息。当N28/Sy接口策略计数器状态改变时，RCP生成用量状态变化日志，记录最新的N28/Sy接口策略计数器状态和时间戳等信息。
业务历史日志|当RCP检测到用户配额复位和配额耗尽发生时，RCP生成业务历史日志，记录用户配额状态、时间戳、套餐名称等信息。
事件日志|当RCP接收到SMF/PCEF的消息并感知到相关事件发生时，生成事件日志，记录事件类型、时间戳等信息。
用量穿越日志|当RCP累计用量后，发现用量累计值穿越阈值时，生成用量穿越日志，记录穿越阈值的用量、阀值、对应套餐名称、时间戳等信息。
传输日志|当RCP作为SFTP客户端向第三方日志分析网元上传日志文件后，RCP会生成传输日志，记录日志文件的上传时间、文件名、上传成功/失败等信息。
######## 日志文件格式 
日志文件格式：EDR<记录类型>_RCP<网元标识>_<YYYYMMDDHHMMSS>_<AAAAXXXX>.csv.gz 
说明： 
日志文件为解压后的csv文件，建议使用gunzip命令解压gz文件。 
<记录类型>：01：用量日志；02：事件日志；03：策略日志；05：通知日志；07：业务历史日志；09：用量穿越日志。 
<网元标识>：PCF网元标识。 
<YYYYMMDDHHMMSS>：日志文件生成的年月日时分秒。 
<AAAAXXXX>：AAAA为4位日志逻辑号，XXXX表示4位流水号，从0000~9999顺序循环使用。 
示例：EDR01_RCP28_20191031100357_00100000.csv.gz
######## 日志文件老化 
为防止超期的日志文件占用系统硬盘，RCP提供日志文件定期老化清理的功能。通过[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html)命令，设置文件保存周期（天）参数来配置日志文件的老化周期。
RCP定期清理达到老化周期的日志文件，释放硬盘空间。当硬盘空间不足时，RCP会向EM上报磁盘空间不足的告警。 
示例：设置文件保存周期（天）参数为7，则RCP将在日志文件保存时间的第8天凌晨3:00开始日志文件的清理。
######## 日志文件传输及传输日志 
RCP支持作为SFTP服务器或客户端方式，向第三方日志分析网元提供日志文件。为了保证传输效率，默认传输.gz压缩文件。
RCP作为SFTP客户端向第三方日志分析网元上传日志文件时，会生成传输日志，记录日志文件上传时间、文件名、上传成功/失败等信息，以备后续检索和核对。传输日志也支持向第三方日志分析网元开放，同日志文件一样通过SFTP方式获取。 
传输日志格式：TRANSLOG_RCP<网元标识>_<YYYYMMDDHHMMSS>_<AAAAXXXX>.csv 
说明： 
<网元标识>：PCF网元标识。 
<YYYYMMDDHHMMSS>：传输日志文件生成的年月日时分秒。 
<AAAABBBBXXXX>：AAAA为4位日志逻辑号，XXXX表示4位流水号，从0000~9999顺序循环使用。 
示例：TRANSLOG_RCP28_20191031102150_00100000.csv
###### 业务流程 
######## 用量日志-用量数值变化 
SMF上报用量后，RCP累计用量，并记录新的用量数值到用量日志。用量数值变化日志属于用量日志的一种，流程如[图2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__a7242f65-aed1-438f-a5a8-1e0c0255b439)所示。
图2  用量日志-用量数值变化
[]images/1627867999197.png)
流程说明如下： 
用户通过UE发起建立PDU会话请求。SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR通过Sp-UDA消息，返回用户签约信息给RCP。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过Sp'-UDA消息，返回用户用量信息给RCP。 
RCP根据用户签约、用户用量、接入信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create response消息发送给SMF。 
当RCP订阅的用量上报事件发生时，SMF发送Npcf_SMPolicyControl_Update request消息给RCP，其中携带用量信息。 
RCP根据上报的用户的签约数据、用量数据、会话数据，重新进行策略判断，生成新的规则，通过Npcf_SMPolicyControl_Update response消息将新的规则下发给SMF，同时生成用量数值变化日志。 
######## 用量日志-用量状态变化 
在PDU会话建立流程中，SMF确定需要向RCP请求PDU会话策略控制，RCP触发向CHF获取用量状态（策略计数器），或者CHF通知用量状态（策略计数器）发生变化，RCP进行策略决策，并且记录用量状态变化到用量日志。用量状态变化日志属于用量日志的一种，流程如[图3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__55715982-e941-4f72-9763-426d373183e5)所示。
图3  用量日志-用量状态变化
[]images/1627868199216.png)
流程说明如下： 
用户通过UE发起建立PDU会话请求。 SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。 
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR通过Sp-UDA消息，返回用户签约信息给RCP。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过Sp'-UDA消息，返回用户用量信息给RCP。 
RCP根据用户签约和策略计数器的配置，通过N28接口向CHF发送Nchf_SpendingLimitControl_Subscribe request消息，请求查询用户的用量状态。 
CHF查询到用户的用量状态，发送Nchf_SpendingLimitControl_Subscribe respone消息给RCP。 
RCP根据用户签约、用户用量、接入信息、N28接口查询到的用量状态信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create response消息发送给SMF，同时生成用量状态变化日志。 
CHF检查到用户的用量状态发生变化，发送Nchf_SpendingLimitControl_Notify request消息给RCP，其中携带最新的用量状态信息。 
RCP返回Nchf_SpendingLimitControl_Notify response消息给CHF。 
RCP根据用户签约数据、用量数据、用量状态数据，重新进行策略决策，并通过Npcf_SMPolicyControl_UpdateNotify request消息将新的规则下发给SMF，同时生成用量状态变化日志。 
SMF执行最新的策略，并向RCP发送Npcf_SMPolicyControl_UpdateNotify response消息。 
######## 策略日志 
在PDU会话建立流程中，SMF确定需要向RCP请求PDU会话策略控制，或者SMF上报订阅事件，RCP进行策略决策，并生成策略日志，支持的Gx承载策略、Gx业务策略、N7会话策略和N7业务策略上报，流程如[图4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__2cd49b98-377f-4ad9-a7fe-0701a310bdee)所示。
图4  策略日志
[]images/1627868482310.png)
流程说明如下： 
用户通过UE发起建立PDU会话请求。 SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。 
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR通过Sp-UDA消息，返回用户签约信息给RCP。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过Sp'-UDA消息，返回用户用量信息给RCP。 
RCP根据用户签约、用户用量、接入信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create response消息发送给SMF，同时生成策略日志。 
当RCP订阅的事件发生时，SMF发送Npcf_SMPolicyControl_Update request消息给RCP，其中携带该事件的相关信息。 
RCP根据上报的用户的签约数据、用量数据、会话数据，重新进行策略决策，生成新的规则，通过Npcf_SMPolicyControl_Update response消息将新的规则下发给SMF，同时生成策略日志。 
######## 业务历史日志 
RCP感知到用户的配额状态发生变更，记录用户配额状态变更信息到业务历史日志，流程如[图5](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__65d18596-6935-4865-a51b-832590b132e6)所示。
图5  业务历史日志
[]images/1627868585784.png)
流程说明如下： 
用户在某时刻（2021-07-21 07:00:00）通过UE发起发起建立PDU会话请求。 SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。 
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR将用户签约信息通过Sp-UDA消息返回给RCP。UDA消息中携带UserStatus-Amend-Record消息，其中UserStatus-Amend-Value为2，Valid-Time的Valid-Time-End值为2021-07-21 06:00:00。表示用户此时用量配额已经耗尽（本流程中假设用户用量为日用量，日周期清零）。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过UDA消息返回用户用量信息给RCP。 
RCP根据用户签约、用户用量、接入信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create响应消息发送给SMF，同时生成用户配额耗尽的业务历史日志。 
SMF在某时刻（2021-07-22 00:01:00）发起Npcf_SMPolicyControl_Update更新会话信息，RCP根据用户更新信息重新决策。由于用户用量是日用量，当前时间在零点之后，所以用量需要清零，此时会触发一条用户配额清零的业务历史日志。 
RCP根据重新决策的结果返回Npcf_SMPolicyControl_Update response消息给SMF。 
######## 事件日志 
SMF上报订阅事件后，RCP记录该事件相关信息到事件日志，流程如[图6](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__22372169-7771-4c24-99d1-24f4d6af31b0)所示。
图6  事件日志
[]images/1627868981430.png)
流程说明如下： 
用户通过UE发起建立PDU会话请求。 SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。 
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR通过Sp-UDA消息，返回用户签约信息给RCP。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过Sp'-UDA消息，返回用户用量信息给RCP。 
RCP根据用户签约、用户用量、接入信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create response消息发送给SMF。 
当RCP订阅的事件发生时，SMF发送Npcf_SMPolicyControl_Update request消息给RCP，其中携带该事件的相关信息。 
RCP根据上报的用户的签约数据、用量数据、会话数据，重新进行策略决策，生成新的规则，通过Npcf_SMPolicyControl_Update response消息将新的规则下发给SMF，同时生成事件日志。 
######## 用量穿越日志 
SMF上报用量后，RCP累计用量值，当累计的用量值穿越阈值时生成用量穿越日志，流程如[图7](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__391e36dd-d846-4ba9-b6a7-b2807cf9d875)所示。
图7  用量穿越日志
[]images/1627869056230.png)
流程说明如下： 
用户通过UE发起建立PDU会话请求。 SMF通过N7接口向RCP发送Npcf_SMPolicyControl_Create request消息请求建立会话，其中携带用户的用户标识、接入信息等会话信息。 
RCP根据用户标识向SPR发送Sp-UDR消息，获取用户的签约信息。 
SPR通过Sp-UDA消息，返回用户签约信息给RCP。 
RCP根据用户标识向SPR发送Sp'-UDR消息，获取用户的用量信息。 
SPR通过Sp'-UDA消息，返回用户用量信息给RCP。 
RCP根据用户签约、用户用量、接入信息等进行策略决策，并将决策结果通过Npcf_SMPolicyControl_Create resopnse消息发送给SMF。 
当RCP订阅的用量上报事件发生时，SMF发送Npcf_SMPolicyControl_Update request消息给RCP，其中携带用量信息。 
RCP根据上报的用户的签约数据、用量数据、会话数据，重新进行策略决策，生成新的规则，通过Npcf_SMPolicyControl_Update response消息将新的规则下发给SMF。当累计用量穿越阈值时，生成用量穿越日志。 
######## 通知日志 
RCP发送短信通知之后，生成通知日志，流程如[图8](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zbe0b8ea3a1fb415290b3bbcf82d0697e__cc6c09a4-74f3-4cda-99b3-9deb117e3be0)所示。
图8  短信通知日志
[]images/1627869134386.png)
流程说明如下： 
SMF和RCP建立PDU会话。 
RCP进行短信策略决策，并发送短信通知给短信中心。 
RCP生成短信通知日志。 
######## 文件传输及传输日志 
RCP作为SFTP服务端RCP作为SFTP服务端，第三方日志分析网元作为客户端主动到RCP下载各类日志文件，传输流程如图9所示。图9  SFTP服务器方式流程说明如下：RCP开启SFTP服务端。日志分析网元开启SFTP客户端。日志分析网元发送SFTP GET消息，从RCP下载日志文件。 
RCP作为SFTP客户端日志分析网元作为SFTP服务端， RCP作为客户端将日志文件上传至服务器，同时生成文件传输日志，流程如图10所示。图10  SFTP客户端方式流程说明如下：日志分析网元开启SFTP服务端。RCP开启SFTP客户端。RCP发送SFTP PUT消息，向日志分析网元上传日志文件。传输结束后，RCP生成文件传输日志。 说明：RCP作为SFTP客户端时，目前支持对接最多5个SFTP服务器。 
##### 系统影响 
开启该特性，需要部署Npcf_LOG服务，增加系统资源占用。 
Npcf_SMPolicyControl服务按照日志上报的配置，负责日志消息编码，并将消息发往Npcf_LOG服务，增加业务负荷，延长业务流程完成时间。 
Npcf_LOG服务负责日志消息解码，并将消息写入文件，保存到磁盘，增加磁盘空间占用。 
##### 应用限制 
该特性只支持通过SFTP服务对外提供日志文件。 
RCP作为SFTP服务端，存在多个Npcf_LOG服务实例时，SFTP客户端需要对每个实例上的SFTP服务端口进行轮询，获取全部日志文件。 
##### 特性交互 
该特性是FL-07-01-002 中移策略报表
特性的前提。
中移策略报表功能是运营商（中国移动）基于日志基本功能的定制化功能，要求在此场景下输出策略日志、通知日志和业务历史日志，其他类型日志不需要输出，日志输出功能关闭。 
中移策略报表应用场景需要开启“1122 中移报表开关
”，业务内部实现时会自动开启指定日志上报字段，其他日志字段自动关闭。
当前中移策略报表场景需要打开字段和日志字段输出顺序参见[表5](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newd7e2a82627de404a948f355823d1cb17__29d69b80-f098-4e01-8e05-88da6d259cc7)。
日志类型|默认开启的字段以及输出顺序
---|---
策略日志|记录类型、记录时间、IMSI、MSISDN、日志事件、策略名、Gx应用标识、套餐名称、ULI、策略合并标识、用户配额状态、业务配额状态、套餐配额、IMEI、用户类型。
通知日志|记录类型、记录时间、IMSI、MSISDN、发送状态、策略名、套餐名称。
业务历史日志|MSISDN、记录时间、事件类型、套餐名称。
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
IETF|RFC 4251|The Secure Shell (SSH) Protocol Architecture
##### 特性能力 
能力名称|指标
---|---
对端SFTP服务器最大个数|5 个
上传SFTP服务器时间间隔最大值|60 分钟
生成的日志文件大小最大值|1024 M
日志文件保存时间最大值|30 天
##### 可获得性 
####### 版本要求及变更记录 
编号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性需要申请了License许可后，运营商才能获得该特性的服务。 
该特性对应License文件中的项目为LIC_RCP_FUNC_SYSLOG，此项目显示为ON，表示ZXUN RCP支持策略日志特性。 
####### 对其他网元的要求 
策略日志特性要求采集策略日志的第三方分析网元支持SFTP文件传输协议，RCP网元可以作为SFTP服务器或者SFTP客户端提供策略日志文件。 
RCP作为客户端时，需要第三方分析网元启用SFTP服务器，并提供SFTP服务器信息，支持RCP能够正常访问对端的SFTP服务器。 
RCP作为服务端时，需要第三方分析网元提供SFTP客户端信息，RCP配置允许该客户端访问本端SFTP服务器。 
##### O&M相关 
####### 命令 
配置项命令项命令名称描述日志基本参数配置SET POLICYLOG修改日志基本参数。SHOW POLICYLOG查询日志基本参数。日志上报配置SET LOGRPT修改日志上报配置。SHOW LOGRPT查询日志上报配置。事件日志配置ADD  LOGEVENT增加事件日志配置。SET  LOGEVENT修改事件日志配置。DEL  LOGEVENT删除事件日志配置。SHOW  LOGEVENT查询事件日志配置。对端日志SFTP服务器配置ADD  LOGSFTPSRV增加对端日志SFTP服务器。SET  LOGSFTPSRV修改对端日志SFTP服务器。DEL  LOGSFTPSRV删除对端日志SFTP服务器。SHOW  LOGSFTPSRV查询对端日志SFTP服务器。本端日志SFTP客户端配置ADD  LOGSFTPCLT新增本端日志SFTP客户端。SET LOGSFTPCLT修改本端日志SFTP客户端。DEL LOGSFTPCLT删除本端日志SFTP客户端。SHOW LOGSFTPCLT查询本端日志SFTP客户端。本端日志SFTP服务器配置ADD LOCLOGSFTPSRV增加本端日志SFTP服务器。SET LOCLOGSFTPSRV修改本端日志SFTP服务器。DEL LOCLOGSFTPSRV删除本端日志SFTP服务器。SHOW LOCLOGSFTPSRV查询本端日志SFTP服务器。 
动态管理命令项命令名称描述查询统计SHOW_STAT查询LOG服务内部统计。关闭所有文件   CLOSE LOGFILE关闭正在写入的所有日志文件。删除指定时间之前的日志文件DELETE LOGFILE删除指定时间之前的日志文件。重新加载上传文件RELOAD_ULFILE将待上传的日志文件重新加入SFTP的上传队列。查询上传相关信息SHOW_UPLOAD_INFO查询SFTP传输信息。关闭SFTP上传结果文件CLOSE_SFTP_TRANS_LOG关闭SFTP上传结果记录文件。 
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警与通知 
告警与通知|描述
---|---
2987525121 磁盘剩余空间不足一级告警|当日志模块所在的磁盘剩余空间低于系统配置的磁盘剩余空间一级告警阈值时，上报本告警。
2988573697 磁盘剩余空间不足二级告警|当日志模块所在的磁盘剩余空间低于系统配置的磁盘剩余空间二级告警阈值时，上报本告警。
2989622273 磁盘剩余空间不足三级告警|当日志模块所在的磁盘剩余空间低于系统配置的磁盘剩余空间三级告警阈值时，上报本告警。
2986738690 SFTP上传失败|系统上传文件至SFTP服务器出现异常时，上报本告警。
2986738691 SFTP客户端未配置|系统配置了对端SFTP服务端，但未配置本端SFTP客户端时，上报本告警。
2986738692 SFTP服务端开启失败|本端SFTP服务端开启失败或超时时，上报本告警。
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置RCP为SFTP服务器 
###### 配置说明 
ZXUN RCP增加一个日志服务，配置本端为SFTP服务器，对外提供日志数据服务，供第三方日志分析网元主动下载日志文件。 
###### 配置前提 
已规划配置好ZXUN RCP与第三方日志分析网元的互联数据，包括SFTP服务器/客户端地址、端口和账号信息等。 
###### 配置过程 
RCP作为SFTP服务端的配置流程如[图1](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#zd493f0fa6a53432c9ed1ce42d04c11f6__3cd8a39c-5513-4ff1-bae6-d63ec6a11337)所示。
图1  SFTP服务端配置流程
[]images/%E7%AD%96%E7%95%A5%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0服务。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改系统全局变量。
执行[SHOW PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787193.html)命令，查询基本的套餐信息。
执行[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html)命令，修改日志基本参数。
执行[SET LOGRPT](../../Npcf_PolicyManagement\zh-CN\mml\1787600.html)命令，修改日志上报配置。
执行[ADD LOGEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787092.html)命令，新增事件日志配置。
执行[ADD LOCLOGSFTPSRV](../../Npcf_PolicyManagement\zh-CN\mml\1787698.html)命令，配置本端日志SFTP服务器。
###### 配置实例 
######## 场景说明 
开通日志服务功能，RCP作为SFTP服务器向第三方日志分析网元提供日志数据。 
配置本地SFTP服务器。 
启用SFTP服务器功能。 
######## 数据规划 
全局变量开关编号取值1044用量穿越日志开关，配置为1。1045策略日志开关，配置为1。1046事件日志开关,配置为1。1047用量日志开关，配置为1。1048通知日志开关，配置为1。1049业务历史日志开关，配置为1。1125策略日志记录无策略上线和下线事件开关，配置为1。 
SFTP服务器数据规划RCP作为SFTP服务器，需要规划SFTP服务器IP地址、端口、账号、根目录等信息，SFTP服务器IP地址使用LOG平面地址。日志服务器服务器IP地址服务器起始端口SFTP账户信息根目录110.6.202.19021用户名/密码：rcp/rcp/IDE0 
######## 配置步骤 
配置全局变量。 
开启记录各类日志文件开关。 
配置命令： 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1044,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1045,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1046,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1047,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1048,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1049,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1125,CURVAL="1",EXTFLAG=0
参数取值参见[表1](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__8c77168a-5821-40c8-bf66-f0e949f1f666)，根据实际情况来设定。
参数|说明
---|---
IDX|开关编号。
CURVAL|开关值。0：关闭1：开启 。
EXTFLAG|是否为隐藏开关。0：隐藏开关。1：非隐藏开关。
配置规则开关。 
开启规则的记录日志开关。 
配置命令： 
[SET DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787306.html):NAME="1",LOGFLAG="ON"
参数取值参见[表2](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__30943000-d68a-429a-85b1-f89f826e02fb)，根据实际情况来设定，哪些规则发生需要记录日志文件，将其日志开关打开。
参数|说明
---|---
NAME|规则名称。
LOGFLAG|日志开关：ON：开启。OFF：关闭。
查询套餐基本配置。 
执行[SHOW PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787193.html)命令，查询套餐基本配置，确认其套餐名称需要对齐PUDR套餐信息配置中（执行SHOW PUDRPAKINFO查询）的套餐名称。
配置数据采集。 
配置日志基本参数。 
配置命令： 
[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html):FILESIZE="300",FILECYCLE="7",ALARMSIZE="10",ALARMSIZETWO="20",ALARMSIZETHREE="30",UPLOAD="5",HEADERFLAG="OFF"
参数取值参见[表3](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__2c050b7e-d5e6-4bf7-a27d-0a45b9db8846)，根据实际情况来设定，若无特殊要求可保持默认值。
参数|说明
---|---
FILESIZE|文件大小（MB），默认为300。
FILECYCLE|文件保存周期（天） ，默认为7。
ALARMSIZE|磁盘剩余空间（GB）一级告警，默认为10。
ALARMSIZETWO|磁盘剩余空间（GB）二级告警，默认为20。
ALARMSIZETHREE|磁盘剩余空间（GB）三级告警，默认为30。
ALARMSIZERESUME|磁盘剩余空间告警恢复阈值(GB) ，默认为40。
UPLOAD|上传服务器时间间隔（分），默认为5。
HEADERFLAG|日志题头开关：ON：包含。OFF：不包含 。默认为OFF。
配置日志上报。 
用于配置哪些策略变量记录日志。 
配置命令： 
[SET LOGRPT](../../Npcf_PolicyManagement\zh-CN\mml\1787600.html):LOGTYPE="USGLOG",CATEGORY="USER",NAME="BILL_TYPE",RPTFLAG="OFF",DESCP="付费类型"
参数取值参见[表4](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__8b0de62a-b39b-4bf7-84c2-694245eb1370)，根据实际情况来设定，需要将哪个策略变量记录日志，则将其上报开关打开。
参数|说明
---|---
LOGTYPE|日志类型：用量日志、事件日志、策略日志、业务历史日志、通知日志、用量穿越日志。
CATEGORY|策略变量类别：用户信息类、接入信息类、IP-CAN会话信息类、IP-CAN承载信息类、用量上报信息、会话决策、黑白名单、承载决策、业务决策、短信决策、公共信息。
NAME|策略变量名称。
RPTFLAG|上报开关：ON：该变量记入日志。OFF：该变量不记入日志。
DESCP|策略变量描述，本字段为最终输出日志文件（.csv文件）的列名。
配置事件日志。 
用于配置哪些事件记录日志。 
配置命令： 
[ADD LOGEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787092.html):EVENT="Tethering-Change",FLAG="ON"
参数取值参见[表5](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__c4011e8a-a867-4659-9a46-77bd5264851b)，根据实际情况来设定，需要将哪个事件记录日志，则增加该事件的事件日志配置。
参数|说明
---|---
EVEN|事件。
FLAG|日志开关：ON：记录该事件日志。OFF：不记录该事件日志。
配置本端日志SFTP服务器。 
配置命令： 
[ADD LOCLOGSFTPSRV](../../Npcf_PolicyManagement\zh-CN\mml\1787698.html):SERVERIPADDR="10.6.202.1",SERVERPORT=9021,USERNAME="rcp",PWD="rcp",VPNID=0,DIRECTORY="/IDE0"
参数取值参见[表6](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z68bfb2d1e3fb42e98441efbbe7e35bb7__dbb65099-92f0-472a-b4d6-9312faa0ec8e)。
参数|说明
---|---
SERVERIPADDR|服务器IP地址。
SERVERPORT|服务器起始端口。
USERNAME|用户名。
PWD|密码。
VPNID|VPNID。
DIRECTORY|SFTP服务器根目录。
######## 配置脚本 
//全局变量配置 
SET SYS GLOBPARA:IDX=1044,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1045,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1046,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1047,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1048,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1049,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1125,CURVAL="1",EXTFLAG=0 
//规则开关配置 
SET DM RULE:NAME="1",LOGFLAG="ON" 
//数据采集配置 
SET POLICYLOG:FILESIZE="300",FILECYCLE="7",ALARMSIZE="10",ALARMSIZETWO="20",ALARMSIZETHREE="30",UPLOAD="5",HEADERFLAG="OFF"
SET LOGRPT:LOGTYPE="USGLOG",CATEGORY="USER",NAME="BILL_TYPE",RPTFLAG="OFF",DESCP="付费类型"
ADD LOGEVENT:EVENT="Tethering-Change",FLAG="ON" 
ADD LOCLOGSFTPSRV:SERVERIPADDR="10.6.202.1",SERVERPORT=9021,USERNAME="rcp",PWD="rcp",VPNID=0,DIRECTORY="/IDE0"
##### 配置RCP为SFTP客户端 
###### 配置说明 
ZXUN RCP增加一个日志服务，配置本端为SFTP客户端，对外提供日志数据服务，向第三方日志分析网元上传日志文件。 
###### 配置前提 
已规划配置好ZXUN RCP与第三方日志分析网元的互联数据，包括SFTP服务器/客户端地址、端口和账号信息等。 
###### 配置过程 
RCP作为SFTP客户端配置流程如[图2](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#zb620f4b1bc694ebb9f1fa0961f16277b__7fa12902-9933-4b48-91f4-54b8bf38a1f9)所示。
图2  SFTP客户端配置
[]images/%E7%AD%96%E7%95%A5%E6%97%A5%E5%BF%97%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0服务。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改系统全局变量。
执行[SHOW PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787193.html)命令，查询基本的套餐信息。
执行[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html)命令，修改日志基本参数。
执行[SET LOGRPT](../../Npcf_PolicyManagement\zh-CN\mml\1787600.html)命令，修改日志上报配置。
执行[ADD LOGEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787092.html)命令，新增事件日志配置。
执行[ADD LOGSFTPSRV](../../Npcf_PolicyManagement\zh-CN\mml\1787081.html)命令，配置对端日志SFTP服务器。
执行[ADD LOGSFTPCLT](../../Npcf_PolicyManagement\zh-CN\mml\1787097.html)命令，配置本端日志SFTP客户端。
###### 配置实例 
######## 场景说明 
开通日志服务功能，RCP作为SFTP客户端，向第三方日志分析网元上传日志文件。 
配置本地SFTP客户端。 
配置对端SFTP服务器。 
启用SFTP客户端功能。 
######## 数据规划 
全局变量开关编号取值1044用量穿越日志开关，配置为1。1045策略日志开关，配置为1。1046事件日志开关，配置为1。1047用量日志开关，配置为1。1048通知日志开关，配置为1。1049业务历史日志开关，配置为1。1125策略日志记录无策略上线和下线事件开关，配置为1。 
SFTP客户端数据规划RCP作为SFTP客户端，需要规划SFTP客户端的IP地址、端口、每SC端口数，SFTP客户端IP地址使用LOG平面地址。本端SFTP客户端IP客户端最小端口对端SFTP服务器IP服务器端口对端SFTP服务器账户信息10.6.202.12210.6.202.1022用户名/密码：sftp/sftp 
######## 配置步骤 
配置全局变量。 
开启记录日志开关。 
配置命令： 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1044,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1045,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1046,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1047,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1048,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1049,CURVAL="1",EXTFLAG=1
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1125,CURVAL="1",EXTFLAG=0
参数取值参见[表7](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__7c1e77ff-8758-4a44-8754-bbd90c3a0ab3)，根据实际情况来设定。
参数|说明
---|---
IDX|开关编号。
CURVAL|开关值。0：关闭1：开启 。
EXTFLAG|是否为隐藏开关。0：隐藏开关。1：非隐藏开关。
配置规则开关。 
开启规则记录日志开关。 
配置命令： 
[SET DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787306.html):NAME="1",LOGFLAG="ON"
参数取值参见[表8](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__8eeebbf6-34ad-4fdf-811a-fe8863f5e375)，根据实际情况来设定，哪些规则发生需要记录日志，将其日志开关打开。
参数|说明
---|---
NAME|规则名称。
LOGFLAG|日志开关：ON：开启。OFF：关闭。
查询套餐基本配置。 
执行[SHOW PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787193.html)命令，检查套餐基本配置的套餐名称，需要对齐PUDR套餐信息配置（执行SHOW PUDRPAKINFO查询）的套餐名称。
配置数据采集。 
配置日志基本参数。 
配置命令： 
[SET POLICYLOG](../../Npcf_PolicyManagement\zh-CN\mml\1787348.html):FILESIZE="300",FILECYCLE="7",ALARMSIZE="10",ALARMSIZETWO="20",ALARMSIZETHREE="30",UPLOAD="5",HEADERFLAG="OFF"
参数取值参见[表9](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__cde7c242-cdaf-441e-b05a-616d6ed2eefb)，根据实际情况来设定，若无特殊要求可保持默认值。
参数|说明
---|---
FILESIZE|文件大小（MB），默认为300。
FILECYCLE|文件保存周期（天） ，默认为7。
ALARMSIZE|磁盘剩余空间（GB）一级告警，默认为10。
ALARMSIZETWO|磁盘剩余空间（GB）二级告警，默认为20。
ALARMSIZETHREE|磁盘剩余空间（GB）三级告警，默认为30。
ALARMSIZERESUME|磁盘剩余空间告警恢复阈值(GB) ，默认为40。
UPLOAD|上传服务器时间间隔（分），默认为5。
HEADERFLAG|日志题头开关：ON：包含。OFF：不包含 。默认为OFF。
配置日志上报。 
用于配置哪些策略变量记录日志。 
配置命令： 
[SET LOGRPT](../../Npcf_PolicyManagement\zh-CN\mml\1787600.html):LOGTYPE="USGLOG",CATEGORY="USER",NAME="BILL_TYPE",RPTFLAG="OFF",DESCP="付费类型"
参数取值参见[表10](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__54d9a815-f218-47d4-8b6f-0dad44a37446)，根据实际情况来设定，需要将哪个策略变量记录日志，则将其上报开关打开。
参数|说明
---|---
LOGTYPE|日志类型：用量日志、事件日志、策略日志、业务历史日志、通知日志、用量穿越日志。
CATEGORY|策略变量类别：用户信息类、接入信息类、IP-CAN会话信息类、IP-CAN承载信息类、用量上报信息、会话决策、黑白名单、承载决策、业务决策、短信决策、公共信息。
NAME|策略变量名称。
RPTFLAG|上报开关：ON：该变量记入日志。OFF：该变量不记入日志。
DESCP|策略变量描述，本字段为最终输出日志文件（.scv文件）的列名。
配置事件日志。 
用于配置哪些事件记录日志。 
配置命令： 
[ADD LOGEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787092.html):EVENT="Tethering-Change",FLAG="ON"
参数取值参见[表11](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__35ce9be0-ddf2-459e-8899-caf8bb1f7960)，根据实际情况来设定，需要将哪个事件记录日志，则增加该事件的事件日志配置。
参数|说明
---|---
EVEN|事件。
FLAG|日志开关：ON：记录该事件的日志。OFF：不记录该事件的日志。
配置对端日志SFTP服务器。 
用于配置对端日志SFTP服务器信息。目前支持的最多对端服务器数目为5个。 
配置命令： 
[ADD LOGSFTPSRV](../../Npcf_PolicyManagement\zh-CN\mml\1787081.html):ID=1,SERVERIPADDR="10.6.202.10",SERVERPORT=22,USERNAME="sftp",PWD="sftp",VPNID=0,POLICYDIR="policylog/",USAGEDIR="usglog/",NOTICEDIR="noticelog/",EVENTDIR="eventlog/",SERVHISDIR="servicehislog/",RULECFGDIR="ruleconfig/",UPLOADDIR="uploadlog/",USAGECROSSDIR="usagecrosslog/"
参数取值参见[表12](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__64b79b68-980b-4cb6-990b-b145709c0abe)。
参数|说明
---|---
ID|对端日志SFTP服务器配置编号。
SERVERIPADDR|对端SFTP服务器IP地址。
SERVERPORT|对端SFTP服务器服务端口。
USERNAME|用户名。
PWD|密码。
VPNID|VPNID。
POLICYDIR|策略日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：policylog/。
USAGEDIR|用量日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：usglog/。
NOTICEDIR|通知日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：noticelog/。
EVENTDIR|事件日志上传到SFTP服务器路径，必须使用相对路径，支持中文。例如：eventlog/。
SERVHISDIR|业务历史日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：servicehislog/。
RULECFGDIR|规则配置记录上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：ruleconfig/
UPLOADDIR|传输日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：uploadlog/。
USAGECROSSDIR|用量穿越日志上传到SFTP服务器的路径，必须使用相对路径，支持中文。例如：usagecrosslog/。
配置本端日志SFTP客户端。 
配置命令： 
[ADD LOGSFTPCLT](../../Npcf_PolicyManagement\zh-CN\mml\1787097.html):CLIENTIPADDR="10.6.202.1",CLIENTPORT=31,PORTNUM=10,CLIENTENCRY="AES",CLIENTHASH="SHA1",VPNID=0
参数取值参见[表13](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z0912a8a49134461e985572db1cac5076__6fbd2bf3-f235-480c-a31a-df746e46a93b)。
参数|说明
---|---
CLIENTIPADDR|本端SFTP客户端的IP地址。
CLIENTPORT|SFTP客户端端口号的最小值。
PORTNUM|SFTP客户端每个SC上的端口数。
CLIENTENCRY|客户端加密算法。
CLIENTHASH|客户端HASH算法。
VPNID|VPNID。
######## 配置脚本 
//全局变量配置 
SET SYS GLOBPARA:IDX=1044,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1045,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1046,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1047,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1048,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1049,CURVAL="1",EXTFLAG=1 
SET SYS GLOBPARA:IDX=1125,CURVAL="1",EXTFLAG=0 
//规则开关配置 
SET DM RULE:NAME="1",LOGFLAG="ON" 
//数据采集配置 
SET POLICYLOG:FILESIZE="300",FILECYCLE="7",ALARMSIZE="10",ALARMSIZETWO="20",ALARMSIZETHREE="30",UPLOAD="5",HEADERFLAG="OFF"
SET LOGRPT:LOGTYPE="USGLOG",CATEGORY="USER",NAME="BILL_TYPE",RPTFLAG="OFF",DESCP="付费类型"
ADD LOGEVENT:EVENT="Tethering-Change",FLAG="ON" 
ADD LOGSFTPCLT:CLIENTIPADDR="10.6.202.1",CLIENTPORT=31,PORTNUM=10,CLIENTENCRY="AES",CLIENTHASH="SHA1",VPNID=0
ADD LOGSFTPSRV:ID=1,SERVERIPADDR="10.6.202.10",SERVERPORT=22,USERNAME="sftp",PWD="sftp",VPNID=0,POLICYDIR="policylog/",USAGEDIR="usglog/",NOTICEDIR="noticelog/",EVENTDIR="eventlog/",SERVHISDIR="servicehislog/",RULECFGDIR="ruleconfig/",UPLOADDIR="uploadlog/",USAGECROSSDIR="usagecrosslog/"
##### 测试用例 
测试项目|日志文件生成——用量日志、策略日志、通知日志
---|---
预置条件|RCP系统正常运行，LOG服务正常部署。网管配置完成网管基本配置。系统加载了支持策略日志上报的License。配置SFTP服务。1045、1047和1048开关打开。日志上报配置下所有与用量相关的字段都置为ON。GUI配置承载规则：当套餐1每月流量 > 200M，下发承载Qos1，Log Flag=ON。会话规则：当组套餐1有效期流量 > 签约值（300M），下发APN带宽1，Log Flag=ON。预下发规则：预下发业务1001、1002。业务规则：当 Gx Application ID=1001& 套餐1业务1每日时长>2h，下发业务规则1，Log Flag=ON。通知规则：当组套餐1业务2每周单击次数 > 10次，下发Notice1，LogFlag=ON。配置业务1和业务2的上线业务规则。配置相应的用量监控规则。规则中引用的所有用量的日志开关都打开。
测试过程|用户上线，SPR返回用户套餐1业务1。组上线，SPR返回组套餐1业务2，SPR未返回用量。N7 Update/Gx CCR-U上报用量，其中：会话流量 100M、业务1时长1h、业务2单击次数3次。N7 Update/Gx CCR-U再次上报用量，其中：会话流量 300M、业务1时长2h、业务2单击次数8次。使用SFTP工具获取日志文件。检查日志内容中的每一个字段。
通过准则|用户上线成功，无日志生成。N7 Update/Gx CCR-U上报用量，生成3条用量日志。N7 Update/Gx CCR-U再次上报用量，下发Qos1、APN带宽1、业务规则1和Notice1，生成3条用量日志，4条策略日志。能够通过SFTP获取压缩后的日志文件，且解压缩后，文件可以正常打开。检查用量日志中的字段正常显示，且显示内容正确。LOG服务中无异常失败观察和告警。
### 缩略语 
### 缩略语 
#### AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
#### APN 
Access Point Name接入点名称
#### CHF 
Charging Function计费功能
#### EDR 
Event Detail Record事件详细记录
#### OCS 
Online Charging System在线计费系统
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### SFTP 
Secure File Transfer Protocol安全文件传输协议
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### UDR 
Unified Data Repository统一数据存储
#### UE 
User Equipment用户设备
### ZUF-59-51-051 N15接口 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|说明
---|---
AM策略|AM策略指的是PCF下发给AMF的，用于AMF实施接入和移动性管理的控制策略。
UE策略|UE策略指的是PCF通过AMF下发给UE的URSP和ANDSP。
##### 描述 
####### 特性定义 
N15接口是AMF和PCF之间的接口，用于AMF和PCF之间的消息交互。AMF可以通过N15接口向PCF请求AM策略控制和UE策略控制，或上报AM/UE策略控制相关事件。PCF可以通过N15接口向AMF推送最新的AM/UE策略，并订阅AM/UE策略控制相关事件。
####### 背景知识 
N15接口遵循3GPP TS 29.507协议，采用基于HTTP/2+ JSON的服务化接口。AMF通过N15接口调用PCF的Npcf_AMPolicyControl和Npcf_UEPolicyControl服务，PCF通过N15接口调用AMF的Namf_Communication服务。 
##### 应用场景 
N15接口用于AM策略控制和UE策略控制。
接入和移动性策略控制应用场景运营商需要对业务区域限制实施动态策略控制：例如对享有大额度优惠流量的家庭CPE，限制其只能在家庭周边基站接入，防止用户在非允许区域使用此类CPE上网而可能导致的网络拥塞。并且，当某个CPE每月的优惠流量耗尽时，缩小其允许区域，扩大其非允许区域，以限制该CPE继续使用业务，直至用户购买新的优惠流量或在下个账期开始时自动恢复至原来的业务区域限制。运营商需要对RFSP Index实施动态策略控制：例如PCF根据RAN拥塞信息动态调整RFSP Index并传递给RAN，RAN指示UE选择该RFSP Index对应的无线接入方式和频率进行数据传输。 
URSP策略控制应用场景PCF可根据用户签约、接入网情况为UE下发URSP策略，包括如下场景：PCF能基于用户签约（套餐、用户类型等）、接入类型（Access Type）、无线接入类型（RAT）、跟踪区域（TAC）等条件决策URSP策略。PCF可下发基于各种业务流的URSP策略，可通过OS ID、地址类型、协议、端口、流标签等参数识别业务流。PCF可下发NSSP策略，为不同应用提供不同切片选择，UE根据不同的NSSP选择不同的应用专网，提供更好保障和用户体验。PCF可下发SSCMSP策略，为不同应用提供不同业务连续性策略，保证不同用户不同应用的会话业务连续性需求。PCF可下发DNN选择策略，为不同应用提供不同DNN，保证不同应用通过不同APN接入。PCF可下发PDU会话类型选择策略，UE可为不同应用选择建立不同类型的PDU会话，满足应用多样性需求。PCF可下发非无缝卸载策略，UE可将部分应用卸载到非3GPP接入的数据网。PCF可下发接入类型优先策略，UE在为部分应用建立PDU会话时，指示优选的接入类型。 
##### 客户收益 
受益方|受益描述
---|---
运营商|通过AM策略可以加快用户业务接通，或对UE实施移动性限制。通过UE策略可以指导UE选择接入网及PDU会话。
用户|加快用户业务接通。选择合适的业务路由。
##### 实现原理 
###### 系统架构 
本特性涉及的系统架构如[图1](1569726753347.html#z6e6b0b870d194ae7853059babfff84ad__0cb8e532-8cac-4280-9fe8-5373a7f1677d)所示。RCP作为PCF，N15接口为AMF和RCP之间的接口。
图1  系统架构
[]images/5GC%E7%89%B9%E6%80%A7-%E6%9E%B6%E6%9E%84%E5%9B%BE-PCF.png)
###### 涉及的网元 
网元|描述
---|---
RCP|向AMF提供AM策略和UE策略，并订阅相关事件。
AMF|执行PCF提供的AM策略，向UE传递PCF下发的UE策略，并向PCF上报相关事件。
###### 协议栈 
AMF与PCF间的N15接口协议栈如下图所示。
图2  N15接口协议栈
[]images/1569210072973.png)
AMF和PCF通过服务操作的调用，实现消息交互。AMF和PCF在N15接口提供的服务操作参见下表。 
NF|服务|操作|操作语义|说明
---|---|---|---|---
PCF|Npcf_AMPolicyControl|Create|Request/Response|AMF向PCF请求建立AM策略关联，PCF在响应中下发AM策略，并订阅AM策略控制相关事件。
Update|PCF|Npcf_AMPolicyControl|Request/Response|AMF向PCF上报AM策略控制相关事件，PCF在响应中可能更新AM策略和事件订阅。
Delete|PCF|Npcf_AMPolicyControl|Request/Response|AMF请求PCF删除AM策略关联。
UpdateNotify|PCF|Npcf_AMPolicyControl|Subscribe/Notify|PCF因为内部或外部事件触发，主动向AMF更新AM策略和事件订阅。AM策略更新通知操作不需要显式的订阅操作，在AMF调用Create操作请求PCF建立AM策略关联时，PCF就认为AMF订阅了AM策略更新通知。
PCF|Npcf_UEPolicyControl|Create|Request/Response|AMF向PCF请求建立UE策略关联，PCF在响应中可以订阅UE策略控制相关事件。
Update|PCF|Npcf_UEPolicyControl|Request/Response|AMF向PCF请求更新UE策略关联，PCF在响应中可以更新UE策略控制相关事件订阅。
Delete|PCF|Npcf_UEPolicyControl|Request/Response|AMF请求PCF删除UE策略关联。
UpdateNotify|PCF|Npcf_UEPolicyControl|Subscribe/Notify|PCF因为内部或外部事件触发，主动向AMF更新UE策略控制相关事件订阅。
AMF|Namf_Communication|N1MessageNotify|Subscribe/Notify|AMF从UE收到UE策略信息后通知PCF。
N1MessageSubscribe|AMF|Namf_Communication|Subscribe/Notify|PCF向AMF订阅UE上报的UE策略信息。
N1MessageUnSubscribe|AMF|Namf_Communication|Subscribe/Notify|PCF向AMF取消订阅UE上报的UE策略信息。
N1N2MessageTransfer|AMF|Namf_Communication|Request/Response|PCF通过AMF向UE下发UE策略。
N1N2TransferFailureNotification|AMF|Namf_Communication|Subscribe/Notify|AMF向UE传送UE策略失败后通知PCF。
##### 其他内容 
N15接口的其他内容参见“ZUF-59-53-052 PDU会话策略控制
”和“ZUF-59-53-053 URSP策略控制
”。
#### 特性配置 
#### 特性配置 
N15接口的特性配置参见“ZUF-59-53-052 PDU会话策略控制
”和“ZUF-59-53-053 URSP策略控制
”。
### 缩略语 
### 缩略语 
#### 3GPP 
3rd Generation Partnership Project第三代合作伙伴计划
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### NF 
Network Function网络功能
#### PCF 
Policy Control Function策略控制功能
#### TLS 
Transport Layer Security传输层安全
#### UE 
User Equipment用户设备
### ZUF-59-51-052 N5接口 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
PDU会话|UE通过SMF/UPF和数据网建立的一个连接，用于传输数据报文（Packet Data Unit）。
N7会话|一个UE可以建立多个PDU会话，每个PDU会话建立时，SMF可以通过N7接口向PCF建立一个策略关联，用于获取PDU会话的控制策略，这个策略关联也称为N7会话。因为N7会话和PDU会话是一对一的，所以从PCF角度来看也可以把N7会话视为PDU会话。每个PDU会话建立成功后，SMF为该PDU会话分配IPv4地址或IPv6地址前缀（通常是64bit的前缀），传递给UE，另一方面SMF将其为PDU会话分配的IPv4地址或IPv6地址前缀等相关信息通过N7会话上报给PCF。如果是IPv6地址前缀，UE会在后面拼接上自己的接口地址，构成一个完整的IPv6地址。UE再使用IPv4或IPv6地址传输数据报文，例如访问AF上的特定业务。
N5会话|如果UE访问的AF业务流有特别的传输要求（QoS、路由等），AF可以为此类业务流向PCF请求策略授权，AF通过N5接口向RCP建立一个应用会话，也称为N5会话或AF会话。AF在N5会话中向RCP提供需要做策略授权的业务信息和策略要求（QoS、路由等），并提供UE IP地址，需要RCP根据UE IP地址找到对应的N7会话，这个过程称为“N5会话绑定”。之后PCF根据AF在N5会话中提供的业务信息和策略要求，生成PCC规则，在绑定的N7会话中将这些PCC规则下发给SMF。
AF|应用功能（Application Function），例如各种应用的服务端程序。
策略授权|PCF基于用户签约、运营商策略、网络状况等判断AF对特定业务流的策略要求（QoS、路由等）是否能够被接纳，如果接纳，则生成相应的PCC规则和事件订阅，下发给SMF。
DNAI|数据网接入标识（Data Network Access Identifier），用于SMF选择UPF，UE通过UPF访问数据网中的AF。
QoS|QoS是网络的一种安全机制，是用来解决网络延迟和阻塞等问题的一种技术。当网络过载或拥塞时，QoS能确保重要业务不受延迟或丢弃，同时保证网络的高效运行。
QNC|QoS通知控制（QoS Notification Control）。对于需要提供保障带宽的业务，AF可以通过5GC向接入网订阅QNC事件。当接入网无法满足保障带宽时，会通过5GC上报QNC事件到AF，AF再决定是否维持或调整业务传输。
##### 描述 
####### 定义 
N5接口是AF和PCF之间的接口，用于AF和PCF之间的消息交互。AF通过N5接口向PCF请求策略授权，请求为用户的特定业务应用提供可靠的资源保障。
####### 背景知识 
N5接口遵循3GPP TS 29.514协议，采用基于HTTP/2+JSON的服务化接口，AF通过N5接口调用RCP的Npcf_PolicyAuthorization服务。 
##### 应用场景 
N5接口主要应用场景包括： 
AF请求PCF为特定业务流传输提供QoS保障，例如对VoNR业务音频流和视频流提供QoS保障。 
AF通过PCF的QoS监控，获知特定业务流在UE和UPF间的传输时延，以便AF能监控高可靠低时延业务的传输服务质量。 
AF请求PCF为特定业务流传输提供特定路由，例如分流到本地网络以减少时延。具体参考“ZUF-59-55-052 AF影响业务路由”。 
AF请求PCF将特定业务流标记为赞助业务，单独做用量监控，及实施免费的计费策略，例如视频广告类业务。具体参考“ZUF-59-55-009 赞助业务”。 
##### 客户收益 
受益方|受益描述
---|---
运营商|AF业务按需提供QoS保障和业务路由，提升用户体验，增加运营商收益。赞助业务可以对用户免费，对赞助商收费，拓展了运营商的运营手段。AF通过QoS监控能及时感知高可靠低时延业务的传输服务质量。
终端用户|访问AF业务能够获得更好的用户体验。可以免费使用赞助业务。

##### 实现原理 

###### 系统架构 
本特性所涉及的系统架构如下图所示，RCP作为PCF，N5接口为AF和RCP之间的接口。
N5接口是5GC引入的基于HTTP/2协议的服务化接口，用于AF调用RCP的Npcf_PolicyAuthorization服务的相关操作，为特定业务向RCP请求策略授权，这种AF一般是运营商自己部署的AF。 
N30接口是NEF和RCP之间的接口，第三方AF可以调用NEF的相关服务操作，触发NEF调用RCP的Npcf_PolicyAuthorization服务的相关操作。 
即RCP的Npcf_PolicyAuthorization服务操作在N5接口和N30接口都可以被调用。 
AF和RCP间也可以使用传统的基于diameter协议的Rx接口，Rx接口和N5接口都可以用于AF为特定业务向RCP请求策略授权，N5接口相比Rx接口引入了一些5G新特性，例如AF影响业务路由。 
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|描述
---|---
SMF|向RCP提供PDU会话信息。从RCP获取PDU会话策略，下发给UPF执行。
RCP|作为PCF，根据运营商的策略配置，结合周边NF的输入信息，进行策略决策。向AMF提供接入和移动性策略，以及通过AMF向UE提供UE策略。向SMF提供PDU会话策略。对AF/NEF业务进行策略授权。
AF|向RCP提供应用层的业务信息和策略控制要求（QoS、路由等），请求RCP进行策略授权。
NEF|向第三方AF开放5GC策略控制能力。对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
UDR/SPR|向RCP提供策略签约信息，并允许RCP将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
###### 协议栈 
AF和PCF间的N5接口协议栈如下图所示：
[]images/%E5%8D%8F%E8%AE%AE%E6%A0%88.jpg)协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。
AF和PCF通过服务操作的调用，实现消息交互。AF和PCF在N5接口提供的服务操作如下： 
NF|服务|服务操作|操作语义|资源URI|HTTP方法|说明
---|---|---|---|---|---|---
PCF|Npcf_PolicyAuthorization|Npcf_PolicyAuthorization_Create|Request/Response|//{apiRoot}/npcf-policyauthorization/v1/app-sessions|POST|创建新的应用会话上下文，以及订阅相关事件通知。
Npcf_PolicyAuthorization_Update|PCF|Npcf_PolicyAuthorization|Request/Response|//{apiRoot}/npcf-policyauthorization/v1/app-sessions/{appSessionId}|PATCH|更新已存在的应用会话上下文，以及订阅相关事件通知。
Npcf_PolicyAuthorization_Notify|PCF|Npcf_PolicyAuthorization|Subscribe/Notify|//{apiRoot}/af/v1/sessions/notify|POST|AF订阅事件，当事件发生后，PCF通知AF。
//{apiRoot}/af/v1/sessions/terminate|Npcf_PolicyAuthorization_Notify|PCF|Npcf_PolicyAuthorization|Subscribe/Notify|POST|PCF请求AF终止应用会话上下文。
Npcf_PolicyAuthorization_Subscribe|PCF|Npcf_PolicyAuthorization|Request/Response|//{apiRoot}/npcf-policyauthorization/v1/app-sessions/{appSessionId}/events-subscription|PUT|AF向PCF订阅事件。
Npcf_PolicyAuthorization_Unsubscribe|PCF|Npcf_PolicyAuthorization|Request/Response|DELETE|//{apiRoot}/npcf-policyauthorization/v1/app-sessions/{appSessionId}/events-subscription|AF向PCF取消事件订阅。
Npcf_PolicyAuthorization_Delete|PCF|Npcf_PolicyAuthorization|Request/Response|//{apiRoot}/npcf-policyauthorization/v1/app-sessions/{appSessionId}/delete|POST|删除已存在的应用会话上下文，以及订阅相关事件通知。
###### 业务流程 
######## AF会话上线，建立专有承载 
[]images/1625196938681.png)流程说明如下： 
PDU会话建立成功，AF向RCP请求策略授权，发送Npcf_PolicyAuthorization_Create请求消息给RCP，请求建立AF会话。主要包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-policyauthorization/v1/app-sessions:authority: PCF主机:端口，端口可选，默认80，主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80|HTTP Header关键参数
ascReqData|ueIpv4|UE的IPv4地址
ueIpv6|ascReqData|UE的IPv6地址，是完整的128bit的IPv6地址。ueIpv4和ueIpv6通常二选一携带
sliceInfo|ascReqData|切片信息，可选，通常不携带
dnn|ascReqData|数据网名称（Data Network Name，等同于EPC中的APN），可选，通常不携带
ipDomain|ascReqData|IP域，当存在UE IPv4地址池重叠时，ipDomain + ueIpv4应当唯一 ，可选，通常不携带
supi|ascReqData|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI），可选，通常不携带
gpsi|ascReqData|一般公共签约用户标识（Generic Public Subscription Identifier，例如MSISDN），可选，通常不携带
notifUri|ascReqData|通知URI，即AF后续接收PCF下发的通知请求（PolicyAuthorization_Notify.request）的URI地址
suppFeat|ascReqData|AF支持的特性列表
afAppId|ascReqData|AF应用标识
sponId|ascReqData|赞助商标识【注2】
aspId|ascReqData|业务提供商标识【注2】
sponStatus|ascReqData|赞助状态【注2】，取值：SPONSOR_DISABLED：赞助停止SPONSOR_ENABLED：赞助启用不携带时默认为SPONSOR_ENABLED
afRoutReq|ascReqData|AF会话级的业务影响路由信息【注1】
evSubsc|ascReqData|事件订阅信息events 订阅的事件列表，每个事件中主要包含如下参数：event 订阅的事件，常见的有：ACCESS_TYPE_CHANGE：接入类型变更FAILED_RESOURCES_ALLOCATION：资源分配失败SUCCESSFUL_RESOURCES_ALLOCATION：资源分配成功PLMN_CHG：PLMN变更QOS_NOTIF：QoS通知USAGE_REPORT：赞助用量上报【注2】ANI_REPORT：接入网位置查询【注3】notifMethod：事件通知方法，AF通过此参数指示PCF何时上报事件通知，取值有：EVENT_DETECTION：对AF订阅的事件，PCF每次检测到事件发生，都通知AFONE_TIME：对AF订阅的事件，PCF检测到事件发生一次，通知AF，如果AF不再订阅，PCF后续不再通知PERIODIC：对AF订阅的事件，PCF周期性的通知AFPDU_SESSION_RELEASE：对AF订阅的事件，在PDU会话释放时通知AFnotifUri 事件通知URI，即AF后续接收PCF下发的事件通知请求的URI地址usgThres 赞助业务用量门限信息【注2】
medComponents|ascReqData|媒体部件列表，每个媒体部件包含如下参数：afAppId：AF应用标识medCompN：媒体部件编号，一个AF会话中各媒体部件编号要不同medType：媒体类型，取值如下：AUDIO：音频VIDEO：视频DATA：数据APPLICATION：应用CONTROL：控制TEXT：文本MESSAGE：消息OTHER：其它marBwUl：最大上行请求带宽marBwDl：最大下行请求带宽mirBwUl：最小上行请求带宽mirBwDl：最小下行请求带宽rrBw：RTCP接收带宽rsBw：RTCP发送带宽fStatus：流状态，取值如下：ENABLED-UPLINK：允许上行ENABLED-DOWNLINK：允许下行ENABLED：双向允许DISABLED：双向禁止REMOVED：流被删除afRoutReq：AF媒体级的业务影响路由信息【注1】X-AF-Charging-identifier：私有信元。通过该参数，可以指定某业务的计费信息（RG/SID）medSubComps：媒体子部件列表，每个媒体子部件包含如下参数：fNum：媒体子部件编号，一个媒体部件中各媒体子部件编号要不同fDescs：流描述列表，最多包含2条流描述。例如permit in 17 from 192.168.0.4 3000to 192.168.0.5 4000和permit out 17 from 192.168.0.5 4000 to 192.168.0.43000，其中in指上行，out指下行fStatus：流状态，和媒体部件层的fStatus含义相同，如果媒体部件和媒体子部件中fStatus都出现，则以媒体子部件中的fStatus取值为准flowUsage：流用途，取值如下：NO_INFO：此IP流用途无信息说明，flowUsage缺省时默认值就是NO_INFO，当此IP流用于实时传输协议（Real-TimeTransport Protocol）时flowUsage取值也填NO_INFORTCP：此IP流用于实时传输控制协议（Real-TimeTransport Control Protocol）AF_SIGNALLING：此IP流用于传输AF信令marBwUl：最大上行请求带宽marBwDl：最大下行请求带宽X-AF-Charging-identifier：私有信元，通过该参数，可以指定某业务的计费信息（RG/SID）。如果媒体和子媒体都携带，则子媒体级的优先级更高。
【注1】AF影响业务路由特性参考“ZUF-59-55-052
AF影响业务路由
”
【注2】赞助用量特性参考“ZUF-59-55-009
赞助业务
”
【注3】请参考“[接入网位置查询](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__efe19b50-8c3b-428d-a34c-87f730c4d719)”
RCP根据Npcf_PolicyAuthorization_Create请求消息提供的信息绑定N7会话（参见“[N5会话绑定](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__419366cc-791b-4a35-be4b-51a8dec8b171)”），回复Npcf_PolicyAuthorization_Create响应消息。主要包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:status: 201 Created:location: {authority}/npcf-policyauthorization/v1/app-sessions/{appSessionId}，其中authority填写的是PCF的信息，appSessionId为PCF根据群组号+userkey+sessionid等信息生成的关联ID，例如：http://192.162.231.2:8080/npcf-policyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366.
evsNotif|事件通知信息：evNotifs：通知的具体事件信息evSubsUri：RCP的URI，例如：http://192.162.231.2:8080/npcf-policyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366.accessType：接入类型ratType：RAT类型plmnId：PLMN标识
注：RCP根据“AF能力配置”的“授权响应方式”，确定采用立即响应（流程图中步骤2a）还是等承载确认后响应（流程图中步骤2b），详见“[授权响应方式](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__49a3ed64-1927-4a90-bb5a-6eee320c1475)”。
RCP对AF业务（参见“[AF业务映射](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__3649ebc4-1d25-4b4f-be0b-fc5a43feaa60)”）进行决策，并根据运营规划决策PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF，主要包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {notificationUri}/update，{notificationUri}为SMF在Create请求中提供的notificationUri，例如：/nsmf-pdusession/v1/sm-contexts/sessionId-0000000013580c71026b/update:authority: SMF的主机:端口
resourceUri|SMF策略关联URI，和Create响应http头域Location字段分配的resourceUri一致
sessRules|SessionRule列表，每个SessionRule主要包含：authSessAmbr：授权的会话聚合带宽authDefQos：授权的缺省QoSsessRuleId：会话规则IDrefUmData：引用的用量数据refCondData：引用的条件数据
pccRules|PccRule列表，每个PccRule主要包含：flowInfos：流信息appId：应用标识pccRuleId：PCC规则标识precedence：优先级refQosData：引用的QoS Data的qosIdrefTcData：引用的TrafficControlData的tcIdrefChgData：引用的ChargingData的chgIdrefUmData：引用的UsageMonitoringData的umIdrefCondData：引用的ConditionData的condId
qosDecs|QoSData列表，每个QoSData主要包含：qosId：QoS编号5qi：5QImaxbrUl：最大上行请求带宽maxbrDl：最下上行请求带宽gbrUl：上行保障请求带宽gbrDl：下行保障请求带宽arp：抢占优先级qnc：QoS通知控制reflectiveQos：反射QoSsharingKeyDl：下行带宽共享键sharingKeyUl：上行带宽共享键priorityLevel：优先等级averWindow：平均窗maxDataBurstVol：最大突发流量maxPacketLossRateDl：最大下行丢包率maxPacketLossRateUl：最大上行丢包率defQosFlowIndication：缺省QoSFlow指示
chgDecs|ChargingData列表，每个ChargingData主要包含：chgId：计费数据编号meteringMethod：度量方法，取值DURATION/VOLUME/DURATION_VOLUME/EVENT。缺省时SMF自己决定度量方法。offline：是否启用离线计费，取值TRUE/FLASE，缺省时默认FALSE。pccRule的该参数缺省时对齐sessRule的offline参数。online：是否启用在线计费，取值TRUE/FLASE，缺省时默认FALSE。pccRule的该参数缺省时对齐sessRule的offline参数。ratingGroup：计费键组。reportingLevel：计费话单上报粒度，取值SER_ID_LEVEL/RAT_GR_LEVEL/SPON_CON_LEVEL。缺省时SMF自己决定上报粒度。serviceId：业务标识sponsorId：赞助商标识appSvcProvId：应用服务提供商标识afChargingIdentifier：AF计费标识（旧），Uint32类型afChargId：AF计费标识（新），string类型，当SMF在suppFeat中指示支持AF_Charging_Identifier特性时，PCF才能下发该参数。
chargingInfo|计费信息，主要包含：primaryChfAddress：首选CHF地址，FQDN格式的URIsecondaryChfAddress：次选CHF地址，FQDN格式的URI
traffContDecs|TrafficControlData列表，每个TrafficControlData主要包含：tcId：流控数据标识flowStatus：流状态redirectInfo：重定向信息muteNotif：是否上报应用发生停止事件trafficSteeringPolIdDl：下行业务链策略编号trafficSteeringPolIdUl：上行业务链策略编号routeToLocs：一组RouteToLocation，每个必须包含dnai，可选包含routeInfo和routeProfIdtraffCorreInd：流量关联指示，布尔类型，为true时，如果一个会话中多个PCC规则各自下发了dnai列表，SMF要从中选择出commonDNAI（即各dnai列表中都存在的dnai），用于相关业务流选择到相关的UPF进行传输upPathChgEvent：包含AF订阅用户面路径改变事件的相关信息
umDecs|UsageMonitoringData列表，每个UsageMonitoringData主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolumeThreshold：流量门限volumeThresholdUplink：上行流量门限volumeThresholdDownlink：下行流量门限timeThreshold：时长门限monitoringTime：监控时间点nextVolThreshold：下个流量门限nextVolThresholdUplink：下个上行流量门限nextVolThresholdDownlink：下个下行流量门限nextTimeThreshold：下个时长门限inactivityTime：非活动时长，超过此时长没收到数据包后，停止时长用量监控exUsagePccRuleIds：排除会话用量监控的PCC规则标识（不计入会话用量）
qosChars|QosCharacteristics列表，每个QosCharacteristics针对一个5qi，主要包含：5qi：5QI，类似于4G的QCIresourceType：资源类型，取值GBR/Non-GBR/Delay-critical GBRpriorityLevel：资源调度优先级packetDelayBudget：UE和锚点UPF之间数据包传输的时延上限packetErrorRate：误包率，发送端已正确发送但接收端未正确接收的数据包比率averagingWindow：平均时间窗，只用于GBR/Delay-critical GBR型QoS流，UE、R(AN)、UPF按每个平均时间窗内的流量来度量GFBR和MFBRmaxDataBurstVol：最大包突发，只用于Delay-critical GBR类型QoS流
conds|ConditionData列表，每个ConditionData主要包含：condId：条件编号activationTime：激活时间deactivationTime：去激活时间
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求。
lastReqRuleData|RequestedRuleData列表，用于PCC规则级别的事件订阅，每个RequestedRuleData包含：refPccRuleIds：相关PCC规则编号reqData：请求的规则数据，取值：CH_ID：查询接入网计费标识MS_TIME_ZONE：查询时区信息USER_LOC_INFO：查询用户位置信息RES_RELEASE：订阅资源释放事件通知SUCC_RES_ALLO：订阅资源分配成功事件通知
lastReqUsageData|用于PCF向SMF查询用量，包含：refUmIds：相关UmId。allUmIds：所有UmId。refUmIds和allUmIds二选一使用。
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow建立。 
参数|说明
---|---
HTTP Header关键参数|:status: 有如下三种响应：200 OK204 No Content400 Bad Request
ErrorReport|如果PCF下发的全部策略在SMF安装或执行失败，SMF回复400 Bad Request，并携带ErrorReport，包含如下参数：error：含具体失败信息ProblemDetailsruleReports：PCC规则报告sessRuleReports：会话规则报告
 说明： 
该流程中步骤3和步骤4的更详细信息，可以参考“ZUF-59-53-052 PDU会话策略控制
”中的“实现原理”。
######## AF会话修改，更新专有承载 
 
流程说明如下： 
AF携带新的媒体流信息向RCP发起资源更新请求，发送Npcf_PolicyAuthorization_Update请求消息给RCP，请求修改AF会话。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: PATCH:scheme: http或https:path: /npcf-policyauthorizationpolicyauthorization/v1/app-sessions/{appSessionId}，例如：/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366.:authority: PCF主机:端口
sponId|赞助商标识【注2】
aspId|业务提供商标识【注2】
sponStatus|赞助状态【注2】
afRoutReq|AF会话级的业务影响路由信息【注1】
evSubsc|事件订阅信息，主要包含：events ：订阅的事件列表notifUri：事件通知URI，即AF后续接收PCF下发的事件通知请求的URI地址usgThres：赞助用量门限信息【注2】
medComponents|媒体部件信息
【注1】AF影响业务路由特性参考“ZUF-59-55-052
AF影响业务路由
”
【注2】赞助用量特性参考“ZUF-59-55-009 赞助业务
”
RCP根据Npcf_PolicyAuthorization_Update请求消息提供的appSessionId中的sessionid信息找到AF会话，回复Npcf_PolicyAuthorization_Update响应消息。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK204 No Content:location: ——update响应的http头域Location字段为空
注：RCP根据“AF能力配置”的“授权响应方式”，确定采用立即响应（流程图中步骤2a）还是等承载确认后响应（流程图中步骤2b），详见“[授权响应方式](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__49a3ed64-1927-4a90-bb5a-6eee320c1475)”。
RCP对AF业务（参见“[AF业务映射](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__3649ebc4-1d25-4b4f-be0b-fc5a43feaa60)”）进行决策，并根据运营规划决策PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow更新。 
 说明： 
该流程中步骤3和步骤4步的主要参数可以参见“[AF会话上线，建立专有承载](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__940cad29-6c6f-47c6-960a-12b492c912be)”的步骤3和步骤4。
######## 事件发生后通知AF 
[]images/1625207424178.png)流程说明如下：
当AF通过RCP向SMF订阅的事件发生时（例如AF通过RCP向SMF订阅了ACCESS_TYPE_CHANGE事件后，接入类型发生了变化），SMF向RCP发送Npcf_SMPolicyControl_Update请求。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/update，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./update:authority: PCF主机:端口
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求
notificationUri|通知URI，即SMF后续接收PCF为该SM策略关联下发的SM策略更新通知请求（Npcf_SMPolicyControl_UpdateNotify请求）的URI地址
subsSessAmbr|签约的会话聚合带宽（Subscribed Session AMBR）
subsDefQos|签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN等，类似于Gx接口的RAT-Type
servingNetwork|接入网的PLMN ID，类似于Gx接口的3GPP-SGSN-MCC-MNC
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号guami：全局唯一AMF标识对4G接入，包含：anGWAddr：SGW的IP地址对2/3G接入，包含：sgsnAddr：SGSN的IP地址
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
userLocationInfoTime|SMF获取userLocationInfo的NTP时间
ueTimeZone|UE所在时区
ipv4Address|UE的IPv4地址
relIpv4Address|释放的IPv4地址
ipv6AddressPrefix|UE的IPv6地址前缀
relIpv6AddressPrefix|释放的IPv6地址前缀
addIpv6AddrPrefixes|增加的多个IPv6地址前缀
addRelIpv6AddrPrefixes|释放的多个IPv6地址前缀
ipDomain|IP域，当存在UE IPv4地址池重叠时，ipDomain + ipv4Address应当唯一
accNetChId|缺省QoS Flow或整个PDU会话的接入网计费标识包含如下参数：accNetChaIdValue：接入网计费标识取值refPccRuleIds：关联PCC规则，会话粒度的计费标识不用携带此参数sessionChScope：是否会话粒度的计费标识
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolUsage：流量使用量volUsageUplink：上行流量使用量volUsageDownlink：下行流量使用量timeUsage：时长使用量nextVolUsage：下个流量使用量（在monitoringTime之后的使用量，下同）nextVolUsageUplink：下个上行流量使用量nextVolUsageDownlink：下个下行流量使用量nextTimeUsage：下个时长使用量
appDetectionInfos|应用探测信息列表，每个appDetectionInfo包含：appId：应用标识instanceId：应用实例编号sdfDescriptions：业务流描述
ruleReports|ruleReport列表，每个ruleReport主要包含：pccRuleIds：PCC规则标识ruleStatus：PCC规则状态failureCode：PCC规则失败码
sessRuleReports|sessRuleReport列表，每个sessRuleReport主要包含：ruleId：会话规则标识ruleStatus：会话规则状态sessRuleFailureCode：会话规则失败码
RCP根据最新的会话接入信息、用户签约及用量信息重新进行策略决策，可能更新SM策略。RCP向SMF发送Npcf_SMPolicyControl_Update响应，如果RCP更新了SM策略，则将最新的SM策略包含在Update响应消息中。 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK:location: ——update响应的http头域Location字段为空
SmPolicyDecision相关参数|和Create响应的SmPolicyDecision相关参数一致
RCP找到该PDU会话关联的AF会话，并向AF发送Npcf_PolicyAuthorization_Notify请求消息，把事件相关信息通知AF。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {$request.body#/ascReqData/evSubsc/notifUri}/notify，例如/af/v1/sessions/notify:authority: AF的主机:端口。
evSubsUri|AF策略授权URI，和Creae响应http头域Location字段分配的resourceUri一致
evNotifs|事件通知信息：event：通知的事件flows：通知的事件所关联的流信息
accessType|接入类型
ratType|RAT类型
plmnId|PLMN标识
qncReports|QoS通知信息
usgRep|赞助用量上报信息
AF向RCP回复Npcf_PolicyAuthorization_Notify响应。 
参数|说明
---|---
HTTP Header关键参数|:status: 204 No Content
######## 订阅事件 
[]images/1625207771765.png)流程说明如下：
AF携带新的订阅事件向RCP发起更新请求，发送Npcf_PolicyAuthorization_Subscribe请求消息给RCP，请求订阅事件。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: PUT:scheme: http或https:path: /npcf-policyauthorizationpolicyauthorization/v1/app-sessions/{appSessionId}/events-subscription，例如：/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366./events-subscription:authority: PCF主机:端口
events|订阅的事件列表
notifUri|事件通知URI，即AF后续接收PCF下发的事件通知请求的URI地址
usgThres|赞助用量的门限信息
注：相比Update操作，Subscribe操作只用于更新事件订阅，Update操作除可以更新事件订阅外，还可以更新业务信息。 
RCP根据Npcf_PolicyAuthorization_Subscribe请求消息提供的appSessionId中的sessionid信息找到AF会话，回复Npcf_PolicyAuthorization_Subscribe响应消息。主要包含如下关键参数： 
参数|说明
HTTP Header关键参数|:status: 201 Created200 OK204 No Content
注：RCP根据“AF能力配置”的“授权响应方式”，确定采用立即响应（流程图中步骤2a）还是等承载确认后响应（流程图中步骤2b），详见“[授权响应方式](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__49a3ed64-1927-4a90-bb5a-6eee320c1475)”。
RCP对AF业务（参见“[AF业务映射](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__3649ebc4-1d25-4b4f-be0b-fc5a43feaa60)”）进行决策，并根据运营规划决策PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
该流程中步骤3和步骤4步的主要参数可以参见“[AF会话上线，建立专有承载](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__940cad29-6c6f-47c6-960a-12b492c912be)”的步骤3和步骤4。
######## 去订阅事件 
[]images/1625207879843.png)流程说明如下： 
AF发送Npcf_PolicyAuthorization_Unsubscribe请求消息给RCP请求取消订阅事件。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: DELETE:scheme: http 或https:path:/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/{appSessionId}/events-subscription，例如：/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366./events-subscription:authority: PCF主机:端口
RCP根据Npcf_PolicyAuthorization_Subscribe请求消息提供的appSessionId中的sessionid信息找到AF会话，回复Npcf_PolicyAuthorization_Unsubscribe响应消息。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 204 No Content
注：RCP根据“AF能力配置”的“授权响应方式”，确定采用立即响应（流程图中步骤2a）还是等承载确认后响应（流程图中步骤2b），详见“[授权响应方式](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__49a3ed64-1927-4a90-bb5a-6eee320c1475)”。
RCP对AF业务（参见“[AF业务映射](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__3649ebc4-1d25-4b4f-be0b-fc5a43feaa60)”）进行决策，并根据运营规划决策PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
该流程中步骤3和步骤4步的主要参数可以参见“[AF会话上线，建立专有承载](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__940cad29-6c6f-47c6-960a-12b492c912be)”的步骤3和步骤4。
######## AF主动触发的专有承载释放 
[]images/1625207966569.png)流程说明如下： 
当用户停止使用AF业务时，触发AF向RCP发送Npcf_PolicyAuthorization_Delete请求消息，请求释放AF会话。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /npcf-policyauthorizationpolicyauthorization/v1/app-sessions/{appSessionId}/delete，例如：/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366./delete:authority: PCF主机:端口
events|订阅的事件列表
notifUri|事件通知URI，即AF后续接收PCF下发的事件通知请求的URI地址
usgThres|赞助用量的门限信息
RCP根据Npcf_PolicyAuthorization_Delete请求消息提供的appSessionId中的sessionid信息找到AF会话，回复Npcf_PolicyAuthorization_Delete响应消息，主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK204 No Content
注：RCP根据“AF能力配置”的“授权响应方式”，确定采用立即响应（流程图中步骤2a）还是等承载确认后响应（流程图中步骤2b），详见“[授权响应方式](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2d064391deba452c89b774a3dfd7ea51__49a3ed64-1927-4a90-bb5a-6eee320c1475)”。
RCP检查出需要删除的AF业务，并将相应的PCC规则通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF指示删除。 
SMF返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS Flow删除。 
######## SMF触发的专有承载释放 
[]images/1625208013597.png)流程说明如下：
在UE或SMF发起的PDU会话释放流程中，SMF查找到某PDU会话有相关的SM策略关联，向PCF发送Npcf_SMPolicyControl_Delete请求，请求PCF删除SM策略关联。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/delete，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./delete:authority: PCF主机:端口
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
userLocationInfoTime|SMF获取userLocationInfo的NTP时间
ueTimeZone|UE所在时区
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolUsage：流量使用量volUsageUplink：上行流量使用量volUsageDownlink：下行流量使用量timeUsage：时长使用量nextVolUsage：下个流量使用量（在monitoringTime之后的使用量，下同）nextVolUsageUplink：下个上行流量使用量nextVolUsageDownlink：下个下行流量使用量nextTimeUsage：下个时长使用量
pduSessRelCause|PDU会话释放原因。可选，取值：PS_TO_CS_HO：SRVCC切换
PCF向SMF发送Npcf_SMPolicyControl_Delete响应。主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|204 No Content
RCP找到该PDU会话关联的AF会话，并向AF发送Npcf_PolicyAuthorization_Notify请求消息，通知AF会话离线，主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {$request.body#/ascReqData/notifUri}/terminate，例如/af/v1/sessions/terminate:authority: AF的主机:端口
resUri|AF策略授权URI，和Create响应http头域Location字段分配的resourceUri一致
termCause|PCF终止AF会话的原因
AF向PCF回复Npcf_PolicyAuthorization_Notify响应。 
参数|说明
---|---
HTTP Header关键参数|204 No Content
AF向RCP发送Npcf_PolicyAuthorization_Delete请求消息请求释放AF会话，主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-policyauthorizationpolicyauthorization/v1/app-sessions/{appSessionId}/delete，例如：/npcf-policyauthorizationpolicyauthorization/v1/app-sessions/groupno_2303.supi_123456789012345.sessionid_4041032035915144366./delete:authority: PCF主机:端口
events|订阅的事件列表
notifUri|事件通知URI，即AF后续接收PCF下发的事件通知请求的URI地址
usgThres|赞助用量的门限信息
RCP根据Npcf_PolicyAuthorization_Delete请求消息提供的appSessionId中的sessionid信息找到AF会话，回复Npcf_PolicyAuthorization_Delete响应消息，主要包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK204 No Content
######## N5会话建立的同时订阅QoS监控事件 
[]images/n5%E4%BC%9A%E8%AF%9D%E5%BB%BA%E7%AB%8B%E7%9A%84%E5%90%8C%E6%97%B6%E8%AE%A2%E9%98%85qos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6.png)流程说明如下： 
N7会话建立后，UE访问AF，AF向RCP发送Npcf_PolicyAuthorization_Create请求，请求RCP建立N5会话，AF在请求中同时订阅QoS监控事件。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
ascReqData|ueIpv4|UE的IPv4地址。ueIpv4和ueIpv6通常二选一携带。
ueIpv6|ascReqData|UE的IPv6地址，是完整的128 bit的IPv6地址。ueIpv4和ueIpv6通常二选一携带。
afAppId|ascReqData|AF应用标识。
evSubsc|ascReqData|事件订阅信息，包含如下参数：events：事件订阅列表。每个事件订阅中包含如下参数：event：订阅的事件。对于QoS监控事件，取值为QOS_MONITORING。notifMethod：事件通知方法。对于QoS监控事件，取值如下，不携带时默认为EVENT_DETECTION。EVENT_DETECTION：UPF监控业务流时延达到或超过上报阈值时，触发QoS监控事件，上报业务流时延。PERIODIC：UPF周期性触发QoS监控事件，上报业务流时延。PDU_SESSION_RELEASE：UPF在PDU会话释放时，上报业务流时延，此场景不触发QoS监控事件。repPeriod：上报周期。当notifMethod为PERIODIC时，AF需要携带此参数。此参数最终用于指示UPF定时触发QoS监控事件上报的周期。waitTime：等待时长。当notifMethod为EVENT_DETECTION时需要携带此参数。此参数最终用于指示UPF前后两次QoS监控事件上报的等待时长，两次QoS监控事件上报都是因为业务流时延达到或超过上报阈值而触发，设置等待时长可以避免UPF频繁上报QoS监控事件。notifUri：通知URI，即AF后续接收PCF上报事件通知请求的URI地址。notifCorreId：通知关联标识，用于关联事件订阅和后续事件通知，当AF期望UPF能跳过SMF/PCF直接将QoS监控事件上报给AF/NEF时，携带此参数。diretNotifInd：直接通知指示。当AF携带此参数，且设置为true时，表示AF期望UPF将QoS监控事件直接上报给AF。reqQosMonParams：请求QoS监控参数列表，可同时携带多个不同取值的请求QoS监控参数，每个请求QoS监控参数取值如下：DOWNLINK：监控业务流下行时延。UPLINK：监控业务流上行时延。ROUND_TRIP：监控业务流往返时延。qosMon：用于设定业务流的时延上报门限，当业务流时延超过此门限时，UPF才上报QoS监控事件给SMF并携带业务流时延。包含如下参数：repThreshDl：业务流下行时延上报门限。repThreshUl：业务流上行时延上报门限。repThreshRp：业务流往返时延上报门限。
medComponents|ascReqData|媒体部件列表，其中包含需要实施QoS监控的业务流信息。
RCP向AF返回Npcf_PolicyAuthorization_Create响应。 
RCP根据UE IP将N5会话绑定到N7会话，通过Npcf_SMPolicyControl_UpdateNotify请求下发QoS监控事件订阅。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
pccRules|PccRule列表，每个PccRule主要包含：flowInfos：流信息。pccRuleId：PCC规则标识。refQosMonData：引用的QoSMonitoringData的qmId。
qosMonDecs|QoSMonitoringData列表，每个QoSMonitoringData主要包含：qmId：QoS监控编号，由RCP自己生成，在一个N7会话内保持唯一。reqQosMonParams：请求QoS监控参数列表，与AF提供给PCF的QoS监控事件订阅的reqQosMonParams参数含义相同，取值一致。取值有：DOWNLINK：监控业务流下行时延。UPLINK：监控业务流上行时延。ROUND_TRIP：监控业务流往返时延。repFreqs：QoS监控事件上报频度，与AF提供给PCF的QoS监控事件订阅的notifMethod参数含义相同，取值一致。取值有：EVENT_DETECTION：UPF监控业务流时延达到或超过上报阈值时，触发QoS监控事件，上报业务流时延。PERIODIC：UPF周期性触发QoS监控事件，上报业务流时延。PDU_SESSION_RELEASE：UPF在PDU会话释放时，上报业务流时延，此场景不触发QoS监控事件。repThreshDl：业务流下行时延上报门限，与AF提供给PCF的QoS监控事件订阅的repThreshDl参数含义相同，取值一致。repThreshUl：业务流上行时延上报门限，与AF提供给PCF的QoS监控事件订阅的repThreshUl参数含义相同，取值一致。repThreshRp：业务流往返时延上报门限，与AF提供给PCF的QoS监控事件订阅的repThreshRp参数含义相同，取值一致。waitTime：等待时长，与AF提供给PCF的QoS监控事件订阅的waitTime参数含义相同，取值一致。repPeriod：上报周期，与AF提供给PCF的QoS监控事件订阅的repPeriod参数含义相同，取值一致。notifUri：通知URI，与AF提供给PCF的QoS监控事件订阅的notifUri参数含义相同，取值一致。notifCorreId：通知关联标识，与AF提供给PCF的QoS监控事件订阅的notifCorreId参数含义相同，取值一致。diretNotifInd：直接通知指示，与AF提供给PCF的QoS监控事件订阅的diretNotifInd参数含义相同，取值一致。
policyCtrlReqTriggers|PCF向SMF订阅的策略控制请求事件触发器列表，对于QoS监控，需包含QOS_MONITORING事件。
SMF向RCP返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
以上各步骤的其他主要参数参见“[AF会话上线，建立专有承载](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__940cad29-6c6f-47c6-960a-12b492c912be)”流程的各步骤。
######## N5会话更新的同时订阅、更新或取消QoS监控事件 
[]images/n5%E4%BC%9A%E8%AF%9D%E6%9B%B4%E6%96%B0%E7%9A%84%E5%90%8C%E6%97%B6%E8%AE%A2%E9%98%85%E6%9B%B4%E6%96%B0%E6%88%96%E5%8F%96%E6%B6%88qos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6.png)流程说明如下： 
N5会话建立后，AF在Npcf_PolicyAuthorization_Update请求中下发、更新或取消QoS监控事件订阅。 
RCP向AF返回Npcf_PolicyAuthorization_Update响应。 
RCP找到N5会话已绑定的N7会话，通过Npcf_SMPolicyControl_UpdateNotify请求下发、更新或取消QoS监控事件订阅。 
SMF向RCP返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
步骤1、步骤3涉及的QoS监控的关键参数和“N5会话建立的同时订阅QoS监控事件”的步骤1、步骤3相同。 
以上各步骤的其他主要参数参见“AF会话上线，建立专有承载”流程的各步骤。 
######## N5会话通过Subscribe操作订阅、更新或取消QoS监控事件 
[]images/n5%E4%BC%9A%E8%AF%9D%E9%80%9A%E8%BF%87subscribe%E6%93%8D%E4%BD%9C%E8%AE%A2%E9%98%85%E6%9B%B4%E6%96%B0%E6%88%96%E5%8F%96%E6%B6%88qos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6.png)流程说明如下： 
N5会话建立后，AF在Npcf_PolicyAuthorization_Subscribe请求中下发、更新或取消QoS监控事件订阅。 
RCP向AF返回Npcf_PolicyAuthorization_Subscribe响应消息。 
RCP找到N5会话已绑定的N7会话，通过Npcf_SMPolicyControl.UpdateNotify请求下发、更新或取消QoS监控事件订阅。 
SMF向RCP返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
步骤1、步骤3涉及的QoS监控的关键参数和“N5会话建立的同时订阅QoS监控事件”的步骤1、步骤3相同。 
以上各步骤的其他主要参数参见“订阅事件”流程的各步骤。 
######## N5会话通过Unsubscribe操作取消所有事件订阅（包括QoS监控事件订阅） 
[]images/n5%E4%BC%9A%E8%AF%9D%E9%80%9A%E8%BF%87unsubscribe%E6%93%8D%E4%BD%9C%E5%8F%96%E6%B6%88%E6%89%80%E6%9C%89%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85%EF%BC%88%E5%8C%85%E6%8B%ACqos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85%EF%BC%89.png)流程说明如下： 
N5会话建立后，AF在Npcf_PolicyAuthorization_Unsubscribe请求中取消所有事件订阅。 
RCP向AF返回Npcf_PolicyAuthorization_Unsubscribe响应。 
RCP找到N5会话已绑定的N7会话，通过Npcf_SMPolicyControl_UpdateNotify请求取消该N5会话相关事件订阅。 
SMF向RCP返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
以上各步骤的参数说明参见“[去订阅事件](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__31269b7f-d0b5-42d7-ae66-3ed7bb08bbde)”流程的各步骤。
######## N5会话释放的同时取消QoS监控事件 
[]images/n5%E4%BC%9A%E8%AF%9D%E9%87%8A%E6%94%BE%E7%9A%84%E5%90%8C%E6%97%B6%E5%8F%96%E6%B6%88qos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6.png)流程说明如下： 
N5会话建立后，AF在Npcf_PolicyAuthorization_Delete请求中取消QoS监控事件订阅。 
RCP向AF返回Npcf_PolicyAuthorization_Delete响应。 
RCP找到N5会话已绑定的N7会话，通过Npcf_SMPolicyControl_UpdateNotify请求取消QoS监控事件订阅。 
SMF向RCP返回Npcf_SMPolicyControl_UpdateNotify响应。 
 说明： 
以上各步骤的参数说明参见“[AF主动触发的专有承载释放](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__8af8c2fe-edbc-4742-9c2a-b8aabff73735)”流程的各步骤。
######## N7会话上报QoS监控事件 
[]images/n7%E4%BC%9A%E8%AF%9D%E4%B8%8A%E6%8A%A5qos%E7%9B%91%E6%8E%A7%E4%BA%8B%E4%BB%B6.png)流程说明如下： 
RCP下发QoS监控事件订阅后，当相关条件满足时，SMF通过Npcf_SMPolicyControl_Update请求上报QoS监控事件。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
policyCtrlReqTriggers|策略控制事件触发器列表，对QoS监控事件上报，需要包含QOS_MONITORING事件。
qosMonReports|QoS监控报告列表，每个QoS监控报告主要包含：ulDelays：业务流上行时延。dlDelays：业务流下行时延。rpDelays：业务流往返时延。每类时延最多可带2个取值，分别是该类最大时延和最小时延。
RCP向SMF返回Npcf_SMPolicyControl_Update响应。 
RCP通过Npcf_PolicyAuthorization_Notify请求上报QoS监控事件给AF。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
evSubsUri|AF策略授权URI，和Npcf_PolicyAuthorization_Create响应消息中http头域Location字段分配的resourceUri一致。
evNotifs|事件通知信息，包含event：通知的事件，此处为QOS_MONITORING事件。flows：通知的事件所关联的流信息，对于QOS_MONITORING事件，不携带此参数。
qosMonReports|QoS监控报告列表，每个QoS监控报告主要包含：flows：业务流信息，不携带时表示该N5会话全部业务流。ulDelays：业务流上行时延。dlDelays：业务流下行时延。rpDelays：业务流往返时延。每类时延最多可带2个取值，分别是该类最大时延和最小时延。
AF回复Npcf_PolicyAuthorization_Notify响应。 
 说明： 
以上各步骤的其他参数说明参见“[事件发生后通知AF](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__8ca17de1-ac6c-48c8-841d-8ac72742c9dc)”流程的各步骤。
######## PDU会话释放时上报QoS监控信息 
如果AF之前订阅的QOS_MONITORING事件要求在PDU_SESSION_RELEASE时上报QoS监控信息，则SMF释放N7会话时会上报QoS监控信息，RCP进一步上报给AF。 
[]images/pdu%E4%BC%9A%E8%AF%9D%E9%87%8A%E6%94%BE%E6%97%B6%E4%B8%8A%E6%8A%A5qos%E7%9B%91%E6%8E%A7%E4%BF%A1%E6%81%AF.png)流程说明如下： 
SMF释放PDU会话，向PCF发送Npcf_SMPolicyControl_Delete请求，请求中上报QoS监控信息。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
qosMonReports|QoS监控报告列表，每个QoS监控报告主要包含：ulDelays：业务流上行时延。dlDelays：业务流下行时延。rpDelays：业务流往返时延。每类时延最多可携带2个取值，分别是该类最大时延和最小时延。
RCP向SMF返回Npcf_SMPolicyControl_Delete响应。 
RCP向AF发送Npcf_PolicyAuthorization_Notify请求，通知AF会话离线。 
AF向RCP返回Npcf_PolicyAuthorization_Notify响应。 
AF向RCP发送Npcf_PolicyAuthorization_Delete请求释放N5会话。 
RCP向AF返回Npcf_PolicyAuthorization_Delete响应，其中携带QoS监控事件上报信息。 
该请求中涉及QoS监控的关键参数如下： 
参数|说明
---|---
evSubsUri|AF策略授权URI，与Npcf_PolicyAuthorization_Creae响应http头域Location字段分配的resourceUri一致。
evNotifs|事件通知信息，包含：event：通知的事件，此处为QOS_MONITORING事件。flows：通知的事件所关联的流信息，对于QOS_MONITORING事件，不携带此参数。
qosMonReports|QoS监控报告列表，每个QoS监控报告主要包含：flows：业务流信息，不携带时表示该N5会话全部业务流。ulDelays：业务流上行时延。dlDelays：业务流下行时延。rpDelays：业务流往返时延。每类时延最多可带2个取值，分别是该类最大时延和最小时延。
 说明： 
以上流程各步骤的其他参数说明参见“[SMF触发的专有承载释放](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new286b4af3961a4678877ac633b69faa4e__6d503746-2db8-48c9-900a-a607cded23a6)”流程的各步骤。
###### 本网元实现 
######## N5会话绑定 
一个UE可以建立多个PDU会话，每个PDU会话建立时，SMF可以通过N7接口向PCF建立一个策略关联，用于获取PDU会话的控制策略，这个策略关联也称为N7会话，因为N7会话和PDU会话是一对一的，所以也可以把N7会话称为PDU会话。每个PDU会话建立成功后，SMF为该PDU会话分配IPv4地址或IPv6地址前缀，如果是IPv6地址前缀（通常是64bit的前缀），UE会在后面拼接上自己的接口地址，构成一个完整的IPv6地址。UE再使用IPv4或IPv6地址访问AF，如果AF要为UE访问的特定业务流向PCF请求策略授权，则AF通过N5接口向RCP建立一个应用会话，也称为N5会话或AF会话，AF在此N5会话中向RCP提供需要做策略授权的业务信息和策略要求（QoS、路由等），并提供UE IP地址，需要RCP根据UE IP地址找到对应的N7会话，这个过程称为“N5会话绑定”。RCP根据AF在N5会话中提供的业务信息和策略要求，生成PCC规则，在绑定的N7会话中下发这些PCC规则。
如果N5会话提供了ueIpv6，则RCP根据ueIpv6前缀绑定N7会话。 
如果N5会话提供了ueIpv6和dnn，则RCP根据dnn+ueIpv6前缀绑定N7会话。 
如果N5会话提供了ueIpv4，则RCP根据ueIpv4绑定N7会话。 
如果存在ueIpv4重叠的场景，并且N7和N5会话都提供了ipDomain，则RCP根据ipDomain+ueIpv4执行绑定。如果N5没有提供ipDomain，但提供了dnn，则RCP根据dnn+ueIpv4执行绑定。 
在执行N5会话绑定时，如果N5会话和N7会话都提供了supi或gpsi，则绑定的N5和N7会话的supi或gpsi也要求相同，否则不能绑定。 
当N5会话可绑定多个N7会话时，RCP有一个全局开关（编号1381，AF会话匹配多承载会话时绑定方式）决定绑定最新承载会话还是拒绝N5会话建立，默认值0表示绑定最新承载会话。 
######## AF业务映射 
AF在N5会话中向PCF提供AF业务信息，一个AF业务可以包含若干个媒体流（例如音频流、视频流），每个媒体流的相关信息包含在N5会话的一个媒体部件（MediaComponent）参数中，一个媒体部件参数又可以包含若干媒体子部件（MediaSubComponent）参数，每个媒体子部件可以包含一个特定用途的单向流或双向流，例如一个音频流可以包含一个RTP媒体子部件及一个RCTP媒体子部件，RTP媒体子部件基于实时传输协议（Real-Time Transport Protocol），传输媒体流数据，RCTP媒体子部件基于实时传输控制协议（Real-Time Transport Control Protocol），控制媒体流数据传输。
RCP网管配置提供“AF应用标识映射配置”，将“AF应用标识+媒体类型+流用途+流方向+流状态+赞助商标识+内容提供商标识”映射为RCP内部使用的“应用标识”，每个RCP内部使用的“应用标识”可以在策略配置中输出对应的PCC规则。不同“AF应用标识+媒体类型+流用途+流方向+流状态+赞助商标识+内容提供商标识”组合可以映射为相同或不同的“应用标识”，最终决定它们是否合并输出PCC规则。例如，如果将一个VoNR音频媒体的RTP子部件和RTCP子部件映射为相同的“应用标识”，则最终这个音频流只输出一个PCC规则，这个PCC规则中同时包含RTP子部件和RTCP子部件的流信息。如果将一个VoNR音频媒体的RTP子部件和RTCP子部件映射为不同的“应用标识”，则最终这个音频流的RTP子部件和RTCP子部件分别输出一个PCC规则，分别包含RTP子部件和RTCP子部件的流信息。 
RCP对AF提供的业务信息中的每个最细粒度的单向流（如果是双向流则视为两个单向流），查询上述“AF应用标识映射配置”，确定该单向流对应的RCP内部使用的“应用标识”，这个过程称为“AF业务映射”，之后RCP再根据策略配置确定每个“应用标识”对应的PCC规则，将相关的单向流的流描述包含在对应的PCC规则中。 
每个单向流的相关属性获取方式如下： 
信息|获取方式
---|---
AF应用标识|取媒体部件层的afAppId，如果没有，则取N5会话层的afAppId；再没有，则取“默认AF应用标识配置”中的“默认AF应用标识”。
媒体类型|取媒体部件层的medType，如果没有，则默认值为OTHER。
流用途|取媒体子部件层的flowUsage，如果没有，则默认值为NO_INFORMATON。
流方向|取媒体子部件层的fDescs中的流方向，in表示上行，out表示下行。
流状态|取媒体子部件层的fStatus，如果没有，则取媒体部件层的fStatus。
赞助商标识|取N5会话层的sponId。
内容提供商标识|取N5会话层的aspId。
应用标识|根据以上信息，查“AF应该标识映射配置”获取对应的“应用标识”。
######## 带宽计算 
通过上述“AF业务映射”过程，RCP确定了AF业务中每个最细粒度的单向流对应的RCP内部使用的“应用标识”，不同的单向流可以映射到相同的“应用标识”，RCP再根据策略配置确定每个“应用标识”对应的PCC规则，将相关的单向流的流描述包含在对应的PCC规则中。此类AF业务相关的PCC规则一般不在网管上配置最大带宽（MBR，Max Bit Rate）和保障带宽（GBR，Guranteed Bit Rate），这样RCP会自动将每PCC规则相关各单向流的MBR/GBR累加得到该PCC规则的MBR/GBR。
RCP确定AF业务中每个最细粒度的单向流的MBR带宽的方法如下： 
非RTCP单向流：所在媒体子部件有marBwUl/marBwDl，则根据流方向取marBwUl或marBwDl。如果媒体子部件没有marBwUl/marBwDl，但媒体部件层有marBwUl/marBwDl，则根据流方向取媒体部件层的marBwUl或marBwDl。如果媒体部件层也没有marBwUl/marBwDl，则根据“AF应用标识”+“媒体类型”查询“默认AF业务参数配置”，如果能找到对应的“缺省的最大上行带宽”/“缺省的最大下行带宽”，则根据流方向取“缺省的最大上行带宽”或“缺省的最大下行带宽”。如果上述带宽都未取到，则带宽为0。 
RTCP单向流：所在媒体部件有rrBw和rsBw，则取rrBw+rsBw。所在媒体部件没有rrBw和rsBw，则参考上述非RTCP单向流MBR带宽获取逻辑，得到的MBR再乘以0.05。所在媒体部件rrBW和rsBW只有一个，则参考上述非RTCP单向流MBR带宽获取逻辑，得到的MBR再乘以0.05，再和rrBW或rsBW比较，取较大者。如果上述带宽都未取到，则带宽为0。 
RCP确定了AF业务中每个最细粒度的单向流的GBR带宽的方法如下： 
非RTCP单向流：所在媒体部件有mirBwUl/mirBwDl，则根据流方向取mirBwUl或mirBwDl。如果媒体部件没有mirBwUl/mirBwDl，则根据“AF应用标识”+“媒体类型”查询“默认AF业务参数配置”，如果能找到对应的“缺省的最小上行带宽”/“缺省的最小下行带宽”，则根据流方向取“缺省的最小上行带宽”或“缺省的最小下行带宽”。如果上述带宽都未取到，则带宽为0。 
RTCP单向流：等于RTCP单向流的MBR带宽。 
如果AF业务相关PCC规则在网管上配置MBR和GBR，则按网管配置值输出，不用上述单向流MBR/GBR累加值。如果网管上只配置了MBR或GBR，则未配置的GBR或MBR则用上述单向流MBR/GBR累加值。此外，此类PCC规则的5QI和ARP一般需要在网管上配置，5QI配置值一般参考AF业务的媒体类型来设置，例如VoNR业务的音频流的5QI一般设置为1，ARP配置值按运营商规范或AF请求中的资源预留优先级设置。最终，RCP还会根据PCC规则的5QI是GBR型还是Non-GBR型确定PCC规则是否输出GBR。如果是Non-GBR型5QI，则不输出GBR。如果是GBR型5QI，即便之前的带宽计算或网管配置没有GBR，最终PCC规则也会输出GBR，取值和MBR相等。如果带宽计算或网管配置的GBR大于MBR，最终PCC规则输出的GBR会等于MBR。
一个PCC规则包含的所有单向流都是同一个方向时，另一个方向的带宽值会按0值处理。RCP有一个全局开关（编号1135，IMS业务带宽为0是否下发开关）决定0值带宽是否下发，默认下发。 
######## 授权响应方式 
RCP给AF回复响应的时机，有如下两种方式： 
立即响应：RCP侧处理完成后立即给AF回复响应。 
等承载确认后响应：RCP侧处理完成后，通知承载侧（SMF）。等承载侧回复响应后，RCP再给AF回复响应。 
以上两种方式，通过“AF能力配置”的“授权响应方式”进行配置。 
以下场景，不受上面的配置约束，固定为“等承载确认后响应”： 
AF主动离线时订阅了“接入网位置查询”事件。 
订阅了赞助用量上报，且AF主动离线前，未上报过赞助用量。 
######## 事件订阅 
Npcf_PolicyAuthrozation的Create/Update/Subscribe/Delete操作都可以订阅事件，每次操作提供全量的订阅事件列表，如果事件列表为null则删除所有事件订阅。 
Delete操作只能订阅特定事件（例如“接入网位置查询”事件）。 
Subscribe操作只能更新事件订阅，而Update操作除了可以更新事件订阅外，还可以更新业务信息。 
Unsubscribe操作只用于取消所有事件订阅。 
######## 接入网位置查询 
在用户进行IMS呼叫的时候，AF有时候需要从网络侧查询用户的接入网信息。例如：用户在进行紧急呼叫的时候，需要根据用户的位置信息进行呼叫中心定位。AF从RCP获取的接入网信息包含：用户位置信息、用户接入地时间或用户接入地时区。RCP在收到AF的查询请求后，需要实时地向SMF查询用户相关的接入网信息，查询后上报给AF。 
可以在以下接口进行接入网位置查询： 
N5会话创建 
N5会话更新 
N5会话主动离线 
N5会话事件订阅 
 说明： 
接入网位置查询都是一次性的，即：RCP上报接入网位置给AF后，后面不再上报。AF如需RCP再次上报，则AF需要向RCP再次订阅。 
######## N5多会话和重复会话 
如果同时满足以下条件，则认为是N5重复会话，否则认为是N5多会话。 
流信息：每条流的媒体部件编号、子部件编号、流描述完全一致。 
事件订阅：事件订阅events完全一致。 
AfAppid：优先使用媒体层比较、后会话层比较。如果会话未携带媒体，也需要比较会话层的AfAppid（AF影响路由场景，可能存在不携带媒体但是AFAppid不同的多会话场景）。 
N5会话未曾更新过。 
 说明： 
一个N7会话最多绑定11个N5+Rx会话。 
N5会话只和已创建的N5会话进行判重/多会话判定，不和Rx会话比较。 
######## QoS监控 
QoS监控用于AF监控UE和UPF间高可靠低时延（Ultra Reliable Low Latency Communication，URLLC）业务的传输时延，主要包含如下流程：
AF直接或通过NEF向PCF建立或更新N5会话，携带媒体流信息，订阅QoS监控事件，提供QoS监控事件订阅相关参数。 
PCF对AF媒体流构造PCC规则下发给SMF，并向SMF传递QoS监控事件订阅及相关参数。 
SMF安装PCC规则，向UPF传递QoS监控事件订阅及相关参数。 
UPF监控PCC规则相关业务流的传输时延，满足QoS监控事件触发要求时，触发QoS监控事件，上报业务流传输时延。 
UPF触发的QoS监控事件可以通过SMF/PCF传递给AF/NEF，也可以直接传递给AF/NEF，由AF在QoS监控事件订阅时指定上报方式。 
PCF在QoS监控流程中的作用： 
传递AF/NEF的QoS监控事件订阅及相关参数给SMF。 
将SMF上报的QoS监控事件及相关参数上报给AF/NEF。 
因为PCF在QoS监控流程中只是起到QoS监控事件及相关参数的传递作用，所以PCF在QoS监控流程中不需要做额外的配置，只需要与AF业务建立专载流程，在RCP上配置AF业务对应的PCC规则即可。 
AF提供QoS监控事件订阅时，可以通过notifMethod参数指示UPF何时上报QoS监控事件，notifMethod参数取值如下，不携带时默认为EVENT_DETECTION。 
notifMethod|UPF上报时机|AF在QoS监控事件订阅中需提供的其它参数
---|---|---
EVENT_DETECTION|UPF监控业务流时延达到或超过上报阈值时，触发QoS监控事件，上报业务流时延。|AF需提供qosMon参数说明业务流下行/上行/往返时延上报门限。AF需提供waitTime参数说明UPF两次上报间的等待时间，避免频繁上报。
PERIODIC|UPF周期性触发QoS监控事件，上报业务流时延。|AF需提供repPeriod参数说明UPF上报周期。
PDU_SESSION_RELEASE|UPF在PDU会话释放时，上报业务流时延，此场景不触发QoS监控事件。|无。
AF提供QoS监控事件订阅时，可以通过reqQosMonParams参数指示UPF监控并上报业务流的哪类时延，取值如下，可多选。 
DOWNLINK：监控业务流下行时延。 
UPLINK：监控业务流上行时延。 
ROUND_TRIP：监控业务流往返时延。 
######## Token授权认证 
在N5接口处PCF作为服务提供者时，可根据开关1266（N5接口Oauth安全校验开关）参数值决定是否需要进行Token授权认证。 
当1266开关开启时，PCF会对AF发过来的请求消息进行校验。校验步骤如下： 
从http的Authorication参数中获取Token串，并使用NRF的密钥进行解密。 
若解密失败，则向AF返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
若解密成功，则执行步骤2，校验Token串内容。 
校验Token串中的以下字段。 
Token串中的字段|请求消息中的字段|校验标准
---|---|---
subject|NFS consumer的NF id|NFS consumer的NF id和subject中的授权NF id一致。
audience|NFS producer的id和type|满足其中一个检验标准即可。NFS producer的id和audience的NF id一致。NFS producer的type和audience的type一致。
scope|NFS producer的service name|NFS producer的service name在scope范围内。
expiration|-|当前时间戳未超过expiration有效期（可适当允许有效期误差）。
 说明： 
因为各网元可能有微小的差异，因此在NRF策略配置中增加了“令牌有效期允许最大偏差(秒)”的配置，如果expiration超过当前时间，但是在此误差以内，依然认为有效。 
PCF校验成功则继续处理业务请求，失败则在发送给AF的响应消息中返回检验结果。 
scope校验失败，则返回响应HTTP status code: "403 Forbidden"，携带头"WWW-Authenticate"，其中的error为"insufficient_scope"。 
scope校验以外的失败，则返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
######## 私有信元 
RCP基于能力开放平台定制X-AF-Charging-Identifier字段携带私有计费信息，针对特定业务下发指定的计费信息。X-AF-Charging-identifier字段可以通过N5/N30接口消息携带，在N5会话中通过以下流程携带： 
N5会话创建流程，可通过媒体级或子媒体级携带私有信元。RCP根据媒体信息映射业务下发动态规则，其中包括计费规则。如果计费规则中费率组/计费业务标识的决策方式配置为优先取AF决策的计费标识，那么此时将使用媒体信息中的私有计费信息X-AF-Charging-identifier替换计费规则中配置的费率组RG和计费业务标识SID，最终通过RG和SID把私有计费信息X-AF-Charging-identifier下发给SMF。 
N5会话更新流程，可通过媒体级或子媒体级新增或修改私有信元。如果N5会话创建时没有携带X-AF-Charging-identifier字段，那么在N5会话更新流程中可通过媒体级或子媒体级新增私有信元信息。如果N5会话创建时已携带X-AF-Charging-identifier字段，那么在N5会话更新流程中可通过媒体级或子媒体级修改私有信元信息。通过N5会话更新流程更新私有计费信息X-AF-Charging-identifier，此时会触发业务重新决策把新的私有计费信息X-AF-Charging-identifier通过RG和SID下发给SMF。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。    
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System
3GPP|TS 23.502|Procedures for the 5G System
3GPP|TS 23.503|Policy and Charging Control Framework for the 5G System
3GPP|TS 29.512|Session Management Policy Control Service
3GPP|TS 29.514|Policy Authorization Service
##### 特性能力 
名称|指标
---|---
单PDU会话最大支持N5+Rx会话个数|11
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
02|V7.23.10|增加QoS监控功能。
01|V7.20.10|首次发布。
####### License要求 
该特性需要申请了License许可后，运营商才能获得该特性的服务。 
该特性对应License文件中的受控项名称为Rx接口，受控项标识为LIC_RCP_FUNC_RX，此项目显示为ON，表示RCP支持Rx和N5接口接入特性。
####### 对其他网元的要求 
N5接口特性需要RCP和AF、SMF配合完成。AF提供业务信息和策略要求给RCP，RCP进行策略授权并生成PCC规则，下发给SMF实施。如果网络中部署有多个RCP，还需要引入BSF，RCP向BSF注册绑定信息（每PDU会话分配的UE IP地址及所选的RCP），AF根据UE IP地址到BSF查询绑定信息，找到对应的RCP。
##### O&M相关 
####### 命令 
配置项表1  新增命令编号命令项命令名称描述1AF能力配置ADD AFABILITY增加AF能力用于配置对应的AF网元的能力，主要有“授权响应方式”和“AF多事件通知”两个配置项：授权响应方式用于设置RCP给AF网元回复响应的时机，包括立即响应和等承载确认后响应两种方式。AF多事件通知用于指定RCP网元是否支持多事件合一通知AF。SET AFABILITY修改AF能力。DEL AFABILITY删除AF能力。SHOW AFABILITY查询AF能力。2AF应用标识映射配置ADD AFAPPMEDIA增加AF应用标识映射。将AF网元提供的媒体业务流信息映射为RCP内部的应用标识，用作后续的规则决策使用。SET AFAPPMEDIA修改AF应用标识映射。DEL AFAPPMEDIA删除AF应用标识映射。SHOW AFAPPMEDIA查询AF应用标识映射。3默认AF业务参数配置ADD AFAPP增加默认AF业务参数。用于配置AF应用标识所关联的默认的媒体业务流相关参数，当AF网元未向RCP提供媒体业务流相关参数信息时，执行本配置。SET AFAPP修改默认AF业务参数。DEL AFAPP删除默认AF业务参数。SHOW AFAPP查询默认AF业务参数。4AF净荷带宽映射配置ADD AFMBR增加AF净荷带宽映射。将净荷类型/编码方式与最大上、下行请求带宽进行了映射。在RCP网元没有为业务应用配置带宽策略，并且AF会话中也没有携带媒体子部件带宽时，RCP网元会根据本配置获取媒体部件中的codecs中的每种净荷类型的映射带宽，并使用映射带宽的最大值作为业务应用的带宽下发给SMF执行。SET AFMBR修改AF净荷带宽映射。DEL AFMBR删除AF净荷带宽映射。SHOW AFMBR查询AF净荷带宽映射。5DNN启用BSF配置ADD DNNBSF新增DNN启用BSF5GC中，AF/NEF通过BSF（Binding Support Function，绑定支持功能）寻址PCF，确保N5/Rx会话和对应的N7会话能选到相同的PCF。PCF在N7会话建立/修改/释放操作涉及UE IP地址分配释放时，要向BSF注册/更新/去注册UE IP和PCF的绑定信息。某些DNN（Data Network Name，数据网名称）的会话不需要向BSF注册绑定信息，因此需要按DNN向BSF注册绑定信息。说明：如果AF/NEF使用N5接口前要通过独立BSF查询PCF绑定信息，则需要在PCF配置DNN启用BSF，否则无需配置。目前中移、电信、联通均无需配置。SET DNNBSF修改DNN启用BSF。DEL DNNBSF删除DNN启用BSF。SHOW DNNBSF查询DNN启用BSF。 
定时器定时器编号定时器名称系统缺省值(毫秒)建议2055FSWAITASA1000不建议修改2056FSWAITRAA1000不建议修改2057FSWAITSTR5000不建议修改2059FSWAITRXACK5000不建议修改2060FSWAITRXPULL5000不建议修改 
全局变量参数编号参数名称描述使用方法1055PCEF携带的IPv6的Prefix长度N5使用携带的IPv6的前多少位和N7会话进行绑定。最小值1，最大值64，系统默认值64。通过命令SHOW SYS GLOBPARA:BEGIN=1055,END=1055,EXTFLAG=0，查看“全局开关1055”的取值。通过命令SET SYS GLOBPARA:IDX=1055,CURVAL="60",EXTFLAG=0，修改“全局开关1055”的取值为60。1381AF会话匹配多承载会话时绑定方式
该软件参数设置为0：表示当AF会话匹配多个N7/Gx会话时，RCP对AF会话绑定最新的N7/Gx会话。该软件参数设置为1：表示AF会话匹配多个N7/Gx会话时，RCP拒绝AF会话建立。通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1381,END=1381,EXTFLAG="ADVANCED"，查看“全局开关1381”的取值。通过命令SET SYS GLOBPARA:IDX=1381,CURVAL="1",EXTFLAG="ADVANCED"，修改“全局开关1381”的取值为1。1266N5接口Oauth安全校验开关N5接口是否开启Oauth Token校验功能。 0：关闭Oauth Token校验功能。1：开启Oauth Token校验功能。系统默认值为0。校验功能参见“Token授权认证”。通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1266,END=1266,EXTFLAG="ADVANCED"，查看“全局开关1266”的取值。通过命令SET SYS GLOBPARA:IDX=1266,CURVAL="1",EXTFLAG="ADVANCED"，修改“全局开关1266”的取值为1。 
动态管理编号命令说明1REL_AF_SESS:SESSIONTYPE="N5Sess",USERKEYTYPE="IP",IP="192.168.10.1"释放AF会话，其中：SESSIONTYPE为会话类型，选择N5Sess。USERKEYTYPE为用户标识类型。2SHOW_AF_SESS:USERTYPE="RCP_QUERY_TYPE_IP",IP="192.168.10.1"查询AF会话，其中：USERTYPE为用户类型，可选IP，IMSI等。IP为IP地址，IP地址类型根据USERTYPE选项值确定。 
####### 性能统计 
性能计数器测量类型性能计数器名称00020 RCP系统资源统计C000200100 在线N5会话数C000200101 在线N5会话数均值C000200102 在线N5会话数峰值C000200109 在线IMS N5会话数C000200110 在线IMS N5会话数均值C000200111 在线IMS N5会话数峰值C000200112 在线数据N5会话数C000200113 在线数据N5会话数均值C000200114 在线数据N5会话数峰值52003 N5接口测量编号为C52003开头的所有计数器52008 基于切片的会话数测量C520080004 N5在线会话数52023 AF/NEF邻接主机测量编号为C52023开头的所有计数器 
性能指标测量类型性能指标名称52003 N5接口测量（520039001）策略授权会话发起成功率（%）（520039002）策略授权会话更新成功率（%）（520039003）策略授权会话结束成功率（%）（520039004）策略授权会话发起成功率（去除用户原因）（%）（520039005）策略授权会话更新成功率（去除用户原因）（%）（520039006）策略授权会话结束成功率（去除用户原因）（%）52023 AF/NEF邻接主机测量（520239001）策略授权会话发起成功率（%）（520239002）策略授权会话更新成功率（%）（520239003）策略授权会话结束成功率（%）（520239004）策略授权会话发起成功率（去除用户原因）（%）（520239005）策略授权会话更新成功率（去除用户原因）（%）（520239006）策略授权会话结束成功率（去除用户原因）（%） 
####### 告警与通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及告警消息的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置特性 
###### 配置说明 
N5接口特性配置主要是实现AF/NEF通过N5接口向PCF请求关联的PDU会话策略授权，PCF下发规划的PCC规则。但是如果网络中部署有多个PCF，AF/NEF则需要通过查询BSF，确定访问哪个PCF。
 说明： 
如果AF/NEF使用N5接口前要通过独立BSF查询PCF绑定信息，则需要在PCF配置DNN启用BSF，否则无需配置。 
目前中移、电信、联通均无需配置。 
###### 配置前提 
N5接口特性是PCF、SMF以及AF配合共同完成的，如果网络中部署有多个PCF，还需要与BSF网元进行交互，因此在配置此特性之前保证四个网元的功能及交互正常。
###### 配置过程 
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)配置过程包含如下步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。

执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，配置HTTP客户端模板。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，配置HTTP服务端模板。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，配置服务类型为NBSF_MGT、NPCF_POLICYAUTHORIZATION的关联HTTP客户端模板配置。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，配置服务类型为NBSF_MGT、NPCF_POLICYAUTHORIZATION的服务基础信息。
（可选）NRF服务器相关配置。 
 说明： 
如果已有NRF相关配置，可以忽略此配置。 
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，配置NRF服务器分组。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，配置NRF服务器节点。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，配置NRF服务器策略。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，配置NRF服务器模板。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，配置NRF服务器模板选择。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
（可选）执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)命令，配置DNN启用外置BSF。
 说明： 
如果AF/NEF使用N5接口前要通过独立BSF查询PCF绑定信息，则需要在PCF上配置DNN启用BSF，否则无需配置。目前中移、电信、联通均无需配置。 
执行[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html)命令，配置邻接主机类型为AF/NEF的邻接主机IP地址。
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，配置进行应用标识。
执行[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html)命令，配置AF应用标识映射。
在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。
###### 配置实例 
######## 场景说明 
AF/NEF通过N5接口向PCF请求业务策略授权控制，包括：
对特定业务提供保障带宽。 
业务影响路由控制。 
######## 数据规划 
NF类型|IP地址
---|---
PCF|4003::19:5
AF|4003::19:17
NRF（互备双活模式）|4003::19:3
4003::19:4|NRF（互备双活模式）
类别|参数|取值
---|---|---
HTTP客户端模板配置1|编号|1
IP地址|HTTP客户端模板配置1|4003::19:5
起始端口|HTTP客户端模板配置1|20000
终止端口|HTTP客户端模板配置1|30000
HTTP客户端模板配置2|编号|2
IP地址|HTTP客户端模板配置2|4003::19:5
起始端口|HTTP客户端模板配置2|30001
终止端口|HTTP客户端模板配置2|40000
HTTP服务端模板配置|IP地址|4003::19:5
编号|HTTP服务端模板配置|1
端口|HTTP服务端模板配置|8080
关联HTTP客户端模板配置1|服务类型|NPCF_POLICYAUTHORIZATION
HTTP IPv6模板ID|关联HTTP客户端模板配置1|1
关联HTTP客户端模板配置2|服务类型|NBSF_MGT
HTTP IPv6模板ID|关联HTTP客户端模板配置2|2
服务基础配置1|服务类型|NPCF
Fqdn|服务基础配置1|pcf.zte.com.cn
版本|服务基础配置1|v1
优先级|服务基础配置1|1
服务基础配置2|服务类型|NPCF_POLICYAUTHORIZATION
Fqdn|服务基础配置2|pcf.zte.com.cn
版本|服务基础配置2|v1
优先级|服务基础配置2|1
（可选）NRF服务器分组配置1|NRF服务器组编号|1
描述信息|（可选）NRF服务器分组配置1|NrfMaster
（可选）NRF服务器分组配置2|NRF服务器组编号|2
描述信息|（可选）NRF服务器分组配置2|NrfSlave
（可选）NRF服务器节点配置1|NRF服务器节点编号|1
NRF服务器IP地址|（可选）NRF服务器节点配置1|4004::19:3
NRF服务器端口|（可选）NRF服务器节点配置1|8080
NRF服务器FQDN|（可选）NRF服务器节点配置1|nrf1.hatt.zte.com.cn
URI scheme|（可选）NRF服务器节点配置1|http
HTTP客户端模板编号|（可选）NRF服务器节点配置1|1
通知时使用的HTTP服务端模板编号|（可选）NRF服务器节点配置1|1
NRF服务器节点优先级|（可选）NRF服务器节点配置1|1
归属的NRF服务器组编号|（可选）NRF服务器节点配置1|1
（可选）NRF服务器节点配置2|NRF服务器节点编号|2
NRF服务器IP地址|（可选）NRF服务器节点配置2|4004::19:4
NRF服务器端口|（可选）NRF服务器节点配置2|8080
NRF服务器FQDN|（可选）NRF服务器节点配置2|nrf2.hatt.zte.com.cn
URI scheme|（可选）NRF服务器节点配置2|http
HTTP客户端模板编号|（可选）NRF服务器节点配置2|2
通知时使用的HTTP服务端模板编号|（可选）NRF服务器节点配置2|2
NRF服务器节点优先级|（可选）NRF服务器节点配置2|2
归属的NRF服务器组编号|（可选）NRF服务器节点配置2|2
（可选）NRF服务器策略配置|NRF服务器策略编号|1
NRF模式|（可选）NRF服务器策略配置|NRFPATTERN="DUAL_ACTIVE"
（可选）NRF服务器模板配置|NRF服务器模板编号|1
NRF服务器策略编号|（可选）NRF服务器模板配置|1
主用NRF服务器组编号|（可选）NRF服务器模板配置|1
备用NRF服务器组编号|（可选）NRF服务器模板配置|2
（可选）NRF服务器模板选择配置|NF类型|BSF_TYPE
NRF服务器模板编号|（可选）NRF服务器模板选择配置|1
（可选）DNN启用BSF配置|DNN|ims
启用BSF|（可选）DNN启用BSF配置|ENABLE
邻接主机IP配置|邻接主机编号|7
主机IP地址|邻接主机IP配置|4003::19:17
掩码长度|邻接主机IP配置|128
邻接主机类型|邻接主机IP配置|AF/NEF
邻接主机组编号|邻接主机IP配置|0
应用标识配置1|应用标识|1001
应用标识描述|应用标识配置1|1001
签约业务标识|应用标识配置1|1
签约业务标识描述|应用标识配置1|1
应用标识配置2|应用标识|1002
应用标识描述|应用标识配置2|1002
签约业务标识|应用标识配置2|2
签约业务标识描述|应用标识配置2|2
AF应用标识映射配置1|AFAI|3
应用标识|AF应用标识映射配置1|1001
AF应用标识映射配置2|AFAI|4
应用标识|AF应用标识映射配置2|1002
策略类型|控制条件|决策参数
---|---|---
N7业务策略|Gx应用标识1001|N7 PCC规则参数集1
Gx应用标识1002|N7业务策略|N7 PCC规则参数集2
######## 配置步骤 
配置基础数据
配置HTTP客户端模板 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=2,IPADDR=4003::19:5,STARTPORT=30001,ENDPORT=40000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端模板 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NPCF_POLICYAUTHORIZATION",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=2,SERVICETYPE="NBSF_MGT",HTTP4CLTID=0,HTTP6CLTID=2,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF_POLICYAUTHORIZATION",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,TOPHIDE="NOTHIDE",SCHEMA="HTTP"
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
（可选）NRF服务器相关配置。 
配置NRF服务器分组 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="4004::19:3",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=2,SERVERIPADDR="4004::19:4",SERVERPORT=8080,SERVERFQDN="nrf2.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=2,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1
配置NRF服务器策略 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="BSF_TYPE",NRFPROFILEID=1
（可选）配置DNN启用BSF 
[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html):DNN="ims",BSF="ENABLE"
配置邻接主机IP 
[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html):ADJHOSTID="7",HOSTIPADDRESS="4003::19:17",MASKLEN="128",HOSTTYPE="AF"
配置应用标识 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1",BEARCTRMODE="UE_NW",PREPROV="YES",DATABWLSTIND="WHITELIST"
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="1002",SUBSID="2",SUBSDESC="2",BEARCTRMODE="UE_NW",PREPROV="YES",DATABWLSTIND="WHITELIST"
配置AF应用标识映射 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=1,AFAI="3",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1001
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=2,AFAI="3",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1001
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=3,AFAI="4",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1002
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=4,AFAI="4",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1002
配置规则条件
Gx标识条件 
条件名称|参数|取值
---|---|---
Gx应用标识1001|选择策略变量|其他
策略变量类别|Gx应用标识1001|会话信息类
策略变量|Gx应用标识1001|Gx应用标识
操作符|Gx应用标识1001|=
值类型|Gx应用标识1001|值
值|Gx应用标识1001|1001
Gx应用标识1002|选择策略变量|其他
策略变量类别|Gx应用标识1002|会话信息类
策略变量|Gx应用标识1002|Gx应用标识
操作符|Gx应用标识1002|=
值类型|Gx应用标识1002|值
值|Gx应用标识1002|1002
配置规则动作参数
N7业务决策动作参数 
动作参数名称|参数名称|取值
---|---|---
action_N7pcc1|动作参数类型|N7 PCC规则参数集
PCC规则名称|action_N7pcc1|N7pcc1
PCC规则类型|action_N7pcc1|动态规则
QoS控制策略ID|action_N7pcc1|N7QoS1
流量控制策略ID|action_N7pcc1|N7RouteTC1
计费控制策略ID|action_N7pcc1|N7Chg1
Monitoring Key|action_N7pcc1|1
action_N7pcc2|动作参数类型|N7 PCC规则参数集
PCC规则名称|action_N7pcc2|N7pcc2
PCC规则类型|action_N7pcc2|动态规则
QoS控制策略ID|action_N7pcc2|N7QoS2
流量控制策略ID|action_N7pcc2|N7RouteTC2
计费控制策略ID|action_N7pcc2|N7Chg2
Monitoring Key|action_N7pcc2|2
动作参数名称|参数名称|取值
---|---|---
N7QoS1|动作参数类型|QoS参数集
动作参数名称|N7QoS1|N7QoS1
QoS控制策略ID|N7QoS1|QoS1
5QI|N7QoS1|5
ARP优先级|N7QoS1|10
ARP抢占能力|N7QoS1|可以抢占
ARP被抢占能力|N7QoS1|可以被抢
N7QoS2|动作参数类型|QoS参数集
动作参数名称|N7QoS2|N7QoS2
QoS控制策略ID|N7QoS2|QoS2
5QI|N7QoS2|6
ARP优先级|N7QoS2|20
ARP抢占能力|N7QoS2|可以抢占
ARP被抢占能力|N7QoS2|可以被抢占
动作参数名称|参数名称|取值
---|---|---
N7RouteTC1|动作参数类型|TC参数集
动作参数名称|N7RouteTC1|N7RouteTC1
流量控制策略ID|N7RouteTC1|TC1
路由目的地|N7RouteTC1|N7Route1
N7RouteTC2|动作参数类型|TC参数集
动作参数名称|N7RouteTC2|N7RouteTC2
流量控制策略ID|N7RouteTC2|TC2
路由目的地|N7RouteTC2|N7Route2
动作参数名称|参数名称|取值
---|---|---
N7Route1|动作参数类型|路由目的地参数集
动作参数名称|N7Route1|N7Route1
DNAI|N7Route1|dnai1
N7Route2|动作参数类型|路由目的地参数集
动作参数名称|N7Route2|N7Route2
DNAI|N7Route2|dnai2
动作参数名称|参数名称|取值
---|---|---
N7Chg1|动作参数类型|Charging参数集
动作参数名称|N7Chg1|N7Chg1
计费控制策略ID|N7Chg1|1
费率组|N7Chg1|1
AF计费标识|N7Chg1|1
计费上报等级|N7Chg1|赞助支付等级
动作参数名称|参数名称|取值
---|---|---
N7Chg2|动作参数类型|Charging参数集
动作参数名称|N7Chg2|N7Chg2
计费控制策略ID|N7Chg2|2
费率组|N7Chg2|2
AF计费标识|N7Chg2|2
计费上报等级|N7Chg2|赞助支付等级
配置场景
场景规则关联 
场景名称|参数|取值
---|---|---
TrafficInfluRole|入口1|入口类型|接入信息类
已选入口|TrafficInfluRole|入口1|接入类型
取值|TrafficInfluRole|入口1|3GPP接入
N7业务策略规则 
规则名称|规则参数|参数取值
---|---|---
rule_serv1|优先级|10
动作类型|rule_serv1|参数填充
日志开关|rule_serv1|关闭
条件表达式|rule_serv1|Gx应用标识 = 1001
选中动作参数名称|rule_serv1|action_N7pcc1
规则名称|规则参数|参数取值
---|---|---
rule_serv2|优先级|10
动作类型|rule_serv2|参数填充
日志开关|rule_serv2|关闭
条件表达式|rule_serv2|Gx应用标识 = 1002
选中动作参数名称|rule_serv2|action_N7pcc2
######## 配置脚本 
//配置Gx标识条件 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="Gx应用标识1001",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1001";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="Gx应用标识1002",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1002";
//配置规则动作参数 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7Chg1",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"3"&"SYS.CHG_RATING_GROUP"-"0"-"1"&"SYS.CHG_REPORTING_LEVEL"-"0"-"SERVICE_IDENTIFIER_LEVEL"&"SYS.CHG_AF_CHARGING_ID"-"0"-"1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7Chg2",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"4"&"SYS.CHG_RATING_GROUP"-"0"-"2"&"SYS.CHG_REPORTING_LEVEL"-"0"-"SERVICE_IDENTIFIER_LEVEL"&"SYS.CHG_AF_CHARGING_ID"-"0"-"2";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS1"&"SYS.QOS_5QI"-"0"-"5"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"10"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS2"&"SYS.QOS_5QI"-"0"-"6"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"20"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7Route1",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"0"-"dnai1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7Route2",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"0"-"dnai2";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC1",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC1"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"N7Route1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC2",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC2"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"N7Route2";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc1",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc1"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS1"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC1"&"SYS.N7_PCC_CHARGING_ID"-"0"-"N7Chg1"&"SYS.N7_MONITOR_KEY"-"0"-"1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc2",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc2"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS2"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC2"&"SYS.N7_PCC_CHARGING_ID"-"0"-"N7Chg2"&"SYS.N7_MONITOR_KEY"-"0"-"2";
//配置场景规则关联 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv1",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{Gx应用标识1001}",ACTTYPE="PARAM",ACTNAME="action_N7pcc1",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv2",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{Gx应用标识1002}",ACTTYPE="PARAM",ACTNAME="action_N7pcc2",LOGFLAG="OFF",RULENO=0;
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="TrafficInfluRole",ENTRANCE="SYS.ACCESS_TYPE"-"3GPP_ACCESS",RULENAME="rule_serv1"&"rule_serv2",VALIDFLAG="ENABLE";
##### 测试用例 
测试项目|根据媒体类型进行QoS、计费策略控制
---|---
预置条件|PCF运行正常，与周边NF通讯正常。PCF已完成基础数据配置（“配置实例”中介绍的配置内容）。其中，AF应用标识映射：ADD AFAPPMEDIA:ID=1,AFAI="1",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1001ADD AFAPPMEDIA:ID=2,AFAI="1",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1001ADD AFAPPMEDIA:ID=3,AFAI="2",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1002ADD AFAPPMEDIA:ID=4,AFAI="2",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1002已完成N7业务规则的配置。Gx Application ID=1001，下发业务规则1，对应该业务规则下的QOS1、TC1、CHARGE1参数集。Gx Application ID=1002，下发业务规则2，对应该业务规则下的QOS2、TC2、CHARGE2参数集。
测试过程|建立N7会话。模拟AF创建N5会话，消息中携带媒体1信息：AFAI为1、媒体类型OTHER、媒体子部件包含上下行的NOINFO流。修改N5会话，消息中携带媒体2信息：AFAI为2、媒体类型OTHER、媒体子部件包含上下行的NOINFO流。释放N5会话、N7会话。
通过准则|用户成功上线。N5会话建立成功，PCF给SMF下发业务规则1，包含：N5请求消息中携带的媒体1对应的路由参数。下发QOS1、TC1、CHARGE1对应的参数集内容。修改N5会话，重新下发规则，包含：下发业务规则2，下发QOS2、TC2、CHARGE2对应的参数集内容。删除业务规则1。
### 缩略语 
### 缩略语 
#### 5GC 
5G Core Network5G核心网
#### 5QI 
5G QoS Identifier5G QoS标识
#### AF 
Application Function应用功能
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### BSF 
Binding Support Function绑定支持功能
#### DNAI 
DN Access Identifier数据网络接入标识符
#### DNN 
Data Network Name数据网名称
#### EM 
Element Management网元管理
#### GBR 
Guaranteed Bit Rate保证比特率
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### IPv4 
Internet Protocol Version 4互联网通信协议第四版
#### IPv6 
Internet Protocol Version 6互联网通信协议第六版
#### MBR 
Maximum Bit Rate最大比特率
#### MSISDN 
Mobile Station International Subscriber Directory Number移动台国际用户目录号
#### NEF 
Network Exposure Function网络开放功能
#### NF 
Network Function网络功能
#### PCC 
Policy and Charging Control计费和策略控制
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PCF 
Policy Control Function策略控制功能
#### PDU 
Packet Data Unit分组数据单元
#### QoS 
Quality of Service服务质量
#### RCP 
Resource Control Platform资源控制平台
#### RG 
Rating Group费率组
#### RTP 
Real-time Transport Protocol实时传输协议
#### SID 
Service Identifier业务标识
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### TLS 
Transport Layer Security传输层安全
#### UDR 
Unified Data Repository统一数据存储
#### UPF 
User Plane Function用户平面功能
#### URI 
Uniform Resource Identifier统一资源标识符
#### URLLC 
Ultra Reliable Low Latency Communication超高可靠超低时延通信
#### VoNR 
Voice over New Radio新空口承载语音
### ZUF-59-51-053 N28接口 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
策略计数器（policyCounterId，简称PCID）|CHF通过定义的策略计数器（如套餐的消费情况）跟踪某个用户消费的情况。当CHF发现定义的策略计数器达到某种等级的消费配额时（如80%），通知PCF该策略计数器状态已达消费配额的80%，PCF根据策略计数器状态进行策略决策。
策略计数器状态（Policy Counter Status，简称PCS）|与策略计数器相互关联，用于指示策略计数器对应的消费配额，通过currentStatus字段值标识，例如：策略计数器状态为1，表示已达消费配额的50%。策略计数器状态为2，表示已达消费配额的80%。策略计数器状态为3，表示该消费配额已耗尽。
##### 描述 
####### 特性定义 
N28是CHF提供的服务化接口。
PCF作为Nchf_SpendingLimitControl服务的使用者，通过N28接口向CHF查询策略计数器的状态，并订阅或取消订阅指定用户的策略计数器状态的变更通知。
PCF根据实时的策略计数器状态，对用户的数据业务消费限额进行控制。 
基于N28接口的消费限额控制，主要包括如下内容： 
PCF订阅策略计数器状态（PCS）的变更通知，同时查询策略计数器状态。 
PCF去订阅所有策略计数器状态变化通知，不再关心CHF上的策略计数器状态变化。 
CHF通知PCF订阅的策略计数器状态变化。CHF也可通知一个或多个未来时间点生效策略计数器的状态，以指示该时间点时策略计数器状态生效。 
CHF也可通知PCF终止某用户的所有策略计数器订阅。 
####### 背景知识 
CHF是5GC中的计费网元。BOSS系统以及SMF、AMF等网元实时更新用户计费信息，PCF通过N28接口获取这些信息。
N28接口功能与非服务化的Sy口接口功能对应。PCRF通过Sy接口向OCS查询策略计数器状态，或收到OCS更新的策略计数器状态。
##### 应用场景 
N28接口用于PCF基于用户的签约信息向CHF订阅策略计数器状态，对用户的数据业务实时进行消费限额控制。
应用于运营商期望对用户实施动态的计费控制的场景。例如，PCF对后付费用户，在非漫游时实施离线计费，在漫游时实施在线计费。 
##### 客户收益 
受益方|受益描述
---|---
运营商|PCF基于CHF在N28接口提供的策略计数器状态信息进行策略和计费控制，可以使PCF及时响应策略和计费控制变化，准确实施消费限额控制。
终端用户|用户可以及时感知套餐消费情况。

##### 实现原理 

###### 系统架构 
本特性所涉及的系统架构如下图所示，RCP作为PCF，N28接口为CHF和RCP之间的接口。
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.jpg)
###### 涉及的网元 
网元|描述
---|---
RCP|向CHF查询策略计费信息和策略计费状态，包括注册、更新、去注册策略计费信息的变更，用于策略决策。
CHF|维护RCP的订阅信息，向RCP提供策略计费信息的查询接口及状态变更的通知。
SMF|向RCP提供PDU会话信息，根据RCP下发的SM策略信息，下发给UPF执行。
###### 协议栈 
RCP与CHF间的N28接口协议栈如下图所示。
[]images/1624612536272.png)协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。
N28接口支持的消息参见下表。 
NF|服务|操作|操作语义|HTTP方法|资源URL|说明
---|---|---|---|---|---|---
CHF|Nchf_SpendingLimitControl|Subscribe|Request/Response|POST|{apiRoot}/nchf-spendinglimitcontrol/v1/subscriptions|当RCP根据用户签约判断需要订阅策略计数器状态时，可用此操作创建用户的策略计费会话，携带订阅的策略计数器ID。
PUT|CHF|Nchf_SpendingLimitControl|Subscribe|Request/Response|{apiRoot}/nchf-spendinglimitcontrol/v1/subscriptions/{subscriptionId}|当RCP根据用户签约判断需要更新订阅的策略计数器，或者需要全量获取一次已订阅的策略计数器的状态时，可用此操作更新用户的策略计费会话，携带全部订阅的策略计数器ID。
Unsubscribe|CHF|Nchf_SpendingLimitControl|Request/Response|DELETE|{apiRoot}/nchf-spendinglimitcontrol/v1/subscriptions /{subscriptionId}|当RCP不再关心用户的任何策略计数器状态，或者用户下线时，RCP可用此操作取消订阅，删除用户的策略计费会话。
Notify|CHF|Nchf_SpendingLimitControl|Request/Response|POST|{notifUri}/notify|当CHF检测到策略计数器状态发生改变时，使用此操作发送通知给RCP，携带发生变化的策略计数器及其状态。
POST|Notify|CHF|Nchf_SpendingLimitControl|Request/Response|{notifUri}/terminate|当CHF检测到系统中某用户被删除时，使用此操作发送通知给RCP，终止该用户的策略计费会话。
###### 业务流程 
######## 策略计数器初始订阅流程 
[]images/1627874931021.png)流程说明如下： 
SMF请求PDU会话建立，向RCP发送Npcf_SMPolicyControl_Create请求，消息中包含的关键参数参见ZUF-59-53-052 PDU会话策略控制
相关业务流程。
RCP基于该用户的签约信息获取待订阅的PCID列表，判断需要触发策略计费会话的建立。若本地无CHF局向地址信息，则RCP需要向NRF发送Nnrf_NFDiscovery请求，消息中包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:method: GET:scheme: http或https:path: /nnrf-disc/v1/nf-instances?gpsi=msisdn-8612345678900&preferred-locality={Loc}&requester-nf-instance-fqdn=pcf.zte.com.cn&requester-nf-instance-id={NFInstanceID}&requester-nf-type=PCF&service-names=nchf-spendinglimitcontrol&target-nf-type=CHF发现CHF携带的参数有：用户的主用标识，gpsi或supi，例如：gpsi=msisdn-8612345678900（可选）位置优选参数，例如：preferred-locality={Loc}请求查询的NF的FQDN，即RCP的FQDN，例如：requester-nf-instance-fqdn=pcf.zte.com.cn请求查询的NF实例号，即RCP的nfInstanceId，例如：requester-nf-instance-id={NFInstanceID}请求查询的NF类型，即RCP的NFType，例如：requester-nf-type=PCF查询目标NF的服务名，例如：service-names=nchf-spendinglimitcontrol查询目标NF的类型，例如：target-nf-type=CHF:authority: NRF主机地址:端口，端口可选，默认80；主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80。
NRF基于RCP请求的参数列表，筛选出符合条件的CHF列表信息，向RCP发送Nnrf_NFDiscovery应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK --http头域的status类似于diameter响应的Result-Code
nfInstances|NFProfile列表，每个NFProfile主要包含：nfInstanceId：NF实例号nfType：NF类型nfStatus：NF状态capacity：NF的容量load：NF的负荷priority：NF的优先级chfInfo：NF（CHF）支持的号段列表信息nfServices：NF内的服务列表
nfServices|NFService列表，每个NFService主要包含：serviceInstanceId：服务的实例号serviceName：服务名scheme：通讯连接使用的方式，http或httpsnfServiceStatus：服务实例的状态fqdn：服务实例的FQDN信息ipEndPoints：服务实例的通讯地址&端口capacity：服务实例的容量load：服务实例的负荷priority：服务实例的优先级，比NF实例的优先级高
RCP根据NRF返回的可用CHF列表，或者本地匹配的可用CHF列表，选择优先级最高NF及其服务实例，向CHF发送Nchf_SpendingLimitControl_Subscribe请求，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /nchf-spendinglimitcontrol/v1/subscriptions:authority: CHF主机:端口
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI）
gpsi|一般公共签约用户标识（Generic Public Subscription Identifier，例如MSISDN）
policyCounterIds|通过“用户级策略计数器标识配置”和“套餐级策略计数器标识配置”配置的PCID列表。
notifUri|通知URI，即RCP后续接收CHF发送策略计费状态变更或释放通知请求的URI地址，该地址的IP和端口从“通知URI服务端模板配置”中配置的CHF服务对应的模板ID中获取。
CHF查询到PCID对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 201 Created —— 建立成功:location: {authority}/nchf-spendinglimitcontrol/v1/subscriptions/{subscriptionId}，其中subscriptionId由CHF网元生成，用于标识CHF上的资源Id，RCP后续对该资源更新、去订阅时，需要携带。
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI）
statusInfos|PolicyCounterInfo列表，标识所有订阅的PCID的状态，每个PolicyCounterInfo主要包含：policyCounterId：订阅的PCIDcurrentStatus：该PCID当前的状态（可选）penPolCounterStatuses：该PCID未来时间点后的状态，此参数里包含：activationTime -- 未来的时间点policyCounterStatus -- 未来时间点后的状态
RCP根据CHF返回的策略计数器的状态、签约信息等进行策略决策，向SMF发送Npcf_SMPolicyControl_Create应答，消息中包含的关键参数参见ZUF-59-53-052 PDU会话策略控制
相关业务流程。
######## 策略计数器更新订阅流程 
[]images/1627875119308.png)流程说明如下： 
当RCP检测到待订阅的PCID列表有新增时，触发策略计费会话更新，向CHF发送Nchf_SpendingLimitControl_Subscribe请求，消息中包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:method: PUT:scheme: http或https:path: /nchf-spendinglimitcontrol/v1/subscriptions/{subscriptionId}，subscriptionId为创建会话响应的头部Location携带的。:authority: CHF主机:端口
policyCounterIds|订阅的全量PCID字符串列表
CHF查询到PCID对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK
statusInfos|同策略计数器初始订阅流程步骤5里的参数
RCP根据CHF返回的新的策略计数器的状态、签约信息等进行策略决策，向SMF发送Npcf_SMPolicyControl_UpdateNotify请求，消息中包含的关键参数参见ZUF-59-53-052 PDU会话策略控制
相关业务流程。
SMF执行最新的SM策略，向RCP发送Npcf_SMPolicyControl_UpdateNotify应答。 
######## 策略计数器去订阅流程 
[]images/1627875153934.png)流程说明如下： 
UE发起PDU会话释放流程，SMF查找到某PDU会话有相关的SM策略关联，向RCP发送Npcf_SMPolicyControl_Delete请求，请求RCP删除SM策略关联。 
RCP收到Npcf_SMPolicyControl_Delete请求后，删除对应的会话，向SMF发送成功的Npcf_SMPolicyControl_Delete应答。 
RCP检测到用户会话都已下线，触发用户离线流程，并触发用户的策略计费会话释放流程，向CHF发送Nchf_SpendingLimitControl_Unsubscribe请求，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: DELETE:scheme: http或https:path: /nchf-spendinglimitcontrol/v1/subscriptions/{subscriptionId}，subscriptionId为创建会话响应的头部Location携带的。:authority: CHF主机:端口
CHF根据subscriptionId定位到策略计费会话资源，释放会话并向RCP发送Nchf_SpendingLimitControl_Unsubscribe应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 204 No Content
 说明： 
策略会话释放请求和应答消息都不携带Body信息。 
######## 策略计数器状态通知流程 
[]images/1627875196621.png)流程说明如下： 
CHF检测到RCP订阅的PCID对应的状态发生变更，则会向RCP发送Nchf_SpendingLimitControl_Notify请求，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {notifUri}/notify，notifUri是RCP订阅PCID列表的请求消息里携带的。:authority: RCP主机:端口
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI）
statusInfos|PolicyCounterInfo列表，采用增量更新的方式，标识状态有变化的PCID的最新状态信息。每个PolicyCounterInfo主要包含：policyCounterId：状态发生变化的PCIDcurrentStatus：该PCID当前的状态（可选）penPolCounterStatuses：该PCID未来时间点后的状态，此参数里包含：activationTime -- 未来的时间点policyCounterStatus -- 未来时间点后的状态
RCP更新相应的PCID的状态，并向CHF发送Nchf_SpendingLimitControl_Notify应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 204 No Content
RCP根据最新的策略计数器状态、签约信息等进行策略决策，向SMF发送Npcf_SMPolicyControl_UpdateNotify请求。 
SMF执行最新的SM策略，向RCP发送Npcf_SMPolicyControl_UpdateNotify应答。 
######## 策略计费会话终止通知流程 
[]images/1627875225323.png)流程说明如下：
CHF检测到系统中某个用户被删除，则会找到该用户的策略计费会话，向RCP发送携带terminate指示的Nchf_SpendingLimitControl_Notify请求，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {notifUri}/terminate，notifUri是RCP订阅PCID列表的请求消息里携带的。:authority: RCP主机:端口
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI）
termCause|终止原因：例如REMOVED_SUBSCRIBER，用户被删除。
RCP也会删除该用户的策略计费会话，并向CHF发送Nchf_SpendingLimitControl_Notify应答，消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 204 No Content
RCP根据用户的其他信息，例如签约信息等进行策略决策，向SMF发送Npcf_SMPolicyControl_UpdateNotify请求更新或删除SM策略。 
SMF执行最新的SM策略，向RCP发送Npcf_SMPolicyControl_UpdateNotify应答。 
###### 本网元实现 
######## RCP向CHF发起策略计费会话建立 
策略计费会话触发时机 
RCP只会为一个用户建立一个策略计费会话。当用户上线RCP获取到签约信息后，可以通过签约的套餐、扩展属性、计费类型等在“用户级策略计数器标识配置”和“套餐级策略计数器标识配置”中获取到当前用户需要订阅的PCID列表。PCID可分为用户级PCID和套餐级PCID，这两种类型的定义主要取决于CHF与RCP规划用量配额是用户级还是套餐级： 
CHF与RCP规划关注用户级用量配额，则定义用户级PCID。 
CHF与RCP规划关注套餐级用量配额，则定义套餐级PCID。 
套餐级PCID可以指定生成，也可以根据套餐实例号生成 。 
当RCP决策出需要订阅的PCID列表时，则会去判断是否需要通过N28接口建立CHF会话。 
RCP选择CHF或OCS获取策略计费信息
RCP支持为4/5G用户通过CHF或OCS获取策略计费信息。RCP主要根据1255开关（Sy/N28选择方式）、用户签约信息来判断，具体选择场景参见下表。 
1255开关值|用户签约携带networkType，指示为5G用户|用户签约携带networkType，指示为4G用户|未携带networkType
---|---|---|---
0|N28|Sy|Sy
1|N28|Sy|N28
2|Sy|Sy|Sy
3|N28|N28|N28
4|优选N28，次选Sy|优选N28，次选Sy|优选N28，次选Sy
5|优选Sy，次选N28|优选Sy，次选N28|优选Sy，次选N28
 说明： 
开关值4或5时，优选次选的含义是未获取到优选对应网元的局向地址信息时，则去获取次选对应网元的局向地址信息。 
当符合上述表格里选择N28接口的条件时，RCP就会向CHF发起策略计费会话的建立。 
######## CHF地址信息的获取 
5G组网中引入了NRF网元，可以通过动态发现方式寻址目标NF；同时，在某些运营商的组网规划中，也会不考虑从NRF网元寻址，采用直接在RCP上配置目标NF地址的静态方式。RCP支持通过动态发现或静态配置的方式分析CHF的地址信息，需要根据运营商的组网规划，在CommonS_HTTP_LB服务下的“服务发现方式”里配置对应CHF地址获取方式。 
RCP配置CHF的服务发现方式为“动态” 
该场景下，RCP通过匹配本地发现缓存，或向NRF网元发现CHF的方式获取CHF地址。 
RCP会根据用户号码优先匹配本地的发现缓存，匹配不到时会携带目标NF类型、主用户标识关键字、可选的RCP位置等参数向NRF发送发现请求；当NRF在响应里返回可用的NF列表后，RCP根据优先级、负荷及链路状态等选择可用的CHF地址发送消息，以此来实现多CHF时的主备或负荷分担方式。若获取不到，则发送消息失败。 
RCP配置CHF的服务发现方式为“静态” 
该场景下，RCP通过匹配CommonS_HTTP_LB服务下的“本地NRF配置”来获取CHF地址。 
本地NRF配置是一组配置，配置内容与NRF发现响应的内容相同，将CHF支持的号段、网元状态、优先级、通讯地址IP&Port、FQDN、位置等参数加到配置里。可以在本地配置一个或多个CHF网元。 
RCP使用目标NF类型、主用户标识关键字等参数匹配本地NRF配置，筛选出可用的CHF列表；并根据优先级、负荷及链路状态等选择可用的CHF地址发送消息，以此来实现多CHF时的主备或负荷分担方式。若获取不到，则发送消息失败。 
RCP配置CHF的服务发现方式为“动态优先” 
该场景下，RCP优先根据动态发现的方式获取CHF地址。若获取不到，则通过静态配置的方式获取。若通过静态配置仍获取不到CHF的地址，则发送消息失败。 
######## 策略计费会话的更新 
RCP会在以下几种场景触发策略计费会话的更新流程： 
由于套餐变更等原因，RCP对于当前用户需要订阅的PCID列表存在新增的PCID时，则会触发策略计费会话的更新流程，携带完整的PCID列表订阅信息。 
跨账期后RCP主动发起PCS查询：针对部分和RCP对接的CHF，不能在跨账期时主动推送新的PCS（如果有变化）到RCP。此种场景下，可以在“限速策略计数器状态配置”中配置PCID+PCS，当RCP主动查询到当前用户的PCID+PCS在配置中存在时，则会在用户级账期发生切换后的N分钟（全局开关1072的值）后，主动发起策略计费会话更新流程，查询所有需要订阅的PCID的PCS。 
RCP发生容灾后，在备用局接管用户会话后，若全局开关1232配置为1，会主动触发策略计费会话的更新流程，除了携带完整的PCID列表订阅信息外，还会更新notifUri。 
CHF会在以下场景触发策略计费会话的状态更新通知流程： 
当CHF检测到RCP订阅的某个PCID对应的状态发生变化时，则会触发给RCP的通知流程，携带状态发生变化的PCID及其最新的状态信息。 
######## 策略计费会话的释放 
RCP会在以下几种场景触发策略计费会话的释放流程： 
用户的最后一个承载会话下线时，RCP会触发当前用户的策略计费会话释放流程。 
由于套餐变更等原因，对于当前用户不再需要订阅任何PCID时，RCP会触发当前用户的策略计费会话释放流程。 
CHF会在以下场景触发策略计费会话的释放流程： 
CHF检测到某用户从系统中被删除，使用Nchf_SpendingLimitControl_Notify服务操作，请求终止该用户的策略计费会话时，RCP会释放当前用户的策略计费会话。 
######## 未来时间点的PCS 
CHF返回PCID的PCS时，可能会携带未来时间点的PCS给RCP。RCP支持每PCID最多保存两个PCS状态切换的时间点，并在该时间点之后，触发用户进行重决策，RCP基于最新的PCS状态决策出用户新的策略。 
######## N28接口相关的业务键 
RCP基于CHF返回的策略计数器的状态进行决策。由于N28接口的PCID和PCS用途和含义与Sy接口一样，所以由CHF触发承载会话决策时，仍采用Sy接口的如下三个业务健作为决策的条件： 
自定义变量： 
字符型策略计数器状态（Sy）/String Policy Counter Status(Sy)--- 指定PCID对应的字符型PCS 
数值型策略计数器状态（Sy）/Numeric Policy Counter Status(Sy)--- 指定PCID对应的数值型PCS 
用户信息类： 
用户所有策略计数器状态（Sy）/User Owned Policy Counter Status(Sy)---用户当前的有效PCS中是否含有指定的PCS 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 29.594|Spending Limit Control Service
##### 特性能力 
名称|指标
---|---
每个套餐最多配置的PCID个数|8
每个用户的策略计费会话最多支持的PCID个数|64
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.21.10|首次发布。
####### License要求 
该特性为RCP网元的基本特性，无需License支持。
####### 对其他网元的要求 
N28接口特性需要PCF和CHF网元配合完成。其中，CHF向PCF提供策略计数器状态，PCF根据实时的策略计数器状态，对用户的数据业务消费限额进行控制。
##### O&M相关 
####### 命令 
配置项表1  新增命令编号命令项命令名称描述1用户级策略计数器标识配置ADD USERPCID新增用户级策略计数器标识SET USERPCID修改用户级策略计数器标识DEL USERPCID删除用户级策略计数器标识SHOW USERPCID查询用户级策略计数器标识2套餐级策略计数器标识配置ADD PCID新增套餐级策略计数器标识SET PCID修改套餐级策略计数器标识DEL PCID删除套餐级策略计数器标识SHOW PCID查询套餐级策略计数器标识3限速策略计数器状态配置ADD SPDPCS增加限速策略计数器状态DEL SPDPCS删除限速策略计数器状态SHOW SPDPCS查询限速策略计数器状态表2  修改命令编号命令项命令名称描述1关联HTTP客户端模板配置ADD SVCHTTPCLTPROF“服务类型”新增枚举值：Nchf_SpendingLimitControl2通知URI服务端模板配置ADD NOTIURISVRTPROF“服务类型”新增枚举值：Nchf_SpendingLimitControl3服务发现方式配置ADD SBISRVDISCOVERYMODE“目标NF类型”新增枚举值：CHF 
定时器N28接口和Sy接口共用如下定时器：定时器编号默认值(毫秒)描述20703000PCF发消息给CHF后，等待CHF返回响应的时长。 
全局变量参数编号参数名称描述使用方法1072跨月清零时间点延迟发送SLR的分钟数开关取值为0-720，单位分钟，默认值为30。通过命令SHOW SYS GLOBPARA DETAIL:BEGIN=1072,END=1072,EXTFLAG=1，查看“全局开关1072”的取值。通过命令SET SYS GLOBPARA:IDX=1072,CURVAL="30",EXTFLAG=1，修改“全局开关1072”的取值。1232容灾后主动发送N28更新消息开关取值为0-1，默认值为1，含义如下：0-否1-是通过命令SHOW SYS GLOBPARA:BEGIN=1232,END=1232,EXTFLAG=0，查看“全局开关1232”的取值。通过命令SET SYS GLOBPARA:IDX=1232,CURVAL="1",EXTFLAG=0，修改“全局开关1232”的取值。1255Sy/N28选择方式开关取值为0-5，默认值为0，含义如下：0-按networkTYPE选择，无networkTYPE选Sy1-按networkTYPE选择，无networkTYPE选N282-全选Sy3-全选N284-优选N28，次选Sy5-优选Sy，次选N28通过命令SHOW SYS GLOBPARA:BEGIN=1255,END=1255,EXTFLAG=1，查看“全局开关1255”的取值。通过命令SET SYS GLOBPARA:IDX=1255,CURVAL="0",EXTFLAG=1，修改“全局开关1255”的取值。 
动态管理N28接口和Sy接口共用人机命令SHOW_SY_SESS、REL_SY_SESS：查询在线用户CHF会话信息的命令是SHOW_SY_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460060601020000"删除在线用户CHF会话信息的命令是REL_SY_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460060601020000" 
####### 性能统计 
编号|测量类型名称|描述
---|---|---
1|52006 N28接口测量|编号为C52006开头的所有计数器
2|52026 CHF邻接主机测量|编号为C520260003-C520260035的所有计数器
3|00020 RCP系统资源统计|C000200134 在线N28会话数C000200135 在线N28会话数均值C000200136 在线N28会话数峰值
编号|测量类型名称|Index ID
---|---|---
1|52006 N28接口测量|（520069001）消费限额初始订阅成功率（%）
（520069002）消费限额取消订阅成功率（%）|1|52006 N28接口测量
（520069003）消费限额更新订阅成功率（%）|1|52006 N28接口测量
（520069004）消费限额通知更新成功率（%）|1|52006 N28接口测量
（520069005）消费限额通知终止成功率（%）|1|52006 N28接口测量
（520069006）消费限额通知终止成功率（去除用户原因）（%）|1|52006 N28接口测量
2|52026 CHF邻接主机测量|（520269001）消费限额初始订阅成功率（%）
（520269002）消费限额更新订阅成功率（%）|2|52026 CHF邻接主机测量
（520269003）消费限额取消订阅成功率（%）|2|52026 CHF邻接主机测量
####### 告警和通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置本地CHF 


 

###### 配置说明 
本地配置主备CHF，PCF通过N28接口向CHF查询策略计数器，注册、更新或去注册指定用户的策略计费信息及状态，并根据实时的策略计数器状态，进行用户的消费限额控制，例如达量限速。
###### 配置前提 
PCF与CHF之间的HTTP2链路配置完成。
###### 配置过程 
图1  配置流程
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B1.png)
配置过程包含如下步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，配置HTTP客户端模板。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，配置HTTP服务端模板。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，配置关联的HTTP客户端模板。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，配置服务基础信息。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
根据用户关键字配置对应的SUPI或者GPSI号段，两种方式二选一。
配置GPSI范围组执行ADD SBIGPSIRANGEARRID命令，配置GPSI范围组编号。执行ADD SBIGPSIRANGEARRPARAM命令，配置GPSI范围组参数。 
配置SUPI范围组执行ADD SBISUPIRANGEARRID命令，配置SUPI范围组编号。执行ADD SBISUPIRANGEARRPARAM命令，配置SUPI范围 
执行[ADD SBICHFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220961.html)命令，配置CHF信息。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html)命令，配置IPv6地址。
执行[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html)命令，配置IP端点。
执行[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html)命令，配置IP端点组编号。
执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，配置IP端点组参数。
执行[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html)命令，配置NF服务版本组编号。
执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，配置NF服务版本组参数。
执行[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html)命令，配置对端NF基本信息。
执行[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html)命令，配置对端NF扩展信息。
执行[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html)命令，配置对端NF实例。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，配置服务发现。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息。
执行[ADD PCID](../../Npcf_PolicyManagement\zh-CN\mml\1787549.html)命令，配置套餐级策略计数器标识。
在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。 
###### 配置实例 
######## 场景说明 
PCF携带套餐级策略计数器标识PCID向CHF订阅策略计数器状态，CHF根据PCID查询对应的策略计数器状态并返回给PCF，PCF根据策略计数器状态实行消费限额控制。假设PCS包含四个策略计数器状态，对应不同的限速策略，参见下表。
PCS|限速策略
---|---
0|不限速
1|限速3M
2|限速1M
3|限速128K
######## 数据规划 
类别|参数|取值
---|---|---
HTTP客户端模板配置|编号|1
IP地址|HTTP客户端模板配置|4003::19:5
起始端口|HTTP客户端模板配置|20000
终止端口|HTTP客户端模板配置|30000
HTTP服务端模板配置|编号|1
IP地址|HTTP服务端模板配置|4003::19:5
端口|HTTP服务端模板配置|8080
关联HTTP客户端模板配置|服务类型|NCHF_SPENDLMTCONTROL
HTTP IPv6模板ID|关联HTTP客户端模板配置|1
服务基础配置|服务类型|NPCF
Fqdn|服务基础配置|pcf.zte.com.cn
版本|服务基础配置|v1
优先级|服务基础配置|1
（可选）通知URI服务端模板配置|服务类型|NCHF_SPENDLMTCONTROL
服务端模板ID1|（可选）通知URI服务端模板配置|1
GPSI范围组编号配置|GPSI范围组编号|100
GPSI范围组参数配置|配置索引|100
GPSI范围组编号|GPSI范围组参数配置|100
开始|GPSI范围组参数配置|0000000000000
结束|GPSI范围组参数配置|9999999999999
CHF信息配置|CHF信息编号|100
GPSI范围组编号|CHF信息配置|100
IPv6地址配置1|IPv6地址编号|100
IP地址|IPv6地址配置1|4004::19:3
IPv6地址配置2|IPv6地址编号|101
IP地址|IPv6地址配置2|4004::19:4
IP端点配置1|IP端点编号|100
端口|IP端点配置1|8080
IPv6地址编号|IP端点配置1|100
IP端点配置2|IP端点编号|101
端口|IP端点配置2|8080
IPv6地址编号|IP端点配置2|101
IP端点组编号配置1|IP端点组编号|100
IP端点组编号配置2|IP端点组编号|101
IP端点组参数配置1|配置索引|100
IP端点组编号|IP端点组参数配置1|100
IP端点编号|IP端点组参数配置1|100
IP端点组参数配置2|配置索引|101
IP端点组编号|IP端点组参数配置2|101
IP端点编号|IP端点组参数配置2|101
NF服务版本组编号配置|NF服务版本组编号|100
NF服务版本组参数配置|配置索引|100
NF服务版本组编号|NF服务版本组参数配置|100
API URI版本号|NF服务版本组参数配置|v1
API完整版本号|NF服务版本组参数配置|v1
对端NF基本信息配置1|对端NF信息编号|100
NF实例标识|对端NF基本信息配置1|100
NF类型|对端NF基本信息配置1|CHF_TYPE
NF状态|对端NF基本信息配置1|REGISTERED
NF实例名称|对端NF基本信息配置1|260e6cfe-5eea-4036-8566-77744b5e7101
对端NF基本信息配置2|对端NF信息编号|101
NF实例标识|对端NF基本信息配置2|101
NF类型|对端NF基本信息配置2|CHF_TYPE
NF状态|对端NF基本信息配置2|REGISTERED
NF实例名称|对端NF基本信息配置2|260e6cfe-5eea-4036-8566-77744b5e7199
对端NF扩展信息配置1|对端NF信息编号|100
CHF信息编号|对端NF扩展信息配置1|100
对端NF扩展信息配置2|对端NF信息编号|101
CHF信息编号|对端NF扩展信息配置2|100
对端NF实例配置1|配置索引|100
归属NF编号|对端NF实例配置1|100
服务实例标识|对端NF实例配置1|100
服务名称|对端NF实例配置1|NCHF_SPENDINGLIMITCONTROL
服务版本组编号|对端NF实例配置1|100
协议模式|对端NF实例配置1|HTTP
服务实例状态|对端NF实例配置1|REGISTERED
域名|对端NF实例配置1|chf1.zte.com.cn
IP端点组编号|对端NF实例配置1|100
优先级|对端NF实例配置1|1
对端NF实例配置2|配置索引|101
归属NF编号|对端NF实例配置2|101
服务实例标识|对端NF实例配置2|101
服务名称|对端NF实例配置2|NCHF_SPENDINGLIMITCONTROL
服务版本组编号|对端NF实例配置2|100
协议模式|对端NF实例配置2|HTTP
服务实例状态|对端NF实例配置2|REGISTERED
域名|对端NF实例配置2|chf2.zte.com.cn
IP端点组编号|对端NF实例配置2|101
优先级|对端NF实例配置2|2
服务发现方式配置|目的NF类型|CHF_TYPE
发现方式|服务发现方式配置|STATIC_ONLY
地址选择方式|服务发现方式配置|RANDOM
http默认端口|服务发现方式配置|8080
https默认端口|服务发现方式配置|443
用户套餐配置|套餐编号|1
优先级|用户套餐配置|10
套餐级策略计数器标识配置|套餐级策略计数器标识配置编号|1
套餐编号|套餐级策略计数器标识配置|1
策略计数器标识1|套餐级策略计数器标识配置|1
策略类型|控制条件|决策参数
---|---|---
N7会话策略|pcid1=0|N7 会话规则参数集1
pcid1=1|N7会话策略|N7 会话规则参数集2
pcid1=2|N7会话策略|N7 会话规则参数集3
pcid1=3|N7会话策略|N7 会话规则参数集4
######## 业务配置关系 
图2  业务配置关系
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB%E5%9B%BE.png)
######## 配置步骤 
配置基础数据
配置HTTP客户端模板 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端模板 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=2,SERVICETYPE="NCHF_SPENDLMTCONTROL",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
（可选）配置通知URI服务端模板 
[ADD NOTIURISVRTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788170.html):SERVICETYPE="NCHF_SPENDLMTCONTROL",SVRID1=1
配置GPSI范围组编号 
[ADD SBIGPSIRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220693.html):ARRAYID=100
配置GPSI范围组参数 
[ADD SBIGPSIRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220697.html):INDEX=100,ARRAYID=100,START="0000000000000",END="9999999999999"
配置CHF信息 
[ADD SBICHFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220961.html):ID=100,GPSIRANGEARRAY=100
配置IPv6地址1 
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=100,IP="4004::19:3"
配置IPv6地址2 
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=101,IP="4004::19:4"
配置IP端点1 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=100,IPV6=100,PORT=8080
配置IP端点2 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=101,IPV6=101,PORT=8080
配置IP端点组编号1 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=100
配置IP端点组编号2 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=101
配置IP端点组参数1 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=100,ARRAYID=100,IPENDPOINT=100
配置IP端点组参数2 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=101,ARRAYID=101,IPENDPOINT=101
配置NF服务版本组编号 
[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html):ARRAYID=100
配置NF服务版本组参数 
[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html):INDEX=100,ARRAYID=100,APIVERSIONINURI="v1",APIFULLVERSION="v1"
配置对端NF基本信息1 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=100,NFINSTANCEID="100",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7101",PRIORITY=1
配置对端NF基本信息2 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=101,NFINSTANCEID="101",NFTYPE="CHF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7199",PRIORITY=2
配置对端NF扩展信息1 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=100,CHFINFO=100
配置对端NF扩展信息2 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=101,CHFINFO=100
配置对端NF实例1 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=100,NFINDEX=100,SRVINSTANCEID="100",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf1.zte.com.cn",IPENDPOINTARRAY=100,PRIORITY=1
配置对端NF实例2 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=101,NFINDEX=101,SRVINSTANCEID="101",SERVICENAME="NCHF_SPENDINGLIMITCONTROL",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="chf2.zte.com.cn",IPENDPOINTARRAY=101,PRIORITY=2
配置服务发现方式 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="CHF_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置套餐基本 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=10;
配置套餐级策略计数器标识 
[ADD PCID](../../Npcf_PolicyManagement\zh-CN\mml\1787549.html):ID=1,PKGID="1",GENMODE="SPECIFIC",CHARGTYPE=4294967295,PCID1="1"
配置策略
配置自定义策略变量 
自定义变量名称|策略变量|策略变量属性
---|---|---
pcid1|策略变量|字符型策略计数器状态(Sy)
策略计数器标识生成方式|pcid1|指定
策略计数器标识|pcid1|1
日志开关|pcid1|关闭
配置条件1 
条件名称|参数|取值
---|---|---
PCS=0|选择策略变量|其他
策略变量类别|PCS=0|自定义策略变量
策略变量|PCS=0|pcid1
操作符|PCS=0|=
值类型|PCS=0|值
值|PCS=0|0
配置条件2 
条件名称|参数|取值
---|---|---
PCS=1|选择策略变量|其他
策略变量类别|PCS=1|自定义策略变量
策略变量|PCS=1|pcid1
操作符|PCS=1|=
值类型|PCS=1|值
值|PCS=1|1
配置条件3 
条件名称|参数|取值
---|---|---
PCS=2|选择策略变量|其他
策略变量类别|PCS=2|自定义策略变量
策略变量|PCS=2|pcid1
操作符|PCS=2|=
值类型|PCS=2|值
值|PCS=2|2
配置条件4 
条件名称|参数|取值
---|---|---
PCS=3|选择策略变量|其他
策略变量类别|PCS=3|自定义策略变量
策略变量|PCS=3|pcid1
操作符|PCS=3|=
值类型|PCS=3|值
值|PCS=3|3
配置动作参数1 
动作参数名称|参数名称|取值
---|---|---
action_N7sess1|动作参数类型|N7会话参数集
会话规则名称|action_N7sess1|N7sess1
会话汇聚带宽决策方式|action_N7sess1|签约的APN带宽
配置动作参数2 
动作参数名称|参数名称|取值
---|---|---
action_N7sess2|动作参数类型|N7会话参数集
会话规则名称|action_N7sess2|N7sess2
会话AMBR上行速率(kbps)|action_N7sess2|2048
会话AMBR下行速率(kbps)|action_N7sess2|2048
配置动作参数3 
动作参数名称|参数名称|取值
---|---|---
action_N7sess3|动作参数类型|N7会话参数集
会话规则名称|action_N7sess3|N7sess3
会话AMBR上行速率(kbps)|action_N7sess3|1024
会话AMBR下行速率(kbps)|action_N7sess3|1024
配置动作参数4 
动作参数名称|参数名称|取值
---|---|---
action_N7sess4|动作参数类型|N7会话参数集
会话规则名称|action_N7sess4|N7sess4
会话AMBR上行速率(kbps)|action_N7sess4|128
会话AMBR下行速率(kbps)|action_N7sess4|128
配置N7会话规则1 
规则名称|规则参数|参数取值
---|---|---
rule_sess1|优先级|10
动作类型|rule_sess1|参数填充
日志开关|rule_sess1|关闭
条件表达式|rule_sess1|PCS=0
选中动作参数名称|rule_sess1|action_N7sess1
配置N7会话规则2 
规则名称|规则参数|参数取值
---|---|---
rule_sess2|优先级|10
动作类型|rule_sess2|参数填充
日志开关|rule_sess2|关闭
条件表达式|rule_sess2|PCS=1
选中动作参数名称|rule_sess2|action_N7sess2
配置N7会话规则3 
规则名称|规则参数|参数取值
---|---|---
rule_sess3|优先级|10
动作类型|rule_sess3|参数填充
日志开关|rule_sess3|关闭
条件表达式|rule_sess3|PCS=2
选中动作参数名称|rule_sess3|action_N7sess3
配置N7会话规则4 
规则名称|规则参数|参数取值
---|---|---
rule_sess4|优先级|10
动作类型|rule_sess4|参数填充
日志开关|rule_sess4|关闭
条件表达式|rule_sess4|PCS=3
选中动作参数名称|rule_sess4|action_N7sess4
配置场景 
场景名称|参数|取值
---|---|---
Scenario 3GPP|入口1|入口类型|用户信息类
已选入口|Scenario 3GPP|入口1|用户套餐
取值|Scenario 3GPP|入口1|1
策略类型|Scenario 3GPP|N7会话控制策略|rule_sess1
rule_sess2|策略类型|Scenario 3GPP|N7会话控制策略
rule_sess3|策略类型|Scenario 3GPP|N7会话控制策略
rule_sess4|策略类型|Scenario 3GPP|N7会话控制策略
######## 配置脚本 
//配置自定义策略变量 
[ADD DM CUSTOMVAR](../../Npcf_PolicyManagement\zh-CN\mml\1787255.html):NAME="pcid1",SVCKEY="SYS.STR_PCID_STATUS",SVCKEYATTR="PCID"-"1"&"PCIDMOD"-"SPECIFIC"&"LOGFLAG"-"OFF";
//配置条件1 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="PCS=0",SVCKEY="pcid1",OPERATOR="=",VALTYPE="VALUE",VALUE="0"
//配置条件2 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="PCS=1",SVCKEY="pcid1",OPERATOR="=",VALTYPE="VALUE",VALUE="1"
//配置条件3 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="PCS=2",SVCKEY="pcid1",OPERATOR="=",VALTYPE="VALUE",VALUE="2"
//配置条件4 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="PCS=3",SVCKEY="pcid1",OPERATOR="=",VALTYPE="VALUE",VALUE="3"
//配置动作参数1 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7sess1",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"N7sess1"&"SYS.SESS_AGG_BW_ACTION"-"VALUE"-"PROFILE_APN_BW"
//配置动作参数2 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7sess2",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"N7sess2"&"SYS.SESS_AMBR_UL"-"VALUE"-"3072"&"SYS.SESS_AMBR_DL"-"VALUE"-"3072"
//配置动作参数3 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7sess3",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"N7sess3"&"SYS.SESS_AMBR_UL"-"VALUE"-"1024"&"SYS.SESS_AMBR_DL"-"VALUE"-"1024"
//配置动作参数4 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7sess4",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"N7sess4"&"SYS.SESS_AMBR_UL"-"VALUE"-"128"&"SYS.SESS_AMBR_DL"-"VALUE"-"128"
//配置N7会话规则1 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_sess1",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=10,CONDEXP="{PCS=0}",ACTTYPE="PARAM",ACTNAME="action_N7sess1",LOGFLAG="OFF",RULENO=0
//配置N7会话规则2 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_sess2",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=10,CONDEXP="{PCS=1}",ACTTYPE="PARAM",ACTNAME="action_N7sess2",LOGFLAG="OFF",RULENO=0
//配置N7会话规则3 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_sess3",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=10,CONDEXP="{PCS=2}",ACTTYPE="PARAM",ACTNAME="action_N7sess3",LOGFLAG="OFF",RULENO=0
//配置N7会话规则4 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_sess4",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=10,CONDEXP="{PCS=3}",ACTTYPE="PARAM",ACTNAME="action_N7sess4",LOGFLAG="OFF",RULENO=0
//配置场景 
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="Scenario 3GPP",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="rule_sess1"&"rule_sess2"&"rule_sess3"&"rule_sess4",VALIDFLAG="ENABLE";

##### 配置动态发现CHF 


 

###### 配置说明 
动态发现CHF配置只呈现通过NRF发现CHF的对接配置（步骤[1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__0411e224-58c4-432b-bbe2-cf1c88689d84)-步骤[14](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__5b0bc7af-78c6-4c01-93fa-87f512b631c1)），其余基本套餐、策略计数器标识和策略配置请参考“[配置本地CHF](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z8dd34e9dec0c411d8ac964caa7d6deb7)”章节的对应部分数据。
###### 配置前提 
PCF与NRF之间的HTTP2链路配置完成。
###### 配置过程 
图3  配置流程
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B2.png)
配置过程包含如下步骤： 
 说明： 
如果已有NRF相关配置，则步骤[7](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__9301a641-9e94-47ae-a8f6-045ae18171b1)-步骤[14](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__5b0bc7af-78c6-4c01-93fa-87f512b631c1)配置可忽略。
步骤[15](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__8364b810-bb6e-4fef-9c6c-3165d51fc858)-步骤[18](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z59fcea95f7504fcc8000d53780eb6783__ebcd6455-b96b-4642-8968-da4cf35ea014)参见“[配置本地CHF](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z8dd34e9dec0c411d8ac964caa7d6deb7)”对应配置部分。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，配置HTTP客户端模板。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，配置HTTP服务端模板。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，配置关联的HTTP客户端模板。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，配置服务基础信息。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，配置NRF服务器分组。
执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，配置NRF服务器节点。
执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，配置NRF服务器策略。
执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，配置NRF服务器模板。
执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，配置NRF服务器模板选择。
执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，配置服务发现。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，配置服务发现方式。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息。
执行[ADD PCID](../../Npcf_PolicyManagement\zh-CN\mml\1787549.html)命令，配置套餐级策略计数器标识。
在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。 
###### 配置实例 
######## 场景说明 
通过NRF发现CHF的对接配置。
######## 数据规划 
假设： 
RCP网元地址：4003::19:5。 
NRF网元地址：4003::19:3和4003::19:4，互备双活模式。 说明：NRF模式默认是互备双活模式DUAL_ACTIVE，如需要配置成主备模式选择MAIN_STANDBY。 
关联的HTTP客户端模板配置：服务类型NCHF_SPENDLMTCONTROL，关联HTTP客户端IPv6模板1。 
服务基础配置：服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
类别|参数|取值
---|---|---
HTTP客户端模板配置|编号|1
IP地址|HTTP客户端模板配置|4003::19:5
起始端口|HTTP客户端模板配置|20000
终止端口|HTTP客户端模板配置|30000
HTTP服务端模板配置|编号|1
IP地址|HTTP服务端模板配置|4003::19:5
端口|HTTP服务端模板配置|8080
关联HTTP客户端模板配置|服务类型|NCHF_SPENDLMTCONTROL
HTTP IPv6模板ID|关联HTTP客户端模板配置|1
服务基础配置|服务类型|NPCF
Fqdn|服务基础配置|pcf.zte.com.cn
版本|服务基础配置|v1
优先级|服务基础配置|1
NRF服务器分组配置1|NRF服务器组编号|1
描述信息|NRF服务器分组配置1|NrfMaster
NRF服务器分组配置1|NRF服务器组编号|2
描述信息|NRF服务器分组配置1|NrfSlave
NRF服务器节点配置1|NRF服务器节点编号|1
NRF服务器IP地址|NRF服务器节点配置1|4004::19:3
NRF服务器端口|NRF服务器节点配置1|8080
NRF服务器FQDN|NRF服务器节点配置1|nrf1.hatt.zte.com.cn
URI scheme|NRF服务器节点配置1|http
HTTP客户端模板编号|NRF服务器节点配置1|1
通知时使用的HTTP服务端模板编号|NRF服务器节点配置1|1
NRF服务器节点优先级|NRF服务器节点配置1|1
归属的NRF服务器组编号|NRF服务器节点配置1|1
NRF服务器节点配置1|NRF服务器节点编号|2
NRF服务器IP地址|NRF服务器节点配置1|4004::19:4
NRF服务器端口|NRF服务器节点配置1|8080
NRF服务器FQDN|NRF服务器节点配置1|nrf2.hatt.zte.com.cn
URI scheme|NRF服务器节点配置1|http
HTTP客户端模板编号|NRF服务器节点配置1|1
通知时使用的HTTP服务端模板编号|NRF服务器节点配置1|1
NRF服务器节点优先级|NRF服务器节点配置1|2
归属的NRF服务器组编号|NRF服务器节点配置1|2
NRF服务器策略配置|NRF服务器策略编号|1
NRF模式|NRF服务器策略配置|DUAL_ACTIVE
NRF服务器模板配置|NRF服务器模板编号|1
NRF服务器策略编号|NRF服务器模板配置|1
主用NRF服务器组编号|NRF服务器模板配置|1
备用NRF服务器组编号|NRF服务器模板配置|2
NRF服务器模板选择配置|NF类型|CHF_TYPE
NRF服务器模板编号|NRF服务器模板选择配置|1
修改服务发现配置|订阅者NF类型|PCF_TYPE
订阅者FQDN|修改服务发现配置|pcf.zte.com.cn
服务发现方式配置|目的NF类型|CHF_TYPE
发现方式|服务发现方式配置|DYNAMIC_ONLY
地址选择方式|服务发现方式配置|RANDOM
http默认端口|服务发现方式配置|8080
https默认端口|服务发现方式配置|443
######## 配置步骤 
配置HTTP客户端模板 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端模板 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=2,SERVICETYPE="NCHF_SPENDLMTCONTROL",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器分组1 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=1,DESC=NrfMaster
配置NRF服务器分组2 
[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html):ID=2,DESC=NrfSlave
配置NRF服务器节点1 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=1,SERVERIPADDR="4004::19:3",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1
配置NRF服务器节点2 
[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html):ID=2,SERVERIPADDR="4004::19:4",SERVERPORT=8080,SERVERFQDN="nrf2.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=2,GROUPID=2
配置NRF服务器策略 
[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html):ID=1,NRFPATTERN="DUAL_ACTIVE"
配置NRF服务器模板 
[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html):ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2
配置NRF服务器模板选择 
[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html):NFTYPE="CHF_TYPE",NRFPROFILEID=1
配置修改服务发现，其中订阅者NF类型为必选 
[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html):SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="CHF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
##### 测试用例 
测试项目|达量限速功能验证测试
---|---
预置条件|5GC网络中各网元系统及操作维护台运行正常。用户在UDM中签约正常的AMBR，初始限速速率为DL-1000Mbps/UL-100Mbps，用户相关套餐正常。SMF/GW-C与PCF/PCRF互通正常，PCF/PCRF能够给用户下发签约的AMBR数值，能够下发达量之后新的AMBR数值。达量限速速率更新或者撤销之后，PCF/PCRF能够给SMF/GW-C下发新的限速速率信息。5G用户在5G区域及4G区域都能够正常接入。PCF和CHF协商PCID和对应的四种状态下的限速策略，例如PCID=1，四种状态对应的限速策略如下：PCS=0是不限速，PCS=1是限速3M，PCS=2是限速1M，PCS=3是限速128K
测试过程|在用户流量未达到限速触发条件之前，相当于PCS=0。终端5G基站发起附着。在网络侧查看用户附着情况，在AMF/MME、SMF/GW-C、UPF/GW-U、PCF/PCRF上查看用户限速参数。使用speedtest发起测速，记录测速结果。用户使用流量触发CHF通知PCF/PCRF或者直接在CHF上模拟消息通知PCF/PCRF，PCS状态发生改变，分别变为PCS=1、PCS=2、PCS=3。在网络侧查看用户附着情况，在MME、SGW、SMF/GW-C、UPF/GW-U上查看用户限速参数。使用speedtest发起测速，记录测速结果。终端在4G基站发起附着，重复步骤2-步骤7。
通过准则|UE能够附着成功。默认承载建立成功，并下发初始限速速率为DL-1000Mbps/UL-100Mbps，码流如下图所示。后续PCS状态发生改变。PCS=1、限速3M，码流如下图所示。PCS=2、限速1M，码流如下图所示。PCS=3、限速128K，码流如下图所示。MME、AMF/MME、SGW、SMF/GW-C、UPF/GW-U上获取到的上下行限速速率信息与UDM/HSS、PCF/PCRF上的限速信息一致，达量限速策略生效。
信令流程|
### 缩略语 
### 缩略语 
#### 5GC 
5G Core Network5G核心网
#### AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### CHF 
Charging Function计费功能
#### DL 
Down Link下行链路
#### EM 
Element Management网元管理
#### FQDN 
Fully Qualified Domain Name完全限定域名
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### GW 
GateWay网关
#### HTTP 
Hypertext Transfer Protocol超文本传输协议
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### NF 
Network Function网络功能
#### NRF 
NF Repository Function网络仓储功能
#### OCS 
Online Charging System在线计费系统
#### PCF 
Policy Control Function策略控制功能
#### PCRF 
Policy and Charging Rules Function策略和计费规则功能
#### PDU 
Protocol Data Unit协议数据单元
#### RCP 
Resource Control Platform资源控制平台
#### SLR 
Spending Limit Request消费限额请求
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### TLS 
Transport Layer Security传输层安全
#### UDM 
Unified Data Management统一数据管理
#### UL 
Uplink上行链路
#### UPF 
User Plane Function用户平面功能
#### URI 
Uniform Resource Identifier统一资源标识符
### ZUF-59-51-054 N23接口 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
NWDAF|NWDAF为PCF提供实时的小区拥塞信息，PCF根据小区拥塞信息进行QoS策略控制。
##### 描述 
####### 定义 
PCF作为Nnwdaf_AnalyticsInfo服务的使用者，通过N23接口向NWDAF查询小区拥塞的拥塞类型和拥塞级别，并根据实时的拥塞类型和拥塞级别，对用户的数据业务进行QoS策略控制。
基于N23接口的小区拥塞控制，主要包括如下内容： 
在SM策略关联建立时，PCF根据SMF携带的小区位置向NWDAF查询该小区拥塞的拥塞类型和拥塞级别。 
在SM策略关联更新时，SMF携带的小区位置发生变化，PCF使用新的小区位置向NWDAF查询该小区拥塞的拥塞类型和拥塞级别。 
PCF向NWDAF获取的小区拥塞有效期到期，PCF重新向NWDAF查询该小区拥塞的拥塞类型和拥塞级别。 
####### 背景 
5G核心网引入NWDAF网元，作为5GC中提供人工智能服务的NF，可以给其他消费者NF提供各种人工智能的分析。根据3GPP TS 23.288协议，NWDAF网元提供了多种分析类型，可分别用于不同的目的业务场景。 
VIP用户QoS提升，指对于VIP用户（如警务通用户，或重点保障用户），期望可以通过识别出当前位置当前时间无线网络的忙闲，来对用户的QoS策略进行控制。 
当无线网络忙时，临时提升VIP用户的QoS策略，从而提升VIP用户的体验。 
当无线网络不忙时，使用原有QoS策略。 
采用这种方式，运营商可以进行更灵活的策略控制。 
##### 应用场景 
针对签约VIP套餐用户，能够根据小区拥塞情况，调整QoS策略，保障VIP用户的体验。 
SMF上报用户所处小区位置，PCF向NWDAF获取小区拥塞情况，当前时间粒度的拥塞等级为高，提升该用户会话QoS保障。 
SMF上报用户所处小区位置，PCF向NWDAF获取小区拥塞情况，当前时间粒度的拥塞等级为低，恢复到用户原来的QoS保障。 
用户在一个小区长时间未移动，PCF重新向NWDAF获取小区拥塞情况，当小区拥塞情况发生变化，则调整该用户的QoS保障。 
##### 客户收益 
受益方|受益描述
---|---
运营商|PCF基于NWDAF在N23接口提供的小区拥塞信息进行QoS策略控制，使运营商能为不同等级用户提供差异化服务。
终端用户|VIP套餐用户享受高质量的QoS保障服务。

##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new1768321f660f46f3969e64a33cb65cbe__0a3bd7f2-7ebc-4816-89cf-8ee3b67aec5d)所示。RCP作为PCF，N23接口为NWDAFF和RCP之间的接口。
图1  系统架构
[]images/1.png)
###### 各网元作用 
本特性涉及的NF/网元参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new0cd9175c9e3e4a09b08fdb9e7d84a718__156c4773-2ab0-4ca0-b08d-660894af3e1f)。
名称|说明
---|---
NWDAF|NWDAF为RCP 提供实时的小区拥塞信息，包括小区拥塞类型和拥塞等级。
RCP|根据运营商的策略配置，结合NWDAF返回的小区拥塞信息进行策略决策，向SMF提供PDU会话QoS策略保障。
SMF|向RCP提供PDU会话信息，从RCP获取PDU会话策略，下发给UPF执行。
UDR/SPR|向RCP提供策略签约信息，并允许RCP将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
###### 协议栈 
NWDAF与PCF间的N23接口协议栈如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new2eff79fc53b847ce82eb57d094e47db4__c2593c30-dc23-4139-9a3b-6f662463a8f4)所示。
图2  协议栈
[]images/2.png)
###### 本网元实现 
######## 小区拥塞信息存储 
为了使QoS得到保障，即便限定用户签约特定套餐，拥塞小区个数也会达数十万个，因此拥塞小区多采用Data统一节点管理，在每个SC采用系统级节点方式存储。 
为了减少存储量，NWDAF返回的startTime和stopTime经过运算，存储相对2000年的一个时间值。 
RCP向NWDAF获取小区拥塞信息有三个状态：0-尚未获取、1-获取中、2-获取完成。 
获取小区拥塞信息状态为尚未获取时，说明该小区拥塞信息尚未获取，RCP向NWDAF获取小区拥塞信息，并将获取小区拥塞信息状态设置为获取中。待NWDAF返回小区拥塞信息后，更新小区拥塞信息，将获取小区拥塞信息状态为获取完成，RCP可据此决策。 
获取小区拥塞信息状态为获取完成时，且stopTime尚在有效期范围内，说明该小区拥塞信息为有效，RCP可据此决策。 
获取小区拥塞信息状态为获取中时，后续会话设置定时器等待处理（如1秒延迟定时器），待定时器到后，再次获取小区拥塞信息时，不管获取小区拥塞信息状态是否完成，业务流程将不再等待。 
######## 小区拥塞信息获取及老化 
每个SC向NWDAF获取小区拥塞信息，同一个小区以ecgi、ncgi为关键字索引存储在系统级小区拥塞缓存中。会话中包含的小区信息相同时，每个SC只向NWDAF获取一次拥塞信息。 
后续会话查询本地小区拥塞缓存中已有信息，且在有效期范围内，则直接根据小区拥塞信息决策。本地小区拥塞缓存中已有信息，但不在有效期范围内，RCP向NWDAF获取小区拥塞信息，并将获取小区拥塞信息状态为获取中。待NWDAF返回小区拥塞信息后，更新小区拥塞信息，将isQueryNwdaf取值设置为获取完成，RCP可据此决策。 
小区拥塞信息的老化处理较为简单，由于每个SC都存储了小区拥塞信息，可以每SC全局扫描。老化时间为stopTimes+25小时，扫描时与当前时间比较，若当前时间大于老化时间，对该小区拥塞信息老化处理。 
######## 会话感知小区拥塞有效期 
在小区拥塞信息获取后，根据stopTime+随机值（在2分钟内随机秒数，可简单使用用户号码对60取模获得一个随机值），设置在会话内按绝对时间向ATM注册定时通知。 
ATM通知时间到，RCP优先从本地小区拥塞信息读取，处理步骤参考“小区拥塞信息存储”。 
同时，根据最新的stopTime（根据存储的）+随机值（在2分钟内随机秒数，可简单使用用户号码对60取模获得一个随机值），重新设置在会话内按绝对时间向ATM注册定时通知。 
######## 未获取到NWDAF小区拥塞信息的处理 
未获取到小区拥塞信息的情况有如下三种： 
NWDAF对某小区返回204，即无内容。 
查询某小区超时无应答（不管NWDAF无应答还是内部失败）。 
获取小区拥塞信息状态为获取中时，后续会话设置定时器（如1秒延迟定时器）也超时未获取到相应信息。 
上述三种情况都做相同逻辑处理： 
将该小区拥塞状态设置为0，获取状态为获取完成。存储时，startTime为当前时间，stopTime为当前时间+拥塞小区有效期最小粒度（目前与NWDAF约定为15分钟）。 
设置重决策定时器仍为stopTime（存储的）+随机值（在2分钟内随机秒数，可简单使用用户号码对60取模获得一个随机值）。 
设置在会话内按绝对时间向ATM注册定时通知。 
######## 决策拥塞等级约定 
拥塞等级可设置为条件业务键，作为RCP策略决策参数。按拥塞程度从高到低，暂定1、2、3、4、5 五个等级。 
每个拥塞等级对应的负荷区间在NWDAF配置。暂定： 
等级1：[100-90] 
等级2：(90-80] 
等级3：(80-70] 
等级4：(70-60] 
等级5：(60-0] 
由于该条件业务键类型为整型，若RCP向NWDAF未获取到拥塞等级，条件业务键取值返回为0。 
###### 业务流程 
######## 位置区域的小区拥塞信息获取与决策 
位置区域级小区拥塞信息获取与决策的流程如[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new9f235aecbed8447b9098fd49675ed780__b0abfb59-dc64-425b-9b7f-f7c5e8d8d1ec)所示。
图3  位置区域级小区拥塞获取与决策流程
[]images/nwdaf%EF%BC%88%E5%8C%BA%E5%9F%9F%E7%BA%A7%EF%BC%89%E6%B5%81%E7%A8%8B%E5%9B%BEeddx.png)
步骤如下： 
SMF发起PDU会话关联建立请求消息（Npcf_SMPolicyControl_Create），或位置更新请求消息（Npcf_SMPolicyControl_Update），携带supi、s-nassai、UserLocation等信息给RCP。 
RCP获取签约套餐，查看套餐支持获取小区拥塞的情况。若为按位置区域获取，则先查询本地是否有该小区的拥塞信息，若本地没有，再向NRF查询NWDAF的信息（也可通过本地NRF获取）。 
若为不需要获取小区拥塞情况，跳过步骤3~7，继续后续业务流程。 
RCP向NRF发送Nnrf_NFDiscovery请求消息，携带S-NSSAI、Analytics ID、TAI等参数发现NWDAF实例。 
NRF通过Nnrf_NFDiscovery响应消息，返回NWDAF实例信息。 
注：若为本地NRF，第3~4步，RCP不发送Nnrf_NFDiscovery消息，直接在本地查询配置的NWDAF实例信息。 
RCP根据NRF返回的NWDAF实例信息，决定需要向NWDAF获取该位置区域的拥塞情况。 
RCP向NWDAF发送Nnwdaf_AnalyticsInfo请求消息，携带Analytics ID取值为User Data Congestion、EventId取值为USER_DATA_CONGESTION，event-filter中的networkArea取值为UserLocation的ncgi或ecgi信息。
RCP收到Nnwdaf_AnalyticsInfo的响应消息，存储小区拥塞的相关信息，包括拥塞级别、拥塞类型、一个粒度的有效期等参数。 
RCP根据NWDAF返回的拥塞信息（优先使用预测时间的小区拥塞信息来决策）如拥塞级别、拥塞类型等，决策该位置区域的用户会话规则（含业务规则）或会话拒绝。 
RCP向SMF回复Npcf_SMPolicyControl_Create或者Npcf_SMPolicyControl_Update响应消息，携带根据小区拥塞决策的会话规则和业务规则。 
######## 当前时段到期后重新获取拥塞信息及决策 
当前粒度到期后，重新获取拥塞信息及决策的流程如[图4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new9f235aecbed8447b9098fd49675ed780__ea817d1f-1a3a-4565-838c-92ad1defc1cd)所示。
图4  当前时段到期后重新获取拥塞信息及决策
[]images/%E5%BD%93%E5%89%8D%E6%97%B6%E6%AE%B5%E5%88%B0%E6%9C%9F%E5%90%8E%E9%87%8D%E6%96%B0%E8%8E%B7%E5%8F%96%E6%8B%A5%E5%A1%9E%E4%BF%A1%E6%81%AF.png)
步骤如下： 
N7会话设置的拥塞小区当前粒度到期后，RCP会主动查看本地小区拥塞信息是否更新。如果没有更新，执行2-3步骤；若果已更新，执行步骤4。 
RCP向NWDAF发送Nnwdaf_AnalyticsInfo请求消息，携带Analytics ID取值为User Data Congestion、EventId取值为USER_DATA_CONGESTION、event-filter中的networkArea取值为UserLocation的ncgi或ecgi信息。
RCP收到Nnwdaf_AnalyticsInfo的响应消息，存储小区拥塞的相关信息，主要包括拥塞级别、拥塞类型、一个粒度的有效期等参数。 
RCP根据NWDAF返回的拥塞信息（如拥塞级别、拥塞类型等），决策该位置区域的用户会话规则（含业务规则）。 
RCP向SMF发送Npcf_SMPolicyControl_UpdateNotify请求消息，携带根据小区拥塞决策的会话规则和业务规则。 
SMF回复Npcf_SMPolicyControl_UpdateNotify响应消息。 
##### 系统影响 
目前规划的小区数量最大为1000000个，每个小区拥塞信息为30个字节。开启本功能时，本地缓存增加30000000字节，由于采用动态内存分配，每SC最多增加内存消耗为30M。 
##### 应用限制 
目前测试场景，由于用户数少，小区订阅上报量也有限，暂按照本地套餐方式，即对所有用户生效。 
后续商用场景，需要在SPR能对特定用户签约特定套餐，限制用户量订阅小区。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 23.288|Architecture enhancements for 5G System (5GS) to support network data analytics services
##### 特性能力 
该特性不涉及规格指标。 

##### 可获得性 

###### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.22.21|首次发布。
###### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
###### 对其他网元的要求 
网元|要求
---|---
NWDAF|需要按协议提供小区拥塞查询能力。

##### O&M相关 

###### 命令 
命令项|命令|描述
---|---|---
套餐基本配置|ADD PKGINFO|增加套餐基本配置。新增网络拥塞控制粒度参数，用于判断是否需要获取小区拥塞情况。不控制：不需要获取小区拥塞情况。小区：需要按小区粒度获取拥塞情况。
SET PKGINFO|套餐基本配置|设置套餐基本配置。新增网络拥塞控制粒度参数，用于判断是否需要获取小区拥塞情况。不控制：不需要获取小区拥塞情况。小区：需要按小区粒度获取拥塞情况。
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
该特性不涉及告警/通知消息的变化。 
###### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置N23接口特性 
###### 配置说明 
本地配置NWDAF，PCF通过N23接口向NWDAF查询用户拥塞信息，并根据实时的用户拥塞状态，进行用户的会话及业务控制，例如N7会话AMBR控制。 
###### 配置前提 
PCF与本地配置NWDAF之间的HTTP2链路配置完成。 
###### 配置过程 
配置流程如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424918__2d881196-348f-473e-a2b2-7fd6fb963ea3)所示。
图1  配置流程图
[]images/n23%E6%8E%A5%E5%8F%A3%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE%E5%9B%BE%E7%A4%BA.png)
配置过程包含如下步骤： 
登录EM客户端，打开配置→命令处理
页面，选择CommonS_HTTP_LB_0节点。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，配置HTTP客户端模板。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，配置HTTP服务端模板。
选择Npcf_PolicyManagement_0节点。 
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，配置关联的HTTP客户端模板。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，配置服务基础信息。
选择CommonS_HTTP_LB_0节点。 
执行[ADD SBINWDAFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220981.html)命令，配置NWDAF信息。
NF相关配置。 
执行[ADD SBIIPV4ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220633.html)命令，配置IPv4地址。
执行[ADD SBIIPV4ADDRARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220637.html)命令，配置IPv4地址组编号。
执行[ADD SBIIPV4ADDRARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220641.html)命令，配置IPv4地址组参数。
执行[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html)命令，配置IP端点。
执行[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html)命令，配置IP端点组编号。
执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，配置IP端点组参数。
执行[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html)命令，配置NF服务版本组编号。
执行[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html)命令，配置NF服务版本组参数。
执行[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html)命令，配置对端NF基本信息。
执行[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html)命令，配置对端NF扩展信息。
执行[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html)命令，配置对端NF实例。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，配置服务发现。
选择Npcf_PolicyManagement_0节点。 
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息。
打开配置→RCP策略管理
页面，在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。
###### 配置实例 
######## 配置场景 
RCP携带位置信息（NCGI或ECGI）向本地NWDAF获取用户拥塞信息，NWDAF根据位置信息匹配对应的拥塞信息，并返回给RCP，RCP根据拥塞信息实行N7会话AMBR控制。
假设拥塞信息包含以下四个状态，对应不同的N7会话AMBR控制策略，参见[表1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__4ad2a391-e83b-4c42-a7ee-8f1b86c93626)。
拥塞类型|拥塞级别|AMBR控制策略
---|---|---
用户面|0|AMBR上行速率/下行速率 = 500/500
用户面|1|AMBR上行速率/下行速率 = 1000/1000
用户面|2|AMBR上行速率/下行速率 = 2000/2000
业务面|3|AMBR上行速率/下行速率 = 3000/3000
注：如NWDAF和RCP不在同一平面，需增加通知URI服务端模板配置。 
######## 数据规划 
基本数据规划参见[表2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__4750df59-602e-4e07-b7fd-f383ea7c15d5)。
配置项|参数|规划值
---|---|---
RCP网元地址|IP地址|192.165.25.99
NWDAF网元地址|NWDAF网元地址|192.165.25.88
关联的HTTP客户端模板配置|HTTP客户端模板ID|1
服务类型|关联的HTTP客户端模板配置|Npcf_SMPolicyControl
服务基础配置|版本|v1
FQDN|服务基础配置|pcf
优先级|服务基础配置|1
######## 配置步骤 
基本数据配置
配置HTTP客户端模板。 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR="192.162.25.99",STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,RESPBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",HTTP2_DSCP=0,ISSHORT="OPTION_NO",LINKAGINGTIME=0,LINKSHRINKTIME=60,SHRINKTRANS=30,SHRINKSTREAM=40,CIPERCUITESNAME="default";
配置HTTP服务端模板。 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR="192.162.25.99",PORT=8080,VPNID=0,REQBODYMAXLENGTH=10240,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF",HTTP2_DSCP=0,ISSHORT="OPTION_NO",LINKAGINGTIME=0;
关联的HTTP客户端模板。 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=1,SERVICETYPE="NPCF_SMPOLICYCONTROL",HTTP4CLTID=1,HTTP6CLTID=0,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP";
配置服务基础信息。 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE",SCHEMA="HTTP";
配置NWDAF信息。 
[ADD SBINWDAFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220981.html):ID=2,EVENTIDS="USER_DATA_CONGESTION",NWDAFEVENTS="USER_DATA_CONGESTION";
NF相关配置。 
配置IPv4地址。 
[ADD SBIIPV4ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220633.html):ID=1,IP="192.162.25.88";
配置IPv4地址组编号。 
[ADD SBIIPV4ADDRARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220637.html):ARRAYID=1;
配置IPv4地址组参数。 
[ADD SBIIPV4ADDRARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220641.html):INDEX=1,ARRAYID=1,IPV4=1;
配置IP端点。 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=1,PORT=8080,IPV4=1;
配置IP端点组编号。 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=1;
配置IP端点组参数。 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=1,ARRAYID=1,IPENDPOINT=1;
配置NF服务版本组编号。 
[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html):ARRAYID=1;
配置NF服务版本组参数。 
[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html):INDEX=1,ARRAYID=1,APIVERSIONINURI="v1",APIFULLVERSION="v1";
配置对端NF基本信息。 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=2,NFINSTANCEID="12345-6789-123-5",NFTYPE="NWDAF_TYPE",NFSTATUS="REGISTERED",FQDN="pcf",IPV4ARRAY=1,CAPACITY=65535,PRIORITY=0;
配置对端NF扩展信息。 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=2,NWDAFINFO=2;
配置对端NF实例。 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=2,NFINDEX=2,SRVINSTANCEID="nwdaf1",SERVICENAME="NNWDAF_ANALYTICSINFO",SERVICEVERSIONARRAY=1,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="pcf",IPENDPOINTARRAY=1,CAPACITY=65535,PRIORITY=0;
配置服务发现。 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="NWDAF_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="IPV4_FIRST",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443;
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1,NWCONGCTL="CELL";
策略配置
配置条件。 
条件1： 
条件名称|参数|取值
---|---|---
usertype=user|选择策略变量|其他
策略变量类别|usertype=user|接入信息类
策略变量|usertype=user|拥塞类型
操作符|usertype=user|=
值类型|usertype=user|值
值|usertype=user|用户面
条件2： 
条件名称|参数|取值
---|---|---
usertype=control|选择策略变量|其他
策略变量类别|usertype=control|接入信息类
策略变量|usertype=control|拥塞类型
操作符|usertype=control|=
值类型|usertype=control|值
值|usertype=control|控制面
条件3： 
条件名称|参数|取值
---|---|---
congLevel=0|选择策略变量|其他
策略变量类别|congLevel=0|接入信息类
策略变量|congLevel=0|拥塞级别
操作符|congLevel=0|=
值类型|congLevel=0|值
值|congLevel=0|0
条件4： 
条件名称|参数|取值
---|---|---
congLevel=1|选择策略变量|其他
策略变量类别|congLevel=1|接入信息类
策略变量|congLevel=1|拥塞级别
操作符|congLevel=1|=
值类型|congLevel=1|值
值|congLevel=1|1
条件5： 
条件名称|参数|取值
---|---|---
congLevel=2|选择策略变量|其他
策略变量类别|congLevel=2|接入信息类
策略变量|congLevel=2|拥塞级别
操作符|congLevel=2|=
值类型|congLevel=2|值
值|congLevel=2|2
条件6： 
条件名称|参数|取值
---|---|---
congLevel=3|选择策略变量|其他
策略变量类别|congLevel=3|接入信息类
策略变量|congLevel=3|拥塞级别
操作符|congLevel=3|=
值类型|congLevel=3|值
值|congLevel=3|3
配置动作。 
动作1： 
动作参数名称|参数|取值
---|---|---
N7_sess_Congestion_def|动作参数类型|N7会话参数集
会话规则名称|N7_sess_Congestion_def|Congestion_def
会话AMBR上行速率(kbps)|N7_sess_Congestion_def|500
会话AMBR下行速率(kbps)|N7_sess_Congestion_def|500
动作2： 
动作参数名称|参数|取值
---|---|---
N7_sess_Congestion_1|动作参数类型|N7会话参数集
会话规则名称|N7_sess_Congestion_1|Congestion_1
会话AMBR上行速率(kbps)|N7_sess_Congestion_1|1000
会话AMBR下行速率(kbps)|N7_sess_Congestion_1|1000
动作3： 
动作参数名称|参数|取值
---|---|---
N7_sess_Congestion_2|动作参数类型|N7会话参数集
会话规则名称|N7_sess_Congestion_2|Congestion_2
会话AMBR上行速率(kbps)|N7_sess_Congestion_2|2000
会话AMBR下行速率(kbps)|N7_sess_Congestion_2|2000
动作4： 
动作参数名称|参数|取值
---|---|---
N7_sess_Congestion_3|动作参数类型|N7会话参数集
会话规则名称|N7_sess_Congestion_3|Congestion_3
会话AMBR上行速率(kbps)|N7_sess_Congestion_3|3000
会话AMBR下行速率(kbps)|N7_sess_Congestion_3|3000
配置规则。 
N7会话规则1： 
规则名称|参数|取值
---|---|---
Congestion_def_rule|优先级|300
动作类型|Congestion_def_rule|参数填充
日志开关|Congestion_def_rule|关闭
条件表达式|Congestion_def_rule|{congType=user}&{congLevel=0}
选中动作参数名称|Congestion_def_rule|N7_sess_Congestion_def
N7会话规则2： 
规则名称|参数|取值
---|---|---
Congestion_rule1|优先级|300
动作类型|Congestion_rule1|参数填充
日志开关|Congestion_rule1|关闭
条件表达式|Congestion_rule1|{congType=user}&{congLevel=1}
选中动作参数名称|Congestion_rule1|N7_sess_Congestion_1
N7会话规则3： 
规则名称|参数|取值
---|---|---
Congestion_rule2|优先级|300
动作类型|Congestion_rule2|参数填充
日志开关|Congestion_rule2|关闭
条件表达式|Congestion_rule2|{congType=user}&{congLevel=2}
选中动作参数名称|Congestion_rule2|N7_sess_Congestion_2
N7会话规则4： 
规则名称|参数|取值
---|---|---
Congestion_rule3|优先级|300
动作类型|Congestion_rule3|参数填充
日志开关|Congestion_rule3|关闭
条件表达式|Congestion_rule3|{congType=control}&{congLevel=3}
选中动作参数名称|Congestion_rule3|N7_sess_Congestion_3
配置场景。 
场景名称|参数|取值
---|---|---
Congestion_role|入口|无|入口
策略类型|Congestion_role|N7会话控制策略|Congestion_def_rule
Congestion_rule1|策略类型|Congestion_role|N7会话控制策略
Congestion_rule2|策略类型|Congestion_role|N7会话控制策略
Congestion_rule3|策略类型|Congestion_role|N7会话控制策略
##### 测试用例 
测试条目|5G用户5G基站（小区1）初始上线
---|---
预置条件|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。
测试步骤|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据拥塞级别下发相应的规则。
通过准则|PCF根据拥塞级别下发相应的规则正常。|PCF根据拥塞级别下发相应的规则正常。|PCF根据拥塞级别下发相应的规则正常。|PCF根据拥塞级别下发相应的规则正常。
测试条目|5G用户触发小区变更（小区1移动到小区2）首次上线
---|---
预置条件|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。
测试步骤|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据小区1拥塞级别下发相应的规则。5G用户移动，触发Xn切换到小区2，SMF触发update消息给PCF。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区2的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区2的位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区2的拥塞级别。PCF根据小区2拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据小区1拥塞级别下发相应的规则。5G用户移动，触发Xn切换到小区2，SMF触发update消息给PCF。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区2的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区2的位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区2的拥塞级别。PCF根据小区2拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据小区1拥塞级别下发相应的规则。5G用户移动，触发Xn切换到小区2，SMF触发update消息给PCF。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区2的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区2的位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区2的拥塞级别。PCF根据小区2拥塞级别下发相应的规则。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的拥塞级别。PCF根据小区1拥塞级别下发相应的规则。5G用户移动，触发Xn切换到小区2，SMF触发update消息给PCF。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区2的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区2的位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区2的拥塞级别。PCF根据小区2拥塞级别下发相应的规则。
通过准则|PCF根据拥塞级别下发相应的规则正常。PCF在SMF上报用户位置更新后，重新向NWDAF去获取拥塞信息。|PCF根据拥塞级别下发相应的规则正常。PCF在SMF上报用户位置更新后，重新向NWDAF去获取拥塞信息。|PCF根据拥塞级别下发相应的规则正常。PCF在SMF上报用户位置更新后，重新向NWDAF去获取拥塞信息。|PCF根据拥塞级别下发相应的规则正常。PCF在SMF上报用户位置更新后，重新向NWDAF去获取拥塞信息。
测试条目|5G用户上线（小区1），随后该用户的会话2在不同的时间粒度上线
---|---
预置条件|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。
测试步骤|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。此时，5G用户的新建会话2在不同粒度上线。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。此时，5G用户的新建会话2在不同粒度上线。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。此时，5G用户的新建会话2在不同粒度上线。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。此时，5G用户的新建会话2在不同粒度上线。
通过准则|PCF根据拥塞级别下发相应的规则正常。PCF主动触发下一个粒度的小区拥塞信息，向NWDAF发送Nnwdaf_AnalysisInfo_Req消息。|PCF根据拥塞级别下发相应的规则正常。PCF主动触发下一个粒度的小区拥塞信息，向NWDAF发送Nnwdaf_AnalysisInfo_Req消息。|PCF根据拥塞级别下发相应的规则正常。PCF主动触发下一个粒度的小区拥塞信息，向NWDAF发送Nnwdaf_AnalysisInfo_Req消息。|PCF根据拥塞级别下发相应的规则正常。PCF主动触发下一个粒度的小区拥塞信息，向NWDAF发送Nnwdaf_AnalysisInfo_Req消息。
测试条目|5G用户上线（小区1），用户一直在线
---|---
预置条件|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。|5GC系统中各NF状态正常。NWDAF能正常查询小区列表对应的拥塞级别。PCF针对CELL和用户的套餐，不同的拥塞级别配置不同的规则。
测试步骤|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在该小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。该小区的不同粒度拥塞存在变化，PCF主动触发策略变更消息给SMF。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在该小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。该小区的不同粒度拥塞存在变化，PCF主动触发策略变更消息给SMF。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在该小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。该小区的不同粒度拥塞存在变化，PCF主动触发策略变更消息给SMF。|5G用户在小区1上线。SMF触发N7口消息给PCF，携带ULI信息。PCF根据套餐配置，确定该用户上线后需要获取拥塞信息。PCF查询本地不存在该小区1的拥塞缓存信息，触发向NWDAF的Nnwdaf_AnalysisInfo_Req消息。NWDAF根据小区1位置信息，回Nnwdaf_AnalysisInfo_Rsp消息，携带小区1的当前粒度和下一个粒度拥塞级别。PCF根据当前小区1的当前粒度的拥塞级别，下发相应的规则。PCF下一个粒度时期内，随机一个时间触发下一个粒度该小区的拥塞查询。该小区的不同粒度拥塞存在变化，PCF主动触发策略变更消息给SMF。
通过准则|PCF根据拥塞级别下发相应的规则正常。拥塞信息变化导致规则变化，PCF主动触发策略变更消息给SMF。|PCF根据拥塞级别下发相应的规则正常。拥塞信息变化导致规则变化，PCF主动触发策略变更消息给SMF。|PCF根据拥塞级别下发相应的规则正常。拥塞信息变化导致规则变化，PCF主动触发策略变更消息给SMF。|PCF根据拥塞级别下发相应的规则正常。拥塞信息变化导致规则变化，PCF主动触发策略变更消息给SMF。
### 缩略语 
### 缩略语 
#### ECGI 
E-UTRAN Cell Global IdentifierE-UTRAN小区全球标识
#### NWDAF 
Network Data Analytics Function网络数据分析功能
#### PCF 
Policy Control Function策略控制功能
#### QoS 
Quality of Service服务质量
#### RCP 
Resource Control Platform资源控制平台
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### UDR 
Unified Data Repository统一数据存储
### ZUF-59-51-056 Nbsf接口 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|含义
---|---
BSF|绑定支持功能，用于绑定相同UE的PDU会话和AF/NEF会话到相同PCF处理。
绑定信息|用于AF/NEF判断一个PDU会话选择了哪个PCF的信息。
##### 描述 
####### 特性定义 
Nbsf接口是BSF提供的服务化接口。PCF可以通过Nbsf接口调用Nbsf_Management服务的注册、更新注册或注销PCF绑定信息。PCF绑定信息包含PDU会话的S-NSSAI、DNN、UE IP地址、用户标识等信息，以及PDU会话所选PCF信息。当该PDU会话上的AF/NEF需要通过Rx/N5接口访问PCF时，如果网络中部署有多个PCF，AF/NEF可以查询BSF，确定访问哪个PCF。
####### 背景知识 
5GC中的BSF和EPC中的DRA功能类似，BSF用于寻址PCF，DRA用于寻址PCRF。
5GC网络中，存在SMF内置BSF（即BSF和SMF融合）情况，SMF与PCF交互时在BSF内置功能存储PCF绑定信息，不需要PCF显式向BSF写入绑定信息。现网DRA要改造支持Nbsf接口，以便VoNR流程Rx接口消息正确寻址到PCF。内置BSF向NRF注册BSF服务，供后续DRA、AF/NEF发现BSF，获取PDU会话绑定信息以及PCF地址查询。SMF内置BSF与5GC NF的连接示意图如图1所示。图1  SMF内置BSF与5GC NF的连接示意图 
5GC网络中，存在BSF独立部署情况，一般还集成DRA功能，现网DRA不用改造，可以将Rx请求通过Proxy或Redirect模式转给新建BSF寻址PCF。外置BSF与5GC NF的连接示意图如图2所示。图2  外置BSF与5GC NF的连接示意图 
##### 应用场景 
SMF内置BSF的场景，PCF与BSF无直接交互，本特性的应用场景主要适用于BSF独立部署的情况（参见[图2](1627268759233.html#z2f23045145a046818e411216227d301c__23323841-61ba-40cb-840b-a0048977bd2d)）。
当运营商部署多个RCP作为PCF时，如果有AF/NEF需要PCF进行策略授权的应用场景（例如VoNR、AF影响业务路由），则需要部署BSF，PCF向BSF注册绑定信息，AF/NEF通过BSF寻址PCF。
场景|场景描述
---|---
VoNR|PCF作为服务使用者向BSF注册PDU会话绑定信息，供后续AF通过Diameter Rx至BSF时查询绑定信息后，将Rx接口消息转发到相应的PCF。通过绑定信息寻址到相应PCF，处理存量Diameter Rx接口消息的VoNR是5G典型应用场景：为VoNR呼叫提供QoS保障。为VoNR紧急呼叫提供优先接入。支持P-CSCF查询用户位置和订阅承载事件通知。支持计费关联。P-CSCF容灾增强相关流程。支持EPS Fallback流程。
AF影响业务路由|PCF作为服务使用者向BSF注册PDU会话绑定信息，供后续AF/NEF通过查询BSF的绑定信息后，将N5接口消息转发到相应的PCF。通过绑定信息寻址到相应PCF，处理服务化N5接口消息的AF影响业务路由功能为5G典型应用场景：5G网络数据流量密度和用户体验速率的急剧增长，核心网经受着更大数据流量的冲击，因此需要启用AF业务本地分流，减轻核心网流量传输压力。5G提出的高可靠低时延应用场景（如车联网、工业控制）也需要启用AF业务本地分流，从而降低业务时延。AF种类和数量繁多，不同的AF业务有不同的本地分流要求，很难在5GC中预配置，因此需要向AF开放业务路由选择功能。
##### 客户收益 
受益方|受益描述
---|---
运营商|VoNR、AF影响业务等应用场景，AF/NEF通过BSF准确寻址PCF。

##### 实现原理 


 

###### 系统架构 
ZXUN RCP可以通过Nbsf接口调用Nbsf_Management服务的注册、更新注册或去注册RCP绑定信息。如果网络中部署有多个RCP，AF/NEF可以查询BSF，确定访问哪个RCP。
ZXUN RCP系统架构如[图3](1627268759233.html#z1619aa64e33c4db4b6a4023371d73ebc__4321069f-ee77-41f2-bb1e-1f6219a237dc)所示。
图3  ZXUN RCP系统架构
[]images/rcp%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|描述
---|---
RCP|向BSF注册、更新、去注册RCP绑定信息。
BSF|维护RCP绑定信息，提供RCP绑定信息的注册、更新、去注册、查询接口。
AF/NEF|向BSF查询RCP绑定信息。
###### 协议栈 
RCP与BSF间的Nbsf接口协议栈如[图4](1627268759233.html#zdadf8e0f62cb43d493ce6fe2446a4f87__0dc21ed9-1b0b-44b2-a6b8-eec8facefe59)所示。
图4  RCP与BSF间的Nbsf接口协议栈
[]images/%E5%8D%8F%E8%AE%AE%E6%A0%88.jpg)
协议栈中的TLS为可选协议，当需要考虑传输层数据安全保护时，可以使用该协议。
Nbsf接口支持的消息参见下表。 
NF|服务|操作|操作语义|说明
---|---|---|---|---
BSF|Nbsf_management|Register|Request/Response|RCP向BSF注册本网元RCP绑定信息。
Update|BSF|Nbsf_management|Request/Response|RCP向BSF更新本网元RCP绑定信息。
Deregister|BSF|Nbsf_management|Request/Response|RCP向BSF去注册本网元RCP绑定信息。
Discovery|BSF|Nbsf_management|Request/Response|AF/NEF向BSF发现RCP。
###### 业务流程 
######## RCP向BSF注册、更新、注销过程 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B1.png)流程说明如下： 
[]images/%E7%A9%BA%E6%A0%BC.PNG)0. []images/1627283734321.PNG)预置注册信息，包括RCP、BSF分别向NRF注册网元及支持服务信息。
UE和SMF建立PDU会话，SMF为PDU会话向RCP请求SM策略控制，为此SMF向RCP发送Npcf_SMPolicyControl_Create请求消息，请求RCP建立SM策略关联，请求消息主要包含： 
SUPI（Subscriber Permanent Identifier，签约永久标识），例如IMSI。 
GPSI（Generic Public Subscription Identifier，通用公共签约标识），例如MSISDN。 
PEI（Permanent Equipment Identifier，永久设备标识），例如IMEISV。 
PDU会话标识：SUPI+PDU会话标识唯一定位一个PDU会话。 
DNN（Data Network Name，数据网名称），等同于EPC中的APN。 
S-NSSAI（Single Network Slice Selection Assistance Information，单个网络切片选择辅助信息）。 
通知URI：SMF后续接收RCP为该SM策略关联下发的策略更新通知的URI地址。 
签约的会话聚合带宽（Subscribed Session AMBR）。 
签约的缺省QoS（Subscribed Default QoS）。 
相对于EPC网络在创建会话时可携带UE IP地址，5G组网时SMF在创建请求中一般不携带UE IP地址信息，UE IP在后续更新请求中携带。 
RCP进行策略决策，向SMF发送Npcf_SMPolicyControl_Create响应，响应消息主要包含： 
SM策略关联ID：由RCP生成，唯一定位SMF和RCP间的一个SM策略关联（即一个N7会话）。 
会话规则：RCP对PDU会话决策默认承载QoS、用量等信息。 
PCC规则：RCP对业务决策QoS、计费、用量等信息。 
SMF收到Create响应后，为UE分配IP地址，再通过Npcf_SMPolicyControl_Update请求向RCP上报UE IP地址，更新请求中主要包含： 
用户IPv4地址或 IPv6地址前缀。 
IP地址域（可选）。 
IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP记录下UE IP地址信息，根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。 
如果需要注册，执行后续步骤5~8和步骤11~12，否则直接跳过这些步骤。 
RCP根据UE IP地址等信息，通过Nnrf_NFDiscovery Request向NRF查询支持处理的BSF，查询条件参见[表1](1627268759233.html#za63c895c4ce84fcf8d74629de9ad8f36__a7f4e91d-8d70-4e99-8bde-c889a87d8fd9)。
参数|说明
---|---
HTTP Header关键参数|:method: GET:scheme: http 或https:path: /nnrf-disc/v1/nf-instances?dnn=ims&requester-nf-instance-fqdn=RCP&preferred-locality={Loc}&requester-nf-instance-id={NFInstanceID}&requester-nf-type=PCF&service-names=nbsf-management&target-nf-type=BSF&ue-ipv4-address=192.168.0.1发现BSF携带的参数有：用户IPv4地址和/或IPv6地址前缀，例如：ue-ipv4-address=192.168.0.1位置优选参数（可选），例如：preferred-locality={Loc}请求查询的NF的FQDN，即RCP的FQDN，例如：requester-nf-instance-fqdn=pcf.zte.com.cn请求查询的NF实例号，即RCP的nfInstanceId，例如：requester-nf-instance-id={NFInstanceID}请求查询的NF类型，即RCP的NFType，例如：requester-nf-type=PCF查询目标NF的服务名，例如：service-names=nbsf-management查询目标NF的类型，例如：target-nf-type=BSFDNN:authority: NRF主机:端口，端口可选，默认80；主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80。
 说明： 
发现请求不携带Body信息。 
NRF返回符合条件的BSF实例信息及服务信息。 
RCP向BSF发送Nbsf_Management_Register请求，请求中可包含： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /nbsf-management/v1/RCPBindings:authority: BSF主机:端口，端口可选，默认80，主机可以是IPv4、IPv6或FQDN，例如[3408::1114]:8080
supi|签约用户永久标识，如"imsi-123456789012345"。
gpsi|通用公共签约标识，如"msisdn-923456789012345"。
ipv4Addr|UE的IPv4地址。
addIpv6Prefixes|UE的IPv6前缀地址。
ipDomain|IP地址域标识。
dnn|数据网名称。
RCPFqdn|RCP实例下Npcf_PolicyAuthorization服务的FQDN。
RCPIpEndPoints|RCP实例下Npcf_PolicyAuthorization服务的IP地址，含端口等，如{"ipv4Address":"192.162.120.1","transport":"TCP","port":8080}。
RCPDiamHost|RCP实例的Diameter主机名，如"rcp.hatt.zte.com.cn"。
RCPDiamRealm|RCP实例的Diameter域名，如"hatt.zte.com.cn"。
snssai|切片标识，如{"sst":1,"sd":"310000"}。
RCPId|RCP实例编号。
recoveryTime|RCP启动或重启时间戳。
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP向SMF回复NPCF_SMPolicyControl_Update响应。 
如果UE IP地址（一般是 IPv6地址前缀）发生变化，SMF再通过Npcf_SMPolicyControl_Update请求向RCP上报新的UE IP地址。 
RCP记录下UE IP地址信息，向BSF更新绑定信息，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP向SMF回复NPCF_SMPolicyControl_Update响应。 
用户下线，SMF向RCP发送Npcf_SMPolicyControl_Delete请求。 
RCP向BSF发送Nbsf_Management_Deregister请求。 
BSF回复Nbsf_Management_Deregister响应。 
RCP向SMF回复Npcf_SMPolicyControl_Delete响应。 
######## AF通过SMF内置BSF寻址RCP过程 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B2.png)以VoNR流程中AF（P-CSCF）寻址RCP的流程为例（需要改造DRA，支持Nbsf服务化接口发现绑定的RCP），具体描述如下： 
AF收到IMS用户注册请求或新的呼叫请求，构造Rx接口的AAR消息发送给DRA，AAR消息中的如下信息可用以DRA寻址RCP： 
目标域名（Destination-Realm） 
用户IPv4地址（Framed-IPv4-Address）或IPv6地址前缀（Framed-IPv6-Prefix) 
DRA（需改造升级BSF接口）收到AAR消息，如果在本地找不到对应的Gx会话绑定信息，则向BSF查询N7会话绑定信息（如果DRA本地未配置BSF地址，则在向BSF发起查询前，先要通过NRF发现BSF，这里不再详述），DRA向BSF发送Nbsf_Management_Discovery请求。请求中必须包含用户 IP地址，可选包含GPSI、DNN、IP地址域等参数。 
BSF查询到RCP注册的N7会话绑定信息，使用Nbsf_Management_Discovery响应向DRA提供该绑定信息。 
DRA（假设是Proxy模式）从绑定信息中读取RCP在Rx接口的Diameter主机名和域名，将AAR请求发送到对应的RCP。 
RCP处理AAR消息，回复AAA消息。 
DRA转发AAA消息给AF。 
######## AF通过外置BSF寻址RCP过程 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B3.png)仍以VoNR流程中AF（P-CSCF）寻址RCP的流程为例（不需要改造DRA，BSF已有绑定的RCP信息），具体描述如下： 
AF收到IMS用户注册请求或新的呼叫请求，构造Rx接口的AAR消息发送给DRA，AAR消息中的如下信息可用以DRA寻址RCP： 
目标域名（Destination-Realm） 
用户IPv4地址（Framed-IPv4-Address）或IPv6地址前缀（Framed-IPv6-Prefix) 
DRA收到AAR消息，直接转发AAR消息给BSF。 
BSF查询到RCP注册的N7会话绑定信息，将AAR消息再次转发给RCP。 
RCP处理AAR消息，回复AAA消息。 
BSF转发AAA消息给DRA。 
DRA转发AAA消息给AF。 
######## AF/NEF通过BSF寻址RCP过程 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B4.png)AF/NEF应用发生时，通过服务化接口寻址RCP的流程（BSF已有绑定的RCP信息），具体描述如下： 
AF/NEF根据UE IP地址信息，通过Nnrf_NFDiscovery Request向NRF查询支持处理的BSF，查询条件可能包含： 
用户IPv4地址和/或IPv6地址前缀 
DNN，详细可参见表1。 
NRF返回符合条件的BSF实例信息及服务信息。 
AF/NEF向BSF发送Nbsf_Management_Discovery请求查询N7会话绑定信息。请求中必须包含用户IP地址，可选包含GPSI、DNN、IP地址域等参数。 
BSF查询到RCP注册的N7会话绑定信息，使用Nbsf_Management_Discovery响应向AF/NEF提供该绑定信息。 
AF/NEF构造Npcf_PolicyAuthorization_Create请求消息并发送给RCP。 
RCP回复Npcf_PolicyAuthorization_Create Response消息给AF/NEF。 
###### 本网元实现 
######## 判断一个N7会话是否要向BSF注册 
RCP可配置DNN下是否启用BSF注册，默认记录为所有DNN不向BSF注册，可根据如下配置满足实际场景： 
所有DNN都不向BSF注册（例如SMF内置BSF，就不需要RCP向BSF注册）。 
所有DNN都向BSF注册（例如所有DNN都有AF会话）。 
仅指定DNN向BSF注册（例如仅IMS APN开启AF会话）。 
除指定DNN外都向BSF注册（如果除少量DNN外都要向BSF注册，可以反过来配置）。 
######## BSF发现 
BSF一般以主备或负荷分担方式工作。如果是负荷分担方式，多个BSF间是按UE IP地址段负荷分担。 
发现BSF方式可通过服务发现方式配置进行配置，发现方式可以配置为动态、静态或者动态优先。
RCP向BSF绑定注册时，先会通过NRF发现目标BSF，并根据发现结果中的nfinstanceid订阅该BSF的信息变更，将发现结果缓存下来。后续业务流程根据N7会话提供的UE IP地址查询本地缓存的BSF局向信息，找到匹配的BSF，如果找不到，再次执行NRF发现BSF的流程。 
新增订阅条件配置，按照目的网元类型BSF进行订阅，BSF网元向NRF更新注册信息后，NRF会通知RCP更新本地缓存。
如果用本地配置，涉及配置本地NRF配置，该配置配置了BSF网元的相关信息，静态发现会根据IP地址等信息匹配到相应局向。
######## BSF注册失败处理 
RCP和BSF交互失败，不影响当次N7业务流程（N7接口仍可以回复成功的响应码），但下次该会话的N7 Update业务流程就会直接回复失败码500 Internal Server Error（SYSTEM_FAILURE），不重试BSF注册，Update失败响应会触发SMF的CCFH流程释放会话，整体上看是因为PCF的BSF注册失败而延时释放了N7会话。延迟释放会话可以避免因BSF持续故障引发的用户反复上下线信令风暴。 
对于语音会话，PCF向BSF注册失败时：如果“会话授权时长特定配置”中“IMS会话BSF交互失败授权时长”配置值>0（默认值是10分钟），PCF会参考此配置值下发Revalidation-Time，使得SMF在Revalidation-Time时间点触发Update流程。如果“IMS会话BSF交互失败授权时长”配置值=0，PCF会依据2084(BSFRETRY)定时器时长配置（默认值是10分钟）自行设置定时器，超过定时器时长时发起UpdateNotify/terminate请求触发N7会话释放。 
对于数据会话，PCF向BSF注册失败时：如果“会话授权时长特定配置”中“数据会话BSF交互失败授权时长”配置值>0（默认值是10分钟），PCF会参考此配置值下发Revalidation-Time，使得SMF在Revalidation-Time时间点触发Update流程。如果“数据会话BSF交互失败授权时长”配置值=0，PCF不会自行设置定时器触发UpdateNotify/terminate操作，而是在下次N7业务流程时，通过Update失败响应或UpdateNotify/terminate请求触发N7会话释放。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性在VoNR场景使用时有交互，参见“ZUF-59-55-051 VoNR”。 
该特性在AF影响业务路由场景使用时有交互，参见“ZUF-59-55-052 AF影响业务路由”。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|29.521|5G System; Binding Support Management Service; Stage 3
##### 特性能力 
该特性不涉及专门的能力指标。 
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.21.10|首次发布
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
配置项命令项命令名称描述DNN启用BSF配置ADD DNNBSF新增DNN启用BSFSET DNNBSF修改DNN启用BSFDEL DNNBSF删除DNN启用BSFSHOW DNNBSF查询DNN启用BSF 
定时器定时器编号定时器名称系统缺省值（毫秒）建议2076FSWAITBSFACK3000等待BSF应答时长，不建议修改。2084BSFRETRY600000BSF回复失败后，无业务消息定时触发重发的时长，不建议修改。 
####### 性能统计 
性能计数器测量类型描述BSF接口测量参见“52007 BSF接口测量”中的计数器。BSF邻接主机测量参见“52027 BSF邻接主机测量”中的计数器。 
性能指标中文名称指标公式KPI描述（520079001）注册绑定成功率（%）C520070003 / (C520070001+C520070010+C520070018) ×100收到注册绑定成功应答次数/（发送注册绑定请求次数+注册绑定请求超时无应答次数+注册绑定请求超时应答次数）×100（520079002）注销绑定成功率（%）C520070008 / (C520070006+C520070011+C520070019) ×100收到注销绑定成功应答次数/（发送注销绑定请求次数+注销绑定请求超时无应答次数+注销绑定请求超时应答次数）×100（520279001）注册绑定成功率（%）C520270005 / (C520270003+C520270012+C520270020) ×100收到注册绑定成功应答次数/（发送注册绑定请求次数+注册绑定请求超时无应答次数+注册绑定请求超时应答次数）×100（520279002）注销绑定成功率（%）C520270010 / (C520270008+C520270013+C520270021) ×100收到注销绑定成功应答次数/（发送注销绑定请求次数+注销绑定请求超时无应答次数+注销绑定请求超时应答次数）×100 
####### 告警和通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
#### 特性配置 

#### 特性配置 


 

##### 配置通过NRF发现BSF 
###### 配置说明 
本配置完成通过NRF发现BSF的配置。
###### 配置前提 
RCP与NRF之间的HTTP2链路配置完成。
###### 配置过程 
图1  通过NRF发现BSF的配置流程
[]images/%E9%80%9A%E8%BF%87NRF%E5%8F%91%E7%8E%B0BSF.png)
在EM→配置
页面中，执行如下配置过程：
在CommonS_HTTP_LB_0服务下执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
在CommonS_HTTP_LB_0服务下执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
在Npcf_PolicyManagement_0服务下执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，进行关联的HTTP客户端模板配置。
在Npcf_PolicyManagement_0服务下执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
 说明： 
NRF服务器相关配置见步骤5~步骤8，如果在已有NRF相关配置，可以忽略此段配置。 
在CommonS_HTTP_LB_0服务下执行[ADD SBINRFGROUP](../../CommonS_HTTP_LB\zh-cn\mml\1220505.html)命令，进行NRF服务器分组配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINRFNODE](../../CommonS_HTTP_LB\zh-cn\mml\1220501.html)命令，进行NRF服务器节点配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINRFPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220513.html)命令，进行NRF服务器策略配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINRFPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220509.html)命令，进行NRF服务器模板配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINRFPROFILESEL](../../CommonS_HTTP_LB\zh-cn\mml\1220527.html)命令，进行NRF服务器模板选择配置。
在CommonS_HTTP_LB_0 服务下执行[SET SBISRVDISCOVERY](../../CommonS_HTTP_LB\zh-cn\mml\1220525.html)命令，进行服务发现配置
在CommonS_HTTP_LB_0服务下执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现方式配置。
在Npcf_PolicyManagement_0服务下执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)命令，进行DNN启用BSF配置。
 说明： 
步骤13~步骤14为可选配置，如需使用区域限制用于服务发现，参考如下配置。
在Npcf_PolicyManagement_0服务下执行[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html)命令，进行本局配置。
在Npcf_PolicyManagement_0服务下执行[SET NRFPATTERN](../../Npcf_PolicyManagement\zh-CN\mml\1788126.html)命令，进行NRF策略配置。
###### 配置实例 
######## 场景说明 
RCP通过NRF发现BSF，配置某些DNN向BSF注册。 
######## 数据规划 
数据规划如下： 
RCP网元地址为4003::19:5。 
NRF网元地址为4003::19:3、4003::19:4，互备双活模式。 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv6模板1。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
基本数据规划如下： 
HTTP客户端模板配置参见下表。参数名称参数值编号1IP地址4003::19:5起始端口20000终止端口30000 
HTTP服务端模板配置参见下表。参数名称参数值编号1IP地址4003::19:5端口8080 
关联HTTP客户端模板配置参见下表。参数名称参数值服务类型NBSF_MGTHTTP IPv6模板ID1 
服务基础配置参见下表。参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
NRF服务器分组配置1参见下表。参数名称参数值NRF服务器组编号1描述信息NrfMaster 
NRF服务器分组配置2参见下表。参数名称参数值NRF服务器组编号2描述信息NrfSlave 
NRF服务器节点配置1参见下表。参数名称参数值NRF服务器节点编号1NRF服务器IP地址4004::19:3NRF服务器端口8080NRF服务器FQDNnrf1.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号1通知时使用的HTTP服务端模板编号1NRF服务器节点优先级1归属的NRF服务器组编号1 
NRF服务器节点配置2参见下表。参数名称参数值NRF服务器节点编号2NRF服务器IP地址4004::19:4NRF服务器端口8080NRF服务器FQDNnrf2.hatt.zte.com.cnURI schemehttpHTTP客户端模板编号1通知时使用的HTTP服务端模板编号1NRF服务器节点优先级2归属的NRF服务器组编号2 
NRF服务器策略配置参见下表。参数名称参数值NRF服务器策略编号1NRF模式NRFPATTERN="DUAL_ACTIVE" 
NRF服务器模板配置参见下表。参数名称参数值NRF服务器模板编号1NRF服务器策略编号1主用NRF服务器组编号1备用NRF服务器组编号2 
NRF服务器模板选择配置参见下表。参数名称参数值NF类型BSF_TYPENRF服务器模板编号1 
修改服务发现配置参见下表。参数名称参数值订阅者NF类型PCF_TYPE订阅者FQDNpcf.zte.com.cn 
服务发现方式配置参见下表。参数名称参数值目的NF类型BSF_TYPE发现方式DYNAMIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
DNN启用BSF配置参见下表。参数名称参数值DNNims启用BSFENABLE 
######## 配置步骤 
配置HTTP客户端版本。 
ADD CLIENTPROFILE:ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端版本。 
ADD SERVERPROFILE:ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板。 
ADD SVCHTTPCLTPROF:ID=1,SERVICETYPE="NBSF_MGT",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置NRF服务器分组1。 
ADD SBINRFGROUP:ID=1,DESC=NrfMaster 
配置NRF服务器分组2。 
ADD SBINRFGROUP:ID=2,DESC=NrfSlave 
配置NRF服务器节点1。 
ADD SBINRFNODE:ID=1,SERVERIPADDR="4004::19:3",SERVERPORT=8080,SERVERFQDN="nrf1.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=1,GROUPID=1
配置NRF服务器节点2。 
ADD SBINRFNODE:ID=2,SERVERIPADDR="4004::19:4",SERVERPORT=8080,SERVERFQDN="nrf2.hatt.zte.com.cn",SCHEME="HTTP",APIVERSION="V1",CLIENTPROFILEID=1,NOTIFYSVRPROFILEID=1,PRIORITY=2,GROUPID=2
配置NRF服务器策略。 
ADD SBINRFPOLICY:ID=1,NRFPATTERN="DUAL_ACTIVE" 
配置NRF服务器模板。 
ADD SBINRFPROFILE:ID=1,POLICYID=1,ACTIVESRVGRPID=1,BAKSRVGRPID=2 
选择NRF服务器模板。 
ADD SBINRFPROFILESEL:NFTYPE="BSF_TYPE",NRFPROFILEID=1 
修改服务发现配置，其中订阅者NF类型为必选。 
SET SBISRVDISCOVERY:SUBREQNFTYPE="PCF_TYPE",SUBREQFQDN="pcf.zte.com.cn"
配置服务发现方式。 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="DYNAMIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置DNN启用BSF。 
ADD DNNBSF:DNN="ims",BSF="ENABLE" 
（可选）配置NRF策略。 
SET NRFPATTERN:LOCDISC="YES" 
（可选）配置本局信息。地区按实际填写。 
SET NFINFO:NFID=1,LOCALITY="地区"  
##### 配置静态BSF 
###### 配置说明 
本配置完成本地配置BSF方式的配置。 
###### 配置前提 
RCP与BSF之间的HTTP2链路配置完成。
###### 配置过程 
图2  本地配置BSF的配置流程
[]images/1627371635915.png)
在EM→配置
页面中，执行如下配置过程：
在CommonS_HTTP_LB_0服务下执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，进行HTTP客户端模板配置。
在CommonS_HTTP_LB_0服务下执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，进行HTTP服务端模板配置。
在Npcf_PolicyManagement_0服务下执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，进行关联的HTTP客户端模板配置。
在Npcf_PolicyManagement_0服务下执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，进行服务基础配置。
 说明： 
BSF信息相关配置见步骤5~步骤7，根据用户地址配置对应的IPv4地址范围组或者IPv6前缀范围组。 
IPv6前缀范围组举例，如需配置IPv4地址范围组，执行[ADD SBIIPV4ADDRRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220765.html)命令和[ADD SBIIPV4ADDRRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220769.html)命令。
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPV6PREFIXRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220773.html)命令，进行IPv6前缀范围组编号配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPV6PREFIXRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220777.html)命令，进行IPv6前缀范围组参数配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIBSFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220949.html)命令，进行BSF信息配置。
 说明： 
NF相关配置见步骤8~步骤16。 
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html)命令，进行IPv6地址配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html)命令，进行IP端点配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html)命令，进行IP端点组编号配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，进行IP端点组参数配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html)命令，进行NF服务版本组编号配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html)命令，进行NF服务版本组参数配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html)命令，进行对端NF基本信息配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html)命令，进行对端NF扩展信息配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html)命令，进行对端NF实例配置。
在CommonS_HTTP_LB_0服务下执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，进行服务发现配置。
在Npcf_PolicyManagement_0服务下执行[ADD DNNBSF](../../Npcf_PolicyManagement\zh-CN\mml\1788174.html)命令，进行DNN启用BSF配置。
###### 配置实例 
######## 场景说明 
RCP本地配置静态BSF信息，经过IPv6前缀地址段分析配置某些DNN向BSF注册。 
######## 数据规划 
数据规划如下： 
RCP网元地址为4003::19:5。 
BSF网元地址为4003::19:3、4003::19:4。 
UE IPv6前缀范围组200:127:0:100::/64~400:127:0:100::/64。 
关联的HTTP客户端模板配置中，服务类型NBSF_MGT，关联HTTP客户端IPv6模板1。 
服务基础配置中，服务类型NPCF的版本为v1、FQDN为pcf.zte.com.cn、优先级为1。 
基本数据规划如下： 
HTTP客户端模板配置参见下表。参数名称参数值
编号1IP地址4003::19:5起始端口20000终止端口30000 
HTTP服务端模板配置参见下表。参数名称参数值
编号1IP地址4003::19:5端口8080 
关联HTTP客户端模板配置参见下表。参数名称参数值服务类型NBSF_MGTHTTP IPv6模板ID1 
服务基础配置参见下表。参数名称参数值服务类型NPCFFqdnpcf.zte.com.cn版本v1优先级1 
IPv6前缀范围组编号配置参见下表。参数名称参数值IPv6前缀范围组编号200 
IPv6前缀范围组参数配置参见下表。参数名称参数值配置索引200IPv6前缀范围组编号200开始200:127:0:100::/64结束400:127::/64 
BSF信息配置参见下表。参数名称参数值BSF信息编号200IPv6前缀范围组编号200 
IPv6地址配置1参见下表。参数名称参数值IPv6地址编号200IP地址4004::19:3 
IPv6地址配置2参见下表。参数名称参数值IPv6地址编号201IP地址4004::19:4 
IP端点配置1参见下表。参数名称参数值IP端点编号200端口8080IPv6地址编号200 
IP端点配置2参见下表。参数名称参数值IP端点编号201端口8080IPv6地址编号201 
IP端点组编号配置1参见下表。参数名称参数值IP端点组编号200 
IP端点组编号配置2参见下表。参数名称参数值IP端点组编号201 
IP端点组参数配置1参见下表。参数名称参数值配置索引200IP端点组编号200IP端点编号200 
IP端点组参数配置2参见下表。参数名称参数值配置索引201IP端点组编号201IP端点编号201 
NF服务版本组编号配置参见下表。参数名称参数值NF服务版本组编号100 
NF服务版本组参数配置参见下表。参数名称参数值配置索引100NF服务版本组编号100API URI版本号v1API完整版本号v1 
对端NF基本信息配置1参见下表。参数名称参数值对端NF信息编号200NF实例标识200NF类型BSF_TYPENF状态REGISTEREDNF实例名称460e6cfe-5eea-4036-8566-77744b5e7101 
对端NF基本信息配置2参见下表。参数名称参数值对端NF信息编号201NF实例标识201NF类型BSF_TYPENF状态REGISTEREDNF实例名称460e6cfe-5eea-4036-8566-77744b5e7199 
对端NF扩展信息配置1参见下表。参数名称参数值对端NF信息编号200BSF信息编号200 
对端NF扩展信息配置2参见下表。参数名称参数值对端NF信息编号201BSF信息编号200 
对端NF实例配置1参见下表。参数名称参数值配置索引200归属NF编号200服务实例标识200服务名称NBSF_MANAGEMENT服务版本组编号100协议模式HTTP服务实例状态REGISTERED域名bsf1.zte.com.cnIP端点组编号200优先级1 
对端NF实例配置2参见下表。参数名称参数值配置索引201归属NF编号201服务实例标识201服务名称NBSF_MANAGEMENT服务版本组编号100协议模式HTTP服务实例状态REGISTERED域名bsf2.zte.com.cnIP端点组编号201优先级2 
服务发现方式配置参见下表。参数名称参数值目的NF类型BSF_TYPE发现方式STATIC_ONLY地址选择方式RANDOMhttp默认端口8080https默认端口443 
DNN启用BSF配置参见下表。参数名称参数值DNNvolte启用BSFENABLE 
######## 配置步骤 
配置HTTP客户端版本。 
ADD CLIENTPROFILE:ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端版本。 
ADD SERVERPROFILE:ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板。 
ADD SVCHTTPCLTPROF:ID=2,SERVICETYPE="NBSF_MGT",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础。 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
配置IPv6前缀范围组编号。 
ADD SBIIPV6PREFIXRANGEARRID:ARRAYID=200 
配置IPv6前缀范围组参数。 
ADD SBIIPV6PREFIXRANGEARRPARAM:INDEX=200,ARRAYID=200,START="200:127:0:100::/64",END="400:127::/64"
配置BSF信息。 
ADD SBIBSFINFO:ID=200,IPV6PREFIXRNGARRAY=200 
配置IPv6地址1。 
ADD SBIIPV6ADDR:ID=200,IP="4004::19:3" 
配置IPv6地址2。 
ADD SBIIPV6ADDR:ID=201,IP="4004::19:4" 
配置IP端点1。 
ADD SBIIPENDPOINT:INDEX=200,IPV6=200,PORT=8080 
配置IP端点2。 
ADD SBIIPENDPOINT:INDEX=201,IPV6=201,PORT=8080 
配置IP端点组编号1。 
ADD SBIIPENDPOINTARRID:ARRAYID=200 
配置IP端点组编号2。 
ADD SBIIPENDPOINTARRID:ARRAYID=201 
配置IP端点组参数1。 
ADD SBIIPENDPOINTARRPARAM:INDEX=200,ARRAYID=200,IPENDPOINT=200 
配置IP端点组参数2。 
ADD SBIIPENDPOINTARRPARAM:INDEX=201,ARRAYID=201,IPENDPOINT=201 
配置NF服务版本组编号。 
ADD SBINFSVERSIONARRID:ARRAYID=100 
配置NF服务版本组参数。 
ADD SBINFSVERSIONARRPARAM:INDEX=100,ARRAYID=100,APIVERSIONINURI="v1",APIFULLVERSION="v1"
配置对端NF基本信息1。 
ADD SBIPEERNFBASEINFO:ID=200,NFINSTANCEID="200",NFTYPE="BSF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="460e6cfe-5eea-4036-8566-77744b5e7101",PRIORITY=1
配置对端NF基本信息2。 
ADD SBIPEERNFBASEINFO:ID=201,NFINSTANCEID="201",NFTYPE="BSF_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="460e6cfe-5eea-4036-8566-77744b5e7199",PRIORITY=2
配置对端NF扩展信息1。 
ADD SBIPEERNFEXTINFO:ID=200,BSFINFO=200 
配置对端NF扩展信息2。 
ADD SBIPEERNFEXTINFO:ID=201,BSFINFO=200 
配置对端NF实例1。 
ADD SBIPEERNFSERVICEINSTANCE:INDEX=200,NFINDEX=200,SRVINSTANCEID="200",SERVICENAME="NBSF_MANAGEMENT",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="bsf1.zte.com.cn",IPENDPOINTARRAY=200,PRIORITY=1
配置对端NF实例2。 
ADD SBIPEERNFSERVICEINSTANCE:INDEX=201,NFINDEX=201,SRVINSTANCEID="201",SERVICENAME="NBSF_MANAGEMENT",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="bsf2.zte.com.cn",IPENDPOINTARRAY=201,PRIORITY=2
配置重选。 
ADD SBIRESELECT:TARGETNFTYPE="BSF_TYPE" 
配置服务发现方式。 
ADD SBISRVDISCOVERYMODE:TARGETNFTYPE="BSF_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略。 
ADD SBIROUTEPOLICY:TARGETNFTYPE="BSF_TYPE",NFTYPE="PCF_TYPE" 
配置DNN启用BSF。 
ADD DNNBSF:DNN="volte",BSF="ENABLE" 
##### 测试用例 
测试条目|RCP向静态配置的BSF注册和注销
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上参见“配置实例”进行配置。
测试步骤|用户A在本地接入网络，携带DNN=ims。用户发起语音呼叫。用户下线。
通过准则|RCP收到用户上线请求后，检查DNN需要向BSF注册，向BSF发送注册请求。RCP收到BSF返回的响应后向SMF返回上线成功。用户语音业务正常。用户下线，RCP向BSF发送注销请求。RCP收到BSF返回的响应后向SMF返回下线成功。
测试条目|RCP向动态发现的BSF注册和注销
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上参见“配置实例”进行配置。
测试步骤|用户A在本地接入网络，携带DNN=ims。用户发起语音呼叫。用户下线。
通过准则|RCP收到用户上线请求后，检查DNN需要向BSF注册，本地未配置BSF信息，向NRF发送服务发现请求，请求发现BSF。RCP收到NRF返回的BSF信息后，向BSF发送注册请求，RCP收到BSF的成功响应后向SMF返回上线成功。用户语音业务正常。用户下线，RCP向BSF发送注销请求。RCP收到BSF返回的响应后向SMF返回下线成功。
### 缩略语 
### 缩略语 
#### 5GC 
5G Core Network5G核心网
#### AF 
Application Function应用功能
#### BSF 
Binding Support Function绑定支持功能
#### DNN 
Data Network Name数据网名称
#### DRA 
Diameter Routing AgentDiameter路由代理
#### EPC 
Evolved Packet Core演进的分组核心网
#### EPS 
Evolved Packet System演进的分组系统
#### NEF 
Network Element Function网络单元（网元）功能
#### NRF 
NF Repository Function网络仓储功能
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCF 
Policy Control Function策略控制功能
#### PCRF 
Policy and Charging Rules Function策略和计费规则功能
#### PDU 
Packet Data Unit分组数据单元
#### RCP 
Resource Control Platform资源控制平台
#### S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
#### SMF 
Session Management Function会话管理功能
#### TLS 
Transport Layer Security传输层安全
#### UE 
User Equipment用户设备
#### VoNR 
Voice over New Radio新空口承载语音
## 策略条件类特性 
### ZUF-59-42-001 基于默认签约的策略 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
签约信息（User profile information）|SPR中存储的用户签约信息，包括用户类型、签约的业务等。
##### 描述 
####### 定义 
默认签约包括默认用户类型、默认套餐。运维人员可以为不同号段的用户或特定用户类型的用户配置默认签约，并配置基于默认签约的控制策略。用户上线时，RCP根据默认签约信息为用户激活默认策略。 
此外，RCP还提供全局套餐的配置。全局套餐是对所有用户都生效的默认套餐。 
####### 背景知识 
在某些异常情况下用户获取不到个性化签约，为了给这些用户提供基本的QoS保障，RCP提供默认签约的配置以及基于默认签约的策略控制，为用户提供默认策略。 
##### 应用场景 
默认签约应用于以下场景： 
未配置SPR。对无SPR局向配置的用户，运维人员可根据规划为之配置默认签约（指定用户类型和默认套餐）。在“非VoLTE”且“非紧急呼叫”时，RCP根据“未配置SPR”的默认签约为这些用户提供默认策略。 
SPR返回用户未知。非PCC用户未在SPR放号，向SPR获取签约时，SPR返回用户未知。运维人员可根据规划为用户配置默认签约（指定用户类型和默认套餐）。当SPR返回用户未知时，RCP根据“SPR返回用户未知”时的默认签约为这些用户提供默认策略。例如：IMSI号段100000000000000~300000000000000之间的非PCC用户，设置默认套餐1，套餐1的2小时内使用流量超过100MB则进行限速。IMSI号段500000000000000~600000000000000之间的非PCC用户，设置默认套餐2，套餐2的默认带宽64Kbps。 
SPR宕机。SPR异常或Sp接口链路异常，RCP均认为SPR宕机。运维人员可根据规划为用户配置默认签约（指定用户类型和默认套餐）。用户上线时向SPR获取签约，由于Sp/Sp'接口链路异常、或SPR异常返回失败，RCP根据“SPR宕机”时的默认签约为这些用户提供默认策略。 
SPR签约中的关键信息（用户类型、套餐）缺失。用户向SPR成功获取签约，签约信息中没有生效的套餐或没有指定用户类型。运维人员可根据规划为“SPR中未签约套餐”的用户配置默认套餐，为“SPR签约中未携带用户类型” 的配置默认用户类型。RCP根据“SPR中未签约套餐”和“SPR签约中未携带用户类型”时的默认签约为这些用户提供默认策略。 
SPR签约正常，为不同号段的用户开通不同的默认套餐。RCP向SPR获取签约成功，签约信息也正常，但运营商希望通过RCP设置不同的策略，实现为不同号段的用户开通不同的默认套餐。 
在特定时间段，为所有用户提供多个默认套餐 。例如，流量池红包业务。由企业购买一定量的定向流量或通用流量，免费提供给所有用户使用，例如淘宝双11免流量。此场景下的默认套餐通过配置“全局套餐”来实现。 
##### 客户收益 
收益方|收益描述
---|---
运营商|异常场景下用户无法获取个性化签约时，运营商通过在RCP配置默认签约为用户提供默认策略，增强产品竞争力。
终端用户|异常场景下用户无法获取个性化签约时，用户的业务访问得到了基本的QoS保证。

##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new8de1dc82243042b78b1622202082d3b8__94eed350-dbed-417a-8de8-44a1761b1f54)所示。
图1  系统架构
[]images/%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.png)
###### 各网元作用 
涉及的网元及其功能参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf0ca60caa2a14ff0adf6fe961b67581c__33026e75-df8a-4b15-854d-d3fb5d7e4667)。
网元|描述
---|---
RCP|提供默认签约配置。用户上线时，RCP向SPR获取用户个性化签约，根据个性化签约、默认签约及用户会话当前状态等信息进行策略决策。
SPR|提供用户个性化签约，包括用户类型、套餐信息等。
###### 业务流程 
######## 用户上线，不向SPR获取签约 
用户上线，不向SPR获取签约的流程如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newfe3620fc09294245b27860ea981250c9__b9b381f1-e6d9-4dfa-9848-30d1d1fd5aad)所示。
图2  用户上线，不向SPR获取签约
[]images/%E7%94%A8%E6%88%B7%E4%B8%8A%E7%BA%BF%EF%BC%8C%E4%B8%8D%E5%90%91spr%E8%8E%B7%E5%8F%96%E7%AD%BE%E7%BA%A6.png)
步骤： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。因此SMF向RCP发送Npcf_SMPolicyControl_Create Request消息。 
RCP获取默认签约及策略决策。 
RCP根据Npcf_SMPolicyControl_Create携带的用户号码，进行SPR局向分析，分析结果为：无邻接SPR，且非紧急呼叫、非指定APN的VoLTE接入。 
RCP查询全局开关“1079 用户未配置SPR处理方式
”的配置信息。如果配置为“0-使用默认签约”，则RCP根据用户号码进行默认签约的号段分析，获取该用户的默认签约（默认签约也可能不存在）。
RCP获取全局套餐配置。 
RCP根据用户的默认签约、全局套餐、会话当前状态、及策略配置数据（登录客户端页面，选择菜单配置→RCP策略管理
配置相关策略数据），进行策略决策，生成规则。
RCP将当前会话决策出的规则，通过Npcf_SMPolicyControl_Create Response消息发送给SMF。 
######## 用户上线，向SPR获取签约 
用户上线，向SPR获取签约的流程如[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newfe3620fc09294245b27860ea981250c9__8c6293bd-cff2-4493-b34f-d7701cafa811)所示。
图3  用户上线，向SPR获取签约
[]images/%E7%94%A8%E6%88%B7%E4%B8%8A%E7%BA%BF%EF%BC%8C%E5%90%91spr%E8%8E%B7%E5%8F%96%E7%AD%BE%E7%BA%A6.png)
步骤： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。因此SMF向RCP发送Npcf_SMPolicyControl_Create Request消息。 
RCP通过Sp接口向SPR发送UDR消息，获取用户签约。 
本步骤只有在如下场景下才会执行。 
RCP根据CCR携带的用户号码进行SPR局向分析，分析结果为：有邻接SPR，且“签约和用量接口交互模式”为“签约和用量都有交互”。 
RCP等待获取签约响应。当RCP收到Sp-UDA响应消息或等待响应消息超时，则为用户获取默认签约。 
RCP为用户获取默认签约有如下可能场景： 
SPR成功返回UDA给RCP，签约中携带用户类型和有效的套餐。RCP首先根据用户类型获取默认签约，若没有获取到默认签约，则继续根据用户号码进行默认签约的号段分析，从RCP网管配置中获取“SPR签约正常时的默认套餐”（默认签约信息也可能获取不到）。 
SPR成功返回UDA给RCP，签约中无用户类型。RCP根据用户号码进行默认签约的号段分析，从RCP网管配置中获取“签约未说明时用户（组）类型”（默认签约信息也可能获取不到）。 
SPR成功返回UDA给RCP，签约中无生效套餐。RCP根据用户号码进行默认签约的号段分析，从RCP网管配置中获取“SPR中未签约套餐时默认套餐”（默认签约信息也可能获取不到）。 
RCP等UDA超时，链路异常或SPR宕机。RCP根据用户号码进行默认签约的号段分析，从RCP网管配置中获取“SPR宕机时用户类型”和“SPR宕机时默认套餐”（默认签约信息也可能获取不到）。 
SPR返回用户不存在。RCP根据用户号码进行默认签约的号段分析，从RCP网管配置中获取“SPR返回用户未知时的默认套餐”和“SPR返回用户未知时用户类型”（默认签约信息也可能获取不到）。 
上述各个场景，如果运营商没有为用户规划配置默认签约，则用户没有默认签约。 
如果RCP从SPR成功获取了用户个性化签约、或“签约和用量接口交互模式”为“仅有用量交互”，RCP通过Sp'接口向SPR发送UDR消息，获取用量等动态数据。 
SPR发送Sp'-UDA消息给RCP。若用户有动态数据，那么动态数据通过Sp'-UDA携带给RCP。 
RCP根据用户个性化签约、默认签约、全局套餐、会话当前状态、及策略配置数据（登录客户端页面，选择菜单配置→RCP策略管理
配置相关策略数据）进行策略决策，生成规则。
RCP将当前会话决策出的规则通过Npcf_SMPolicyControl_Create Response消息发送给SMF。 
###### 本网元实现 
######## 默认签约的管理 
RCP提供默认签约的配置和管理。在RCP网管中，可以根据规划为指定号段配置默认签约，也可以为指定用户类型（用户类型保存在字段UserType中）配置默认签约。 
RCP为用户获取默认签约的流程如[图4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new5045d717e701446799868a5eb0953211__d7f5b6c6-a256-4382-8846-dc6008bd09b2)所示。
图4  获取默认签约的流程
[]images/%E8%8E%B7%E5%8F%96%E9%BB%98%E8%AE%A4%E7%AD%BE%E7%BA%A6%E6%B5%81%E7%A8%8B.png)
对于成功向SPR获取到签约的用户，若签约中存在用户类型，则优先根据用户类型获取默认签约。 
如果未获取到签约信息或者获取到的签约信息中不存在用户类型，则先根据用户号码进行默认签约号码段分析，再根据号码分析结果获取默认签约。 
只有在用户上线、PNR更新用户签约时，RCP才会获取用户的默认签约配置。用户在线期间，其他情况下（非上线场景、非PNR更新场景）更新默认签约，对当前会话不生效。 
######## 全局套餐 
默认签约配置支持每种场景（SPR宕机、用户未知等）最多5个默认套餐。当需要为所有用户配置多个默认套餐时，在默认签约中配置默认套餐的个数有局限。此时，可通过全局套餐配置表配置套餐，系统中所有用户均可使用全局套餐。 
在用户上线、PNR更新用户签约时，RCP为用户获取默认签约后，继续获取全局套餐，通过默认签约获取到的套餐、全局套餐均为用户的可用套餐。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
相关特性|交互关系
---|---
ZUF-59-41-002 Diameter Sp/Sp'接口|运营商根据规划为用户配置各种场景下的默认签约。用户上线获取默认签约，有些场景需要等待与SPR交互后才能确定取何种默认签约，比如：获取“SPR返回用户未知时的默认签约”。RCP与SPR的交互需要通过Diameter Sp/Sp'接口完成。
##### 遵循标准 
本特性采用中兴通讯内部的接口和协议，不涉及标准协议。 
##### 特性能力 
名称|指标
---|---
每个用户默认套餐个数最大值|40
全局套餐个数最大值|30
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布
####### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
####### 对其他网元的要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
###### 配置命令 
配置项|命令|描述
---|---|---
用户资料接入局配置|ADD USERACC|新增用户资料接入局。指定RCP与邻接SPR之间的接口交互模式。
SET USERACC|用户资料接入局配置|修改用户资料接入局。
DEL USERACC|用户资料接入局配置|删除用户资料接入局。
SHOW USERACC|用户资料接入局配置|查询用户资料接入局。
套餐基本配置|ADD PKGINFO|新增套餐基本配置。
SET PKGINFO|套餐基本配置|修改套餐基本配置。
DEL PKGINFO|套餐基本配置|删除套餐基本配置。
SHOW PKGINFO|套餐基本配置|查询套餐基本配置。
默认签约信息配置|ADD DEFSPRINFO|新增默认签约信息。说明：配置默认套餐时需先进行套餐基本配置。
SET DEFSPRINFO|默认签约信息配置|修改默认签约信息。
DEL DEFSPRINFO|默认签约信息配置|删除默认签约信息。
SHOW DEFSPRINFO|默认签约信息配置|查询默认签约信息。
特定用户的默认签约信息配置|ADD SPRINFO|新增特定用户的默认签约信息。
SET SPRINFO|特定用户的默认签约信息配置|修改特定用户的默认签约信息。
DEL SPRINFO|特定用户的默认签约信息配置|删除特定用户的默认签约信息。
SHOW SPRINFO|特定用户的默认签约信息配置|查询特定用户的默认签约信息。
全局套餐配置|ADD GLBPKG|新增全局套餐。说明：配置全局套餐时需先进行套餐基本配置。
SET GLBPKG|全局套餐配置|修改全局套餐。
DEL GLBPKG|全局套餐配置|删除全局套餐。
SHOW GLBPKG|全局套餐配置|查询全局套餐。
配置项|命令|新增参数
---|---|---
号码段分析配置|ADD NUMANA|参数号码段分析类型，新增以下几种类型：默认签约信息IMSI分析默认签约信息MSISDN分析默认签约信息CUI分析用户组默认签约信息Group ID分析
###### 全局变量 
序号|描述
---|---
1|1003 未知用户处理方式
2|1009 SPR执行失败的处理方式
3|1079 用户未配置SPR处理方式
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
该特性不涉及告警/通知消息的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


 

##### 配置默认签约 
###### 配置说明 
运维人员根据规划为指定号段的用户或特定用户类型的用户配置默认签约。 
运维人员根据规划配置全局套餐，为系统中所有用户可用。 
###### 配置前提 
完成邻接主机（SPR）配置、相关的链路/路由配置、以及用户资料接入局的号码段配置。 
完成其他接口（比如N7接口）相关配置。 
###### 配置过程 
配置流程如[图1](1665216606044.html#T_20175108424918__cc445c2e-f7e6-4ee9-beae-b3e0c5b30853)所示。
图1  配置流程
[]images/%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
步骤： 
登录EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0 服务。
执行[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html)命令，配置用户资料接入局。
执行[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令，配置用户资料接入局类型的号码段分析。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息。
执行[ADD DEFSPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787337.html)命令，配置默认签约信息。
执行[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令，配置默认签约的号码段分析。
执行[ADD SPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787430.html)命令，配置特定用户类型的默认签约信息。
执行[ADD GLBPKG](../../Npcf_PolicyManagement\zh-CN\mml\1787376.html)命令，配置全局套餐。
进入策略管理页面，配置基于默认签约信息的控制策略。
###### 配置实例-用户未知时的策略控制 
######## 场景说明 
所有非PCC用户，下发低带宽。
用户签约|策略控制条件|策略
---|---|---
IMSI为136000000000000的用户无个性化签约，SPR返回特定错误码“用户未知”。|非PCC用户|会话AMBR上/下行速率均为128 Kbps
######## 数据规划 
类别|参数|取值
---|---|---
非PCC用户的默认签约|IMSI号段|000000000000000~999999999999999
SPR返回用户未知时的默认套餐|非PCC用户的默认签约|100
规则|N7会话控制策略|当前使用套餐100，则上下行速率为128 Kbps
######## 业务配置关系图 
业务配置关系图如[图2](1665216606044.html#T_20175108424919__d7d042ea-53c5-4a1f-b8c7-f55f05dc741f)所示。
图2  QoS_Based_on_DefPak100场景
[]images/1.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="100",PRIORITY=1;
配置默认签约信息。 
[ADD DEFSPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787337.html):DEFPROFID=1,PKGID1NOSUBS="100";
配置“默认签约信息”号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=10,ANATYPE="DEFSUBS_IMSI",NUMBEGIN="000000000000000",NUMEND="999999999999999",RESULTID=1;
配置策略

配置动作参数 
N7会话参数集： 
动作参数名称|参数名称|取值
---|---|---
Action_Sess_Non_PCC|参数类型|N7会话参数集
会话AMBR上行速率(kbps)|Action_Sess_Non_PCC|128
会话AMBR下行速率(kbps)|Action_Sess_Non_PCC|128
配置规则 
N7会话控制策略规则： 
规则名称|参数|取值
---|---|---
Rule_Sess_Non_PCC|优先级|1
动作类型|Rule_Sess_Non_PCC|参数填充
日志开关|Rule_Sess_Non_PCC|关
条件表达式|Rule_Sess_Non_PCC|无
动作参数名称|Rule_Sess_Non_PCC|Action_Sess_Non_PCC

配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
QoS_Based_on_DefPak100|入口|入口类型|用户信息类
已选入口|QoS_Based_on_DefPak100|入口|用户套餐
取值|QoS_Based_on_DefPak100|入口|100
策略类型|QoS_Based_on_DefPak100|N7会话控制策略|Rule_Sess_Non_PCC
###### 配置实例-SPR宕机时的策略控制 
######## 场景说明 
用户在SPR宕机或链路异常时，下发基本带宽。 
用户签约|策略控制条件|策略
---|---|---
配置“SPR宕机时默认套餐”为101|用户使用套餐101|会话AMBR上/下行速率均为128 Kbps
######## 数据规划 
类别|参数|取值
---|---|---
SPR宕机时默认签约|IMSI号段|000000000000000~999999999999999
SPR宕机时的默认套餐|SPR宕机时默认签约|101
规则|N7会话控制策略|当前使用套餐101，则上下行速率为128 Kbps
######## 业务配置关系图 
业务配置关系图如[图3](1665216606044.html#newdc704182d46146608f4999ab837bee0c__c002a0d4-7fb9-4468-8607-cddadfd78755)所示。
图3  QoS_Based_on_DefPak101场景
[]images/962bfec31fe94531813c4496b748e402.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="101",PRIORITY=1;
配置默认签约信息。 
[ADD DEFSPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787337.html):DEFPROFID=2,PKGID1NOSUBS="101";
配置默认签约信息号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=11,ANATYPE="DEFSUBS_IMSI",NUMBEGIN="000000000000000",NUMEND="999999999999999",RESULTID=2;
配置策略

配置动作参数 
N7会话参数集： 
动作参数名称|参数名称|取值
---|---|---
Act_Sess_128K|参数类型|N7会话参数集
会话AMBR上行速率(kbps)|Act_Sess_128K|128
会话AMBR下行速率(kbps)|Act_Sess_128K|128
配置规则 
N7会话控制策略规则： 
规则名称|参数|取值
---|---|---
Rule_Sess_1|优先级|1
动作类型|Rule_Sess_1|参数填充
日志开关|Rule_Sess_1|关
条件表达式|Rule_Sess_1|无
动作参数名称|Rule_Sess_1|Act_Sess_128K

配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
QoS_Based_on_DefPak101|入口|入口类型|用户信息类
已选入口|QoS_Based_on_DefPak101|入口|用户套餐
取值|QoS_Based_on_DefPak101|入口|101
策略类型|QoS_Based_on_DefPak101|N7会话控制策略|Rule_Sess_1
###### 配置实例-用户有签约且无有效套餐时的策略控制 
######## 场景说明 
PCC用户的金牌用户，所有套餐已过期或没有签订套餐，用户上线时为其指定默认套餐，并提供基本带宽。 
用户签约|策略控制条件|策略
---|---|---
金牌用户，配置“SPR未签约套餐时的默认套餐”为102。|用户使用套餐102|会话AMBR上/下行速率(kbps) 均为128 Kbps
######## 数据规划 
类别|参数|取值
---|---|---
金牌用户|UserType|1
SPR未签约套餐时的默认签约|SPR未签约套餐时的默认套餐|102
规则|N7会话控制策略|当前使用套餐102，则上下行速率为128 Kbps
######## 业务配置关系图 
业务配置关系图如[图4](1665216606044.html#newb9bd0200470d48bdaad80a8d71653c80__fa04208e-8024-4ba8-96ac-c7671a9eb251)所示。
图4  QoS_Based_on_DefPak102场景
[]images/9781c12f462e4ddf9ca4553bef0bb4df.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="102",PRIORITY=1;
配置默认签约信息 
[ADD DEFSPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787337.html):DEFPROFID=3,PKGID1NOSUBS="102";
配置特定用户的默认签约 
[ADD SPRINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787430.html):USERTYPE=1,DEFPROFID=3;
配置策略

配置规则动作参数 
N7会话参数集： 
动作参数名称|参数名称|取值
---|---|---
Act_Sess_128K|参数类型|N7会话参数集
会话AMBR上行速率(kbps)|Act_Sess_128K|128
会话AMBR下行速率(kbps)|Act_Sess_128K|128
配置规则 
N7会话控制策略规则： 
规则名称|参数|取值
---|---|---
Rule_Sess_1|优先级|1
动作类型|Rule_Sess_1|参数填充
日志开关|Rule_Sess_1|关
条件表达式|Rule_Sess_1|无
动作参数名称|Rule_Sess_1|Act_Sess_128K

配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
QoS_Based_on_DefPak102|入口|入口类型|用户信息类
已选入口|QoS_Based_on_DefPak102|入口|用户套餐
取值|QoS_Based_on_DefPak102|入口|102
策略类型|QoS_Based_on_DefPak102|N7会话控制策略|Rule_Sess_1
###### 配置实例-特定时间段为所有用户免费提供多个流量红包 
######## 配置场景 
双十一当天（2021-11-11 00:00:00 ~ 2021-11-11 23:59:59）多家服务提供商通过电信运营商，为全网用户提供多个免费的本地流量套餐（当天有效），分别用于手机各种APP的网上购物。比如：淘宝、天猫、京东、1号店、苏宁易购、美团等。 
用户签约|策略控制条件|策略
---|---|---
双十一当天，淘宝、京东等手机应用，对应的全局套餐为111，112，且优先级高。每个套餐的可用流量200 MB，流量耗尽就失效。用户个性化签约套餐1。|淘宝业务，套餐111的使用流量<200 MB|请求的上/下行带宽均为10 Mbps
京东业务，套餐112的使用流量<200 MB|双十一当天，淘宝、京东等手机应用，对应的全局套餐为111，112，且优先级高。每个套餐的可用流量200 MB，流量耗尽就失效。用户个性化签约套餐1。|请求的上/下行带宽均为10 Mbps
淘宝和京东，使用套餐1时|双十一当天，淘宝、京东等手机应用，对应的全局套餐为111，112，且优先级高。每个套餐的可用流量200 MB，流量耗尽就失效。用户个性化签约套餐1。|请求的上/下行带宽均为5 Mbps
######## 数据规划 
类别|参数|取值
---|---|---
套餐信息|全局套餐|编号|111，112
优先级|套餐信息|全局套餐|9999
超出签约阈值后套餐是否失效|套餐信息|全局套餐|是
有效期|套餐信息|全局套餐|2021-11-11 00:00:00 ~ 2021-11-11 23:59:59
双十一流量包|套餐信息|全局套餐|分别200 MB
用户个性化签约套餐|套餐信息|编号|1
优先级|用户个性化签约套餐|套餐信息|1
有效期|用户个性化签约套餐|套餐信息|2021-01-01 00:00:00 ~
月流量签约值|用户个性化签约套餐|套餐信息|1 GB
签约业务|用户个性化签约套餐|套餐信息|1，2
业务规划|淘宝|套餐标识|111
签约业务标识|业务规划|淘宝|1
应用标识|业务规划|淘宝|1001
京东|业务规划|套餐标识|112
签约业务标识|京东|业务规划|2
应用标识|京东|业务规划|1002
规则|N7业务控制策略1|对于淘宝业务，若使用套餐111，且套餐111的使用流量<=200 MB，那么最大上/下行带宽均为10 Mbps；否则，提供默认带宽5 Mbps。|N7业务控制策略1
N7业务控制策略2|规则|N7业务控制策略2|对于京东业务，若使用套餐112，且套餐112的使用流量<=200 MB，最大上/下行带宽均为10 Mbps；否则，提供默认带宽5 Mbps。
业务用量监控策略|规则|业务用量监控策略|固定值方式
######## 业务配置关系图 
套餐1的业务控制策略配置关系图如[图5](1665216606044.html#newb2f04f07a3704215a65c39de801ee974__2168e322-9d3f-47f9-a46e-c1accbbad79c)所示。套餐111的业务控制策略配置关系图如[图6](1665216606044.html#newb2f04f07a3704215a65c39de801ee974__53ba5bb2-e81e-4f35-b29f-f18aeb72b950)所示，套餐112的业务控制策略配置关系图如[图7](1665216606044.html#newb2f04f07a3704215a65c39de801ee974__0b4dd3c7-b993-41ed-8934-4f800acb94bd)所示，预下发业务控制策略的配置关系图[图8](1665216606044.html#newb2f04f07a3704215a65c39de801ee974__48d38d3d-4581-4ec8-9e8a-553de2d64359)所示。
图5  QoS_Based_on_Pak1场景
[]images/image.png)
图6  QoS_Based_on_Pak111场景
[]images/1649727726067.png)
图7  QoS_Based_on_Pak112场景
[]images/1649727802932.png)
图8  Role_PreProvSvc场景
[]images/1649727843979.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1, INVALID="NO";
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="111",PRIORITY=9999, INVALID="YES";
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="112",PRIORITY=9999, INVALID="YES";
配置套餐业务基本信息 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="111",SUBSID="1";
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=2,PKGID="112",SUBSID="2";
配置应用标识 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="taobao",SUBSID="1",SUBSDESC="1";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="jingdong",SUBSID="2",SUBSDESC="2";
配置全局套餐 
[ADD GLBPKG](../../Npcf_PolicyManagement\zh-CN\mml\1787376.html):PKGID="111",PKGSTARTTIME="2021-11-11 00:00:00",PKGENDTIME="2021-11-11 23:59:59";
[ADD GLBPKG](../../Npcf_PolicyManagement\zh-CN\mml\1787376.html):PKGID="112",PKGSTARTTIME="2021-11-11 00:00:00",PKGENDTIME="2021-11-11 23:59:59";
配置策略
配置基本用量 
基本用量|参数|取值
---|---|---
Usg_Pak111_valid_vol|策略变量编号|111
用量层次|Usg_Pak111_valid_vol|Monitoring Key Subscriber
用量周期|Usg_Pak111_valid_vol|Month
用量类型|Usg_Pak111_valid_vol|Volume
套餐标识|Usg_Pak111_valid_vol|111
Monitoring Key列表|Usg_Pak111_valid_vol|1001
用量签约阈值（KByte）|Usg_Pak111_valid_vol|20480
Usg_Pak112_valid_vol|策略变量编号|112
用量层次|Usg_Pak112_valid_vol|Monitoring Key Subscriber
用量周期|Usg_Pak112_valid_vol|Month
用量类型|Usg_Pak112_valid_vol|Volume
套餐标识|Usg_Pak112_valid_vol|112
Monitoring Key列表|Usg_Pak112_valid_vol|1002
用量签约阈值（KByte）|Usg_Pak112_valid_vol|20480
配置规则条件 
条件名称|参数|取值
---|---|---
Cond_Pak111_valid_vol<Prof|选择策略变量|用量
策略变量类别|Cond_Pak111_valid_vol|总用量实际值
策略变量|Cond_Pak111_valid_vol|Usg_Pak111_valid_vol
操作符|Cond_Pak111_valid_vol|<
值类型|Cond_Pak111_valid_vol|策略变量
用量策略变量|Cond_Pak111_valid_vol|Usg_Pak111_valid_vol.Total Value
Cond_Pak112_valid_vol<Prof|选择策略变量|用量
策略变量类别|Cond_Pak112_valid_vol|总用量实际值
策略变量|Cond_Pak112_valid_vol|Usg_Pak112_valid_vol
操作符|Cond_Pak112_valid_vol|<
值类型|Cond_Pak112_valid_vol|策略变量
用量策略变量|Cond_Pak112_valid_vol|Usg_Pak112_valid_vol.Total Value
Cond_APPID_1001|选择策略变量|其他
策略变量类别|Cond_APPID_1001|IP-CAN会话信息类
策略变量|Cond_APPID_1001|Gx应用标识
操作符|Cond_APPID_1001|=
值类型|Cond_APPID_1001|值
值|Cond_APPID_1001|1001
Cond_APPID_1002|选择策略变量|其他
策略变量类别|Cond_APPID_1002|IP-CAN会话信息类
策略变量|Cond_APPID_1002|Gx应用标识
操作符|Cond_APPID_1002|=
值类型|Cond_APPID_1002|值
值|Cond_APPID_1002|1002

配置动作参数 
业务预下发动作参数： 
动作参数名称|参数|取值
---|---|---
Act_PreProvSvc_Prof|参数类型|预下发业务参数集
根据签约来决策预下发业务|Act_PreProvSvc_Prof|是
QoS动作参数集1： 
动作参数名称|参数|取值
---|---|---
action_qos1|动作参数类型|QoS参数集
QoS控制策略ID|action_qos1|qos1
5QI|action_qos1|9
最大上行带宽(kbps)|action_qos1|10240
最大下行带宽(kbps)|action_qos1|10240
QoS动作参数集2： 
动作参数名称|参数|取值
---|---|---
action_qos2|动作参数类型|QoS参数集
QoS控制策略ID|action_qos2|qos2
5QI|action_qos2|10
最大上行带宽(kbps)|action_qos2|5120
最大下行带宽(kbps)|action_qos2|5120
N7业务控制策略动作参数： 
动作参数名称|参数|取值
---|---|---
Act_Svc_taobao_1111|参数类型|N7 PCC规则参数集
PCC规则类型|Act_Svc_taobao_1111|动态规则
规则名|Act_Svc_taobao_1111|Svc_taobao_1111
QoS控制策略ID|Act_Svc_taobao_1111|action_qos1
Monitoring Key|Act_Svc_taobao_1111|1001
Act_Svc_jd_1111|参数类型|N7 PCC规则参数集
业务规则类型|Act_Svc_jd_1111|动态规则
规则名|Act_Svc_jd_1111|Svc_jd_111
QoS控制策略ID|Act_Svc_jd_1111|action_qos1
Monitoring Key|Act_Svc_jd_1111|1002
Act_Svc_taobao_Default|参数类型|N7 PCC规则参数集
业务规则类型|Act_Svc_taobao_Default|动态规则
规则名|Act_Svc_taobao_Default|Svc_taobao_Default
QoS控制策略ID|Act_Svc_taobao_Default|action_qos2
Monitoring Key|Act_Svc_taobao_Default|1001
Act_Svc_jd_Default|参数类型|N7 PCC规则参数集
业务规则类型|Act_Svc_jd_Default|动态规则
规则名|Act_Svc_jd_Default|Svc_jd_Default
QoS控制策略ID|Act_Svc_jd_Default|action_qos2
Monitoring Key|Act_Svc_jd_Default|1002
业务用量监控策略动作参数： 
动作参数名称|参数|取值
---|---|---
Act_MK_Svc_Fixed_10M|参数类型|业务用量监控参数集
流量门限控制方式|Act_MK_Svc_Fixed_10M|固定值
总流量门限(Kbps)|Act_MK_Svc_Fixed_10M|10240
配置规则 
N7业务控制策略： 
规则名称|参数|取值
---|---|---
Rule_Svc_taobao_Default|优先级|1
动作类型|Rule_Svc_taobao_Default|参数填充
日志开关|Rule_Svc_taobao_Default|关
条件表达式|Rule_Svc_taobao_Default|Cond_APPID_1001
动作参数名称|Rule_Svc_taobao_Default|Act_Svc_taobao_Default
Rule_Svc_jd_Default|优先级|1
动作类型|Rule_Svc_jd_Default|参数填充
日志开关|Rule_Svc_jd_Default|关
条件表达式|Rule_Svc_jd_Default|Cond_APPID_1002
动作参数名称|Rule_Svc_jd_Default|Act_Svc_jd_Default
Rule_Svc_taobao_1111|优先级|1
动作类型|Rule_Svc_taobao_1111|参数填充
日志开关|Rule_Svc_taobao_1111|关
条件表达式|Rule_Svc_taobao_1111|Cond_APPID_1001& Cond_Pak111_valid_vol<Prof
动作参数名称|Rule_Svc_taobao_1111|Act_Svc_taobao_1111
Rule_Svc_jd_1111|优先级|1
动作类型|Rule_Svc_jd_1111|参数填充
日志开关|Rule_Svc_jd_1111|关
条件表达式|Rule_Svc_jd_1111|Cond_APPID_1002& Cond_Pak112_valid_vol<Prof
动作参数名称|Rule_Svc_jd_1111|Act_Svc_jd_1111
业务用量监控策略： 
规则名称|参数|取值
---|---|---
Rule_MK_Svc_1|优先级|1
动作类型|Rule_MK_Svc_1|参数填充
日志开关|Rule_MK_Svc_1|关
条件表达式|Rule_MK_Svc_1|无
动作参数名称|Rule_MK_Svc_1|Act_MK_Svc_Fixed_10M
业务预下发控制策略： 
规则名称|参数|取值
---|---|---
Rule_PreProvSvc_Prof|优先级|1
动作类型|Rule_PreProvSvc_Prof|参数填充
日志开关|Rule_PreProvSvc_Prof|关
条件表达式|Rule_PreProvSvc_Prof|无
动作参数名称|Rule_PreProvSvc_Prof|Act_PreProvSvc_Prof

配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
QoS_Based_on_Pak1|入口|入口类型|用户信息类
已选入口|QoS_Based_on_Pak1|入口|业务套餐
取值|QoS_Based_on_Pak1|入口|1
策略类型|QoS_Based_on_Pak1|N7业务控制策略|Rule_Svc_taobao_Default
Rule_Svc_jd_Default|策略类型|QoS_Based_on_Pak1|N7业务控制策略
QoS_Based_on_Pak111|入口|入口类型|用户信息类
已选入口|QoS_Based_on_Pak111|入口|业务套餐
取值|QoS_Based_on_Pak111|入口|111
策略类型|QoS_Based_on_Pak111|N7业务控制策略|Rule_Svc_taobao_1111
业务用量监控策略|策略类型|QoS_Based_on_Pak111|Rule_MK_Svc_1
QoS_Based_on_Pak112|入口|入口类型|用户信息类
已选入口|QoS_Based_on_Pak112|入口|业务套餐
取值|QoS_Based_on_Pak112|入口|112
策略类型|QoS_Based_on_Pak112|N7业务控制策略|Rule_Svc_jd_1111
业务用量监控策略|策略类型|QoS_Based_on_Pak112|Rule_MK_Svc_1
Role_PreProvSvc|入口|入口类型|无
已选入口|Role_PreProvSvc|入口|无
取值|Role_PreProvSvc|入口|无
策略类型|Role_PreProvSvc|业务预下发控制策略|Rule_PreProvSvc_Prof
##### 测试用例 
测试条目|用户未知时的策略控制
---|---
预置条件|IMSI为136000000000000的用户在SPR没有放号。网管基本配置、规则配置已完成，参见“配置实例-用户未知时的策略控制”。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，IMSI为136000000000000。RCP向SMF发送Npcf_SMPolicyControl_Create Response。
通过准则|用户上线，从SPR获取签约失败，返回码为“用户未知”。RCP获取用户未知时的默认签约：默认套餐100。RCP根据默认签约、GUI配置策略，进行策略决策，通过Npcf_SMPolicyControl_Create Response下发会话AMBR上/下行速率均为128 Kbps。用户成功下线。
测试条目|SPR宕机时的策略控制
---|---
预置条件|IMSI为136000000000000的用户为PCC用户。网管基本配置、规则配置已完成，参见“配置实例-SPR宕机时的策略控制”。RCP与SPR之间的链路异常或SPR宕机。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，IMSI为136000000000000。RCP向SMF发送Npcf_SMPolicyControl_Create Response。
通过准则|用户上线，从SPR获取签约失败，等待Sp-UDA超时或收到链路异常通知。RCP获取SPR宕机时的默认签约：默认套餐101。RCP根据默认签约、GUI配置策略，进行策略决策，通过Npcf_SMPolicyControl_Create Response下发会话AMBR上/下行速率均为128 Kbps。用户成功下线。
测试条目|用户有签约且无有效套餐时的策略控制
---|---
预置条件|IMSI为136000000000000的用户为PCC用户，个性化签约中无有效套餐，用户类型为1。网管基本配置、规则配置已完成，参见“配置实例-用户有签约且无有效套餐时的策略控制”。RCP与SPR之间的链路正常。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，IMSI为136000000000000。RCP向SMF发送Npcf_SMPolicyControl_Create Response。
通过准则|用户上线，从SPR获取签约成功，用户类型为1，且无有效的个性化套餐。RCP获取获取UserType=1时的默认签约：默认套餐102。RCP根据默认签约、GUI配置策略，进行策略决策，通过Npcf_SMPolicyControl_Create Response下发会话AMBR上/下行速率均为128 Kbps。用户成功下线。
测试条目|特定时间段为所有用户免费提供多流量红包
---|---
预置条件|IMSI为136000000000000的用户为PCC用户，签约套餐1。网管基本配置、规则配置已完成，参见“配置实例-特定时间段为所有用户免费提供多个流量红包”。RCP与SPR之间的链路正常。动态用量存SPR的增量阈值设置为500 MB。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，IMSI为136000000000000。SMF上报MK1001的PCC Rule级用量200 MB。SMF上报MK1002的PCC Rule级用量200 MB。RCP向SMF发送Npcf_SMPolicyControl_Create Response。
通过准则|用户上线，从SPR获取签约成功，签约套餐1。RCP为其获取全局套餐111和112。Npcf_SMPolicyControl_Create Response下发策略：下发业务1001的策略：规则名Svc_taobao_1111，MK1001，最大上/下行带宽均为10 Mbps。下发业务1002的策略：规则名Svc_jd_1111，MK1002，最大上/下行带宽均为10 Mbps。下发MK1001和MK1002的PCC Rule级用量监控及订阅相关事件。SMF上报MK1001的PCC Rule级用量200 MB。RCP进行用量累计，Usg_Pak111_valid_vol的用量值为200 MB。RCP给SMF发消息，删除规则Svc_taobao_1111，重新安装业务1001的策略：规则名Svc_taobao_Default，MK1001，最大上/下行带宽均为5  Mbps。SMF上报MK1002的PCC Rule级用量200 MB。RCP进行用量累计，Usg_Pak112_valid_vol的用量值为200 MB。RCP给SMF发消息，删除规则Svc_jd_1111，重新安装业务1002的策略：规则名Svc_jd_Default，MK1002，最大上/下行带宽均为5 Mbps。用户成功下线。用户离线前会将用量同步到SPR。
### 缩略语 
### 缩略语 
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### PCC 
Policy and Charging Control计费和策略控制
#### RCP 
Resource Control Platform资源控制平台
#### SPR 
Subscription Profile Repository用户签约数据库
### ZUF-59-42-002 基于SPR签约的策略 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
签约信息（User profile information）|SPR中存储的用户签约信息，包括用户类型、签约的业务等。
##### 描述 
####### 定义 
基于SPR签约的策略是指RCP根据用户在SPR的签约信息进行决策，生成控制策略，实施个性化的服务和计费控制。
用户在SPR签约的信息如下： 
基本信息包含用户标识、SMS接收号码、Email地址、用户类型、用户起账日等。 
套餐信息一个用户可以同时签约多个套餐，套餐信息包含套餐标识、套餐有效期、套餐优先级、套餐Homezone等。当一个用户同时签约多个套餐时，RCP可以根据套餐优先级决定使用顺序。 
业务信息一个套餐可以对多个业务实施PCC控制，业务信息包含业务标识、业务等级、业务优先级等。一个用户的不同套餐可以控制相同业务，RCP可根据套餐中业务优先级决定该业务从属于哪个套餐。 
用户组信息一个用户可以加入多个用户组，每个用户组上可以签约多个群组套餐。 
用量阈值信息包含各种维度累计用量的实际值。 
####### 背景知识 
用户在运营商实体或网络营业厅开户并购买套餐等业务，生成用户的个性化签约，这些签约信息存储在SPR。 
PCC架构中RCP能够根据用户的个性化签约，为用户提供差异化的控制策略和服务，提升客户满意度。  
##### 应用场景 
RCP可以基于SPR签约信息做差异化的PCC策略控制。 
例如，根据用户类别（金、银、铜牌）、用户的付费类型（预付费、后付费）、用户选择的套餐，RCP可以根据这些签约项来为用户提供不同的QoS。
##### 客户收益 
收益方|收益描述
---|---
运营商|通过SPR签约实施个性化的策略控制。
终端用户|通过SPR签约选择适合自己的业务套餐。

##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newf94b96f5e374444e9ff8a019ac935351__26165978-71a5-4643-8968-c166c1ea34ad)所示。
图1  系统架构
[]images/image.png)
###### 各网元作用 
涉及的网元及其功能参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf0ca60caa2a14ff0adf6fe961b67581c__11a9e787-aa6d-4588-8dce-84d6518dc68b)。
网元|描述
---|---
RCP|根据用户个性化签约、会话状态等信息进行策略决策，将控制策略下发给PCEF/SMF/AMF。
SPR|用户签约数据库，存储了和策略控制与计费相关的用户策略计费控制签约信息。和RCP之间通过Sp和Sp'口相连，使用Diameter协议。
PCEF/SMF/AMF|向RCP请求控制策略，或上报会话的事件状态。
###### 业务流程 
参见“ZUF-59-41-002 Diameter Sp和Sp'接口
”中的业务流程。
###### 本网元实现 
RCP的网管中可配置套餐的基本信息，并从SPR获取个性化的签约数据，执行相关策略，保障用户QoS。 
 说明： 
当SPR异常时，可以使用默认签约的策略，为用户提供基本的QoS保障。有关默认签约参见“ZUF-59-42-001 基于默认签约的策略
”。
######## 用户在SPR个性化签约数据模型 
用户在SPR个性化签约数据模型如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newffece10ce2c549efb431c9d7de872bff__2f1b42a1-a626-4592-8ee7-563e59d7e084)所示。
图2  SPR签约个性化数据
[]images/1650250791059.png)
用户个性化签约数据描述参见[表2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newffece10ce2c549efb431c9d7de872bff__95b0b2b3-8d46-4e47-b06b-8df4f29a61c4)。
签约信息属性|签约信息|对应的Sp接口字段|用法描述
---|---|---|---
用户关键字类型|IMSI|Key-Type取值为1User-Name携带IMSI号码|用户的IMSI号码。
ISDN|用户关键字类型|Key-Type取值为2MSISDN|用户的ISDN号码。
PCCPI|用户关键字类型|Key-Type取值为4User-Name携带PCCPI号码|用户的CUI号码。
GROUPID|用户关键字类型|Group-Id|组号码。
用户签约信息|用户类型|User-Type|根据实际需要在SPR的web受理台下拉列表框中选择需要设置的用户类型。列表中的选项在SPR网管的用户类型配置（ADD SPRUSERTYPE）中设置。
IMEISV|用户签约信息|IMEISV|设置设备的IMEISV，可以实现IMSI和IMEI绑定功能。
计费类型|用户签约信息|Charging-Type|具体含义由RCP设置。例如，4表示预付费，8表示后付费。
用户起帐日|用户签约信息|Charging-Begin-Time|根据需要在下拉列表框中选择。列表选项：1~28、97~99。1~28，表示相应的日。97，表示每月倒数第三天。98，表示每月倒数第二天。99，表示每月倒数第一天。
用户业务状态|用户签约信息|UserStatus|用户配额状态的取值。取值范围：0~ 255。0~254：允许上网业务。255： 暂停上网业务。缺省值1。
用户归属地编码|用户签约信息|HomeZone-Info|十进制数字，取值范围0~12。
用户SIM卡类型|用户签约信息|Card-Type|取值范围：0~ 4294967294。0表示没有签约该字段。
用户清零周期|用户签约信息|ResetPeriod|格式为：minute$hour$day-of-month$month$day-of-week分钟：[0,59]小时：[0,23]天数：[0,28]以及97、98、990：在RCP系统中的含义和1相同。97：每月倒数第3天。98：每月倒数第2天。99：每月倒数第1天。月份：[1,12]星期：[0,6]0：代表周日。使用说明：日用量：按照ResetPeriod中的minute$hour来清零。如无，按照网管配置套餐清零时刻清零。月用量：按照ResetPeriod中的minute$hour$day-of-month来清零。如无，minute$hour取RCP网管配置套餐清零时刻清零，day-of-month取Charging-Begin-Time。周用量：按照ResetPeriod中的minute$hour$day-of-week来清零。如无，minute$hour取RCP网管配置套餐清零时刻清零，day-of-week取RCP网管配置套餐周清空时间清零。N天用量：清零当天的清零时刻按照ResetPeriod中的minute$hour来清零。如无，minute$hour取RCP网管配置套餐清零时刻清零。套餐、业务的用量：首先取Package-Profile-Info中的ResetPeriod，没有再取用户层的ResetPeriod。
短信通知MSISDN|用户签约信息|Subscription-IdSubscription-Id-Type：0（END_USER_E164）Subscription-Id-Data：短信通知MSISDN号码|用户接收短信通知的MSISDN号码。
Email|用户签约信息|Email-Addr|用户Email地址。多个Email地址之间用“|”符号分隔。
名|用户签约信息|UserInfo-Type：GivenNamesUserInfo-Value：名的取值|姓名的名部分。
姓|用户签约信息|UserInfo-Type：FamilyNameUserInfo-Value：姓的取值|姓名的姓部分。
性别|用户签约信息|UserInfo-Type：GenderUserInfo-Value：性别的取值|UserInfo-Value，枚举值。0：Unknown1：Male2：Female3：Other不带时，系统默认为0。
出生日期|用户签约信息|UserInfo-Type：BirthdayUserInfo-Value：yyyymmdd|UserInfo-Value格式数字串yyyymmdd。 yyyy为0-9的数字串。mm为01-12，dd为01-31。注：系统不检查是否为真实有效的日期，仅检查格式是否正确。
语言|用户签约信息|UserInfo-Type：LanguageUserInfo-Value：语言的取值|UserInfo-Value （区分大小写）为枚举字符串，定义如下：en：English英语zh-cn：Chinese(PRC) 中文（中华人民共和国）zh-hk：Chinese(Hong Kong PRC) 中文（中国香港特别行政区）zh-sg：Chinese(Singapore) 中文（新加坡）zh-tw：Chinese(Taiwan Region) 中文（中国台湾）ms：Malay马来语tl：Tagalog菲律宾语id：Indonesian印度尼西亚vi：Vietnamese越南语pt：Portuguese葡萄牙语取值请参考SPR网管配置：SPR全局业务配置→SPR习惯语言配置中的语言代码字段。
通知方式|用户签约信息|Prefer-Notify-Method|接收通知的方式。按位表示，从最低位开始，第1位的1表示SMS，第2位的1表示Email。组合之后：0：No notification1：SMS2：Email3：Email and SMS
开放通知事件|用户签约信息|Open-Notification-ID-InfoNotification-ID|用户订阅的通知ID。RCP中会定义所有此用户适用的通知ID，这些适用的短信中，有一部分属于用户默认通知的ID。用户适用的短信ID、默认通知的ID和此AVP之间的关系：当前用户应该需要决策是否需要发送的通知为：（（默认通知的短信ID）∪（OpenNotificationId-Info））∩（用户适用的通知ID）。例如：RCP中针对此用户配置了可以发送编号为1、2、3、4的通知，默认发送编号为1、2的通知；此AVP为3、5，那对此用户，最终可能发送的通知为：1、 2、 3。
关闭通知事件|用户签约信息|Close-Notification-ID-InfoNotification-ID|如果SPR中签约了此字段，则RCP对此字段中的通知ID不进行决策。继续上面的例子。如果此字段有通知ID3，则对通知ID为3不进行决策。所以，如果带了此AVP之后，修正上面的决策内容为：（（默认通知的ID）∪（OpenNotificationId-Info））∩（用户适用的通知ID）－（（CloseNotificationId-Info）∩（用户适用的通知ID））。
扩展属性|用户签约信息|Extended-Attribute :{ Extended-Attribute-Name}{ Extended-Attribute-Type}{ Extended-Attribute-Len}{ Extended-Attribute-Value}|用户或者套餐的各种扩展信息。当组（套餐）和用户（套餐）重复的时候，扩展属性取合集。当扩展属性Name字段一致时，取用户（套餐）的。一个User-Profile-Info中最多携带8个Extended-Attribute，Extended-Attribute中的Extended-Attribute-Name不能相同。
打折用量|用户签约信息|Usage-Discount-Record:{Discount-Usage-Type}[Discount-Usage-Value][Discount-Usage-Value-UINT64][Valid-Time]|使用ID方式表示的签约打折记录。针对ID表示的用量不同，其单位也不同。时长单位：分钟，流量单位：K字节，点击次数单位：次。说明：一个Usage-Limit-Info中最多16个Usage-Limit-Record、16个Usage-Discount-Record、16个Usage-Rollover-Record。一个用户签约的用ID标识的用量签约记录总数不能超过32个。不同来源、相同枚举值的签约记录作为不同的签约记录，32个里面包括Usage-Limit-Record 、Usage-Discount-Record、 Usage-Rollover-Record。同一个Usage-Limit-Info下面的Usage-Limit-Record中用量ID不能重复。
转移用量|用户签约信息|Usage-Rollover-Record:{Rollover-Usage-Type}[Rollover-Usage-Value][Rollover-Usage-Value-UINT64][Valid-Time]|使用ID方式表示的用量的返还记录。针对ID表示的用量不同，单位不同。时长单位：分钟，流量单位：K字节，点击次数单位：次。说明：一个Usage-Limit-Info中最多16个Usage-Limit-Record、16个Usage-Discount-Record、16个Usage-Rollover-Record。
个性签约阈值|用户签约信息|Usage-Limit-Record:{Usage-Type}[Usage-Value][Usage-Value-UINT64]|使用ID方式表示的用量的签约信息。针对ID表示的用量不同，单位不同。时长单位：分钟，流量单位：K字节，点击次数单位：次。
HomeZone|用户签约信息|HomeZone-Info :[HomeZone-Info-Type]*[HomeZone-Info-Value]|HomeZone的定义。一个HomeZone-Info中最多携带8个HomeZone-Area-Value。HomeZone-Area-Value取值重复的时候，当做1个进行处理。type：表示位置区的类型。有如下取值：0：CGI，由MCC、MNC、LAC、CI组成。1：SAI，由MCC、MNC、LAC、SAC组成。2：RAI，MCC、MNC、LAC、RAC组成。128：TAI，由MCC、MNC、TAC组成。129：ECGI，由MCC、MNC、ECI组成。130：TAI+ECGI，由MCC、MNC、TAC、ECI组成。value：type对应的位置区的具体编号，十进制数字字符串，长度范围10-20之间。MCC：长度为3的十进制数字。MNC：长度为2或3的十进制数字。LAC：取值范围为0～65535的十进制数，当长度不足5位时，需要在数字前面补0确保位数为5位。CI/SAC/RAC/TAC：长度为1～5的十进制数字，当长度不足5位时，需要在数字前面补0确保位数为5位。ECI：长度为1～9的十进制数字，当长度不足9位时，需要在数字前面补0确保位数为9位。“-”：type与value之间的连接符。“,”：多个type-value段间的连接符，当要表达多个type-value段时，必须使用“,”进行连接。例如：0-123456789100001,1-123456789100009。
附加属性|用户签约信息|Additional-Attribute :{Additional-Attribute-ID}[Valid-Time] :Valid-Time-BeginValid-Time-End|用户或者套餐的各种附加信息。Additional-Attribute-ID：各类附加信息的ID。数字类型，取值范围1~65535。Valid-Time：各类附加信息的有效期范围，如果不携带表示一直有效。说明：一个User-Profile-Info中最多带4个Additional-Attribute。一个User-Profile-Info中多个Additional-Attribute下的Additional-Attribute-ID不能相同。
用户归属的组|用户签约信息|Group-Info ：{Group-Id}[Master-Flag] [User-Begin-Join-Group-time]|用户所属的组信息。一个组最多分布在16个RCP中。Group-Id：组ID。一个用户最多属于4个组。Master-Flag：用户是否是组长的标记。0：非组长1：组长2~255：运营商自定义角色特殊说明： 默认用户非组长。一个组内建议最多签约7种角色。User-Begin-Join-Group-time：用户加入组的时间Zte-time类型，从2000年开始的秒数，UTC时间。特殊说明：当SPR携带了此字段之后，RCP在SP'接口中存放到SPR中的所有组数据有效性的判断，都需要加上对这个字段的判断。在这个时间之前存放在SPR中的内容都要删除。
网络类型|用户签约信息|networkType|1：5G网络0：2G/3G/4G网络
套餐|套餐ID|Package-ID|套餐ID。UTF8String类型，最大长度32字节。用户签约如果只签约套餐ID，没有携带个性化的套餐详细信息，就表示用户签约了这个套餐，且套餐内容和套餐公共签约信息一致。如果携带了个性化套餐签约信息，就表示用户签约了这个套餐，且用户个性化套餐信息覆盖套餐公共签约信息后的内容是用户签约套餐的完整签约内容。说明：在Package-Profile-Info中PackageId必带。同一个用户的签约中，PackageID不能重复。
套餐默认等级|套餐|Service-Class|套餐内业务的默认等级。数字类型，数字越大代表优先级越高。当Si-Profile-Info业务等级没携带，就取套餐的默认业务等级。
套餐优先等级|套餐|Priority|套餐/业务优先级， 数字越大代表优先级越高。
套餐开始时间|套餐|Valid-Time-Begin|有效期开始时间。zte-time 类型。DWORD 值，从2000年到现在的秒数，UTC时间。不带表示在有效期结束前一直有效。说明：对于按激活时间起计算有效期的套餐，有效期开始时间为SPR计算后的实际有效期开始时间。
套餐结束时间|套餐|Valid-Time-End|有效期结束时间。zte-time 类型。DWORD值，从2000年到现在的秒数，UTC时间。不带表示在生效后一直有效。说明：如果同时携带Valid-Time-End和Valid-Time-Begin，Valid-Time-End必须大于Valid-Time-Begin。对于按激活时间起计算有效期的套餐，有效期结束时间为SPR计算后的实际有效期结束时间。
套餐扩展属性|套餐|Package-Profile-Info :{Package-ID}Extended-Attribute :Extended-Attribute-NameExtended-Attribute-TypeExtended-Attribute-LenExtended-Attribute-Value|套餐的各种扩展信息。当组（套餐）和用户（套餐）重复的时候，扩展属性取合集。当扩展属性Name字段一致时，取用（套餐）中的。说明：一个User-Profile-Info中最多携带8个Extended-Attribute。Extended-Attribute中的Extended-Attribute-Name不能相同。
套餐打折用量|套餐|Package-Profile-Info :{Package-ID}Profile-Limit-Discount :[Time-Limit-Amend-Record]*[Volume-Limit-Amend-Record]*[Count-Limit-Amend-Record]|用量打折后的阀值信息。例如，用户有首月用量打折的需求时。首月打折之后的用量阀值，可以用此AVP传送过来。Time-Limit-Amend-Record：时长打折记录。可以带多个，最多6个，签约类型不能重复。Volume-Limit-Amend-Record：流量打折记录。可以带多个，最多6个，签约类型不能重复Count-Limit-Amend-Record：次数打折记录。可以带多个，最多6个，签约类型不能重复。
套餐转移用量|套餐|Package-Profile-Info {Package-ID}[Profile-Limit-Rollover]:*[Time-Limit-Rollover-Record]*[Volume-Limit-Rollover-Record]*[Count-Limit-Rollover-Record]|转移用量信息。Time-Limit-Rollover-Record：时长返还记录。可以带多个，最多6个，签约类型不能重复。Volume-Limit-Rollover-Record：流量返还记录。可以带多个，最多6个，签约类型不能重复。Count-Limit-Rollove-Record：次数返还记录。可以带多个，最多6个，签约类型不能重复。说明：对于套餐的同一个阀值Profile-Limit-Discount、Profile-Limit-Rollover、Profile-Limit 3组AVP的关系：最终的阀值 = 基础阀值 + Rollover阀值。基础阀值的获取方式如果有Profile-Limit-Discount，并且携带的阀值有效，则基础阀值取Profile-Limit-Discount中携带的阀值。如果携带的阀值不在有效期内容，或者未携带，则取Profile-Limit中的内容*Package-Purchase-Count。如果Profile-Limit也没有，则取RCP中配置的阀值*Package-Purchase-Count。Rollover阀值的获取方式如果Profile-Limit-Rollover有携带阀值，并且阀值在有效期，则Rollover阀值为Profile-Limit-Rollover中携带的值，否则为0。如果获取的非套餐和套餐下面的业务阀值，则Package-Purchase-Count按1计算。
套餐HomeZone|套餐|Package-Profile-Info :{Package-ID}[HomeZone-Info]|HomeZone的定义。一个HomeZone-Info中最多携带8个HomeZone-Area-Value。HomeZone-Area-Value取值重复的时候，按照正常处理。type：表示位置区的类型。0：CGI，由MCC、MNC、LAC、CI组成。1：SAI，由MCC、MNC、LAC、SAC组成。2：RAI，MCC、MNC、LAC、RAC组成。128：TAI，由MCC、MNC、TAC组成。129：ECGI，由MCC、MNC、ECI组成。130：TAI+ECGI，由MCC、MNC、TAC、ECI组成。value：type对应的位置区的具体编号，十进制数字字符串，长度范围10-20之间。MCC：长度为3的十进制数字。MNC：长度为2或3的十进制数字。LAC：取值范围为0～65535的十进制数，当长度不足5位时，需要在数字前面补0确保位数为5位。CI/SAC/RAC/TAC：长度为1～5的十进制数字，当长度不足5位时，需要在数字前面补0确保位数为5位。ECI：长度为1～9的十进制数字，当长度不足9位时，需要在数字前面补0确保位数为9位。“-”：type与value之间的连接符。“,”：多个type-value段间的连接符，当要表达多个type-value段时，必须使用“,”进行连接。例如：0-123456789100001,1-123456789100009。
套餐下的个性签约阈值|套餐|Package-Profile-Info :{Package-ID}[Profile-Limit]:*[ Time-Limit-Record]*[ Volume-Limit-Record]*[ Count-Limit-Record]|Profile-Limit中存放的是用枚举格式表示的用量的签约记录。Profile-Limit放在User-Profile-Info中表示用户级用量签约限制。Profile-Limit放在Package- Profile-Info中表示套餐级用量签约限制。Profile-Limit放在SI- Profile-Info中表示套餐SI级用量签约限制。特殊说明：一个用户签约的用枚举方式表示的签约记录总数不能超过32个。例如：同一个套餐中Profile-Limit-Discount有Type1，Profile-Limit有Type1，算2个。一个Profile-Limit中最多6个Time-Limit-Record，最多6个Volume-Limit-Record，最多6个Count-Limit-Record。一个Profile-Limit中的信息，用量的枚举类型不能重复。
套餐下的业务|套餐|Package-Profile-Info {Package-ID}*[Si-Profile-Info]|业务ID，SI=“9999”时，表示任意业务。一个套餐内携带的SI信息不能相同。
业务|业务ID|Spr-Si|业务ID, SI=“9999”时，表示任意业务。
业务等级|业务|Si-Profile-Info ::= < AVP Header:XXX>{Spr-Si}[Service-Class]|业务等级。数字类型，数字越大代表优先级越高。Package-Profile-Info中的Service-Class表示套餐内业务的默认等级。当Si-Profile-Info业务等级没携带，就取上层套餐的默认业务等级。
业务优先级|业务|Si-Profile-Info :{Spr-Si}[Priority]|套餐/业务优先级，数字越大代表优先级越高。
业务开始时间|业务|Si-Profile-Info :{Spr-Si}[Valid-Time]:[Valid-Time-Begin]|有效期开始时间，不带表示在有效期结束前一直有效。zte-time 类型。DWORD 值，从2000年到现在的秒数,UTC时间。
业务结束时间|业务|Si-Profile-Info :{Spr-Si}[Valid-Time]:[Valid-Time-End]|有效期结束时间。不带表示在生效后一直有效。zte-time 类型。DWORD值，从2000年到现在的秒数,UTC时间。
业务下的个性签约阈值|业务|Si-Profile-Info{Spr-Si}[Profile-Limit]:*[ Time-Limit-Record]*[ Volume-Limit-Record]*[ Count-Limit-Record]|Profile-Limit中存放的是用枚举格式表示的用量的签约记录。Profile-Limit放在User-Profile-Info中表示用户级用量签约限制。Profile-Limit放在Package- Profile-Info中表示套餐级用量签约限制。Profile-Limit放在SI- Profile-Info中表示套餐SI级用量签约限制。说明：一个用户签约的用枚举方式表示的签约记录总数不能超过32个。例如，同一个套餐中Profile-Limit-Discount有Type1，Profile-Limit有Type1，算2个。一个Profile-Limit中最多6个Time-Limit-Record，最多6个Volume-Limit-Record，最多6个Count-Limit-Record。一个Profile-Limit中的信息，用量的枚举类型不能重复。
######## SPR签约数据的管理 
SPR提供用户和个性化签约信息管理，主要包括对用户与用户所签约业务之间关系的管理，具体操作包括且不限于：对用户进行开户、销户、修改、查询、签约等操作。 
######## SPR签约数据的应用 
用户签约数据用于IP-CAN会话的策略决策，从而为用户请求的业务提供差异化的服务。 
在RCP进行策略决策过程中，首先是用户个性化签约数据，其次是默认数据。 
例如，以优先级为例，用户签约一个套餐，从SPR处获取到了套餐优先级信息，系统中也配置了套餐的优先级信息，在进行策略决策时，首选用户签约（SPR获取）的套餐优先级信息。 
######## RCP冷备场景下用户多会话汇聚 
RCP冷备组Pool场景中，RCP之间数据不备份，并且RCP不部署CGW，多RCP之间无数据交互。
为了实现一个用户的多个会话能存储到一个RCP中，采用重定向的方式来实现多会话汇聚。 
涉及的流程如下： 
用户上线流程
SMF发送会话建立请求消息给RCP。 
RCP判断此会话为该用户的第一个会话，触发用户上线流程。 
RCP判断打开了SPR汇聚功能开关，发送的UDR消息中会携带Session-Aggregation-Flag为1，并设置FLAG位为用户上线。 
如果SPR判断没有Master RCP局向号，则SPR记录UDR消息中携带的Master RCP局向号并返回成功。 
如果SPR判断已有Master RCP局向号，并且和UDR消息中携带的一致，则SPR返回成功。 
如果SPR判断已有Master RCP局向号，但是和UDR消息中携带的不一致，则SPR的响应中Result_Code返回特定失败码5003，并携带Master RCP主机名。 
如果SPR返回了成功，则对签约信息进行保存，用于规则决策，并向SMF发送会话建立响应信息。 
如果SPR返回了5003并携带了Master RCP主机名，RCP判断返回的Master RCP状态正常，则发送重定向到Master RCP的响应消息给SMF，SMF重新与Master RCP主机建立连接。 
如果SPR返回了5003并携带了Master RCP主机名，RCP判断返回的Master RCP状态异常或者本局未配置该RCP的信息，RCP发送携带FLAG位设置为上线并且是强制更新局向的UDR消息，等待UDA响应。 
如果SPR返回成功的UDA消息，则对签约信息进行保存，用于规则决策，并向SMF发送会话建立响应信息。 
如果SPR返回的是失败的UDA消息或者未收到UDA消息，导致用户上线失败，向SMF返回失败的CCA消息。 
用量上报流程
SMF发送会话用量上报请求消息给RCP。 
RCP判断超过SPR用量上报阈值，发起用量上报流程。 
RCP判断打开了SPR汇聚功能开关，则发送上报用量的SP'-UDR消息，并携带Session-Aggregation-Flag为1。 
如果SPR判断已有Master RCP局向号，并且和UDR消息中携带的一样，则SPR累计用量并返回成功。 
如果SPR判断已有Master RCP局向号，但是和UDR消息中携带的不一样，则SPR不累计用量，响应中Result_Code返回特定失败码5003，并且携带Master RCP主机名。 
如果SPR判断没有Master RCP局向号，则SPR不累计用量，响应中Result_Code返回特定失败码5003，并且不携带Master RCP主机名。 
如果SPR返回了成功，RCP处理响应消息，结束用量上报流程。 
如果SPR返回5003，RCP处理响应消息，结束用量上报流程，并触发本局该用户所有会话的释放流程。 
如果SPR返回其他失败或未返回响应，RCP结束本次用量上报流程，但不会释放会话。 
用户离线流程
SMF发送会话释放请求消息给RCP。 
RCP判断此会话为该用户的最后一个会话，触发用户释放流程。 
RCP判断打开了SPR汇聚功能开关，则发送SP'-UDR消息，并且携带当前未上报的用量。 
如果SPR判断已有Master RCP局向号，并且和UDR消息中携带的一样，则SPR累计用量并返回成功。 
如果SPR判断已有Master RCP局向号，但是和UDR消息中携带的不一样，则SPR不累计用量，响应中Result_Code返回特定失败码5003，并携带已有的Master RCP主机名。 
如果SPR判断没有Master RCP局向号，则SPR不累计用量，响应中Result_Code返回特定失败码5003，并且不携带Master RCP主机名。 
如果SPR返回了成功，处理响应消息，结束用量上报流程并发送下线的UDR消息给SPR。 
如果SPR返回5003失败，RCP跳过与SPR的用户离线消息交互流程，直接完成用户下线。 
######## 策略条件、策略动作可通过扩展属性灵活配置 
用户签约数据中的扩展属性可在策略条件、策略动作中灵活使用。 
在ToB物联网场景中，会存在同一类业务可能涉及几百甚至几千数量的企业需要使用，且不同企业的策略参数是需要区分的。为了减少套餐配置数量、避免套餐容量快速达到容量上限，可通过以套餐扩展属性作为策略条件、策略动作的配置方式来实现。 
例如，对于同一类ToB业务，可以仅配置一个套餐，不同企业策略参数（条件和动作）的区分通过扩展属性变量实现。这样既可解决ToB物联网场景中的套餐容量受限问题，同时ZXUN RCP的配置也更加灵活。
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
相关特性|交互关系
---|---
FL-01-01-009 Diameter链路及路由|与Diameter路由特性相关。SPR和RCP的Sp/Sp'接口消息是Diameter消息。
ZUF-59-41-002 Diameter Sp/Sp'接口|RCP通过Sp/Sp'接口从SPR获取签约和用量相关信息，如套餐相关的特性、用量特性等。
##### 遵循标准 
本特性采用中兴通讯内部的接口和协议，不涉及标准协议。 
##### 特性能力 
名称|指标
---|---
每个用户可签约的套餐个数|50
整局可配置的套餐个数|套餐容量License控制
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
02|V7.23.10|新增组合套餐场景的优先级和套餐类型（用户套餐，用户可用套餐，业务套餐）选择使用的原则说明。新增策略条件、策略动作可通过扩展属性灵活组合配置特性说明。
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
但是套餐是本特性的一个重要元素，本特性涉及到套餐基本信息配置，其容量由License控制。 
####### 对其他网元的要求 
基于SPR签约的策略特性需要RCP网元配合实现，其中RCP需要和SPR共同配合达到对某一个性化签约属性的策略控制。 

##### O&M相关 

###### 配置命令 
######## 网管命令 
命令项|命令名称|描述
---|---|---
套餐基本配置|ADD PKGINFO|新增套餐基本配置。
SET PKGINFO|套餐基本配置|修改套餐基本配置。
DEL PKGINFO|套餐基本配置|删除套餐基本配置。
SHOW PKGINFO|套餐基本配置|查询套餐基本配置。
套餐选择方式配置|ADD PKGSEL|新增套餐选择方式配置。
SET PKGSEL|套餐选择方式配置|修改套餐选择方式配置。
DEL PKGSEL|套餐选择方式配置|删除套餐选择方式配置。
SHOW PKGSEL|套餐选择方式配置|查询套餐选择方式配置。
######## GUI配置 
GUI配置中的策略变量参见[表3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new6239437d700942a3abdc0424d3e06e16__984546b5-2b58-4d07-9a95-a93014b0000d)。
策略变量类别|字段名称|描述
---|---|---
用户信息类|用户类型|该策略变量表示用户签约的用户类型。RCP从SPR发送的用户签约UDA或PNR消息的User-Type中取值。如果从SPR发送的消息中未获取到用户类型，那么RCP从通过ADD DEFSPRINFO配置的默认签约信息中获取用户类型。例如，用户类型为：金牌用户、银牌用户、铜牌用户，根据用户类型，下发不同的策略，分配不同的流量。
卡类型|用户信息类|该策略变量表示用户签约的卡类型。RCP从SPR发送的用户签约UDA或PNR消息的Card-Type中取值。
付费类型|用户信息类|该策略变量表示用户签约的付费类型。RCP从SPR发送的用户签约UDA或PNR消息的Charging-Type中取值。付费类型有：预付费和后付费。
用户套餐|用户信息类|当该策略变量被“通知策略”、“套餐动态优先级策略”、”套餐预定义策略“引用时，该业务键退化为可用套餐（套餐属性必须是用户套餐）进行使用。当该策略变量作为其它策略决策如会话决策或业务决策等的条件业务键时，表示当前会话生效的用户套餐。如果用户下有多个用户套餐并且可用，则系统会从其中选择一个作为当前会话生效的用户套餐。用户套餐来源用户在SPR个性化签约的套餐、组套餐、全局套餐、默认套餐，并且套餐属性（套餐基本配置表中“套餐属性”字段）必须为用户套餐。用户套餐选择逻辑若用户下有多个用户套餐并且可用时，通过以下方式进行筛选：选择优先级最高的套餐。若优先级最高的套餐有多个，优先选择最先失效的套餐。若还是选出了多个套餐，则随机选取一个套餐。用户套餐优先级来源针对每一个套餐，其优先级有多个来源（个性化签约、本地配置、套餐动态优先级），套餐自身的优先级最终取自哪个来源。优先级获取逻辑获取套餐签约个性化优先级。如果未签个性化优先级，则取套餐动态优先级规则决策输出的动态优先级。如果动态优先级也不存在，则取套餐网管公共配置中的优先级。其中，当套餐动态优先级决策输出的结果为套餐“失效”，则该套餐是不可用套餐，不会参与用户套餐的选择。
用户状态|用户信息类|该策略变量表示用户的配额状态。RCP从SPR发送的用户签约UDA或PNR消息的UserStatus或UserStatus-Amend-Record中取值。如果用户签约的UDA或PNR消息中携带UserStatus-Amend-Record，并且RCP系统时间在子AVP Valid-Time指定的时间段内，则该策略变量值取自子AVP UserStatus-Amend-Value。如果用户签约的UDA或PNR消息中没有携带UserStatus-Amend-Record，或者RCP系统时间不在Valid-Time指定的时间段内，则该策略变量值取自UserStatus。如：允许上网业务，暂停上网业务
用户性别|用户信息类|该策略变量表示用户的性别。RCP从SPR发送的用户签约UDA或PNR消息的UserInfo中取值。当UserInfo的子AVP UserInfo-Type取值为3时表示用户性别，该策略变量值取自UserInfo-Value。
用户语言|用户信息类|该策略变量表示用户的语言。RCP从SPR发送的用户签约UDA或PNR 消息的UserInfo中取值， 当UserInfo的子AVP UserInfo-Type取值为4时表示用户语言，该策略变量值取自UserInfo-Value。取值为英语，则对英语的用户下发策略。
用户级HomeZone状态标识|用户信息类|该策略变量表示用户的接入位置是否在用户级HomeZone区域内。RCP从SPR发送的用户签约UDA或PNR消息的HomeZone-Info中获取用户级HomeZone区域。
用户套餐级HomeZone状态标识|用户信息类|该策略变量表示用户的接入位置是否在当前IP-CAN会话的用户套餐的HomeZone区域内。RCP从SPR发送的用户签约UDA或PNR消息的Package-Profile-Info中的HomeZone-Info中获取套餐级HomeZone区域。如果套餐的签约信息下没有携带，那么RCP从ADD PKGINFO配置中获取。
业务套餐级HomeZone状态标识|用户信息类|该策略变量表示用户的接入位置是否在用户使用的受控业务的业务套餐的HomeZone区域内。RCP从SPR发送的用户签约UDA或PNR消息的Package-Profile-Info中的HomeZone-Info中获取套餐级HomeZone区域。如果套餐的签约信息下没有携带，那么RCP从ADD PKGINFO配置中获取。
用户生日状态标识|用户信息类|该策略变量表示当前日期是否是用户的生日。RCP从SPR发送的用户签约UDA或PNR消息中的UserInfo中获取用户生日。当UserInfo的子AVP UserInfo-Type取值为5时，子AVP UserInfo-Value表示用户的生日。RCP判断当前日期是否为用户的生日。
用户计费方式|用户信息类|该策略变量表示用户的计费方式。RCP从SPR发送的用户签约UDA或 PNR消息的User-Billing-Type中取值。
用户套餐级计费方式|用户信息类|该策略变量表示当前IP-CAN会话的用户套餐的计费方式。RCP从SPR发送的用户签约UDA或PNR消息的Package-Profile-Info中的Service-Billing-Type取值。
用户可用套餐|用户信息类|该策略变量表示该套餐是否属于用户当前会话中可用的套餐，一个会话可以同时有多个可用套餐。用户的套餐获取来源包括：RCP从SPR发送的用户（组）签约UDA或PNR消息的Package-ID中取值得到用户签约的套餐信息；从全局套餐配置表中得到的套餐信息；从默认签约信息配置表中得到的套餐信息。在获取到所有套餐后，通过以下可用性条件进行筛选：（必选）套餐是否有效，包括flag是否有效、是否在有效期内等。（可选）套餐是否匹配，包括homezone接入区域、NAI组和APN。（可选）套餐用量是否超过签约阀值。（可选）套餐动态优先级决策出套餐无效。
业务套餐|用户信息类|当该策略变量被“通知策略”、“套餐动态优先级策略”、”套餐预定义策略“引用时，该业务键退化为可用套餐（套餐属性必须是业务套餐）进行使用。当该策略变量作为其它业务级策略决策（如“N7业务控制策略”）的条件业务键时，该策略变量是针对当前业务级决策的某个业务（appid）来说，表示从用户可用套餐中选出该业务（appid）正在使用的套餐（查找路径：appid ->si->pak，三者关系是1：N：N）。一个业务可以同时被多个套餐签约，但每个业务同一时间最多能选中一个生效的套餐。业务套餐来源用户在SPR个性化签约的套餐、组套餐、全局套餐、默认套餐，只要这些套餐都签了该业务，则都属于该业务选择当前生效的业务套餐的可供选择范围。业务套餐选择逻辑若该业务属于多个套餐并且可用时，通过以下方式进行筛选：选择优先级最高的套餐。若优先级最高的套餐有多个，优先选择最先失效的套餐。若还是选出了多个套餐，则随机选取一个套餐。业务套餐优先级获取逻辑针对该业务所属的每一个套餐，在选择其当前生效的业务套餐时，每个套餐的优先级有多个来源。每个套餐的优先级的获取逻辑：取该SI签约的个性化优先级。若SI未携带优先级，则取套餐签约个性化优先级。若未签约个性化优先级，则取套餐动态优先级决策输出的动态优先级。若动态优先级不存在，则取业务网管公共配置中的优先级。若业务网管公共配置未配置优先级，则取套餐网管公共配置中的优先级。
业务计费方式|用户信息类|该策略变量表示用户使用的受控业务所属的业务套餐的计费方式。RCP从SPR发送的用户签约UDA或PNR消息的Package-Profile-Info中的Service-Billing-Type取值。如：在线计费，离线计费。
用户订购的套餐类别|用户信息类|该策略变量表示用户订购的套餐类别。RCP从SPR发送的UDA或PNR消息的Extended-Attribute中取值。 当Extended-Attribute的子AVP Extended-Attribute-Name为SubscribePackageType时，该策略变量值取自Extended-Attribute-Value。
业务等级|用户信息类|该策略变量表示受控业务对应的签约业务对应的等级。数值越大表示等级越高。RCP从SPR发送的UDA或PNR消息的Service-Class中取值。如果消息中未携带，那么RCP从ADD PKGINFO配置中的套餐内的默认的业务等级取值。
MSISDN|用户信息类|该策略变量表示用户的MSISDN。从用户签约UDA或PNR消息中的MSISDN获取。当CCR消息中的Subscription-Id-Type为2时，从Subscription-Id-Data获取。
归属用户组HomeZone状态标识|用户信息类|该策略变量表示是否在生效的用户组的HomeZone区域内。 组HomeZone来源：组签约的组用户层HomeZone，从SPR发给RCP的查询组签约SP-UDA响应或SP-PNR组签约推送消息的HomeZone-Info中获取。
归属业务组HomeZone状态标识|用户信息类|该策略变量表示是否在生效的业务组的HomeZone区域内。 组HomeZone来源：组签约的组用户层HomeZone，从SPR发给RCP的查询组签约SP-UDA响应或SP-PNR组签约推送消息的HomeZone-Info中获取。
动作参数参见[表4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new6239437d700942a3abdc0424d3e06e16__e88b4606-7440-4145-b61e-7b4d48040658)。
参数集|字段名称|描述
---|---|---
套餐动态属性参数集|套餐动态优先级|当用户签约中没有携带套餐优先级时，RCP网元以该参数作为当前套餐的优先级。套餐优先级的取值顺序为： SPR携带的用户签约的套餐个性化优先级，从UDA或PNR消息的Package_Profile_Info的Priority获取。 若1中的优先级没有获取到，那么RCP使用此参数指定的动态优先级。 若1和2中的优先级都没有获取到，那么RCP使用SHOW PKGINFO中配置的全局优先级。
会话参数集|在线计费地址决策方式|该参数用于向RCP网元指定在线计费地址的决策方式。签约PCF/SCF本地计费地址优先若SPR通过Sp接口返回签约PCF-ID或SCF-ID，则根据PCF-ID（作为ARP-ID）或SCF-ID（作为ARP-ID）查找计费中心配置（命令SHOW CCCFG）。PCF-ID查询到的计费中心URI地址参数，作为首选在线计费地址。SCF-ID查询到的计费中心URI地址参数，作为备选在线计费地址。签约ARP漫游计费地址优先若SPR通过Sp接口返回用户签约ARP-ID，且ARP-ID已生效，则根据ARP-ID查找计费中心配置（命令SHOW CCCFG），计费中心URI地址参数就作为首选在线计费地址，备选无。若没有查询到，SPR还返回了PCF-ID或SCF-ID，则按照签约PCF/SCF本地计费地址优先决策方式，查找首选和备选在线计费地址。
###### 失败观察 
该特性不涉及业务观察/失败观察的变化。 
###### 性能统计 
序号|性能计数器名称
---|---
1|C000200081 在线用户群组数
2|C000200082 在线用户群组数均值
3|C000200083 在线用户群组数峰值
###### 告警和通知 
该特性不涉及告警/通知消息的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置特性 


 

###### 配置说明 
对于PCC用户，通过SPR签约个性化套餐，达到个性化定制策略的目的。 
###### 配置前提 
个性化签约属性已提前规划完成。 
SPR与RCP之间的链路配置正常，SPR与PCR之间通信正常。 
SPR与BOSS之间通信正常，SPR可以接收到BOSS发送的用户签约消息。 
RCP与SMF、AF、SMSC等交互网元链路通信正常。 
###### 配置过程 
配置流程如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424918__3cb562b4-c283-45be-9c31-718870cfe999)所示。
图1  配置流程
[]images/%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
配置过程： 
登录RCP的EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0服务。
执行ADD USERACC命令，配置用户（组）资料接入局。 
执行ADD NUMANA命令，配置号段分析。 
配置套餐等用户签约信息 
SPR配置
登录SPR的EM客户端，在SPR的配置页面 
执行[ADD SPRPAKINFO](None)命令，配置SPR网元支持套餐的基本信息。
执行[ADD SPRUSERTYPE](None)命令，配置SPR网元支持用户类型的信息。
执行[ADD SPRUSGID](None)命令，配置SPR网元支持签约用量的基本信息。
执行ADD SPRCL命令，配置SPR网元支持签约的习惯语言。 
执行[ADD SPREXINFO](None)命令，配置扩展信息。
在BOSS营账页面 
执行[ADD BASE](None)命令，增加用户的开户信息，以及签约信息，包括套餐、用户类型、用量、附加属性等。
执行[SET PAK](None)命令，修改套餐信息。
执行[SET SI](None)命令，修改业务信息。
执行[SET USAGE](None)命令，设置用量信息。
RCP配置
登录RCP的EM客户端，打开配置→命令处理
页面。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置RCP网元支持套餐的基本信息。
配置策略 
登录RCP的EM客户端，进入配置→RCP策略管理
页面，配置基于用户签约信息的控制策略。
###### 配置实例-VIP用户保障策略 
######## 场景说明 
根据用户的签约类型（金、银、铜）不同，对用户分级设置默认保障带宽，实现QoS控制。
用户需求参见[表1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__ae535c1a-35c0-4735-bd83-531de53d3688)。
用户类型|默认保障带宽(上/下行)
---|---
金牌用户|6Mbps/6Mbps，QCI=6
银牌用户|4Mbps/4Mbps，QCI=8
铜牌用户|2Mbps/2Mbps，QCI=9
######## 数据规划 
类别|参数|取值
---|---|---
用户个性化签约|用户类型|1|用户类型
签约套餐|用户个性化签约|套餐ID|400
默认保障带宽|签约套餐|用户个性化签约|6 Mbps
用户类型|用户个性化签约|用户类型|2
签约套餐|用户个性化签约|套餐ID|400
默认保障带宽|签约套餐|用户个性化签约|4 Mbps
用户类型|用户个性化签约|用户类型|3
签约套餐|用户个性化签约|套餐ID|400
默认保障带宽|签约套餐|用户个性化签约|2 Mbps
规则|N7会话控制策略1|当前使用套餐400，且用户类型=1，则上下行默认保障带宽为6 Mbps|N7会话控制策略1
N7会话控制策略2|规则|N7会话控制策略2|当前使用套餐400，且用户类型=2，则上下行默认保障带宽为4 Mbps
N7会话控制策略3|规则|N7会话控制策略3|当前使用套餐400，且用户类型=3，则上下行默认保障带宽为2 Mbps
######## 业务配置关系图 
业务配置关系图如[图2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__62ab0be9-8d98-49e0-894c-d01e896d4792)所示。
图2  业务配置关系图
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB%E5%9B%BE1.png)
######## 配置步骤 
配置基础信息
RCP配置 
增加用户（组）资料接入局。 
[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html):ID=1,ADJHOSTID=2,ACTMODE="SUBS_USG",AUTOPROVSWITCH="CLOSE";
增加号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=1,ANATYPE="USERACC_IMSI",NUMBEGIN="000000000000000",NUMEND="999999999999999",RESULTID=1;
增加套餐基本配置。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="400",PRIORITY=1;
SPR配置 
新增SPR用户类型配置。 
[ADD SPRUSERTYPE](None):TYPEID=1,NAME="金牌用户";
[ADD SPRUSERTYPE](None):TYPEID=2,NAME="银牌用户";
[ADD SPRUSERTYPE](None):TYPEID=3,NAME="铜牌用户";
新增SPR套餐信息配置。 
ADD SPRPAKINFO:PAKID=400,NAME="pak400",DESC="套餐400";
SPR受理个性化签约。 
[ADD BASE](None):IMSI=460000000000001,ISDN=8613312345671,USERTYPE=1,UFLAG=0$0$3$0$0$0,PAKIDLIST=400;
[ADD BASE](None):IMSI=460000000000002,ISDN=8613312345672,USERTYPE=2,UFLAG=0$0$3$0$0$0,PAKIDLIST=400;
[ADD BASE](None):IMSI=460000000000003,ISDN=8613312345673,USERTYPE=3,UFLAG=0$0$3$0$0$0,PAKIDLIST=400;
配置策略
配置规则条件 
条件名称|参数|取值
---|---|---
User type1|选择策略变量|其他
策略变量类别|User type1|用户签约信息
策略变量|User type1|User Type
操作符|User type1|=
值类型|User type1|值
值|User type1|1
User type2|选择策略变量|其他
策略变量类别|User type2|用户签约信息
策略变量|User type2|User Type
操作符|User type2|=
值类型|User type2|值
值|User type2|2
User type3|选择策略变量|其他
策略变量类别|User type3|用户签约信息
策略变量|User type3|User Type
操作符|User type3|=
值类型|User type3|值
值|User type3|3
配置动作参数 
动作参数名称|参数名称|取值
---|---|---
Act_Sess_Gold user|参数类型|N7会话参数集
默认最大上行带宽（kbps）|Act_Sess_Gold user|6000
默认最大下行带宽（kbps）|Act_Sess_Gold user|6000
默认保障上行带宽（kbps）|Act_Sess_Gold user|6000
默认保障下行带宽（kbps）|Act_Sess_Gold user|6000
5QI|Act_Sess_Gold user|6
ARP 优先级|Act_Sess_Gold user|1
Act_Sess_Silver user|参数类型|N7会话参数集
默认最大上行带宽（kbps）|Act_Sess_Silver user|4000
默认最大下行带宽（kbps）|Act_Sess_Silver user|4000
默认保障上行带宽（kbps）|Act_Sess_Silver user|4000
默认保障下行带宽（kbps）|Act_Sess_Silver user|4000
5QI|Act_Sess_Silver user|8
ARP 优先级|Act_Sess_Silver user|2
Act_Sess_Copper user|参数类型|N7会话参数集
默认最大上行带宽（kbps）|Act_Sess_Copper user|2000
默认最大下行带宽（kbps）|Act_Sess_Copper user|2000
默认保障上行带宽（kbps）|Act_Sess_Copper user|2000
默认保障下行带宽（kbps）|Act_Sess_Copper user|2000
QCI|Act_Sess_Copper user|9
ARP 优先级|Act_Sess_Copper user|3
配置策略规则 
规则名称|参数|取值
---|---|---
Rule_Sess_Gold user|优先级|10
动作类型|Rule_Sess_Gold user|参数填充
日志开关|Rule_Sess_Gold user|关
条件表达式|Rule_Sess_Gold user|{用户类型 = 1}
动作参数名称|Rule_Sess_Gold user|Act_Sess_Gold user
Rule_Sess_Silver user|优先级|10
动作类型|Rule_Sess_Silver user|参数填充
日志开关|Rule_Sess_Silver user|关
条件表达式|Rule_Sess_Silver user|{用户类型 = 2}
动作参数名称|Rule_Sess_Silver user|Act_Sess_Silver user
Rule_Sess_Copper user|优先级|10
动作类型|Rule_Sess_Copper user|参数填充
日志开关|Rule_Sess_Copper user|关
条件表达式|Rule_Sess_Copper user|{用户类型 = 3}
动作参数名称|Rule_Sess_Copper user|Act_Sess_Copper user
配置场景规则关联 
场景名称|参数|取值
---|---|---
QoS_Based_on_User type control policy|入口|入口类型|用户信息类
已选入口|QoS_Based_on_User type control policy|入口|用户套餐
取值|QoS_Based_on_User type control policy|入口|400
策略类型|QoS_Based_on_User type control policy|N7会话控制策略|Rule_Sess_Gold user
Rule_Sess_Silver user|策略类型|QoS_Based_on_User type control policy|N7会话控制策略
Rule_Sess_Copper user|策略类型|QoS_Based_on_User type control policy|N7会话控制策略
###### 配置实例-基于套餐做APN-AMBR达量限速 
######## 场景说明 
用户签约多个套餐，使用不同套餐时，用户的带宽不同，RCP需为用户尽量提供允许的最高的带宽。 
用户需求示例参见[表2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new428a0528eaba4354b3641cbe92395fc8__ed462dfc-9dd6-42e7-9d7f-3dd18eda5ea6)。
用户签约|策略控制条件|策略
---|---|---
用户类型为10用户签约套餐1、套餐2|使用套餐1，且套餐1每月使用流量 <= 签约值|会话AMBR上/下行速率均为10 Mbps
使用套餐1，且套餐1每月使用流量 > 签约值|用户类型为10用户签约套餐1、套餐2|会话AMBR上/下行速率均为1 Mbps
使用套餐2，且套餐2每月使用流量 <= 签约值|用户类型为10用户签约套餐1、套餐2|会话AMBR上/下行速率均为5 Mbps
使用套餐2，且套餐2每月使用流量 > 签约值|用户类型为10用户签约套餐1、套餐2|会话AMBR上/下行速率均为512 Kbps
######## 数据规划 
根据场景描述，需要根据各套餐不同使用流量，动态调整套餐优先级，才能达到场景要求的控制需求。 
具体为： 
套餐1、套餐2初始均为最低优先级1。 
套餐1每月使用流量 <= 签约值时，调整套餐1的优先级为最高优先级11；条件不满足时，优先级恢复为1。 
套餐1每月使用流量 > 签约值，并且套餐2每月使用流量 <= 签约值时，调整套餐2的优先级为最高优先级11；条件不满足时，优先级恢复为1。 
套餐1每月使用流量 > 签约值，并且套餐2每月使用流量 > 签约值时，调整套餐1的优先级为最高优先级11；条件不满足时，优先级恢复为1。 
需求拆解及数据规划 
类别|参数|取值
---|---|---
用户个性化签约|用户类型|10|用户类型
签约套餐|用户个性化签约|套餐ID|1
个性化优先级|签约套餐|用户个性化签约|无
签约套餐|用户个性化签约|套餐ID|2
个性化优先级|签约套餐|用户个性化签约|无
套餐1|编号|1|编号
套餐基本配置中的优先级|套餐1|套餐基本配置中的优先级|1
套餐2|编号|2|编号
套餐基本配置中的优先级|套餐2|套餐基本配置中的优先级|1
套餐1用量|签约用量|1GB|签约用量
清零方式|套餐1用量|清零方式|每月1号0点。
MK|套餐1用量|MK|1000
套餐2用量|签约用量|2GB|签约用量
清零方式|套餐2用量|清零方式|每月1号0点。
MK|套餐2用量|MK|2000
规则|N7会话控制策略1|当前使用套餐1，且套餐1每月使用流量<=签约值，则上下行带宽为10Mbps|N7会话控制策略1
N7会话控制策略2|规则|N7会话控制策略2|当前使用套餐1，且套餐1每月使用流量>签约值，则上下行带宽为1Mbps
N7会话控制策略3|规则|N7会话控制策略3|当前使用套餐2，且套餐2每月使用流量<=签约值，则上下行带宽为5Mbps
N7会话控制策略4 说明：此条规则可不配置，因为通过动态优先级策略决策，不会选中此规则。|规则|N7会话控制策略4 说明：此条规则可不配置，因为通过动态优先级策略决策，不会选中此规则。|当前使用套餐2，且套餐2每月使用流量>签约值，则上下行带宽为512Kbps
套餐动态优先级策略1|规则|套餐动态优先级策略1|“套餐1每月使用流量 <= 签约值”或者“套餐2每月使用流量 > 签约值”， 套餐1的优先级调整为11
套餐动态优先级策略2|规则|套餐动态优先级策略2|“套餐1每月使用流量 > 签约值”并且“套餐2每月使用流量 <= 签约值”， 套餐2的优先级调整为11
会话用量监控策略|规则|会话用量监控策略|固定值方式
######## 业务配置关系图 
图3  业务关系配置图
[]images/qosbasedonusg.png)
######## 配置步骤 
配置基础信息
RCP配置 
增加用户（组）资料接入局。 
[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html):ID=1,ADJHOSTID=2,ACTMODE="SUBS_USG",AUTOPROVSWITCH="CLOSE";
增加号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=1,ANATYPE="USERACC_IMSI",NUMBEGIN="000000000000000",NUMEND="999999999999999",RESULTID=1;
增加套餐基本配置。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="2",PRIORITY=1;
SPR配置 
新增SPR套餐信息配置。 
[ADD SPRPAKINFO](None):PAKID=1,NAME="pak1",RESETTIME="00:00",RESETCYCLE=0,FIRSTUSGID=0,DESC="套餐1";
[ADD SPRPAKINFO](None):PAKID=2,NAME="pak2",RESETTIME="00:00",RESETCYCLE=0,FIRSTUSGID=0,DESC="套餐2";
SPR受理个性化签约。 
[ADD BASE](None):IMSI=460000000000001,ISDN=8613312345671,PAKIDLIST=1;
[ADD BASE](None):IMSI=460000000000002,ISDN=8613312345672,PAKIDLIST=1;
配置策略
配置基本用量 
基本用量|参数|取值
---|---|---
Usg_Pak1_mon_vol|策略变量编号|1说明：SPR上需要配置
策略变量名称|Usg_Pak1_mon_vol|Usg_Pak1_mon_vol
用量层次|Usg_Pak1_mon_vol|Monitoring Key Subscriber
用量周期|Usg_Pak1_mon_vol|Month
用量类型|Usg_Pak1_mon_vol|Volume
套餐标识|Usg_Pak1_mon_vol|1
Monitoring Key列表|Usg_Pak1_mon_vol|1000
Usg_Pak2_mon_vol|策略变量编号|2 说明：SPR上需要配置
策略变量名称|Usg_Pak2_mon_vol|Usg_Pak2_mon_vol
用量层次|Usg_Pak2_mon_vol|Monitoring Key Subscriber
用量周期|Usg_Pak2_mon_vol|Month
用量类型|Usg_Pak2_mon_vol|Volume
套餐标识|Usg_Pak2_mon_vol|2
Monitoring Key列表|Usg_Pak2_mon_vol|2000
配置规则条件 
条件名称|参数|取值
---|---|---
Cond_Pak1_mon_vol>Prof|选择策略变量|用量
策略变量类别|Cond_Pak1_mon_vol>Prof|总用量实际值
策略变量|Cond_Pak1_mon_vol>Prof|Usg_Pak1_mon_vol
操作符|Cond_Pak1_mon_vol>Prof|>
值类型|Cond_Pak1_mon_vol>Prof|策略变量
用量策略变量|Cond_Pak1_mon_vol>Prof|Usg_Pak1_mon_vol.Total Value
Cond_Pak2_mon_vol>Prof|选择策略变量|用量
策略变量类别|Cond_Pak2_mon_vol>Prof|总用量实际值
策略变量|Cond_Pak2_mon_vol>Prof|Usg_Pak2_mon_vol
操作符|Cond_Pak2_mon_vol>Prof|>
值类型|Cond_Pak2_mon_vol>Prof|策略变量
用量策略变量|Cond_Pak2_mon_vol>Prof|Usg_Pak2_mon_vol.Total Value
Cond_PakID_1|选择策略变量|其他
策略变量类别|Cond_PakID_1|用户签约信息
策略变量|Cond_PakID_1|用户套餐ID
操作符|Cond_PakID_1|=
值类型|Cond_PakID_1|值
值|Cond_PakID_1|1
Cond_PakID_2|选择策略变量|其他
策略变量类别|Cond_PakID_2|用户签约信息
策略变量|Cond_PakID_2|用户套餐ID
操作符|Cond_PakID_2|=
值类型|Cond_PakID_2|值
值|Cond_PakID_2|2
配置动作参数 
N7会话策略动作参数： 
动作参数名称|参数名称|取值
---|---|---
Act_Sess_10M|参数类型|N7会话参数集
会话AMBR上行速率（kbps）|Act_Sess_10M|10240
会话AMBR下行速率（kbps）|Act_Sess_10M|10240
Act_Sess_5M|参数类型|N7会话参数集
会话AMBR上行速率（kbps）|Act_Sess_5M|5120
会话AMBR下行速率（kbps）|Act_Sess_5M|5120
Act_Sess_1M|参数类型|N7会话参数集
会话AMBR上行速率（kbps）|Act_Sess_1M|1024
会话AMBR下行速率（kbps）|Act_Sess_1M|1024
会话用量监控策略动作参数： 
动作参数名称|参数名称|取值
---|---|---
Act_MK1000_Sess_Fixed_10M|参数类型|会话用量监控参数集
流量门限控制方式|Act_MK1000_Sess_Fixed_10M|固定值
总流量门限（kbps）|Act_MK1000_Sess_Fixed_10M|10240
Monitoring Key|Act_MK1000_Sess_Fixed_10M|1000
Act_MK2000_Sess_Fixed_20M|参数类型|会话用量监控参数集
流量门限控制方式|Act_MK2000_Sess_Fixed_20M|固定值
总流量门限（kbps）|Act_MK2000_Sess_Fixed_20M|20480
Monitoring Key|Act_MK2000_Sess_Fixed_20M|2000
套餐动态优先级策略动作参数： 
动作参数名称|参数名称|取值
---|---|---
Act_PakPrio_11|参数类型|套餐动态属性参数集
套餐动态优先级|Act_PakPrio_11|11
配置策略规则 
N7会话控制策略规则： 
规则名称|参数|取值
---|---|---
Rule_Sess_1|优先级|1
动作类型|Rule_Sess_1|参数填充
日志开关|Rule_Sess_1|关
条件表达式|Rule_Sess_1|“Cond_PakID_1” 并且 取反“Cond_Pak1_mon_vol>Prof ”
动作参数名称|Rule_Sess_1|Act_Sess_10M
Rule_Sess_2|优先级|1
动作类型|Rule_Sess_2|参数填充
日志开关|Rule_Sess_2|关
条件表达式|Rule_Sess_2|“Cond_PakID_1” 并且“Cond_Pak1_mon_vol>Prof ”
动作参数名称|Rule_Sess_2|Act_Sess_1M
Rule_Sess_3|优先级|1
动作类型|Rule_Sess_3|参数填充
日志开关|Rule_Sess_3|关
条件表达式|Rule_Sess_3|“Cond_PakID_2”并且 取反“Cond_Pak2_mon_vol>Prof ”
动作参数名称|Rule_Sess_3|Act_Sess_5M
会话用量监控策略规则： 
规则名称|参数|取值
---|---|---
Rule_MK_Sess_1|优先级|1
动作类型|Rule_MK_Sess_1|参数填充
日志开关|Rule_MK_Sess_1|关
条件表达式|Rule_MK_Sess_1|Cond_PakID_1
动作参数名称|Rule_MK_Sess_1|Act_MK1000_Sess_Fixed_10M
Rule_MK_Sess_2|优先级|1
动作类型|Rule_MK_Sess_2|参数填充
日志开关|Rule_MK_Sess_2|关
条件表达式|Rule_MK_Sess_2|Cond_PakID_2
动作参数名称|Rule_MK_Sess_2|Act_MK2000_Sess_Fixed_20M
套餐动态优先级策略规则： 
规则名称|参数|取值
---|---|---
Rule_PakPrio_ 1|优先级|1
动作类型|Rule_PakPrio_ 1|参数填充
日志开关|Rule_PakPrio_ 1|关
条件表达式|Rule_PakPrio_ 1|“Cond_PakID_1”并且（取反“Cond_Pak1_mon_vol>Prof ”或者 “Cond_Pak2_mon_vol>Prof ”）
动作参数名称|Rule_PakPrio_ 1|Act_PakPrio_11
Rule_PakPrio_ 2|优先级|1
动作类型|Rule_PakPrio_ 2|参数填充
日志开关|Rule_PakPrio_ 2|关
条件表达式|Rule_PakPrio_ 2|“Cond_PakID_2”并且（“Cond_Pak1_mon_vol>Prof ”并且 取反“Cond_Pak2_mon_vol>Prof ”）
动作参数名称|Rule_PakPrio_ 2|Act_PakPrio_11
配置场景规则关联 
场景名称|参数|取值
---|---|---
QoS_Based_on_UsgType10|入口|入口类型|用户信息类
|QoS_Based_on_UsgType10|已选入口|用户类型
|QoS_Based_on_UsgType10|取值|10
策略类型|QoS_Based_on_UsgType10|N7会话控制策略|Rule_Sess_1
|QoS_Based_on_UsgType10||Rule_Sess_2
|QoS_Based_on_UsgType10||Rule_Sess_3
|QoS_Based_on_UsgType10|会话级用量监控策略|Rule_MK_Sess_1
|QoS_Based_on_UsgType10||Rule_MK_Sess_2
|QoS_Based_on_UsgType10|套餐动态优先级策略|Rule_PakPrio_ 1
|QoS_Based_on_UsgType10||Rule_PakPrio_ 2
###### 配置实例-基于用户套餐签约信息中扩展属性决策 
######## 场景说明 
签约套餐中扩展属性字段可以作为业务键，用来决策会话规则。例如，用户签约信息中有扩展属性dnn，用户上线携带dnn，RCP根据签约信息中扩展属性dnn来进行决策，下发规则。 
######## 数据规划 
用户需求示例参见[表3](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newbcf252b7890c42cc81c370cce0ad4ab3__7507a272-f4a2-4427-ba46-ec65fcb5f380)。
用户签约|策略控制条件|策略
---|---|---
用户签约套餐1|用户上线，携带dnn= 签约信息中扩展属性|会话AMBR上/下行速率 均为100000 kbps
######## 业务配置关系图 
业务配置关系图如[图4](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newbcf252b7890c42cc81c370cce0ad4ab3__62ab0be9-8d98-49e0-894c-d01e896d4792)所示。
图4  业务配置关系图
[]images/dc12f5d0968440b999918f6543895664.png)
######## 配置步骤 
配置基础信息
RCP配置 
增加用户（组）资料接入局。 
[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html):ID=1,ADJHOSTID=2,ACTMODE="SUBS_USG",AUTOPROVSWITCH="CLOSE"
增加号码段分析。 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=1,ANATYPE="USERACC_IMSI",NUMBEGIN="000000000000000",NUMEND="999999999999999",RESULTID=1
增加套餐基本配置。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
SPR配置 
新增SPR套餐信息配置。 
[ADD SPRPAKINFO](None):PAKID=1,NAME="pak1",RESETTIME="00:00",RESETCYCLE=0,FIRSTUSGID=0,DESC="套餐1"
SPR受理个性化签约。 
[ADD BASE](None):IMSI=460000000000001,ISDN=8613312345671,PAKIDLIST=1
配置策略
配置自定义变量 
自定义变量名称|参数|取值
---|---|---
自定义_dnn|策略变量|字符型扩展属性类型
扩展属性类型|自定义_dnn|套餐层
扩展属性名称|自定义_dnn|dnn
套餐标识|自定义_dnn|1
配置规则条件 
条件名称|参数|取值
---|---|---
APN=dnn|选择策略变量|其他
策略变量类别|APN=dnn|会话信息类
策略变量|APN=dnn|APN
操作符|APN=dnn|=
值类型|APN=dnn|策略变量
值|APN=dnn|自定义_dnn
配置动作参数 
动作参数名称|参数名称|取值
---|---|---
N7_Session_01|参数类型|N7会话参数集
会话AMBR上行速率（kbps）|N7_Session_01|100000
会话AMBR下行速率（kbps）|N7_Session_01|100000
5QI|N7_Session_01|10
配置策略规则 
规则名称|参数|取值
---|---|---
N7_Session_Rule_01_01|优先级|20
动作类型|N7_Session_Rule_01_01|参数填充
日志开关|N7_Session_Rule_01_01|关
条件表达式|N7_Session_Rule_01_01|{APN = 自定义_dnn}
动作参数名称|N7_Session_Rule_01_01|N7_Session_01
配置场景规则关联 
场景名称|参数|取值
---|---|---
Rule_01_01|入口|入口类型|用户信息类
已选入口|Rule_01_01|入口|用户套餐
取值|Rule_01_01|入口|1
策略类型|Rule_01_01|N7会话控制策略|N7_Session_Rule_01_01
##### 测试用例 
测试条目|VIP用户保障策略
---|---
预置条件|已完成签约配置、网管基本配置、规则配置。参见“配置实例-VIP用户保障策略”。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，携带签约类型为金牌用户号码。SMF向RCP发送Npcf_SMPolicyControl_Create Request，携带签约类型为银牌用户号码。SMF向RCP发送Npcf_SMPolicyControl_Create Request，携带签约类型为铜牌用户号码。
通过准则|RCP判断用户类型是金牌用户，则下发上下行带宽为6 Mbps策略，通过Npcf_SMPolicyControl_Create Response消息给SMF。RCP判断用户类型是银牌用户，则下发上下行带宽为4 Mbps策略，通过Npcf_SMPolicyControl_Create Response消息给SMF。RCP判断用户类型是铜牌用户，则下发上下行带宽为2 Mbps策略，通过Npcf_SMPolicyControl_Create Response消息给SMF。
测试条目|基于套餐做APN-AMBR达量限速
---|---
预置条件|已完成签约配置、网管基本配置、规则配置。参见“配置实例-基于套餐做APN-AMBR达量限速”。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request。SMF向RCP发送Npcf_SMPolicyControl_Update Request，携带会话用量1.1GB， MK=1000。SMF向RCP发送Npcf_SMPolicyControl_Update Request，携带会话用量1GB， MK=2000。SMF向RCP发送Npcf_SMPolicyControl_Update Request，携带会话用量1.1GB， MK=2000。SMF向RCP发送Npcf_SMPolicyControl_Delete Request。
通过准则|用户成功上线。RCP在Npcf_SMPolicyControl_Create Response消息中，下发会话策略AMBR上/下行带宽 均为10Mbps，以及会话用量监控策略。此时套餐1用量为0，套餐2用量为0。用量累计成功。此时套餐1用量为1.1GB，套餐2用量为0。RCP在Npcf_SMPolicyControl_Update Response消息中，下发会话策略AMBR上/下行带宽均为5Mbps，以及会话用量监控策略。用量累计成功。此时套餐1用量为1.1GB，套餐2用量为1GB。RCP在Npcf_SMPolicyControl_Update Response消息中，只下发会话用量监控策略。用量累计成功。此时套餐1用量为1.1GB，套餐2用量为2.1GB。RCP在Npcf_SMPolicyControl_Update Response消息中，下发会话策略AMBR上/下行带宽 均为1Mbps，以及会话用量监控策略。用户成功下线。离线前动态用量存储到SPR。
测试条目|基于用户套餐签约信息中扩展属性决策
---|---
预置条件|已完成签约配置、网管基本配置、规则配置。参见“配置实例-基于用户套餐签约信息中扩展属性决策”。
测试步骤|SMF向RCP发送Npcf_SMPolicyControl_Create Request，上线携带dnn1。RCP从SPR获取签约信息，套餐1携带扩展属性（名称为dnn，类型为utf8-string，长度4，值为dnn1）。
通过准则|用户成功上线。RCP在Npcf_SMPolicyControl_Create Response消息中，下发会话AMBR上/下行带宽 均为100Mbps。
### 缩略语 
### 缩略语 
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### IMEISV 
International Mobile Equipment Identity and Software Version number国际移动设备识别码和软件版本号
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### ISDN 
International Subscriber Directory Number国际用户目录号
#### PCCPI 
PCC Private IdentityPCC私有标识
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### QoS 
Quality of Service服务质量
#### RCP 
Resource Control Platform资源控制平台
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
### ZUF-59-42-005 基于漫游的策略控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
PLMN|公共陆地移动网，由政府或它所批准的经营者，为公众提供陆地移动通信业务目的而建立和经营的网络。
HPLMN|Home PLMN，归属网络。
VPLMN|Visited PLMN，拜访网络。
##### 描述 
####### 定义 
RCP允许运营商定义本地区域和多个不同的漫游区域，在不同区域内实施差异化的策略控制。 
####### 背景知识 
参考3GPP标准，漫游分为Home Routed和Local Breakout两种模式。 
Home Routed模式此模式下，用户PDU会话终结在HPLMN的SMF，如图1所示。图1  Home Routed模式 
Local Breakout模式此模式下，用户PDU会话终结在VPLMN的SMF，如图2所示。图2  Local Breakout模式 
但实际部署时，H-PCF和V-PCF间的N24接口都还未部署。 
运营商内部省间漫游中国移动、中国联通、中国电信的运营商内部省间漫游大体上是Local Breakout模式，PDU会话终结在拜访地SMF，但在PCC漫游架构上又类似Home Routed模式。具体如下：拜访地AMF都是直接找归属地H-PCF，不经过V-PCF。对数据业务DNN上的PDU会话，拜访地SMF直接找归属地H-PCF做策略控制，不经过V-PCF。对VoLTE/VoNR业务的IMS DNN上的PDU会话，拜访地SMF直接找拜访地V-PCF做策略控制，V-PCF不和H-PCF交互。 
国际漫游目前各运营商用到一般都是HomeRouted模式，PDU会话终结在HPLMN的SMF，H-PCF对SMF实施会话策略控制，但此时AMF是否直接访问H-PCF获取AM/UE策略，还是走标准的V-PCF和H-PCF架构，目前没有明确要求。 
##### 应用场景 
运营商对用户在漫游区域和非漫游区域实施不同的策略控制。例如，对在漫游区域的用户实施限速，或对离线计费用户在漫游区域时开启在线计费，避免用户因为数据业务漫游资费较高而意外过度欠费。 
运营商对用户在不同的漫游区域实施不同的策略控制。例如，根据用户所在漫游区域向用户发送短信，推荐相应的漫游套餐。 
##### 客户收益 
收益方|收益描述
---|---
运营商|当用户漫游时，如果用户没有购买漫游套餐，对用户实施限速，或使离线计费用户转为在线计费，避免用户因为数据业务漫游资费较高而意外过度欠费。对用户在不同的漫游区域实施不同的策略控制，根据用户所在漫游区域向用户发送短信推荐相应的漫游套餐，提升用户满意度。
终端用户|在不同漫游区域可以购买不同的漫游套餐。未购买漫游套餐的用户，通过限速，离线计费转在线计费等手段，避免意外使用过多漫游流量而过度欠费。

##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newcef44d8913a743fe811d286b90f64a80__a652d205-302b-4924-97dc-532fb34dc695)所示。
图3  系统架构
[]images/image.png)
###### 各网元作用 
涉及的网元及其功能参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zf0ca60caa2a14ff0adf6fe961b67581c__8ed2a015-e099-49cd-a5b0-bf9dc954d199)。
网元|描述
---|---
RCP|根据用户是否漫游或在不同漫游区域实施差异化的策略控制。
SMF|上报用户位置，向PCF请求PDU会话策略控制。
AMF|上报用户位置，向PCF请求接入和移动性策略控制及UE策略控制。
###### 业务流程 
######## N7会话漫游判断 
N7会话漫游判断流程如[图4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newfe84db88115846369640566e8d921e8a__4531c61b-9558-4ed7-9efa-1e109df0c631)所示。
图4  N7会话漫游判断
[]images/n7%E6%8E%A5%E5%8F%A3%E6%BC%AB%E6%B8%B8%E5%88%A4%E6%96%AD.png)
步骤： 
PDU会话建立时，SMF向RCP发送Npcf_SMPolicyControl_Create请求，其中如下信息可以用于漫游判断。 
servingNetwork：其中包含拜访网络的MCC和MNC。 
servNfId：如果是5G接入，包含AMF实例编号（servNfInstId）和全局AMF标识（GUAMI）；如果是4G接入，包含接入网关SGW或ePDG地址（anGwAddr）。 
smfId：SMF实例编号。 
notificationUri：在不启用Proxy的场景下，其中包含SMF的IP地址或FQDN。 
userLocationInfo：包含TAI、ECGI（4G接入）或NCGI（5G接入）等细粒度的用户位置信息。 
RCP选择上述信息进行漫游判断，向SMF发送Npcf_SMPolicyControl_Create响应，下发PCC规则，并在PolicyControlRequestTriggers中订阅漫游判断相关事件。 
例如： 
PLMN_CH：对应servingNetwork改变。 
SCNN_CH：对应servNfId改变。 
SAREA_CH：对应userLocationInfo改变。 
后续用户接入区域改变时，SMF通过Npcf_SMPolicyControl_Update请求上报新的接入区域，RCP再判断用户漫游区域及是否要调整策略控制。 
######## Gx会话漫游判断 
Gx会话漫游判断流程如[图5](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newfe84db88115846369640566e8d921e8a__8fd571bb-9a69-46f9-905f-ba24aaf22abe)所示。
图5  Gx会话漫游判断
[]images/gx%E6%8E%A5%E5%8F%A3%E6%BC%AB%E6%B8%B8%E5%88%A4%E6%96%AD.png)
步骤： 
IP-CAN会话建立时，PCEF向RCP发送CCR-I请求，其中如下信息可以用于漫游判断。 
3GPP-SGSN-MCC-MNC：其中包含拜访网络的MCC和MNC。 
3GPP-SGSN-Address或3GPP-SGSN-IPv6-Address：2G/3G接入时的SGSN地址。 
AN-GW-Address：4G接入时的SGW地址。 
3GPP-User-Location-Info：用户位置信息（例如：2G的CGI，3G的SAI，4G的TAI和ECGI）。 
UE-Local-IP-Address：Wi-Fi接入时的UE本地IP地址。 
RCP选择上述信息进行漫游判断，向PCEF发送CCA-I响应，下发PCC规则，并在Event-Trigger中订阅漫游判断相关事件。 
例如： 
PLMN_CHANGE (4)：对应3GPP-SGSN-MCC-MNC改变。 
SGSN_CHANGE (0)：对应3GPP-SGSN-Address或3GPP-SGSN-IPv6-Address改变。 
AN_GW_CHANGE (21)：对应AN-GW-Address改变。 
USER_LOCATION_CHANGE (13)：对应3GPP-User-Location-Info改变。 
后续用户接入区域改变时，PCEF通过CCR-U上报新的接入区域，RCP再判断用户漫游区域及是否要调整策略控制。 
###### 本网元实现 
######## Gx会话漫游判断 
接入属性配置
RCP可以配置[表2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new34505278201347fc8e8a753cb0eb62ff__d8a214cc-3a34-40a7-9237-ab261283d5ec)中的接入属性，一个接入属性代表一个SMF/PCEF邻接主机组下的一个指定的接入区域（本地区域/漫游区域）。
接入属性|对应配置|配置约束|用途
---|---|---|---
MCC-MNC接入属性|MCC-MNC接入配置|同一个SMF/PCEF邻接主机组下，不同MCC-MNC接入属性的MCC-MNC号段不能重叠。|运营商间的漫游判断。
SGSN/AN-GW-Address接入属性|SGSN IP/AN-GW-Address接入配置|同一个SMF/PCEF邻接主机组下，不同SGSN/AN-GW地址接入属性的SGSN/AN-GW地址段不能重叠。|运营商间或运营商内部省间漫游判断。
ULI接入属性|ULI接入配置|同一个SMF/PCEF邻接主机组下，不同ULI接入属性的ULI号段不能重叠。|运营商内部不同区域间细粒度的漫游判断。一般不用。
BSID接入属性|BSID接入配置|同一个SMF/PCEF邻接主机组下，不同BSID接入属性的BSID号段不能重叠。|CDMA/eHRPD接入时的漫游判断。
UE本地IP接入属性|UE本地IP接入配置|同一个SMF/PCEF邻接主机组下，不同UE本地IP地址接入属性的UE本地IP地址段不能重叠。|VoWiFi业务的漫游判断。
每种接入属性配置中都有邻接主机组编号，代表SMF/PCEF邻接主机组。
当同一套RCP同时为多个国家运营商服务时，配置这个邻接局ID有利于区分不同国家的漫游区域。例如：一个跨国运营商在A、B两国各部署SMF/PCEF，但共用同一套RCP，A国的MCC-MNC相对于自己的PGW来说是本地区域，但相对于B国的PGW是漫游区域。 
对于非多国运营商场景，可以将邻接主机组编号设置为0，代表通配邻接局。 
漫游策略规则配置
配置了接入属性后，直接以接入属性作为业务键配置漫游相关策略规则。例如：将HPLMN自己的MCC、MNC配置为一个MCC-MNC接入属性，RCP根据用户是否在这个接入属性来配置漫游/非漫游策略。将一个VPLMN的所有SGSN/SGW IP地址配置为一个SGSN/AN-GW-Address接入属性，RCP针对这个VPLMN配置漫游策略。 
在配置了接入属性后，通过漫游属性配置，以漫游标识作为业务键配置漫游相关策略规则。通过漫游属性配置，可以为每个接入属性定义其漫游标识，即表示此接入属性是漫游还是非漫游。对一个确定的Gx会话，RCP会分析其PCEF邻接局，并根据此邻接局的承载能力配置中的漫游判断条件，确定使用哪种接入属性来分析漫游标识，并以漫游标识作为业务键来配置漫游相关策略规则。若PCEF提供的位置信息无法最终匹配到相应的漫游标识，则默认漫游标识为漫游。 
######## N7会话漫游判断 
漫游策略规则配置
以漫游标识作为业务键配置漫游相关策略规则。运营商间漫游，可以配置MCC-MNC接入属性及配置漫游属性的漫游标识，来配置漫游相关策略规则。 
以SMF邻接局或SMF邻接局组作为业务键配置漫游相关策略规则。运营商内省间漫游，国内拜访地SMF访问归属地PCF，可以通过分析SMF邻接局或SMF邻接局组来判断漫游，策略规则中可以用SMF邻接局或SMF邻接局组作为漫游判断条件的业务键。RCP根据SMF提供的notificationUri中的SMF FQDN或IP地址，查询邻接主机配置、邻接主机通配配置、邻接主机IP配置、邻接主机组配置，确定SMF邻接局和SMF邻接局组。 
以SMF实例编号和AMF实例编号作为业务键配置漫游相关策略规则。如果SMF提供了SMF实例编号（SmfId）或AMF实例编号（servNfInstId），策略规则中也可以用SMF实例编号和AMF实例编号作为游判断条件的业务键。如果采用AMF实例编号，仅能覆盖5G接入，对4G/5G互操作场景，还要结合SGSN/AN-GW-Address接入属性覆盖4G接入场景。注：AMF/SMF实例编号格式如下：NF instance ID（网元实例标识）采用UUID版本4格式（RFC 4122）共128个bit，以32个16进制数，并以"-"分为5段标识，具体为：time-low "-" time-mid "-" time-high-and-version "-" clock-seq-and-reserved clock-seq-low "-" node。其中：node为48个bit，由6个字节（8位组）组成。中移对node部分的编码规则如下：按上述规则，中移AMF/SMF实例ID长度应该是36字节（包含4个横杠），其中第29、30字节为省份信息。因此在中移使用AMF/SMF实例编号判断漫游时，可以对AMF或SMF实例编号用Substr操作取第29，30字节和省份编码（2个字节）做对比，来判断用户是否省间漫游。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及应用限制。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|3GPP TS 29.512|5G System; Session Management Policy Control Service; Stage 3
3GPP|3GPP TS 29.212|Policy and Charging Control (PCC); Reference points
##### 特性能力 
名称|指标
---|---
各类接入属性配置记录数上限|65535
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
该特性对其它网元无特殊要求。 
##### O&M相关 
###### 配置命令 
配置项|命令|描述
---|---|---
SGSN IP/AN-GW Address接入配置|ADD SGSNIPACC|增加SGSN IP/AN-GW Address接入
DEL SGSNIPACC|SGSN IP/AN-GW Address接入配置|删除SGSN IP/AN-GW Address接入
SHOW SGSNIPACC|SGSN IP/AN-GW Address接入配置|查询SGSN IP/AN-GW Address接入
SGSN MCC-MNC接入配置|ADD MCCMNCACC|增加SGSN MCC-MNC接入
DEL MCCMNCACC|SGSN MCC-MNC接入配置|删除SGSN MCC-MNC接入
SHOW MCCMNCACC|SGSN MCC-MNC接入配置|查询SGSN MCC-MNC接入
BSID接入配置|ADD BSIDACC|增加BSID接入
DEL BSIDACC|BSID接入配置|删除BSID接入
SHOW BSIDACC|BSID接入配置|查询BSID接入
ULI接入配置|ADD ULIACC|增加ULI接入
DEL ULIACC|ULI接入配置|删除ULI接入
SHOW ULIACC|ULI接入配置|查询ULI接入
UE本地IP接入配置|ADD UELOCIPACC|增加UE本地IP接入
DEL UELOCIPACC|UE本地IP接入配置|删除UE本地IP接入
SHOW UELOCIPACC|UE本地IP接入配置|查询UE本地IP接入
漫游属性配置|ADD ACCMAP|增加漫游属性
SET ACCMAP|漫游属性配置|修改漫游属性
DEL ACCMAP|漫游属性配置|删除漫游属性
SHOW ACCMAP|漫游属性配置|查询漫游属性
配置项|命令|描述
---|---|---
承载能力配置|SET BEARABILITY|参数ROAMCOND：用于配置漫游判断条件，包含MCC-MNC、SGSN IP/AN-GW Address、BSID、ULI四种方式。RCP根据漫游条件，以及相应的信息，分析用户的漫游情况。
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
该特性不涉及告警/通知消息的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置漫游策略控制 
###### 配置说明 
基于漫游的策略控制主要是指当用户漫游时，RCP下发漫游时的策略规则，取消本地策略规则。 
###### 配置前提 
基于漫游的策略控制特性是RCP和SMF以及SPR配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常。 
###### 配置过程 
基于漫游策略决策配置流程如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424918__be2cd39b-09dc-41cc-8567-29fbdb942567)所示。
图1  基于漫游策略决策配置流程
[]images/%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
步骤： 
登录EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0  服务。
配置基本的套餐、业务信息。 
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，新增套餐基本配置。
执行[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html)命令，新增套餐业务基本配置。
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，新增应用标识配置。
配置SMF邻接主机组/邻接主机。 
执行[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html)命令，新增邻接主机组配置。
执行[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html)命令，新增邻接主机IP配置。
配置承载能力。 
执行[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html)命令，新增承载能力配置，并设置漫游判断条件。
配置漫游区域判断 
基于漫游标识策略控制所需的配置执行ADD SGSNIPACC命令，增加SGSN IP/AN-GW Address接入。执行ADD MCCMNCACC命令，增加MCC-MNC接入。执行ADD BSIDACC命令，增加BSID接入。执行ADD ULIACC命令，增加ULI接入。执行ADD UELOCIPACC命令，增加UE本地IP接入。执行ADD ACCMAP命令，增加漫游属性配置。 
基于漫游区域策略控制所需的配置执行命令ADD NUMABS，增加号码映射策略变量配置。 
进入策略管理页面，配置基于漫游的控制策略，包括配置条件、动作参数、规则和场景。
###### 配置实例-基于SMF邻接局判断漫游 
######## 场景说明 
中国电信用户在省间漫游，RCP对漫游的用户更新业务规则。 
######## 数据规划 
基本数据规划参见[表1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__d05d3cf6-40e9-4fdd-9fb1-1bbc610960b1)，业务控制策略规划参见[表2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__0fe40e1c-a237-43f0-a9d3-79bcee2416d9)。
类别|参数|取值
---|---|---
外省SMF|IP|192.168.0.0
掩码|外省SMF|16
邻接主机组ID|外省SMF|10
策略类型|控制条件|决策参数
---|---|---
业务预下发控制策略|无|Application-ID=1001
N7业务控制策略-本地|Application ID|规则名=localprerule
N7业务控制策略-漫游|Application ID & SMF邻接主机组ID|规则名=roamprerule
######## 业务配置关系图 
业务配置关系图如[图2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__22a417c1-7972-44de-bf75-cecab1395edf)所示。
图2  业务配置关系图-基于SMF邻接局判断漫游
[]images/%E5%9F%BA%E4%BA%8Esmf%E9%82%BB%E6%8E%A5%E5%B1%80%E5%88%A4%E6%96%AD%E6%BC%AB%E6%B8%B8.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置套餐业务。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="1",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
配置SMF邻接局。 
配置邻接主机组10为SMF主机类型。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置外省SMF的邻接主机IP。 
[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html):ADJHOSTID=1,HOSTIPADDRESS="192.168.0.0",MASKLEN=16,HOSTTYPE="SMF",ADJHOSTGRPID=10
配置SMF承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID"
配置策略
配置规则条件 
业务条件： 
条件名称|参数|取值
---|---|---
ApplicationID1001|选择策略变量|其他
策略变量类别|ApplicationID1001|会话信息类
策略变量|ApplicationID1001|Gx应用标识
操作符|ApplicationID1001|=
值类型|ApplicationID1001|值
值|ApplicationID1001|1001
SMF邻接主机组条件： 
条件名称|参数|取值
---|---|---
SMFadjgroup|选择策略变量|其他
策略变量类别|SMFadjgroup|接入信息类
策略变量|SMFadjgroup|SMF邻接主机组编号
操作符|SMFadjgroup|=
值类型|SMFadjgroup|值
值|SMFadjgroup|10
配置规则动作参数 
预下发业务动作参数： 
动作参数名称|参数|取值
---|---|---
pre_1001|动作参数类型|预下发业务参数集
应用标识|pre_1001|1001
N7业务决策动作参数-本地： 
动作参数名称|参数|取值
---|---|---
localprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|localprerule|localprerule
PCC规则类型|localprerule|预定义规则
N7业务决策动作参数-漫游： 
动作参数名称|参数|取值
---|---|---
roamprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|roamprerule|roamprerule
PCC规则类型|roamprerule|预定义规则
配置规则 
业务预下发控制策略规则： 
规则名称|参数|取值
---|---|---
rule_pre|优先级|10
动作类型|rule_pre|参数填充
日志开关|rule_pre|关闭
条件表达式|rule_pre|无
选中动作参数名称|rule_pre|pre_1001
N7业务控制规则-本地： 
规则名称|参数|取值
---|---|---
rule_local|优先级|10
动作类型|rule_local|参数填充
日志开关|rule_local|关闭
条件表达式|rule_local|{Gx应用标识 = 1001}
选中动作参数名称|rule_local|localprerule
N7业务控制规则-漫游： 
规则名称|参数|取值
---|---|---
rule_roam|优先级|20
动作类型|rule_roam|参数填充
日志开关|rule_roam|关闭
条件表达式|rule_roam|{Gx应用标识 = 1001}&{SMF邻接主机组编号=10}
选中动作参数名称|rule_roam|roamprerule
配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
SMFAdjGroup|入口|入口类型|用户信息类
已选入口|SMFAdjGroup|入口|用户套餐
取值|SMFAdjGroup|入口|1
策略类型|SMFAdjGroup|业务预下发控制策略|rule_pre
业务控制策略|策略类型|SMFAdjGroup|rule_roam
rule_local|业务控制策略|策略类型|SMFAdjGroup
###### 配置实例-基于SMF实例编号判断漫游 
######## 场景说明 
中国移动用户在省间漫游，RCP对漫游的用户更新业务规则。 
######## 数据规划 
基本数据规划参见[表3](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newef1ec4389b844695b5bc6e89f9c5616a__fc77984d-a117-4ec9-8ccb-2defe3a735c8)，业务控制策略规划参见[表4](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newef1ec4389b844695b5bc6e89f9c5616a__b24513d1-2904-4c1f-8e7f-8d845e2c3f67)。
类别|参数|取值
---|---|---
外省SMF|SMF实例编号（省份信息）|29
SMF实例编号（省份编码）|外省SMF|00
策略类型|控制条件|决策参数
---|---|---
业务预下发控制策略|无|Application-ID=1001
N7业务控制策略-本地|Application ID|规则名=localprerule
N7业务控制策略-漫游|Application ID & 外省SMF实例编号|规则名=roamprerule
######## 业务配置关系图 
业务配置关系图如[图3](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#newef1ec4389b844695b5bc6e89f9c5616a__c153e8ff-9394-482c-9d70-49f8549ef9d4)所示。
图3  业务配置关系图-基于SMF实例编号判断漫游
[]images/%E5%9F%BA%E4%BA%8Esmf%E5%AE%9E%E4%BE%8B%E7%BC%96%E5%8F%B7%E5%88%A4%E6%96%AD%E6%BC%AB%E6%B8%B8%20.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置套餐业务。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="1",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
配置SMF邻接局。 
配置邻接主机组10为SMF主机类型。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置外省SMF的邻接主机IP。 
[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html):ADJHOSTID=1,HOSTIPADDRESS="192.168.0.0",MASKLEN=16,HOSTTYPE="SMF",ADJHOSTGRPID=10
配置SMF承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID"
配置策略
配置规则条件 
业务条件： 
条件名称|参数|取值
---|---|---
ApplicationID1001|选择策略变量|其他
策略变量类别|ApplicationID1001|会话信息类
策略变量|ApplicationID1001|Gx应用标识
操作符|ApplicationID1001|=
值类型|ApplicationID1001|值
值|ApplicationID1001|1001
SMF实例编号条件： 
条件名称|参数|取值
---|---|---
SMFInstID|选择策略变量|其他|选择策略变量
策略变量类别|SMFInstID|策略变量类别|接入信息类
策略变量|SMFInstID|策略变量|SMF实例编号
操作符|SMFInstID|操作符|Substr
值类型|SMFInstID|值类型|值
值|SMFInstID|起始位置|29
字符串|值|SMFInstID|00
配置规则动作参数 
预下发业务动作参数： 
动作参数名称|参数|取值
---|---|---
pre_1001|动作参数类型|预下发业务参数集
应用标识|pre_1001|1001
N7业务决策动作参数-本地： 
动作参数名称|参数|取值
---|---|---
localprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|localprerule|localprerule
PCC规则类型|localprerule|预定义规则
N7业务决策动作参数-漫游： 
动作参数名称|参数|取值
---|---|---
roamprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|roamprerule|roamprerule
PCC规则类型|roamprerule|预定义规则
配置规则 
业务预下发控制策略规则： 
规则名称|参数|取值
---|---|---
rule_pre|优先级|10
动作类型|rule_pre|参数填充
日志开关|rule_pre|关闭
条件表达式|rule_pre|无
选中动作参数名称|rule_pre|pre_1001
N7业务控制规则-本地： 
规则名称|参数|取值
---|---|---
rule_local|优先级|10
动作类型|rule_local|参数填充
日志开关|rule_local|关闭
条件表达式|rule_local|{Gx应用标识 = 1001}
选中动作参数名称|rule_local|localprerule
N7业务控制规则-漫游： 
规则名称|参数|取值
---|---|---
rule_roam|优先级|20
动作类型|rule_roam|参数填充
日志开关|rule_roam|关闭
条件表达式|rule_roam|{Gx应用标识 = 1001}&{SMF实例编号 Substr 29,00}
选中动作参数名称|rule_roam|roamprerule
配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
SMFInstID|入口|入口类型|用户信息类
已选入口|SMFInstID|入口|用户套餐
取值|SMFInstID|入口|1
策略类型|SMFInstID|业务预下发控制策略|rule_pre
业务控制策略|策略类型|SMFInstID|rule_roam
rule_local|业务控制策略|策略类型|SMFInstID
###### 配置实例-基于AMF实例编号判断漫游 
######## 配置场景 
中国移动物联网用户在大区间漫游，RCP对漫游的用户更新业务规则。 
######## 数据规划 
基本数据规划参见[表5](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4e78f99238404b6182b28199656ea3a5__3be68c09-197b-4a27-a10d-37473d0f2f89)，业务控制策略规划参见[表6](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4e78f99238404b6182b28199656ea3a5__c9fcf31c-84a7-48cd-82db-77a52fbcaaec)。
类别|参数|取值
---|---|---
外省AMF|AMF实例编号（省份信息）|29
AMF实例编号（省份编码）|外省AMF|00
策略类型|控制条件|决策参数
---|---|---
业务预下发控制策略|无|Application-ID=1001
N7业务控制策略-本地|Application ID|规则名=localprerule
N7业务控制策略-漫游|Application ID & 外省AMF实例编号|规则名=roamprerule
######## 业务配置关系图 
业务配置关系图如[图4](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4e78f99238404b6182b28199656ea3a5__4dc24bc7-939b-4a33-bbb9-24247edc0e4f)所示。
图4  业务配置关系图-基于AMF实例编号判断漫游
[]images/1.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置套餐业务。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="1",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
配置SMF邻接局。 
配置邻接主机组10为SMF主机类型。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置外省SMF的邻接主机IP。 
[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html):ADJHOSTID=1,HOSTIPADDRESS="192.168.0.0",MASKLEN=16,HOSTTYPE="SMF",ADJHOSTGRPID=10
配置SMF承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID"
配置策略
配置规则条件 
业务条件： 
条件名称|参数|取值
---|---|---
ApplicationID1001|选择策略变量|其他
策略变量类别|ApplicationID1001|会话信息类
策略变量|ApplicationID1001|Gx应用标识
操作符|ApplicationID1001|=
值类型|ApplicationID1001|值
值|ApplicationID1001|1001
AMF实例编号条件： 
条件名称|参数|取值
---|---|---
AMFInstID|选择策略变量|其他|选择策略变量
策略变量类别|AMFInstID|策略变量类别|接入信息类
策略变量|AMFInstID|策略变量|AMF实例编号
操作符|AMFInstID|操作符|Substr
值类型|AMFInstID|值类型|值
值|AMFInstID|起始位置|29
字符串|值|AMFInstID|00
配置规则动作参数 
预下发业务动作参数： 
动作参数名称|参数|取值
---|---|---
pre_1001|动作参数类型|预下发业务参数集
应用标识|pre_1001|1001
N7业务决策动作参数-本地： 
动作参数名称|参数|取值
---|---|---
localprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|localprerule|localprerule
PCC规则类型|localprerule|预定义规则
N7业务决策动作参数-漫游： 
动作参数名称|参数|取值
---|---|---
roamprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|roamprerule|roamprerule
PCC规则类型|roamprerule|预定义规则
配置规则 
业务预下发控制策略规则： 
规则名称|参数|取值
---|---|---
rule_pre|优先级|10
动作类型|rule_pre|参数填充
日志开关|rule_pre|关闭
条件表达式|rule_pre|无
选中动作参数名称|rule_pre|pre_1001
N7业务控制规则-本地： 
规则名称|参数|取值
---|---|---
rule_local|优先级|10
动作类型|rule_local|参数填充
日志开关|rule_local|关闭
条件表达式|rule_local|{Gx应用标识 = 1001}
选中动作参数名称|rule_local|localprerule
N7业务控制规则-漫游： 
规则名称|参数|取值
---|---|---
rule_roam|优先级|20
动作类型|rule_roam|参数填充
日志开关|rule_roam|关闭
条件表达式|rule_roam|{Gx应用标识 = 1001}&{AMF实例编号 Substr 29,00}
选中动作参数名称|rule_roam|roamprerule
配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
AMFInstID|入口|入口类型|用户信息类
已选入口|AMFInstID|入口|用户套餐
取值|AMFInstID|入口|1
策略类型|AMFInstID|业务预下发控制策略|rule_pre
业务控制策略|策略类型|AMFInstID|rule_roam
rule_local|业务控制策略|策略类型|AMFInstID
###### 配置实例-基于MCCMNC判断漫游 
######## 配置场景 
用户在国际间漫游，RCP对漫游的用户更新业务规则。 
######## 数据规划 
基本数据规划参见[表7](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4a0c199b06254bb6b15fa1261a8ace1d__07ecaa7e-6960-4119-9d0e-406497792ed9)，业务控制策略规划参见[表8](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4a0c199b06254bb6b15fa1261a8ace1d__6cb90f81-8772-4f3b-816e-9097e7239254)。
类别|参数|取值
---|---|---
本地接入|MCCMNC|460001
接入属性|本地接入|本地
策略类型|控制条件|决策参数
---|---|---
业务预下发控制策略|无|Application-ID=1001
N7业务控制策略-本地|Application ID|规则名=localprerule
N7业务控制策略-漫游|Application ID & 漫游|规则名=roamprerule
######## 业务配置关系图 
业务配置关系图如[图5](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#new4a0c199b06254bb6b15fa1261a8ace1d__2ceb8eec-1431-4b1a-aff3-dd5705fa3636)所示。
图5  业务配置关系图-基于MCCMNC判断漫游
[]images/f78ffe0993884796bec07503074d9ac9.png)
######## 配置步骤 
配置基础信息
配置套餐基本信息。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置套餐业务。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="1",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1",SUBSDESC="1";
配置SMF邻接局。 
配置邻接主机组10为SMF主机类型。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置外省SMF的邻接主机IP。 
[ADD ADJHOSTIP](../../Npcf_PolicyManagement\zh-CN\mml\1788200.html):ADJHOSTID=1,HOSTIPADDRESS="192.168.0.0",MASKLEN=16,HOSTTYPE="SMF",ADJHOSTGRPID=10
配置SMF承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID",ROAMCOND="MCCMNC"
配置MCC-MNC接入。 
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=1,ADJHOSTGRPID=1,MCC="460",MNC="001",ACCATTR="1";
配置漫游属性。 
[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html):ACCATTR="1",ROAMFLAG="NO",ACCTYPE="MCCMNC";
配置策略
配置规则条件 
业务条件： 
条件名称|参数|取值
---|---|---
ApplicationID1001|选择策略变量|其他
策略变量类别|ApplicationID1001|会话信息类
策略变量|ApplicationID1001|Gx应用标识
操作符|ApplicationID1001|=
值类型|ApplicationID1001|值
值|ApplicationID1001|1001
漫游条件： 
条件名称|参数|取值
---|---|---
IsLocal|选择策略变量|其他
策略变量类别|IsLocal|接入信息类
策略变量|IsLocal|漫游标识
操作符|IsLocal|=
值类型|IsLocal|值
值|IsLocal|本地
配置规则动作参数 
预下发业务动作参数： 
动作参数名称|参数|取值
---|---|---
pre_1001|动作参数类型|预下发业务参数集
应用标识|pre_1001|1001
N7业务决策动作参数： 
动作参数名称|参数|取值
---|---|---
localprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|localprerule|localprerule
PCC规则类型|localprerule|预定义规则
roamprerule|动作参数类型|N7 PCC规则参数集
PCC规则名称|roamprerule|roamprerule
PCC规则类型|roamprerule|预定义规则
配置规则 
业务预下发控制策略规则： 
规则名称|参数|取值
---|---|---
rule_pre|优先级|10
动作类型|rule_pre|参数填充
日志开关|rule_pre|关闭
条件表达式|rule_pre|无
选中动作参数名称|rule_pre|pre_1001
N7业务控制规则-本地： 
规则名称|参数|取值
---|---|---
rule_local|优先级|10
动作类型|rule_local|参数填充
日志开关|rule_local|关闭
条件表达式|rule_local|{Gx应用标识 = 1001}
选中动作参数名称|rule_local|localprerule
N7业务控制规则-漫游： 
规则名称|参数|取值
---|---|---
rule_roam|优先级|20
动作类型|rule_roam|参数填充
日志开关|rule_roam|关闭
条件表达式|rule_roam|{Gx应用标识 = 1001}&~{漫游标识=本地}
选中动作参数名称|rule_roam|roamprerule
配置场景 
场景规则关联配置： 
场景名称|参数|取值
---|---|---
MCCMNCRoam|入口|入口类型|用户信息类
已选入口|MCCMNCRoam|入口|用户套餐
取值|MCCMNCRoam|入口|1
策略类型|MCCMNCRoam|业务预下发控制策略|rule_pre
业务控制策略|策略类型|MCCMNCRoam|rule_roam
rule_local|业务控制策略|策略类型|MCCMNCRoam
##### 测试用例 
测试条目|基于SMF邻接局判断漫游
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-基于SMF邻接局判断漫游”进行漫游场景配置。
测试步骤|用户从本地接入网络。RCP从SPR获取用户签约，用户签约了套餐1。用户漫游到外省接入网络。
通过准则|用户能够上线成功，匹配非漫游策略，下发本地业务规则。用户漫游到外省，匹配漫游策略，删除本地业务规则，并下发漫游地业务规则。
测试条目|基于SMF实例编号判断漫游
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-基于SMF实例编号判断漫游”进行漫游场景配置。
测试步骤|用户从本地接入网络，携带smfId=859675bc-59c8-424d-afca-030303000001。RCP从SPR获取用户签约，用户签约了套餐1。用户漫游到外省，携带smfId=859675bc-59c8-424d-afca-030300000001。
通过准则|用户能够上线成功，匹配非漫游策略，下发本地业务规则。用户漫游到外省，匹配漫游策略，删除本地业务规则，并下发漫游地业务规则。
测试条目|基于AMF实例编号判断漫游
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-基于AMF实例编号判断漫游”进行漫游场景配置。
测试步骤|用户从本地接入网络，携带servNfId->servNfInstId=9dcc2ec4-59c8-424d-afca-030303000001。RCP从SPR获取用户签约，用户签约了套餐1。用户漫游到外省携带servNfId->servNfInstId=9dcc2ec4-59c8-424d-afca-030300000001。
通过准则|用户能够上线成功，匹配非漫游策略，下发本地业务规则。用户漫游到外省，匹配漫游策略，删除本地业务规则，并下发漫游地业务规则。
测试条目|基于MCCMNC判断漫游
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-基于MCCMNC判断漫游”进行漫游场景配置。
测试步骤|1. 用户从本地接入网络，携带MCCMNC=460002。2. RCP从SPR获取用户签约，用户签约了套餐1。3. 用户漫游到外省，携带MCCMNC=460001。
通过准则|用户能够上线成功，匹配非漫游策略，下发本地业务规则。用户漫游到外省，匹配漫游策略，删除本地业务规则，并下发漫游地业务规则。
### 缩略语 
### 缩略语 
#### CGI 
Cell Global Identification小区全球识别码
#### ECGI 
E-UTRAN Cell Global IdentifierE-UTRAN小区全球标识
#### GUAMI 
Globally Unique AMF ID全球唯一AMF标识
#### HPLMN 
Home Public Land Mobile Network归属公众陆地移动网
#### MCC 
Mobile Country Code移动国家码
#### MNC 
Mobile Network Code移动网络号
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PLMN 
Public Land Mobile Network公共陆地移动网
#### SAI 
Service Area Identity业务区域标识
#### SGSN 
Serving GPRS Support Node服务GPRS支持节点
#### SGW 
Serving Gateway服务网关
#### TAI 
Tracking Area Identity跟踪区标识
#### ULI 
User Location Information用户位置信息
#### UUID 
Universal Unique Identifier全局唯一标识符
#### VPLMN 
Visited Public Land Mobile Network拜访公众陆地移动网
### ZUF-59-52-001 基于时段的策略 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|含义
---|---
时段|带有一定周期性的时间段，一般有起始时间点和结束时间点，用于标识业务的开始和结束时间。
##### 描述 
####### 特性定义 
时段策略是指RCP能基于时段提供差异化的控制策略，从而更好的引导用户使用网络。RCP可以将某个时段设置为系统忙/闲时段，或者将某个时段设置为某个套餐的忙/闲时段。 
RCP支持的时段设置非常灵活，能满足运营商不同的时段需求： 
基于日期：可以设置时段的开始日期和终止日期，例如2010年1月1号~2029年1月1号。 
基于时间：可以设置时段的开始时间和结束时间，例如00:08:00~00:20:00。 
基于星期：在日期的基础上，可以勾选星期几时段生效，例如2010年1月1号~2029年1月1号的周六、周日。 
基于第几天：在日期的基础上，可以勾选第几天时段生效，例如要求每个月1号时段生效，那么可以勾选第一天。 
####### 背景知识 
运营商的网络每天有忙时和闲时。忙时大量用户使用网络，其中一些用户频繁使用高带宽的网络应用（例如视频和BT下载），容易导致网络拥塞，影响其他用户体验。闲时使用网络的用户很少，网络利用率低，影响运营商收益。  
为了引导用户合理使用网络，满足大多数用户体验，提升运营商收益，运营商可以部署时段策略，例如忙时对下载类业务带宽限速，闲时所有业务流量资费优惠，从而引导用户在各时段均衡使用网络。 
##### 应用场景 
####### 忙闲时会话带宽控制 
对购买了月套餐的用户，为了防止少量用户在忙时过度使用网络，影响其他用户体验，忙时对月套餐用户设置一个能满足绝大多数用户带宽需求的会话带宽上限。闲时则提升月套餐用户的会话带宽上限，引导用户在闲时多使用网络。 
例如，每天忙时（07:00～22:00）对会话带宽限速10Mbps，闲时（22:00～07:00）对会话带宽限速100Mbps。 
####### 忙闲时业务带宽控制 
为了防止少量用户在忙时过度使用下载类业务（例如：BitTorrent），影响其他用户体验，忙时对所有用户设置下载类业务带宽限速3Mbps。闲时则取消下载类业务限速，引导用户在闲时使用下载类业务。 
例如，对下载类业务带宽，每天忙时（07:00～22:00）限速3Mbps，闲时1（22:00～00:00）限速6Mbps，闲时2（00:00～07:00）则取消限速。 
####### 忙闲时切换时触发用户下线 
在系统忙、闲状态发生切换时，为了做计费切换，运营商需要RCP触发已经在线的用户下线并重新上线。 
系统忙时：07:00～22:00，闲时：22:00～07:00。 
系统时间到达07:00时，使闲时上线的用户下线并重新上线。 
系统时间到达22:00时，使忙时上线的用户下线并重新上线。 
##### 客户收益 
受益方|受益描述
---|---
运营商|运营商针对网络忙闲状态，制定相应的控制策略，引导用户均衡使用网络，提升网络利用率。运营商可以进行差异化定价，推广空闲时段的优惠套餐，吸引更多用户。
用户|终端用户能在网络非高峰期享受低资费，并能享受更高的网络体验。

##### 实现原理 


 

###### 系统架构 
ZXUN RCP系统架构如[图1](1668762071433.html#z0f528759a3524312b56169902ac99fff__c214e878-ca2d-48c4-a291-a2b51ba7aa9f)所示，RCP作为PCF，在本特性相关流程中主要涉及和SMF交互。
图1  ZXUN RCP系统架构
[]images/rcp%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|描述
---|---
PCF|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，对AF业务进行策略授权，向AMF提供接入和移动性策略，向SMF提供PDU会话策略。其中PDU会话策略包含本特性所述时段规则。
AMF|向PCF提供UE接入信息，从PCF获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向PCF提供PDU会话信息，从PCF获取PDU会话策略，下发给UPF执行。其中PDU会话策略包含本特性所述时段规则。
UPF|执行PDU会话策略。
AF|向PCF提供应用层的业务信息，请求PCF进行策略授权。例如对于VoNR业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给PCF。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|PCF收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和PCF的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的PCF。
UDR/SPR|向PCF提供策略签约信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向PCF提供消费门限信息，例如通知PCF某用户的月累计流量是否超过了特定门限。
###### 业务流程 
######## 描述 
RCP可以通过N7接口向SMF下发会话级别或业务级别的时段规则，相关参数如下图所示。每个时段规则的起始时间（activationTime，简称AT）和结束时间（deactivationTime，简称DT）都是绝对时间点（精确到年月日时分秒），SMF在起始时间自动激活该时段规则，在结束时间自动去激活时段规则。 
[]images/n7%E6%97%B6%E6%AE%B5%E8%A7%84%E5%88%99.png)N7接口PCC规则可以是预定义PCC规则（RCP只下发pccRuleId）或动态PCC规则（除了pccRuleId外RCP还下发PCC规则的具体内容）。但如果对预定义PCC规则下发时段，则PCC规则中除pccRuleId外，还要下发refCondData，引用相关时段的condId。 
承载能力配置的“每业务时段规则数量”可以指定RCP对同一控制对象（N7会话，或N7会话中的一个业务）能同时下发的时段规则数量上限，取值N含义如下： 
N=0：表示只能下发当前时段的时段规则，此时时段规则不带起始时间和结束时间，在SMF上永久有效，时段策略切换时需要PCF参与（删除旧规则，安装新规则）才能切换到新的时段规则。 
N>0：表示最多能下发N个时段规则（N<=8），此时每个时段规则带起始时间和结束时间，但若其中最早的时段规则在RCP第一次决策输出该规则时为当前时段的的时段规则，则RCP不下发该时段规则的起始时间，表示此时段规则当前已生效。若当前时段没有时段规则，且RCP配置为支持下发不连续时段规则，则其中最早的时段规则是未来时段的时段规则。 
时段策略往往具有周期性，例如每天的忙时限速，闲时不限速，但RCP下发给SMF的时段规则的起始时间和结束时间都是绝对时间点，因此随着时间推进，RCP要不断下发新的时段规则。N7会话建立后，RCP支持三种方式下发新的时段规则： 
PUSH方式 
PULL方式 
混合方式 
上述三种方式，可以通过承载能力配置的“数据会话时段策略刷新方式”指定。该配置只影响数据会话，不影响语音会话（即会话APN在“IMS域APN配置”中有配置的会话）。语音会话不需要使用时段策略，语音会话配置了授权时长时就会按“当前时间点+授权时长”下发revalidationTime，起到会话周期性保活作用。对于数据会话，如果有时段策略，承载能力配置的“数据会话时段策略刷新方式”推荐使用混合方式。 
不论哪种模式，如果有其他事件触发RCP策略决策，RCP也可能随该事件流程下发新的时段规则。例如PUSH模式下，如果RCP配置为每业务最多下发2个时段规则，SMF在第2个时段规则生效期间，因为接入方式改变触发Npcf_SMPolicyControl_Update请求并上报最新接入方式给RCP，RCP也可以在响应中下发新的时段规则。 
######## PUSH方式 
这种方式下，RCP自己设置内部定时器控制时段规则的切换。当定时器到期，如果时段规则要更新，由RCP主动发送Npcf_SMPolicyControl_UpdateNotify请求给SMF，携带新的时段规则。 
这种方式下，每次策略决策时，RCP根据全局开关1104（规则刷新时间取值处理方式开关）取值确定如何设置上述内部定时器。 
取值0（用授权时长参与计算）：这时RCP会比较“当前时间点+会话授权时长”和“当前最晚时段规则的去激活时间点+1秒”，对齐较早者设置内部定时器。 
取值1（使用授权时长）：这时RCP仅按“当前时间点+会话授权时长”设置内部定时器。 
会话授权时长的配置参见“[本网元实现](1668762071433.html#z8044cd99b33e42b2a041cec41ddb993c)”的描述。不论全局开关1104采用哪种取值，如果未配置会话授权时长，则RCP对齐“当前最晚时段规则的去激活时间点+1秒”设置内部定时器。
例如：某用户某业务每天有3个时段规则，时段1区间[00:00:00，6:59:59]，时段2区间[07:00:00，21:59:59]，时段3区间[22:00:00，23:59:59]，RCP配置为对每业务最多下发2个时段规则，不配置会话授权时长。假设某用户在2022-08-10日00:30:00上线，SMF和PCF间的交互流程如下： 
[]images/push%E6%96%B9%E5%BC%8F.png)步骤说明： 
某用户在2022-08-10日00:30:00上线，SMF向RCP发送Npcf_SMPolicyControl_Create请求获取相关策略。 
RCP在Npcf_SMPolicyControl_Create响应中下发当日时段1和时段2规则，并对时段3的起始时间设置定时器。 
在时段3开始时，RCP定时器触发RCP用Npcf_SMPolicyControl_UpdateNotify请求下发当日时段3规则和次日时段1规则（因之前已下发当日时段1规则，此时只是更新规则1的起止时间），并删除当日时段2和规则。 
SMF回复Npcf_SMPolicyControl_UpdateNotify响应。 
######## PULL方式 
这种方式下，RCP自己不设置定时器控制时段规则的切换，而是下发revalidationTime给SMF，revalidationTime也是绝对时间点。SMF在revalidationTime到期时，向RCP发送Npcf_SMPolicyControl_Update请求，携带RE_TIMEOUT事件，触发RCP策略重决策。RCP可以在响应中下发新时段规则，以及新的revalidationTime。 
这种方式下，每次策略决策时，RCP根据全局开关1104（规则刷新时间取值处理方式开关）取值确定如何设置revalidationTime。 
取值0（用授权时长参与计算）：这时RCP会比较“当前时间点+会话授权时长”和“当前最晚时段规则的去激活时间点+1秒”，对齐较早者设置revalidationTime。 
取值1（使用授权时长）：这时RCP仅按“当前时间点+会话授权时长”设置revalidationTime。 
会话授权时长的配置参见“[本网元实现](1668762071433.html#z8044cd99b33e42b2a041cec41ddb993c)”的描述。不论全局开关1104采用哪种取值，如果未配置会话授权时长，则RCP对齐“当前最晚时段规则的去激活时间点+1秒”设置revalidationTime。
仍按上例，但改为PULL方式，并设置会话授权时长为4小时。SMF和PCF间的交互流程如下： 
[]images/pull%E6%96%B9%E5%BC%8F.png)步骤说明： 
某用户在2022-08-10日00:30:00上线，SMF向RCP发送Npcf_SMPolicyControl_Create请求获取相关策略。 
RCP在Npcf_SMPolicyControl_Create响应中下发当日时段1和时段2规则，并下发revalidationTime为当天4:30（按当前时间点00:30:00+会话授权时长4小时计算得出）。 
在当天4:30，SMF因revalidationTime到期时触发Npcf_SMPolicyControl_Update请求。 
因当前仍在当天时段1内，RCP回复Npcf_SMPolicyControl_Update响应没有下发新的时段规则，但更新revalidationTime为当天8:30。 
在当天8:30，SMF因revalidationTime到期时触发Npcf_SMPolicyControl_Update请求。 
RCP判断此时已进入时段2，之前下发的时段1规则已失效，于是在Npcf_SMPolicyControl_Update响应中删除当天时段1规则，下发当天时段3规则（当天时段2规则之前已下发，所以不用再下发），这样在SMF侧可用的时段规则仍有2个（当天时段2规则、当天时段3规则），此外响应中还包含新的revalidationTime为当天12:30。 
######## 混合方式 
混合方式即上述两种方式的混合，RCP通过下发revalidationTime触发SMF通过Npcf_SMPolicyControl_Update交互拉取新时段规则。但对revalidationTime前未下发的时段规则，RCP也可以在该时段规则起始时间点通过发送Npcf_SMPolicyControl_UpdateNotify请求推送给SMF。 
这种方式下，每次策略决策时，RCP不看全局开关1104（规则刷新时间取值处理方式开关）取值，按“当前时间点+会话授权时长”设置revalidationTime。但如果未配置会话授权时长，则对齐“当前最晚时段规则的去激活时间点+1秒”设置revalidationTime。 
仍按上例，但改为混合方式，且会话授权时长改为20小时。SMF和PCF间的交互流程如下： 
[]images/%E6%B7%B7%E5%90%88%E6%96%B9%E5%BC%8F.png)步骤说明： 
某用户在2022-08-10日00:30:00上线，SMF向RCP发送Npcf_SMPolicyControl_Create请求获取相关策略。 
RCP在Npcf_SMPolicyControl_Create响应中下发当日时段1和时段2规则，并下发revalidationTime为当天20:30（按当前时间点00:30:00+会话授权时长20小时计算得出）。 
在当天20:30，SMF因revalidationTime到期时触发Npcf_SMPolicyControl_Update请求。 
RCP判断此时已进入时段2，之前下发的时段1规则已失效，于是在Npcf_SMPolicyControl_Update响应中删除当天时段1规则，下发当天时段3规则（当天时段2规则之前已下发，所以不用再下发），这样在SMF侧可用的时段规则仍有2个（当天时段2规则、当天时段3规则），此外响应中还包含新的revalidationTime为次日16:30（按当前时间点20:30:00+会话授权时长20小时计算得出）。 
 说明： 
如果采用PULL模式，此流程RCP会错过次日16:00:00前的时段1和时段2规则。 
因为采用混合模式，RCP判断下发revalidationTime前有未下发的时段规则，因此RCP自行设置定时器，在次日00:00:00主动推送次日时段1和时段2规则，这样不会错过任何时间段的规则。 
###### 本网元实现 
######## 连续时段和不连续时段规则 
全局开关1060（决策不连续时段的规则开关）用于控制RCP对同一控制对象（N7会话，或N7会话中的一个业务）是否支持输出不连续的时段规则，默认值“0-不支持”表示只能下发连续时段的时段规则，这时如果某个控制对象在某个时段没有时段规则，RCP对该控制对象不会提前下发该时段之后的时段规则。 
例如时段1区间[00:00:00，6:59:59]，时段2区间[07:00:00，21:59:59]，时段3区间[22:00:00，23:59:59]是3个连续时段。当某控制对象在时段1和时段3有时段规则，而时段2没有时段规则时，同一天的时段1规则和时段3规则就是不连续的时段规则，但当天的时段3规则和第二天的时段1规则是连续的时段规则。 
如果用户在00:30:00上线，承载能力配置的“每业务时段规则数量”配置为2。 
当全局开关1060配置为“1-支持”时，RCP在会话建立响应中下发当天时段1和时段3的时段规则。 
当全局开关1060配置为“0-不支持”时，RCP在会话建立响应中仅下发时段1的时段规则。 
SMF一般不支持同时下发多个同名但不同时段的规则，因此要小心配置承载能力配置的“每业务时段规则数量”，特别是针对不连续时段场景。例如： 
每天忙时8:00~22:00对P2P业务限速，对应的PCC规则名为P2P_Limit。 
每天闲时22:00~8:00取消P2P业务限速，这时P2P业务没有对应的PCC规则。 
上述P2P业务每天只有一个不连续的时段规则，如果RCP配置为支持决策不连续时段规则，且“每业务时段规则数量”设置为2，则RCP就会为P2P业务一次下发2个PCC规则，名称都是P2P_Limit，只是起止时间不同，这在SMF可能无法处理。规避方法是把RCP配置为不支持决策不连续时段的规则，或把“每业务时段规则数量”设置为1。 
######## 会话授权时长 
RCP可以按“当前时间点+会话授权时长”设置PUSH方式的内部定时器，或PULL/混合方式的revalidationTime，具体参见“[业务流程](1668762071433.html#zb9d5345ee0f24f268802c1b05afb6932)”。
会话授权时长在RCP有3个配置项： 
配置1：策略配置会话参数集的“授权时长”，用于配置特定会话（可按DNN、套餐等区分）的授权时长。 
配置2：会话授权时长默认配置，用于配置系统默认的会话授权时长。 
配置3：会话授权时长特定配置，用于配置特定异常场景（PCF向BSF注册N7会话绑定信息失败，PCF向CHF/OCS建立N28/Sy会话失败）的会话授权时长。 
配置1和配置2通常用于会话周期性保活和刷新时段规则。 
配置3的会话授权时长通常设置较短（例如10~30分钟），用于会话处于特定异常场景（PCF向BSF注册N7会话绑定信息失败，PCF向CHF/OCS建立N28/Sy会话失败）时，RCP根据此配置计算出较短的revalidationTime下发给SMF。在revalidationTime到期时，SMF发送Npcf_SMPolicyControl_Update请求，触发RCP重试向CHF或BSF注册，尽快使会话恢复正常。
对一个具体会话，如果配置1和配置2都存在，则使用配置1的会话授权时长。但如果配置3也存在，当如下条件同时满足时，则使用配置3的会话授权时长。 
该会话当前处于配置3所规定的特定场景（例如会话向BSF或CHF注册失败）。 
该会话允许下发revalidationTime（该会话是语音会话，或该会话是数据会话但使用PULL或混合模式）。 
配置3的授权时长更短时。 
######## revalidationTime 
RCP下发给SMF的revalidationTime（简称RT）是绝对时间点（精确到年月日时分秒）。SMF在RT到期时，向RCP发送Npcf_SMPolicyControl_Update请求，携带RE_TIMEOUT事件，触发RCP策略重决策。RCP可以在响应中下发新时段规则，以及新的RT。 
数据会话在承载能力配置的“数据会话时段策略刷新方式”为PULL或混合方式下： 
如果配置了时段规则或会话授权时长，就可下发RT。 
如果配置了时段规则而未配置会话授权时长，则RCP对齐“当前最晚时段规则的去激活时间点+1秒”设置RT。 
如果配置了时段规则同时也配置会话授权时长，按如下逻辑设置RT：PULL模式，RCP根据全局开关1104（规则刷新时间取值处理方式开关）取值确定如何计算RT。取值0（用授权时长参与计算）：这时RCP会比较“当前时间点+会话授权时长”和“当前最晚时段规则的去激活时间点+1秒”，对齐较早者设置RT。取值1（使用授权时长）：这时RCP按“当前时间点+会话授权时长”设置RT。混合模式，RCP不看全局开关1104取值，按“当前时间点+会话授权时长”设置RT。 
语音会话只要配置了会话授权时长，就可以按“当前时间点+会话授权时长”下发RT。 
在RCP按“当前时间点+会话授权时长”计算并下发RT时，外部事件（例如签约变更）触发RCP策略重决策，可能仅需要推迟RT（重新计算的RT较之前RT更晚）而无其他策略变化。RCP的全局开关1229（规则无变化时是否主发通知推迟Revalidation-Time）控制此场景是否推迟RT，默认值0表示不推迟，在这种场景下就不会更新RT，这样可以减少RCP和SMF间交互。 
N7会话无交互时长超过“网元间保活检测配置”的“保活周期”时，RCP会发起主动保活，即RCP向SMF下发不带策略的UpdateNotify请求，根据SMF的UpdateNotify响应确定N7会话是否存活。需要注意的是，RCP不会在主动保活UpdateNotify请求中下发RT。因此，当RCP按“当前时间点+会话授权时长”计算并下发RT时，建议“会话授权时长”配置值小于“保活周期”配置值，否则N7会话交互次数可能翻倍，不同配置下的N7交互流程差异对比如下。 
配置方法|N7会话交互流程|是否推荐
---|---|---
“会话授权时长”配置值小于“保活周期”配置值|40SMF请求建立N7会话建立，RCP在响应中基于“当前时间点+会话授权时长”下发RT，并基于“当前时间点+保活周期”设置RCP主动保活N7会话的时间点。RT到期，SMF触发RE_TIMEOUT事件上报，RCP在响应中基于“当前时间点+会话授权时长”下发新的RT，并重新基于“当前时间点+保活周期”设置RCP主动保活N7会话的时间点。因“会话授权时长”小于“保活周期”，步骤2重复出现，SMF和RCP间总是先触发RE_TIMEOUT交互，使得RCP始终不会触发N7会话主动保活，但N7会话通过周期性的RE_TIMEOUT交互也可以保活。|是
“会话授权时长”配置值大于等于“保活周期”配置值|SMF请求建立N7会话建立，RCP在响应中基于“当前时间点+会话授权时长”下发RT，并基于“当前时间点+保活周期”设置RCP主动保活N7会话的时间点。N7会话无交互超“保活周期”时，RCP主动保活N7会话，并基于“当前时间点+保活周期”重新设置RCP主动保活N7会话的时间点，但主动保活流程不更新RT。RT到期，SMF触发RE_TIMEOUT事件上报，RCP在响应中基于“当前时间点+会话授权时长”下发RT，并重新基于“当前时间点+保活周期”确定RCP主动保活N7会话的时间点。因“会话授权时长”大于等于“保活周期”，步骤2和3重复出现，SMF和RCP间总是先触发RCP主动保活N7会话，再触发RE_TIMEOUT交互，交互次数较上一种配置方法翻倍。|否
######## 时区 
用户的时间都是有时区概念的，系统进行时段控制的时候，采用的时区可以是用户所在时区也可以是系统时区。 

时区的选择涉及两部分： 
规则相关的时区选择规则相关时区可选择系统时区，也可选择Npcf_SMPolicyControl_Create消息中ueTimeZone携带的时区。当全局开关1014取值为0时，代表规则相关时区采用系统时区。当全局开关1014取值为1时，采用Npcf_SMPolicyControl_Create/Update请求消息中ueTimeZone携带的时区；若消息中未携带时区信息，则使用系统时区。系统时区可通过SHOW TIMEZONE查询，并通过SET TIMEZONE来修改（如系统时区配置为东8区，SET TIMEZONE:TIMEZONE="GMTE0800"）。 
用量及短信相关的时区用量及短信相关的时区选择比较简单，只选择系统时区。 
######## 其他与时段相关的策略切换场景 
承载能力配置的“数据会话时段策略刷新方式”定义的PULL/PUSH/混合模式，适用于在RCP策略配置中定义的时段及相关策略规则。除此之外，RCP还有如下时段相关的策略切换场景，这些场景下，RCP只能采用PUSH模式。 
套餐有效期。例如用户签约的套餐在将来生效或失效，RCP在相应时间点使套餐策略生效或失效。 
周期性用量。例如月用量在第二个月初要清理，月套餐用户如果因月用量达到限速门限被限速后，在第二个月初要恢复速率。 
Sy接口相关时段。RCP收到Sy SLA/SNR消息时，若消息中携带了Pending-Policy-Counter-Change-Time指示在未来某个时间点切换策略计数器状态，则RCP会在相应时间点根据新的策略计数器状态重新做策略决策。 
RCP对每业务生成时段PCC规则的逻辑是： 
按会话上下文评估出所有匹配的策略场景。 
对所有匹配的策略场景下的所有策略规则，按策略规则的优先级从高到低，评估是否匹配策略条件表达式，匹配则执行相应动作，生成PCC规则，剩余策略规则不再评估。 
在评估策略条件表达式时，无论该条件表达式是否匹配，只要涉及时段条件（因为当前时间不匹配时段条件时也可能要提前下发该时段PCC规则），就会取出时段起止时间，用于生成时段PCC规则的起止时间。 
因此，在RCP策略配置中定义业务相关的时段策略时，如果一个策略场景中包含不同业务的时段策略，可能引发非预期结果。例如，套餐A中： 
业务1在任何时段保持限速1Mbps。 
业务2在忙时08:00~22:00限速3Mbps，闲时不限速。 
如果把这两个业务策略配在同一个策略场景下（例如策略场景为：套餐ID=A），且策略规则优先级一样，则业务1也可能下发08:00~22:00和22:00~08:00的时段规则。 
对此问题有两种解决方案： 
方案一：把不同业务拆到不同场景中配置（例如业务1的策略场景为：套餐ID=A&业务ID=1。业务2的策略场景为：套餐ID=A & 业务ID=2）。 
方案二：把时段策略规则优先级调低，避免对非时段策略产生影响。 
##### 系统影响 
在PUSH模式下，当大量用户同时在线，若RCP配置为只下发当前时段规则，在忙闲切换时间点，RCP会触发大量的Npcf_SMPolicyControl_UpdateNotify交互，RCP根据1052开关控制Npcf_SMPolicyControl_UpdateNotify发送速率，减轻系统过负荷的风险，这可能导致时段规则延后下发到SMF。 
如果RCP的CPU/数据区过负荷等级达到一级，则RCP不会发出Npcf_SMPolicyControl_UpdateNotify请求，这会导致时段策略不能及时切换。 
当启用时段策略时，建议时段策略刷新方式配置为混合模式，时段规则数量配置为2，会话授权时长配置值小于各时段区间长度，这样可以避开忙闲时提前且离散下发时段规则，减少系统过负荷风险。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 29.512|Session Management Policy Control Service
##### 特性能力 
名称|指标
---|---
每业务时段规则的最大数量|8条
##### 可获得性 
####### License要求 
该特性是RCP网元的基本功能，无需License的支持。 
####### 对其他网元的要求 
该特性是RCP网元的基本功能，对其他网元无要求。 
##### O&M相关 
###### 命令 
######## 配置项 
在策略配置GUI中配置时段策略，步骤如下： 
配置时段。其中“时段属性”的取值有：正常、系统忙时、系统闲时、套餐忙时、套餐闲时。如果使用套餐忙时或套餐闲时，要填上套餐标识。 
[]images/%E9%85%8D%E7%BD%AE%E9%A1%B91.png)
配置好时段后，就可以在策略规则的条件定义中引用时段。 
[]images/%E9%85%8D%E7%BD%AE%E9%A1%B92.png)
如果是“时段属性”为“系统忙时”或“系统闲时”，在策略条件定义中可以直接引用“系统忙闲时属性”。 
[]images/%E9%85%8D%E7%BD%AE%E9%A1%B93.png)
如果是“时段属性”为“套餐忙时”或“套餐闲时”，需要创建相应的“套餐忙闲时段状态标识”类型的自定义策略变量。 
[]images/%E9%85%8D%E7%BD%AE%E9%A1%B94.png)
在策略条件定义中引用上述自定义策略变量。 
[]images/%E9%85%8D%E7%BD%AE%E9%A1%B95.png)
其他与时段策略相关的全局配置： 
承载能力配置的“数据会话时段策略刷新方式”（参数名REVALIDTIME）取值如下，推荐混合方式。NO：PUSH方式YES：PULL方式MIX：混合方式 
承载能力配置的“每业务时段规则数量”（参数名TIMERULENUM）规定了RCP针对一个控制对象（一个N7会话，或会话中的一个业务）能同时下发的时段规则数量上限，推荐值为2。 
######## 全局变量 
参数编号|参数名称|最小值|最大值|缺省值|含义
---|---|---|---|---|---
1014|时区和夏令时获取来源|0|1|1|时区和夏令时获取来源。0-从当前系统中获取时区和夏令时信息。1-从CCR消息的3GPP-MS-TimeZone中获取时区和夏令时信息。
1052|消息流控参数|1|100|10|消息流控参数。
1059|规则激活/去激活时间区间开关|0|1|0|0-闭区间1-左闭右开
1060|决策不连续时段的规则开关|0|1|0|0-不支持1-支持
1061|当前时段业务规则是否下发Rule-Activation-TimeAVP开关|0|1|0|0-不携带1-携带
1104|规则刷新时间取值处理方式开关|0|1|0|0-用授权时长参与计算1-使用授权时长
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
该特性不涉及告警消息的变化。 
#### 特性配置 

#### 特性配置 


 


##### 配置特性 


 

###### 配置说明 
RCP的时段特性配置功能包括： 
通过配置时段条件，并在规则的条件表达式中引用该条件，达到在特定时间内下发特定规则的目的。 
通过配置动作参数中的授权时长控制特定规则的revalidationTime，在revalidationTime到期后，对端网元发送更新请求消息来获取新的规则，达到在特定时间后对端网元发送更新请求获取新的规则的目的。若动作参数中未配置授权时长，也可以通过会话授权时长默认配置中配置授权时长默认值。 
通过配置承载能力配置中的“数据会话时段策略发送方式”，修改更新规则信息为主动下发、被动下发或者混合模式，达到在对端网元和PCF都可以触发规则更新的目的。 
通过配置决策不连续时段的规则开关，达到控制是否同时下发不连续时段规则的目的。 
###### 配置前提 
时段的特性是RCP和SMF配合共同完成的，因此在配置此特性之前保证两个网元的功能及交互正常。同时需要两个网元之间协商配合模式：通过主动下发模式、被动下发模式还是混合模式。 
###### 配置过程 
基于时段的策略特性配置过程如[图1](1669114308772.html#zd35a9082a58c44e099239c30fee30bd6__05f3df08-2a57-4aff-ad07-4eb7acd03e5f)所示。
图1  配置过程
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)
配置过程包含如下几个步骤： 
在RCP网管中，执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，配置承载能力中的数据会话时段策略发送方式。
在RCP网管中，执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，配置决策不连续时段的规则开关1060。
在RCP网管中，执行[SET SESSAUTHPRDDEF](../../Npcf_PolicyManagement\zh-CN\mml\1788288.html)命令，配置会话授权时长默认值。
在RCP网管中，执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐等基础信息。
配置策略： 
配置时段信息。 
配置规则条件。 
配置规则动作参数。 
配置场景。 
配置规则。 
###### 配置实例1-忙闲时切换踢用户下线 
######## 场景描述 
在忙闲时切换的时间点之前上线的用户将被踢下线。通过PUSH模式更新时段规则。 
场景说明参见下表。 
策略类型|控制条件（&=And、|=Or、~=Not)|决策参数
---|---|---
会话控制策略|时间=忙时（07:00-22:00）&& 会话上线时间 !=  忙时（07:00-22:00）|拒绝接入
时间=闲时（22:00-次日07:00）&& 会话上线时间 != 闲时（22:00-07:00）|会话控制策略|拒绝接入
######## 数据规划 
数据规划参见下表： 
时段|时间
---|---
忙时|07:00-22:00
闲时|22:00-次日07:00
######## 配置步骤 
配置基础信息
执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，设置承载能力为PUSH模式，每业务时段下发规则数量为0。
SET BEARABILITY:ADJHOSTGRPID=1,INTERFACE="PGW",TIMERULENUM=0,REVALIDTIME="NO"; 
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，设置1060开关为开，支持下发不连续时段规则。
SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC"; 
执行[SET SESSAUTHPRDDEF](../../Npcf_PolicyManagement\zh-CN\mml\1788288.html)命令，修改默认授权时长配置为4小时。
SET SESSAUTHPRDDEF:N7IMSAUTHPRD=240,N7DATAAUTHPRD=240,GXIMSAUTHPRD=240,GXDATAAUTHPRD=240,AUTHPRDMAXOFFSET=0; 
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，增加套餐基本配置。
ADD PKGINFO:PKGID="1",PRIORITY=1; 
配置实例——基于时间段的策略控制
配置时段。 
时段名称|参数|取值
---|---|---
07～22|时段属性|系统忙时
起始时间|07～22|07:00:00
结束时间|07～22|22:00:00
配置条件。 
配置系统时段条件 
条件名称|参数|取值
---|---|---
TimeIn07～22|选择策略变量|其他
策略变量类别|TimeIn07～22|系统类
操作符|TimeIn07～22|TimeIn
值类型|TimeIn07～22|值
值|TimeIn07～22|07～22
配置会话上线时间条件 
条件名称|参数|取值
---|---|---
online_time|选择策略变量|其他
策略变量类别|online_time|IP-CAN会话信息类
策略变量|online_time|会话Init-Time
操作符|online_time|TimeIn
值类型|online_time|值
值|online_time|07～22
配置会话控制策略。 
当前时段为闲时，用户登录时间为忙时。 
规则名称|参数|取值
---|---|---
reject_1|优先级|10
动作类型|reject_1|拒绝
日志开关|reject_1|关闭
选中条件名称|reject_1|~{时间TimeIn TimeIn07～22} & {会话Init-Time TimeIn online_time }（按名称）
当前时段为忙时，用户登录时间为闲时。 
规则名称|参数|取值
---|---|---
reject_2|优先级|10
动作类型|reject_2|拒绝
日志开关|reject_2|关闭
选中条件名称|reject_2|~{会话Init-Time TimeIn online_time } &{时间TimeIn TimeIn07～22}（按名称）
配置场景。 
配置场景规则关联。 
场景名称|参数|取值
---|---|---
Busy_idle|入口1|入口类型|空
已选入口|Busy_idle|入口1|空
取值|Busy_idle|入口1|空
策略类型|Busy_idle|会话控制策略|reject_1
reject_2|策略类型|Busy_idle|会话控制策略
###### 配置实例2-忙闲时会话带宽控制 
######## 场景说明 
用户签约套餐1。07:00~22:00为忙时，其他时间段为闲时，在07:00~22:00限制会话带宽10Mbps。其余时段限制会话带宽到100Mbps。PULL模式更新会话规则。 
场景说明参见下表。 
策略类型|控制条件（&=And、|=Or、~=Not)|决策参数
---|---|---
会话控制策略|时间=闲时（22:00-07:00）|Rule_idle
时间=忙时（07:00-22:00）|会话控制策略|Rule_busy
######## 数据规划 
数据规划参见下表。 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
规则|闲时|Rule_idle
忙时|规则|Rule_busy
######## 业务配置关系图 
业务配置关系图如下图所示。 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB%E5%9B%BE.png)
######## 配置步骤 
配置基础信息
执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，设置承载能力为PULL模式，每业务时段下发规则数量为0。
SET BEARABILITY:ADJHOSTGRPID=1,INTERFACE="PGW",TIMERULENUM=0,REVALIDTIME="YES"; 
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，设置1060开关为开，支持下发不连续时段规则。
SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC"; 
执行[SET SESSAUTHPRDDEF](../../Npcf_PolicyManagement\zh-CN\mml\1788288.html)命令，修改默认授权时长配置为4小时。
SET SESSAUTHPRDDEF:N7IMSAUTHPRD=240,N7DATAAUTHPRD=240,GXIMSAUTHPRD=240,GXDATAAUTHPRD=240,AUTHPRDMAXOFFSET=0; 
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，增加套餐基本配置。
ADD PKGINFO:PKGID="1",PRIORITY=1; 
配置实例——基于时间段的策略控制
配置时段。 
时段名称|参数|取值
---|---|---
07～22|时段属性|系统忙时
起始时间|07～22|07:00:00
结束时间|07～22|22:00:00
配置条件。 
配置时段条件。 
条件名称|参数|取值
---|---|---
Time_Busy|选择策略变量|其他
策略变量类别|Time_Busy|系统类
操作符|Time_Busy|TimeIn
值类型|Time_Busy|值
值|Time_Busy|07～22
配置策略动作参数。 
配置N7会话参数集，闲时： 
动作参数名称|参数名称|取值
---|---|---
Sess_idle|动作参数类型|N7会话参数集
会话参数名称|Sess_idle|Sess_100M
会话AMBR上行速率|Sess_idle|100000
会话AMBR下行速率|Sess_idle|100000
配置N7会话参数集，忙时： 
动作参数名称|参数名称|取值
---|---|---
Sess_busy|动作参数类型|N7会话参数集
会话参数名称|Sess_busy|Sess_10M
会话AMBR上行速率|Sess_busy|10000
会话AMBR下行速率|Sess_busy|10000
配置策略规则。 
配置N7会话控制策略，闲时： 
规则名称|参数名称|取值
---|---|---
Rule_idle|优先级|10
策略类型|Rule_idle|N7会话控制策略
动作类型|Rule_idle|参数填充
日至开关|Rule_idle|关闭
条件|Rule_idle|~{时间 TimeIn 07~22}
动作|Rule_idle|Sess_idle
配置N7会话控制策略，忙时： 
规则名称|参数名称|取值
---|---|---
Rule_busy|优先级|10
策略类型|Rule_busy|N7会话控制策略
动作类型|Rule_busy|参数填充
日至开关|Rule_busy|关闭
条件|Rule_busy|{时间 TimeIn 07~22}
动作|Rule_busy|Sess_busy
配置策略场景。 
配置场景规则关联配置。 
场景名称|参数|取值
---|---|---
Busy_idle|入口1|入口类型|用户信息类
已选入口|Busy_idle|入口1|用户套餐
取值|Busy_idle|入口1|1
策略类型|Busy_idle|N7会话控制策略|Rule_idle
|策略类型|Busy_idle|Rule_busy
###### 配置实例3-忙闲时业务带宽控制 
######## 场景说明 
用户签约套餐1，包含BT业务。在07:00~22:00限制BT业务带宽到3Mbps，在22:00~00:00限制BT业务带宽到6Mbps，其余时段限制取消限速。N7接口采用预定义规则。混合模式更新业务规则。 
场景说明参加下表。 
策略类型|控制条件（&=And、|=Or、~=Not)|决策参数
---|---|---
业务= BT|时间=闲时1（22:00-00:00）|BT_6M
时间=闲时2（00:00-07:00）|业务= BT|不限速
时间=忙时（07:00-22:00）|业务= BT|BT_3M
会话控制策略|无|SESSION
######## 数据规划 
数据规划参加下表。 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
时段|07:00-22:00|忙时
22:00-00:00|时段|闲时1
业务|BT|APPID=1001
规则|BT闲时1|BT_6M
BT闲时2|规则|不限速
BT忙时|规则|BT_3M
######## 业务配置关系图 
业务配置关系图如下图所示。 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB%E5%9B%BE3.png)
######## 配置步骤 
配置基础信息
执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，设置承载能力为混合模式，每业务时段下发规则数量为0。
SET BEARABILITY:ADJHOSTGRPID=1,INTERFACE="PGW",TIMERULENUM=0,REVALIDTIME="MIX"; 
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，设置1060开关为开，支持下发不连续时段规则。
SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC"; 
执行[SET SESSAUTHPRDDEF](../../Npcf_PolicyManagement\zh-CN\mml\1788288.html)命令，修改默认授权时长配置为4小时。
SET SESSAUTHPRDDEF:N7IMSAUTHPRD=240,N7DATAAUTHPRD=240,GXIMSAUTHPRD=240,GXDATAAUTHPRD=240,AUTHPRDMAXOFFSET=0; 
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，增加套餐基本配置。
ADD PKGINFO:PKGID="1",PRIORITY=1; 
执行[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html)命令，增加套餐业务配置。
ADD PKGSVC:ID=1,PKGID="1",SUBSID="1"; 
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，增加应用标识。 
ADD APPSUBS:APPID=1001,APPDESC="BT",SUBSID="1",SUBSDESC="1"; 
配置实例——基于时间段的策略控制
配置时段。 
时段名称|参数|取值
---|---|---
07～22|时段属性|系统忙时
起始时间|07～22|07:00:00
结束时间|07～22|22:00:00
22～00|时段属性|系统闲时1
起始时间|22～00|22:00:00
结束时间|22～00|00:00:00
配置条件。 
配置时段条件。 
条件名称|参数|取值
---|---|---
Time_busy|选择策略变量|其他
策略变量类别|Time_busy|系统类
操作符|Time_busy|TimeIn
值类型|Time_busy|值
值|Time_busy|07～22
Time_idle|选择策略变量|其他
策略变量类别|Time_idle|系统类
操作符|Time_idle|TimeIn
值类型|Time_idle|值
值|Time_idle|22～00
配置业务条件。 
条件名称|参数|取值
---|---|---
gx_appid_1001|选择策略变量|其他
策略变量类别|gx_appid_1001|IP-CAN会话信息类
策略变量|gx_appid_1001|Gx应用标识
操作符|gx_appid_1001|=
值类型|gx_appid_1001|值
值|gx_appid_1001|1001
配置策略动作参数相关。 
业务预下发参数集。 
动作参数名称|参数名称|取值
---|---|---
ACT_PRE|动作参数类型|预下发业务参数集
应用标识|ACT_PRE|1001
业务控制策略动作参数，BT闲时1。 
规则名称|参数名称|取值
---|---|---
bt_idle|动作参数类型|N7 PCC规则参数集
业务规则类型|bt_idle|预定义规则
规则名|bt_idle|BT_6M
业务控制策略动作参数，BT忙时。 
规则名称|参数名称|取值
---|---|---
bt_busy|动作参数类型|N7 PCC规则参数集
业务规则类型|bt_busy|预定义规则
规则名|bt_busy|BT_3M
会话控制策略动作参数。 
动作参数名称|参数名称|取值
---|---|---
SESSION|动作参数类型|N7会话参数集
会话规则名称|SESSION|Session
配置策略规则。 
业务预下发控制策略。 
规则名称|参数名称|取值
---|---|---
Rule_Pre|优先级|10
策略类型|Rule_Pre|业务预下发控制策略
动作类型|Rule_Pre|参数填充
日至开关|Rule_Pre|关闭
条件|Rule_Pre|-
动作|Rule_Pre|ACT_PRE
N7业务控制策略，BT闲时1。 
规则名称|参数名称|取值
---|---|---
Rule_idle|优先级|10
策略类型|Rule_idle|N7业务控制策略
动作类型|Rule_idle|参数填充
日至开关|Rule_idle|关闭
条件|Rule_idle|{时间 TimeIn 22~00}&{Gx应用标识 = 1001}
动作|Rule_idle|bt_idle
N7业务控制策略，BT忙时。 
规则名称|参数名称|取值
---|---|---
Rule_busy|优先级|10
策略类型|Rule_busy|N7业务控制策略
动作类型|Rule_busy|参数填充
日至开关|Rule_busy|关闭
条件|Rule_busy|{时间 TimeIn 19~22}&{Gx应用标识 = 1001}
动作|Rule_busy|bt_busy
会话控制策略动作参数。 
规则名称|参数名称|取值
---|---|---
Rule_session|优先级|10
策略类型|Rule_session|N7会话控制策略
动作类型|Rule_session|参数填充
日至开关|Rule_session|关闭
条件|Rule_session|-
动作|Rule_session|SESSION
配置策略场景相关。 
场景规则关联配置。 
场景名称|参数|取值
---|---|---
Busy_idle|入口1|入口类型|用户信息类
已选入口|Busy_idle|入口1|用户套餐
取值|Busy_idle|入口1|1
策略类型|Busy_idle|业务预下发控制策略|Rule_Pre
业务控制策略|策略类型|Busy_idle|Rule_idle
Rule_busy|业务控制策略|策略类型|Busy_idle
会话控制策略|策略类型|Busy_idle|Rule_session
##### 测试用例 
####### 基于时间段的策略控制 
测试条目|基于时间段的策略控制
---|---
预置条件|系统正常运行。前后台通讯正常，GUI正常运行。配置时段规则：07:00~22:00为忙时。22:00~07:00为闲时。在07:00~22:00限制会话带宽10Mbps。其余时段限制会话带宽到100Mbps。PULL模式更新会话规则。承载能力配置支持的每业务时段规则数为0，支持Revalidation-Time。SET BEARABILITY:REVALIDTIME="YES";设置全局变量1104为0：SET SYS GLOBPARA:IDX=1104,CURVAL="0",3=0;执行SET SYS GLOBPARA命令，设置1060开关为开，支持下发不连续时段规则。SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC";配置“规则去激活时间右区间开关”为“0-关闭”。
测试步骤|06:30分用户上线。修改时间到7:00，SMF发送Update Req消息，重决策。修改时间到11:30，SMF发送Update Req消息。修改时间到15:30，SMF发送Update Req消息。修改时间到19:30，SMF发送Update Req消息。修改时间到次日00:30，SMF发送Update Req消息。修改时间到19:00，重决策后，下线。
通过准则|06:30分用户上线，下发业会话规则：Sess_100M，Revalidation-Time为23:00。修改时间到07:30，下发会话规则：Sess_10M，Revalidation-Time为03:30。修改时间到11:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为07:30。修改时间到15:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为11:30。修改时间到19:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为15:30。修改时间到次日00:30，重决策下发会话规则：Sess_100M，Revalidation-Time为次日 20:30，用户下线正常。信令跟踪正常，每个测试步骤中观察向ATM注册的时段个数正确。
信令流程|06:30分用户上线，下发业会话规则：Sess_100M，Revalidation-Time为23:00。修改时间到07:30，下发会话规则：Sess_10M，Revalidation-Time为03:30。修改时间到11:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为07:30。修改时间到15:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为11:30。修改时间到19:30，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为15:30。修改时间到次日00:30，重决策下发会话规则：Sess_100M，Revalidation-Time为次日 20:30。用户下线。
####### 忙闲时业务带宽控制 
测试条目|忙闲时业务带宽控制——用正常的3个时段，混合模式，RT=4小时
---|---
预置条件|“承载能力配置”的“数据会话时段策略刷新方式”为“0-混合”。N7 Data会话授权时长（分）=360，偏移0分钟。承载能力中，“每业务时段规则数量”为2。1229开关为0。执行SET SYS GLOBPARA命令，设置1060开关为开，支持下发不连续时段规则。SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC";新增业务套餐2、套餐2业务1。删除基线中业务1，业务2配置。GUI配置：预下发业务1001，下载类业务带宽。每天：忙时（07:00～22:00）限速3Mbps。闲时1（22:00～00:00）限速6Mbps。闲时2（00:00～07:00）则取消限速。
测试步骤|用户20220705 07:00N7会话上线，签约用户套餐1、业务套餐2。修改时间到20220705 6:30。修改时间到20220705 07:00。修改时间到20220705 11:00。修改时间到20220705 15:00。修改时间到20220705 19:00。修改时间到20220705 22:00:10。修改时间到20220706 00:00:10。N7会话更新，上报RT_Timeout。N7会话离线。
通过准则|20220705 06:30 N7会话上线成功，并下发N7 规则DL_idel2， AMBR=1GB，RT=20220705 02:30。修改时间到20220705 07:00，触发PCF重决策，下发Update Resp消息携带DL_3M，AMBR=3M，Revalidation-Time为03:00。 修改时间到20220705 11:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为07:00。 修改时间到20220705 15:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为10:00。 修改时间到20220705 19:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为15:00。 修改时间到20220705 22:00:05，触发PCF重决策，下发Update Resp消息携带DL_6M，AMBR=6M，Revalidation-Time为18:00。修改时间到20220706 00:00:05，触发PCF重决策，下发Update Resp消息携带规则DL_idel2，AMBR=1GB，Revalidation-Time为20220706 20:00。N7会话更新，上报RT_Timeout，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为20:00。 N7会话离线成功。
信令流程|20220705 06:30 N7会话上线，并下发N7 规则DL_idel2， AMBR=1GB，RT=20220705 02:30。修改时间到20220705 07:00，触发PCF重决策，下发Update Resp消息携带DL_3M，AMBR=3M，Revalidation-Time为03:00。 修改时间到20220705 11:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为07:00。 修改时间到20220705 15:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为10:00。 修改时间到20220705 19:00，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为15:00。 修改时间到20220705 22:00:05，触发PCF重决策，下发Update Resp消息携带DL_6M，AMBR=6M，Revalidation-Time为18:00。修改时间到20220706 00:00:05，触发PCF重决策，下发Update Resp消息携带规则DL_idel2，AMBR=1GB，Revalidation-Time为20220706 20:00。N7会话更新，上报RT_Timeout，SMF发送Update Req，PCF回复Update Resp成功，携带Revalidation-Time为20:00。 用户下线成功。
####### 忙闲时切换踢用户下线 
测试条目|忙闲时切换踢用户下线
---|---
预置条件|PCF系统正常运行。前后台通讯正常，GUI正常运行。 配置时段规则： 闲时：22:00～次日07:00，忙时：07:00～22:00。当前时间为忙时，会话上线时间为闲时，拒绝会话接入。当前时间为闲时，会话上线时间为忙时，拒绝会话接入。承载能力配置支持的每业务时段规则数为0，不支持Revalidation-Time。执行SET SYS GLOBPARA命令，设置1060开关为开，支持下发不连续时段规则。SET SYS GLOBPARA:IDX=1060,CURVAL="1",EXTFLAG="BASIC";配置“规则去激活时间右区间开关”为“0-关闭”。
测试步骤|07:30用户上线，修改系统时间到22:00。22:30用户上线，修改系统时间到次日07:00。
通过准则|7:30用户上线，修改系统时间到22:00后，用户被踢下线。22:30用户上线，修改系统时间到次日07:00后，用户被踢下线。信令跟踪正常，失败观察无异常，每个测试步骤中观察向ATM注册的时段个数正确。
信令流程|07:30用户上线，PCF回复上线成功 。修改系统时间到22:00后，PCF重决策发UpdateNotify Req消息踢用户下线，SMF回复成功UpdateNotify Resp消息。22:30用户上线，PCF回复上线成功。修改系统时间到次日07:00后，PCF重决策发UpdateNotify Req消息踢用户下线，SMF回复成功UpdateNotify Resp消息。
### ZUF-59-53-008 基于PRA的策略控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
PRA|包含若干小区的区域，无线侧需向核心网上报用户在区域内或区域外。根据协议规定，一个PRA区域最多同时包含15个TAI、15个RAI、63个Macro eNB ID、63个Home eNB ID、63个ECGI、63个NCGI、63个SAI、63个CGI和126个gNB。
##### 描述 
####### 定义 
PRA通过PRA元素列表（Presence-Reporting-Area-Elements-List ，如trackingAreaList、ecgiList、ncgiList、globalRanNodeIdList、globalENbIdList）表示区域范围，RCP可以向SMF/AMF订阅某个用户进入或离开某个PRA的事件通知。当用户离开或进入PRA时，SMF/AMF会向RCP上报最新的PRA状态（presenceState：In，表示用户在PRA中；Not In，表示用户不在PRA中），RCP基于SMF/AMF上报的PRA状态实施策略和计费控制。
PRA分为动态PRA和预定义PRA。 
对于动态PRA，RCP在订阅PRA事件通知时需要向SMF/AMF提供PRA标识（praId，以十进制表示，如PRA ID 123被编码为 "123"）及PRA元素列表。 
对于预定义PRA，RCP只要提供PRA标识，对应PRA元素列表在SMF/AMF预先配置。 
####### 背景知识 
基于位置的策略往往只关注用户进入或离开一组小区的事件，例如进入或离开某个校园，如果采用传统的ULI/ECGI/TAI切换事件订阅，用户每发生ULI/ECGI/TAI切换时都会产生位置上报事件。而订阅PRA事件后，如果用户仅在PRA内部或外部的小区间移动，SMF/AMF不会向RCP上报PRA状态，可以大量减少位置上报事件，减轻了网络负担。
##### 应用场景 
只有当用户进出某个较大区域（包含多个小区），进行策略变更控制时，才可以使用PRA特性。
##### 客户收益 
受益方|受益描述
---|---
运营商|可以基于用户位置信息列表进行策略控制，减少网元间的信令交互。精细化计费策略，更有效合理利用网络资源，降低运营成本。
终端用户|此特性对终端用户不可见。

##### 实现原理 

###### 系统架构 
[]images/6.png)PRA策略控制特性涉及的网元描述参见下表。 
网元|描述
---|---
RCP|RCP向SMF/AMF订阅某个用户进入或离开某个PRA的事件通知。RCP基于SMF/AMF上报的PRA状态实施策略和计费控制。
SMF|当用户进入或离开某个PRA时，SMF向RCP上报PRA状态。
AMF|当用户进入或离开某个PRA时，AMF向RCP上报PRA状态。
###### 业务流程 
RCP向SMF/AMF下发预定义PRA业务流程如下：RCP在本地套餐基本配置（ADD PKGINFO命令）中配置PRA标识、PRA类型为预定义。同时配置基于PRA状态的策略规则。用户上线，SMF/AMF向RCP发送N7/N15会话建立请求消息。RCP向SPR发送Sp-UDR消息，请求用户签约信息。SPR通过Sp-UDA消息，返回用户签约信息。RCP向SPR发送Sp'-UDR消息，请求用户的动态信息。SPR通过Sp'-UDA消息，返回用户动态信息。用户当前会话使用支持PRA特性的套餐，RCP基于接入信息、用户签约信息及用量信息进行决策，在N7/N15会话建立应答消息中下发PRA相关信息给SMF/AMF。PRA相关信息包括praInfos（其中praId为PRA标识）、PRA_CH（policyCtrlReqTriggers设为PRA_CH，表示PCF订阅PRA状态变化）。 
RCP向SMF/AMF下发动态PRA（本地配置PRA元素列表）业务流程如下：RCP在本地套餐基本配置（ADD PKGINFO命令）中配置PRA标识、PRA类型为动态、HomeZone接入属性，其中HomeZone接入属性名指示的区域表示PRA元素列表。同时配置基于PRA状态的策略规则。用户上线，SMF/AMF发送N7/N15会话建立请求消息。RCP向SPR发送Sp-UDR消息，请求用户签约信息。SPR通过Sp-UDA消息，返回用户签约信息。RCP向SPR发送Sp'-UDR消息，请求用户动态信息。SPR通过Sp'-UDA消息，返回用户动态信息。用户当前会话使用支持PRA特性的套餐，RCP基于接入信息、用户签约信息及用量信息进行决策，在N7/N15会话建立应答消息中携带PRA相关信息给SMF/AMF。PRA相关信息包括praInfos（其中praId为PRA标识，以及PRA位置列表，如trackingAreaList/ecgiList/ncgiList/globalRanNodeIdLis）、PRA_CH（policyCtrlReqTriggers设为PRA_CH，表示PCF订阅PRA状态变化）。 
RCP向SMF/AMF下发动态PRA（SPR提供 PRA元素列表）业务流程如下：RCP在本地套餐基本配置（ADD PKGINFO命令）中配置PRA标识、PRA类型为动态。同时配置基于PRA状态的策略规则。用户上线，SMF/AMF发送N7/N15会话建立请求消息。RCP向SPR发送Sp-UDR消息，请求用户签约信息。SPR通过Sp-UDA消息，返回用户签约信息，其中Package-Profile-Info AVP携带支持PRA特性的套餐信息。套餐信息中可以携带类型为1的HomeZone_Info AVP，表示 PRA元素列表。RCP向SPR发送Sp'-UDR消息，请求用户动态信息。SPR通过Sp'-UDA消息，返回用户动态信息。用户当前会话使用支持PRA特性的套餐，RCP基于接入信息、用户签约信息及用量信息进行决策，在N7/N15会话建立应答消息中携带PRA相关信息给SMF/AMF。PRA相关信息包括praInfos（其中praId为PRA标识，以及PRA位置列表，如trackingAreaList/ecgiList/ncgiList/globalRanNodeIdLis）、PRA_CH（policyCtrlReqTriggers设为PRA_CH，表示PCF订阅PRA状态变化）。 
RCP基于SMF/AMF上报的PRA状态进行策略控制业务流程如下：RCP已向SMF/AMF下发了PRA信息，且配置了基于PRA状态的策略规则。当SMF/AMF检测到用户进出PRA导致PRA状态发生变化时，会向RCP发送N7/N15会话更新请求消息。更新请求包含的PRA信息包括repPraInfos和repPolicyCtrlReqTriggers为PRA_CH。repPraInfos包含praId（PRA标识）、presenceState（PRA状态）。RCP基于PRA状态进行规则匹配，通过N7/N15会话更新应答消息将新的规则下发给SMF/AMF。 
###### 本网元实现 
######## 配置PRA标识和类型 
为了支持PRA特性，在RCP本地的套餐基本配置中，新增PRA类型和PRA标识两个字段，其中套餐属性必须配置为用户套餐，参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newb3e97d7a0f4948808feb0ad43f788b34__18dde6a5-e3c8-468b-b9fa-c886c79f1674)。
参数|值|说明
---|---|---
PRA类型|无PRA|套餐不支持PRA特性
预定义|PRA类型|套餐支持预定义PRA
动态|PRA类型|套餐支持动态PRA
PRA标识|整数（0-16777215）|套餐支持的PRA标识
套餐属性|用户套餐|一个用户会话只支持一个PRA
######## 获取PRA元素列表 
RCP向PCEF下发动态PRA时，PRA元素列表有两种获取方式。
通过RCP命令终端配置，具体过程如下（其中4可选）：序号来源说明1ULI接入配置（ADD ULIACC命令）每一条记录配置PRA元素列表中的一个元素或多个元素。2接入区域配置（ADD ACCAREA命令）接入类型="ULI"，一个接入区域包含多个ULI接入。该接入区域包含的范围即表示PRA元素列表。3支持PRA特性的套餐基本配置（ADD PKGINFO命令）HomeZone属性控制方式="HomeZone和非HomeZone区域区分控制"，HomeZone接入类型="区域"，HomeZone接入属性填入接入区域名（对应接入区域配置）。4SPR返回的套餐HomeZone信息（Package-Profile-Info AVP中的HomeZone_Info AVP）HomeZone_Info_Type AVP=0，HomeZone_Info_Value AVP为接入区域名（对应接入区域配置）。 
RCP从SPR获取，具体过程如下：序号来源说明1SPR返回的套餐HomeZone信息（Package-Profile-Info AVP中的HomeZone_Info AVP）HomeZone_Info_Type AVP=1；HomeZone_Info_Value AVP为用户位置信息集合，表示PRA元素列表。格式为"位置类型-位置信息,位置类型-位置信息,…"，其中位置类型必须为ULI。 
######## 基于PRA状态进行策略控制 
SMF/AMF感知到用户进入、离开PRA时发送SM策略更新/AM策略更新/UE策略更新消息，将用户的PRA状态告知RCP。RCP解析上报的PRA状态并据此进行策略控制。PRA状态值：
在（In）：用户在PRA中； 
不在（Not In）：用户不在PRA中。 
在RCP本地配置基于PRA状态的策略规则。比如，当PRA状态="在"时，RCP下发MBR=4Mbps；当PRA状态="不在"时，RCP下发MBR=2Mbps。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性使用“1252 PRA订阅限制
”全局开关，控制RCP向SMF/AMF订阅某个用户进入或离开某个PRA的订阅限制。
该全局开关应用于用户在进行4G/5G切换时，RCP是否需要根据用户RAT Type值的改变来重新订阅PRA的场景。 
0：RCP不区分用户，不论用户是4G/5G接入，向SMF订阅PRA，并且用户在4G/5G间切换时也不需要重新订阅。 
1：RCP区分用户，仅当用户是5G NR接入时，向SMF订阅PRA。 
2：RCP不区分用户，不论用户是4G/5G接入，向SMF订阅PRA，但当用户在4G/5G间切换时，需要重新订阅PRA。 
该特性使用“1214 PRA ID取值方式
”全局开关。RCP向SMF/AMF订阅了PRA事件通知，该全局开关用于控制RCP收到SMF/AMF上报的PRA状态后，向SMF/AMF下发的PRA信息中praId的构造格式。
0：RCP向SMF/AMF下发的PRA信息中praId为十进制字符串格式。 
1：RCP向SMF/AMF下发的PRA信息中praId为十六进制字符串格式。 
##### 特性交互 
相关特性|交互关系
---|---
基于HomeZone的策略控制|PRA元素列表通过用户套餐的HomeZone配置实现。
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 29.507|5G System; Access and Mobility Policy Control Service; Stage 3
3GPP|TS 29.525|5G System; UE Policy Control Service;Stage 3
3GPP|TS 29.512|5G System; Session Management Policy Control Service; Stage 3
3GPP|TS 29.571|5G System; Common Data Types for Service Based Interfaces;Stage 3
##### 特性能力 
该特性不涉及规格指标。 
##### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.20|首次发布。
##### 可获得性 
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
本特性需要RCP、SMF和AMF网元配合完成。
SMF需要能够处理RCP通过N7接口下发的PRA信息，并向RCP上报PRA状态。
AMF需要能够处理RCP通过N15接口下发的PRA信息，并向RCP上报PRA状态。 
####### 工程规划要求 
对于预定义PRA，RCP和SMF/AMF要约定好PRA元素列表和PRA标识。 

##### O&M相关 

###### 配置命令 
网管修改的配置项参见下表。 
编号|命令名称|描述
---|---|---
1|ADD PKGINFO|新增PRA类型、PRA标识字段。
2|SET PKGINFO|设置PRA类型、PRA标识字段。
3|ADD ULIACC|新增两种地理位置类型MENBID、HENBID。
策略配置GUI中新增的策略变量参见下表。 
所属类别|新增项名称|描述
---|---|---
IPCAN会话信息类|PRA状态|在（In）：用户在PRA中。不在（Not In）：用户不在PRA中。
策略配置GUI中修改的策略变量参见下表。 
所属类别|修改项名称|描述
---|---|---
IPCAN会话信息类|事件上报|增加事件"CHANGE_OF_UE_PRESENCE_IN_PRESENCE_REPORTING_AREA_REPORT"。
动态管理参见下表。 
命令|增加项|描述
---|---|---
SHOW_DPI_IPCAN_SESS|PRA Identifier|PRA标识
PRA Status|SHOW_DPI_IPCAN_SESS|PRA状态
###### 性能统计 
该特性不涉及性能计数器的变化。 
###### 告警和通知 
该特性不涉及告警和通知消息的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置说明 
RCP根据配置的PRA信息和基于PRA状态的策略规则，收到SMF/AMF上报的PRA状态后实施相应的策略和计费控制。
##### 配置前提 
基本数据配置正常，系统能够支持用户的基本上下线流程。 
基本规则数据配置正常，使得RCP能够完成基本的决策流程。 
##### 配置过程 
[]images/pra%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)配置过程包含如下几个步骤： 
（可选）在EM客户端配置页面的左侧命令树中，展开PCF节点，配置PRA元素列表。通过以下命令实现：
执行[ADD ULIACC](../../Npcf_PolicyManagement\zh-CN\mml\1787466.html)命令，新增多个ULI接入配置，对应PRA元素列表中的各个元素。
执行[ADD ACCAREA](../../Npcf_PolicyManagement\zh-CN\mml\1787175.html)命令，新增一个接入区域，关联已经配置的多个ULI接入。该接入区域即表示PRA元素列表。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，新增一个支持PRA特性的用户套餐。
进入RCP策略管理页面，根据PRA策略规划进行配置。 
##### 配置实例-RCP下发预定义PRA 
####### 配置场景 
运营商规划一个校园网，PRA元素列表已在SMF/AMF预先配置。区域位置类型为ECGI，MCC="111"，MNC="222"，起始位置="100000000"，结束位置="100000010"。学生签约用户套餐1，在校园内上线，授权8Mbps的AMBR，出校园后，授权AMBR改为4Mbps，并短信提醒用户已出校园不再享受校园流量优惠。
####### 数据规划 
数据规划参见下表。 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
HomeZone属性控制方式|套餐|HomeZone和非HomeZone区域区分控制
HomeZone接入类型|套餐|区域
HomeZone接入属性|套餐|PRA_School
PRA类型|套餐|预定义
PRA标识|套餐|16777210
####### 策略规划 
策略规划参见下表。 
类别|条件|动作参数
---|---|---
会话规则|PRA状态="在"|MK=1001MBR=8Mbps
PRA状态="不在"|会话规则|MK=1001MBR=4Mbps
通知规则|PRA状态="不在"|短信通知"您已出校园不再享受校园流量优惠"
####### 业务配置关系图 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB1.png)
####### 配置步骤 
配置ULI接入 
[ADD ULIACC](../../Npcf_PolicyManagement\zh-CN\mml\1787466.html):ID=1,ADJHOSTGRPID=1,LOCTYPE="ECGI",MCC="111",MNC="222",LOCBEGIN="100000000",LOCEND="100000010",ACCATTR="ULI_School";
配置接入区域 
[ADD ACCAREA](../../Npcf_PolicyManagement\zh-CN\mml\1787175.html):ID=1,ACCTYPE="ULI",ACCATTR="ULI_School",AREAID="PRA_School";
配置套餐基本信息 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1,HOMEZONECTRL="BOTH",ACCTYPE="ULI",AREAID="PRA_School",PRATYPE="PREDEF",PRAID=16777210;
配置规则基础数据 
自定义变量配置 
自定义变量名称|参数|取值
---|---|---
Pkg1_Home_Status|策略变量|套餐级HomeZone状态标识
策略变量属性|Pkg1_Home_Status|套餐标识：1
通知配置 
通知名称|参数|取值
---|---|---
Note_PRA_School_Out|通知语言|中文（中华人民共和国）
通知内容|Note_PRA_School_Out|您已出校园不再享受校园流量优惠
配置规则条件 
条件名称|参数|取值
---|---|---
Con_PRA_School_In|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA_School_In|PRA状态
操作符|Con_PRA_School_In|=
参考值|Con_PRA_School_In|在
Con_PRA_School_Out|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA_School_Out|PRA状态
操作符|Con_PRA_School_Out|=
参考值|Con_PRA_School_Out|不在
配置规则动作参数 
动作参数名称|参数名称|取值
---|---|---
Act_Note_PRA_School_Out|参数类型|通知参数集
全局通知编号|Act_Note_PRA_School_Out|1
通知类型|Act_Note_PRA_School_Out|SMS/EMAIL
私人短信通知内容|Act_Note_PRA_School_Out|Note_PRA_School_Out
Act_Ses_PRA_School_8Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA_School_8Mbps|8388608
downlink(bps)|Act_Ses_PRA_School_8Mbps|8388608
Act_Ses_PRA_School_4Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA_School_4Mbps|4194304
downlink(bps)|Act_Ses_PRA_School_4Mbps|4194304
配置场景 
配置场景关联规则 
场景名称|参数|取值
---|---|---
Scn_SvcPkg1|入口|入口类型|用户信息类
已选入口|Scn_SvcPkg1|入口|用户套餐
取值|Scn_SvcPkg1|入口|1
策略类型|Scn_SvcPkg1|通知策略|Rule_Note_PRA_School_Out
N7会话控制策略|策略类型|Scn_SvcPkg1|Rule_Ses_PRA_School_8Mbps Rule_Ses_PRA_School_4Mbps
通知策略规则 
规则名称|参数|取值
---|---|---
Rule_ PRA_School_Out|优先级|1
动作类型|Rule_ PRA_School_Out|立即发送
日志开关|Rule_ PRA_School_Out|关
条件表达式|Rule_ PRA_School_Out|Con_PRA_School_Out
动作参数名称|Rule_ PRA_School_Out|Act_Note_PRA_School_Out
会话控制策略规则 
规则名称|参数|取值
---|---|---
Rule_Ses_PRA_School_8Mbps|优先级|1
动作类型|Rule_Ses_PRA_School_8Mbps|参数填充
日志开关|Rule_Ses_PRA_School_8Mbps|关
条件表达式|Rule_Ses_PRA_School_8Mbps|Con_PRA_School_In
动作参数名称|Rule_Ses_PRA_School_8Mbps|Act_Ses_PRA_School_8Mbps
Rule_Ses_PRA_School_4Mbps|优先级|1
动作类型|Rule_Ses_PRA_School_4Mbps|参数填充
日志开关|Rule_Ses_PRA_School_4Mbps|关
条件表达式|Rule_Ses_PRA_School_4Mbps|Con_PRA_School_Out
动作参数名称|Rule_Ses_PRA_School_4Mbps|Act_Ses_PRA_School_4Mbps
##### 配置实例-RCP下发动态PRA（RCP本地配置PRA元素列表） 
####### 配置场景 
运营商规划一个校园网，区域位置类型为ECGI，MCC="111"，MNC="333"，起始位置="200000000"，结束位置="200000010"。学生签约用户套餐2，在校园内上线，授权8Mbps的AMBR；出校园后，授权AMBR改为4Mbps，并短信提醒用户已出校园不再享受校园流量优惠。
####### 数据规划 
类别|参数|取值
---|---|---
ULI接入|接入属性|PRA_School1
地理位置类型|ULI接入|MCC+MNC+起始ECI+结束ECI
范围|ULI接入|MCC="111"，MNC="333"，起始位置="200000000"，结束位置="200000010"
套餐|编号|2
套餐类型|套餐|用户套餐
HomeZone属性控制方式|套餐|HomeZone和非HomeZone区域区分控制
HomeZone接入类型|套餐|ULI
HomeZone接入属性|套餐|PRA_School1
PRA类型|套餐|动态
PRA标识|套餐|16777211
####### 策略规划 
类别|条件|动作参数
---|---|---
会话规则|在套餐2的HomeZone内或PRA状态="在"|MK=2001AMBR=8Mbps
PRA状态="不在"|会话规则|MK=2002MBR=4Mbps
通知规则|PRA状态="不在"|短信通知"您已出校园不再享受校园流量优惠"
####### 业务关系配置图 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB2.png)
####### 配置步骤 
ULI接入配置 
[ADD ULIACC](../../Npcf_PolicyManagement\zh-CN\mml\1787466.html):ID=2,ADJHOSTGRPID=1,LOCTYPE="ECGI",MCC="111",MNC="333",LOCBEGIN="200000000",LOCEND="200000010",ACCATTR="PRA_School1";
接入区域配置 
[ADD ACCAREA](../../Npcf_PolicyManagement\zh-CN\mml\1787175.html):ID=2,ACCTYPE="ULI",ACCATTR="ULI2_School",AREAID="PRA2_School";
套餐基本配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="2",PRIORITY=1,HOMEZONECTRL="BOTH",ACCTYPE="ULI",AREAID="PRA_School1",PRATYPE="DYN",PRAID=16777211;
配置规则基础数据 
通知名称|参数|取值
---|---|---
Note_PRA2_School_Out|通知语言|中文（中华人民共和国）
通知内容|Note_PRA2_School_Out|您已出校园不再享受校园流量优惠
配置规则条件 
条件名称|参数|取值
---|---|---
Con_PRA2_School_In|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA2_School_In|PRA状态
操作符|Con_PRA2_School_In|=
参考值|Con_PRA2_School_In|在
Con_PRA2_School_Out|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA2_School_Out|PRA状态
操作符|Con_PRA2_School_Out|=
参考值|Con_PRA2_School_Out|不在
配置规则动作参数 
动作参数名称|参数名称|取值
---|---|---
Act_Note_PRA2_School_Out|参数类型|通知参数集
全局通知编号|Act_Note_PRA2_School_Out|1
通知类型|Act_Note_PRA2_School_Out|SMS/EMAIL
私人短信通知内容|Act_Note_PRA2_School_Out|Note_PRA2_School_Out
Act_Ses_PRA_School2_8Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA_School2_8Mbps|8388608
downlink(bps)|Act_Ses_PRA_School2_8Mbps|8388608
Act_Ses_PRA_School2_4Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA_School2_4Mbps|4194304
downlink(bps)|Act_Ses_PRA_School2_4Mbps|4194304
配置场景 
场景名称|参数|取值
---|---|---
Scn_SvcPkg2|入口|入口类型|用户信息类
已选入口|Scn_SvcPkg2|入口|用户套餐
取值|Scn_SvcPkg2|入口|2
策略类型|Scn_SvcPkg2|通知策略|Rule_Note_PRA2_School_Out
N7会话控制策略|策略类型|Scn_SvcPkg2|Rule_Ses_PRA2_School_8Mbps Rule_Ses_PRA2_School_4Mbps
N7会话级用量监控策略|策略类型|Scn_SvcPkg2|Rule_MK2001_Fix_10M
配置规则 
通知策略规则 
规则名称|参数|取值
---|---|---
Rule_ PRA2_School_Out|优先级|1
动作类型|Rule_ PRA2_School_Out|立即发送
日志开关|Rule_ PRA2_School_Out|关
条件表达式|Rule_ PRA2_School_Out|Con_PRA2_School_Out
动作参数名称|Rule_ PRA2_School_Out|Act_Note_PRA2_School_Out
会话控制策略规则 
规则名称|参数|取值
---|---|---
Rule_Ses_PRA2_School_8Mbps|优先级|1
动作类型|Rule_Ses_PRA2_School_8Mbps|参数填充
日志开关|Rule_Ses_PRA2_School_8Mbps|关
条件表达式|Rule_Ses_PRA2_School_8Mbps|Con_PRA2_School_In
动作参数名称|Rule_Ses_PRA2_School_8Mbps|Act_Ses_PRA2_School_8Mbps
Rule_Ses_PRA2_School_4Mbps|优先级|1
动作类型|Rule_Ses_PRA2_School_4Mbps|参数填充
日志开关|Rule_Ses_PRA2_School_4Mbps|关
条件表达式|Rule_Ses_PRA2_School_4Mbps|Con_PRA2_School_Out
动作参数名称|Rule_Ses_PRA2_School_4Mbps|Act_Ses_PRA2_School_4Mbps
##### 配置实例-RCP下发动态PRA（SPR返回PRA元素列表） 
####### 配置场景 
运营商规划一个校园网，区域位置类型为ECGI，MCC="111"，MNC="333"，起始位置="200000000"，结束位置="200000010"。学生签约用户套餐3，在校园内上线，授权8Mbps的AMBR，出校园后，授权AMBR改为4Mbps，并短信提醒用户已出校园不再享受校园流量优惠。
####### 数据规划 
类别|参数|取值
---|---|---
套餐|编号|3
套餐类型|套餐|用户套餐
PRA类型|套餐|动态
PRA标识|套餐|16777212
HomeZone属性控制方式|套餐|HomeZone和非HomeZone区域区分控制
SPR返回套餐HomeZone信息|HomeZone类型|1
HomeZone值|SPR返回套餐HomeZone信息|"129-111222100000000,129-11122210000000,129-111222100000002,129-111222100000003, 129-111222100000004, 129-111222100000005"
####### 策略规划 
类别|条件|动作参数
---|---|---
会话规则|在套餐3的HomeZone内或PRA状态="在"|MK=1001uplink=8Mbps
PRA状态="不在"|会话规则|MK=1001downlink=4Mbps
通知规则|PRA状态="不在"|短信通知"您已出校园不再享受校园流量优惠"
####### 业务配置关系图 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB3.png)
####### 配置步骤 
配置套餐基本信息 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="3",PRIORITY=1,HOMEZONECTRL="BOTH",PRATYPE="DYN",PRAID=16777212;
配置规则基础数据 
自定义变量配置 
自定义变量名称|参数|取值
---|---|---
Pkg3_Home_Status|策略变量|套餐级HomeZone状态标识
策略变量属性|Pkg3_Home_Status|套餐标识：3
通知配置 
通知名称|参数|取值
---|---|---
Note_PRA3_School_Out|通知语言|中文（中华人民共和国）
通知内容|Note_PRA3_School_Out|您已出校园不再享受校园流量优惠
配置规则条件 
条件名称|参数|取值
---|---|---
Con_PRA3_School_In|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA3_School_In|PRA状态
操作符|Con_PRA3_School_In|=
参考值|Con_PRA3_School_In|在
Con_PRA3_School_Out|策略变量类别|IP-CAN会话信息类
策略变量|Con_PRA3_School_Out|PRA状态
操作符|Con_PRA3_School_Out|=
参考值|Con_PRA3_School_Out|不在
Con_Pkg3_Home_Status|策略变量类别|自定义策略变量
策略变量|Con_Pkg3_Home_Status|Pkg3_Home_Status
操作符|Con_Pkg3_Home_Status|=
参考值|Con_Pkg3_Home_Status|1
配置规则动作参数 
动作参数名称|参数名称|取值
---|---|---
Act_Note_PRA3_School_Out|参数类型|通知参数集
全局通知编号|Act_Note_PRA3_School_Out|1
通知类型|Act_Note_PRA3_School_Out|SMS/EMAIL
私人短信通知内容|Act_Note_PRA3_School_Out|Note_PRA3_School_Out
Act_Ses_PRA3_School_8Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA3_School_8Mbps|8388608
downlink(bps)|Act_Ses_PRA3_School_8Mbps|8388608
Act_Ses_PRA3_School_4Mbps|参数类型|会话参数集
uplink(bps)|Act_Ses_PRA3_School_4Mbps|4194304
downlink(bps)|Act_Ses_PRA3_School_4Mbps|4194304
配置场景 
场景名称|参数|取值
---|---|---
Scn_SvcPkg1|入口1|入口类型|用户信息类
已选入口|Scn_SvcPkg1|入口1|用户套餐
取值|Scn_SvcPkg1|入口1|3
策略类型|Scn_SvcPkg1|通知策略|Rule_Note_PRA3_School_Out
N7会话控制策略|策略类型|Scn_SvcPkg1|Rule_Ses_PRA3_School_8Mbps Rule_Ses_PRA3_School_4Mbps
配置规则 
通知策略规则 
规则名称|参数|取值
---|---|---
Rule_ PRA_School_Out|优先级|1
动作类型|Rule_ PRA_School_Out|立即发送
日志开关|Rule_ PRA_School_Out|关
条件表达式|Rule_ PRA_School_Out|Con_PRA3_School_Out
动作参数名称|Rule_ PRA_School_Out|Act_Note_PRA3_School_Out
会话控制策略规则 
规则名称|参数|取值
---|---|---
Rule_Ses_PRA3_School_8Mbps|优先级|1
动作类型|Rule_Ses_PRA3_School_8Mbps|参数填充
日志开关|Rule_Ses_PRA3_School_8Mbps|关
条件表达式|Rule_Ses_PRA3_School_8Mbps|Con_Pkg3_Home_Status|Con_PRA3_School_In
动作参数名称|Rule_Ses_PRA3_School_8Mbps|Act_Ses_PRA3_School_8Mbps
Rule_Ses_PRA3_School_4Mbps|优先级|1
动作类型|Rule_Ses_PRA3_School_4Mbps|参数填充
日志开关|Rule_Ses_PRA3_School_4Mbps|关
条件表达式|Rule_Ses_PRA3_School_4Mbps|Con_PRA3_School_Out
动作参数名称|Rule_Ses_PRA3_School_4Mbps|Act_Ses_PRA3_School_4Mbps
##### 测试用例 
####### RCP下发预定义PRA 
测试条目|RCP下发预定义PRA，基于PRA状态进行策略控制
---|---
预置条件|RCP系统正常运行。前后台通讯正常。ULI接入配置中增加配置。"地理位置类型"选"MCC+MNC+起始ECI+结束ECI"，"接入属性"为1。 接入区域配置中增加配置。“接入类型”为ULI，“接入属性”为1，“区域接入属性”为1。套餐基本配置中增加基础套餐1。套餐ID为"1"，套餐属性为"用户套餐"，"HomeZone属性控制方式"为BOTH，"HomeZone接入类型"为区域，"HomeZone接入属性"为1，"PRA 类型"为"预定义"，PRA标识为16777210。策略管理中场景1配置。入口条件：用户套餐=1。会话规则1：HomeZone=In或PRA状态=In时，下发APN-MBR=8Mbps。 会话规则2：PRA状态=Not In时，下发APN_MBR=4Mbps。 通知规则：上报事件PRA_CH，且PRA状态=Not In时，发送短信。
测试步骤|用户上线，建立N7会话，签约UDA中携带套餐1，Npcf_SMPolicyControl_Create Request消息中携带accessType为3GPP-EPS，userLocationInfo（对应位置在ULI配置的ECGI范围内）。N7-U上报事件PRA_CH，携带repPraInfos，praId为16777210，presenceState为In。N7-U上报事件PRA_CH，携带repPraInfos，praId为16777210，presenceState为Not In。用户下线。
通过准则|用户上线，下发uplink=8Mbps，repPrainfos只包含16777210。第一次上报事件后，Npcf_SMPolicyControl_Update Request继续订阅PRA事件。第二次上报事件后，下发uplink=4Mbps，并触发短信发送。信令跟踪查看Presence-Reporting-Area-Information，显示正确。人机命令查询会话数据区，PRA标识及状态显示正确。失败观察无无用信息上报。用户下线，向SPR存储短信，数据区正常释放。
信令流程|信令流程
####### RCP下发动态PRA（RCP本地配置PRA元素列表） 
测试条目|RCP下发动态PRA（RCP本地配置PRA元素列表），基于PRA状态进行策略控制
---|---
预置条件|RCP系统正常运行。前后台通讯正常。ULI接入配置中增加配置。"地理位置类型"选"MCC+MNC+起始ECI+结束ECI"，"接入属性"为2。接入区域配置中增加配置。“接入类型”为ULI，“接入属性”为2，“区域接入属性”为2。套餐基本配置中增加基础套餐2。 套餐ID为"2"，套餐属性为"用户套餐"，"HomeZone属性控制方式"为BOTH，"HomeZone接入类型"为区域，"HomeZone接入属性"为2，"PRA 类型"为"动态"，PRA标识为16777211。策略管理中场景1配置 。入口条件：用户套餐=2。 会话规则1：HomeZone=IN 或PRA状态=In时，下发APN-MBR=8Mbps。 会话规则2：PRA状态=Not In时，下发APN_MBR=4Mbps。通知规则：上报事件PRA_CH，且PRA状态=Not In时，发送短信。
测试步骤|用户上线，建立N7会话，签约UDA中携带套餐2，Npcf_SMPolicyControl_Create Request消息中携带accessType为3GPP-EPS，userLocationInfo（对应位置在ULI配置的ECGI范围内）。Npcf_SMPolicyControl_Update Response上报事件PRA_CH，携带repPraInfos，praId为16777211，presenceState为In。Npcf_SMPolicyControl_Update Response上报事件PRA_CH，携带repPraInfos，praId为16777211，presenceState为Not In。用户下线。
通过准则|用户上线，下发APN-MBR=8Mbps，repPrainfos中包含praId及Presence-Reporting-Area-Elements_List。第一次上报事件后，Npcf_SMPolicyControl_Update Response继续订阅PRA事件。第二次上报事件后，下发uplink=4Mbps，并触发短信发送。信令跟踪查看repPrainfos，显示正确。人机命令查询会话数据区，PRA标识及状态显示正确。失败观察无无用信息上报。用户下线，向SPR存储短信，数据区正常释放。
信令流程|信令流程
####### RCP下发动态PRA（SPR返回 PRA元素列表） 
测试条目|RCP下发动态PRA（SPR返回 PRA元素列表），基于PRA状态进行策略控制
---|---
预置条件|RCP系统正常运行。前后台通讯正常。套餐基本配置中增加基础套餐3 。套餐ID为"3"，套餐属性为"用户套餐"，"HomeZone属性控制方式"为BOTH，"PRA 类型"为"动态"，PRA标识为16777212。策略管理中场景1配置 。入口条件：用户套餐=3。会话规则1：HomeZone=IN 或PRA状态=In时，下发APN-MBR=8Mbps。会话规则2：PRA状态=Not In时，下发APN_MBR=4Mbps。通知规则：上报事件PRA_CH，且PRA状态=Not In时，发送短信。
测试步骤|用户上线，建立N7会话，签约UDA中携带套餐3，套餐3携带HomeZone-Info，HomeZone-Info中携带HomeZone-Type为1，HomeZone-Value为"129-123456100000001, 129-123456100000002, 129-123456100000003, 129-123456100000004, 129-123456100000005"），Npcf_SMPolicyControl_Create Request消息中携带accessType为3GPP-EPS，userLocationInfo（对应位置在套餐1携带的位置范围内）。Npcf_SMPolicyControl_Create Request上报事件PRA_CH，携带repPraInfos，repPraInfos为16777212，presenceState为In。Npcf_SMPolicyControl_Create Request上报事件PRA_CH，携带repPraInfos，repPraInfos为16777212，presenceState为Not In。用户下线。
通过准则|用户上线，下发uplink=8Mbps，repPraInfos中包含praId及trackingAreaList/ecgiList/ncgiList/globalRanNodeIdList。第一次上报事件后，Npcf_SMPolicyControl_Create Response继续订阅PRA事件。第二次上报事件后，下发downllink=4Mbps，并触发短信发送。信令跟踪查看Presence-Reporting-Area-Information，显示正确。人机命令查询会话数据区，PRA标识及状态显示正确。失败观察无无用信息上报。用户下线，向SPR存储短信，数据区正常释放。
信令流程|信令流程
### 缩略语 
### 缩略语 
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### ECGI 
E-UTRAN Cell Global IdentifierE-UTRAN小区全球标识
#### EM 
Element Management网元管理
#### PCF 
Policy Control Function策略控制功能
#### PRA 
Presence Reporting Area出现上报区域
#### RCP 
Resource Control Platform资源控制平台
#### SMF 
Session Management Function会话管理功能
#### TAI 
Tracking Area Identity跟踪区标识
#### ULI 
User Location Information用户位置信息
## 策略动作类特性 
### ZUF-59-53-004 业务重定向控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
PCC规则|PCC规则包含业务数据流的策略控制和计费控制。若重定向信息在PCC规则中下发，则称为重定向规则。
业务探测规则|业务探测规则用于监测用户是否访问了重定向URL地址或IP地址。若用户访问了重定向地址，则SMF或SPR通知RCP发生了业务重定向。
##### 描述 
####### 定义 
业务重定向控制特性，是指控制业务数据流的上行流是否应该重定向到一个特定地址。 
RCP能够基于各种条件实施重定向或取消重定向。RCP通过下发PCC规则给SMF来实施重定向。如果下发的是动态PCC规则，RCP需要在规则中指定重定向地址；如果下发的是预定义PCC规则，需要在SMF中预配置重定向地址。
RCP可以指示SMF采用一次重定向或永久重定向。 
一次重定向：SMF在收到重定向PCC规则后，只对相应业务中的下一次HTTP请求实施重定向，后续HTTP请求在本次会话内不再重定向。 
永久重定向：SMF在收到重定向PCC规则后，对相应业务的所有HTTP请求实施重定向，对其它非HTTP报文丢弃，直至重定向PCC规则删除。 
RCP支持重定向确认功能：签约接口确认和事件订阅确认。签约接口确认由SPR通知RCP；事件订阅确认由SMF通知RCP。当RCP收到确认后，记录重定向确认规则，并通知SMF网元删除重定向规则。 
####### 背景知识 
运营商根据策略规则将用户的业务重定向到特定的页面，用以提醒用户或给用户提供特定的服务，使运营商能够精准营销，增加营收。同时能让用户合理安排自己的消费选择，提升用户满意度。 
##### 应用场景 
业务重定向支持的主要场景如下： 
用户位置信息切换时，重定向到一个指定的地址。例如：用户由本地进入漫游区域。当用户上线时，运营商将其网络访问重定向到URL地址，该URL地址可链接到购买漫游套餐页面。 
用量达到指定阈值时，重定向到一个指定的地址，方便用户充值/购买套餐。例如：当用户的套餐用量使用百分比 ≥ 100％时，用户的业务访问被重定向到“充值/购买套餐页面”，此时用户可以选择继续使用或充值。当用户访问指定页面或充值后，SMF或SPR通知RCP重定向确认。 
##### 客户收益 
受益方|受益描述
---|---
运营商|通过业务重定向功能及时提醒用户用量消费达到特定阈值或者用户费率已改，提升用户满意度。通过业务重定向功能对用户精准营销，增加营收。
终端用户|及时了解用量消费或者费率改变，防止用户过度消费。及时了解运营商的促销信息。

##### 实现原理 

###### 系统架构 
本特性所涉及的系统架构如下图所示。 
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 各网元作用 
功能单元|描述
---|---
RCP|决策是否需要进行业务重定向，并把业务重定向规则、业务探测规则发送给SMF。
SMF|可以实现重定向功能，并向RCP上报重定向确认信息。
SPR|存储签约用户信息、重定向确认标记等。在签约接口确认场景下，SPR向RCP上报重定向确认信息。
###### 业务流程 
######## RCP下发无需确认重定向规则 
当会话建立、会话更新、SPR向RCP发送PNR消息修改签约或用量时，RCP可以下发重定向规则给SMF。
[]images/%E4%B8%8B%E5%8F%91%E6%97%A0%E9%9C%80%E7%A1%AE%E8%AE%A4%E9%87%8D%E5%AE%9A%E5%90%91%E8%A7%84%E5%88%99.png)用户上线，SMF发送Npcf_SMPolicyControl_Create Request消息请求建立会话。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含用户签约的套餐信息。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，消息中可能包含用户的用量信息（如果用户之前没有上报用量到SPR，那么SPR返回RCP的消息中并不会携带用量信息）。 
RCP决策出需要重定向，通过Npcf_SMPolicyControl_Create Response消息下发重定向规则1。消息中携带的traffContDecs.redirectInfo字段表示重定向信息。 
SMF通过Npcf_SMPolicyControl_Update Request消息更新会话，触发重决策，匹配重定向规则2。 
RCP通过Npcf_SMPolicyControl_Update Response消息下发重定向规则2给SMF。 
SPR通过PNR消息（Sp-PNR/Sp'-PNR）修改签约或用量，触发重决策，匹配重定向规则3。 
RCP给SPR回复PNA消息。 
RCP通过Npcf_SMPolicyControl_UpdateNotify Request消息下发重定向规则3给SMF。 
SMF给RCP回复Npcf_SMPolicyControl_UpdateNotify Reponse消息。 
######## RCP下发事件订阅确认重定向规则 
当会话建立、会话更新、SPR向RCP发送PNR消息修改签约或用量等流程，RCP可以下发重定向规则及重定向业务探测规则给SMF。SMF上报重定向确认，RCP记录后删除重定向规则。 
下图以RCP下发给SMF标准重定向规则为例，描述重定向规则下发、确认流程。 
[]images/%E4%B8%8B%E5%8F%91%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85%E7%A1%AE%E8%AE%A4%E9%87%8D%E5%AE%9A%E5%90%91%E8%A7%84%E5%88%99.png)用户上线，SMF发送Npcf_SMPolicyControl_Create Request消息请求建立会话。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含用户签约的套餐信息。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，消息中可能包含用户的用量信息（如果用户之前没有上报用量到SPR，那么SPR返回RCP的消息中并不会携带用量信息）。 
RCP决策匹配到要下发重定向规则及探测规则，通过Npcf_SMPolicyControl_Create Response消息下发。其中重定向规则中，通过traffContDecs.redirectInfo字段下发重定向内容，通过pccRules.appid下发重定向业务TDF应用标识。 并且Npcf_SMPolicyControl_Create Response消息中会下发订阅APP_STA 和 APP_STO两个事件。 
SMF通过Npcf_SMPolicyControl_Update Request消息向RCP上报业务发生。消息中携带消息触发器APP_STA 及重定向业务TDF应用标识。 
RCP记录规则的重定向已确认，通过Npcf_SMPolicyControl_Update Response消息通知SMF删除重定向规则和探测规则。 
SMF发送Npcf_SMPolicyControl_Delete Request消息通知RCP用户下线。 
RCP给SMF回复Npcf_SMPolicyControl_Delete Response消息。 
RCP通过Sp'-UDR消息将重定向规则的确认标记（Userd-Service-info-Report AVP）存储到SPR。 
SPR给RCP回复SP'-UDA消息。 
13~14. RCP发送Sp-UDR消息通知SPR用户下线。 
######## RCP下发签约接口确认重定向规则 
当会话建立、会话更新、SPR向RCP发送PNR消息修改签约或用量等流程，RCP可以下发签约接口确认重定向规则给SMF。SPR向RCP上报重定向确认，RCP记录后删除重定向规则。 
[]images/%E4%B8%8B%E5%8F%91%E7%AD%BE%E7%BA%A6%E6%8E%A5%E5%8F%A3%E7%A1%AE%E8%AE%A4%E9%87%8D%E5%AE%9A%E5%90%91%E8%A7%84%E5%88%99.png)用户上线，SMF发送Npcf_SMPolicyControl_Create Request消息请求建立会话。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含用户签约的套餐信息。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，消息中可能包含用户的用量信息（如果用户之前没有上报用量到SPR，那么SPR返回RCP的消息中并不会携带用量信息）。 
用户消息匹配到重定向规则，并且规则未被确认，通过Npcf_SMPolicyControl_Create Response消息下发给SMF。其中traffContDecs.redirectInfo表示重定向内容。 
7~8. SPR通过Sp-PNR消息推送签约修改，消息中携带User-Profile-Info.Package-Profile-Info.Extended-Attribute AVP表示重定向确认。 
9~10. RCP记录下重定向规则被确认，通过Npcf_SMPolicyControl_UpdateNotify Request消息通知SMF删除重定向规则。 
11~12. SMF通过Npcf_SMPolicyControl_Delete Request消息通知RCP用户离线。 
13~14. RCP通过Sp'-UDR消息中的Userd-Service-info-Report AVP将“重定向确认状态”及用量信息存储到SPR。 
15~16. RCP发送Sp-UDR消息通知SPR用户下线。 
######## 会话建立时重定向规则已被确认 
会话建立，用户信息匹配到重定向规则，SPR返回重定向确认信息，该重定向规则不再下发。 
[]images/%E4%BC%9A%E8%AF%9D%E5%BB%BA%E7%AB%8B%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91%E8%A7%84%E5%88%99%E5%B7%B2%E8%A2%AB%E7%A1%AE%E8%AE%A4.png)用户上线，SMF发送Npcf_SMPolicyControl_Create Request消息请求建立会话。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含用户签约的套餐信息。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，重定向记录通过消息中的Used-Service-Info-Query AVP携带。 
用户消息匹配到重定向规则1，并且规则被确认，Npcf_SMPolicyControl_Create Response消息中不再下发重定向规则。 
SMF通过Npcf_SMPolicyControl_Update Request消息更新会话，触发重决策，匹配重定向规则2。 
重定向规则2未被确认，RCP通过Npcf_SMPolicyControl_Update Response消息下发重定向规则2给SMF。消息中携带的traffContDecs.redirectInfo表示重定向内容。 
 说明： 
该业务流程适用于签约接口确认和事件订阅确认两种确认方式。对于事件订阅确认方式，用户信息匹配到重定向规则，SPR返回重定向确认信息，重定向规则和业务探测规则均不再下发。 
######## 签约接口重定向确认后用户充值 
会话建立时重定向已确认，无需下发重定向规则。用户充值后重定向规则不满足，无需重定向。会话更新后再次匹配重定向规则，下发重定向规则。重定向确认后删除重定向规则。 
[]images/%E7%AD%BE%E7%BA%A6%E6%8E%A5%E5%8F%A3%E9%87%8D%E5%AE%9A%E5%90%91%E7%A1%AE%E8%AE%A4%E5%90%8E%E5%85%85%E5%80%BC.png)用户上线，SMF发送Npcf_SMPolicyControl_Create Request消息请求建立会话。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含用户签约的套餐信息。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，重定向记录通过消息中的Used-Service-Info-Query AVP携带。 
RCP判断重定向确认记录有效，无需下发重定向规则1。 
用户充值后，SPR通过Sp-PNR消息携带签约的返还用量。 
RCP向SPR返回PNA消息。 
9~10. RCP根据用量判断重定向规则1不再匹配，匹配业务规则2，无需重定向，并通过Npcf_SMPolicyControl_UpdateNotify Request消息给SMF下发业务规则2。 
11. SMF通过Npcf_SMPolicyControl_Update Request消息向RCP上报用量。 
12. RCP重决策，再次匹配的重定向规则1，通过Npcf_SMPolicyControl_Create Response消息下发重定向规则1。 
13~14. SPR通过Sp-PNR消息向RCP推送签约，消息中携带User-Profile-Info.Package-Profile-Info.Extended-Attribute AVP表示重定向确认。 
15~16. RCP认为重定向规则被确认，通过Npcf_SMPolicyControl_UpdateNotify Request消息通知SMF删除重定向业务策略。 
###### 本网元实现 
######## 概述 
RCP对于重定向规则的决策流程如下图所示。
[]images/%E6%9C%AC%E7%BD%91%E5%85%83%E5%AE%9E%E7%8E%B0.png)当RCP系统进行决策的时候（如会话上线、会话更新、SPR触发的签约修改、时段规则设置的定时器等场景触发决策），根据配置的场景信息决策出重定向规则。
如果决策出的是“无需确认的重定向规则”，则直接将该规则下发给SMF。 
如果决策出的是“需确认的重定向规则”，结合重定向目的地址的访问情况，作如下处理：若规则尚未重定向确认，则下发重定向规则和重定向业务的探测规则（签约接口确认没有重定向业务的探测规则）。    若规则已重定向确认，判断规则是否已下发。 若已下发，则删除重定向规则和重定业务的探测规则；若未下发，则丢弃规则。    
######## 重定向确认功能 
重定向确认有两种形式：事件订阅确认和签约接口确认。由全局开关1112决定。  
事件订阅确认方式（全局开关1112的值为0）RCP中配置重定向规则和重定向业务的探测规则。RCP将重定向规则和重定向业务的探测规则下发给SMF。用户若访问了重定向地址，则SMF告知RCP，RCP收到业务发生的事件后认为该重定向确认过了，RCP会通知SMF删除重定向规则和重定向业务的探测规则。 说明：当重定向确认为事件订阅确认时，重定向业务的探测规则不能预下发。 
签约接口确认方式（全局开关1112的值为1）签约接口确认又称PORTAL确认。RCP将重定向规则下发给SMF。当用户用量达到重定向条件时，会把用户重定向到PORTAL页面。在PORTAL页面用户可以选择CONTINUE和充值。只有当用户选择CONTINUE时，结果会通过SOAP接口传送给SPR，SPR通过签约接口Sp-PNR消息（携带User-Profile-Info.Package-Profile-Info.Extended-Attribute AVP）推送给RCP。RCP认为重定向被确认，通知SMF删除重定向规则，并且该场景下不再下发重定向规则。      
综上所述，两种重定向确认的比较参见下表。 
配置项|事件订阅确认|签约接口确认
---|---|---
全局开关1112的值|0|1
是否下发重定向业务的探测规则|是|否
GUI中“Tc参数集”中是否需要配置“重定向业务TDF应用标识”|是|否
是否下发事件订阅|是|否
重定向确认网元|SMF|SPR
重定向确认上报AVP|policyCtrlReqTriggers：APP_STApccRules.appId：TDF应用标识|通过签约接口的“扩展属性”字段进行上报：User-Profile-Info.Package-Profile-Info.Extended-Attribute其中，“扩展属性”字段的“名称”字段为“rdselecttime”，即User-Profile-Info.Package-Profile-Info.Extended-Attribute.Extended-Attribute-Name为“rdselecttime”，用以表示该扩展属性字段为重定向确认相关字段。
重定向确认状态存储|Userd-Service-info-Report AVP（Sp'-UDR消息上报）|Userd-Service-info-Report AVP（Sp'-UDR消息上报）
RCP也可以配置无需确认业务重定向（GUI中的“TC参数集”中“重定向业务TDF应用标识”配置为空）。RCP下发重定向规则给SMF后，无论用户是否访问了重定向地址，都不需要告知RCP。这种业务重定向策略与RCP中其他业务策略的决策过程完全一样。RCP决策出业务规则后，需要判断之前是否给SMF下发过该规则，若没有，则下发；若下发过，则不重复下发。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 29.212|定义Gx参考点规格
##### 特性能力 
该特性不涉及规格指标。 

##### 可获得性 

###### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.22.20|首次发布。
###### License要求 
该特性为RCP网元的基本特性，无需License支持。 
###### 对其他网元的要求 
业务重定向控制功能需要SMF、SPR配合完成。
其中，SMF需要具备重定向的功能，SPR需要能够存储重定向确认信息，并通知RCP。

##### O&M相关 

###### 命令 
序号|命令|描述
---|---|---
1|ADD TDFAPP|增加TDF应用标识映射
2|SET TDFAPP|修改TDF应用标识映射
3|DEL TDFAPP|删除TDF应用标识映射
4|SHOW TDFAPP|查询TDF应用标识映射
“TDF应用标识映射配置”用来配置TDF应用标识与RCP中用于识别业务的Application ID的对应关系。当需要SMF网元对某种业务进行探测时，使用该命令进行配置。 
序号|命令|描述
---|---|---
1|SET BEARABILITY|修改参数：支持重定向类型。 RCP支持两种重定向协议：3GPP标准重定向和ZTE私有重定向。
2|SET DATARATIO|修改参数：重定向确认记录系数。“重定向确认记录系数”范围0~16，默认值为0。在需要重定向确认功能时，根据话务模型修改该系数。不需要重定向确认功能时，建议采用默认配置。此数据区修改后，整个系统需要重启才能生效。
3|SET MODULECAP|系统支持的重定向确认记录数据区个数 = 重定向确认记录系数 × 在线用户数。
开关名称|取值|说明
---|---|---
1112 重定向确认方式|0|1112 重定向确认方式|事件订阅确认
1|1112 重定向确认方式|1112 重定向确认方式|签约接口确认（系统默认值）
###### 性能统计 
该特性不涉及计数器的变化。  
###### 告警和通知 
该特性不涉及告警消息的变化。 
###### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置特性 

###### 配置说明 
RCP业务重定向功能主要是通过配置重定向条件，并在规则的条件表达式中引用该重定向条件，达到在特定条件下发重定向规则的目的。 
###### 配置前提 
业务重定向的特性是由RCP和SMF、SPR配合共同完成的，因此在配置此特性之前保证网元的功能及交互正常。
###### 配置过程 
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)配置过程包含如下几个步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，配置套餐、业务的基本信息。
执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，增加套餐基本配置。
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，增加应用标识配置。
（可选）配置TDF应用标识映射信息。 
当重定向确认方式为事件订阅确认时，需要执行[ADD TDFAPP](../../Npcf_PolicyManagement\zh-CN\mml\1787557.html)命令，增加TDF应用标识映射。
配置承载能力、全局开关等重定向业务信息。 
执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，配置承载能力，包括支持重定向类型、漫游判断条件等信息。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，配置1112全局开关，决定重定向确认的方式。
在EM客户端RCP策略管理页面，配置重定向策略，包括条件、动作参数、场景和规则配置。
###### 配置实例-RCP下发无需确认重定向规则 
######## 场景说明 
用户漫游时，将用户的http业务访问重定向到指定页面，重定向规则无需确认。 
签约套餐1用户从本地进入漫游地后，将用户的“http业务访问”重定向到“提示确认页面”。 
用户访问了重定向地址（提示确认页面）后，SMF无需通报给RCP。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
业务|业务ID|1001
重定向信息|重定向地址类型|URL
重定向地址|重定向信息|http://confirm.189.com
承载能力|漫游判断条件|MCCMNC
支持重定向类型|承载能力|标准接口
非漫游区域|MCC MNC|460001
策略类型|条件描述|动作描述
---|---|---
业务控制策略|用户接入区域位于漫游地|下发重定向规则，将用户的“http业务访问”重定向到“提示确认页面”。
######## 配置步骤 
配置基础信息 
套餐配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1,PKGATTR="USER_PKG";
业务配置 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="http业务",SUBSID="1",SUBSDESC="1",PREPROV="YES";
承载能力配置 
[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html):ADJHOSTGRPID=10,SVCREDIRECT="NO",ROAMCOND="MCCMNC";
MCC-MNC接入配置 
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=1,ADJHOSTGRPID=1,MCC="460",MNC="001",ACCATTR="1";
漫游属性配置 
[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html):ACCATTR="1",ROAMFLAG="NO",ACCTYPE="MCCMNC";
全局开关控制 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1112,CURVAL="0";
配置规则条件 
漫游条件条件名称参数取值漫游状态选择策略变量其他策略变量类别接入信息类策略变量漫游标识操作符=值类型值值漫游 
应用标识条件配置条件名称参数取值COND_APPID_1001选择策略变量其他策略变量类别IP-CAN会话信息类策略变量Gx应用标识操作符=值类型值值1001 
配置规则动作参数 
业务控制策略动作参数动作参数名称参数名称取值ACTION_SVC1001_REDIR动作参数类型N7 PCC规则参数集业务规则类型动态规则规则名svc1001_redir_pcc应用标识1001流量控制策略IDSVC1001_REDIR_TC1SVC1001_REDIR_TC1动作参数类型TC参数集流量控制策略IDSVC1001_REDIR_TC1重定向能力是重定向地址类型URL重定向地址http://confirm.189.com 说明：无需重定向确认，所以动作参数中不用配置“重定向业务TDF应用标识”。 
业务预下发动作参数名称参数名称取值ACTION_PRE_1001动作参数类型预下发业务参数集应用标识1001 
场景配置 
场景规则关联配置场景名称参数取值PGK_1_REDIECT入口1入口类型用户信息类已选入口用户套餐取值1策略类型业务预下发控制策略RULE_PRE_1001N7业务控制策略RULE_SVC1001_REDIRECT 
业务预下发策略规则规则名称规则参数参数取值RULE_PRE_1001策略类型业务预下发控制策略优先级1动作类型参数填充日志开关关闭条件表达式无动作参数名称ACTION_PRE_1001 
业务控制策略规则规则名称规则参数参数取值RULE_SVC1001_REDIRECT优先级1动作类型参数填充策略类型N7业务控制策略日志开关关闭条件表达式{Gx应用标识 = 1001}&{漫游标识 = 漫游}选中动作参数名称ACTION_SVC1001_REDIR 
###### 配置实例-RCP下发事件订阅重定向规则 
######## 场景说明 
当用户总流量使用达到100%时，将用户的http业务访问重定向到套餐订购页面，重定向确认方式为事件订阅确认。 
用户签约套餐1，用量阈值1 G。当总流量超过阈值的100%时，将用户的“http业务访问”重定向到“套餐订购页面”，并带宽限速1000 kbps。 
用户访问了重定向地址（套餐订购页面）后，SMF需发送“业务发生事件”给RCP。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
业务编号|编号|1（重定向业务编号）
编号|业务编号|2（探测业务编号）
应用标识|编号|1001（重定向业务的应用标识）
编号|应用标识|1002（探测业务的应用标识）
TDF应用标识|应用标识|1
探测业务应用标识|TDF应用标识|1002
承载规则应用标识|TDF应用标识|2000
用量|策略变量编号|1
策略变量名称|用量|PakMonthVol
用量层次|用量|MK用户
用量周期|用量|月
用量类型|用量|流量
Monitoring Key列表|用量|1
重定向信息|重定向能力|是
重定向地址类型|重定向信息|URL
重定向地址|重定向信息|test.zte.com.cn
重定向业务TDF应用标识|重定向信息|TDFID1
1112全局开关|重定向确认方式|0（事件订阅确认）
策略类型|条件描述|动作描述
---|---|---
业务控制策略|应用标识1001|预定义规则业务Monitoring Key：1
应用标识1001 && MK用量超过签约阈值100%|业务控制策略|重定向，带宽限速1000kbps业务Monitoring Key：1
应用标识1002|业务控制策略|输出TDF应用标识
######## 配置步骤 
配置基础信息 
套餐配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1,PKGATTR="USER_PKG";
配置应用标识Application ID，其中1001对应重定向业务，1002对应探测业务。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="重定向业务",SUBSID="1",SUBSDESC="1",BEARCTRMODE="UE_NW",PREPROV="NO",DATABWLSTIND="WHITELIST";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="探测业务",SUBSID="2",SUBSDESC="2",BEARCTRMODE="UE_NW",PREPROV="NO",DATABWLSTIND="WHITELIST";
承载能力配置 
[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html):ADJHOSTGRPID=1,SVCREDIRECT="NO";
配置TDF应用标识映射配置 
[ADD TDFAPP](../../Npcf_PolicyManagement\zh-CN\mml\1787557.html):TDFAPP="TDFID1",MONIAPPID=1002,APPID=2000;
全局开关控制 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1112,CURVAL="0";
配置规则基础数据 
基本用量定义配置 
基本用量|参数|取值
---|---|---
PakMonthVol|策略变量编号|1
用量层次|PakMonthVol|MK用户
用量周期|PakMonthVol|月
用量类型|PakMonthVol|流量
套餐标识|PakMonthVol|1
Monitoring Key列表|PakMonthVol|1
配置规则动作参数 
应用标识条件配置条件名称参数取值APPID=1001选择策略变量其他策略变量类别IP-CAN会话信息类策略变量Gx应用标识操作符=值类型值值1001APPID=1002选择策略变量其他策略变量类别IP-CAN会话信息类策略变量Gx应用标识操作符=值类型值值1002 
套餐用量百分比配置条件名称参数取值PakMonthVol.总用量百分比 > 100选择策略变量用量策略变量类别总用量百分比策略变量PakMonthVol操作符> 值类型值值100 
配置规则动作参数 
业务控制策略动作参数动作参数名称参数名称取值Redirect1001动作参数类型N7 PCC规则参数集业务规则类型预定义规则规则名Redirect1001应用标识1001n7_pcc_action1动作参数类型N7 PCC规则参数集业务规则类型动态规则规则名Redirect1001_100应用标识1001QoS控制策略IDaction_Qos1流量控制策略IDaction_TC1Monitoring Key1action_Qos1动作参数类型Qos参数集QoS控制策略IDQos_15QI1ARP优先级1ARP抢占能力可以抢占ARP被抢占能力不可以被抢占请求的上行流带宽（kbps）1000请求的下行流带宽（kbps）1000容忍的上行流带宽（kbps）1000容忍的下行流带宽（kbps）1000action_TC1动作参数类型TC参数集流量控制策略IDaction_TC1重定向能力是重定向地址类型URL重定向地址test.zte.com.cn重定向业务TDF应用标识TDFID1 
探测应用规则动作参数动作参数名称参数名称取值n7_pcc_action2动作参数类型N7 PCC规则参数集业务规则类型动态规则规则名service1002应用标识1002计费控制策略IDchg_action需要应用探测是Monitoring Key1chg_action动作参数类型charging参数集计费控制策略IDchg_1费率组1 
业务预下发（重定向业务探测规则不能预下发）动作参数名称参数名称取值ACTION_PRE_1001动作参数类型预下发业务参数集应用标识1001 
业务用量监控动作参数动作参数名称参数名称取值MK_1_action动作参数类型业务用量监控参数集流量门限控制方式固定值总流量门限10240 
场景配置 
场景规则关联配置场景名称参数取值N7_REDIRECT入口1入口类型用户信息类已选入口用户套餐取值1策略类型N7业务控制策略service1002Redirect1001Redirect1001_100业务预下发控制策略RULE_PRE_1001业务级用量监控策略N7_MK_ser_1 
业务预下发策略规则规则名称规则参数参数取值RULE_PRE_1001策略类型业务预下发控制策略优先级1动作类型参数填充日志开关关闭条件表达式无动作参数名称ACTION_PRE_1001 
业务策略规则规则名称参数取值service1002优先级1动作类型参数填充策略类型N7业务控制策略日志开关关闭条件表达式{Gx应用标识 = 1002}选中动作参数名称n7_pcc_action2Redirect1001优先级1动作类型参数填充策略类型N7业务控制策略日志开关关闭规则编号11条件表达式{Gx应用标识 = 1001}&{PakMonthVol.总用量百分比 < 100}选中动作参数名称Redirect1001Redirect1001_100优先级1动作类型参数填充策略类型N7业务控制策略日志开关关闭规则编号20条件表达式{Gx应用标识 = 1001}&{PakMonthVol.总用量百分比 > 100}选中动作参数名称n7_pcc_action1 
业务级用量监控策略规则规则名称参数取值N7_MK_ser_1优先级10动作类型参数填充日志开关关闭选中条件名称无选中动作参数名称MK_1_action 
###### 配置实例-RCP下发签约接口确认重定向规则 
######## 场景说明 
当SPR向RCP上报的用户用量超过限制时，RCP下发重定向规则。重定向确认方式为签约接口确认。
用户签约套餐3，当未超过签约阈值时，下发静态业务规则。 
超过签约阈值100%后，下发重定向规则（签约接口确认），限制带宽2 Mbit/s。 
重定向确认后（用户未充值），删除重定向策略，下发新的业务规则。为了避免巨额账单产生，限制带宽1 Mbit/s。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|3
套餐类型|套餐|用户套餐
业务|编号|3
应用标识|编号|1003
用量|策略变量编号|3
策略变量名称|用量|MK1003_PKG3_MON_VOL
用量层次|用量|MK用户
用量周期|用量|月
用量类型|用量|流量
Monitoring Key列表|用量|1003
重定向信息|重定向地址类型|URL
重定向地址|重定向信息|http://confirm.189.com
重定向类型|重定向信息|永久重定向
承载能力|支持重定向类型|标准接口
1112全局开关|重定向确认方式|1（签约接口确认）
策略类型|条件描述|动作描述
---|---|---
业务控制策略|应用标识1003|预下发策略业务Monitoring Key：1003
应用标识1003 && 用量百分比超过100&重定向未确认|业务控制策略|重定向，带宽限速2Mbit/s业务Monitoring Key：1003
应用标识1003&& 用量百分比超过100|业务控制策略|用户业务带宽限速为1Mbit/s业务Monitoring Key：1003
######## 配置步骤 
配置基础信息 
套餐配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="3",PRIORITY=1,PKGATTR="USER_PKG";
业务配置 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1003,APPDESC="http业务3",SUBSID="3",SUBSDESC="3",PREPROV="YES";
承载能力配置 
[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html):ADJHOSTGRPID=1,SVCREDIRECT="NO";
全局开关控制 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1112,CURVAL="1";
配置规则基础数据 
基本用量定义配置 
基本用量|参数|取值
---|---|---
MK1003_PKG3_MON_VOL|策略变量编号|3
用量层次|MK1003_PKG3_MON_VOL|MK用户
用量周期|MK1003_PKG3_MON_VOL|月
用量类型|MK1003_PKG3_MON_VOL|流量
套餐标识|MK1003_PKG3_MON_VOL|3
Monitoring Key列表|MK1003_PKG3_MON_VOL|1003
配置规则条件 
应用标识条件配置条件名称参数取值COND_APPID_1003选择策略变量其他策略变量类别IP-CAN会话信息类策略变量Gx应用标识操作符=值类型值值1003 
套餐用量百分比配置条件名称参数取值COND_MK1003_PKG3_MON_VOL_100%选择策略变量用量策略变量类别总用量百分比策略变量MK1003_PKG3_MON_VOL操作符> 值类型值值100 
重定向确认条件配置条件名称参数取值COND_REDIRECT_CONFIRM选择策略变量其他策略变量类别IP-CAN会话信息类策略变量重定向确认状态操作符IfHave值类型值值未确认 
配置规则动作参数 
业务控制策略动作参数动作参数名称参数名称取值ACTION_SVC1003_PREDEFINED动作参数类型N7 PCC规则参数集业务规则类型预定义规则规则名service1003pre应用标识1003ACTION_SVC1003_REDIRECT动作参数类型N7 PCC规则参数集业务规则类型动态规则规则名service1003_redirect应用标识1003QoS控制策略IDSVC1003_REDIRECT_Qos流量控制策略IDSVC1003_REDIRECT_TCSVC1003_REDIRECT_Qos动作参数类型Qos参数集QoS控制策略IDSVC1003_REDIRECT_Qos5QI1ARP优先级1ARP抢占能力可以抢占ARP被抢占能力不可以被抢占请求的上行流带宽（kbps）2000请求的下行流带宽（kbps）2000容忍的上行流带宽（kbps）2000容忍的下行流带宽（kbps）2000SVC1003_REDIRECT_TC动作参数类型TC参数集流量控制策略IDSVC1003_REDIRECT_TC重定向能力是重定向地址类型URL重定向地址http://confirm.189.comACTION_SVC1003_CONFIRM动作参数类型PCC规则参数集业务规则类型动态规则规则名service1003_confirm应用标识1003QoS控制策略IDSVC1003_CONFIRM_QosSVC1003_CONFIRM_Qos动作参数类型Qos参数集QoS控制策略IDSVC1003_CONFIRM_Qos5QI1ARP优先级1ARP抢占能力可以抢占ARP被抢占能力不可以被抢占请求的上行流带宽（kbps）1000请求的下行流带宽（kbps）1000容忍的上行流带宽（kbps）1000容忍的上行流带宽（kbps）1000 
业务预下发动作参数规则名称规则参数参数取值ACTION_PRE_1003动作参数类型预下发业务参数集应用标识1003 
业务用量监控动作参数动作参数名称参数名称取值ACTION_SERVICE_MONITOR_10240动作参数类型业务用量监控参数集流量门限控制方式固定值总流量门限10240 
场景配置 
场景规则关联配置场景名称参数取值PKG3_REDIRECT入口1入口类型用户信息类已选入口用户套餐取值3策略类型业务预下发控制策略RULE_PRE_1003N7业务控制策略RULE_SVC1003_PREDEFINEDRULE_SVC1003_REDIRECTRULE_SVC1003_CONFIRM会话级用量监控策略RULE_SERVICE_MONITORING 
业务预下发策略规则规则名称规则参数参数取值RULE_PRE_1003优先级1动作类型参数填充日志开关关闭条件名称无动作参数名称ACTION_PRE_1003 
业务策略规则规则名称参数取值RULE_SVC1003_PREDEFINED优先级1动作类型参数填充策略类型N7业务控制策略日志开关关闭条件表达式{Gx应用标识 = 1003}选中动作参数名称ACTION_SVC1003_PREDEFINEDRULE_SVC1003_REDIRECT优先级10动作类型参数填充策略类型N7业务控制策略日志开关关闭规则编号2条件表达式{Gx应用标识 = 1003}&{重定向确认状态 IfHave 未确认}&
{MK1003_PKG3_MON_VOL.总用量百分比 > 100}选中动作参数名称ACTION_SVC1003_REDIRECTRULE_SVC1003_CONFIRM优先级5动作类型参数填充策略类型N7业务控制策略日志开关关闭规则编号3条件表达式{Gx应用标识 = 1003}&{MK1003_PKG3_MON_VOL.总用量百分比 > 100}选中动作参数名称ACTION_SVC1003_CONFIRM 
业务级用量监控策略规则规则名称参数取值RULE_SERVICE_MONITORING优先级10动作类型参数填充日志开关关闭选中条件名称无选中动作参数名称ACTION_SERVICE_MONITOR_10240 
##### 测试用例 
####### RCP下发无需确认重定向规则 
测试条目|RCP下发无需确认重定向规则
---|---
预置条件|RCP系统正常运行。前后台通讯正常，GUI正常运行。RCP和SMF、SPR之间通讯正常。在EM客户端按照“配置实例-RCP下发无需确认重定向规则” 进行配置。
测试步骤|用户上线，携带MCCMNC = 460001。用户更新会话，携带MCCMNC = 460002。
通过准则|用户携带MCCMNC = 460001上线，RCP向SMF下发预定义规则。用户携带MCCMNC = 460002更新会话，RCP向SMF下发重定向规则，并移除预定义规则。
信令流程|信令流程
####### RCP下发事件订阅重定向规则 
测试条目|RCP下发事件订阅重定向规则
---|---
预置条件|RCP系统正常运行。前后台通讯正常，GUI正常运行。RCP和SMF、SPR之间通讯正常。在EM客户端按照“配置实例-RCP下发事件订阅重定向规则” 进行配置。
测试步骤|1. 用户上线，SPR向RCP返回UDA消息，消息中携带用户已使用91%签约用量的信息。2. SMF再次向RCP上报用量，用户使用总用量已超过签约用量100%。3. SMF向RCP上报重定向确认。4. 用户下线。
通过准则|1. 用户上线后，RCP向SMF下预定义规则及用量监控。2. 用量超过100%后，RCP移除预定义规则，下发重定向规则、业务探测规则及事件订阅。3. SMF上报重定向确认后，RCP移除重定向规则及业务探测规则。4. 用户下线，RCP通过Sp'-UDR消息将重定向规则的确认标记存储到SPR。
信令流程|信令流程
####### RCP下发签约接口确认重定向规则 
测试条目|RCP下发签约接口确认重定向规则
---|---
预置条件|RCP系统正常运行。前后台通讯正常，GUI正常运行。RCP和SMF、SPR之间通讯正常。在EM客户端按照“配置实例-RCP下发签约接口确认重定向规则” 进行配置。
测试步骤|1. 用户上线，SPR向RCP返回UDA消息，消息中携带用户已使用91%签约用量的信息。2. SMF再次向RCP上报用量，用户使用总用量已超过签约用量100%。3. SPR向RCP通知重定向确认。4. 用户下线。
通过准则|1. 用户上线后，RCP向SMF下发预定义规则。2. 用量达到100%后，RCP移除预定义规则，下发重定向规则。3. SPR向RCP通知重定向确认后，RCP移除重定向规则。4.用户下线，RCP通过Sp'-UDR消息将重定向规则的确认标记存储到SPR。
信令流程|信令流程
### 缩略语 
### 缩略语 
#### EM 
Element Management网元管理
#### GUI 
Graphical User Interface图形用户界面
#### HTTP 
Hypertext Transfer Protocol超文本传输协议
#### MCC 
Mobile Country Code移动国家码
#### MNC 
Mobile Network Code移动网络号
#### PCC 
Policy and Charging Control计费和策略控制
#### PNR 
Push-Notification-Request推送通知请求
#### RCP 
Resource Control Platform资源控制平台
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### URL 
Uniform Resource Locator统一资源定位符
### ZUF-59-53-051 接入和移动性策略控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
业务区域限制|业务区域限制（Service Area Restrictions）包含允许区域（Allowed Area）和非允许区域（Non-AllowedArea）。UE在允许区域内可以正常进行语音和数据业务。UE在非允许区域内可以注册，但不能进行其他业务。
无线/频率选择优先级|无线/频率选择优先级是无线接入网进行无线资源管理时所采用的策略。不同的无线/频率选择优先级可以使用不同的RFSP Index取值来表示。基站可以根据RFSP Index实施无线资源管理策略，例如指示UE使用特定的无线接入方式和频率进行数据传输。
DNN替换|DNN替换（DNN Replacement）是指通过替换会话使用的DNN，来控制AMF对UE接入的SMF及UPF的选择，从而实现网络分片。3GPP R16引入了DNN替换功能，PCF可根据用户的套餐使用情况修改用户会话中使用的DNN。
##### 描述 
####### 定义 
接入和移动性策略控制指的是PCF向AMF提供用于接入和移动性管理的控制策略，简称AM（Access & Mobility）策略，包含PCF授权（批准或修改）的业务区域限制和RFSP Index。
为了获取AM策略，在UE注册或切换到AMF时，AMF需要向PCF请求建立AM策略关联。请求消息中包含AMF从UDM获取的UE签约的业务区域限制和RFSP Index。PCF根据运营商策略（例如基于策略签约信息，或基于累计用量）批准或修改AMF提供的业务区域限制和RFSP Index，并在响应消息中下发给AMF。
之后PCF可以因为内部事件（如时段切换）或外部事件（如UDR通知该用户的策略签约变更）触发而主动向AMF更新AM策略；或者，PCF可以在AMF上报接入和移动性相关事件时，在响应消息中更新AM策略。
在UE去注册或从AMF切走时，AMF请求PCF终止该UE的AM策略关联；PCF也可能因为某些事件（如UDR通知该用户的策略签约删除）而主动要求AMF终止该UE的AM策略关联。 
####### 背景知识 
业务区域限制和RFSP Index
EPC中，MME就可以从HSS获取UE签约的业务区域限制和RFSP Index，下发给RAN和UE执行。但在EPC中，PCRF和MME之间没有接口，MME无法向PCRF上报UE签约的业务区域限制和RFSP Index，PCRF也无法修改业务区域限制和RFSP Index。
5GC中，AMF从UDM获取UE签约的业务区域限制和RFSP Index后，可以通过N15接口发送给PCF。PCF可以批准或修改AMF提供的业务区域限制和RFSP Index。这使得运营商可以对业务区域限制和RFSP Index实施动态的策略控制。
DNN Replacement
UE发起会话建立时，会携带选择的DNN，AMF据此选择提供业务的SMF。在3GPP TS 24.501协议中将UE在会话建立请求中携带的DNN称之为“UE请求的DNN”（DNN requested by the UE）。如果UE在会话建立请求中不携带DNN，或携带的DNN不合法，网络可以对其进行修正和替换。网络替换的DNN在3GPP TS 24.501协议中被称为“网络选择的DNN”（DNN selected by the network）。 


##### 应用场景 




接入和移动性策略控制主要适用于以下几种场景： 



 
运营商需要对业务区域限制实施动态策略控制。例如对享有大额度优惠流量的家庭CPE，可以进行以下限制：
限制CPE只能在家庭周边基站接入，防止用户在非允许区域使用此类CPE上网，从而避免网络拥塞。
当某个CPE每月的优惠流量耗尽时，缩小其允许区域，扩大其非允许区域，以限制该CPE继续使用业务。当用户购买新的优惠流量或下个账期开始时，自动恢复至原来的业务区域限制。
 

 
运营商需要对RFSP Index实施动态策略控制：例如PCF根据RAN拥塞信息动态调整RFSP Index并传递给RAN，RAN指示UE选择该RFSP Index对应的无线接入方式和频率进行数据传输。 

 






##### 客户收益 




受益方|受益描述
---|---
运营商|运营商可以根据策略签约信息、累计用量、忙闲时段等实施动态的接入和移动性策略控制，提升接入网资源利用效率。
终端用户|业务区域限制可以限定特定UE（如享有大额度优惠流量的家庭CPE）只在特定位置（如家庭周边基站）使用，防止用户在非允许区域使用此类UE而影响其他用户的上网体验。灵活的RFSP Index管理可以减少RAN拥塞，使得用户获得更好的上网体验。





##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图1](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new4b752617528e40439f1e97bac1330626__51483699-1d70-4145-908d-46c8e3a1093f)所示。
图1  系统架构
[]images/image3.png)
###### 涉及的网元 
NF|说明
---|---
PCF（即图1中的RCP）|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向PCF提供UE接入信息，从PCF获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向PCF提供PDU会话信息，从PCF获取PDU会话控制策略，下发给UPF执行。
UPF|执行PDU会话策略。
AF|向PCF提供应用层的业务信息，请求PCF进行策略授权。例如对于VoNR业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给PCF。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|PCF收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和PCF的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的PCF。
UDR/SPR|向PCF提供用户的策略签约信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向PCF提供消费门限信息，例如通知PCF某用户的月累计流量是否超过了特定门限。
###### 消息描述 
AMF和PCF通过服务操作的调用，实现消息交互。AMF和PCF在N15接口提供的服务操作参见[表2](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z827dc703cd674b6994c39fc07412bf25__%E6%9C%8D%E5%8A%A1%E6%93%8D%E4%BD%9C-D155AD8C)。
服务操作|资源URI|请求消息|HTTP方法|响应消息|响应码|说明
---|---|---|---|---|---|---
Npcf_AMPolicyControl_Create|{apiRoot}/npcf-am-policy-control/v1/policies|PolicyAssociationRequest|POST|PolicyAssociation|201 Created|AMF发起AMF会话创建
Npcf_AMPolicyControl_Update|{apiRoot} /npcf-am-policy-control/ v1/policies/{polAssoId}/update|PolicyAssociationUpdateRequest|update (POST)|PolicyAssociation|200 OK|AMF发起AMF会话更新
Npcf_AMPolicyControl_Delete|{apiRoot}/npcf-am-policy-control/v1/policies/{polAssoId}|无|DELETE|无|204 No Content|AMF发起AMF会话释放
Npcf_AMPolicyControl_UpdateNotify|{Notification URI}/update|PolicyUpdate|POST|无|204 No Content|PCF发起AMF会话更新
Npcf_AMPolicyControl_UpdateNotify|{Notification URI}/terminate|TerminationNotification|POST|无|204 No Content|PCF发起AMF会话释放
###### 业务流程 
######## 概述 
本特性涉及的业务流程如下，具体可参考3GPP TS23.502的4.16.1~4.16.3章节。
######## AM策略关联建立流程 
AM策略关联建立流程如[图2](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__AM%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E5%BB%BA%E7%AB%8B%E6%B5%81%E7%A8%8B-BF506F23)所示。
图2  AM策略关联建立流程
[]images/image4.png)
流程说明如下： 
在UE注册或切换到某个AMF的过程中，如果该AMF确定需要为该UE向PCF请求接入和移动性策略控制，该AMF需要向PCF请求建立AM策略关联。为此该AMF向PCF发送Npcf_AMPolicyControl_Create请求，请求消息（PolicyAssociationRequest）中包含如下关键参数。
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-am-policy-control/v1/policies  [注1]:authority: PCF主机:端口，端口可选，默认80，主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80
notificationUri|通知URI，即AMF后续接收PCF为该AM策略关联下发的AM策略更新通知（Npcf_AMPolicyControl_UpdateNotify）请求的URI地址
altNotifIpv4Addrs|AMF的备用IPv4地址，若notificationUri中的AMF无法使用，PCF会选用该备用地址发送策略更新通知。
altNotifIpv6Addrs|AMF的备用IPv6地址，若notificationUri中的AMF无法使用，PCF会选用该备用地址发送策略更新通知。
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI）
gpsi|一般公共签约用户标识（Generic Public Subscription Identifier，例如MSISDN）
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type
pei|永久设备标识PEI（Permanent Equipment Identifier，例如IMEISV）
userLoc|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
timeZone|时区信息
servingPlmn|服务PLMN
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN等，类似于Gx接口的RAT-Type
groupIds|群组标识
servAreaRes|业务区域限制（如果AMF从UDM获取了会在Npcf_AMPolicyControl_Create请求中携带）
rfsp|无线/频率选择优先级索引（如果AMF从UDM获取了会在Npcf_AMPolicyControl_Create请求中携带）
allowedSnssais|允许的切片选择信息
guami|全局唯一AMF标识
serviceName|AMF服务名称
suppFeat|AMF支持特性列表
[注1]/npcf-am-policy-control/v1/policies 和/npcf-am-policy-control/v1/policies/
都兼容。 
如果AMF从UDM获取了一般公共用户标识（GPSI，Generic Public Subscription Identifier，例如MSISDN）、允许的切片选择信息（the
Allowed S-NSSAI），AMF也将这些信息包含在Npcf_AMPolicyControl_Create请求中。 
如果PCF确定对该UE的接入和移动性策略控制需要用到该用户的策略签约信息，并且PCF本地没有该用户的策略签约信息，则PCF向UDR/SPR获取该用户的策略签约信息，并向UDR/SPR订阅该用户的策略签约信息变更通知。
PCF基于运营商配置的策略规则及各NF提供的信息进行策略决策，生成AM策略，其中包含PCF授权的业务区域限制（Service
Area Restrictions）和RFSP Index；PCF同时还确定需要为此AM策略关联向AMF订阅的事件列表。
PCF向AMF发送Npcf_AMPolicyControl_Create响应，其中包含PCF生成的AM策略关联ID、AM策略、订阅的事件列表。向AMF发送Npcf_AMPolicyControl_Create响应，响应消息的HTTP头域Location字段中包含RCP为此AM策略关联生成的ResourceURI，响应消息（PolicyAssociation）中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 201 Created —— http头域的status类似于diameter响应的Result-Code:location: {authority}/npcf-am-policy-control/v1/policies/{amPolicyId}，其中amPolicyId为PCF根据supi/gpsi+pduSessionId+时间戳等信息生成的AM策略关联ID，例如：http://[2409:8069:5003:803::2:121]:80/npcf-am-policy-control/v1/policies/supi_123456789012346.6aa2fb6220edf7aa
triggers|PCF订阅的触发事件。 "LOC_CH", "ALLOWED_NSSAI_CH"可以过配置控制。"PRA_CH" 根据是否下发pra列表动态控制，SERV_AREA_CH，RFSP_CH默认订阅，不显式下发
servAreaRes|PCF决策出的业务区域限制
rfsp|PCF决策出的无线/频率选择优先级索引
pras|pra列表，如果决策出pra列表信息，PCF会同时订阅"PRA_CH"
suppFeat|PCF支持特性列表
######## AMF发起的AM策略关联修改流程 
AMF发起的AM策略关联修改流程如[图3](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__4b280cd8-89c4-4217-8f1e-be9416baa37f)所示。
图3  AM策略关联修改流程（AMF发起）
[]images/image5.png)
流程说明如下： 
当PCF订阅的事件发生时（如UDM通知AMF某用户签约的业务区域限制或RFSP Index发生了改变），AMF向PCF发送Npcf_AMPolicyControl_Update请求，请求消息（PolicyAssociationUpdateRequest）中包含如下关键参数：
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-am-policy-control/v1/policies/{amPolicyId}/update，例如/npcf-am-policy-control/v1/policies/supi_123456789012346.6aa2fb6220edf7aa./update:authority: PCF主机:端口
notificationUri|通知URI，即AMF后续接收PCF为该AM策略关联下发的AM策略更新通知（Npcf_AMPolicyControl_UpdateNotify）请求的URI地址
altNotifIpv6Addrs|AMF的备用IPv6地址，若notificationUri中的AMF无法使用，PCF会选用该备用地址发送策略更新通知
altNotifIpv4Addrs|AMF的备用IPv4地址，若notificationUri中的AMF无法使用，PCF会选用该备用地址发送策略更新通知
triggers|更新的触发事件，包括LOC_CH、PRA_CH、ALLOWED_NSSAI_CH、SERV_AREA_CH、RFSP_CH
rfsp|如果更新携带"RFSP_CH"事件，会同时携带更新的无线/频率选择优先级索引
servAreaRes|如果更新携带"SERV_AREA_CH"事件，会同时携带更新的业务区域限制
praStatuses|如果更新携带"PRA_CH"事件，会同时携带更新pra列表信息
userLoc|如果更新携带"LOC_CH"事件，会同时携带更新的位置信息
allowedSnssais|如果更新携带"ALLOWED_NSSAI_CH"事件，会同时携带更新允许的切片选择信息
PCF重新进行策略决策，可能更新AM策略。 
PCF向AMF发送Npcf_AMPolicyControl_Update响应，如果PCF更新了AM策略，则此响应消息中包含最新的AM策略。响应消息（PolicyAssociation）中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK:location:——update响应的http头域Location字段为空
PolicyAssociation|和创建会话的相应消息内容一致
######## PCF发起的AM策略关联修改流程 
PCF发起的AM策略关联修改流程如[图4](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__e1ba1692-cc5a-4026-a686-7fa2e2faec6f)所示。
图4  AM策略关联修改流程（PCF发起）
[]images/image6.png)
流程说明如下： 
PCF收到内外部事件触发（内部事件例如时段变更通知，外部事件例如UDR策略签约信息变更通知）。 
PCF重新进行策略决策，确定需要调整某UE的AM策略。 
PCF向AMF发送Npcf_AMPolicyControl_UpdateNotify请求，携带更新的AM策略。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: {notificationUri}/update，{notificationUri}为AMF在Create请求中提供的notificationUri，例如：/namf_communication/v1/policies/update:authority: SMF的主机:端口
resourceUri|AMF策略关联URI，和Creae响应http头域Location字段分配的resourceUri一致
triggers|PCF订阅的触发事件。 "LOC_CH", "ALLOWED_NSSAI_CH"可以过配置控制。"PRA_CH" 根据是否下发pra列表动态控制。SERV_AREA_CH、RFSP_CH默认订阅，不显式下发
servAreaRes|PCF决策出的业务区域限制
rfsp|PCF决策出的无线/频率选择优先级索引
pras|pra列表，如果决策出pra列表信息，PCF会同时订阅"PRA_CH"
AMF回复Npcf_AMPolicyControl_UpdateNotify响应。 
参数|说明
---|---
HTTP Header关键参数|204 No Content
消息内容为空|-
######## AMF发起的AM策略关联终止流程 
AMF发起的AM策略关联终止流程如[图5](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__AM%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E7%BB%88%E6%AD%A2%E6%B5%81%E7%A8%8BAMF%E5%8F%91%E8%B5%B7-BF507DBF)所示。
图5  AM策略关联终止流程(AMF发起)
[]images/image7.png)
流程说明如下： 
在UE去注册流程中，或AMF重选伴随PCF重选流程中，源AMF需要向PCF终止AM策略关联。AMF向PCF发送Npcf_AMPolicyControl_Delete请求，携带AM策略关联ID。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-am-policy-control/v1/policies/{amPolicyId}，例如/npcf-am-policy-control/v1/policies/supi_123456789012345.654646211b02c961:authority: PCF主机:端口
消息内容为空|-
如果PCF确定此AM策略关联结束后，PCF已不需要为该用户接收UDR/SPR策略签约变更通知，则PCF向UDR/SPR去订阅该用户的策略签约变更通知。 
PCF删除本地保存的该AM策略关联的相关信息，向AMF发送Npcf_AMPolicyControl_Delete响应。 
参数|说明
---|---
HTTP Header关键参数|204 No Content
消息内容为空|-
######## PCF发起的AM策略关联终止流程 
PCF发起的AM策略关联终止流程如[图6](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__08164619-600f-4305-b809-cb0b2c2e6136)所示。
图6  AM策略关联终止流程（PCF发起）
[]images/image8.png)
流程说明如下： 
PCF收到内外部事件触发（内部事件例如时段变更通知，外部事件例如UDR通知PCF已删除了某用户的策略签约）。 
PCF重新进行策略决策，确定需要删除相关的AM策略关联。 
PCF向AMF发送Npcf_AMPolicyControl_UpdateNotify请求，携带AM策略关联ID及删除AM策略关联指示。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: {notificationUri}/terminate，{notificationUri}为AMF在Create请求中提供的notificationUri:authority: AMF的主机:端口
resourceUri|AMF策略关联URI，和Creae响应http头域Location字段分配的resourceUri一致
cause|PCF终止AM策略关联的原因
AMF回复Npcf_AMPolicyControl_UpdateNotify响应。 
参数|说明
---|---
HTTP Header关键参数|204 No Content
消息内容为空|-
后续流程同[AMF发起的AM策略关联终止流程](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe30f970292464f939965c058bfbfbb31__e3ec87a9-be10-4c65-a6e7-658d5578f2ee)。
###### 本网元实现 
######## 概述 
PCF基于运营商配置的策略，并结合各NF提供的输入信息，进行策略决策，确定下发给AMF的AM策略。 
PCF可以通过以下方式确定每个AM策略关联所需访问UDR：方式1：PCF本地配置SUPI/GPSI号段和UDR的对应关系，按每个AM策略关联的SUPI或GPSI查询本地配置。方式2：PCF通过NRF发现UDR。部署时通常采用方式2。 
######## 业务区域限制 
在AMF发送的请求中，servAreaRes参数代表AMF请求的业务区域限制。 
在PCF下发的策略中，servAreaRes参数代表PCF授权的业务区域限制。 
如果AMF在Create/Update请求中携带请求servAreaRes，PCF就会在Create/Update响应中下发授权servAreaRes。 
PCF也可以主动在UpdateNotify中更新授权servAreaRes，如果不携带，则不更新。 
当收到Create/Update请求时，如果没有匹配的AM策略规则，PCF默认按请求servAreaRes下发授权servAreaRes。如果有匹配的AM策略规则，PCF按匹配的AM策略规则进行决策，确定授权servAreaRes。 
servAreaRes包含如下参数： 
restrictionType：取值为ALLOWED_AREAS或NOT_ALLOWED_AREAS，和areas参数配合使用。 
areas：允许或不允许区域TA列表。 
maxNumOfTAs：允许区域的最大TA数量，当restrictionType为ALLOWED_AREAS时此参数才有效，为NOT_ALLOWED_AREAS时此参数不出现。 
maxNumOfTAsForNotAllowedAreas：允许区域的最大TA数量（注意：不是非允许区域的最大TA数量），当restrictionType为NOT_ALLOWED_AREAS时此参数才有效，为ALLOWED_AREAS时此参数不出现。 
一个AM策略关联中最多有一个请求servAreaRes和一个授权servAreaRes。 
PCF下发的授权servAreaRes有几种表示方式： 
restrictionType|areas|maxNumOfTAs|maxNumOfTAsForNotAllowedAreas|含义
---|---|---|---|---
不携带|不携带|不携带|不携带|servAreaRes:{}表示全部TA都是允许区域
不携带|不携带|>0的整数|不携带|AMF自行确定maxNumOfTAs个TA作为允许区域，其它为非允许区域
不携带|不携带|不携带|>0的整数|AMF自行确定maxNumOfTAsForNotAllowedAreas个TA作为允许区域，其他为非允许区域
不携带|不携带|>0的整数|>0的整数|AMF自行确定允许区域
ALLOWED_AREAS|空的areas|不携带|不携带|areas:[]没有允许区域（全部TA都是非允许区域）
ALLOWED_AREAS|具体TA列表|不携带|不携带|仅areas指定的TA列表为允许区域，其它为非允许区域
ALLOWED_AREAS|具体TA列表|>0的整数|不携带|areas指定的TA列表为允许区域。如果该列表中TA数量小于maxNumOfTAs，则AMF可以再补充TA到允许区域，直至允许区域内TA数量达到maxNumOfTAs。如果该列表中TA数量大于maxNumOfTAs，则AMF从列表中动态确定maxNumOfTAs个TA作为允许区域，列表中剩余TA及列表外的TA都是非允许区域。
NOT_ALLOWED_AREAS|空的areas|不携带|不携带|areas:[]没有非允许区域（全部TA都是允许区域）
NOT_ALLOWED_AREAS|具体TA列表|不携带|不携带|仅areas指定的TA列表为非允许区域，其它为允许区域
NOT_ALLOWED_AREAS|具体TA列表|不携带|>0的整数|areas指定的TA列表为非允许区域，此外AMF可以动态决定列表外maxNumOfTAsForNotAllowedAreas个TA作为允许区域，剩下的列表外TA也作为非允许区域。
######## RFSP索引 
在AMF发送的请求中，rfsp参数代表AMF请求的RFSP索引。
在PCF下发的策略中，rfsp参数代表PCF授权的RFSP索引。 
如果AMF在Create/Update请求中携带请求rfsp，PCF就会在Create/Update响应中下发授权rfsp。 
PCF也可以主动在UpdateNotify中更新授权rfsp，如果不携带，则不更新。 
当收到Create/Update请求时，如果没有匹配的AM策略规则，PCF默认按请求rfsp下发授权rfsp。如果有匹配的AM策略规则，PCF按匹配的AM策略规则进行决策，确定授权rfsp。 
######## 保活 
为了防止PCF与AMF之间由于消息丢失等异常情况造成会话资源挂死，PCF利用Npcf_AMPolicyControl_UpdateNotify通知实现保活功能。当PCF与AMF之间的已建立的某个N15会话在一定时间内没有消息交互时，PCF构造携带无内容的PolicyUpdate的Npcf_AMPolicyControl_UpdateNotify通知发送到AMF，根据AMF返回的HTTP状态码来检测会话资源是否存在： 
如果通知响应的HTTP状态码为404 Not Found时，PCF就释放该N15会话资源；其他情况认为保活成功。 
如果超时未接收到通知响应，PCF则等待10分钟后重发保活消息，最多重发3次。PCF若一直都未接收到应答消息，则认为该N15会话挂死并释放。 
可通过“网元间保活检测配置”开启或关闭N15会话的保活功能，并设置保活消息间隔时长。 
######## DNN Replacement控制 
AMF在发送的Npcf_AMPolicyControl_Create请求中，会携带allowedSnssais和支持DNNReplacementControl的指示。 
在PCF下发的Create响应中，会携带根据allowedSnssais决策的SMF选择信息（smfSelInfo）并且订阅allowedSnssais变更事件和SMF选择信息变更事件。 
当allowedSnssais变更或SMF选择信息变更，AMF会发送Npcf_AMPolicyControl_Update请求，其中携带allowedSnssais及UE选定的DNN信息。PCF根据allowedSnssais决策出替换的DNN，在Npcf_AMPolicyControl_Update响应下发给AMF进行DNN替换。 
######## 重发 
当PCF向AMF发送AM策略关联修改请求、AM策略关联终止请求等业务交互消息时，如果发现HTTP通讯故障或对端服务层故障，则PCF会根据AMF在Npcf_AMPolicyControl_Create请求中携带的备选IP进行重发请求。如果重发失败，则根据AMF携带的guami发现AM，如果发现成功则向该AMF重发请求。 
######## Token授权认证 
在N15接口PCF作为服务提供者时，可根据开关1265（N15接口Oauth安全校验开关）决定是否需要进行Token授权认证。 
当1265开关开启时，PCF会对AMF发过来的请求消息进行校验。校验步骤如下： 
PCF从http的Authorication参数中获取Token串，并使用NRF的密钥进行解密；解密失败，PCF返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
PCF对于Token串中的内容进行验证： 
subject（NFS consumer的NF id）：请求消息中携带的NF id和校验token解密出的授权NF id 是否一致。 
audience（NFS producer的id和type）：producer是否符合audience的NF id或者type。 
scope（NFS producer service name）：请求访问的service是否在scope范围内。 
expiration（有效期）：当前时间戳是否超过有效期，可适当允许有效期误差。 
scope检查以外的失败返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
scope检查失败返回响应HTTP status code: "403 Forbidden"，携带头"WWW-Authenticate"，其中的error为"insufficient_scope"。 
因为各网元可能有微小的差异，因此提供了在NRF策略配置中增加了"令牌有效期允许最大偏差(秒)"的配置。如果expiration超过当前时间，但是在此误差以内，依然认为有效。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|3GPP TS 23.501|System Architecture for the 5G System (R15)
3GPP|3GPP TS 23.502|Procedures for the 5G System (R15)
3GPP|3GPP TS 23.503|Policy and Charging Control Framework for the 5G System(R15)
3GPP|3GPP TS 29.507|Access and Mobility Policy Control Service(R15)
3GPP|3GPP TS 29.571|Common Data Types for Service Based Interfaces(R15)
##### 特性能力 
名称|指标|说明
---|---|---
允许区域TA列表最多TA数量|16（个）|一个允许区域中最多包含的TA数量。
非允许区域TA列表最多TA数量|16（个）|一个非允许区域中最多包含的TA数量。
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
####### 对其他网元的要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
配置项表3  新增的命令编号命令项命令名称描述1AM上报事件配置SET AMEVENT修改AM上报事件SHOW AMEVENT查询AM上报事件2网元间保活检测配置SET SESSKADCT:RESTYPE="N15",KATYPE="EXTERNAL",KATIME="240"修改N15会话保活时长 
定时器表4  定时器定时器编号定时器名称系统缺省值(毫秒)建议2050FSWAITBEARER6000不建议修改2051FSWAITRELEASE8000不建议修改 
全局变量表5  全局变量参数编号参数名称系统缺省值建议1002用户签约来源1如果签约从SPR通过SP口获取签约，则修改为1如果签约从UDR通过N36口获取签约，修改为21209N15是否发送消息获取签约开关0如果从UDR通过N36接口获取签约，则修改为1（开）1210构造URI的方式4不建议修改1216NFcodec版本控制开关0不建议修改1218AMF授权认证开关0如果需要进行AMF的HTTP授权认证，则修改为1（开）1238N15规则未输出是否从请求获取RFSP Index1如果未配置rfsp相关规则，则透传请求中携带的rfsp值1239N15规则未输出是否从请求获取限制区域1-1240AmPolicyId生成方式00-使用用户号码和时间戳1-使用用户号码2-使用用户号码且无Session
Id1247N15区域码字段名开关00-AreaCode1-AreaCodes1265N15接口Oauth安全校验开关 00-关闭1-打开 
动态管理释放用户IMSI标识为“460010101010000”的N15会话。RELEASE_N15_SESSION:SESSIONTYPE="N15Sess",USERKEYTYPE="IMSI",USERKEY="460010101010000"查询用户IMSI标识为“460010101010000”的N15会话的详细信息。SHOW_N15_SESSION:SESSIONTYPE="N15Sess",USERKEYTYPE="IMSI",USERKEY="460010101010000"触发用户IMSI标识为“460010101010000”的N15会话发起更新流程。UPDATE_N15_SESSION:SESSIONTYPE="N15Sess",USERKEYTYPE="IMSI",USERKEY="460010101010000"查询N15统计。SHOW_STAT_INFO:MODULE="RCP_N15"清除统计。CLEAR_STAT_INFO查看系统状态信息中的N15信息。SHOW_SYS 
####### 性能统计 
测量类型|性能计数器
---|---
N15接口测量|C520020001收到AM策略关联请求次数C520020002 发送AM策略关联应答次数C520020003 发送AM策略关联成功应答次数C520020004 收到AM策略关联建立请求次数C520020005 发送AM策略关联建立应答次数C520020006 发送AM策略关联建立成功应答次数C520020007 收到AM策略关联更新请求次数C520020008 发送AM策略关联更新应答次数C520020009 发送AM策略关联更新成功应答次数C520020010 发送AM策略关联更新通知请求次数C520020011 收到AM策略关联更新通知应答次数C520020012 收到AM策略关联更新通知成功应答次数C520020013 发送AM策略关联终止请求次数C520020014 收到AM策略关联终止应答次数C520020015 收到AM策略关联终止成功应答次数C520020016 收到AM策略关联删除请求次数C520020017 发送AM策略关联删除应答次数C520020018 发送AM策略关联删除成功应答次数
测量类型|性能指标名称
---|---
N15接口测量|（520029001）AM策略关联成功率（%）
（520029002）AM策略关联建立成功率（%）|N15接口测量
（520029003）AM策略关联更新成功率（%）|N15接口测量
（520029004）AM策略关联删除成功率（%）|N15接口测量
（520029005）AM策略关联通知成功率（%）|N15接口测量
（520029006）AM策略关联通知更新成功率（去除保活）（%）|N15接口测量
（520029007）AM策略关联通知终止成功率（%）|N15接口测量
（520029008）AM策略关联丢包率（%）|N15接口测量
（520029009）AM策略关联反向通知丢包率（%）|N15接口测量
####### 告警和通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置特性 
###### 配置说明 
ZXUN RCP的接入和移动性策略控制特性主要是通过配置不同的接入移动策略动作参数，设置不同条件下使用不同的RFSP Index和业务区域限制，达到对接入和移动下性策略进行控制的目的。
###### 配置前提 
接入和移动策略控制特性是RCP和AMF配合共同完成的，因此在配置此特性之前保证两个网元的功能及交互正常。
###### 配置过程 
图1  配置过程
[]images/image9.png)
配置过程包含如下几个步骤： 
在EM客户端配置页面的Npcf_PolicyManagement_0服务下，执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令新增基本的套餐信息。
在EM客户端配置页面的Npcf_PolicyManagement_0服务下，配置条件、动作参数、规则和场景配置。
###### 配置实例-用户注册时的接入和移动策略控制 
######## 配置场景 
用户接入时，根据签约信息下发相应的接入移动策略规则。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
策略类型|控制条件|决策参数
---|---|---
AMF接入移动策略|无|RFSP索引=2允许区域=1111
######## 业务配置关系 
图2  业务配置关系
[]images/image10.png)
######## 配置步骤 
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置动作参数。 
动作参数名称|参数名称|取值
---|---|---
allowed_tac1|动作参数类型|N15限制服务区域参数集
服务区域类型|allowed_tac1|TAC
TAC|allowed_tac1|1111
动作参数名称|参数名称|取值
---|---|---
action_amf|动作参数类型|接入移动策略参数集
RFSP索引|action_amf|2
服务区域限制决策方式|action_amf|配置
服务区域限制类型|action_amf|允许
限制服务区域操作集ID|action_amf|allowed_tac1
配置场景。 
场景名称|参数|取值
---|---|---
PolicyAMF|入 口1|入口类型|用户信息类
已选入口|PolicyAMF|入 口1|用户套餐
取值|PolicyAMF|入 口1|1
策略类型|PolicyAMF|AMF 接入移动策略|rule_amf
规则名称|规则参数|参数取值
---|---|---
rule_amf|优先级|10
动作类型|rule_amf|参数填充
日志开关|rule_amf|关闭
条件表达式|rule_amf|无
选中动作参数名称|rule_amf|action_amf
######## 配置脚本 
/*Role:PolicyAMF---Start*/ 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="allowed_tac1",TYPE="N15_SERV_AREA_RESTRICT",PARAMS="SYS.N15_SERVICE_AREA_TYPE"-"0"-"TAC"&"SYS.N15_SERVICE_AREA_TAC"-"0"-"1111";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_amf",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.RFSP_INDEX"-"0"-"2"&"SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"0"-"CONFIG"&"SYS.SERVICE_AREA_RESTRICTION_TYPE"-"0"-"ALLOW"&"SYS.SERVICE_AREA_RESTRICTION_ACT_ID"-"0"-"allowed_tac1";
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_amf",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="",ACTTYPE="PARAM",ACTNAME="action_amf",LOGFLAG="OFF",RULENO=0;
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="PolicyAMF",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="rule_amf",VALIDFLAG="ENABLE";
/*Role:PolicyAMF--End*/ 
###### 配置实例-移动性限制 
######## 场景说明 
对签约了特定套餐（例如移动固网套餐）的用户，限制其在特定允许区域内使用业务，允许区域在UDM签约，PCF按AMF请求值下发就可以，如果套餐用量超限，PCF将允许区域置空，表示全部区域都不允许。
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
策略类型|控制条件|决策参数
---|---|---
AMF接入移动策略|用量未超限|按请求值下发允许区域
用量超限|AMF接入移动策略|将允许区域置空
######## 业务关系 
图3  业务关系
[]images/image12.png)
######## 配置步骤 
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置策略的条件。 
条件属性参数|取值
---|---
条件名称|userstatus=1
选择策略变量|其他
策略变量类别|用户信息类
策略变量|用户状态
操作符|=
值类型|值
值|1
配置策略的动作参数。 
动作参数名称|参数名称|取值
---|---|---
allowed_area|动作参数类型|N15限制服务区域参数集
服务区域类型|allowed_area|TAC
动作参数名称|参数名称|取值
---|---|---
act_limit|动作参数类型|接入移动策略参数集
服务区域限制决策方式|act_limit|配置
服务区域限制类型|act_limit|允许
限制服务区域操作集ID|act_limit|allowed_area
动作参数名称|参数名称|取值
---|---|---
act_req|动作参数类型|接入移动策略参数集
服务区域限制决策方式|act_req|请求
配置策略的控制规则。 
规则名称|规则参数|参数取值
---|---|---
rule_request|优先级|10
动作类型|rule_request|参数填充
日志开关|rule_request|关闭
条件表达式|rule_request|{用户状态 = 1}
选中动作参数名称|rule_request|act_req
规则名称|规则参数|参数取值
---|---|---
rule_limit|优先级|10
动作类型|rule_limit|参数填充
日志开关|rule_limit|关闭
条件表达式|rule_limit|~{用户状态 = 1}
选中动作参数名称|rule_limit|act_limit
配置场景。 
场景名称|参数|取值
---|---|---
role_amf|入口1|入口类型|用户信息类
已选入口|role_amf|入口1|用户套餐
取值|role_amf|入口1|1
策略类型|role_amf|AMF接入移动策略|rule_request
rule_limit|策略类型|role_amf|AMF接入移动策略
######## 配置脚本 
/*Role:role_amf---Start*/ 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="userstsus=1",SVCKEY="SYS.USER_STATUS",OPERATOR="=",VALTYPE="VALUE",VALUE="1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="act_req",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"0"-"REQUEST";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="allowed_area",TYPE="N15_SERV_AREA_RESTRICT",PARAMS="SYS.N15_SERVICE_AREA_TYPE"-"0"-"TAC";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="act_limit",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"0"-"CONFIG"&"SYS.SERVICE_AREA_RESTRICTION_TYPE"-"0"-"ALLOW"&"SYS.SERVICE_AREA_RESTRICTION_ACT_ID"-"0"-"allowed_area";
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_request",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{userstsus=1}",ACTTYPE="PARAM",ACTNAME="act_req",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_limit",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="~{userstsus=1}",ACTTYPE="PARAM",ACTNAME="act_limit",LOGFLAG="OFF",RULENO=0;
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="role_amf",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="rule_request"&"rule_limit",VALIDFLAG="ENABLE";
/*Role:role_amf--End*/ 
###### 配置实例-AM策略支持DNN Replacement功能 
######## 场景说明 
UE上线时，PCF根据策略将allowedSnssais对应的备选DNN列表通过SmfSelectionData下发给AMF，同时订阅ALLOWED_NSSAI_CH和SMF_SELECT_CH触发器。 
AMF将使用PCF在策略更新中下发的SmfSelectionData控制新的PDU会话，而对当前PDU会话无影响。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
策略类型|控制条件|决策参数
---|---|---
AMF接入移动策略|DNN替换切片类型=1DNN替换切片=310000|替换的DNN
######## 业务关系 
图4  业务关系
[]images/%E6%B5%81%E7%A8%8B3.png)
######## 配置步骤 
配置基础信息。 
套餐配置：无套餐配置，默认所有用户都需要匹配本规则。 
配置策略的条件。 
条件名称|策略变量|取值
---|---|---
sst=1|DNN替换切片类型|1
sd=310000|DNN替换切片|310000
配置策略的动作参数。 
动作参数名称|参数名称|取值
---|---|---
dnn1|接入移动策略参数集|dnn1
配置场景。 
场景名称|参数|取值
---|---|---
PolicyAMF|入口|入口类型|无
策略类型|PolicyAMF|AMF接入移动策略|replaceDnn1
AMF接入移动策略规则 
规则名称|规则参数|参数取值
rule_amf|优先级|10
策略类型|rule_amf|AMF接入移动策略
日志开关|rule_amf|关闭
条件表达式|rule_amf|DNN替换切片类型=1DNN替换切片=310000
选中动作参数名称|rule_amf|dnn1
######## 配置脚本 
/*Role:replaceDnn1---Start*/ 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=1",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="1";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=2",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="2";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=3",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="3";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=4",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="4";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=5",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="5";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=6",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="6";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=7",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="7";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=8",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="8";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=9",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="9";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=10",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="10";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sst=11",SVCKEY="SYS.DNNRPLC_SST",OPERATOR="=",VALTYPE="VALUE",VALUE="20";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sd=310000",SVCKEY="SYS.DNNRPLC_SD",OPERATOR="=",VALTYPE="VALUE",VALUE="310000";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sd=320000",SVCKEY="SYS.DNNRPLC_SD",OPERATOR="=",VALTYPE="VALUE",VALUE="320000";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="sd=330000",SVCKEY="SYS.DNNRPLC_SD",OPERATOR="=",VALTYPE="VALUE",VALUE="330000";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn1",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"<P6LwM{F4VALsMiOfv0%:bNhdyahzJGwiMtPLmGP1sMW?^WGMWVH)Ub5clmM^euzc9AXvsZw7vE6Mk|i1TblxmS<I|}YEoJQxv!";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn2",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"eY:<&qBnoVl)8|4VXSxTkvNvln|o6u8kEvht7S2wZnokNU?uxx83eVyAvZaBFKWv?>a61cCczdY6(Y#QH}UV2EHxPR)GN0:M>5T";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn3",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"qJH&uUN#|vPOoJUw>j>uk1P@OP8N?eqp9(eE|eq<:?<k:RQ)m?P)0oT1>#O<sqOBherHsS&oR#}|&K(DJ)v<gB>FP>^tn^^*2Iy";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn4",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"XknxnBrmS:FHEx>A?!Z*zWU#vI2m>K6UgtDEh^clb3%P#cC@<NRXWYJbS>xP}DVaji0#yc7JfmL1yzeW6iD#0y|SwXUSNz#*4%4";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn5",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"Crb6{y3}iCB?ITCvT:VXTCBvB:Jrrwv%Y{l3To>:!!}VDZaI6hSb5dGHA9k@)212:m5OLu:XfiCSt|NzfpKNCCep>!a&#bj9!o9";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn6",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"vT5EkP1o2?:%HMZeBlU!iEmAT!T#Ku<rz1&T2*14ip(Z:2pwn3g({&TMPxzLdXoMadpcwSI01@Z>%8VaDotwd7ve*^b3>zP7|qj";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn7",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"u2@W4MFtz?A:CYolnXQBN*|Q%xp}wPFc4S{AQ!fB!PwO!6{7^::%@{E0TfmBh@NND)7F5m0hnwh7&bH5yC)kXYkAqH:{U:GKfN9";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn8",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"kla%I)5Q9Ihe05zM#J(P{!<e*jUAzT<5|y{HS|J#)cs)JdFXXYw2}Vh!|nNx1J&?ta)58%(0rMk}ZZS){An%f*0GdN>GIe):ocs";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn9",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"Y0MaTiv0tGSOAE:n6@nMqm:jgabbyn*hPCTVU8VzPZ7Bn2aVf!r)6PbnZO!JnQcpc*4iqZSrIb#hGppV92?fRC^#a1Y!Rm9gcd!";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn10",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"&oCIi0v@GUaN%dNugBL3|M@YP7(&MwQ%6EvoEc9wiM4xbR#rEZuCvHkw1Dm?loereJ158DBq9FYkI<>7VsJClg)O5G?rgd4v96A";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="dnn11",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.DNN_FOR_REPLACEMENT"-"VALUE"-"hJnH4%pQvlN^sr!^?09NxP?Y*EfNNN7^IuYMJzOr7lfzNrQ|rZ>Z!<{2BAP87WpPDzly){ZrHrdGS%Ew|BHayAdln#tu:44y&Ri";
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn1",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=1}&{sd=310000}",ACTTYPE="PARAM",ACTNAME="dnn1",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn2",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=2}&{sd=320000}",ACTTYPE="PARAM",ACTNAME="dnn2",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn3",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=3}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn3",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn4",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=4}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn4",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn5",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=5}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn5",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn6",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=6}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn6",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn7",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=7}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn7",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn8",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=8}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn8",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn9",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=9}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn9",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn10",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=10}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn10",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn11",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{sst=11}&{sd=330000}",ACTTYPE="PARAM",ACTNAME="dnn11",LOGFLAG="OFF",RULENO=0;
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="replaceDnn1",RULENAME="replaceDnn1"&"replaceDnn2"&"replaceDnn3"&"replaceDnn4"&"replaceDnn5"&"replaceDnn6"&"replaceDnn7"&"replaceDnn8"&"replaceDnn9"&"replaceDnn10"&"replaceDnn11",VALIDFLAG="ENABLE";
/*Role:replaceDnn1--End*/ 
##### 测试用例 
测试项目|根据用户签约信息对AMF接入的RFSP Index和业务区域限制授权。
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-用户注册时的接入和移动策略控制”进行配置。
测试过程|用户A在本地接入网络，通过AMF进行注册。RCP从SPR获取用户签约，用户签约了套餐1。查看用户上线以及接入情况。
通过准则|用户A在AMF上注册成功，RCP返回RFSP值为2，servAreaRes中restrictionType值为ALLOWED_AREAS，并携带areaCodes为1234。AMF根据RCP下发的接入和移动策略对用户进行控制。
测试条目|N15会话更新，对端回复失败响应
---|---
预置条件|N15接口相关配置正常。PCF和NRF对接正常。|N15接口相关配置正常。PCF和NRF对接正常。|N15接口相关配置正常。PCF和NRF对接正常。|N15接口相关配置正常。PCF和NRF对接正常。
测试步骤|用户上线，AMF向PCF发送N15 create消息发起N15会话上线，消息中携带备选IP和GUAMI。PCF向AMF返回N15 create响应消息。外部消息或网管命令触发PCF向AMF发送N15 notify请求消息主动更新策略。AMF向PCF发送N15 notify响应消息，响应码为404。执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|用户上线，AMF向PCF发送N15 create消息发起N15会话上线，消息中携带备选IP和GUAMI。PCF向AMF返回N15 create响应消息。外部消息或网管命令触发PCF向AMF发送N15 notify请求消息主动更新策略。AMF向PCF发送N15 notify响应消息，响应码为404。执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|用户上线，AMF向PCF发送N15 create消息发起N15会话上线，消息中携带备选IP和GUAMI。PCF向AMF返回N15 create响应消息。外部消息或网管命令触发PCF向AMF发送N15 notify请求消息主动更新策略。AMF向PCF发送N15 notify响应消息，响应码为404。执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|用户上线，AMF向PCF发送N15 create消息发起N15会话上线，消息中携带备选IP和GUAMI。PCF向AMF返回N15 create响应消息。外部消息或网管命令触发PCF向AMF发送N15 notify请求消息主动更新策略。AMF向PCF发送N15 notify响应消息，响应码为404。执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。
通过准则|N15会话主动更新失败，PCF仅发送了一次更新通知消息。执行SHOW_SYS、SHOW_N15_SESSION查询会话已被释放。数据区中N15会话已被释放。|N15会话主动更新失败，PCF仅发送了一次更新通知消息。执行SHOW_SYS、SHOW_N15_SESSION查询会话已被释放。数据区中N15会话已被释放。|N15会话主动更新失败，PCF仅发送了一次更新通知消息。执行SHOW_SYS、SHOW_N15_SESSION查询会话已被释放。数据区中N15会话已被释放。|N15会话主动更新失败，PCF仅发送了一次更新通知消息。执行SHOW_SYS、SHOW_N15_SESSION查询会话已被释放。数据区中N15会话已被释放。
测试条目|N15会话保活，保活失败3次后会话不释放
---|---
预置条件|N15接口相关配置正常。N15会话保活时长设置为10分钟，防挂死时间设置为55分钟。|N15接口相关配置正常。N15会话保活时长设置为10分钟，防挂死时间设置为55分钟。|N15接口相关配置正常。N15会话保活时长设置为10分钟，防挂死时间设置为55分钟。|N15接口相关配置正常。N15会话保活时长设置为10分钟，防挂死时间设置为55分钟。
测试步骤|1-1 用户上线，AMF向PCF发送N15 create消息发起N15会话上线，携带一个备选IP。1-2 PCF向AMF返回N15 create响应消息。2-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。2-2 AMF向PCF返回失败非404。2-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。2-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。3-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。3-2 AMF向PCF返回失败非404。3-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。3-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。4-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。4-2 AMF向PCF返回失败非404。4-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。4-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。5-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。5-2 AMF向PCF返回失败非404。5-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。5-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。6-1 10分钟后，查看PCF是否继续发起保活。6-2 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。6-3 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。7-1 5分钟后，执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。7-2 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|1-1 用户上线，AMF向PCF发送N15 create消息发起N15会话上线，携带一个备选IP。1-2 PCF向AMF返回N15 create响应消息。2-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。2-2 AMF向PCF返回失败非404。2-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。2-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。3-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。3-2 AMF向PCF返回失败非404。3-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。3-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。4-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。4-2 AMF向PCF返回失败非404。4-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。4-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。5-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。5-2 AMF向PCF返回失败非404。5-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。5-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。6-1 10分钟后，查看PCF是否继续发起保活。6-2 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。6-3 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。7-1 5分钟后，执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。7-2 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|1-1 用户上线，AMF向PCF发送N15 create消息发起N15会话上线，携带一个备选IP。1-2 PCF向AMF返回N15 create响应消息。2-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。2-2 AMF向PCF返回失败非404。2-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。2-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。3-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。3-2 AMF向PCF返回失败非404。3-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。3-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。4-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。4-2 AMF向PCF返回失败非404。4-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。4-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。5-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。5-2 AMF向PCF返回失败非404。5-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。5-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。6-1 10分钟后，查看PCF是否继续发起保活。6-2 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。6-3 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。7-1 5分钟后，执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。7-2 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。|1-1 用户上线，AMF向PCF发送N15 create消息发起N15会话上线，携带一个备选IP。1-2 PCF向AMF返回N15 create响应消息。2-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。2-2 AMF向PCF返回失败非404。2-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。2-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。3-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。3-2 AMF向PCF返回失败非404。3-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。3-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。4-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。4-2 AMF向PCF返回失败非404。4-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。4-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。5-1 10分钟后，PCF向AMF发送N15 notify消息发起保活。5-2 AMF向PCF返回失败非404。5-3 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。5-4 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。6-1 10分钟后，查看PCF是否继续发起保活。6-2 执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。6-3 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。7-1 5分钟后，执行SHOW_SYS、SHOW_N15_SESSION命令查询会话。7-2 执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令查询数据区中N15会话。
通过准则|第2~5次：N15会话保活失败，发送了两次保活请求消息。执行SHOW_SYS查询会话依然存在，执行SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第6次：PCF继续向AMF发送N15 notify消息发起保活。执行SHOW_SYS查询会话依然存在，SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第7次：执行SHOW_SYS、SHOW_N15_SESSION查询会话被释放。数据区中N15会话被释放。|第2~5次：N15会话保活失败，发送了两次保活请求消息。执行SHOW_SYS查询会话依然存在，执行SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第6次：PCF继续向AMF发送N15 notify消息发起保活。执行SHOW_SYS查询会话依然存在，SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第7次：执行SHOW_SYS、SHOW_N15_SESSION查询会话被释放。数据区中N15会话被释放。|第2~5次：N15会话保活失败，发送了两次保活请求消息。执行SHOW_SYS查询会话依然存在，执行SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第6次：PCF继续向AMF发送N15 notify消息发起保活。执行SHOW_SYS查询会话依然存在，SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第7次：执行SHOW_SYS、SHOW_N15_SESSION查询会话被释放。数据区中N15会话被释放。|第2~5次：N15会话保活失败，发送了两次保活请求消息。执行SHOW_SYS查询会话依然存在，执行SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第6次：PCF继续向AMF发送N15 notify消息发起保活。执行SHOW_SYS查询会话依然存在，SHOW_N15_SESSION查询会话信息未更新。数据区中N15会话依然存在。第7次：执行SHOW_SYS、SHOW_N15_SESSION查询会话被释放。数据区中N15会话被释放。
测试条目|根据N15会话上报的SmfSelectionData信息，下发相应替换的DNN。
---|---
预置条件|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。已添加DNN Replacement相关配置。RCP上按照配置实例进行配置。全局变量1359（AMF是否对不支持的DNN发起DNN Replacement）配置为1。将“允许的网络切片改变”配置为上报。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。已添加DNN Replacement相关配置。RCP上按照配置实例进行配置。全局变量1359（AMF是否对不支持的DNN发起DNN Replacement）配置为1。将“允许的网络切片改变”配置为上报。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。已添加DNN Replacement相关配置。RCP上按照配置实例进行配置。全局变量1359（AMF是否对不支持的DNN发起DNN Replacement）配置为1。将“允许的网络切片改变”配置为上报。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。已添加DNN Replacement相关配置。RCP上按照配置实例进行配置。全局变量1359（AMF是否对不支持的DNN发起DNN Replacement）配置为1。将“允许的网络切片改变”配置为上报。
测试步骤|建立N15会话，消息中suppFeat指示AMF支持DNN ReplacementControl功能，携带allowedSnssais切片信息。查看RCP下发匹配DNN Replacement配置中的DNN信息。更新N15会话，携带SmfSelectionData切片信息。查看RCP根据“接入移动策略控制”决策出的DNN信息。|建立N15会话，消息中suppFeat指示AMF支持DNN ReplacementControl功能，携带allowedSnssais切片信息。查看RCP下发匹配DNN Replacement配置中的DNN信息。更新N15会话，携带SmfSelectionData切片信息。查看RCP根据“接入移动策略控制”决策出的DNN信息。|建立N15会话，消息中suppFeat指示AMF支持DNN ReplacementControl功能，携带allowedSnssais切片信息。查看RCP下发匹配DNN Replacement配置中的DNN信息。更新N15会话，携带SmfSelectionData切片信息。查看RCP根据“接入移动策略控制”决策出的DNN信息。|建立N15会话，消息中suppFeat指示AMF支持DNN ReplacementControl功能，携带allowedSnssais切片信息。查看RCP下发匹配DNN Replacement配置中的DNN信息。更新N15会话，携带SmfSelectionData切片信息。查看RCP根据“接入移动策略控制”决策出的DNN信息。
通过准则|N15会话建立成功,RCP返回DNN信息正确，若有删除的切片，会下发切片信息。N15会话更新成功，RCP返回的DNN为更新请求上携带切片上的DNN。|N15会话建立成功,RCP返回DNN信息正确，若有删除的切片，会下发切片信息。N15会话更新成功，RCP返回的DNN为更新请求上携带切片上的DNN。|N15会话建立成功,RCP返回DNN信息正确，若有删除的切片，会下发切片信息。N15会话更新成功，RCP返回的DNN为更新请求上携带切片上的DNN。|N15会话建立成功,RCP返回DNN信息正确，若有删除的切片，会下发切片信息。N15会话更新成功，RCP返回的DNN为更新请求上携带切片上的DNN。
测试条目|N15第一次主动更新备选AMF回307，再次发送主动更新消息至新的AMF
---|---
预置条件|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。RCP上按照配置实例进行配置。PCF可通过NRF正常发现并建链。AMF发生容灾切换，新接管AMF尚未对该用户会话发起AM策略关联更新。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。RCP上按照配置实例进行配置。PCF可通过NRF正常发现并建链。AMF发生容灾切换，新接管AMF尚未对该用户会话发起AM策略关联更新。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。RCP上按照配置实例进行配置。PCF可通过NRF正常发现并建链。AMF发生容灾切换，新接管AMF尚未对该用户会话发起AM策略关联更新。|RCP运行正常，与周边NF通讯正常。N15接口相关配置正常。RCP上按照配置实例进行配置。PCF可通过NRF正常发现并建链。AMF发生容灾切换，新接管AMF尚未对该用户会话发起AM策略关联更新。
测试步骤|AMF向PCF发送N15 create请求消息发起AM策略关联建立，上线消息notifyUri携带FQDN。PCF向AMF发送N15 create响应消息响应AM策略关联建立成功。SPR发起签约变更。PCF通过notifyuri中的fqdn向NRF发现AMF，NRF返回AMF的信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。主选AMF响应307，并在location中携带新的AMF的信息。PCF根据新AMF的信息向NRF发现，NRF返回新AMF的地址等信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。AMF响应成功。|AMF向PCF发送N15 create请求消息发起AM策略关联建立，上线消息notifyUri携带FQDN。PCF向AMF发送N15 create响应消息响应AM策略关联建立成功。SPR发起签约变更。PCF通过notifyuri中的fqdn向NRF发现AMF，NRF返回AMF的信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。主选AMF响应307，并在location中携带新的AMF的信息。PCF根据新AMF的信息向NRF发现，NRF返回新AMF的地址等信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。AMF响应成功。|AMF向PCF发送N15 create请求消息发起AM策略关联建立，上线消息notifyUri携带FQDN。PCF向AMF发送N15 create响应消息响应AM策略关联建立成功。SPR发起签约变更。PCF通过notifyuri中的fqdn向NRF发现AMF，NRF返回AMF的信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。主选AMF响应307，并在location中携带新的AMF的信息。PCF根据新AMF的信息向NRF发现，NRF返回新AMF的地址等信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。AMF响应成功。|AMF向PCF发送N15 create请求消息发起AM策略关联建立，上线消息notifyUri携带FQDN。PCF向AMF发送N15 create响应消息响应AM策略关联建立成功。SPR发起签约变更。PCF通过notifyuri中的fqdn向NRF发现AMF，NRF返回AMF的信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。主选AMF响应307，并在location中携带新的AMF的信息。PCF根据新AMF的信息向NRF发现，NRF返回新AMF的地址等信息。PCF向发现到的AMF发送N15 notify请求消息发起AM策略变更通知。AMF响应成功。
通过准则|执行SHOW_SYS、SHOW_UE_SESSION命令查询会话 ，N15主动更新成功。N15会话信息内容正确。信令跟踪内容正确，且有2条主动更新消息。|执行SHOW_SYS、SHOW_UE_SESSION命令查询会话 ，N15主动更新成功。N15会话信息内容正确。信令跟踪内容正确，且有2条主动更新消息。|执行SHOW_SYS、SHOW_UE_SESSION命令查询会话 ，N15主动更新成功。N15会话信息内容正确。信令跟踪内容正确，且有2条主动更新消息。|执行SHOW_SYS、SHOW_UE_SESSION命令查询会话 ，N15主动更新成功。N15会话信息内容正确。信令跟踪内容正确，且有2条主动更新消息。
### 缩略语 
### 缩略语 
#### 3GPP 
3rd Generation Partnership Project第三代合作伙伴计划
#### 5GC 
5G Core Network5G核心网
#### AF 
Application Function应用功能
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### CHF 
Charging Function计费功能
#### CPE 
Customer Premises Equipment用户驻地设备
#### DNN 
Data Network Name数据网名称
#### EPC 
Evolved Packet Core演进的分组核心网
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### HSS 
Home Subscriber Server归属用户服务器
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### MME 
Mobility Management Entity移动管理实体
#### NEF 
Network Exposure Function网络开放功能
#### NF 
Network Function网络功能
#### NRF 
NF Repository Function网络仓储功能
#### NWDAF 
Network Data Analytics Function网络数据分析功能
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCF 
Policy Control Function策略控制功能
#### PCRF 
Policy and Charging Rules Function策略和计费规则功能
#### PDU 
Packet Data Unit分组数据单元
#### PEI 
Permanent Equipment Identifier永久设备标识
#### PLMN 
Public Land Mobile Network公共陆地移动网
#### RAN 
Radio Access Network无线接入网
#### RAT 
Radio Access Technology无线接入技术
#### RFSP 
RAT/Frequency Selection Priority无线/频率选择优先级
#### S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
#### SDP 
Session Description Protocol会话描述协议
#### SIP 
Session Initiation Protocol会话发起协议
#### SMF 
Session Management Function会话管理功能
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### TA 
Tracking Area跟踪区域
#### UDM 
Unified Data Management统一数据管理
#### UDR 
Unified Data Repository统一数据存储
#### UE 
User Equipment用户设备
#### ULI 
User Location Information用户位置信息
#### UPF 
User Plane Function用户平面功能
#### URI 
Uniform Resource Identifier统一资源标识符
### ZUF-59-53-052 PDU会话策略控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
PDU会话|UE通过SMF/UPF和数据网建立的一个连接，用于传输数据报文。
QoS|QoS是网络的一种安全机制，是用来解决网络延迟和阻塞等问题的一种技术。当网络过载或拥塞时，QoS能确保重要业务不受延迟或丢弃，同时保证网络的高效运行。
##### 描述 
####### 定义 
PDU会话策略控制是指RCP向SMF提供用于PDU会话管理的控制策略，简称SM策略。
PDU会话策略控制包括： 
PDU会话QoS控制：RCP向SMF提供授权的会话聚合带宽和缺省QoS（通过SessionRule的authSessAmbr和authDefQoS参数提供）。 
PDU会话计费控制：RCP指示SMF对PDU会话实施在线计费或离线计费，并提供计费系统地址（通过smPolicyDecision下的online、offline和chargingInfo参数提供）。 
PDU会话业务控制：RCP向SMF提供业务PCC规则，指定SMF对业务实施QoS控制、计费控制、业务流向控制（通过pccRule及其关联的qosDesc、chgDesc、traffContDecs参数提供）。 
####### 背景知识 
4G/5G融合策略控制
在5GC定义的4G/5G互操作场景中，无论用户通过5G还是4G接入SMF+PGW-C，SMF+PGW-C都是通过N7接口向PCF请求PDU会话策略控制。后来运营商又要求用户通过2G/3G也能接入SMF，并通过N7接口向PCF请求策略控制。所以，当前PCF能够通过N7接口对2/3/4/5G接入的PDU会话实施策略控制。
图1  4G/5G融合策略控制
[]images/image3.png)
在不启用PCF时，SMF也能基于从UDM获取的用户签约信息中的签约的会话聚合带宽和缺省QoS（Subscribed Session-AMBR & Default QoS），对PDU会话实施QoS控制。但这种基于UDM用户签约信息的QoS控制缺乏灵活性，不能随用户的位置变化、累计用量变化、时段变化等而动态调整。 
在启用PCF时，SMF可以向PCF请求PDU会话的控制策略，请求中包含SMF从UDM获取的签约的会话聚合带宽和缺省QoS。PCF可以基于UDR提供的策略签约信息及其他NF的输入信息，对PDU会话实施动态的个性化的策略控制。PCF可以批准或修改SMF提供的签约的会话聚合带宽和缺省QoS，据此生成授权的会话聚合带宽和缺省QoS，下发给SMF执行。PCF还可以向SMF提供PDU会话的计费控制策略和业务控制策略。 
相比于UDM的用户签约信息，UDR的策略签约信息更为详尽的说明了用户向运营商订购的各种服务及限制。UDR的策略签约信息包含用户类别（例如指示用户是VIP用户还是普通用户）及详细的套餐签约信息（用户可以同时购买多个套餐，每套餐签约信息包含套餐标识，可选包含套餐优先级、套餐起止时间、套餐用量门限、套餐适用的区域、套餐中允许或禁止的业务等信息）。 
4G网络QoS机制
图2  4G网络QoS机制
[]images/image4.png)
QoS控制的基本粒度是EPS承载(Bearer)，各分段承载间一一对应。 
QoS管控粒度较粗，单用户空口支持最多8个EPS承载，无法满足5G业务精细QoS控制需求，多段承载组成端到端承载建立信令开销大、过程慢，无法跟踪数据流QoS需求的变化，对于差异化的应用适配不够灵活。 
QoS映射机制为一层映射：使用包过滤器集直接将IP数据包映射到EPS Bearer上。 
UL：UE将数据包映射到EPS Bearer上，eNodeB、SGW按照各段承载间的一对一映射关系进行转发。 
DL：P-GW将数据包映射到EPS Bearer上，SGW、eNodeB按照各段承载间的一对一映射关系进行转发。 
5G网络QoS机制
图3  5G网络QoS机制
[]images/image5.png)
核心网取消承载概念，引入QoS Flow作为最小QoS控制粒度。单PDU会话支持最多64个QoS Flow，QoS管控更为精细。 
RAN侧决定QoS Flow→RAN侧承载的映射，给RAN侧更大自由度。单用户空口最多支持16个DRB（Data Radio Bearer，数据空口承载）。 
QoS映射机制为二层映射：先根据过包滤器集将IP数据包映射到QoS Flow，再根据QFI将其映射到对应的Radio Bearer上。 
UL：UE先通过过滤器集决定数据包应该映射到哪个QoS Flow上，在数据包头打上QFI标记，再将QoSFlow映射到Radio Bearer上，发送给AN；AN收到数据包后，在包头上携带QFI，发送给UPF。 
DL：UPF将数据包映射到QoS Flow上，在数据包头打上QFI标记，发送给AN；AN：收到数据包后，根据QFI将QoS Flow映射到Radio Bearer上，在包头上携带QFI，发送给UE。 
5GSQoS|EPSQoS|说明
---|---|---
QFI（QoS Flow ID）|EBI（EPS Bearer ID）|QFI（QoS Flow ID）|QFI/EBI由SMF/PGW分配，PCF/PCRF不感知。
5QI（5G QoS ID）|QCI（QoS Classifier ID）|5QI（5G QoS ID）|5QI/QCI是一个标量，每个5QI/QCI取值用于索引一组QoS特征（QoS Characteristics）值。协议定义了一组标准的5QI/QCI取值，标准5QI/QCI的取值基本是一一对应的，例如QCI=1和5QI=1都是用于通话音频，QCI=5和5QI=5都是用于IMS信令。除标准5QI/QCI外，运营商也可以预定义5QI/QCI，对应的QoS特征值在接入网预配置，而不需要通过信令传递。对于标准/预定义5QI，其QoS特征值中的某些参数（Priority Level、Averaging Window、Maximum Data Burst Volume）也可以通过每会话的信令来修改。5G QoS还支持动态5QI，PCF可以在PDU会话策略控制中下发动态5QI取值及对应的QoS特征值。
5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|Resource Type|Resource Type|取值：GBRNon-GBRDelay-critical GBR(5G新增)
Priority Level|5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|Priority Level|表示5GQoS流间的资源调度优先级；该参数用于区分一个UE的各个QoS流，也用于区分不同终端的QoS流。该参数值越小表示优先级越高。
Packet Delay Budget（PDB）|5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|Packet Delay Budget|PDB定义了UE和锚点UPF之间数据包传输的时延上限。
Packet Error Rate（PER）|5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|Packet Error Loss Rate|误包率定了一个上限，也就是数据包已经被发送端的链路层（如3GPP接入网的RLC层）处理了，但没有被对应的接收端提交给上层（如3GPP接入网的PDCP层）的比率上限。PER参数的作用是让网络配置合适的链路层参数（如3GPP接入网的RLC和HARQ配置）。
Averaging Window|5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|-|只用于GBR/Delay-critical GBR型QoS流。平均窗口是给GBR QoS Flow定义的，用于相关网元统计GFBR和MFBR。
Maximum Data Burst Volume（MDBV）|5G QoS Characteristics注：红色标注的参数在标准5QI中也可以通过每会话的信令调整取值。|-|只用于Delay-critical GBR类型QoS流。具有延迟关键资源类型的每个GBR QoS流应与一个MDBV相关联；MDBV表示5G-AN在一个5G-ANPDB期间需要服务的最大数据量。
Maximum Packet Loss Rate|-|Maximum Packet Loss Rate|最大丢包率，Only for GBR QoS Flow。
GFBR (Guranteed Flow Bit Rate)|GBR|GFBR (Guranteed Flow Bit Rate)|保障带宽，每个GBR型QoS Flow/承载有自己的GFBR/GBR参数。
MFBR (Maximum Flow Bit Rate)|MBR|MFBR (Maximum Flow Bit Rate)|最大带宽，每个GBR型QoS Flow/承载有自己的MFBR/MBR参数，且MFBR/MBR要大于等于GFBR/GBR。Non-GBR型QoS Flow/承载没有自己的MFBR/MBR参数，而是共用Session-AMBR/APN-AMBR及UE-AMBR的带宽限制。
ARP (Allocationand Retention Priority)|ARP|ARP (Allocationand Retention Priority)|抢占优先级，抢占优先级低的QoS Flow/承载在资源不足可能被其他高优先级QoS Flow/承载抢占而释放
Reflective QoS|-|Reflective QoS|反射QoS，只用于Non-GBR QoS Flow，UPF根据PCF/SMF指示对下行流设置反射QoS标记，UE对设置了反射QoS标记的下行流，将下行QoS参数反射到对应的上行流实施QoS控制
Notification Control|-|Notification Control|通知控制，只用于GBR QoS Flow，当RAN无法满足GFBR时通知核心网
Session-AMBR|APN-AMBR|Session-AMBR|PDU会话所有Non-GBR QoS Flow的MBR之和
UE-AMBR|UE-AMBR|UE-AMBR|UE所有Non-GBR QoS Flow的MBR之和，UE-AMBR由AMF/MME根据UDM/HSS签约下发给RAN做控制，PCF/PCRF不感知。
##### 应用场景 
该特性的主要应用场景包括： 
运营商期望提供多种类型的套餐满足不同用户需求。 
不同类型的套餐可以提供不同的带宽，包含不同的用量门限，超过用量门限要对用户限速或禁止上网。有的套餐是通用套餐，适用于任何流量；有的套餐是定向套餐，只能访问特定的业务。有的套餐适用于任何区域，有的套餐只能在非漫游或漫游适用。运营商可以在PCF上按每个套餐的具体策略要求来配置策略规则，在UDR中存放每个用户的策略签约信息（其中包含套餐签约信息）。 
运营商期望当用户使用特定业务时，能对该业务提供QoS保障。例如，当用户使用VoNR时，能够获得较好的通话质量。为此，IMS中的P-CSCF充当AF。在用户发起VoNR通话时，将VoNR媒体流信息和QoS要求发送给PCF，触发PCF构造PCC规则下发给SMF。SMF收到PCC规则后，通知UPF为VoNR媒体流建立专门的QoS
Flow，为VoNR媒体流传输提供保障带宽和较高的转发优先级。 
运营商期望对用户实施动态的计费控制。例如，对后付费用户，在非漫游时实施离线计费，在漫游时实施在线计费。 


##### 客户收益 




受益方|受益描述
---|---
运营商|基于用户的策略签约信息提供差异化的策略控制，满足不同用户需求。基于累计用量（可以是单个用户的累计用量，也可以是用户群组的累计用量）或网络忙闲调节PDU会话带宽，防止少数用户过度占用网络资源，避免网络拥塞。为增值业务提供更好的QoS，促进增值业务销售，增加运营商收益。
用户|在网络忙时能公平访问网络。使用增值业务时能获得更好的QoS体验。





##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图4](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new3a6f5c5053624bf1bc98760aad920695__7a2d7175-806f-4aa1-8d7d-3847c1eb9529)所示。RCP作为PCF，在PDU会话策略控制流程中主要涉及和SMF交互。
图4  系统架构
[]images/5GC%E7%89%B9%E6%80%A7-%E6%9E%B6%E6%9E%84%E5%9B%BE-PCF.png)
###### 各网元作用 
NF|说明
---|---
PCF|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向PCF提供UE接入信息，从PCF获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向PCF提供PDU会话信息，从PCF获取PDU会话策略，下发给UPF执行。
UPF|执行PDU会话策略。
AF|向PCF提供应用层的业务信息，请求PCF进行策略授权。例如对于VoNR(Voice over New Radio)业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给PCF。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|PCF收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和PCF的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的PCF。
UDR/SPR|向PCF提供策略签约信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向PCF提供消费门限信息，例如通知PCF某用户的月累计流量是否超过了特定门限。
###### 业务流程 
######## SM策略关联建立流程 
SM策略关联建立流程如[图5](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__08b633d4-f7eb-403d-a1a4-40917a0c0b81)所示。
图5  SM策略关联建立流程
[]images/image7.png)
流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联（也可将SM策略关联称为N7会话）。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含如下关键参数。
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-smpolicycontrol/v1/sm-policies:authority:PCF主机:端口，端口可选，默认80，主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80。
pduSessionType|PDU会话类型，取值包括IPV4、IPV6、IPV4V6等。
pduSessionId|PDU会话标识，整型，取值范围0～255。supi+pduSessionId唯一定位一个PDU会话。
dnn|数据网名称（Data Network Name，等同于EPC中的APN）。
sliceInfo|切片信息，其中包含：单个网络切片选择辅助信息S-NSSAI（Single NetworkSlice Selection Assistance Information）。
notificationUri|通知URI，即SMF后续接收PCF为该SM策略关联下发的SM策略更新通知请求(SMPolicyControl.UpdateNotify.request)的URI地址。
supi|签约用户永久标识（Subscriber Permanent Identifier，例如IMSI），紧急呼叫时可不携带。
gpsi|一般公共签约用户标识（Generic Public Subscription Identifier，例如MSISDN）。
pei|永久设备标识PEI（Permanent Equipment Identifier，例如IMEISV）。
subsSessAmbr|签约的会话聚合带宽（Subscribed Session AMBR）。
subsDefQos|签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp。
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type。
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN/NR_REDCAP等，类似于Gx接口的RAT-Type。
servingNetwork|接入网的PLMN ID，类似于Gx接口的3GPP-SGSN-MCC-MNC。
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号guami：全局唯一AMF标识对4G接入，包含：anGWAddr：SGW的IP地址。对2/3G接入，包含：sgsnAddr：SGSN的IP地址。
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
smfId|SMF的NF实例编号。
recoveryTime|SMF重启时间戳。
ipv4Address|UE的IPv4地址 [注1]。
ipv6AddressPrefix|UE的IPv6地址前缀[注1]。
ipDomain|IP域，当存在UE IPv4地址池重叠时，ipDomain +ipv4Address应当唯一[注1]。
suppFeat|支持特性列表，16进制数字串，对应的2进制数字串的每位代表N7接口的一个可选特性，个位代表第一个特性，十位代表第二个特性，以此类推。每位置0表示不支持该特性，置1表示支持该特性。具体特性列表参见TS29.512的5.8章节。SMF在Create请求中提供其所支持的特性列表全集，PCF在Create响应中提供协商后的特性列表，为PCF支持特性列表和SMF支持特性列表的交集。
accNetChId|缺省QoS Flow或整个PDU会话的接入网计费标识。包含如下参数：accNetChaIdValue：接入网计费标识取值refPccRuleIds：关联PCC规则，会话粒度的计费标识不用携带此参数sessionChScope：是否会话粒度的计费标识
chargEntityAddr|接入网计费地址，包含IPv4或IPv6地址或两者都有：anChargIpv4Addr：接入网计费地址IPv4anChargIpv6Addr：接入网计费地址IPv6
online|指示PDU会话是否开启在线计费。
offline|指示PDU会话是否开启离线计费。
qosFlowUsage|缺省QoS Flow的用途，取值：GENERAL：通用IMS_SIG：用于IMS信令
 说明： 
注1：对5G接入，SMF在SM策略关联建立请求中通常不携带UE IP地址信息，而是在N7会话建立后选择UPF，再分配UE地址，再通过SM策略关联更新请求上报PCF。对4G接入，SMF一般会在SM策略关联建立请求中携带UE
IP地址。 
如果RCP判断对该PDU会话策略控制需要用到该用户的SPR签约信息，并且RCP本地没有该用户的SPR签约信息，则RCP向SPR发生Sp接口UDR消息，请求获取该用户的签约信息。 
SPR在Sp接口UDA中返回用户签约。 
RCP再向SPR发送Sp'接口UDR消息，请求获取该用户的用量信息。 
SPR在Sp'接口UDA中返回用户用量。 
RCP根据会话接入信息、用户签约和用量信息等进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。向SMF发送Npcf_SMPolicyControl_Create响应，响应消息的HTTP头域Location字段中包含RCP为此SM策略关联生成的ResourceURI，json正文中包含SmPolicyDecision相关参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 201 Created —— http头域的status类似于diameter响应的Result-Code:location: {authority}/npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}，其中smPolicyId为PCF根据supi+pduSessionId+时间戳等信息生成的SM策略关联ID，例如：http://[2409:8069:5003:803::2:121]:80/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f。
sessRules|SessionRule列表，每个SessionRule主要包含：authSessAmbr：授权的会话聚合带宽authDefQos：授权的缺省QoSsessRuleId：会话规则IDrefUmData：引用的用量数据refCondData：引用的条件数据
pccRules|PccRule列表，每个PccRule主要包含：flowInfos：流信息appId：应用标识pccRuleId：PCC规则标识precedence：优先级refQosData：引用的QoS Data的qosIdrefTcData：引用的TrafficControlData的tcIdrefChgData：引用的计ChargingData的chgIdrefUmData：引用的UsageMonitoringData的umIdrefCondData：引用的ConditionData的condId
qosDecs|QoSData列表，每个QoSData主要包含：qosId：QoS编号5qi：5QImaxbrUl：最大上行请求带宽maxbrDl：最下下行请求带宽gbrUl：上行保障请求带宽gbrDl：下行保障请求带宽arp：抢占优先级qnc：QoS通知控制reflectiveQos：反射QoSsharingKeyDl：下行带宽共享键sharingKeyUl：上行带宽共享键priorityLevel：优先等级averWindow：平均窗maxDataBurstVol：最大突发流量maxPacketLossRateDl：最大下行丢包率maxPacketLossRateUl：最大上行丢包率defQosFlowIndication：缺省QoSFlow指示
chgDecs|ChargingData列表，每个ChargingData主要包含：chgId：计费数据编号meteringMethod：度量方法，取值DURATION/VOLUME/DURATION_VOLUME/EVENT，缺省时SMF自己决定度量方法offline：是否启用离线计费，取值TRUE/FLASE，缺省时默认FALSE，pccRule该参数缺省时对齐sessRule的。online：是否启用在线计费，取值TRUE/FLASE，缺省时默认FALSE，pccRule该参数缺省时对齐sessRule的。ratingGroup：计费键组。reportingLevel：计费话单上报粒度，取值SER_ID_LEVEL/RAT_GR_LEVEL/SPON_CON_LEVEL，缺省时SMF自己决定上报粒度。serviceId：业务标识sponsorId：赞助商标识appSvcProvId：应用服务提供商标识afChargingIdentifier：AF计费标识（旧），Uint32类型afChargId：AF计费标识（新），string类型，当SMF在suppFeat中指示支持AF_Charging_Identifier特性时，PCF才能下发该参数。
traffContDecs|TrafficControlData列表，每个TrafficControlData主要包含：tcId：流控数据标识flowStatus：流状态redirectInfo：重定向信息muteNotif：是否上报应用发生停止事件trafficSteeringPolIdDl：下行业务链策略编号trafficSteeringPolIdUl：上行业务链策略编号routeToLocs：一组RouteToLocation，每个必须包含dnai，可选包含routeInfo和routeProfIdtraffCorreInd：流量关联指示，布尔类型，为true时，如果一个会话中多个PCC规则各自下发了dnai列表，SMF要从中选择出common DNAI（即各dnai列表中都存在的dnai），用于相关业务流选择到相关的UPF进行传输。upPathChgEvent：包含AF订阅用户面路径改变事件的相关信息
umDecs|UsageMonitoringData列表，每个UsageMonitoringData主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolumeThreshold：流量门限volumeThresholdUplink：上行流量门限volumeThresholdDownlink：下行流量门限timeThreshold：时长门限monitoringTime：监控时间点nextVolThreshold：下个流量门限nextVolThresholdUplink：下个上行流量门限nextVolThresholdDownlink：下个下行流量门限nextTimeThreshold：下个时长门限inactivityTime：非活动时长，超过此时长没收到数据包后，停止时长用量监控exUsagePccRuleIds：排除会话用量监控的PCC规则标识（不计入会话用量）
qosChars|QosCharacteristics列表，每个QosCharacteristics针对一个5qi，主要包含：5qi：5QI，类似于4G的QCIresourceType：资源类型，取值GBR/Non-GBR/Delay-critical GBRpriorityLevel：资源调度优先级packetDelayBudget：UE和锚点UPF之间数据包传输的时延上限packetErrorRate：误包率，发送端已正确发送但接收端未正确接收的数据包比率averagingWindow：平均时间窗，只用于GBR/Delay-critical GBR型QoS流，UE、R(AN)、UPF按每个平均时间窗内的流量来度量GFBR和MFBR。maxDataBurstVol：最大包突发，只用于Delay-critical GBR类型QoS流。
conds|ConditionData列表，每个ConditionData主要包含：condId：条件编号activationTime：激活时间deactivationTime：去激活时间
chargingInfo|计费信息，主要包含：primaryChfAddress：首选CHF地址，FQDN格式的URIsecondaryChfAddress：次选CHF地址，FQDN格式的URI
online|指示PDU会话是否开启在线计费
offline|指示PDU会话是否开启离线计费
qosFlowUsage|缺省QoS Flow的用途，取值如下：GENERAL：通用IMS_SIG：用于IMS信令RCP按Create请求中此参数值回填Create响应中此参数值。
revalidationTime|重授权时间点，SMF到该时间点时需要再向PCF发送SM策略关联更新请求
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求
lastReqRuleData|RequestedRuleData列表，用于PCC规则级别的事件订阅，每个RequestedRuleData包含：refPccRuleIds：相关PCC规则编号reqData：请求的规则数据CH_ID：查询接入网计费标识MS_TIME_ZONE：查询时区信息USER_LOC_INFO：查询用户位置信息RES_RELEASE：订阅资源释放事件通知SUCC_RES_ALLO：订阅资源分配成功事件通知
lastReqUsageData|用于PCF向SMF查询用量，包含：refUmIds：相关UmId。allUmIds：所有UmId。refUmIds和allUmIds二选一使用。
ipv4Index|IPv4地址索引，用于指导SMF选择IPv4地址池
ipv6Index|IPv6地址索引，用于指导SMF选择IPv6地址池
suppFeat|PCF/SMF协商支持的特性列表，为PCF支持特性列表和SMF支持特性列表的交集。
######## SMF发起的SM策略关联修改流程 
SMF发起的SM策略关联修改流程如[图6](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__f967fea6-4b93-4301-b071-40cba4bd381d)所示。
图6  SM策略关联修改流程(SMF发起)
[]images/image8.png)
流程说明如下： 
当PCF订阅的事件发生时（例如PCF向SMF订阅了PLMN change事件后，UE移动导致用户接入的PLMN发生了变化），SMF向PCF发送Npcf_SMPolicyControl_Update请求，携带SM策略关联ID、事件号及事件相关信息。 
参数|说明
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/update，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./update:authority: PCF主机:端口
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求
notificationUri|通知URI，即SMF后续接收PCF为该SM策略关联下发的SM策略更新通知请求(SMPolicyControl.UpdateNotify.request)的URI地址
subsSessAmbr|签约的会话聚合带宽（Subscribed Session AMBR）
subsDefQos|签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN/NR_REDCAP等，类似于Gx接口的RAT-Type
servingNetwork|接入网的PLMN ID，类似于Gx接口的3GPP-SGSN-MCC-MNC
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号guami：全局唯一AMF标识对4G接入，包含：anGWAddr：SGW的IP地址。对2/3G接入，包含：sgsnAddr：SGSN的IP地址。
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
userLocationInfoTime|SMF获取userLocationInfo的NTP时间
ueTimeZone|UE所在时区
ipv4Address|UE的IPv4地址
relIpv4Address|释放的IPv4地址
ipv6AddressPrefix|UE的IPv6地址前缀
relIpv6AddressPrefix|释放的Ipv6地址前缀
addIpv6AddrPrefixes|增加的多个IPv6地址前缀
addRelIpv6AddrPrefixes|释放的多个IPv6地址前缀
ipDomain|IP域，当存在UE IPv4地址池重叠时，ipDomain +ipv4Address应当唯一
accNetChId|缺省QoS Flow或整个PDU会话的接入网计费标识包含如下参数：accNetChaIdValue：接入网计费标识取值refPccRuleIds：关联PCC规则，会话粒度的计费标识不用携带此参数sessionChScope：是否会话粒度的计费标识
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolUsage：流量使用量volUsageUplink：上行流量使用量volUsageDownlink：下行流量使用量timeUsage：时长使用量nextVolUsage：下个流量使用量（在monitoringTime之后的使用量，下同）nextVolUsageUplink：下个上行流量使用量nextVolUsageDownlink：下个下行流量使用量nextTimeUsage：下个时长使用量
appDetectionInfos|应用探测信息列表，每个appDetectionInfo包含：appId：应用标识instanceId：应用实例编号sdfDescriptions：业务流描述
ruleReports|ruleReport列表，每个ruleReport主要包含：pccRuleIds：PCC规则标识ruleStatus：PCC规则状态failureCode：PCC规则失败码
sessRuleReports|sessRuleReport列表，每个sessRuleReport主要包含：ruleId：会话规则标识ruleStatus：会话规则状态sessRuleFailureCode：会话规则失败码
PCF根据最新的会话接入信息、用户签约及用量信息重新进行策略决策，可能更新SM策略。PCF向SMF发送Npcf_SMPolicyControl_Update响应，如果PCF更新了SM策略，则将最新的SM策略包含在Update响应消息中。 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK:location:——update响应的http头域Location字段为空。
SmPolicyDecision相关参数|参考Create响应的SmPolicyDecision相关参数。
如果此次流程中SMF上报了用量，则PCF累计出最新的用量（例如当月用户总流量），并可以通过Sp'接口UDR消息更新到SPR，以便下次PDU会话建立时PCF能够从SPR取回再用于策略决策。 
SPR回复Sp'接口UDA消息。 
######## PCF发起的SM策略关联修改流程 
PCF发起的SM策略关联修改流程如[图7](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__aaf344bc-2f9a-43cb-af62-0346612f330f)所示。
图7  SM策略关联修改流程(PCF发起)
[]images/image9.png)
流程说明如下： 
PCF收到内部事件触发（如时段切换）或外部事件触发（如SPR通知PCF某用户的策略签约信息发生了变更），重新进行SM策略决策。如果决策出的SM策略发生变化，则PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify通知，其中包含最新的SM策略。 
参数|说明
HTTP Header关键参数|:method: POST:scheme: http 或https:path: {notificationUri}/update，{notificationUri}为SMF在Create请求中提供的notificationUri，例如：/nsmf-pdusession/v1/sm-contexts/sessionId-0000000013580c71026b/update:authority: SMF的主机:端口
resourceUri|SMF策略关联URI，和Creae响应http头域Location字段分配的resourceUri一致。
smPolicyDecision|SM策略，具体参数参见上述Create响应参数。
SMF执行最新的SM策略，向PCF发送Npcf_SMPolicyControl_UpdateNotify响应。响应消息中包含如下关键参数： 
参数|说明
HTTP Header关键参数|:status: 200 OK或204 No Content或400 Bad Request
UeCampingRep|如果PCF在UpdateNotify中订阅了ACC_TY_CH、PLMN_CH、SAREA_CH、SCELL_CH等事件，SMF在UpdateNotify响应回复200OK时可选携带UeCampingRep，提供UE最新接入信息，包含：accessType：接入类型ratType：无线接入类型servNfId：接入网关标识servingNetwork：接入网络userLocationInfo：用户位置信息ueTimeZone：UE所在时区netLocAccSupp：是否支持网络位置查询
PartialSuccessReport|SMF回复200 OK但部分策略安装失败时携带PartialSuccessReport，包括如下参数：failureCause：失败原因ruleReports：PCC规则报告sessRuleReports：会话规则报告ueCampingRep：UE位置信息policyDecFailureReports：包含一组PolicyDecisionFailureCode，取值：TRA_CTRL_DECS_ERR：业务流控制决策错误QOS DECS_ERR：QoS决策错误CHG DECS_ERR：计费决策错误USA_MON_DECS_ERR：用量监控决策错误QOS_MON_DECS_ERR：QoS监控决策错误CON_DATA_ERR：条件数据错误
ErrorReport|如果PCF下发的全部策略在SMF安装或执行失败，SMF回复400Bad Request，并携带ErrorReport，包含如下参数：error：含具体失败信息ProblemDetailsruleReports：PCC规则报告sessRuleReports：会话规则报告
######## SMF发起的SM策略关联终止流程 
SMF发起的SM策略删除流程如[图8](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__75aee14b-afbf-4dc9-9f2b-d657d6c7df37)所示。
图8  SM策略关联终止流程(SMF发起)
[]images/image10.png)
流程说明如下： 
在UE或SMF发起的PDU会话释放流程中，SMF查找到某PDU会话有相关的SM策略关联，向PCF发送Npcf_SMPolicyControl_Delete请求，请求PCF删除SM策略关联。请求中携带SM策略关联ID，可能还包含最后用量上报（即SM策略关联删除前SMF统计到用户已使用但SMF但还未上报的用量）。 
参数|说明
HTTP Header关键参数|:method: POST:scheme: http或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/delete，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./delete:authority: PCF主机:端口
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号guami：全局唯一AMF标识对4G接入，包含：anGWAddr：SGW的IP地址。对2/3G接入，包含：sgsnAddr：SGSN的IP地址。
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
userLocationInfoTime|SMF获取userLocationInfo的NTP时间
ueTimeZone|UE所在时区
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-KeyvolUsage：流量使用量volUsageUplink：上行流量使用量volUsageDownlink：下行流量使用量timeUsage：时长使用量nextVolUsage：下个流量使用量（在monitoringTime之后的使用量，下同）nextVolUsageUplink：下个上行流量使用量nextVolUsageDownlink：下个下行流量使用量nextTimeUsage：下个时长使用量
pduSessRelCause|PDU会话释放原因。可选，取值：PS_TO_CS_HO：sRVCC切换
PCF向SMF发送Npcf_SMPolicyControl_Delete响应。 
参数|说明
HTTP Header关键参数|204 No Content
如果Npcf_SMPolicyControl_Delete请求中有最后用量上报，PCF通过Sp'接口UDR消息将最后用量上报给SPR。 
SPR回复Sp'接口UDA消息。 
如果PCF确定此PDU会话结束后，PCF已不需要为该用户接收SPR策略签约变更通知（PCF本地已无该用户的其他会话），则PCF向SPR发送Sp接口UDR消息，通知SPR该用户在本PCF下线。 
SPR回复Sp接口UDA消息。 
######## PCF发起的SM策略关联终止流程 
PCF发起的SM策略关联终止流程如[图9](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__2aa52711-64d8-4429-bdcd-80ca6344fb06)所示。
图9  SM策略关联终止流程(PCF发起)
[]images/image11.png)
流程说明如下： 
PCF收到内部事件（如套餐过期）或外部事件（如SPR删除用户签约，通过Sp接口PNR消息通知PCF）。PCF进行策略决策，确定需要终止相关的SM策略关联。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify通知，包含如下关键参数。 
参数|说明
HTTP Header关键参数|:method: POST:scheme: http 或https:path: {notificationUri}/terminate，{notificationUri}为SMF在Create请求中提供的notificationUri:authority: SMF的主机:端口
resourceUri|SMF策略关联URI，和Creae响应http头域Location字段分配的resourceUri一致
cause|PCF终止SM策略关联的原因
SMF向PCF回复Npcf_SMPolicyControl_UpdateNotify响应。 
参数|说明
HTTP Header关键参数|204 No Content
后续流程同[SMF发起的SM策略关联终止流程](ZUF-90-06-001-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newe0f9fb58d14c4b11b3823c27ec888c78__e2bf2894-f83d-437a-bc2f-2a050dfc8194)。
###### 本网元实现 
######## 用户会话IP重复性校验 
UE向SMF建立PDU会话时，SMF为PDU会话分配一个或多个UE IP地址，并将所分配的UE IP地址通过N7会话上报给PCF。当出现异常（例如UE或SMF异常重启）时，旧的N7会话未正常释放，新的N7会话携带的UE IP地址和旧会话重复，PCF即认为旧会话为挂死会话。为了判断并释放挂死会话，PCF会在SMF每次上报新的UE IP地址时： 
若为IPv4地址，PCF根据“IP+IP-Domain-ID”或“IP+APN+切片信息+SMF的NFID”进行重复性校验；若会话信息同时携带IP-Domain-ID和APN，优先使用IP-Domain-ID。 
若为IPv6地址，PCF根据IP+APN+切片信息+SMF的NFID进行重复性校验。 
如果查找到重复UE IP地址的旧会话，则PCF对旧会话发起SM策略关联终止流程，通知SMF释放相关资源。 
注1：PCF只能在每个SC实例内对N7会话做IP重复性校验，如果两个N7会话分发到不同SC，即使IP重复，也无法做重复性校验。 
注2：RCP V7.22.10版本及之后，可按“DNN属性配置”确定每个DNN配置是否允许不同会话IP地址重复。“DNN属性配置”包含“DNN”和“是否允许IP重复”字段，并包含一条通配DNN（DNN="*"）的默认记录。如果一个DNN在“DNN属性配置”中没有自己的记录，则匹配默认记录。对允许IP重复的DNN，PCF不对相关会话做IP地址重复性校验（PCF不会因此类会话携带的IP地址和其他会话中携带的IP地址重复而释放别的会话，也不会因别的会话中携带的IP地址和此类会话携带的IP地址重复而释放此类会话）。如果Rx/N5会话绑定多个N7会话且其中存在DNN允许IP重复的会话，则绑定失败。对于Rx会话，PCF在AAA消息中返回5065-DIAMETER_UNALBE_TO_COMPLY失败码；对于N5会话，PCF在Create响应返回500
Internal Server Error（SYSTEM_FAILURE）。 
######## 用户会话pduSessionId重复性校验 
对于5G UE，pduSessionId由UE生成，可以保证每个UE的每个PDU会话的pduSessionId唯一。对于4G
UE接入SMF，PCF开启N7接口的场景，4G UE不会生成pduSessionId，SMF可以根据EPS Bearer Id（由MME生成，可以保证唯一）来生成pduSessionId，并且和5G
UE生成的pduSessionID范围区分开（5G UE生成的pduSessionID是1~15，中兴通讯SMF为4G UE生成的pduSessionID，低4个bit位为EPS
Bearer Id，高4个bit位全1）。RCP实现了根据SUPI+pduSessionId做N7会话重复性校验功能，如果两个N7会话的SUPI+pduSessionId一致，且pduSessionId取值非0，则认为旧N7会话挂死；PCF会针对挂死的会话发起SM策略关联终止流程，通知SMF释放资源，然后根据新的消息建立会话。根据SUPI+pduSessionId判重有功能开关（全局开关1222，是否使用pduSessionId校验会话重复），默认开启，是目前N7会话最常用的判重方式。
######## 会话保活 
为了防止PCF与SMF之间由于消息丢失等异常情况造成N7会话资源挂死，PCF利用Npcf_SMPolicyControl_UpdateNotify通知实现会话保活功能。当“网元间保活检测配置”存在“资源类型”为“DPI
IP-CAN会话”且“保活方式”为“网元间保活”的配置记录，且PCF与SMF之间的已建立的某个N7会话在一定时间内没有消息交互时，PCF构造Npcf_SMPolicyControl_UpdateNotify通知发送到SMF，携带无内容的smPolicyDecision，根据SMF返回的HTTP状态码来检测会话资源是否存在： 
如果SMF返回的HTTP状态码为2XX时，PCF认为该PDU会话有效，保活成功。 
如果SMF返回的HTTP状态码为404 Not Found时，PCF就释放该PDU会话资源。 
如果SMF返回的HTTP状态码为其他错误，或者SMF未返回响应时，保活失败。 
PCF按“网元间保活检测配置”的“保活周期”（默认4小时）重试会话保活。如果会话在SMF和PCF之间无成功交互时长超过“资源扫描配置”中“资源类型”为“DPI
IP-CAN会话”的配置记录的“强制释放时长”所规定的时长，则PCF强制释放该会话，不通知SMF。 
######## 会话重授权 
PCF可以下发revalidationTime（简称RT）给SMF，RT是一个绝对时间点（精确的说明年月日时分秒）。SMF需在此时间点发送Update请求携带RE_TIMEOUT事件，触发PCF重新进行策略决策，并可能生成新的策略规则和新的RT，在响应中下发给SMF，起到会话重授权的作用。如果PCF侧会话已异常释放（未通知到SMF），PCF在响应中回复404
Not Found，也可以促使SMF删除对应会话，保证SMF和PCF双方会话一致。 
revalidationTime的相关配置参见“ZUF-59-52-001 基于时段的策略
”的“实现原理”的“本网元实现”中的会话授权时长和revalidationTime的相关描述。
######## 用户会话数量限制 
RCP允许一个用户并发的N7+Gx会话数上限为11个，达到上限后RCP会拒绝新会话建立。此外，RCP收到N7/Gx会话建立请求，或因容灾倒换等原因从CDB加载会话数据时，会根据“同用户同DNN多会话审计配置”检测同用户同DNN最久未交互N7/Gx是否挂死，挂死则清理。“同用户同DNN多会话审计配置”各字段含义及RCP的对应处理逻辑如下： 
字段名|类型|取值范围|默认值|作用
---|---|---|---|---
会话数门限|整型|1~11|2|N7/Gx会话建立或RCP容灾接管从CDB加载用户数据时，RCP检查“同用户同DNN会话数>=会话数门限 &（该用户该DNN最久未交互会话的最后更新时间点-当前时间点>静默时长门限）”时，对此用户此DNN最久未交互会话做一次审计（主动保活）。注1：确定是否相同用户时只看主用户标识（即由“用户标识类型优先级配置”的“首选用户标识类型”确定）。注2：取值1代表RCP不启用同用户同DNN多会话审计功能。
重试次数|整型|0~5|1|会话审计保活失败后重试次数。重试达上限后仍失败则直接释放会话，不再发释放通知给SMF/PGW。
静默时长门限（秒）|整型|0~65535|6|静默时长门限和会话数门限一起作为同用户同DNN多会话审计的触发条件。某些UE上线后立即在某个DNN上同时发起多会话，设置静默时长门限是为了减少此类场景下RCP触发老会话审计，减少SMF/PGW侧事务冲突。
初始间隔（秒）|整型|3~3600|12|老会话（最久未交互会话）满足上述审计条件后，RCP在【初始间隔，初始间隔+离散区间】内产生一个随机值（按毫秒），按此随机值设置定时器，定时器到期后，触发对老会话的主动保活。这样可以平滑RCP主动保活信令量冲高，例如DC倒换后，Gx会话批量重建信令量冲高，引发PCF老会话审计保活到DRA的信令量冲高。初始间隔设置为12s以上，是因为：现网最常见的4G切3G失败导致会话挂死重建，SMF侧挂死会话释放时长为10s，PCF设置为12s秒可以尽量让SMF自己先释放挂死会话，减少PCF的老会话审计保活。5G接入N7会话Create后立即会有Update，将老会话审计延迟12s以上，可以先处理新会话的Update，避免老会话审计影响新会话Update时延。
重试间隔（秒）|整型|30~3600|120|老会话审计时，RCP主动保活老会话：若保活成功（收到diameter2001/2002/http2xx），则维持该会话，更新该会话的最后交互时间戳。若保活失败（如下三种场景之一），则可配再保活一次。本参数指示下次重试保活前的间隔。保活请求发送失败。保活响应超时。收到失败响应但非5002/404（这两个失败码表示SMF/PGW侧该会话已不存在，RCP可以直接释放该会话）且非失败码307/308/3006（这三个失败码指示RCP对请求重定向）且非例外失败码。注1：若保活收到例外失败码，此时无法判断SMF有没有被保活会话，视为保活成功，不再重试保活，但也不刷新会话更新时间戳，此类会话若长时间无交互，则根据RCP资源扫描配置，默认24小时释放。注2：老会话审计的初次或下次保活前，若相同用户+DNN上有新会话建立，则新会话建立后立即触发老会话保活。注3：老会话审计的初次或下次保活前，若老会话因其它业务流程刷新了会话最后更新时间，则取消老会话保活。
例外失败码|字符串|长度0~64（含'\0'）|400,429,503,3004|若保活收到例外失败码，视为保活成功，不再重试保活，但也不刷新会话更新时间戳。本字段为字符串，只允输入数字和英文逗号。多个失败码间用逗号隔开。diameter失败码和http失败码可以混在一起配，3位数的为http失败码，4位数的为diameter失败码。缺省值：400（针对SMF不兼容RCP主动活请求的场景）和429/503/3004（针对SMF/PGW过负荷场景）。
离散区间（秒）|整型|0~3600|120|用于平滑新会话建立TPS冲高引发的老会话反向保活TPS冲高。
######## 会话规则 
N7接口的会话规则（SessRule）中主要包含授权会话聚合带宽（authSessAmbr）和授权缺省QoS（authDefQoS）。如果PCF进行N7会话决策时没有匹配的N7会话策略，则不会下发SessRule或将已下发的SessRule删除，相应的authSessAmbr和authDefQoS就不会下发或随SessRule删除而删除。对于SMF来说，如果PCF在Create响应中没有下发SessRule，SMF可以按用户在UDM签约的SessAmbr和DefQoS实施QoS控制。但如果PCF下发了SessRule之后又删除该SessRule（导致会话没有SessRule），SMF可能仍按之前SessRule中的authSessAmbr和authDefQoS实施QoS控制，这可能导致异常（例如限速无法取消），所以建议要配置缺省的N7会话策略。 
RCP有全局开关1261控制没有配置N7会话规则时是否下发SessRule，默认下发，此时下发的SessRule的会话规则标识（sessRuleID）为auto_default_<会话哈希值>，并按之前Create/Update请求携带的subSessAmbr/subDefQoS来生成authSessAmbr/authDefQoS。 
如果PCF进行N7会话策略决策时有匹配的N7会话策略，则按匹配的N7会话策略配置来生成SessRule的sessRuleID、authSessAmbr、authDefQoS等参数，其中authSessAmbr/authDefQoS可配置为固定值或按之前Create/Update请求携带的subSessAmbr/subDefQoS来生成。 
######## PCC规则 
N7/Gx接口的PCC规则都是用于业务策略控制。N7/Gx接口的主要异同点如下： 
N7/Gx接口的PCC规则都是可以预定义PCC规则或动态PCC规则，预定义PCC规则只需要PCF/PCRF提供规则标识，而动态PCC规则需要PCF/PCRF提供规则内容。 
Gx接口有预定义PCC规则组（Charging-Rule-Base-Name），N7接口没有，需要SMF自行定义PCF下发的哪些预定义PCC规则视为PCC规则组。 
Gx接口有Charging-Rule-Install和Charging-Rule-Remove来安装和释放PCC规则（组），N7接口没有专门的Install/Remove参数，PCF下发具体pccRuleId表示安装，将具体pccRuleId置为null表示删除。 
PCC规则中precedence代表PCC规则优先级，值越小优先级越高，appId或flowInfos代表PCC规则过滤器（即PCC规则适用的业务流），如果一条业务流同事匹配多个PCC规则的过滤器，按优先级高的PCC规则的控制参数执行相关策略。对中兴SMF来说，动态PCC规则的优先级均高于预定义PCC规则。 
######## 事件订阅 
PCF能够基于SMF上报的用户信息、承载事件及状态等，进行规则决策。SMF上报的大部分事件依赖于PCF的订阅。 
PCF支持事件订阅功能，可通过“默认上报事件配置”、“上报事件配置”、关联NF动态更新、特定业务规则授权等触发： 
默认上报事件通过命令SET DEFPCEFEVENT配置，该配置适用于所有用户的PDU会话，可在需要对本网元的用户会话进行统一配置时使用。 
上报事件通过命令ADD PCEFEVENT配置，该配置适用于特定类型的用户或使用特定业务的用户；可在需要对用户PDU会话进行定制化订阅事件配置时使用。配置中通过“应用标识+用户类型”来确定特定类型的用户，通过“套餐”来确定使用特定业务的用户。 
当PDU会话绑定了AF会话时，AF通过N5或Rx接口订阅的事件，也会在PDU会话订阅的事件中体现。 
当PDU会话决策产生了应用于应用探测，或流量累计相关的规则时，PDU会话订阅的事件会包括APP_STA、APP_STO、US_RE等几个事件。 
特别的，对于（默认）上报事件配置： 
由于订阅事件过多会造成PCF和SMF网元间信令交互的增加，加剧网络负荷，所以建议默认关闭所有事件订阅，根据运营需求开启需要的事件。 
事件配置适用于N7或Gx接口，PCF融合网元会根据协议定义的接口能力，适配配置中的某个事件项配置。 
以下为网管配置的事件订阅及Gx/N7对应的事件和参数。 
网管配置项名称|Gx接口事件|N7接口事件|备注|Gx接口事件描述|N7接口事件描述
---|---|---|---|---|---
SGSN相关信息改变|SGSN|SGSN_CHANGE(0)|-|-|SGSN地址改变，对应3GPP-SGSN-Address或 3GPP-SGSN-Ipv6-Address参数改变|按运营商定制2/3G接入走N7接口方案，SGSN改变时N7接口用SCNN_CH事件
QoS相关信息改变|QOS|QOS_CHANGE(1)|-|-|PCEF向PCRF请求的QoS发生改变（例如由于HSS签约QoS改变），PCEF上报改变后的QoS-Information|-
RAT改变|RAT|RAT_CHANGE(2)|RAT_TY_CH|-|无线接入方式改变，对应RAT-Type参数改变|无线接入方式改变，对应ratType参数改变
TFT改变|TFT|TFT_CHANGE(3)|-|-|-|-
PLMN相关信息改变|PLMN|PLMN_CHANGE(4)|PLMN_CH|-|PLMN改变，对应3GPP-SGSN-MCC-MNC参数改变|PLMN改变，对应servingNetwork参数改变
IP-CAN类型改变|IPCAN|IP_CAN_CHANGE(7)|AC_TY_CH|-|接入网类型改变，对应IP-CAN-Type参数改变|接入网类型改变，对应accessType参数改变
RAI相关信息改变|RAI|RAI_CHANGE(12)|RAI_CH|-|2/3G路由区改变，对应RAI参数改变|2/3G路由区改变，对应userLocationInfo下的geraLocation或utraLocation中的rai参数改变，属于运营商定制2/3G接入走N7接口需求
用户位置信息改变|USERLOC|USER_LOCATION_CHANGE(13)|SCELL_CH|-|用户位置改变（CGI/SAI/RAI/TAI/ECGI/Macro eNB ID改变），PCEF上报3GPP-User-Location-Info|服务小区改变，SMF上报userLocationInfo，协议只用于4G接入互操作时ECGI改变，运营商定制扩展至2/3/4/5G接入小区改变
承载丢失|BEARERLOSS|LOSS_OF_BEARER(5)|-|-|2/3G承载速率降为0，PGW上报相关PCC规则状态为temporarily inactive|-
承载恢复|BEARERRECOV|RECOVERY_OF_BEARER(6)|-|-|2/3G承载速率从0恢复，PGW上报相关PCC规则状态为active|-
时区变化|TIMEZONE|UE_TIME_ZONE_CHANGE(25)|UE_TZ_CH|-|UE所在时区改变，对应3GPP-MS-TimeZone参数改变|UE所在时区改变，对应ueTimeZone参数改变
信用度不足|OUTCREDIT|OUT_OF_CREDIT(15)|NO_CREDIT|-|信用不足，PCEF上报相关PCC规则及Final-Unit-Indication参数|信用不足，SMF上报相关PCC规则及finUnitAct参数
信用度被重新分配|REALLOCCREDIT|REALLOCATION_OF_CREDIT(16)|REALLO_OF_CREDIT|-|信用重分配，PCEF上报相关PCC规则|信用重分配，SMF上报相关PCC规则
用户地址被重新分配|UEIPALLOC|UE_IP_ADDRESS_ALLOCATE(18)|-|-|UE IPv4地址分配，该事件不订阅也能上报|-
用户地址被释放|UEIPRELEASE|UE_IP_ADDRESS_RELEASE(19)|-|-|UE IPv4地址释放，该事件不订阅也能上报|-
默认EPS承载QoS改变|BEARERQOSCHG|DEFAULT_EPS_BEARER_QOS_CHANGE(20)|DEF_QOS_CH|-|缺省EPS承载QoS改变，该事件不订阅也能上报|缺省QoS改变，SMF上报subsDefQoS，该事件不订阅也能上报
接入网关改变|ANGWCHG|AN_GW_CHANGE(21)|-|-|接入网关改变，对应AN-GW-Address参数改变|N7接口对应SCNN_CH事件
资源分配成功|RESOURCEALLOC|SUCCESSFUL_RESOURCE_ALLOCATION(22)|SUCC_RES_ALLO|-|资源分配成功，PCEF上报相关PCC规则状态为active|资源分配成功，PCEF上报相关PCC规则状态为active
UE发起承载资源变更|RESOURCEMODREQ|RESOURCE_MODIFICATION_REQUEST(23)|RES_MO_RE|-|UE发起的资源修改请求，该事件不订阅也能上报|UE发起的资源修改请求，该事件不订阅也能上报
PGW跟踪激活或去激活|PGWTRACECTRL|PGW_TRACE_CONTROL(24)|-|-|PGW跟踪激活，PCEF上报Trace-Data参数；PGW跟踪去激活，PCEF上报Trace-Reference参数；该事件不订阅也能上报|-
Qos超出授权|QOSEXCAUTH|QOS_CHANGE_EXCEEDING_AUTHORIZATION(11)|-|-|2/3G承载QoS改变超出授权，PCEF上报带Bearer-Identifier的QoS-Information|-
TAI改变|TAICHGRPT|TAI_CHANGE(26)|-|-|TAI改变，PCEF上报3GPP-User-Location-Info携带TAI|-
ECGI改变|ECGICHGRPT|ECGI_CHANGE(27)|-|-|ECGI改变，PCEF上报3GPP-User-Location-Info携带ECGI|-
计费关联改变|CHARGINGCHG|CHARGING_CORRELATION_EXCHANGE(28)|AN_CH_COR|-|计费关联改变，PCEF上报Access-Network-Charging-Identifier-Gx及相关PCC规则|-
APN AMBR修改失败|APNAMBRMODFAIL|APN_AMBR_MODIFICATION_FAILURE(29)|-|-|APN-AMBR修改失败|-
默认EPS承载QoS修改失败|DFTEPSQOSMODFAIL|DEFAULT_EPS_BEARER_QOS_MODIFICATION_FAILURE（34）|-|-|缺省EPS承载QoS修改失败|-
会话AMBR改变|MAXMBRAPNAMBRCHG|/|SE_AMBR_CH|-|-|会话AMBR改变，SMF上报subsSessAmbr，该事件不订阅也能上报
子网改变|SUBNETCHG|SUBNET_CHANGE（2000）|-|私有事件|CDMA接入子网改变，对应3GPP-SGSN-Address或 3GPP-SGSN-Ipv6-Address参数改变|-
无线共享启动|TETHESTART|TETHERING_START(6001)|-|私有事件|无对应参数|-
无线共享停止|TETHESTOP|TETHERING_STOP(6002)|-|私有事件|无对应参数|-
用户共享下挂数量变更|TETHECOUNTCHG|TETHERING_COUNT_CHANGE(6003)|-|私有事件|用户共享下挂数量变更，PCEF上报Tethering-Count参数|-
热点共享启动|HOTSPOTSTART|HOTSPOT_SHARE_START (500)|-|私有事件|无对应参数|-
UE本地地址变更|UELOCIPCHG|UE_LOCAL_IP_ADDRESS_CHANGE(43)|-|-|UE本地地址变更，PCEF上报UE-Local-IP-Address和/或UDP-Source-Port|-
服务区域改变|SAREACH|-|SAREA_CH|-|-|服务区域改变，对应userLocationInfo下的nrLocation或eutraLocation中的tai参数改变
服务CN节点改变|SCNNCH|-|SCNN_CH|-|-|服务CN节点改变，SMF上报servNfId下的servNfInstId和guami（当AMF改变时）或anGwAddr（当S-GW改变时）或sgsnAddr（当SGSN改变时）
接入类型改变|ACCTYPECH|IP_CAN_CHANGE(7)|AC_TY_CH|-|接入类型改变，PCEF上报最新IP-CAN-Type和RAT-Type|接入类型改变，SMF上报最新accessType和ratType
UE IP地址改变|UEIPCH|-|UE_IP_CH|-|-|UE IPv4或IPv6地址分配或释放，该事件不订阅也能上报
UE MAC地址改变|UEMACCH|-|UEMAC_CH|-|-|UE MAC地址改变
信用管理会话失败|CMSESFAIL|-|CM_SES_FAIL|-|-|信用管理会话失败，指SMF-CHF间会话失败。如果涉及部分PCC规则，SMF上报相关PCC规则。如果涉及整个会话，SMF上报creditManageStatus
PS 数据离线状态改变|PSDAOFF|-|PS_DA_OFF|-|-|PS数据离线状态改变，SMF上报3gppPsDataOffStatus，该事件不订阅也能上报
Qos通知控制|QOSNTFCTL|-|QOS_NOTIF|-|-|QoS通知控制，SMF上报qncReports
资源释放结果指示|RESRELEASE|-|RES_RELEASE|-|-|资源释放通知，SMF上报的ruleReport中携带ranNasRelCauses
反射Qos指示改变|REFQOSINDCH|-|REF_QOS_IND_CH|-|-|反射QoS支持改变，SMF上报refQosIndication指示UE是否支持反射QoS
以下为当前版本支持的不是通过网管配置订阅的事件： 
Gx接口事件|N7接口事件|应用场景
---|---|---
NO_EVENT_TRIGGERS（14）|null|取消事件下发
REVALIDATION_TIMEOUT(17)|RE_TIMEOUT|决策输出了对应的刷新时间点，且承载能力了配置支持下发Revalidation-Time
USAGE_REPORT (33)|US_RE|下发用量配额时订阅
APPLICATION_START(39)|APP_STA|决策输出了业务探测规则
APPLICATION_STOP(40)|APP_STO|决策输出了业务探测规则
ACCESS_NETWORK_INFO_REPORT(45)|AN_INFO|AF查询位置信息时订阅
CHANGE_OF_UE_PRESENCE_IN_PRA_REPORT(48)|PRA_CH|决策输出了PRA规则
/|USER_LCOATION_CH|当SMF支持AggregatedUELocChanges特性（Create请求SuppFeat参数中第42个特性置为1）时，如果N7接口需要下发SCELL_CH+ SAREA_CH，RCP自动转换为USER_LCOATION_CH下发（这时SCELL_CH和 SAREA_CH不下发）
######## Token授权认证 
在N7接口PCF作为服务提供者时，可根据开关1208（N7接口Oauth安全校验开关，开关默认不开启，开启后由于涉及密钥解密逻辑会导致系统性能下降）决定是否需要进行Token授权认证。 
当1208开关开启时，PCF会对SMF发过来的请求消息进行校验。校验步骤如下： 
PCF从http的Authorication参数中获取Token串，并使用NRF的密钥进行解密；解密失败，PCF返回响应HTTP
status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
PCF对于Token串中的内容进行验证： 
subject（NFS consumer的NF id）：请求消息中携带的NF id和校验token解密出的授权NF
id 是否一致。 
audience（NFS producer的id和type）：producer是否符合audience的NF id或者type。 
scope（NFS producer service name）：请求访问的service是否在scope范围内。 
expiration（有效期）：当前时间戳是否超过有效期，可适当允许有效期误差。 
scope检查以外的失败返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
scope检查失败返回响应HTTP status code: "403 Forbidden"，携带头"WWW-Authenticate"，其中的error为"insufficient_scope"。 
因为各网元可能有微小的差异，因此提供了在NRF策略配置中增加了"令牌有效期允许最大偏差(秒)"的配置。如果expiration超过当前时间，但是在此误差以内，依然认为有效。 
######## 热点控制 
N7会话上线时，PCF根据配置向SMF订阅热点事件触发功能，在响应消息中携带policyCtrlReqTriggers取值为“TETHERING_COUNT”。 
SMF检测到热点功能使用时，在SmPolicyUpdateContextData携带tetheringCount，用于tetheringcount值上报，同时携带policyCtrlReqTriggers取值为“TETHERING_COUNT”。 
PCF在会话中存储tetheringcount值，并根据规则配置条件匹配tetheringCount后下发决策策略。 
SMF再次检测到热点下挂设备数或状态变更时，能够再次通过更新请求上报，PCF根据最新的tetheringCount决策下发新的策略。 
######## 基于NR_REDCAP进行规则决策 
V7.22.30及之后版本支持基于ratType为NR_REDCAP策略条件进行策略决策，包括N7会话控制策略、N7业务控制策略、业务预下发控制策略、通知策略、业务级用量监控策略、会话级用量监控策略、套餐动态优先级策略、套餐预定义策略等决策。 
######## N7接口chargingCharacteristics处理 
N7接口Create请求可选携带chargingCharacteristics参数，用于SMF向RCP上报用户计费特性，例如用户是否启用在线或离线计费。chargingCharacteristics取值是4字节16进制数字字符串，常见的取值有0400、0800、0A00。chargingCharacteristics取值可展开为16个bit，每个bit取值0或1表示该bit对应的计费特性启用或关闭，每个bit位所对应的计费特性含义由运营商自定义。 
当用户SPR签约无Charging-Type参数时，RCP策略配置的业务键“付费类型”（USER_CHARGING_TYPE）或用户级策略计数器标识配置/套餐级策略计数器标识配置的“计费类型”可以从N7接口chargingCharacteristics取值，将chargingCharacteristics携带的4字节16进制数字字符串转换为10进制数值使用，若非4字节16进制数字字符串，则转换后取值为0。 
##### 系统影响 
该特性不涉及对系统的影响。 


##### 应用限制 





 
一个用户同时建立的PDU会话数最多为11个。 

 
单PDU会话最多支持140个业务规则。 

 
如果PCF在create响应中不下发session rule，中兴SMF会使用UDM签约的session-ambr和default-qos，如果PCF在update响应或updatenotify请求中删除了所有session
rule，中兴SMF会维持之前生效的session rule中的QoS策略。由于协议没有明确无session rule时SMF的处理行为，各厂商SMF实现上可能有异，为避免对接问题，PCF配置上，最好有个兜底策略规则保证总能下发session
rule。 

 




##### 特性交互 
该特性不涉及与其他特性的交互。 


##### 遵循标准 




类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System
3GPP|TS 23.502|Procedures for the5G System
3GPP|TS 23.503|Policy and ChargingControl Framework for the 5G System
3GPP|TS 29.512|Session ManagementPolicy Control Service




##### 特性能力 
名称|指标
---|---
单个用户（不管是以SUPI还是GPSI作为用户标识）最多允许同时建立的PDU会话数|11个
单会话最多支持的业务规则数|140个


##### 可获得性 




####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.20.P3|首次发布。


####### License要求 
本特性为ZXUN RCP的基本特性，无需License支持。


####### 对其他网元的要求 
无特殊要求。 




##### O&M相关 
####### 命令 
配置项表2  新增的配置命令编号命令项命令名称描述1承载能力配置ADD BEARABILITY增加承载能力SET BEARABILITY修改承载能力DEL BEARABILITY删除承载能力SHOW BEARABILITY查询承载能力2应用标识配置ADD APPSUBS增加应用标识SET APPSUBS修改应用标识DEL APPSUBS删除应用标识SHOW APPSUBS查询应用标识3上报事件配置ADD PCEFEVENT增加上报事件SET PCEFEVENT修改上报事件DEL PCEFEVENT删除上报事件SHOW PCEFEVENT查询上报事件4默认上报事件配置SET DEFPCEFEVENT修改默认上报事件SHOW DEFPCEFEVENT查询默认上报事件5网元间保活检测配置SET SESSKADCT修改网元间保活检测配置SHOW SESSKADCT查询网元间保活检测配置6会话授权时长默认配置SET SESSAUTHPRDDEF修改会话授权时长默认配置SHOW SESSAUTHPRDDEF查询会话授权时长默认配置7会话授权时长特定配置SET SESSAUTHPRDSPC修改会话授权时长特定配置SHOW SESSAUTHPRDSPC查询会话授权时长特定配置8DNN属性配置ADD DNNATTR增加DNN属性配置SET DNNATTR修改DNN属性配置DEL DNNATTR删除DNN属性配置SHOW DNNATTR查询DNN属性配置 
全局变量表3  新增的全局变量参数编号参数名称系统缺省值建议1099下发业务流只携带Out流开关1不建议修改1107非VoLTE接入时规则多实例是否需要修改优先级0不建议修改1138smPolicyId生成方式0不建议修改1139N7会话是否支持主动保活功能1不建议修改1143流描述的UE IP通配时是否采用assigned1不建议修改1221每用户第几个会话开始校验老会话是否有效5不建议修改1261如果会话或承载策略未配置，是否从请求中获取QCI、ARP、带宽开关1不建议修改 
定时器表4  新增的定时器定时器编号定时器名称系统缺省值(毫秒)建议2050FSWAITBEARER6000不建议修改2051FSWAITRELEASE8000不建议修改 
动态管理释放用户IMSI标识为“460010101010000”的所有N7会话：REL_SESS:SESSIONTYPE="N7Sess",USERKEYTYPE="IMSI",USERKEY="460010101010000"查询用户IMSI标识为“460010101010000”的N7会话的详细信息：SHOW_DPI_IPCAN_SESS:USERTYPE="RCP_QUERY_TYPE_IMSI",USERID="460010101010000"触发用户IMSI标识为“460010101010000”的N7会话发起更新流程：UPDATE_SESSION:SESSIONTYPE="N7Sess",USERKEYTYPE="IMSI",USERKEY="460010101010000" 
####### 性能统计 
编号|测量类型名称|描述
---|---|---
1|52001 N7接口测量|编号为C52001开头的所有计数器。
编号|测量类型名称|描述
---|---|---
1|52001 N7接口测量|编号为52001开头的所有性能指标。
####### 告警和通知 
该特性不涉及告警和通知的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置特性 
###### 配置说明 
本节将介绍PDU会话策略控制的几个典型配置实例，包括漫游时限速、内容计费套餐仅本地生效、园区业务本地分流。 


###### 配置前提 




PDU会话策略控制特性是RCP和SMF以及SPR配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常。 




###### 配置过程 
图1  配置流程
[]images/image12.png)
配置过程包含如下几个步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，在Npcf_PolicyManagement_0服务下执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令新增基本的套餐信息。
执行[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html)命令，配置承载能力，设置漫游判断条件。
执行[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html)命令，配置漫游属性。
在Npcf_PolicyManagement_0服务下配置漫游条件、动作参数、规则和场景配置。 
###### 配置实例-运营商根据用户是否漫游采取不同的会话控制策略 
######## 场景说明 
用户非漫游时按请求Session-AMBR和Default-QoS授权，漫游（订阅PLMN_CHG事件，按PLMN
ID判断漫游）时Session-AMBR限速，Default-QoS中ARP-Level降级（例如按漫游协议限速和降级，以适应漫游地接入网要求）。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|1
套餐类型|套餐|用户套餐
接入配置1|MCCMNC|46001
接入属性|接入配置1|本地
接入配置2|MCCMNC|46002
接入属性|接入配置2|漫游
策略类型|控制条件|决策参数
---|---|---
N7会话决策|漫游|会话AMBR上行速率=200kbps会话AMBR下行速率=200kbpsARP优先级=3
非漫游|N7会话决策|会话汇聚带宽决策方式=请求中的APN带宽ARP优先级决策方式=请求中的值
######## 业务配置关系 
图2  业务配置关系
[]images/image13.png)
######## 配置步骤 
配置基础信息。 
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="1",PRIORITY=1;
配置承载能力。 
[SET BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787318.html):ADJHOSTGRPID=10,ROAMCOND="MCCMNC";
配置上报事件。 
[ADD PCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787143.html):ID=1,PKGID="1",PLMN="YES";
配置MCC-MNC接入。 
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=1,ADJHOSTGRPID=0,MCC="460",MNC="01",ACCATTR="1";
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=2,ADJHOSTGRPID=0,MCC="460",MNC="02",ACCATTR="2";
配置漫游属性。 
[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html):ACCATTR="1",ROAMFLAG="NO",ACCTYPE="MCCMNC";
[ADD ACCMAP](../../Npcf_PolicyManagement\zh-CN\mml\1787290.html):ACCATTR="2",ROAMFLAG="YES",ACCTYPE="MCCMNC";
配置规则条件。 
条件名称|参数|取值
---|---|---
IsLocal|选择策略变量|其他
策略变量类别|IsLocal|接入信息类
策略变量|IsLocal|漫游标识
操作符|IsLocal|=
值类型|IsLocal|值
值|IsLocal|本地
配置规则动作参数。 
动作参数名称|参数名称|取值
---|---|---
action_roam|动作参数类型|N7会话参数集
会话规则名称|action_roam|roam
会话AMBR上行速率（kbps）|action_roam|200
会话AMBR下行速率（kbps）|action_roam|200
ARP优先级|action_roam|3
ARP抢占能力|action_roam|开启
ARP被抢占能力|action_roam|开启
动作参数名称|参数名称|取值
---|---|---
action_local|动作参数类型|N7会话参数集
会话规则名称|action_local|local
会话汇聚带宽决策方式|action_local|请求中的APN带宽
ARP优先级决策方式|action_local|请求中的值
配置场景。 
场景名称|参数|取值
---|---|---
PolicyByRoamFlag|入口1|入口类型|用户信息类
已选入口|PolicyByRoamFlag|入口1|用户套餐
取值|PolicyByRoamFlag|入口1|1
策略类型|PolicyByRoamFlag|N7会话策略|rule_roam
rule_local|策略类型|PolicyByRoamFlag|N7会话策略
规则名称|规则参数|参数取值
---|---|---
rule_roam|优先级|1
动作类型|rule_roam|参数填充
日志开关|rule_roam|关闭
条件表达式|rule_roam|~{漫游标识 = 本地}
选中动作参数名称|rule_roam|action_roam
规则名称|规则参数|参数取值
---|---|---
rule_local|优先级|1
动作类型|rule_local|参数填充
日志开关|rule_local|关闭
条件表达式|rule_local|{漫游标识 = 本地}
选中动作参数名称|rule_local|action_local
######## 配置脚本 
//套餐配置 
ADD PKGINFO:PKGID="1",PRIORITY=1; 
//承载能力配置 
SET BEARABILITY:ADJHOSTGRPID=10,ROAMCOND="MCCMNC"; 
//上报事件配置 
ADD PCEFEVENT:ID=1,PKGID="1",PLMN="YES"; 
//SGSN MCC-MNC接入配置 
ADD MCCMNCACC:ID=1,ADJHOSTGRPID=0,MCC="460",MNC="01",ACCATTR="1"; 
ADD MCCMNCACC:ID=2,ADJHOSTGRPID=0,MCC="460",MNC="02",ACCATTR="2"; 
//漫游属性配置 
ADD ACCMAP:ACCATTR="1",ROAMFLAG="NO",ACCTYPE="MCCMNC"; 
ADD ACCMAP:ACCATTR="2",ROAMFLAG="YES",ACCTYPE="MCCMNC"; 
//漫游条件 
ADD DM COND:NAME="IsLocal",SVCKEY="SYS.GX_ROAM_FLAG",OPERATOR="=",VALTYPE="VALUE",VALUE="GX_ROAM_FLAG_LOCAL";
//N7会话决策动作参数（漫游） 
ADD DM ACTION:NAME="action_roam",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"roam"&"SYS.SESS_AMBR_UL"-"0"-"200"&"SYS.SESS_AMBR_DL"-"0"-"200"&"SYS.DEF_QOS_ARP_PRIORITY_LEVEL"-"0"-"3"&"SYS.DEF_QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.DEF_QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
//N7会话决策动作参数（非漫游） 
ADD DM ACTION:NAME="action_local",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"local"&"SYS.SESS_AGG_BW_ACTION"-"0"-"REQ_APN_BW"&"SYS.DEF_ARP_PRI_LEVEL_ACTION"-"0"-"REQ_PRIORITY";
//N7会话策略规则（漫游） 
ADD DM RULE:NAME="rule_roam",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=1,CONDEXP="~{IsLocal}",ACTTYPE="PARAM",ACTNAME="action_roam",LOGFLAG="OFF",RULENO=0;
//N7会话策略规则（非漫游） 
ADD DM RULE:NAME="rule_local",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=1,CONDEXP="{IsLocal}",ACTTYPE="PARAM",ACTNAME="action_local",LOGFLAG="OFF",RULENO=0;
//场景规则关联配置 
ADD DM ROLE:NAME="PolicyByRoamFlag",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="rule_roam"&"rule_local",VALIDFLAG="ENABLE";
###### 配置实例-运营商根据用户是否漫游采取不同的内容计费策略 
######## 场景说明 
当用户非漫游时（按PLMN ID判断），内容计费套餐生效，PCF下发内容计费预定义PCC规则。当用户漫游时，内容计费套餐失效，PCF去除相关PCC规则。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|2
套餐类型|套餐|用户套餐
业务|业务标识|1
应用标识|业务|1001
接入配置1|MCCMNC|46001
接入配置2|MCCMNC|46002
策略类型|控制条件|决策参数
---|---|---
套餐动态优先级策略|漫游|套餐失效
N7业务控制策略|非漫游&应用标识=1001|内容计费预定义PCC规则
######## 业务配置关系 
图3  业务配置关系图
[]images/image15.png)
######## 配置步骤 
配置基础信息。 
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="2",PRIORITY=1;
配置套餐业务基本配置。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="2",SUBSID="1";
应用标识配置 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="业务1",SUBSID="1",SUBSDESC="1";
配置上报事件。 
[ADD PCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787143.html):ID=1,PKGID="2",PLMN="YES";
配置SGSN MCC-MNC接入。 
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=1,ADJHOSTGRPID=0,MCC="460",MNC="01",ACCATTR="1";
[ADD MCCMNCACC](../../Npcf_PolicyManagement\zh-CN\mml\1787420.html):ID=2,ADJHOSTGRPID=0,MCC="460",MNC="02",ACCATTR="2";
配置规则条件。 
自定义变量名称|参数|取值
---|---|---
plmn|选择策略变量|接入属性
接入类型|plmn|SGSN_MCC_MNC
条件名称|参数|取值
---|---|---
plmn_local|选择策略变量|其他
策略变量类别|plmn_local|自定义策略变量
策略变量|plmn_local|plmn
操作符|plmn_local|=
值类型|plmn_local|值
值|plmn_local|1
条件名称|参数|取值
---|---|---
plmn_roam|选择策略变量|其他
策略变量类别|plmn_roam|自定义策略变量
策略变量|plmn_roam|plmn
操作符|plmn_roam|=
值类型|plmn_roam|值
值|plmn_roam|2
条件名称|参数|取值
---|---|---
cond_appid_1001|选择策略变量|其他
策略变量类别|cond_appid_1001|IP-CAN会话信息类
策略变量|cond_appid_1001|Gx应用标识
操作符|cond_appid_1001|=
值类型|cond_appid_1001|值
值|cond_appid_1001|1001
配置规则动作参数。 
动作参数名称|参数名称|取值
---|---|---
action_invalid|动作参数类型|套餐动态属性参数集
套餐有效标识|action_invalid|无效
动作参数名称|参数名称|取值
---|---|---
action_svc_1001|动作参数类型|N7 PCC规则参数集
PCC规则类型|action_svc_1001|预定义规则
规则名|action_svc_1001|svc_1001
业务标识|action_svc_1001|1001
配置场景。 
场景名称|参数|取值
---|---|---
PolicyByPLMNID|入口1|入口类型|用户信息类
已选入口|PolicyByPLMNID|入口1|用户套餐
取值|PolicyByPLMNID|入口1|2
策略类型|PolicyByPLMNID|N7业务控制策略|rule_svc_1001
套餐动态优先级策略|策略类型|PolicyByPLMNID|rule_invalid
规则名称|规则参数|参数取值
---|---|---
rule_svc_1001|优先级|1
动作类型|rule_svc_1001|参数填充
日志开关|rule_svc_1001|关闭
条件表达式|rule_svc_1001|{cond_appid_1001}&{plmn_local}
选中动作参数名称|rule_svc_1001|action_svc_1001
规则名称|规则参数|参数取值
---|---|---
rule_invalid|优先级|1
动作类型|rule_invalid|参数填充
日志开关|rule_invalid|关闭
条件表达式|rule_invalid|{plmn_roam}
选中动作参数名称|rule_invalid|action_invalid
######## 配置脚本 
//套餐配置 
ADD PKGINFO:PKGID="2",PRIORITY=1; 
//套餐业务基本配置 
ADD PKGSVC:ID=1,PKGID="2",SUBSID="1"; 
//应用标识配置 
ADD APPSUBS:APPID=1001,APPDESC="业务1",SUBSID="1",SUBSDESC="1"; 
//上报事件配置 
ADD PCEFEVENT:ID=1,PKGID="2",PLMN="YES"; 
//SGSN MCC-MNC接入配置 
ADD MCCMNCACC:ID=1,ADJHOSTGRPID=0,MCC="460",MNC="01",ACCATTR="1"; 
ADD MCCMNCACC:ID=2,ADJHOSTGRPID=0,MCC="460",MNC="02",ACCATTR="2"; 
//自定义策略变量配置 
ADD DM CUSTOMVAR:NAME="plmn",SVCKEY="SYS.GX_SGSN_ATTR_ID",SVCKEYATTR="ACCTYPE"-"SGSN_MCC_MNC";
//PLMN条件配置（非漫游） 
ADD DM COND:NAME="plmn_local",SVCKEY="plmn",OPERATOR="=",VALTYPE="VALUE",VALUE="1"; 
//PLMN条件配置（漫游） 
ADD DM COND:NAME="plmn_roam",SVCKEY="plmn",OPERATOR="=",VALTYPE="VALUE",VALUE="2"; 
//应用标识条件配置 
ADD DM COND:NAME="cond_appid_1001",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1001";
//套餐动态属性动作参数（漫游） 
ADD DM ACTION:NAME="action_invalid",TYPE="PKG_PRIOR",PARAMS="SYS.PKG_VALID_INDIC"-"0"-"INVALID";
//N7业务决策动作参数（非漫游） 
ADD DM ACTION:NAME="action_svc_1001",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"svc_1001"&"SYS.N7_PCC_RULE_TYPE"-"0"-"PRE_RULE"&"SYS.N7_PCC_APPID"-"0"-"1001";
//套餐动态优先级策略规则 
ADD DM RULE:NAME="rule_invalid",PLCTYPE="PKG_PRIOR",PRIOR=1,CONDEXP="{plmn_roam}",ACTTYPE="PARAM",ACTNAME="action_invalid",LOGFLAG="OFF",RULENO=0;
//N7业务控制策略规则 
ADD DM RULE:NAME="rule_svc_1001",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=1,CONDEXP="{cond_appid_1001}&{plmn_local}",ACTTYPE="PARAM",ACTNAME="action_svc_1001",LOGFLAG="ON",RULENO=0;
//场景规则关联配置 
ADD DM ROLE:NAME="PolicyByPLMNID",ENTRANCE="SYS.USER_PAK_ID"-"2",RULENAME="rule_invalid"&"rule_svc_1001",VALIDFLAG="ENABLE";
###### 配置实例-运营商根据用户是否在区域内采取不同的业务控制策略 
######## 场景说明 
当用户在某园区内（以TA映射策略变量判断），PCF下发动态PCC规则，携带五元组、DNAI、QoS，指示SMF将指定业务分流到园区专用UPF。当用户离开园区时，取消该分流PCC规则。 
######## 数据规划 
类别|参数|取值
---|---|---
套餐|编号|3
套餐类型|套餐|用户套餐
业务|业务标识|1
应用标识|业务|1002
接入配置|ULI_TAC|00020095
策略类型|控制条件|决策参数
---|---|---
套餐动态优先级策略|园区外|套餐失效
N7业务控制策略|园区内&应用标识=1002|动态PCC规则
######## 业务配置关系 
图4  业务配置关系图
[]images/image16.png)
######## 配置步骤 
配置基础信息。 
配置套餐。 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="3",PRIORITY=1;
配置套餐业务基本配置。 
[ADD PKGSVC](../../Npcf_PolicyManagement\zh-CN\mml\1787198.html):ID=1,PKGID="3",SUBSID="1";
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="业务1",SUBSID="1",SUBSDESC="1";
配置上报事件。 
[ADD PCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787143.html):ID=1,PKGID="3",USERLOC="YES";
配置业务特征流。 
[ADD SVCFLOWCHR](../../Npcf_PolicyManagement\zh-CN\mml\1787321.html):ID=1,PROTOCOL=255,SERVERIPADDR="0.0.0.0",MASK="0.0.0.0",SERVERPORT=0,SERVERPORTMAX=0,DIRECT="BOTH",CLTIPADDRSRC="ANY",APPID=1002
配置号码映射策略变量（BEGINVALUE和ENDVALUE取值需为8位的字符串，配置中取值为10进制，对应消息中字段tac取值为16进制） 
[ADD NUMABS](../../Npcf_PolicyManagement\zh-CN\mml\1787233.html):ID=1,SVCKEY="ULI_TAC",BEGINVALUE="00020095",ENDVALUE="00020095",ABSATTRID=100,REMARK="";
配置规则条件。 
条件名称|参数|取值
---|---|---
ULI_TAC_100|选择策略变量|其他
策略变量类别|ULI_TAC_100|映射策略变量
策略变量|ULI_TAC_100|ULI TAC映射标识
操作符|ULI_TAC_100|IFHave
值类型|ULI_TAC_100|值
值|ULI_TAC_100|100
条件名称|参数|取值
---|---|---
cond_appid_1002|选择策略变量|其他
策略变量类别|cond_appid_1002|IP-CAN会话信息类
策略变量|cond_appid_1002|Gx应用标识
操作符|cond_appid_1002|=
值类型|cond_appid_1002|值
值|cond_appid_1002|1002
配置规则动作参数。 
动作参数名称|参数名称|取值
---|---|---
action_invalid|动作参数类型|套餐动态属性参数集
套餐有效标识|action_invalid|无效
动作参数名称|参数名称|取值
---|---|---
action_qos|动作参数类型|QoS参数集
QoS控制策略ID|action_qos|qos1
5QI|action_qos|9
最大上行带宽(kbps)|action_qos|300
最大下行带宽(kbps)|action_qos|500
保障上行带宽(kbps)|action_qos|300
保障下行带宽(kbps)|action_qos|500
ARP优先级|action_qos|1
ARP抢占能力|action_qos|不允许抢占
ARP被抢占能力|action_qos|不允许被抢占
动作参数名称|参数名称|取值
---|---|---
action_chg|动作参数类型|Charging参数集
计费控制策略ID|action_chg|chg1
计费度量方式|action_chg|时长
离线计费|action_chg|关闭
在线计费|action_chg|关闭
费率组|action_chg|1
计费上报等级|action_chg|业务标识等级
计费业务标识|action_chg|1
动作参数名称|参数名称|取值
---|---|---
action_dnai_1|动作参数类型|路由目的地参数集
DNAI|action_dnai_1|1
动作参数名称|参数名称|取值
---|---|---
action_tc|动作参数类型|TC参数集
流量控制策略ID|action_tc|1
路由目的地|action_tc|action_dnai_1
动作参数名称|参数名称|取值
---|---|---
action_pcc|动作参数类型|N7 PCC规则参数集
PCC规则类型|action_pcc|动态规则
规则名|action_pcc|DNAI1
业务标识|action_pcc|1002
优先级|action_pcc|10（取值范围：[0,255]）
QoS控制策略ID|action_pcc|action_qos
流量控制策略ID|action_pcc|action_tc
计费控制策略ID|action_pcc|action_chg
配置场景。 
场景名称|参数|取值
---|---|---
PolicyByTac|入口1|入口类型|用户信息类
已选入口|PolicyByTac|入口1|用户套餐
取值|PolicyByTac|入口1|3
策略类型|PolicyByTac|N7业务控制策略|rule_pcc
套餐动态优先级策略|策略类型|PolicyByTac|rule_invalid
规则名称|规则参数|参数取值
---|---|---
rule_pcc|优先级|1
动作类型|rule_pcc|参数填充
日志开关|rule_pcc|关闭
条件表达式|rule_pcc|{ULI_TAC_100}&{cond_appid_1002}
选中动作参数名称|rule_pcc|action_pcc
规则名称|规则参数|参数取值
---|---|---
rule_invalid|优先级|1
动作类型|rule_invalid|参数填充
日志开关|rule_invalid|关闭
条件表达式|rule_invalid|~{ULI_TAC_100}
选中动作参数名称|rule_invalid|action_invalid
######## 配置脚本 
//套餐配置 
ADD PKGINFO:PKGID="3",PRIORITY=1; 
//套餐业务基本配置 
ADD PKGSVC:ID=1,PKGID="3",SUBSID="1"; 
//应用标识配置 
ADD APPSUBS:APPID=1002,APPDESC="业务1",SUBSID="1",SUBSDESC="1"; 
//上报事件配置 
ADD PCEFEVENT:ID=1,PKGID="3",USERLOC="YES"; 
//业务特征流配置 
ADD SVCFLOWCHR:ID=1,PROTOCOL=255,SERVERIPADDR="0.0.0.0",MASK="0.0.0.0",SERVERPORT=0,SERVERPORTMAX=0,DIRECT="BOTH",CLTIPADDRSRC="ANY",APPID=1002
//号码映射策略变量配置 
ADD NUMABS:ID=1,SVCKEY="ULI_TAC",BEGINVALUE="00020095",ENDVALUE="00020095",ABSATTRID=100,REMARK="";
//PLMN条件配置（园区内） 
ADD DM COND:NAME="ULI_TAC_100",SVCKEY="SYS.GX_ULI_TAC_ATTR_ID",OPERATOR="IfHave",VALTYPE="VALUE",VALUE="100";
//应用标识条件配置 
ADD DM COND:NAME="cond_appid_1002",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1002";
//套餐动态属性动作参数（园区外） 
ADD DM ACTION:NAME="action_invalid",TYPE="PKG_PRIOR",PARAMS="SYS.PKG_VALID_INDIC"-"0"-"INVALID";
//QoS动作参数 
ADD DM ACTION:NAME="action_qos",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"qos1"&"SYS.QOS_5QI"-"0"-"9"&"SYS.QOS_MBR_UL"-"0"-"300"&"SYS.QOS_MBR_DL"-"0"-"500"&"SYS.QOS_GBR_UL"-"0"-"300"&"SYS.QOS_GBR_DL"-"0"-"500"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"NOT_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
//Charging动作参数 
ADD DM ACTION:NAME="action_chg",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"chg1"&"SYS.CHG_METERING_METHOD"-"0"-"DURATION"&"SYS.CHG_OFFLINE"-"0"-"DISABLE"&"SYS.CHG_ONLINE"-"0"-"DISABLE"&"SYS.CHG_RATING_GROUP"-"0"-"1"&"SYS.CHG_REPORTING_LEVEL"-"0"-"SERVICE_IDENTIFIER_LEVEL"&"SYS.CHG_SERVICE_ID"-"0"-"1";
//路由目的地动作参数 
ADD DM ACTION:NAME="action_dnai_1",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"0"-"1";
//TC动作参数 
ADD DM ACTION:NAME="action_tc",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"1"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"action_dnai_1";
//N7业务决策动作参数（园区内） 
ADD DM ACTION:NAME="action_pcc",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"DNAI1"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_APPID"-"0"-"1002"&"SYS.N7_PCC_PRECEDENCE"-"0"-"10"&"SYS.N7_PCC_QoS_ID"-"0"-"action_qos"&"SYS.N7_PCC_TC_ID"-"0"-"action_tc"&"SYS.N7_PCC_CHARGING_ID"-"0"-"action_chg";
//套餐动态优先级策略规则 
ADD DM RULE:NAME="rule_invalid",PLCTYPE="PKG_PRIOR",PRIOR=1,CONDEXP="~{ULI_TAC_100}",ACTTYPE="PARAM",ACTNAME="action_invalid",LOGFLAG="OFF",RULENO=0;
//N7业务控制策略规则 
ADD DM RULE:NAME="rule_pcc",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=1,CONDEXP="{ULI_TAC_100}&{cond_appid_1002}",ACTTYPE="PARAM",ACTNAME="action_pcc",LOGFLAG="OFF",RULENO=0;
//场景规则关联配置 
ADD DM ROLE:NAME="PolicyByTac",ENTRANCE="SYS.USER_PAK_ID"-"3",RULENAME="rule_invalid"&"rule_pcc",VALIDFLAG="ENABLE";
###### 配置实例-通过NR RedCap无线接入类型进行决策 
######## 场景说明 
在RAT类型为NR的子类型指示用户设备为NR RedCap时，ZXUN RCP下发规定的会话速率策略。
######## 数据规划 
策略类型|控制条件|决策参数
---|---|---
N7会话决策|接入信息类→无线接入技术为NR_REDCAP|会话AMBR上行速率 = 100 Kbps会话AMBR下行速率 = 100 Kbps
接入信息类→无线接入技术为NG-RAN|N7会话决策|会话AMBR上行速率 = 200 Kbps会话AMBR下行速率 = 200 Kbps
######## 业务配置关系图 
######## 配置步骤 
配置基础信息。 
配置上报事件。 
[SET DEFPCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787147.html):RAT="YES"
配置规则条件。 
规则条件1 
条件名称|参数|取值
---|---|---
RAT=NR_REDCAP|选择策略变量|其他
策略变量类别|RAT=NR_REDCAP|接入信息类
策略变量|RAT=NR_REDCAP|RAT
操作符|RAT=NR_REDCAP|=
值类型|RAT=NR_REDCAP|值
值|RAT=NR_REDCAP|NR_REDCAP
规则条件2 
条件名称|参数|取值
---|---|---
RAT=NR|选择策略变量|其他
策略变量类别|RAT=NR|接入信息类
策略变量|RAT=NR|RAT
操作符|RAT=NR|=
值类型|RAT=NR|值
值|RAT=NR|NR
配置规则动作参数。 
N7会话决策动作参数 
NR： 
动作参数名称|参数名称|取值
---|---|---
n7SessNR|动作参数类型|N7会话参数集
会话规则名称|n7SessNR|n7SessNR
会话AMBR上行速率（kbps）|n7SessNR|200
会话AMBR下行速率（kbps）|n7SessNR|200
ARP优先级|n7SessNR|1
ARP抢占能力|n7SessNR|开启
ARP被抢占能力|n7SessNR|开启
NR_REDCAP： 
动作参数名称|参数名称|取值
---|---|---
n7SessRedcap|动作参数类型|N7会话参数集
会话规则名称|n7SessRedcap|n7SessRedcap
会话AMBR上行速率（kbps）|n7SessRedcap|100
会话AMBR下行速率（kbps）|n7SessRedcap|100
ARP优先级|n7SessRedcap|1
ARP抢占能力|n7SessRedcap|开启
ARP被抢占能力|n7SessRedcap|开启
配置场景。 
场景规则关联配置 
场景名称|参数|取值
---|---|---
redcap|入口1|入口类型|
策略类型|redcap|N7会话策略|n7SessRedcap
n7SessNR|策略类型|redcap|N7会话策略
N7会话策略规则 
规则名称|规则参数|参数取值
---|---|---
n7SessNR|优先级|1
动作类型|n7SessNR|参数填充
日志开关|n7SessNR|关闭
条件表达式|n7SessNR|{RAT=NR}
选中动作参数名称|n7SessNR|n7SessNR
规则名称|规则参数|参数取值
---|---|---
n7SessRedcap|优先级|1
动作类型|n7SessRedcap|参数填充
日志开关|n7SessRedcap|关闭
条件表达式|n7SessRedcap|{RAT=NR_REDCAP}
选中动作参数名称|n7SessRedcap|n7SessRedcap
###### 配置实例-N7口通过Tethering热点控制 
######## 场景说明 
N7口通过Tethering热点控制，PCF能根据tethering上报来下发相应的会话速率策略。 
######## 数据规划 
会话控制策略规划 
策略类型|控制条件|决策参数
---|---|---
N7会话决策|无|会话AMBR上行速率=100kbps会话AMBR下行速率=100kbps
用户共享下挂数量 =1|N7会话决策|会话AMBR上行速率=200kbps会话AMBR下行速率=200kbps
业务控制策略规划 
策略类型|控制条件|决策参数
---|---|---
N7会话决策|appid1=1001|预定义规则n7svcrule1
用户共享下挂数量”>=1，usg1总用量百分比> 20%|N7会话决策|预定义规则n7svcrule2
用户共享下挂数量”>=1，usg2总用量百分比> 40%|N7会话决策|预定义规则n7svcrule3
######## 业务配置关系图 
111 
######## 配置步骤 
配置基础信息。 
设置1096开关值为1。 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1096,CURVAL="1",EXTFLAG="ADVANCED"；
配置默认上报事件。 
[SET DEFPCEFEVENT](../../Npcf_PolicyManagement\zh-CN\mml\1787147.html):TETHECOUNTCHG="YES";
配置基本用量。 
策略变量名称|参数|取值
---|---|---
usage1|用量层次|MK用户
用量周期|usage1|月
用量类型|usage1|流量
用量阈值|usage1|40000
配置条件。 
规则条件1 
条件名称|参数|取值
---|---|---
appid1|选择策略变量|其他
策略变量类别|appid1|会话信息类
策略变量|appid1|Gx应用标识
操作符|appid1|=
值类型|appid1|值
值|appid1|1001
规则条件2 
条件名称|参数|取值
---|---|---
usg1more20|选择策略变量|用量
策略变量类别|usg1more20|总用量百分比
策略变量|usg1more20|usage1.总用量百分比
操作符|usg1more20|>
值类型|usg1more20|值
值|usg1more20|20
规则条件3 
条件名称|参数|取值
---|---|---
usg1more40|选择策略变量|用量
策略变量类别|usg1more40|总用量百分比
策略变量|usg1more40|usage1.总用量百分比
操作符|usg1more40|>
值类型|usg1more40|值
值|usg1more40|40
规则条件4 
条件名称|参数|取值
---|---|---
tethering_moreandequal_1|选择策略变量|其他
策略变量类别|tethering_moreandequal_1|会话类信息
策略变量|tethering_moreandequal_1|用户共享下挂数量
操作符|tethering_moreandequal_1|>=
值类型|tethering_moreandequal_1|值
值|tethering_moreandequal_1|1
规则条件5 
条件名称|参数|取值
---|---|---
mk1|选择策略变量|其他
策略变量类别|mk1|会话类信息
策略变量|mk1|Monitoring Key
操作符|mk1|=
值类型|mk1|值
值|mk1|1
规则条件6 
条件名称|参数|取值
---|---|---
tethering_more_1|选择策略变量|其他
策略变量类别|tethering_more_1|会话类信息
策略变量|tethering_more_1|用户共享下挂数量
操作符|tethering_more_1|=
值类型|tethering_more_1|值
值|tethering_more_1|1
配置N7会话决策动作参数。 
n7sessrule1： 
动作参数名称|参数名称|取值
---|---|---
n7sessrule1|动作参数类型|N7会话参数集
会话规则名称|n7sessrule1|n7sessrule1
会话AMBR上行速率（kbps）|n7sessrule1|100
会话AMBR下行速率（kbps）|n7sessrule1|100
用量监控ID|n7sessrule1|1
n7sessrule2： 
动作参数名称|参数名称|取值
---|---|---
n7sessrule2|动作参数类型|N7会话参数集
会话规则名称|n7sessrule2|n7sessrule2
会话AMBR上行速率（kbps）|n7sessrule2|200
会话AMBR下行速率（kbps）|n7sessrule2|200
用量监控ID|n7sessrule2|1
n7svcrule1： 
动作参数名称|参数名称|取值
---|---|---
n7svcrule1|PCC规则类型|预定义规则
PCC规则名|n7svcrule1|n7svcrule1
n7svcrule2： 
动作参数名称|参数名称|取值
---|---|---
n7svcrule2|PCC规则类型|预定义规则
PCC规则名|n7svcrule2|n7svcrule2
n7svcrule3： 
动作参数名称|参数名称|取值
---|---|---
n7svcrule3|PCC规则类型|预定义规则
PCC规则名|n7svcrule3|n7svcrule3
usage： 
动作参数名称|参数名称|取值
---|---|---
usage|动作参数类型|会话用量监控参数集
Monitoring Key|usage|1
流量门限控制方式|usage|固定值
总流量门限(KByte)|usage|10000
svcpre： 
动作参数名称|参数名称|取值
---|---|---
svcpre|动作参数类型|业务预下发控制策略
应用标识|svcpre|1001
配置场景。 
场景规则关联配置 
场景名称|参数|取值
---|---|---
role|入口1|入口类型|用户类型=1
策略类型|role|N7会话策略|n7sess1
n7sess2|策略类型|role|N7会话策略
策略类型|role|N7业务策略|n7svcrule1
n7svcrule2|策略类型|role|N7业务策略
n7svcrule3|策略类型|role|N7业务策略
策略类型|role|会话级用量监控策略|usage
策略类型|role|业务预下发控制策略|svcpre
N7会话策略规则 
规则名称|规则参数|参数取值
---|---|---
n7sess1|优先级|1
动作类型|n7sess1|参数填充
日志开关|n7sess1|关闭
条件表达式|n7sess1|
选中动作参数名称|n7sess1|n7sess1
规则名称|规则参数|参数取值
---|---|---
n7sess2|优先级|1
动作类型|n7sess2|参数填充
日志开关|n7sess2|关闭
条件表达式|n7sess2|tethering_more_1
选中动作参数名称|n7sess2|n7sess2
N7业务策略规则 
规则名称|规则参数|参数取值
---|---|---
n7svcrule1|优先级|1
动作类型|n7svcrule1|参数填充
日志开关|n7svcrule1|关闭
条件表达式|n7svcrule1|appid1
选中动作参数名称|n7svcrule1|n7svcrule1
规则名称|规则参数|参数取值
---|---|---
n7sess2|优先级|1
动作类型|n7sess2|参数填充
日志开关|n7sess2|关闭
条件表达式|n7sess2|appid1&tethering_moreandequal_1&usg1more20
选中动作参数名称|n7sess2|n7svcrule2
规则名称|规则参数|参数取值
---|---|---
n7sess2|优先级|1
动作类型|n7sess2|参数填充
日志开关|n7sess2|关闭
条件表达式|n7sess2|appid1&tethering_moreandequal_1&usg1more40
选中动作参数名称|n7sess2|n7svcrule3
会话级用量监控策略 
规则名称|规则参数|参数取值
---|---|---
usage|优先级|1
动作类型|usage|参数填充
日志开关|usage|关闭
条件表达式|usage|tethering_more_1
选中动作参数名称|usage|usage
##### 测试用例 
测试条目|根据用户漫游情况进行不同的Session-AMBR和Default-QoS授权。
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“ 配置实例-运营商根据用户是否漫游采取不同的会话控制策略”进行配置。
测试步骤|用户A在本地接入网络，携带MCCMNC=46001。RCP从SPR获取用户签约，用户签约了套餐1。查看用户上线以及用户会话中APN带宽。用户A移动到漫游地，携带MCCMNC=46002。SMF向RCP上报PLMN_CHG事件通知。查看用户会话中APN带宽。
通过准则|用户A在本地能够上线成功，Npcf_SMPolicyControl_Create请求消息携带字段：servingNetwork（mcc=460mnc=01）。RCP返回Npcf_SMPolicyControl_Create响应消息携带字段：sessRules（sessRuleId=localauthSessAmbr值为Npcf_SMPolicyControl_Create请求中携带的带宽，authDefQos中的arp为Npcf_SMPolicyControl_Create请求中携带的arp） 、policyCtrlReqTriggers（PLMN_CH）。用户A漫游后，SMF通知RCP，Npcf_SMPolicyControl_update请求消息携带字段：repPolicyCtrlReqTriggers（PLMN_CH）、servingNetwork（mcc=460 mnc=02）。RCP返回Npcf_SMPolicyControl_update响应消息携带字段：sessRules（sessRuleId=roamauthSessAmbr值为200kbps，authDefQos中的arp为3，preemptCap为允许抢占，preemptVuln为允许被抢占，local：null）。
测试条目|用户非漫游时，内容计费套餐生效，PCF下发内容计费预定义PCC规则；用户漫游时，内容计费套餐失效，PCF去除相关PCC规则。
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-运营商根据用户是否漫游采取不同的内容计费策略”进行配置。
测试步骤|用户A在本地接入网络，携带MCCMNC=46001。RCP从SPR获取用户签约，用户签约了套餐2。查看用户上线以及用户预定义PCC规则。用户A移动到漫游地，携带MCCMNC=46002。SMF向RCP上报PLMN_CHG事件通知。查看用户预定义PCC规则被去除。
通过准则|用户A在本地能够上线成功，Npcf_SMPolicyControl_Create请求消息携带字段：servingNetwork（mcc=460mnc=01）。RCP返回Npcf_SMPolicyControl_Create响应消息携带字段：pccRules（pccRuleId：svc_1001）、policyCtrlReqTriggers（PLMN_CH）。用户A漫游后，SMF通知RCP，Npcf_SMPolicyControl_update请求消息携带字段：repPolicyCtrlReqTriggers（PLMN_CH）、servingNetwork（mcc=460mnc=02）。RCP返回Npcf_SMPolicyControl_update响应消息携带字段：pccRules（svc_1001：null）、policyCtrlReqTriggers：null。
测试条目|用户在某园区内，PCF下发动态PCC规则，携带五元组、DNAI、QoS，指示SMF将指定业务分流到园区专用UPF。用户离开园区时，取消该分流PCC规则。
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-运营商根据用户是否在区域内采取不同的业务控制策略”进行配置。
测试步骤|用户A在本地接入网络，携带ULI_TAC=00020095。RCP从SPR获取用户签约，用户签约了套餐3。查看用户上线以及用户动态PCC规则。用户A移动到漫游地，携带ULI_TAC=00020096。SMF向RCP上报SCELL_CH事件通知。查看用户动态PCC规则被去除。
通过准则|用户A在本地能够上线成功，Npcf_SMPolicyControl_Create请求消息携带字段：userLocationInfo（tac=4E7F）。RCP返回Npcf_SMPolicyControl_Create响应消息携带字段：pccRules（pccRuleId：DNAI1，precedence：10refQosData：qos1 refTcData：1 refChgData：chg1）、 qosDecs、chgDecs、traffContDecs。policyCtrlReqTriggers（SCELL_CH）。用户A漫游后，SMF通知RCP，Npcf_SMPolicyControl_update请求消息携带字段：repPolicyCtrlReqTriggers（SCELL_CH）、userLocationInfo（tac=4E80）。RCP返回Npcf_SMPolicyControl_update响应消息携带字段：pccRules（DNAI1：null）、 qosDecs（qos1：null）、chgDecs（chg1:null）、traffContDecs（1：null）、policyCtrlReqTriggers：null。
测试条目|SMF发起无线接入方式为NR RedCap类型的PDU会话建立请求，SMF发起无线接入方式切换为NG-RAN类型的PDU会话更新请求
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP上按照“配置实例-通过NR RedCap无线接入类型进行决策”进行配置。
测试步骤|用户上线，建立N7会话，请求消息中携带 ratType：NR_REDCAP。用户上线建立N7会话，下发规则session_rule1。N7发起会话更新，更新无线接入类型ratType：NG-RAN。会话更新，下发新的会话规则session_rule2。
通过准则|用户A在本地能够上线成功，Npcf_SMPolicyControl_Create请求消息携带字段：ratType：NR_REDCAP。RCP返回Npcf_SMPolicyControl_Create响应消息携带字段：sessRules（sessRuleId=session_rule1)。SMF通知RCP，Npcf_SMPolicyControl_update请求消息携带字段：ratType：NG-RAN。RCP返回Npcf_SMPolicyControl_update响应消息携带字段：sessRules（sessRuleId=session_rule2）。
测试条目|N7口通过Tethering热点控制会话速率
---|---
预置条件|已执行SET SYS GLOBPARA:IDX=1096,CURVAL="1",EXTFLAG="ADVANCED";将1096开关值设置为1。已执行SET DEFPCEFEVENT:TETHECOUNTCHG="YES";配置默认上报事件。配置N7会话规则：N7_sessrule1，优先级=1，上下行AMBR=1000。配置N7会话规则：N7_sessrule2，优先级=5，用户共享下挂数量=1时，上下行AMBR=2000。配置mk1会话用量监控，固定流量10M。规则配置基本用量usg1，mk用户-月-流量，用量签约阀值40M，Monitoring Key列表增加1，高级属性里“Tethering”选择开启。规则配置基本用量usg2，mk用户-月-流量，用量签约阀值40M，Monitoring Key列表增加1，高级属性里“Tethering”选择关闭。配置预下发规则，输出业务appid 1001。配置N7业务规则N7_svcrule2，条件业务appid 1001，“用户共享下挂数量”>=1， usg1总用量百分比> 20%，优先级5。配置N7业务规则N7_svcrule3，条件业务appid 1001，“用户共享下挂数量”>=1，  usg1总用量百分比> 40%，优先级10。
测试步骤|用户上线，建立N7会话。SMF发起SM策略关联更新请求，更新消息中携带policyCtrlReqTriggers取值为“TETHERING_COUNT”，携带tetheringCount=1。SMF再次发起SM策略关联更新请求，同时上报用量10M。SMF再次发起SM策略关联更新请求，更新消息中携带policyCtrlReqTriggers取值为“TETHERING_COUNT”，携带tetheringCount=2。SMF再次发起SM策略关联更新请求，同时上报用量10M。用户下线，N7会话释放。
通过准则|N7会话上线成功，下发N7_sessrule1规则和N7_svcrule1规则。N7会话更新成功，PCF重决策下发N7_sessrule2规则。N7会话更新成功，PCF重决策下发N7_svcrule2规则。N7会话更新成功，PCF重决策下发N7_sessrule1规则。N7会话更新成功，PCF重决策下发N7_svcrule3规则。下线成功，整个过程无异常失败观察上报。
### 缩略语 
### 缩略语 
#### 5GC 
5G Core Network5G核心网
#### AF 
Application Function应用功能
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### CHF 
Charging Function计费功能
#### DNN 
Data Network Name数据网名称
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### IPv4 
Internet Protocol Version 4互联网通信协议第四版
#### IPv6 
Internet Protocol Version 6互联网通信协议第六版
#### NEF 
Network Exposure Function网络开放功能
#### NF 
Network Function网络功能
#### NRF 
NF Repository Function网络仓储功能
#### NWDAF 
Network Data Analytics Function网络数据分析功能
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCC 
Policy and Charging Control计费和策略控制
#### PCF 
Policy Control Function策略控制功能
#### PDU 
Packet Data Unit分组数据单元
#### PEI 
Permanent Equipment Identifier永久设备标识
#### QoS 
Quality of Service服务质量
#### RAN 
Radio Access Network无线接入网
#### S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
#### SDP 
Session Description Protocol会话描述协议
#### SIP 
Session Initiation Protocol会话发起协议
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### UDM 
Unified Data Management统一数据管理
#### UDR 
Unified Data Repository统一数据存储
#### UE 
User Equipment用户设备
#### UPF 
User Plane Function用户平面功能
#### URI 
Uniform Resource Identifier统一资源标识符
#### VIP 
Very Important Person贵宾
### ZUF-59-53-053 URSP策略控制 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
URSP|UE路由选择策略（UE Route Selection Policy），是UE对业务流的路由选择策略。
SSCMSP|SSC模式选择策略（Session and Service Continuity Mode Selection Policy），用于UE将匹配的应用与SSC模式相关联。SSC模式即会话与服务连续模式的简称。
NSSP|网络切片选择策略（Network Slice Selection Policy），指导UE为不同业务选择不同的网络切片。
##### 描述 
####### 定义 
URSP可预配置在UE或通过PCF下发给UE，预配置策略只在PCF未下发相同类型的策略时生效。
URSP策略控制为UE策略控制的一个重要组成部分，用于UE决定如何为出局的业务流选择路由，主要包含如下几个方面： 
SSC模式选择策略：用于UE关联匹配SSC模式的应用。 
网络切片选择策略：用于UE关联匹配S-NSSAI的应用。 
DNN选择策略：用于UE关联匹配DNN的应用。 
PDU会话类型策略：用于UE关联匹配PDU会话类型的应用。 
非无缝卸载策略：UE使用该策略来确定匹配的应用程序非无缝卸载到PDU会话之外的非3GPP接入网络。 
接入类型优先策略：用于UE需要为匹配的应用建立PDU会话，指示优选的接入类型是3GPP或非3GPP。 
####### 背景知识 
在2G/3G/4G时，UE上业务流使用的路由策略，是通过诸如OTA配置、UE上直接写入、UE上设置业务参数等方式控制的。如果要新增一种业务应用，就需要修改手机侧的路由策略，非常不灵活。
5G网络引入切片、SSC模式、统一3GPP和non-3GPP后，UE上对业务流的路由选择策略更加复杂。 
一方面非专业用户很难修改。通过在USIM卡预先写入（已放号的USIM卡无法写入）或其他非标准方式实现UE路由选择策略的修改，需专业人员实施，代价较大。 
另一方面由于引入切片等参数，和4G相比修改频度会增加。 
因此，为用户提供一种更灵活的更改路由策略的手段，将更加便于业务创新和网络维护。 
URSP策略可以根据不同目的应用，灵活地确定UE策略数据，如新增业务可以通过在URSP中新增策略，便于UE使用。 
##### 应用场景 
PCF可根据用户签约、接入网情况为UE下发URSP策略，包括如下场景： 
PCF能基于用户签约（套餐、用户类型等）、接入类型（Access Type）、无线接入类型（RAT）、跟踪区域（TAC）等条件决策URSP策略。 
PCF可下发基于各种业务流的URSP策略，可通过OS ID、地址类型、协议、端口、流标签等参数识别业务流。 
PCF可下发NSSP策略，为不同应用提供不同切片选择，UE根据不同的NSSP选择不同的应用专网，提供更好保障和用户体验。 
PCF可下发SSCMSP策略，为不同应用提供不同业务连续性策略，保证不同用户不同应用的会话业务连续性需求。 
PCF可下发DNN选择策略，为不同应用提供不同DNN，保证不同应用通过不同APN接入。 
PCF可下发PDU会话类型选择策略，UE可为不同应用选择建立不同类型的PDU会话，满足应用多样性需求。 
PCF可下发非无缝卸载策略，UE可将某应用卸载到非3GPP接入的数据网。 
PCF可下发接入类型优先策略，UE在为某应用建立PDU会话时，指示优选的接入类型。 
##### 客户收益 
收益方|收益说明
---|---
运营商|在网络资源有限的情况下，满足不同用户的多种应用场景，有效节省网络资源。
终端用户|根据不同的业务需求选择合适的URSP策略，提升用户体验。
##### 实现原理 
###### 系统架构 
RCP在5G核心网中位置如[图1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z6b1e71f339a94141a4f5066e3e4c032a__dd77b307-d02f-470c-81e5-dc5ee6aedcb3)所示。
图1  系统架构图
[]images/image.png)
###### 涉及的网元 
涉及的网元及其功能参见[表1](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z9537b6e275614a54a390600035238f17__7f5d194b-85ea-4ea9-98d9-04b2f82eeb00)。
网元|描述
---|---
PCF|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向PCF提供UE接入信息，从PCF获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向PCF提供PDU会话信息，从PCF获取PDU会话策略，下发给UPF执行。
UPF|执行PDU会话策略。
AF|向PCF提供应用层的业务信息，请求PCF进行策略授权。例如，对于VoNR（Voice over New Radio）业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源/目的IP地址和端口、请求带宽等提供给PCF。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如，判断AF请求是否合法）和翻译（例如，将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|PCF收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和PCF的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的PCF。
UDR/SPR|向PCF提供策略签约信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。
CHF|向PCF提供消费门限信息，例如，通知PCF某用户的月累计流量是否超过了特定门限。
###### 协议栈 
AMF与PCF间的UE策略通过N15接口来实现，N15协议栈如[图2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z22863284e9a94f6a974b4d01189f4d38__bb0f40da-fbb2-4e52-a7d7-456a6a512525)所示。
图2  N15协议栈
[]images/1625642513571.png)
AMF和PCF通过服务操作的调用，实现消息交互。AMF和PCF在N15接口提供的UE策略服务操作参见[表2](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z22863284e9a94f6a974b4d01189f4d38__f9ac1254-fd00-4813-a588-e47cdb3474a6)。
NF|服务|操作|操作语义|说明
---|---|---|---|---
PCF|Npcf_UEPolicyControl|Create|Request/Response|AMF向PCF请求建立UE策略关联，PCF在响应中可以订阅UE策略控制相关事件。
Update|PCF|Npcf_UEPolicyControl|Request/Response|AMF向PCF请求更新UE策略关联，PCF在响应中可以更新UE策略控制相关事件订阅。
Delete|PCF|Npcf_UEPolicyControl|Request/Response|AMF请求PCF删除UE策略关联。
UpdateNotify|PCF|Npcf_UEPolicyControl|Subscribe/Notify|PCF因为内部或外部事件触发，主动向AMF更新UE策略控制相关事件订阅。
AMF|Namf_Communication|N1MessageNotify|Subscribe/Notify|AMF从UE收到UE策略信息后通知PCF。
N1MessageSubscribe|AMF|Namf_Communication|Subscribe/Notify|PCF向AMF订阅UE上报的UE策略信息。
N1MessageUnSubscribe|AMF|Namf_Communication|Subscribe/Notify|PCF向AMF取消订阅UE上报的UE策略信息。
N1N2MessageTransfer|AMF|Namf_Communication|Request/Response|PCF通过AMF向UE下发UE策略。
N1N2TransferFailureNotification|AMF|Namf_Communication|Subscribe/Notify|AMF向UE传送UE策略失败后通知PCF。
UE策略的相关URI填写参见[表3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z22863284e9a94f6a974b4d01189f4d38__16a0a212-fbfb-49ae-b938-045eb1b63065)。
接口名称|方法|Head URI|Body URI
---|---|---|---
Npcf_UEPolicyControl_Create|POST|{apiRoot}/npcf-ue-policy-control/v1/policies/|notificationUri取值格式举例：{apiRoot}/namf-comm/v1/uepolicies/imsi-%s;pointer=%u
Npcf_UEPolicyControl_Update|POST|{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/update|无
Npcf_UEPolicyControl_Delete|DELETE|{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}|无
N1MessageSubscribe|POST|{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages/subscriptions|n1NotifyCallbackUri取值格式举例：{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-messages
N1N2MessageTransfer|POST|{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages|n1n2FailureTxfNotifURI取值格式举例：{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-failure/{PTI}
N1MessageUnSubscribe|DELETE|{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages/subscriptions/{subscriptionId}|无
N1MessageNotify|POST|{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-messages|无
N1N2TransferFailureNotification|POST|{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-failure/{PTI}|无
###### 业务流程 
######## UE策略关联建立 
在如下两个场景，会触发AMF向PCF建立UE策略关联（UE Policy Association）。 
UE初始注册。 
容灾切换过程中AMF重分配新的PCF，AMF重新发起注册过程。 
UE策略关联建立的流程如[图3](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z29efa7faae2d4fef99bffa924588b347__506917c4-fe50-4610-8b6d-f8de574de347)所示。
图3  UE策略关联建立
[]images/ue%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E5%BB%BA%E7%AB%8B1.png)
流程说明如下： 
UE开机。 
UE向AMF发送注册请求。 
AMF收到UE的注册请求消息，或者注册更新或切换过程中AMF和PCF都改变，AMF更新该用户的注册信息。 
AMF回复注册应答给UE。 
AMF向PCF发送Npcf_UEPolicyControl Create Request消息，携带notificationUri、SUPI、Access Type、RAT、PEI、ULI、UE time zone、Serving Network、UE Policy Container （the list of stored PSIs）等信息。如果是漫入用户，AMF根据本地配置，也可以携带hPCF ID信息。 
如果本地没有用户签约数据，从UDR/SPR获取签约数据。 
PCF根据本地策略进行URSP策略决策。 
PCF向AMF返回Npcf_UEPolicyControl Create Response消息。如果Npcf_UEPolicyControl Create消息包含了PSI列表，且与从UDR/SPR获取的PSI列表一致，并且PCF决策后的PSI列表也和从UDR/SPR获取的PSI列表一致（包括每个PSI存储的摘要信息与当前决策PSI的摘要信息也一致），则流程结束。如果不一致，继续下面步骤9~18。 
PCF向AMF发起Namf_Communication_N1N2MessageSubscribe订阅UE策略分发结果，头部的URL格式为：{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages/subscriptions，并在Body中携带订阅UE上下文的URI，约定{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-messages。 
AMF向PCF回复响应时，在头部Location携带subscriptionId，以便后续去订阅时使用。 
PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略，同时启动T3501定时器。 
PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应，跳转步骤13继续执行。 
（可选）AMF在本网元检测失败，如事务冲突，或者正在处理同用户注册、切换、多次寻呼等情况下直接判定流程失败，则直接回复Namf_Communication_N1N2MessageTransfer失败应答，不继续后续流程。 
（可选）AMF寻呼失败后，通过Namf_Communication_N1N2TransferFailureNotification异步消息，通知PCF传输UE策略失败。 
（可选）PCF向AMF回复失败通知应答。 
AMF向PCF发送Namf_Communication_N1MessageNotify的请求消息。 
PCF向AMF回复Namf_Communication_N1MessageNotify应答消息。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为MANAGE UE POLICY COMPLETE，则PCF向UDR/SPR存储更新UE策略。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为 MANAGE UE POLICY COMMAND REJECT，则PCF的会将策略恢复为本次决策前的状态，不会保存本次决策的UE策略，并且不向UDR/SPR存储更新UE策略。 
PCF向UDR/SPR更新URSP策略信息。 
UDR/SPR回复更新成功应答。 
######## AMF触发UE策略关联修改 
在如下两个场景，会触发AMF向PCF修改UE策略关联（UE Policy Association）。 
在事件变更（"LOC_CH" and "PRA_CH"）时，会触发AMF向PCF修改UE策略关联。 
AMF改变但PCF不变时，新的AMF会向PCF请求修改UE策略关联。 
AMF触发UE策略关联修改的流程如[图4](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z29efa7faae2d4fef99bffa924588b347__4c5973f2-3880-4272-a38c-120e071b05d4)所示。
图4  AMF触发UE策略关联修改UE
[]images/amf%E8%A7%A6%E5%8F%91ue%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E6%9B%B4%E6%96%B0.png)
流程说明如下： 
如果AMF检测到需更新UE策略关联，例如，位置改变，或者发生了AMF改变但PCF不变的注册更新或切换流程，则AMF确定发起UE策略关联更新过程。AMF给PCF发送Npcf_UEPolicyControl Update Request消息，携带SUPI、事件及相关信息。 
PCF收到消息后，结合位置、签约等信息进行URSP决策。 
PCF向AMF回复Npcf_UEPolicyControl Update Response消息。 
PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略，同时启动T3501定时器。 
PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应，跳转步骤6继续执行。 
（可选）AMF在本网元检测失败，如事务冲突、正在处理同用户注册、切换、多次寻呼等情况下直接判定流程失败，则直接回复Namf_Communication_N1N2MessageTransfer失败应答，不继续后续流程。 
（可选）AMF寻呼失败后，通过Namf_Communication_N1N2TransferFailureNotification异步消息，通知PCF传输UE策略失败。 
（可选）PCF向AMF回复失败通知应答。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息。 
PCF回复Namf_Communication_N1MessageNotify应答消息。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为MANAGE UE POLICY COMPLETE，则PCF向UDR/SPR存储更新UE策略。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为MANAGE UE POLICY COMMAND REJECT，则PCF的会将策略恢复为本次决策前的状态，不会保存本次决策的UE策略，并且不向UDR/SPR存储更新UE策略。 
PCF向UDR/SPR更新URSP策略信息。 
UDR/SPR回复更新成功应答。 
######## PCF触发的UE策略关联修改 
在如下两个场景，会触发PCF向AMF修改UE策略关联（UE Policy Association）。 
用户签约的policy data改变。 

PCF本地策略改变触发UE policy data改变。 
PCF触发的UE策略关联修改流程如[图5](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z29efa7faae2d4fef99bffa924588b347__a5afbb95-6fb2-4d14-a9cc-8a1fb83b4b90)所示。
图5  PCF触发的UE策略关联修改
[]images/pcf%E8%A7%A6%E5%8F%91ue%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E6%9B%B4%E6%96%B0.png)
流程说明如下： 
PCF检测到签约数据变更或本地运营策略变更. 
PCF重新决策URSP策略。 
如果PCF决策更新触发事件，则发送Npcf_UEPolicyControl_UpdateNotify请求并携带URI "{Notification URI}/update"和变化的事件。 
AMF向PCF回复更新通知应答。 
PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略，同时启动T3501定时器。 
PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应，跳转步骤7继续执行。 
（可选）AMF在本网元检测失败，如事务冲突、正在处理同用户注册、切换、多次寻呼等情况下直接判定流程失败，则直接回复Namf_Communication_N1N2MessageTransfer失败应答，不继续后续流程。 
（可选）AMF寻呼失败后，通过Namf_Communication_N1N2TransferFailureNotification异步消息，通知PCF传输UE策略失败。 
（可选）PCF向AMF回复失败通知应答。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息。 
PCF回复Namf_Communication_N1MessageNotify应答消息。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为MANAGE UE POLICY COMPLETE，则PCF向UDR/SPR存储更新UE策略。 
PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息为MANAGE UE POLICY COMMAND REJECT，则PCF的会将策略恢复为本次决策前的状态，不会保存本次决策的UE策略，并且不向UDR/SPR存储更新UE策略。 
PCF向UDR/SPR更新URSP策略信息。 
UDR/SPR回复更新成功应答。 
######## AMF触发的UE策略关联终止 
在如下两个场景，会触发AMF向PCF终止UE策略关联（UE Policy Association）。 
UE触发注销。 
注册更新或切换过程中，PCF发生改变。 
AMF触发的UE策略关联终止流程如[图6](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z29efa7faae2d4fef99bffa924588b347__a72f4c54-f9f2-42cc-b8b3-2f605dc7fa78)所示。
图6  AMF触发的UE策略关联终止
[]images/amf%E8%A7%A6%E5%8F%91%E7%9A%84ue%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E7%BB%88%E6%AD%A2.png)
流程说明如下： 
如果AMF收到UE的注销请求消息，或者注册更新或切换过程中PCF改变了，则AMF确定发起UE策略关联终止请求Npcf_UEPolicyControl Delete Request。 
PCF的UEPolicyControl收到消息后，给AMF返回Npcf_UEPolicyControl Delete Response消息。 
PCF向AMF发起Namf_Communication_N1N2MessageUnsubscribe 去订阅UE策略分发结果，并携带订阅UE上下文的URI，{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages/subscriptions/subscriptionId。 
AMF向PCF回复去订阅应答。 
PCF向UDR/SPR取消策略变更订阅。 
UDR/SPR回复取消订阅成功应答。 
######## PCF触发的UE策略关联终止 
当UDR中用户数据被删除，PCF向AMF终止UE策略关联（UE Policy Association），流程如[图7](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z29efa7faae2d4fef99bffa924588b347__31c15091-381f-4df6-8294-208d5d9d65b1)所示。
图7  PCF触发的UE策略关联终止
[]images/pcf%E8%A7%A6%E5%8F%91%E7%9A%84ue%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E7%BB%88%E6%AD%A2.png)
流程说明如下： 
UDR/SPR删除了UE策略数据。 
UDR/SPR向PCF发送Nudr_DataRepository_Notify Req消息。 
PCF向UDR返回Nudr_DataRepository_Notify Resp消息。 
PCF发送终止消息Npcf_UEPolicyControl_UpdateNotify给AMF，携带URI 为{Notification URI}/terminate。 
AMF的Namf_Communication服务收到消息后，终止UE Policy Association，给PCF返回Npcf_UEPolicyControl_UpdateNotify Ack消息。 
如果AMF收到UE的注销请求消息，或者注册更新或切换过程中PCF改变了，则AMF确定发起UE 策略关联终止请求Npcf_UEPolicyControl Delete Request。 
PCF的UEPolicyControl收到消息后，给AMF返回Npcf_UEPolicyControl Delete Response消息。 
PCF向AMF发起Namf_Communication_N1N2MessageUnsubscribe 去订阅UE策略分发结果，并携带订阅UE上下文的URI，{apiRoot}/namf-comm/v1/ue-contexts/{ueContextId}/n1-n2-messages/subscriptions/subscriptionId。 
AMF向PCF回复去订阅应答。 
###### 本网元实现 
######## UE策略的发送 
PCF基于运营商配置的策略，并结合各NF提供的输入信息，进行策略决策，确定下发给AMF的UE策略。 
PCF可以通过以下方式确定UE策略所应选择的AMF。 
方式1：通过请求消息的notificationUri中的IP地址进行发送。 
方式2：通过上线请求消息携带的备用IP地址（altNotifIpv4Addrs或者altNotifIpv6Addrs）进行发送。 
方式3：使用UE会话上线请求消息携带的guami等字段，向NRF查询获取地址后进行发送。 
上述三种方式按方式1、方式2、方式3的优先级进行选择。 
######## URSP策略的组织 
URSP策略的目的是为UE提供选择应用匹配业务流路由的规则。 
URSP策略以UPSC为最小单位进行下发，一个UPSC可以包含多个URSP规则。
UE策略决策过程如[图8](%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z828c4d84f170491fbafdb64910bf3352__b2206ef0-c8a0-465c-832e-ab6257f7a50d)所示，包括场景入口、套餐动态优先级策略决策、URSP决策（包括规则条件匹配和决策输出）。
图8  URSP策略组织
[]images/2f4128a42e6d470fadab437069d30482.png)
其中： 
根据UE签约的套餐标识、用户类型、接入方式、无线接入类型、TAC、接入属性、PRA状态等，确定用户的可用套餐。 
根据套餐动态优先级策略，决策确定用户当前生效的套餐。可以作为URSP决策的条件。 
UE决策出的URSP规则中，包含业务流描述器、路由选择策略。业务流描述器作用是确定路由选择策略何时生效。如果UE当前的信息与业务流描述器中的信息是匹配的，说明该URSP规则是适用的，UE会应用对应的路由选择策略。 
######## URSP策略的下发和删除 
UE上线请求消息会携带UE侧已经安装的URSP规则，PCF决策出的URSP规则如果和UE上线携带的规则一致，则本次决策出的URSP策略不会进行下发。 
UE会话更新过程中，PCF决策出的URSP规则如果和UE上线下发的规则一致，则本次更新过程决策出的URSP策略不会进行下发。 
对一个UPSC而言，若上次决策有规则，本次没有决策出该UPSC的任何规则，则仍然需要调用N1编码，内容长度为0，指示UE删除相应的URSP策略。 
######## URSP策略存储 
UE会话上线消息中只携带UPSI（UE Policy Section
Identifier），不携带规则的具体内容。PCF需要能够判断出策略内容是否发生变化。 
PCF会通过Sp'接口对URSP策略的摘要进行保存，用于判断规则是否发生变化，从而决定是否下发URSP策略。 
UE上线时向PCF提供之前下发的UPSI列表，PCF从SPR获取之前保存的摘要。 
PCF根据当前配置的策略信息与获取的摘要做对比，如果变化（说明用户不在线期间，运维人员通过EM修改了PCF上的用户策略配置），重新向UE下发UPSI及对应的UE策略。 
######## UE策略分包处理 
PCF可配置发送给UE的最长包大小，协议建议PCF配置的最长包大小不要超过PDCP最大长度限制（8188字节）。PCF配置的最长包大小限制建议在1000~8000个字节。
如果多个UE策略规则合并到一起时，超过了预配置的最长包大小，PCF会根据UPSI为最小单位进行分包处理，每个包限定在预配置的最长包大小范围内。 
PCF会为每个分包生成一个流程，使用PTI（Procedure transaction identity ）进行标识，各自处理UE策略安装结果。 
######## 保活 
为了防止PCF与AMF之间由于消息丢失等异常情况造成会话资源挂死，PCF利用Npcf_UEPolicyControl_Update通知实现保活功能。当PCF与AMF之间的已建立的某个UE会话在一定时间内没有消息交互时，PCF构造携带无内容的PolicyUpdate的Npcf_UEPolicyControl_Update通知发送到AMF，根据AMF返回的HTTP状态码来检测会话资源是否存在。 
如果通知响应的HTTP状态码为404 Not Found时，PCF就释放该UE会话资源；其他情况认为保活成功。 
如果超时未接收到通知响应，PCF则等待10分钟后重发保活消息。如果AMF一直不回响应，PCF则每隔10分钟重发保活消息，直到防挂死释放UE会话。 
可通过网元间保活检测配置（[SET SESSKADCT](../../Npcf_PolicyManagement\zh-CN\mml\1787157.html)命令），开启或关闭UE会话的保活功能，并设置保活消息间隔时长。
######## 重发 
当PCF向AMF发送UE策略关联修改、UE策略关联终止、UE N1 Transfer、UE Sub、UE Unsub请求时，如果PCF的HTTP/LB代理回复如下内部失败码： 

建立TCP链接失败 
发送HTTP请求超时无响应 
路由请求发送超时 
收到了服务端的RST 
其他内部错误响应 
则PCF会根据AMF携带的备选IP进行重发请求。如果重发失败，则根据AMF携带的guami（Globally Unique AMF Identifier）发现AMF。如果发现成功，则向新AMF重发请求。 
######## UE失败流程处理 
PCF在构建Namf_Communication_N1N2MessageTransfer消息时，会同时构建n1n2FailureTxfNotifURI字段，供AMF在发送Namf_Communication_N1N2TransferFailureNotification时作为URL使用。其中，n1n2FailureTxfNotifURI的格式为：{apiRoot}/npcf-ue-policy-control/v1/policies/{polAssoId}/n1-n2-failure/{PTI} ，PTI为多包时确认包序号时使用。 
PCF在发送Namf_Communication_N1N2MessageTransfer消息，下发UE策略时，收到AMF发送Namf_Communication_N1N2MessageTransfer失败应答，携带如下响应码：响应码为409，并且正确携带了retryAfter字段（格式正确为秒数），PCF会在retryAfter指定的秒数后，重新构建Namf_Communication_N1N2MessageTransfer进行策略的重发。如果retryAfter携带的秒数超过了30秒，PCF会在30秒后进行策略重发，如果此时AMF的返回码仍为409，PCF重复该流程。如果AMF同一会话的响应码连续四次都为409，PCF在使用retryAfter进行三次重发后，第四次不再进行重发。 说明：如果retryAfter字段携带错误，则PCF不会主动触发策略重发，后续PCF进行重决策时，会进行策略重发。
响应码为504，PCF会将本次决策出的UE策略进行回滚，保持和AMF策略的一致性。 
PCF收到AMF发送的Namf_Communication_N1N2TransferFailureNotification异步消息通知传输UE策略失败后，会将本次决策出的UE策略进行回滚，保持和AMF策略的一致性。 
多包场景下，PCF在收到Namf_Communication_N1N2MessageTransfer错误响应或者Namf_Communication_N1N2TransferFailureNotification通知后，只会对消息对应的策略分片进行回滚。例1：
（1）PCF下发了A、B两个策略，分为两个包下发。
（2）其中A策略收到了Namf_Communication_N1N2MessageTransfer409错误响应，retryAfter为3秒；B策略正常被终端接受。 
（3）3秒后，PCF重发UE策略。条件未发生变化的情况下，PCF只会对A策略进行重发。例2：
（1）PCF下发了A、B两个策略，分为两个包下发。
（2）其中A策略收到了Namf_Communication_N1N2TransferFailureNotification通知；B策略正常被终端接受。 
（3）后续如果UE会话发起更新，条件未发生变化的情况下，PCF只会对A策略进行重发。 
######## Token授权认证 
在N15接口PCF作为服务提供者时，可根据开关1265（N15接口Oauth安全校验开关）决定是否需要进行Token授权认证。 
当1265开关开启时，会对AMF发过来的请求消息进行校验。 
校验步骤如下： 
从http的Authorication参数中获取Token串，并使用NRF的密钥进行解密。解密失败，返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
对于Token串中的内容进行验证。 
subject（NFS consumer 的NF id）：请求消息中携带的NF id和校验token解密出的授权NF id是否一致。 
audience （NFS producer的id和type）：producer是否符合audience的NF id或者type。 
scope（NFS producer service name）：请求访问的service是否在scope范围内。 
expiration（有效期）：当前时间戳是否超过有效期，可适当允许有效期误差。 
上述参数除scope以外的参数，检查失败返回响应HTTP status code: "401 Unauthorized"，携带头"WWW-Authenticate"，其中的error为"invalid_token"。 
上述参数中的scope参数，检查失败返回响应HTTP status code: "403 Forbidden"，携带头"WWW-Authenticate"，其中的error为"insufficient_scope"。 
因为各网元可能有微小的差异，因此在NRF策略配置中，增加了令牌有效期允许最大偏差(秒)参数，如果expiration超过当前时间，但是在此误差以内，依然认为有效。
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
UE策略为二进制码流协议，需要严格对齐协议规范，目前版本支持3GPP TS 24.526 f30。 
##### 特性间交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System (R15)
3GPP|TS 23.502|Procedures for the 5G System (R15)
3GPP|TS 23.503|Policy and Charging Control Framework for the 5G System (R15)
3GPP|TS 24.526|User Equipment (UE) policies for 5G System (5GS) (R15)
3GPP|TS 29.518|Access and Mobility Management Services (R15)
3GPP|TS 29.525|UE Policy Control Service (R15)
##### 特性能力 
能力名称|指标
---|---
URSP规则限制|单条URSP规则最多包含4个业务流描述器、5个UE路由选择策略。
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
该特性对其它网元无特殊要求。 
##### O&M相关 
####### 命令 
命令项|命令名称|描述
---|---|---
UE策略全局配置|SET UEPLYGLB|修改UE策略全局配置。UE策略分包大小：用于配置UE策略分包大小，如果UE策略大小超过配置值，PCF会对策略进行分包发送。UE策略重发时长（ms)：用于配置UE策略重发时长。UE策略重发次数：用于配置UE策略重发次数。
SHOW UEPLYGLB|UE策略全局配置|查询UE策略全局配置。
操作系统应用标识配置|ADD UEOSAPPID|新增操作系统应用标识配置。该配置与UE业务流描述参数集中操作系统标识与应用标识对应，当业务流类型为操作系统应用标识的UE业务流描述器需要引用配置操作系统应用标识参数时，执行该命令。
SET UEOSAPPID|操作系统应用标识配置|修改操作系统应用标识配置。
DEL UEOSAPPID|操作系统应用标识配置|删除操作系统应用标识配置。
SHOW UEOSAPPID|操作系统应用标识配置|查询操作系统应用标识配置。
IP服务地址配置|ADD UEIP|新增IP服务地址配置。该配置与UE业务流描述参数集中IPv4对端地址对应，当业务流类型为IPv4地址或者IPv6地址的UE业务流描述器需要引用配置IP地址参数时，执行该命令。
SET UEIP|IP服务地址配置|修改IP服务地址配置。
DEL UEIP|IP服务地址配置|删除IP服务地址配置。
SHOW UEIP|IP服务地址配置|查询IP服务地址配置。
服务端口配置|ADD UEPORT|新增服务端口配置。该配置与业务流描述参数集中对端端口范围对应，当业务流类型为服务端口的UE业务流描述器需要引用配置服务端口参数时，执行该命令。
SET UEPORT|服务端口配置|修改服务端口配置。
DEL UEPORT|服务端口配置|删除服务端口配置。
SHOW UEPORT|服务端口配置|查询服务端口配置。
服务类型配置|ADD UESERVTYPE|新增服务类型配置。该配置与UE业务流描述参数集中服务类型对应，当业务流类型为服务类型的UE业务流描述器需要引用配置服务类型参数时，执行该命令。
SET UESERVTYPE|服务类型配置|修改服务类型配置。
DEL UESERVTYPE|服务类型配置|删除服务类型配置。
SHOW UESERVTYPE|服务类型配置|查询服务类型配置。
PCPDEI配置|ADD UEPCPDEI|新增服务端口配置。该配置与UE业务流描述参数集中PCPDEI对应，当业务流类型为PCPDEI的UE业务流描述器需要引用配置PCPDEI参数时，执行该命令。
SET UEPCPDEI|PCPDEI配置|修改PCPDEI配置。
DEL UEPCPDEI|PCPDEI配置|删除PCPDEI配置。
SHOW UEPCPDEI|PCPDEI配置|查询PCPDEI配置。
单网络切片配置|ADD UESNSSAI|新增单网络切片配置。该配置与UE路由选择描述参数集中SNSSAI对应，当UE路由选择描述器需要引用配置切片参数时，执行该命令。
SET UESNSSAI|单网络切片配置|修改单网络切片配置。
DEL UESNSSAI|单网络切片配置|删除单网络切片配置。
SHOW UESNSSAI|单网络切片配置|查询单网络切片配置。
IP三元组配置|ADD IPTRIPLETUPLE|新增IP三元组配置。该配置与UE业务流描述参数集中IP三元组对应，当业务流类型为IP三元组的UE业务流描述器需要引用配置IP三元组参数时，执行此命令。
SET IPTRIPLETUPLE|IP三元组配置|修改IP三元组配置。
DEL IPTRIPLETUPLE|IP三元组配置|删除IP三元组配置。
SHOW IPTRIPLETUPLE|IP三元组配置|查询IP三元组配置。
####### 性能统计 
测量类型|描述
---|---
52002 N15接口测量|包括编号C520020019~C520020036、C520020044~C520020060的UE策略相关计数器。
####### 告警与通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置URSP策略 
###### 配置说明 
配置URSP策略，实现PCF根据用户签约、接入网等信息为UE下发URSP策略，用于UE决定如何路由出局业务流。 
###### 配置前提 
URSP策略需要RCP、AMF、PUDR配合共同完成的，需保证三个网元的功能及交互正常。 
###### 配置过程 
URSP策略配置流程如[图1](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z480f545a42884590b568e5bdaa0c7d5b__9e6779ed-6857-4a68-8767-6aeeaf9383ef)所示。
图1  URSP配置流程
[]images/URSP%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
配置步骤： 
在EM-配置页面，Npcf_PolicyManagement_0 服务，进行UE策略业务流及路由基本元素配置。 
执行[ADD UEOSAPPID](../../Npcf_PolicyManagement\zh-CN\mml\1788146.html)命令，配置操作系统应用标识，用于UE策略下发流量描述符。
执行[ADD UESNSSAI](../../Npcf_PolicyManagement\zh-CN\mml\1788166.html)命令，配置单网络切片，用于UE策略下发网络切片信息。
在EM-配置页面，Npcf_PolicyManagement_0 服务，进行策略配置，包括配置条件、动作参数、规则和场景。 
执行[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html)命令，配置条件。
执行[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html)命令，配置动作。
执行[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html)命令，配置规则。
执行[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html)命令，配置场景。
###### 配置实例 
######## 场景说明 
PCF下发NSSP策略，为应用提供切片选择。 
######## 数据规划 
基本数据规划类别参数取值操作系统应用标识配置名称osid1操作系统标识01234567890123456789012345678901应用标识os1单网络切片配置名称NS1SST10SD111111 
UE路由选择策略规划策略类型控制条件决策参数UE路由选择策略用户套餐=1UE路由选择策略参数集 
######## 业务配置关系 
业务配置关系如[图2](%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#z7c9badfa75a242249cef2e9b0f2952d9__21b23f81-643f-4bfa-8265-29d7de710de1)所示。
图2  业务配置关系图
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB.png)
######## 配置步骤 
配置基础数据。 
配置操作系统应用标识。 
[ADD UEOSAPPID](../../Npcf_PolicyManagement\zh-CN\mml\1788146.html):NAME="osid1",OSID="01234567890123456789012345678901",APPID="os1"
配置单网络切片。 
[ADD UESNSSAI](../../Npcf_PolicyManagement\zh-CN\mml\1788166.html):NAME="NS1",SST=10,SD=111111
配置UE策略。 
配置接入条件。 
条件名称|参数|取值
---|---|---
接入类型3GPP|选择策略变量|其他
策略变量类别|接入类型3GPP|接入信息类
策略变量|接入类型3GPP|接入类型
操作符|接入类型3GPP|=
值类型|接入类型3GPP|值
值|接入类型3GPP|3GPP接入
配置动作参数。 
动作参数名称|参数|取值
---|---|---
UE路由选择参数|动作参数类型|UE路由选择策略参数集
URSP规则参数集ID|UE路由选择参数|URSP
动作参数名称|参数|取值
---|---|---
URSP规则参数|动作参数类型|URSP规则参数集
URSP规则名|URSP规则参数|URSP
业务流描述参数集ID|URSP规则参数|UE业务流参数
路由选择描述参数集ID|URSP规则参数|UE路由选择描述
动作参数名称|参数|取值
---|---|---
UE业务流参数|动作参数类型|UE业务流描述参数集
业务流类型|UE业务流参数|OS Id + OS App ID
操作系统应用标识|UE业务流参数|osid1
动作参数名称|参数|取值
---|---|---
UE路由选择描述|动作参数类型|UE路由选择描述参数集
SNSSAI|UE路由选择描述|NS1
配置规则。 
规则名称|参数|取值
---|---|---
UERule|优先级|1
动作类型|UERule|参数填充
日志开关|UERule|关闭
选中动作参数名称|UERule|UE路由选择参数
选中条件名称|UERule|接入类型3GPP
配置场景。 
场景名称|参数|取值
---|---|---
UERoute|入口1|入口类型|用户信息类
已选入口|UERoute|入口1|用户套餐
取值|UERoute|入口1|1
######## 配置脚本 
//配置基础数据 
ADD UEOSAPPID:NAME="osid1",OSID="01234567890123456789012345678901",APPID="os1"
ADD UESNSSAI:NAME="NS1",SST=10,SD=100
//配置UE策略 
ADD DM COND:NAME="接入类型3GPP",SVCKEY="SYS.ACCESS_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="3GPP_ACCESS";
ADD DM ACTION:NAME="UE业务流参数",TYPE="UE_TRAFFIC",PARAMS="SYS.URSP_TRAF_TYPE"-"VALUE"-"OSAPPID"&"SYS.URSP_TRAF_OS_APPID"-"VALUE"-"osid1";
ADD DM ACTION:NAME="UE路由选择描述",TYPE="UE_ROUTE_DESC",PARAMS="SYS.URSD_PRECEDENCE"-"VALUE"-"1"&"SYS.URSD_SNSSAI"-"VALUE"-"NS1";
ADD DM ACTION:NAME="URSP规则参数",TYPE="URSP_RULE_DESC",PARAMS="SYS.URSP_RULE_NAME"-"VALUE"-"URSP"&"SYS.URSP_RULE_UPSC"-"VALUE"-"1"&"SYS.URSP_RULE_PRECEDENCE"-"VALUE"-"1"&"SYS.URSP_RULE_TRAF_DESC_ACT_ID"-"VALUE"-"UE业务流参数"&"SYS.URSP_RULE_URSD_ACT_ID"-"VALUE"-"UE路由选择描述";
ADD DM ACTION:NAME="UE路由选择参数",TYPE="UE_ROUTE_POLICY",PARAMS="SYS.URSP_RULE_ACT_ID"-"VALUE"-"URSP规则参数";
ADD DM RULE:NAME="UERule",PLCTYPE="DM_RULE_TYPE_UE_URSP_DEC",PRIOR=1,CONDEXP="{接入类型3GPP}",ACTTYPE="PARAM",ACTNAME="UE路由选择参数",LOGFLAG="OFF",RULENO=0;
ADD DM ROLE:NAME="UERoute",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="UERule",VALIDFLAG="ENABLE";
##### 测试用例 
测试项目|PCF下发NSSP策略，为应用提供切片选择
---|---
预置条件|PCF运行正常，与周边NF通讯正常。PCF按照“配置实例”中的场景进行配置。
测试过程|AMF向PCF发送Npcf_UEPolicyControl Create Request消息，携带notificationUri、SUPI、Access Type、RAT等信息。由于本地没有用户签约数据，PCF向SPR获取签约数据，其中返回套餐1。PCF根据本地策略进行URSP策略决策。PCF向AMF返回Npcf_UEPolicyControl Create Response消息。PCF向AMF发起Namf_Communication_N1N2MessageSubscribe订阅UE策略分发结果。PCF收到AMF的Namf_Communication_N1N2MessageSubscribe应答响应。PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应。PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息，立即回复Namf_Communication_N1MessageNotify应答消息。
通过准则|UE策略关联建立成功，正确下发UE策略。
测试项目|PCF发起保活，对端响应成功
---|---
预置条件|PCF运行正常，与周边NF通讯正常。UE接口相关配置正常。UE会话保活时长设置为10 min。
测试过程|AMF向PCF发送Npcf_UEPolicyControl Create Request消息，发起UE创建会话请求，携带备选IP和GUAMI。PCF向AMF返回Npcf_UEPolicyControl Create Response消息。PCF向AMF发起Namf_Communication_N1N2MessageSubscribe订阅UE策略分发结果。PCF收到AMF的Namf_Communication_N1N2MessageSubscribe应答响应。PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应。PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息，立即回复Namf_Communication_N1MessageNotify应答消息。10 min后，PCF向AMF发送UE notify请求消息发起保活。AMF向PCF发送UE notify响应消息，响应码为204 。
通过准则|UE会话保活成功，PCF仅发送了一次保活请求消息 。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令，查询数据区中UE会话，数据区中UE会话依然存在。执行SHOW_SYS命令，查询会话依然存在。执行SHOW_UE_SESSION命令，查询会话信息已更新 。
测试项目|PCF发起保活，对端无响应，第一次重发对端无响应，第二次重发对端响应非404
---|---
预置条件|PCF运行正常，与周边NF通讯正常。UE接口相关配置正常。UE会话保活时长设置为10min 。会话消息中携带的备选地址可用。
测试过程|AMF向PCF发送Npcf_UEPolicyControl Create Request消息，发起UE创建新会话，携带两个备选IP。PCF向AMF返回Npcf_UEPolicyControl Create Response消息。PCF向AMF发起Namf_Communication_N1N2MessageSubscribe订阅UE策略分发结果。PCF收到AMF的Namf_Communication_N1N2MessageSubscribe应答响应。PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer应答响应。PCF收到AMF的Namf_Communication_N1MessageNotify的请求消息，立即回复Namf_Communication_N1MessageNotify应答消息。10 min后，PCF向AMF发送UE notify请求消息发起保活。首选AMF未响应或响应超时。PCF向第一个备选AMF发送UE notify请求消息保活。第一个备选AMF未响应。PCF向第二个备选AMF发送UE notify请求消息保活 。第二个备选AMF向PCF响应失败400。
通过准则|PCF发送了三次保活消息，分别发往三个不同的AMF。执行SHOW_STAT_INFO:MODULE="RCP_DATA"命令，查询数据区中UE会话，数据区中UE会话依然存在。执行SHOW_SYS命令，查询会话依然存在。执行SHOW_UE_SESSION命令，查询会话信息已更新。
测试项目|PCF向AMF发送transfer消息下发UE策略失败，第一次对端回409未携带retryAfter，第二次对端回409并携带retryAfter=5
---|---
预置条件|PCF运行正常，与周边NF通讯正常。UE接口相关配置正常。
测试过程|AMF向PCF发送Npcf_UEPolicyControl Create Request消息，发起UE策略会话建立。PCF向AMF返回Npcf_UEPolicyControl Create Response消息。PCF向AMF发送Namf_Communication_N1N2MessageSubscribe请求消息订阅UE策略分发结果成功。PCF收到AMF的Namf_Communication_N1N2MessageSubscribe应答响应。PCF向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer失败应答响应，对端回409，消息中携带cause为TEMPORARY_REJECT_HANDOVER_ONGOING，未携带retryAfter。PCF收到AMF的Namf_Communication_N1MessageNotify请求消息更新UE策略会话。PCF向AMF发送Npcf_UEPolicyControl_UpdateNotify请求消息下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer失败应答响应，对端回409，消息中携带cause为UE_IN_CM_IDLE_STATE，retryAfter为5。5秒后，PCF再次向AMF发起Namf_Communication_N1N2MessageTransfer下发UE策略。PCF收到AMF的Namf_Communication_N1N2MessageTransfer成功应答响应。AMF向PCF发送UE notify请求消息上报UE的策略信息，携带内容为REJECT消息。PCF响应成功。
通过准则|UE上线，PCF向AMF发transfer消息下发UE策略失败。更新发送Transfer消息下发UE策略失败。5秒后重新发送Transfer消息下发UE策略成功。通过计数器统计消息次数正常。C520020051 发送UE N1消息传递请求次数  +3  C520020052  收到UE N1消息传递应答次数  +3C520020053 收到UE N1消息传递成功应答次数  +1C520020054 收到UE N1消息传递失败应答次数  +2 C520020059  收到UE N1消息通知请求次数  +1C520020060 发送UE N1消息通知应答次数  +1 C520020077  收到UE N1消息失败通知请求次数  +1C520020078  发送UE N1消息失败通知应答次数  +1C520020111  UE N1消息传递请求超时无应答次数  +0C520020112  UE N1消息传递请求超时应答次数  +0C520020137 收到UE N1消息传递失败应答次数（404 Not Found）+0
### 缩略语 
### 缩略语 
#### OS 
Operating System操作系统
#### OTA 
Over The Air空中传输
#### PDCP 
Packet Data Convergence Protocol分组数据收敛协议
#### SSC 
Session and Service Continuity会话与业务连续性
#### UPSC 
UE Policy Section CodeUE策略分片码
#### URSP 
UE Route Selection PolicyUE路由选择策略
## 套餐业务类特性 
### ZUF-59-55-011 CPE锁位置 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
CPE用户|使用CPE设备上网的用户统称为CPE用户。
活动小区|用户每次附着的4G小区就是活动小区。活动小区在地理位置上之间不一定邻接。
邻接小区|RCP认为活动小区都是邻接小区（只受最大活动小区个数限制，小区之间地理位置上可能不邻接）。RCP只存储ECGI类型的位置信息。
##### 描述 
####### 定义 
CPE是一种将高速4G信号转换成平板电脑、智能手机、笔记本等移动终端通用的WiFi信号的设备。
CPE锁位置，即用户只能在优惠区域内使用CPE上网，超出优惠区域使用CPE会限制用户的上网功能并提醒用户。 
该特性可以实现： 
识别用户，并判断用户位置。 
提醒用户。在以下两个场景中，RCP可以向用户发送提醒短信或邮件。由于短信的时效性较好，一般选择短信作为通知方式。两种场景分别是：用户首次使用CPE时进行提醒。用户使用CPE从非优惠区域接入时进行提醒。 
优惠区域重置。有时用户需要重新确定优惠区域，比如用户搬家时，用户使用CPE设备的常用地点发生变更。此时，用户需要通知运营商。运营商可以为用户清空原来的常用地点，用户在新的常用地点使用CPE设备时，RCP为用户重新确定优惠区域。 
####### 背景知识 
CPE可大量应用于农村、城镇、医院、工厂、小区等地，能节省铺设有线网络的费用，尤其适合有线网络难以覆盖的地区。 
运营商基于CPE设备为用户提供高速带宽和低廉的资费，使用户获得类似固网宽带的接入体验，但运营商也要防止用户滥用CPE。因此，运营商需要为每个CPE设置一定的优惠区域，用户只能在优惠区域内使用CPE。 
由于每个CPE签约的优惠区域各不相同，人工设置工作量大，效率低。为了能够帮助运营商快速开展CPE业务，RCP需要引入该特性。 
##### 应用场景 
CPE锁位置功能，适合在有线网络难以覆盖的地区使用。 
##### 客户收益 
受益方|受益描述
---|---
运营商|简化运维，降低成本。快速开展CPE业务。
用户|获得类似固网宽带的体验。获得优惠的资费。
##### 实现原理 
###### 系统架构 
CPE锁位置功能的系统架构如下图所示。 
[]images/4195ecd9d49c4d218ae0121c65699dc0.png)CPE锁位置特性涉及的网元描述参见下表。 
网元名称|网元作用
---|---
RCP|策略与计费决策功能实体。判断CPE用户的接入位置是否在优惠区域内，向PCEF下发策略。向短信中心发送提醒短信或者向邮件服务器发送提醒邮件。
PCEF|策略与计费执行功能实体。向RCP报告用户的接入位置，并执行RCP下发的策略。
BOSS|运维系统。为用户开通或取消CPE锁位置功能。为用户进行位置重置。
SPR|实现用户签约和邻接小区信息的存储和查询功能。
SMSC|接收RCP发送的短信，向用户发送短信。
邮件服务器|接收RCP发送的Email，向用户发送Email。
###### 业务流程 
######## 开通用户的CPE锁位置功能 
用户在使用CPE设备前，运营商需要在BOSS系统中为用户开通CPE套餐。
运营商通过BOSS系统为用户开通CPE套餐的流程参见[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__a0a8b72b-828f-4134-98b5-4a80fa537bfb)。
图1  开通用户的CPE锁位置功能
[]images/1-%E5%BC%80%E9%80%9A%E7%94%A8%E6%88%B7%E7%9A%84cpe%E9%94%81%E4%BD%8D%E7%BD%AE%E5%8A%9F%E8%83%BD.png)
业务流程描述如下：  
运营商通过BOSS系统为用户开通CPE套餐，使得用户的签约信息发生变更。BOSS系统使用SET PAK:命令向SPR推送用户签约变更消息，消息中携带CPE套餐ID。
SPR更新用户的签约信息，并向BOSS系统发送ACK:SET PAK:SUCCESS命令返回处理结果，表示用户签约信息更新成功。通常签约CPE套餐时，用户不在线，业务流程结束。
如果SPR检测到用户在线，则向RCP发送PNR消息，其中User-Profile-Info中包含CPE套餐ID，表示用户新签约CPE套餐。
RCP更新用户的签约信息，并向SPR返回PNA响应消息。RCP检测到用户新签约CPE套餐，可以向PCEF请求释放用户会话，目的是使用户在CPE的常用地开机使用。
######## 取消用户的CPE锁位置功能 
用户不再使用CPE设备上网，运营商需要在BOSS系统中为用户退订CPE套餐。 
运营商通过BOSS系统为用户退订CPE套餐的流程参见[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__12dc0b6a-fab1-43bd-8fbd-b31d30335009)。
图2  取消用户的CPE锁位置功能
[]images/2-%E5%8F%96%E6%B6%88%E7%94%A8%E6%88%B7%E7%9A%84cpe%E9%94%81%E4%BD%8D%E7%BD%AE%E5%8A%9F%E8%83%BD.png)
业务流程描述如下： 
运营商通过BOSS系统为用户退订CPE套餐，使得用户的签约信息发生变更。BOSS系统使用DEL PAK:命令向SPR推送用户签约变更消息，消息中携带CPE套餐ID。
SPR更新该用户的签约信息，并向BOSS系统发送ACK:DEL PAK:SUCCESS命令返回处理结果，表示用户签约信息更新成功。如果用户不在线，此业务流程结束。
SPR检测到用户在线，向RCP发送PNR消息，其中User-Profile-Info中不包含CPE套餐ID，表示用户不再签约CPE套餐。 
RCP更新用户的签约信息，并向SPR返回PNA响应消息。RCP检测到用户不再签约CPE套餐，会删除用户已经记录的位置信息。 
######## 用户首次开机使用CPE 
用户在工厂、小区等常用地点首次开机使用CPE设备上网，RCP可以识别用户并记录用户当前的ECI小区位置。
用户首次开机使用CPE的流程参见[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__f470132b-6937-4695-a153-d741bc306201)。
图3  用户首次开机使用CPE
[]images/3-%E7%94%A8%E6%88%B7%E9%A6%96%E6%AC%A1%E5%BC%80%E6%9C%BA%E4%BD%BF%E7%94%A8cpe.png)
业务流程描述如下：  
PCEF向RCP发起会话建立请求CCR-I消息，其中携带3GPP-User-Location-Info，表示用户当前的接入位置信息。
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含CPE套餐ID。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，消息中不携带ECI小区信息。 
RCP识别用户并记录用户当前的ECI小区位置，同时向用户发送提醒短信或邮件。 
RCP向PCEF发送CCA-I消息，其中包含Event-Trigger=ECGI_CHANGE，表示RCP向PCEF订阅位置变更通知事件。 
######## 用户在优惠区域内重新开机使用CPE 
用户在工厂、小区等常用地点重新开机使用CPE设备上网，RCP可以识别用户并记录用户当前的ECI小区位置。 
用户在优惠区域内使用CPE的流程参见[图4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__4e4a0c10-13c8-4a1b-8f97-22ca8d672d8b)。
图4  用户在优惠区域内重新开机使用CPE
[]images/4-%E7%94%A8%E6%88%B7%E5%9C%A8%E4%BC%98%E6%83%A0%E5%8C%BA%E5%9F%9F%E5%86%85%E9%87%8D%E6%96%B0%E5%BC%80%E6%9C%BA%E4%BD%BF%E7%94%A8cpe.png)
业务流程描述如下：  
PCEF向RCP发起会话建立请求CCR-I消息，其中携带3GPP-User-Location-Info，表示用户当前的接入位置信息。 
RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。 
SPR返回Sp-UDA消息，通过User-Profile-Info携带用户签约信息。其中Package-Profile-Info中包含CPE套餐ID。 
RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。 
SPR返回Sp'-UDA消息，消息中携带ECI小区信息，记录用户之前附着过的小区ECI列表。 
RCP识别用户并判断用户当前在优惠区域内。RCP在用户本地ECI小区信息中记录用户当前小区的ECI，在用户离线或需要向SPR上报动态信息时，RCP将本地ECI小区信息同步保存到SPR中。RCP向PCEF发送CCA-I消息，其中包含Event-Trigger = ECGI_CHANGE，表示RCP向PCEF订阅位置变更通知事件。 
######## 用户位置在优惠区域内切换 
用户位置在优惠区域内切换时流程参见[图5](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__33b02b16-11c1-4f88-a14c-48a29a2824de)。
图5  用户位置在优惠区域内切换
[]images/5-%E7%94%A8%E6%88%B7%E4%BD%8D%E7%BD%AE%E5%9C%A8%E4%BC%98%E6%83%A0%E5%8C%BA%E5%9F%9F%E5%86%85%E5%88%87%E6%8D%A2.png)
业务流程描述如下：  
PCEF向RCP发送CCR-U消息，其中携带Event-Trigger=ECGI_CHANGE和3GPP-User-Location-Info，表示用户位置发生变更。 
RCP识别用户并判断用户当前在优惠区域内，RCP在用户本地ECI小区信息中记录用户当前小区的ECI。RCP向PCEF发送CCA-U消息，其中包含Event-Trigger=ECGI_CHANGE，表示RCP向PCEF订阅位置变更通知事件。 
######## 用户在非优惠区域使用CPE 
用户在非优惠区域使用CPE设备，RCP通过策略配置可以禁止用户的上网功能，同时给用户发送提醒短信或邮件。 
存在“用户位置切换到非优惠区域”和“用户在非优惠区域使用CPE设备发起附着”两种情况，下面分别描述。 
用户位置切换到非优惠区域用户在使用CPE过程中，基站的覆盖范围产生变化，此时PCEF会通过CCR-U消息上报用户新的位置信息。用户位置切换到非优惠区域的流程参见图6。图6  用户位置切换到非优惠区域业务流程描述如下： PCEF向RCP发送CCR-U消息，其中携带Event-Trigger=ECGI_CHANGE和3GPP-User-Location-Info，表示用户位置发生变更。RCP判断用户的当前位置不在优惠区域内。RCP禁止用户使用网络，并向用户发送提醒短信或邮件通知。RCP向PCEF发送CCA-U响应。RCP主动发起RAR消息，其中携带Session-Release-Case，请求PCEF释放用户会话。PCEF发送RAA响应。PCEF发起CCR-T消息，释放用户会话。RCP向SPR发送Sp'-UDR消息，其中Used-Service-Info-Report中包含ECI小区信息。目的是将用户的活动小区列表和当前被拒绝接入的ECI小区信息保存到SPR中，下次用户上线时RCP可以从SPR获取到。SPR向RCP返回Sp'-UDA响应消息。RCP向SPR发送Sp-UDR消息，通知用户下线。SPR向RCP返回Sp-UDA响应消息。RCP向PCEF返回CCA-T消息。 
用户在非优惠区域使用CPE设备发起附着用户已经在常用地开机使用CPE设备，RCP为用户确定优惠区域后，如果用户将CPE设备移动到非优惠区域并重新开机，将触发此流程。用户在非优惠区域使用CPE设备发起附着的流程参见图7。图7  用户在非优惠区域使用CPE设备发起附着业务流程描述如下： PCEF向RCP发送CCR-I消息，其中携带3GPP-User-Location-Info，表示用户当前的接入位置信息。RCP向SPR发送Sp-UDR消息，用于获取用户的签约信息。SPR返回Sp-UDA消息，携带User-Profile-Info，表示用户的签约信息。其中Package-Profile-Info中包含CPE套餐ID。RCP向SPR发送Sp'-UDR消息，用于获取用户的动态信息。SPR返回Sp'-UDA消息，消息中携带ECI小区信息。RCP判断用户的当前位置不在优惠区域内。RCP禁止用户使用网络，并向用户发送提醒短信或邮件通知。RCP向PCEF发送CCA-I响应，消息中携带5003失败，表示拒绝用户上线请求。RCP向SPR发送Sp'-UDR消息，其中Used-Service-Info-Report中包含ECI小区信息。目的是将用户的活动小区列表和当前被拒绝接入的ECI小区信息保存到SPR中，下次用户上线时RCP可以从SPR获取到。SPR向RCP返回Sp'-UDA响应消息。RCP向SPR发送Sp-UDR消息，通知用户下线。SPR向RCP返回Sp-UDA响应消息。 
######## 用户位置重置 
当用户使用CPE设备的常用地点发生变更时，用户需要通知运营商。BOSS通知SPR删除已记录的ECI小区信息。用户在新的CPE常用地开机使用时，RCP可以重新记录用户位置。 
用户位置重置的流程参见[图8](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z2be8fbf909c0450cb89fab1b4ade2d41__c60c7925-44a1-4caa-a457-589de40c95bd)。
图8  用户位置重置
[]images/8-%E7%94%A8%E6%88%B7%E4%BD%8D%E7%BD%AE%E9%87%8D%E7%BD%AE.png)
业务流程描述如下：  
用户使用CPE常用地发生变更需要通知运营商。运营商通过BOSS对用户位置进行重置。BOSS系统使用DEL DYNINFO:命令向SPR推送位置重置消息，表示SPR需要删除ECI小区信息。 
SPR删除用户的ECI小区信息，并向BOSS系统发送ACK:DEL DYNINFO:命令返回处理结果，表示用户的ECI小区信息删除成功。 
SPR检测到用户在线，向RCP发送SP'-PNR消息，表示SPR已经清除该用户的ECI小区信息，通知RCP同步删除。 
RCP向SPR返回PNA响应消息。RCP检测到用户的ECI小区信息被清空，可以向PCEF请求释放用户会话，目的是使用户在新的CPE常用地开机使用。 
###### 本网元实现 
######## 实现原理 
CPE锁位置功能，大致实现原理如下：
通过BOSS为用户开通CPE锁位置功能，SPR中存储用户签约CPE套餐。
用户首次开机使用CPE，RCP根据用户签约识别CPE用户。RCP记录用户当前位置，并向PCEF订阅位置变更事件。
用户位置变更，RCP根据用户当前位置的ECI查询邻接小区配置表。
如果用户附着的4G小区数目未达到最大活动小区个数，RCP认为用户处于优惠区域内，会记录当前附着的ECI。 
如果超过最大活动小区个数，则认为当前不在优惠区域。 
通过这种判断，RCP可以确定用户位置是否在优惠区域内。用户下线时，RCP可以将用户ECI小区信息保存到SPR，目的是用户下次上线时可以获取。 
当BOSS清空SPR中的用户ECI小区信息时，SPR向RCP同步推送PNR消息。RCP需要清空本地保存的用户ECI小区信息并触发用户离线。 
RCP主要实现用户识别和用户位置判断。 
######## 用户识别 
RCP根据用户签约套餐信息识别是否为CPE用户。 
######## 通过最大活动小区个数对用户接入进行控制 
RCP需要在EM上配置每个CPE用户的最大活动小区个数（通过全局开关1384控制，范围1-18，默认值是18）。
如果用户附着的4G小区数目未达到最大活动小区个数，RCP认为用户处于优惠区域内，会记录当前附着的ECI。 
如果超过最大活动小区个数，RCP禁止用户附着，会拒绝用户使用网络。达到最大活动小区个数后，如果用户通过4G小区接入，那么RCP控制用户只能通过已经记录的4G小区使用网络。如果用户通过非4G小区接入，RCP不进行控制。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 29.212|定义PCEF和RCP之间的参考点。
##### 特性能力 
名称|指标
---|---
每个CPE用户的活动小区的最大个数|18
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.22.30|首次发布。
####### License要求 
该特性对License无要求。 
####### 对其他网元的要求 
该特性需要SPR网元配合实现。SPR需要先升级到支持邻接小区信息的存储和查询功能的版本。
##### O&M相关 
###### 配置命令 
######## 网管配置 
编号|命令名称|描述
---|---|---
1|SET SYS GLOBPARA:IDX=1384,CURVAL="18",EXTFLAG="ADVANCED";|1384全局开关控制最大活动小区数，范围1-18，默认值是18。
编号|命令名称|描述
---|---|---
1|ADD PKGINFO|新增参数：是否为CPE套餐
######## GUI配置 
所属类别|名称|描述
---|---|---
自定义策略变量|在线时套餐生效或失效|表示用户在线期间，指定套餐在生效、失效之间的切换状态。
用户信息类|CPE首次上线标识|表示用户是否为首次使用CPE上线。
用户信息类|归属CPE区域状态标识|表示用户当前是否在CPE优惠区域内接入网络。
######## 动态管理 
命令|增加项|描述
---|---|---
SHOW_PROFILE|If CPE Package|是否为CPE套餐。
CPE Recent Reject Cell ECI|SHOW_PROFILE|最近一次拒绝用户接入网络的小区ECI信息。
CPE Max Cell ECI Number|SHOW_PROFILE|每个CPE用户允许的最大活动小区个数。
CPE Cell ECI Number|SHOW_PROFILE|用户已经记录的活动小区个数。
CPE Adjacent Cell ECI|SHOW_PROFILE|活动小区ECI列表。
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
该特性不涉及告警消息的变化。 
###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 
#### 特性配置 
##### 配置说明 
通过配置一个CPE套餐、（可选）配置最大活动小区数、配置CPE管控策略实现用户使用CPE设备的位置锁定功能。
RCP需要在EM中配置一个具有CPE属性的套餐，目的是通过用户签约套餐信息可以识别出CPE用户。 
（可选）如果需要修改最大活动小区数，RCP需要在EM客户端中修改全局开关1384的值，取值范围为1~18，实际配置时按照运营商需求修改取值。 
RCP需要使用CPE首次上线标识、归属CPE区域状态标识、在线时套餐生效或失效作为策略规则的控制条件。目的是识别出CPE用户的关键信息，从而控制带宽、发送通知提醒或者拒绝用户使用网络。 
##### 配置前提 
完成CPE套餐ID的规划。 
完成CPE锁位置功能的策略控制的规划。 
##### 配置过程 
图1  配置过程
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)
在EM客户端的配置页面中，执行如下配置过程。
1.     在EM客户端的配置页面，执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，新增一个具有CPE属性的套餐。
2.    （可选） 执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1384,CURVAL="XXX",EXTFLAG="ADVANCED"命令，修改最大活动小区个数。
3.    进入RCP策略管理页面，根据CPE策略规划进行配置。 
##### 配置实例 
####### 场景说明 
RCP根据配置的最大活动小区个数控制用户允许附着的4G小区的数目。RCP记录用户每次附着的4G小区的ECI，当用户附着的4G小区数目达到最大活动小区个数后，RCP控制用户只能在已经记录的4G小区附着。用户通过其他4G小区附着将被禁止使用网络。用户通过非4G小区附着网络时，RCP不进行控制。 
用户首次使用CPE使用网络，或者用户使用CPE从非优惠区域接入时，需要给用户发送提醒短信。内容分别为： 
“尊敬的客户您好，您的CPE优惠区域位置信息已经登记。在优惠区域内使用将按照CPE资费标准进行计费；超出优惠区域后，将限制您的上网功能，请知悉。” 
“尊敬的客户您好，您的CPE已经超出优惠区域范围，系统已经限制您的上网功能。当您回到优惠区域时，上网功能会自动恢复。” 
####### 数据规划 
网管配置数据规划类别参数取值套餐编号100套餐类型用户套餐是否为CPE套餐是CPE数据最大活动小区个数3 
策略配置数据规划策略类型规则名称动作会话控制策略RULE_SESS_CPE_PAK_100拒绝会话RULE_SESS_CPE_AREA控制带宽为512kbpsRULE_SESS_NOT_CPE_AREA拒绝会话通知策略RULE_NOTE_CPE_FIRST_ATTACH发送短信提醒用户位置已经登记RULE_NOTE_NOT_CPE_AREA发送短信提醒用户超出优惠区域 
####### 业务关系配置图 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB%E5%9B%BE.png)
####### 配置步骤 
配置基础信息 
套餐配置 
[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html):PKGID="100",PRIORITY=1,CPEFLAG="YES";
CPE数据配置 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1384,CURVAL="3",EXTFLAG="ADVANCED";
配置规则基础数据 
自定义变量配置 
自定义变量名称|策略变量|策略变量属性
---|---|---
CPE_PAK_100|在线时套餐生效或失效|属性|套餐标识
参考值|CPE_PAK_100|在线时套餐生效或失效|100
通知配置 
通知名称|参数|取值
---|---|---
NOTE_CPE_FIRST_ATTACH|通知语言|中文（中华人民共和国）
通知内容|NOTE_CPE_FIRST_ATTACH|尊敬的客户您好，您的CPE优惠区域位置信息已经登记。在优惠区域内使用将按照CPE资费标准进行计费；超出优惠区域后，将限制您的上网功能，请知悉。
NOTE_NOT_CPE_AREA|通知语言|中文（中华人民共和国）
通知内容|NOTE_NOT_CPE_AREA|尊敬的客户您好，您的CPE已经超出优惠区域范围，系统已经限制您的上网功能。当您回到优惠区域时，上网功能会自动恢复。
配置规则条件 
条件名称|参数|取值
---|---|---
COND_CPE_FIRST_ATTACH|策略变量类别|用户信息类
策略变量|COND_CPE_FIRST_ATTACH|CPE首次上线标识
操作符|COND_CPE_FIRST_ATTACH|=
参考值|COND_CPE_FIRST_ATTACH|是
COND_CPE_AREA|策略变量类别|用户信息类
策略变量|COND_CPE_AREA|归属CPE区域状态标识
操作符|COND_CPE_AREA|=
参考值|COND_CPE_AREA|在
COND_NOT_CPE_AREA|策略变量类别|用户信息类
策略变量|COND_NOT_CPE_AREA|归属CPE区域状态标识
操作符|COND_NOT_CPE_AREA|=
参考值|COND_NOT_CPE_AREA|不在
COND_CPE_PAK_100|策略变量类别|自定义策略变量
策略变量|COND_CPE_PAK_100|CPE_PAK_100
操作符|COND_CPE_PAK_100|=
参考值|COND_CPE_PAK_100|失效变为有效
配置规则动作参数 
通知策略动作参数 
动作参数名称|参数名称|取值
---|---|---
ACTION_NOTE_CPE_FIRST_ATTACH|参数类型|通知参数集
全局通知编号|ACTION_NOTE_CPE_FIRST_ATTACH|100
通知类型|ACTION_NOTE_CPE_FIRST_ATTACH|SMS/EMAIL
私人短信通知内容|ACTION_NOTE_CPE_FIRST_ATTACH|NOTE_CPE_FIRST_ATTACH
ACTION_NOTE_NOT_CPE_AREA|参数类型|通知参数集
全局通知编号|ACTION_NOTE_NOT_CPE_AREA|200
通知类型|ACTION_NOTE_NOT_CPE_AREA|SMS/EMAIL
私人短信通知内容|ACTION_NOTE_NOT_CPE_AREA|NOTE_NOT_CPE_AREA
会话控制策略动作参数 
动作参数名称|参数名称|取值
---|---|---
ACTION_SESS_CPE_AREA|参数类型|会话参数集
APN汇聚最大上行带宽|ACTION_SESS_CPE_AREA|512000
APN汇聚最大下行带宽|ACTION_SESS_CPE_AREA|512000
配置场景 
场景规则关联配置 
场景名称|参数|取值
---|---|---
CPE|入口1|入口类型|用户信息类
已选入口|CPE|入口1|用户套餐
取值|CPE|入口1|100
策略类型|CPE|通知策略|RULE_NOTE_CPE_FIRST_ATTACH
RULE_NOTE_NOT_CPE_AREA|策略类型|CPE|通知策略
会话控制策略|策略类型|CPE|RULE_SESS_NOT_CPE_AREA
RULE_SESS_CPE_AREA|会话控制策略|策略类型|CPE
RULE_SESS_CPE_PAK_100|会话控制策略|策略类型|CPE
通知策略规则 
规则名称|参数|取值
---|---|---
RULE_NOTE_CPE_FIRST_ATTACH|优先级|1
动作类型|RULE_NOTE_CPE_FIRST_ATTACH|立即发送
日志开关|RULE_NOTE_CPE_FIRST_ATTACH|关
条件表达式|RULE_NOTE_CPE_FIRST_ATTACH|COND_CPE_FIRST_ATTACH
动作参数名称|RULE_NOTE_CPE_FIRST_ATTACH|ACTION_NOTE_CPE_FIRST_ATTACH
RULE_NOTE_NOT_CPE_AREA|优先级|1
动作类型|RULE_NOTE_NOT_CPE_AREA|立即发送
日志开关|RULE_NOTE_NOT_CPE_AREA|关
条件表达式|RULE_NOTE_NOT_CPE_AREA|COND_NOT_CPE_AREA
动作参数名称|RULE_NOTE_NOT_CPE_AREA|ACTION_NOTE_NOT_CPE_AREA
会话控制策略规则 
规则名称|参数|取值
---|---|---
RULE_SESS_CPE_PAK_100|优先级|1
动作类型|RULE_SESS_CPE_PAK_100|拒绝
日志开关|RULE_SESS_CPE_PAK_100|关
条件表达式|RULE_SESS_CPE_PAK_100|COND_CPE_PAK_100
RULE_SESS_NOT_CPE_AREA|优先级|1
动作类型|RULE_SESS_NOT_CPE_AREA|拒绝
日志开关|RULE_SESS_NOT_CPE_AREA|关
条件表达式|RULE_SESS_NOT_CPE_AREA|COND_NOT_CPE_AREA
RULE_SESS_CPE_AREA|优先级|1
动作类型|RULE_SESS_CPE_AREA|参数填充
日志开关|RULE_SESS_CPE_AREA|关
条件表达式|RULE_SESS_CPE_AREA|COND_CPE_AREA
动作参数名称|RULE_SESS_CPE_AREA|ACTION_SESS_CPE_AREA
##### 测试用例 
测试条目|无基站拓扑信息时启用CPE锁位置功能
---|---
预置条件|RCP系统正常运行。前后台通讯正常。RCP和PCEF之间通讯正常。EM上按照配置实例的配置步骤进行配置。用户未签约CPE锁位置功能。
测试步骤|用户上线，其中CCR-I消息携带：3GPP-User-Location-Info填写810000000200ad01（ECI=33598721）。SPR返回用户的签约信息，UDA不携带CPE套餐100。SPR返回用户的动态信息中不包含ECI小区信息。SPR推送签约更新消息PNR，携带CPE套餐100。用户上线，其中CCR-I消息携带：3GPP-User-Location-Info填写810000000200ad01（ECI=33598721）。SPR返回用户的签约信息，UDA携带CPE套餐100。SPR返回用户的动态信息中包含ECI小区信息。用户位置切换，其中CCR-U消息携带：3GPP-User-Location-Info填写810000000200b501（ECI=33600769）。用户位置切换，其中CCR-U消息携带：3GPP-User-Location-Info填写810000000200b502（ECI=33600770）。用户位置切换，其中CCR-U消息携带：3GPP-User-Location-Info填写0121f354ffff3039（SAC=12345）。用户位置切换，其中CCR-U消息携带：3GPP-User-Location-Info填写810000000200b505（ECI=33600773）。
通过准则|用户在线期间开启CPE功能，RCP触发用户下线。由于用户上线的CCR-I消息中带了ECI小区信息，因此RCP自动对用户位置ECI=33598721进行登记，用户下线时向SPR报告当前ECI小区位置。用户再次上线成功，RCP下发带宽512kbps，并且向PCEF订阅ECGI-CHANGE变更事件。用户位置切换到ECI=33600769的ECI小区后可以正常使用网络。此时，用户的活动小区数目为2。用户位置切换到ECI=33600770的ECI小区后可以正常使用网络。此时，用户的活动小区数目为3。RCP认为用户通过非ECI小区接入时，都处在优惠区域内。因此，用户位置切换到SAC=12345的SAC小区后可以正常使用网络。此时，用户的活动小区数目为3。用户的活动小区数目已经超过运营商设定的最大活动小区个数。因此，用户位置切换到ECI=33600773的ECI小区后不可以使用网络。RCP触发用户下线，同时RCP发送提醒短信“尊敬的客户您好，您的CPE已经超出优惠区域范围，系统已经限制您的上网功能。当您回到优惠区域时，上网功能会自动恢复。”用户下线，RCP向SPR报告ECI小区信息。其中包括：用户的活动小区ECI列表，用户被拒绝接入网络的小区的ECI。
信令流程|信令流程

 
### 缩略语 
### 缩略语 
#### CCR-I 
Credit Control Request-Initial初始信用控制请求
#### CCR-U 
Credit Control Request-Update更新信用控制请求
#### CPE 
Customer Premises Equipment用户终端设备
#### ECGI 
E-UTRAN Cell Global IdentifierE-UTRAN小区全球标识
#### ECI 
E-UTRAN Cell IdentifierE-UTRAN小区标识
#### EM 
Element Management网元管理
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PNA 
Push-Notification-Answer推送通知响应
#### PNR 
Push-Notification-Request推送通知请求
#### RCP 
Resource Control Platform资源控制平台
#### SAC 
Service Area Code业务区码
#### SMSC 
Short Message Service Center短消息中心
#### SPR 
Subscription Profile Repository用户签约数据库
#### UDA 
User-Data-Answer用户数据响应
### ZUF-59-55-051 VoNR 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
VoNR|5G语音业务解决方案，使语音服务（控制和媒体层面）作为数据流在5G网络中传输，而不再需维护和依赖传统的电路交换语音网络。
VoLTE|LTE语音业务解决方案，使语音服务（控制和媒体层面）作为数据流在LTE网络中传输，而不再需维护和依赖传统的电路交换语音网络。
SRVCC|单一无线语音呼叫连续性解决方案，是3GPP提出的一种VoLTE/VoNR语音业务连续性方案，主要是为了解决当单射频UE从LTE/5G网络漫游到2G/3G CS网络时，如何保证语音呼叫连续性的问题，即保证单射频UE在IMS控制的VoIP语音和CS域语音之间的平滑切换，保持用户的通话不中断。
eSRVCC|增强的单一无线语音呼叫连续性解决方案，SRVCC的改进版本，与SRVCC相比，eSRVCC在保证语音呼叫连续性的同时，尽可能地减小了切换时延，将时延控制在人类所能感知的范围之内，使正在进行的通话不会感觉到有中断的迹象。
EPS fallback|指的是5G NR不提供语音业务，当支持EPS Fallback的终端发起呼叫或者接受呼叫需在NR上建立音视频承载时，触发终端的重定向或切换流程，回落至LTE网络，由LTE网络为终端提供音视频业务。
##### 描述 
####### 定义 
VoNR（Voice over New Radio，新空口承载语音）是5G网络的目标语音解决方案。RCP能够为VoNR呼叫提供QoS保障、为VoNR紧急呼叫提供优先接入、支持P-CSCF查询用户位置和订阅承载事件通知，支持计费关联、P-CSCF容灾增强相关流程，同时也支持EPS Fallback流程。
####### 背景知识 
从4G LTE开始，语音实现方案就不再仅仅是2G/3G网络，单纯通过电路域网络提供如语音业务和其他增值业务，而是设计通过IMS实现将语音业务承载在IP网络，也即VoLTE的方式，实现将2G/3G电路域所有业务在4G网络全部IP化。4G网络的逐步部署扩展过程中，出于对网络发展的不同阶段及对语音业务连续性的考虑，4G还提出了如CSFB及SRVCC等过渡方案。
5G NR语音方案设计，延续了4G LTE通过IP网络承载语音业务的方式，通过5G网络（无线网+核心网）和IMS系统承载语音业务，该种方式称为VoNR。
同样地，考虑到5G不同阶段部署规模不同，而4G网络已经广泛部署并可能在未来长期存在，以及对语音业务连续性保证的需求，回落方案设计也是十分必要的。因此EPS Fallback（演进的分组系统回落）方案也是5G语音方案的一种。EPS Fallback指的是5G NR不提供语音业务，当支持EPS Fallback的终端发起呼叫或者接受呼叫需在NR上建立音视频承载时，触发终端的重定向或切换流程，回落至LTE网络，由LTE网络为终端提供音视频业务。 
针对家庭宽带用户场景，采用ePDG的VoWiFi方案来提供语音/短信业务。采用ePDG基于本地地址和端口号向固网AAA/溯源系统查询对应的家庭网关其VoWiFi业务可用性并获取用户位置信息，将其与本地地址和端口号传递给移动核心网与IMS网络，来实现VoWiFi用户基于精准定位的紧急呼叫与安全溯源。 
##### 应用场景 
资源预留和QoS保障当UE发起VoNR呼叫时，P-CSCF向RCP请求建立Rx会话，携带UE IP及VoNR通话相关媒体信息。RCP根据UE IP将Rx会话绑定到N7会话，根据P-CSCF提供的VoNR媒体信息，决策生成相关的PCC规则下发给SMF，触发SMF和UE间建立专有QoS流，为VoNR媒体传输提供QoS保障，以保障VoNR呼叫接通后的通话质量。 
紧急呼叫对于紧急呼叫，RCP不仅能进行资源预留，还能提供优先接入。RCP通过调整ARP优先级，赋予紧急呼叫相关承载较高的抢占优先级，使得紧急呼叫在无线网络拥塞的情况下可以抢占普通呼叫或其他低优先级业务的承载资源。 
位置查询和事件订阅AF可以向RCP查询用户当前位置，RCP收到位置查询后，向SMF查询用户当前位置，这有助于实现VoNR呼叫用户位置跟踪。AF还可以向RCP订阅计费关联、资源分配成功通知等事件，RCP可以将事件订阅传递给SMF，当SMF上报相关事件时，RCP再传递给AF。 
协助实现SRVCC/eSRVCC流程当正在通话的VoNR用户从5G切换到3G时（或从4G切换到3G时），如果网络支持SRVCC/eSRVCC，VoNR呼叫中的媒体流可能从PS域切换到3G CS域，这时SMF会释放之前为VoNR建立的专有QoS Flow。SMF能够通过RCP通知给AF承载释放原因PS_TO_CS _HANDOVER。对于这种失败原因，AF就不会中断VoNR呼叫，从而实现SRVCC/eSRVCC流程。 
协助实现EPS fallback流程当用户发起VoNR呼叫时，AF触发RCP为VoNR媒体流下发PCC规则给SMF，SMF创建专有QoS Flow。如果5G NR不支持VoNR，专有QoS flow会建立失败，引发UE回落4G，SMF在4G上建立专载成功，用户在4G可以使用语音业务。 
协助实现P-CSCF容灾增强在P-CSCF容灾增强场景中，当某个P-CSCF发生故障后，备用P-CSCF会给RCP发送一个特殊的AAR消息指示P-CSCF发生容灾切换。RCP收到上述AAR后，给PCEF下发RAR消息，指示P-CSCF发生容灾切换。PCEF收到此RAR后，触发用户下线，重新接入网络并向IMS注册。 
VoWiFi位置查询用户使用VoWiFi业务时，为了在应用侧进行用户位置查询，AF可以向RCP查询用户当前位置，RCP通过SMF向ePDG查询用户位置。ePDG基于UE本地IP和端口号向固网溯源系统查询对应的家庭网关及其VoWiFi业务可用性并获取用户位置信息，将用户位置与UE本地IP和端口号传递给移动核心网与IMS网络，来实现VoWiFi用户基于精准定位的紧急呼叫与安全溯源。 
5G新通话在VoNR功能的基础上，叠加了智能翻译、趣味通话、内容分享、屏幕共享、发送红包等新业务的功能。智能翻译业务包括语音转文字、翻译字幕显示、中英互译等功能。趣味通话业务包括背景替换、虚拟头像替换、语音表情雨、手势动效等功能。为了保障用户在使用5G新通话功能时能够充分利用无线资源，PCF根据5G新通话媒体的时延和丢包率映射不同5QI（试商用阶段以AFAI映射5QI），为5G新通话媒体下发相应的业务规则，建立专有承载保障新通话功能。 
##### 客户收益 
受益方|受益描述
---|---
运营商|VoNR呼叫能够获得QoS保障，提升用户通话体验。VoNR紧急呼叫在网络拥塞时能优先接入。支持EPS Fallback流程，在5G网络不支持VoNR时，用户可以回落到LTE网络，由LTE网络为用户提供语音业务。支持对VoNR呼叫用户进行位置跟踪。支持P-CSCF容灾增强流程，提升VoNR可靠性。
用户|用户可以享受VoNR通话的优质语音和视频业务。用户使用VoNR紧急呼叫，在网络拥塞时能够优先接入。在5G网络不支持VoNR时，语音业务可以回落到LTE网络。

##### 实现原理 

###### 系统架构 
本特性涉及的系统架构如[图1](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newb95e3b65745c497eb48e9a2c7a17f76b__51483699-1d70-4145-908d-46c8e3a1093f)所示。RCP作为PCF，在VoNR流程中主要和AF（P-CSCF）、BSF、SMF发生交互。
图1  系统架构
[]images/5GC%E7%89%B9%E6%80%A7-%E6%9E%B6%E6%9E%84%E5%9B%BE-PCF.png)
###### 涉及的网元 
网元|说明
---|---
RCP|作为PCF，根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向RCP提供UE接入信息，从RCP获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向RCP提供PDU会话信息，从RCP获取PDU会话控制策略，下发给UPF执行。
UPF|对用户面数据报文执行SMF下发的PDU会话控制策略。
AF|向RCP提供应用层的业务信息，请求RCP进行策略授权。例如对于VoNR业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给RCP。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|RCP收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和RCP的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的RCP。
UDR/SPR|向RCP提供用户的策略签约信息，并允许RCP将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向RCP提供消费门限信息，例如告诉RCP某用户的月累计流量是否超过了特定门限。
###### 业务流程 
######## VoNR用户上线 
图2  VoNR用户上线流程
[]images/image4.png)
VoNR用户上线后才能执行IMS注册、呼叫等操作。VoNR用户上线流程如下：
UE和SMF建立PDU会话，SMF为PDU会话向RCP请求SM策略控制，为此SMF向RCP发送Npcf_SMPolicyControl_Create请求（以下简称Create请求）消息，请求RCP建立SM策略关联，请求消息主要包含：
supi：签约用户永久标识（SUPI），例如IMSI。 
gpsi：一般公共签约用户标识（GPSI），例如MSISDN。 
pei：永久设备标识（PEI），例如IMEISV。 
pduSessionId：PDU会话标识，SUPI+PDU会话标识唯一确定一个PDU会话。 
dnn：数据网名称（DNN），等同于EPC中的APN。 
sliceInfo：切片信息，其中包含单个网络切片选择辅助信息（S-NSSAI）。 
notificationUri：通知URI，即SMF后续接收RCP为该SM策略关联下发的SM策略更新通知请求（SMPolicyControl UpdateNotify request）的URI地址。 
subsSessAmbr：签约的会话聚合带宽（Subscribed Session AMBR）。 
subsDefQos：签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp。 
其中，DNN为IMS专用DNN或紧急呼叫专用DNN，如果是IMS专用DNN，则必须携带SUPI，一般也会携带GPSI；如果是紧急呼叫专用DNN，则请求消息中可以不携带SUPI和GPSI，但必须要携带PEI。SMF在Create请求中一般不包含UEIP地址信息。
RCP进行策略决策，向SMF发送Npcf_SMPolicyControl_Create响应，响应消息主要包含： 
location：即HTTP消息头域的location字段，格式为{authority}/npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}，例如：http://[2409:8069:5003:803::2:121]:80/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f.。其中smPolicyId为RCP根据supi+pduSessionId+时间戳等信息生成的SM策略关联ID，唯一定位SMF和RCP间的一个SM策略关联（即一个N7会话）。 
sessRules：会话规则集，在VoNR场景PCF通常只下发一个会话规则，其中包含授权的会话聚合带宽（Authorizeded Session AMBR）和授权的缺省QoS（AuthorizedDefault
QoS）。对VoNR业务来说，RCP一般按Create请求消息中的Subscribed Session AMBR和Subscribed
Default QoS来填写这两个参数。Default QoS应用于缺省QoS Flow。在VoNR业务中，缺省QoS Flow用于IMS信令传输，其5QI取值通常是5。 
SMF收到Create响应后，为UE分配IP地址，再通过Npcf_SMPolicyControl_Update请求（以下简称Update请求）向RCP上报UE
IP地址，Update请求中主要包含： 
ipv4Address/ipv6AddressPrefix：用户IPv4地址或IPv6地址前缀，VoNR通常用IPv6地址前缀。 
ipDomain：IP地址域（可选），IPv4地址池重复时，ipDomain+ipv4Address可以唯一定位一个IPv4地址。 
policyCtrlReqTriggers：其中包含IP地址改变（UE_IP_CH）事件。 
RCP向BSF注册N7会话绑定信息，即N7会话和RCP的关联信息。RCP记录下UE IP地址信息后，向BSF发送Nbsf_Management_Register请求，请求包含如下关键参数： 
ipv4Address/ipv6AddressPrefix：携带相关N7会话的用户IPv4地址和/或IPv6地址前缀。 
dnn：携带相关N7会话的dnn。 
snssai：携带相关N7会话的snssai。 
pcfDiamHost/pcfDiamRealm：RCP在Rx接口的Diameter主机名和域名。 
supi：携带相关N7会话的supi。 
gpsi：携带相关N7会话的gpsi。 
ipDomain：携带相关N7会话的ipDomain。 
pcfId：PCF标识。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP收到BSF回复的Nbsf_Management_Register响应后，向SMF回复Npcf_SMPolicyControl_Update响应。 
######## P-CSCF寻址RCP 
图3  P-CSCF寻址RCP流程
[]images/image5.png)
在VoNR流程中，AF（P-CSCF）寻址RCP的流程如下：
AF收到IMS用户注册请求或新的呼叫请求，构造Rx接口的AAR消息发送给DRA，AAR消息中的如下信息可用于DRA寻址RCP。
Destination-Realm：目标域名 
Framed-IPv4-Address/Framed-IPv6-Prefix：用户IPv4地址或IPv6地址前缀 
DRA（需改造升级BSF接口）收到AAR消息，如果在本地找不到对应的Gx会话绑定信息，则向BSF查询N7会话绑定信息（如果DRA本地未配置BSF地址，则在向BSF发起查询前，先要通过NRF发现BSF，这里不再详述），DRA向BSF发送Nbsf_Management_Discovery请求。请求中必须包含用户IP地址，可选包含GPSI、DNN、IP地址域等参数。
BSF查询到RCP注册的N7会话绑定信息，使用Nbsf_Management_Discovery响应向DRA提供该绑定信息。 
DRA（假设是Proxy模式）从绑定信息中读取RCP在Rx接口的Diameter主机名和域名，将AAR请求发送到对应的RCP。 
RCP处理AAR消息，回复AAA消息。
DRA转发AAA消息给AF。 
 说明： 
如果运营商不改造现网DRA支持BSF查询，而是引入融合BSF/DRA，现网DRA将Rx请求发送给融合BSF/DRA，这时上述流程图中DRA和BSF间的流程为融合BSF/DRA的内部流程，融合BSF/DRA以Proxy或Redirect方式转发Rx请求到RCP。 
######## P-CSCF订阅信令路径事件 
图4  P-CSCF订阅信令路径事件流程
[]images/image6.png)
AF（P-CSCF）订阅信令路径事件是一个可选流程，流程如下： 
在AF（P-CSCF）收到IMS注册请求时，AF可以向RCP发送AAR请求，创建一个新的Rx会话（这里称为信令Rx会话，在VoNR呼叫时P-CSCF会发起另一个Rx会话，称之为媒体Rx会话），在此Rx会话内订阅信令路径事件，AAR消息中包含： 
Framed-IPv4-Address/Framed-IPv6-Prefix：用户IPv4地址或IPv6地址前缀。 
Media-Component-Description：媒体组件信息，其中媒体组件编号（Media-Component-Number）和子组件编号（Flow-Number）取值都是0，可选携带信令流的流描述（Flow-Description）、流用途（Flow-Usage）置为AF_SIGNALLING。实际部署中，AF也可能不提供任何媒体组件信息。 
Specific-Action：订阅事件信息，可订阅的事件包括IP-CAN改变（IP-CAN_CHANGE）、运营商改变（PLMN_CHANGE）、承载丢失（INDICATION_OF_LOSS_OF_BEARER）、承载恢复（INDICATION_OF_RECOVERY_OF_BEARER）、承载释放（INDICATION_OF_RELEASE_OF_BEARER）、接入网信息查询（ACCESS_NETWORK_INFO_REPORT）。 
 说明： 
在AF提供媒体组件编号为0的媒体组件信息时，RCP要求AF必须订阅承载丢失或承载释放事件，以符合协议流程，否则对AAR回复失败。 
Rx接口的承载丢失和承载恢复事件在Gx接口有对应的事件（用于指示2/3G承载带宽降为0或从0恢复），但在N7接口没有对应的事件。如果AF订阅了这两个事件，RCP在N7接口没有相应的事件订阅，也不会上报这两个事件给AF。 
Rx接口的承载释放事件在Gx/N7接口没有对应的事件，如果AF在信令Rx会话订阅了这个事件，当对应的Gx/N7会话异常释放，且RCP的全局开关1127（专载更新失败时通知AF的方式）配置为“1-使用RAR通知”，则RCP会发送Rx RAR消息给AF，上报承载释放事件。 
RCP根据AAR消息提供的用户IP地址绑定N7会话，绑定成功后记录下AAR提供的媒体信息和事件订阅。如果AF提供了信令流的流描述（其中包含P-CSCF和UE通信的IP地址），RCP构造相应的PCC规则并通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF，PCC规则中包含了AF提供的信令流的流描述，这样SMF就可以从中解析出P-CSCF的IP地址。进一步SMF可以监测P-CSCF可达性，在P-CSCF宕机时，通知UE重选P-CSCF。 
如果AF订阅了IP-CAN_CHANGE或PLMN_CHANGE或ACCESS_NETWORK_INFO_REPORT事件，RCP也会在Npcf_SMPolicyControl_UpdateNotify请求中向SMF订阅对应的事件，事件订阅关系如下：Rx接口的IP-CAN_CHANGE事件对应N7接口的AC_TY_CH和RAT_TY_CH事件。Rx接口的PLMN_CHANGE事件对应N7接口的PLMN_CH事件。Rx接口的ACCESS_NETWORK_INFO_REPORT事件对应N7接口的AN_INFO事件。 
如果AF订阅了ACCESS_NETWORK_INFO_REPORT事件，但没有提供信令流的流描述，则RCP需要事先配置假媒体，才可以进行位置查询事件的下发，具体如下：在“AF应用标识映射配置”中添加配置，将“AF应用标识”取值“default”映射到某个“应用标识”取值。对该“应用标识”取值“default”，在“业务流特征配置”中配置业务流信息（其中服务端IP/Port可以通配），用于生成PCC规则中的流描述。在策略配置中，对该“应用标识”取值“default”，配置相应的PCC规则。 
SMF回复Npcf_SMPolicyControl_UpdateNotify响应。如果PCF在之前的UpdateNotify请求中订阅了AC_TY_CH和RAT_TY_CH事件，则SMF在Npcf_SMPolicyControl_UpdateNotify响应中包含最新的accessType和ratType。如果PCF在之前的UpdateNotify请求中订阅了PLMN_CH事件，则SMF在Npcf_SMPolicyControl_UpdateNotify响应中包含最新的servingNetwork。 
RCP向AF回复AAA消息。如果第2步中Rx/N7会话绑定失败，或第2/3步RCP和SMF交互失败（Npcf_SMPolicyControl_UpdateNotify请求发送失败、收到Npcf_SMPolicyControl_UpdateNotify失败响应、Npcf_SMPolicyControl_UpdateNotify响应超时），则AAA携带失败码5065（IP-CAN_SESSION_NOT_AVAILABLE）。 
如果AF在AAR中订阅了IP-CAN改变（IP-CAN_CHANGE）事件，且相关流程成功，则AAA中包含RCP最新获取的IP-CAN类型（IP-CAN-Type）和接入方式（RAT-Type）。 
如果AF在AAR中订阅了运营商改变（PLMN_CHANGE）事件，且相关流程成功，则AAA中包含RCP最新获取的运营商标识（3GPP-SGSN-MCC-MNC）。 
如果订阅的事件发生，SMF使用Npcf_SMPolicyControl_Update请求通知RCP。 
如果AF订阅了ACCESS_NETWORK_INFO_REPORT事件，使得RCP向SMF订阅AN_INFO事件，SMF获得接入网提供的用户位置信息后立即通知RCP，RCP再通知AF。此类事件订阅为一次性事件订阅，SMF/RCP上报该类事件通知后，即使用户位置变化，也不再上报。如果AF关注最新用户位置，需要再次订阅该类事件。 
其他类型的事件订阅则是在订阅后一直生效，只要订阅的事件发生就上报（例如AF订阅的IP-CAN_CHANGE事件，订阅后一直有效，RCP感知IP-CAN-Type/RAT-Type改变就得上报给AF，除非AF取消订阅或AF会话结束）。 
RCP回复Npcf_SMPolicyControl_Update响应。 
RCP向AF发送RAR，通知相应事件发生。 
AF回复RAA消息。 
######## VoNR业务基本授权 
图5  VoNR业务基本授权流程
[]images/image7.png)
VoNR用户上线后，当发起VoNR呼叫时，AF（P-CSCF）向RCP请求业务授权，流程如下： 
用户在IMS DNN上的N7会话建立成功后，AF向RCP发送AAR消息，AAR中包含： 
Framed-IPv4-Address/Framed-IPv6-Prefix：用户IPv4地址或IPv6地址前缀。 
Media-Component-Description：媒体组件信息，VoNR的每条媒体流（音频/视频）构造一条媒体组件信息。 
Specific-Action：订阅事件信息，包含若干个订阅事件，例如P-CSCF可以向RCP订阅资源分配成功事件（INDICATION_OF_SUCCESSFUL_RESOURCES_ALLOCATION），当媒体流资源分配成功后，RCP要通知P-CSCF资源分配成功事件。 
RCP根据AAR消息提供的用户IP地址绑定N7会话，若绑定失败，直接跳到第4步。若绑定成功，存储AF会话、媒体等信息，回复AAA消息。 
RCP对VoNR业务进行决策，构造PCC规则，通过绑定N7会话的Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。PCC规则里通常携带如下信息： 
pccRuleId：PCC规则ID 
refQoSData：PCC规则引用的QoS数据 
flowInfos：流信息 
precedence：规则优先级 
如果AF在AAR中提供了事件订阅，RCP给SMF也下发对应的事件订阅及相应信息。例如当AF订阅了INDICATION_OF_SUCCESSFUL_RESOURCES_ALLOCATION时，RCP在Npcf_SMPolicyControl_UpdateNotify的policyCtrlReqTriggers中包含SUCC_RES_ALLO事件订阅，还在lastReqRuleData的refPccRuleId中指示相关的PCC规则ID，并在lastReqRuleData的中reqData中指示该PCC规则订阅SUCC_RES_ALLO事件。 
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow建立。 
RCP向AF回复AAA消息。如果第2步中Rx/N7会话绑定失败，或第2/3步RCP和SMF交互失败（Npcf_SMPolicyControl_UpdateNotify请求发送失败、收到Npcf_SMPolicyControl_UpdateNotify失败响应，或Npcf_SMPolicyControl_UpdateNotify响应超时），则AAA携带失败码5065（IP-CAN_SESSION_NOT_AVAILABLE）。 
专有QoS Flow建立成功，若之前收到RCP的SUCC_RES_ALLO事件订阅，SMF通过Npcf_SMPolicyControl_Update请求上报给RCP，携带policyCtrlReqTriggers，其中包含SUCC_RES_ALLO事件，并携带ruleReports指示资源分配成功的PCC规则ID。 
RCP回复Npcf_SMPolicyControl_Update响应。 
RCP向P-CSCF发送RAR消息，携带Specific-Action指示SUCCESSFUL_RESOURCES_ALLOCATION，并携带Flows指示受影响的媒体组件编号和子组件编号。 
P-CSCF返回AAA响应。 
######## VoNR业务授权取消 
图6  VoNR业务授权取消流程
[]images/image8.png)
当VoNR呼叫结束时，P-CSCF向RCP请求取消VoNR业务授权，步骤如下： 
AF会话建立后，用户可以正常使用VoLTE业务。当用户停止使用VoLTE业务时，触发AF向RCP发送STR消息释放AF会话。STR中应携带AF会话的SessionID。
RCP校验STR请求，根据SessionID查找到AF会话，删除并发送成功STA响应至AF。
RCP检查出需要删除的VoNR业务，将相应的PCC规则通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF指示删除，相应的PCC规则ID置为NULL，并取消AF相关的事件订阅。 
SMF触发专有承载释放，并返回Npcf_SMPolicyControl_UpdateNotify响应。 
######## VoNR用户位置查询 
图7  VoNR用户位置查询流程
[]images/image9.png)
在VoNR呼叫的业务授权或授权取消过程中，AF可以同时查询用户实时位置。实现方式为：AF向RCP订阅ACCESS_NETWORK_INFO_REPORT事件，使得RCP向SMF订阅AN_INFO事件，SMF获得接入网提供的用户位置信息后立即通知RCP，RCP再通知AF。此类事件订阅为一次性事件订阅，SMF/RCP上报该类事件通知后，即使用户位置变化，也不再上报。如果AF关注最新用户位置，需要再次订阅该类事件。具体流程如下： 
N7会话建立后，用户使用VoNR业务时，触发AF向RCP发送AAR消息建立AF会话。AAR中携带媒体信息（Media-Component-Description）等。若需要查询用户接入网信息时，还应该携带： 
Specific-Action：订阅事件信息，在此流程中包含ACCESS_NETWORK_INFO_REPORT事件。 
Required-Access-Info：置为USER_LOCATION或MS_TIME_ZONE，表示查询用户位置还是用户所在时区信息。 
RCP校验AAR请求，根据IP等信息绑定N7会话。若绑定成功，存储AF会话、媒体等信息。RCP对VoNR业务进行策略决策，构造PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF，请求中还携带policyCtrlReqTriggers，其中包含AN_INFO事件订阅，还在lastReqRuleData的refPccRuleId中指示相关的PCC规则ID，并在lastReqRuleData的中reqData中指示该PCC规则是查询用户所在时区（当reqData取值为MS_TIME_ZONE时）还是用户所在位置（当reqData取值为USER_LOC_INFO时）。 
如果AF订阅了ACCESS_NETWORK_INFO_REPORT事件，但没有提供信令流的流描述，则RCP需要事先在“AF应用标识映射配置”中添加配置。将“AF应用标识”取值 “default”映射到某个“应用标识”取值，并对该“应用标识”取值在“业务流特征配置”中配置业务流信息（其中服务端IP/Port可以通配），用于生成PCC规则中的流描述，并在策略配置中对该“应用标识”取值配置相应的PCC规则，才可以进行位置查询事件的下发。 
SMF校验规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow建立，以便查询用户最新的接入网信息。 
RCP向AF回复AAA消息。如果第2步中Rx/N7会话绑定失败，或第2/3步RCP和SMF交互失败（Npcf_SMPolicyControl_UpdateNotify请求发送失败、收到Npcf_SMPolicyControl_UpdateNotify失败响应，或Npcf_SMPolicyControl_UpdateNotify响应超时），则AAA携带失败码5065（IP-CAN_SESSION_NOT_AVAILABLE）。 
专有QoS Flow建立成功后，接入网上报用户的位置或时区信息，触发SMF通过Npcf_SMPolicyControl_Update请求上报给RCP，其中携带： 
policyCtrlReqTriggers：订阅事件列表，在此流程中包含 AN_INFO事件。 
若RCP查询的是位置信息，则需要上报用户位置（userLocationInfo）和SMF得到用户位置的时间戳（userLocationInfoTime），如果SMF未得到用户位置信息，则上报接入网运营商标识（servingNetwork）。 
若RCP查询的是时区信息，则需要上报ueTimeZone。 
RCP回复成功Npcf_SMPolicyControl_Update响应。 
RCP更新用户位置或时区信息，并通过Rx-RAR上报给AF，其中携带： 
Specific-Action：订阅事件信息，在此流程中包含ACCESS_NETWORK_INFO_REPORT。 
若AF查询的是位置信息，则需要上报3GPP-User-Location-Info、User-Location-Info-Time，都不存在时上报3GPP-SGSN-MCC-MNC。 
若AF查询的是时区信息，则需要上报3GPP-MS-TimeZone。 
AF返回成功Rx-RAA响应。 
当用户停止使用VoNR业务时，触发AF发生Rx-STR释放会话。若需要再次查询用户接入网信息时，还应该携带： 
Required-Access-Info：置为USER_LOCATION或MS_TIME_ZONE，表示查询用户位置还是用户所在时区信息。 
RCP删除该AF会话关联的PCC规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF，请求中将相关PCC规则ID置为null，并携带policyCtrlReqTriggers和lastReqRuleData，填写方法和步骤3相同。 
SMF返回成功Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS Flow的释放，以及用户最新接入网信息的查询。 
专有承载释放后，上报用户的位置或时区信息，触发SMF通过Npcf_SMPolicyControl_Update请求上报给RCP，并携带接入网信息。 
RCP释放AF会话，给AF回复成功Rx-STA响应。并携带SMF上报的接入网信息。 
RCP给SMF回复成功的Npcf_SMPolicyControl_Update响应。 
######## (e)SRVCC切换 
图8  (e)SRVCC切换流程
[]images/image10.png)
和VoLTE类似，VoNR呼叫也支持(e)SRVCC切换流程，允许VoNR音频媒体流回落到3G电路域，但不支持VoNR视频媒体流回落，流程如下：
1.  N7会话建立后，用户使用VoNR业务时，触发AF向RCP发送AAR消息建立AF会话。AAR中携带媒体信息（Media-Component-Description）等。其中媒体可能为音频媒体（Media-Type
= AUDIO）或视频媒体（Media-Type = VIDEO）。 
2.  RCP校验AAR请求，根据IP等信息绑定IPCAN承载会话。若绑定成功，存储AF会话、媒体等信息。RCP对VoNR业务进行决策，构造PCC规则通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。音频流PCC规则的5QI应当设置为1（承载侧判断5QI=1的QoS Flow支持SRVCC切换），VoNR视频流目前还不支持SRVCC功能。 
3.  SMF校验规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow建立。 
4. RCP向AF回复AAA消息。 
VoNR的SRVCC切换分两种场景： 
场景a：4G切换到3G电路域，这时N7会话仍然保留 
5a.  SMF向RCP发送Npcf_SMPolicyControl_Update请求，其中ruleReport的failureCode指示PS_TO_CS_HAN。 
6a.  RCP回复Npcf_SMPolicyControl_Update响应。 
场景b：5G直接切换到3G电路域，这时N7会话不再保留 
5b.  SMF向RCP发送Npcf_SMPolicyControl_Delete请求，其中PduSessionRelCause指示PS_TO_CS_HO。 
6b.  RCP回复Npcf_SMPolicyControl_Delete响应。 
7.  RCP分析出失效规则影响到AF会话的所有媒体信息，通过Rx-ASR通知AF释放会话，并且携带Abort-Cause指示专有承载失效的原因是PS_TO_CS_HANDOVER。 
8.  AF返回成功Rx-ASA响应。 
9.  AF发送Rx-STR释放AF会话，但仍保持用户的呼叫。 
10.  RCP释放AF会话，给AF回复成功Rx-STA响应。 
######## P-CSCF容灾增强 
图9  P-CSCF容灾增强流程
[]images/image11.png)
和VoLTE类似，VoNR也支持P-CSCF容灾增强，流程如下： 
N7会话建立后，UE通过某个P-CSCF注册到IMS，之后如果该P-CSCF发生故障，UE发起呼叫时的SIP Invite消息会发到备用P-CSCF，备用P-CSCF没有该UE上下文，会向RCP发送AAR消息，携带如下信息： 
Rx-Request-Type：Rx请求类型，此流程中置为PCSCF_RESTORATION，表示P-CSCF发生了容灾切换。 
Auth-Session-State置为NO_STATE_MAINTAINED，表示该AF会话不需要保持状态。 
若备用P-CSCF无法获取到IP地址信息，则需要携带用户的IMSI及APN 信息。 
RCP回复成功AAA响应，并携带Auth-Session-State（NO_STATE_MAINTAINED），但不建立新的AF会话。 
RCP根据IP或IMSI和APN信息查找到所有的N7会话，静默删除这些会话绑定的AF会话（不发送Rx-ASR通知），并删除相关联的PCC规则，给SMF下发Npcf_SMPolicyControl_UpdateNotify请求，携带pcscfRestIndication，取值为TRUE，在该请求中还指示SMF删除相关PCC规则。 
SMF返回成功Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS Flow的释放。 
如果UE支持在一个PDU会话内重选P-CSCF，则SMF通知UE重选P-CSCF，否则SMF通过释放PDU会话触发UE重建PDU会话并重选P-CSCF。若PDU会话释放，则SMF发起N7会话释放流程，给RCP发送Npcf_SMPolicyControl_Delete请求。 
RCP释放N7会话，回复成功Npcf_SMPolicyControl_Delete响应。 
######## EPS回落 
图10  EPS回落流程
[]images/image12.png)
EPS回落（EPS Fallback）指的是5G NR不提供语音业务，当EPS Fallback终端发起呼叫或者接受呼叫需在NR上建立音视频承载时，触发终端的重定向或切换流程，回落至LTE网络，由VoLTE网络为终端提供音视频业务。流程如下： 
用户在IMS DNN上的N7会话建立成功后，AF向RCP发送AAR消息，AAR中包含： 
Framed-IPv4-Address/Framed-IPv6-Prefix：用户IPv4地址或IPv6地址前缀。 
Media-Component-Description：媒体组件信息，VoNR的每条媒体流（音频/视频）构造一条媒体组件信息。 
Specific-Action：订阅事件信息，通常包含IP接入网改变事件（IP-CAN_CHANGE）、接入网信息查询事件（ACCESS_NETWORK_INFO_REPORT），还可以包含EPS回落事件（EPS_FALLBACK）及其他事件。 
RCP根据AAR消息提供的用户IP地址绑定N7会话，若绑定成功，存储AF会话、媒体等信息。RCP对VoNR业务进行决策，构造PCC规则，通过绑定N7会话的Npcf_SMPolicyControl_UpdateNotify请求下发给SMF。如果AF在AAR中提供了事件订阅，RCP给SMF也下发对应的事件订阅及相应信息。例如： 
当AF订阅了IP接入网改变事件（IP-CAN_CHANGE）时，RCP在policyCtrlReqTriggers中包含AC_TY_CH和RAT_TY_CH事件，policyCtrlReqTriggers中的事件订阅是N7会话粒度的事件订阅。 
当AF订阅了接入网信息查询事件（ACCESS_NETWORK_INFO_REPORT）时，RCP在policyCtrlReqTriggers中包含AN_INFO事件。这个事件订阅要进一步说明订阅该事件的相关PCC规则，因此RCP还提供相关的lastReqRuleData参数，在lastReqRuleData的refPccRuleId中指示AF相关媒体流的PCC规则ID，并根据AF请求查询的接入网信息类型，在lastReqRuleData的中reqData中指示该PCC规则订阅用户位置信息（USER_LOC_INFO）或终端时区信息（MS_TIME_ZONE）。 
当AF订阅了EPS_FALLBACK时，RCP在policyCtrlReqTriggers中包含EPS_FALLBACK事件订阅。这个事件订阅要进一步说明订阅该事件的相关PCC规则，因此RCP还提供相关的lastReqRuleData参数，在lastReqRuleData的refPccRuleId中指示AF相关媒体流的PCC规则ID，并在lastReqRuleData的中reqData中指示该PCC规则订阅EPS_FALLBACK事件。 
SMF校验PCC规则信息通过，返回Npcf_SMPolicyControl_UpdateNotify响应，并触发专有QoS
Flow建立。 
RCP向AF回复AAA消息，如果AAR订阅了IP-CAN_CHANGE事件，或者这个Rx会话绑定的N7会话已订阅了AC_TY_CH或RAT_TY_CH事件，则AAA会返回IP-CAN-Type=3GPP-5GS，RAT-Type=NR（EPS回落前，用户是5G接入）。 
如果5G NR不支持语音业务，会拒绝专有QoS Flow建立，并指示SMF拒绝原因是因为要发起EPS回落。如果RCP之前已向SMF订阅EPS_FALLBACK事件，则SMF会立即上报EPS_FALLBACK事件给RCP，并携带ruleReports指示相关PCC规则ID，而且SMF可以同时携带userLocationInfo上报用户当前位置，此时用户当前位置还是5G位置。 
RCP回复Npcf_SMPolicyControl_Update响应。 
如果AF订阅了EPS_FALLBACK事件，则RCP通过Rx接口RAR消息向AF上报EPS_FALLBACK事件，如果第5步中SMF上报了用户当前位置，则RAR中携带3GPP-User-Location-Info上报用户当前位置。 
AF回复RAA消息。 
回落LTE后，SMF通过Npcf_SMPolicyControl_Update请求向RCP上报RAT_TY_CH事件，指示接入方式已切换到LTE。 
RCP回复Npcf_SMPolicyControl_Update响应。 
如果AF之前订阅了IP-CAN_CHANGE事件，RCP通过RAR消息上报IP-CAN_CHANGE事件，并携带IP-CAN-Type=3GPP-5GS，RAT-Type=EUTRAN，指示用户已切换到LTE接入。 
AF回复RAA消息。 
SMF在LTE上再次触发专载建立和用户位置查询，专载建立及yoghurt位置查询成功后，SMF通过Npcf_SMPolicyControl_Update请求向RCP上报用户最新位置（LTE接入下的位置），请求中携带policyCtrlReqTriggers，其中包含AN_INFO事件，并携带ruleReports指示相关PCC规则ID，以及userLocationInfo指示用户最新位置。 
RCP回复Npcf_SMPolicyControl_Update响应。 
RCP向P-CSCF发送RAR消息，携带Specific-Action指示ACCESS_NETWORK_INFO_REPORT，并携带第13步SMF上报的用户最新位置。 
P-CSCF返回RAA响应。 
######## VoWiFi位置查询 
图11  VoWiFi位置查询
[]images/vowifi%E4%BD%8D%E7%BD%AE%E6%9F%A5%E8%AF%A2.png)
VoWiFi位置查询的流程如下： 
ePDG向SMF发起创建默认承载请求。 
SMF使用Npcf_SMPolicyControl_Create请求消息向RCP请求建立PDU会话，请求消息主要携带如下内容： 
accessType：NON_3GPP_ACCESS 
ratType：WLAN 
ueTimeZone：用户接入地的时间 
userLocationInfo->N3gaLocation->ueIpv4Addr/ueIpv6Addr：用户的本地地址 
userLocationInfo->N3gaLocation->portNumber：端口号 
userLocationInfo->N3gaLocation->twapId等信息：twapId等字段 
RCP收到请求后，存储RAT、UE本地地址、端口号、用户位置等VoWiFi信息。 
RCP基于签约信息和UE本地地址来判断是否允PDU会话建立，并进行默认承载决策授权，回复Npcf_SMPolicyControl_Create应答消息。 
SMF向ePDG回复创建默认承载应答。 
用户发起VoWiFi呼叫，AF向RCP发起查询用户接入网信息的流程，使用AAR-I消息发起Rx会话建立，AAR-I消息里携带： 
Specific-Action AVP：ACCESS_NETWORK_INFO_REPORT 
Required-Access-Info AVP：USER_LOCATION (0) 或MS_TIME_ZONE (1) 
Media-Component-Description APV：主被叫双方协商后的媒体信息 
RCP基于AAR携带的媒体信息进行策略决策授权，请求分配承载资源，并且要求SMF上报用户的接入网信息。策略更新通知Npcf_SMPolicyControl_UpdateNotify请求消息主要包括： 
policyCtrlReqTriggers：AN_INFO 
pccRules：pccRule1，携带授权的PCC规则 
lastReqRuleData：指示查询用户的接入网信息等参数 
SMF通过Npcf_SMPolicyControl_UpdateNotify应答消息回复RCP。 
RCP回复AAA消息允许IMS业务请求承载资源。 
SMF使用Npcf_SMPolicyControl_Update请求消息上报RCP用户的接入网信息。Npcf_SMPolicyControl_Update请求消息会携带以下信息： 
ueTimeZone：用户接入地的时间 
userLocationInfo->N3gaLocation->ueIpv4Addr/ueIpv6Addr：用户的本地地址 
userLocationInfo->N3gaLocation->portNumber：端口号 
userLocationInfo->N3gaLocation->twapId等信息：twapId等字段 
RCP收到SMF上报的接入网信息后，重新决策授权，并回复Npcf_SMPolicyControl_Update应答给SMF。 
RCP使用RAR消息通知用户的接入网信息，RAR消息包含以下内容： 
User-Location-Info-Time AVP：用户接入地的时间 
UE-Local-IP-Adress AVP：用户的本地地址 
TWAN-Identifier，规划的区域标识 
UDP-Source-Port，建立隧道为UDP时的端口号 
AF使用RAA消息回复RCP。 
用户发起VoWiFi呼叫终止请求，向RCP发起查询用户接入网信息的流程。STR消息发起Rx会话释放，消息里携带： 
Specific-Action AVP：ACCESS_NETWORK_INFO_REPORT 
Required-Access-Info AVP：USER_LOCATION (0) 或MS_TIME_ZONE (1) 
RCP删除之前基于该IMS会话下发的PCC规则，请求SMF释放承载资源，并且要求SMF上报用户的接入网信息。策略更新通知Npcf_SMPolicyControl_UpdateNotify请求消息主要包括： 
policyCtrlReqTriggers：AN_INFO 
pccRules：pccRule1为null，表示删除已授权的PCC规则 
lastReqRuleData：指示查询用户的接入网信息等参数 
SMF通过Npcf_SMPolicyControl_UpdateNotify应答消息回复RCP。 
SMF使用Npcf_SMPolicyControl_Update请求消息上报RCP用户的接入网信息。Npcf_SMPolicyControl_Update请求消息会携带以下信息： 
ueTimeZone：用户接入地的时间 
ueIpv4Addr/ueIpv6Addr：用户的本地地址 
portNumber：端口号 
userLocationInfo：用户位置，主要包括twapId等字段 
RCP收到SMF上报的接入网信息后，重新决策授权，并回复Npcf_SMPolicyControl_Update应答给SMF。 
RCP回复STA消息终止VoWiFi呼叫，并携带用户的接入网信息。STA消息包含以下内容： 
User-Location-Info-Time AVP：用户接入地的时间 
UE-Local-IP-Adress AVP：用户的本地地址 
TWAN-Identifier：规划的区域标识 
UDP-Source-Port：建立隧道为UDP时的端口号 
###### 本网元实现 
######## 业务授权 
业务授权是RCP针对AF会话的通用功能，不仅仅针对IMS业务，即使是数据业务也适用。当AF为某用户向RCP请求媒体信息时，RCP会根据每个媒体的AF应用标识、媒体类型、流用途、流方向等信息映射成一类业务标识；并针对此类业务流信息进行决策，同时结合AF提供的带宽等信息，构造PCC规则向SMF申请专有承载的建立或更新，从而对用户使用的VoNR业务进行差异化的QoS控制。
 说明： 
当用户从VoLTE APN接入时，RCP不会去获取签约信息，也不会根据签约信息进行决策。
######## 语音会话隔离 
语音会话通常只需要按AF（P-CSCF）请求来做策略决策，而不需要看用户在SPR是否有签约，不像数据会话那样涉及签约、用量、时段、位置等复杂多变的策略。另一方面，语音会话的可靠性要求比数据会话高的多，语音会话如果没有PCF，呼叫流程可能失败，而数据会话如果没有PCF，SMF还可以采用本地策略维持会话。目前很多运营商对语音会话和数据会话部署不同的PCF，减少相互间的影响，提升语音业务可靠性。即便语音会话和数据会话在同一个PCF处理，运营商也希望能够尽量减少相互间的影响。 
RCP有“IMS域APN配置”，可以配置语音会话所使用的IMS APN和紧急APN。配置了这些APN后，这些APN上的会话视为语音会话。RCP对语音会话不访问SPR和OCS/CHF，不会根据SPR用户签约检查AF请求的业务是否能够授权，基于用户签约、累计用量、OCS/CHF策略计数器状态的策略都不会对语音会话生效。此外，语音会话不使用默认上报事件订阅配置，如果语音会话有其特定的上报事件配置，需要使用语音APN在“上报事件配置”中做相应配置。 
######## 资源预留 
RCP可以在VoNR呼叫接通前为IMS呼叫的媒体流预先创建专有承载，以保障VoNR呼叫接通时的通话质量。 
VoNR呼叫在IMS域采用Offer/Answer模型协商媒体参数。通常主叫发送SDP Offer，其中包含主叫侧的媒体收发地址端口等信息；被叫回复SDP
Answer，其中包含被叫侧的媒体收发地址端口等信息。P-CSCF综合SDP Offer和SDP Answer的信息，才能确定最终的VoNR业务信息。P-CSCF可以在收到SDP
Offer或SDP Answer时向RCP请求资源预留，并使用Service-Info-Status指示提供的媒体信息是初始业务信息还是最终业务信息。
当UE发起VoNR呼叫时，P-CSCF向RCP请求建立Rx会话。RCP将Rx会话绑定到Gx会话，根据P-CSCF提供的IMS业务媒体信息，决策生成相关的PCC规则下发给SMF。RCP下发的音频承载规则的QCI一般设置为1，视频承载规则的QCI一般设置为2，这样可以触发SMF为IMS业务的音频和视频媒体分别创建专有承载。
由于专载建立过程涉及从SMF到UE间多个设备的信令交互，RCP下发PCC规则触发SMF创建专有承载时，SMF无法立即在RAA消息中报告资源预留结果。同理，RCP也无法在AAA消息中上报给AF资源预留结果。若P-CSCF关心资源预留是否成功，需要在AAR消息中订阅资源预留成功/失败事件，RCP也会向SMF订阅相关事件。后续当资源预留成功或失败时，SMF可以通知RCP，从而进一步通知P-CSCF。
######## 紧急呼叫 
RCP支持用户在紧急呼叫APN或普通IMS APN上发起紧急呼叫流程，并通过将紧急呼叫默认承载和专载规则的ARP优先级设置为1来提供优先接入。
RCP根据紧急呼叫APN配置判断用户是否是从紧急APN接入。 
若是紧急APN接入的PDU会话，RCP在会话建立时就可以将默认承载ARP设置为1。用户发起紧急呼叫时，RCP将相关媒体对应的专载规则ARP也设置为1。 
若是普通IMS APN接入的PDU会话，RCP可能在会话建立时将默认承载ARP设置为较低优先级。直到用户发起紧急呼叫，RCP再将默认承载APR调整为1，并在紧急呼叫结束后再恢复回去；对于紧急呼叫相关媒体对应的专载规则APR仍设置为1。RCP对用户发起的普通VoLTE呼叫则不调整默认承载ARP。 
P-CSCF会在Rx会话中使用特定的Service-URN（例如sos.fire）通知RCP，RCP则根据紧急呼叫Service-URN配置来识别用户是否使用紧急呼叫业务。若未携带特定的Service-URN，RCP则认为是普通呼叫。
RCP支持用户不插入SIM卡直接接入紧急APN，允许紧急呼叫APN上的PDU会话不携带SUPI和GPSI，但必须携带PEI信息。RCP会拒绝用户在紧急APN上发起普通呼叫业务。 
RCP支持用户从普通呼叫APN接入后使用紧急呼叫业务。 
######## 事件订阅和信息查询 
P-CSCF可以通过Specific-Action向RCP订阅一些事件、状态的变更和查询位置信息等。主要可实现如下几个功能： 
承载状态的通知当AF在AAR消息中向RCP订阅承载安装成功、失败、释放等事件时，RCP会发送Npcf_SMPolicyControl_UpdateNotify请求到SMF订阅这些事件。当SMF检测到承载相关事件发生时，将事件及受影响的PCC规则通知RCP。RCP分析受影响的媒体流编号后，将这些信息和承载状态通知给P-CSCF。特别的，对于承载释放事件，受影响的PCC规则将被RCP删除。若Rx会话的所有媒体流都受影响，RCP会给P-CSCF发送ASR并携带Release-Cause通知释放原因。 
网络切换P-CSCF可以向RCP订阅IP-CAN_CHANGE事件感知用户的网络切换行为。RCP收到此事件后，会在响应消息中立即上报IP-CAN-Type和RAT-Type。后续用户发生网络切换SMF上报新的接入信息时，RCP构造Rx-RAR消息将IP-CAN_CHANGE事件和最新的IP-CAN-Type、RAT-Type上报给P-CSCF。 
位置查询用户发起VoNR呼叫时，P-CSCF可能关心主叫方或被叫方的具体位置，则会向RCP请求资源预留的同时也请求查询用户位置。RCP收到位置查询请求后，通过在lastReqRuleData中携带关联规则ID（refPccRuleId）对应的查询类型，指示该PCC规则是查询用户所在时区（当reqData取值为MS_TIME_ZONE时）还是用户所在位置（当reqData取值为USER_LOC_INFO时），以及携带会话订阅事件（AN_INFO）向SMF请求查询用户位置。当SMF在资源预留过程中获得用户当前位置信息时，则通过RCP上报给P-CSCF。P-CSCF可以请求查询用户的具体位置和/或所在时区。如果P-CSCF查询用户具体位置，对于VoNR的会话，RCP会提供3GPP-User-Location-Info、User-Location-Info-Time、3GPP-SGSN-MCC-MNC；对于VoWiFi的会话，RCP会提供UE-Local-IP-Address。如果P-CSCF查询用户所在时区，RCP会提供3GPP-MS-TimeZone。P-CSCF发起的用户位置查询流程与其他事件有所区别，位置查询是一次性的。在P-CSCF获得用户位置后，如果用户位置发生了变化，SMF不会主动通过RCP再次上报。如果P-CSCF想获取用户最新位置信息，可以再次发起位置查询流程。 
计费关联IMS会为每次呼叫动态生成一个ICID（IMS Charging ID，IMS计费标识），当P-CSCF为VoNR呼叫向RCP请求资源授权时，请求中可同时携带了该次呼叫的ICID（包含在AF-Charging-Identifier参数中），并订阅计费关联事件（Specific-Action参数中包含CHARGING_CORRELATION_EXCHANGE事件），RCP则在PCC规则中将ICID下发给SMF，并向SMF订阅计费关联事件。在资源授权成功后，SMF为每个QoS Flow动态生成一个接入网计费标识。当RCP订阅了计费关联事件时，SMF会通过N7接口将接入网计费标识（包含在accNetChaId参数中）和接入网计费地址（包含在chargEntityAddr参数中）上报给RCP，RCP进一步上报给P-CSCF，使得IMS和SMF产生的话单中都可以包含IMS计费标识、接入网计费标识、接入网计费地址。 
协助实现(e)SRVCC流程借用事件订阅和通知流程，RCP可协助实现AF音频媒体的SRVCC流程，允许用户正在通话的VoNR音频媒体流回落到3G电路域，但不支持VoNR视频媒体流回落。当用户从4G切换到3G电路域时，SMF会释放之前为VoNR媒体建立的专有承载，并给RCP上报承载规则失效，携带failureCode为PS_TO_CS_HAN。当用户从5G切换到3G电路域时，SMF会释放PDU会话，携带PduSessionRelCause指示PS_TO_CS_HO。RCP分析出所有受影响的媒体组件，可能给AF发送通知或释放请求：若AF会话只有部分媒体受影响，RCP使用Rx-RAR消息通知AF受影响的媒体流编号，及原因码为PS_TO_CS_HANDOVER。若AF会话的全部媒体受影响，RCP使用Rx-ASR消息通知AF释放会话，仍携带原因码为PS_TO_CS_HANDOVER。对于这种失败原因，AF则不会中断VoLTE呼叫，从而实现SRVCC切换流程。其他失败原因则可能导致AF中止VoLTE呼叫。 
######## 协助实现P-CSCF容灾增强功能 
当某个P-CSCF发生故障后，发给这个P-CSCF的SIP
INVITE消息会被转发到备用P-CSCF。备用P-CSCF由于未处理过该用户的SIP注册消息，感知到主用P-CSCF发生了故障，于是构造一个特殊的AAR消息发送给RCP，指示P-CSCF发生容灾切换。但备用P-CSCF可能无法获得该用户的IP地址，则需要在消息中携带用户的IMSI信息（从HSS获取）及APN信息。
RCP收到AAR请求后，通过消息中的Rx-Request-Type = PCSCF_RESTORATION（2）识别出是指示P-CSCF发生容灾切换的AAR消息： 
若AAR消息携带了IP地址信息，则通过IP+IP-Domain-ID/APN（可选）查找到用户的N7会话。 
若AAR消息未携带IP地址信息，则通过IMSI+APN（可选）查找到用户的所有会话。 
查找N7会话成功后，RCP删除N7会话所有和关联AF会话相关的承载规则，通过Npcf_SMPolicyControl_UpdateNotify请求下发给SMF，并携带pcscfRestIndication指示P-CSCF发生了容灾切换。SMF收到指示后，发起N7会话释放流程，并使用户下线。之后用户重新接入网络并向IMS注册。 
特别的，对于指示容灾切换的AAR消息，无论是否携带了Auth-Session-State = NO_STATE_MAINTAINED(1)，RCP都不会为其建立AF会话，当成一次通知消息处理。 
######## 授权响应方式 
授权响应方式指的是RCP收到AAR/STR请求后，是先回复AAA/STA再和SMF/PGW交互，还是等和SMF/PGW交互后才回复AAA/STA，可以通过“AF能力配置”的“授权响应方式”进行配置，该字段各取值含义如下： 
0（立即响应）：RCP收到AAR/STR请求后，先回复AAA/STA，再和SMF/PGW交互。 
1（等承载确认后响应）：RCP收到AAR/STR请求后，先和SMF/PGW交互，再回复AAA/STA。 
2（仅IMS AF会话建立请求等承载确认后响应）：RCP仅对语音会话初始AAR，先和SMF/PGW交互，再回复AAA/STA。其它场景，先回复AAA/STA，再和SMF/PGW交互。 
该字段的取值2是RCP V7.22.20版本引入的，且此版本后该字段的默认值从取值0调整到取值2（存量配置的此字段若取值0，升级时通过网管脚本自动调整为取值2）。使用取值2的好处： 
P-CSCF通常要在初始AAR中订阅IP-CAN_CHANGE事件，并且需要获取初始AAA提供的IP-CAN-Type和RAT-Type。RCP对初始AAR和SMF/PGW交互完后再回复初始AAA，可以从SMF/PGW获得最新的IP-CAN-Type和RAT-Type并在初始AAA中上报给P-CSCF。 
如果授权响应方式为“立即响应”，RCP为了在初始AAA中携带最新的IP-CAN-Type和RAT-Type，需要从用户上线就一直向SMF/PGW订阅IP-CAN_CHANGE和RAT_CHANGE相关事件，这会造成SMF/PGW和RCP间信令交互明显增多，因为非VoNR呼叫期间用户发生RAT改变时SMF/PGW也会通知RCP。而授权响应方式为“等承载确认后响应”或“仅IMS AF会话建立请求等承载确认后响应”时，RCP可以仅在VoNR呼叫期间因P-CSCF触发而自动向SMF/PGW订阅IP-CAN_CHANGE和RAT_CHANGE相关事件，在VoNR呼叫结束时自动取消这些事件订阅，这样可以避免非VoNR呼叫期间SMF/PGW因用户RAT改变而通知RCP。但“等承载确认后响应”或“仅IMS AF会话建立请求等承载确认后响应”会增加VoNR呼叫接通时延，两者相比之下，“仅IMS AF会话建立请求等承载确认后响应”对呼叫接通时延增加更少，所以推荐这种方式。 
授权响应方式为“仅IMS AF会话建立请求等承载确认后响应”时，如果承载异常，RCP和SMF/PGW交互失败（请求发送失败，响应超时或响应异常）时，RCP可以对P-CSCF回复AAA携带失败码5065（IP-CAN_SESSION_NOT_AVAILABLE），这可以触发P-CSCF启动基于UDM/HSS的P-CSCF容灾流程，使用户下线重接入，用户重建会话后再发起VoNR呼叫大概率可以恢复正常。 
一些特定流程不看授权响应方式配置。例如：基于PCF的P-CSCF容灾增强流程，RCP对初始AAR固定先回复AAA再和SMF/PGW交互。又例如：AF在STR消息中查询用户位置，RCP需要先和SMF/PGW交互，获取最新用户位置后，再回复STA。 
######## 呼叫保持：AF业务多实例 
RCP在业务授权时，根据每个媒体的AF应用标识、媒体类型、流用途、流方向等信息映射成一类业务标识，进行决策产生PCC规则。 
但在用户同时发起多个呼叫时，会建立多个AF会话，不同AF会话的媒体信息只有IP地址和端口不一致，AF应用标识、媒体类型、流用途、流方向等往往都一样，映射出的业务标识也是一样的，就只会决策出同一个PCC规则。在呼叫保持场景下，不同AF会话的媒体流状态是不一样的，下发到同一个PCC规则里则会使得PCC规则的流状态无法设置。 
所以，RCP针对AF多会话的场景，将相同业务标识决策出的规则复制成多份，实例号不为1的实例对应的规则名会加上实例号（实例号左补0扩展成3位）作为后缀区分。这样，每个AF会话的流下发到不同的PCC规则里，PCC规则的流状态可以正确表述媒体流的状态。 
######## VoWiFi位置查询 
P-CSCF向RCP查询接入网络信息时，如果用户从WLAN附着EPS网络，此时RCP会向SMF/PGW查询接入网络信息后传递给P-CSCF。包括TWAN-Identifier（存放：行政区号+国家码+本地网区号）、UE-Local-IP-Address、UDP-Source-Port参数传递位置信息。 
上述字段的组成如下： 
Gx透传RCP向PGWF查询后，PGW返回的TWAN-Identifier、UE-Local-IP-Address、UDP-Source-Port字段。 
N7：TWAN-Identifier：由SMF返回的n3gaLocation结构中，tnapId或者twapId字段的ssid、bssid、civicAddress拼接组成。UE-Local-IP-Address：由SMF返回的n3gaLocation结构中，ueIpv4Addr或ueIpv6Addr组成。UDP-Source-Port：由SMF返回的n3gaLocation结构中，protocol和portNumber组成。 
RCP基于如下条件来判断授信还是非授信的VoWiFi接入： 
N7接口上报VoWiFi位置相关信息时可能携带： accessType取值为NON_3GPP_ACCESS、ratType取值为WLAN、userLocationInfo->N3gaLocation（包括：ueIpv4Addr/ueIpv6Addr、portNumber、n3IwfId/tnapId/twapId）等信息。非授信的非3GPP接入：UE Local IP用于接入N3IWF，上报位置标识为userLocationInfo->N3gaLocation.n3IwfId。授信的的非3GPP接入：UE Local IP用于接入TNGF/TWIF，上报位置标识为userLocationInfo->N3gaLocation.tnapId/twapId。 
Gx接口根据上报的AN-Trusted（TRUSTED (0)，UNTRUSTED (1)）字段区分授信或者非授信的VoWiFi接入。 
######## 提供用户标识信息 
在需要提供用户标识信息的场景，例如VoNR国际漫游，当AF（P-CSCF）需要向PCF查询用户标识信息（IMSI、MSISDN、IMEISV）时，可以在Rx会话的AAR请求中包含AF-Requested-Data AVP且取值为1。 
RCP收到AAR请求后，若发现其中包含AF-Requested-Data AVP且取值为1，则从绑定的N7会话中找到IMSI、MSISDN、IMEISV，在AAA响应中返回给AF。 
参数|对应N7会话Create请求中的参数|对应Rx会话AAA消息中的参数
---|---|---
IMSI|supi|Subscription-Id-Type为END_USER_IMSI（1）的Subscription-Id AVP
MSISDN|gpsi|Subscription-Id-Type为END_USER_E164（0）的Subscription-Id AVP
IMEISV|pei|User-Equipment-Info AVP
######## 5G新通话 
RCP支持在语音或视频呼叫过程中增加实时翻译、趣味动图等新通话功能。 
5G新通话协议方案SBC发起新通话会话建立，携带QosHint特性。对于新通话业务，则会有DC通道的建立，会在音视频媒体基础上增加media-type为application的媒体组件Media-Component-Description（可能存在多个application类型的媒体组件）。每个application类型的媒体组件Media-Component-Description，可以申请GBR类型专有承载（QCI值为71,72,73,74,76），也可以申请Non-GBR类型的承载QCI值为9），PCF根据媒体组件Media-Component-Description携带的Desired-Max-Latency  和/或 Desired-Max-Loss AVP推导相应的QCIs和5QIs，并在动态规则中携带对应的QCI下发给SMF/xGW。 
5G新通话简化方案5G新通话协议方案对各厂商NF都有要求，且改动较大。为了使新通话应用快速部署，P-CSCF识别“Media_type”并解析a=3gpp-qos-hint属性，将解析信息（或映射转换后的信息）写入到“AF-Application-Identifier”。SBC发起语音呼叫会话时，PCF可根据“Media_type”为application和AF-Application-Identifier配置输出QCI/5QI；与协议方案差别在于语音呼叫会话不再携带qos-hint的support-feature，同时新通话DC媒体也可能不携带Desired-Max-Latency及Desired-Max-Loss两个AVP。 
目前，运营商倾向使用5G新通话简化方案。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
类别|标准编号|标准名称
---|---|---
3GPP|TS 29.512|5G System; Session Management Policy Control Service;
3GPP|TS 29.513|5G System; Policy and Charging Control signallingflows and QoS parameter mapping;
3GPP|TS 29.214|Policy and Charging Control over Rx referencepoint
##### 特性能力 
名称|指标
---|---
单用户可建立的AF会话数|11
单PDU会话可绑定的AF会话数|11
每AF会话支持的媒体组件数量|4
每AF会话媒体组件支持的子组件数量|2
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.10|首次发布。
####### License要求 
该特性需要将License中Rx接口受控项的权限设置为打开状态，受控项标识为LIC_RCP_FUN_RX。 
####### 对其他网元的要求 
本特性需要RCP、SMF和AF网元配合完成。其中，AF网元应能够将VoNR呼叫所使用的媒体信息、用户IP地址信息等通知RCP，并根据RCP上报的事件对VoNR呼叫进行控制；SMF网元应能够根据RCP下发的策略触发专有QoS
Flow的建立，并根据RCP订阅的事件上报承载相关的状态变更等。

##### O&M相关 

###### 命令 
######## 配置项 
网管新增的配置项： 
编号|命令名称|描述
---|---|---
1|ADD EMERGAPN|配置IMS域接入的APN标识，分为紧急呼叫和普通VoLTE APN两种。
2|ADD EMERGSVCURN|配置紧急呼叫的Service-URN标识。
3|ADD AFAPPMEDIA|配置AF应用标识映射，根据AF的媒体属性映射到下发决策的应用标识。
4|ADD DEFAFAPP|配置默认的AF应用标识，请求未携带AF-Application-Identifier时使用此配置值。
策略配置GUI中新增的策略变量：
所属类别|新增字段名称/修改字段名称|描述
---|---|---
AF信息类|AF计费标识|表示AF会话中计费标识
Service URN|AF信息类|表示AF会话中的Service URN标识
紧急Service-URN指示|AF信息类|表示AF会话携带的Service URN标识是否为紧急标识
媒体类型|AF信息类|表示业务关联的AF媒体的类型
用户多媒体优先级服务标识|AF信息类|表示用户所有AF会话里包含的MPS ID的值
会话多媒体优先级服务标识|AF信息类|表示AF会话中的MPS ID的值
用户资源预留优先级|AF信息类|表示用户所有AF会话里包含的资源预留优先级
会话资源预留优先级|AF信息类|表示AF会话中的资源预留优先级
媒体资源预留优先级|AF信息类|表示业务关联的AF媒体的资源预留优先级
媒体上行最大带宽|AF信息类|表示业务关联的AF媒体的上行最大带宽（Maximum-Requested-Bandwidth-UL）
媒体下行最大带宽|AF信息类|表示业务关联的AF媒体的下行最大带宽（Maximum-Requested-Bandwidth-DL）
AF应用标识|AF信息类|表示业务关联的AF媒体的应用标识
######## 定时器 
定时器编号|定时器名称|定时器时长（毫秒）|系统缺省值（毫秒）
---|---|---|---
2056|FSWAITRAA|5000|5000
2057|FSWAITSTR|5000|5000
######## 全局变量 
序号|描述
---|---
1|1071 向AF提供用户标识信息的功能开关
2|1081 是否支持对未完成协商信息授权的开关
3|1082 AF关联业务节点是否支持多实例开关
4|1098 当RR和RS存在且为0时是否下发RTCP
5|1127 专载更新失败时通知AF的方式
6|1135 IMS业务带宽为0是否下发开关
7|1362 语音会话建立或更新是否跳过策略决策
8|1269 新通话媒体策略合并开关
######## 动态管理 
执行[SHOW_STAT_INFO](../../Npcf_SMPolicyControl\zh-cn\mml\1137502.html)命令，查询Rx组件的内部统计信息：
[SHOW_STAT_INFO](../../Npcf_SMPolicyControl\zh-cn\mml\1137502.html):MODULE="RCP_RX"
###### 性能统计 
######## 性能计数器 
测量类型|描述
---|---
RCP系统资源统计|C000200075 在线IMS Rx会话数C000200076 在线IMSRx会话数均值C000200077 在线IMS Rx会话数峰值C000200106 在线IMS APN的N7会话数C000200107 在线IMS APN的N7会话数均值C000200108 在线IMS APN的N7会话数峰值
######## KPI 
名称|指标公式|KPI描述
---|---|---
（000179015）Diameter Rx发起成功率（%）|C000170186/C000170004×100|Rx发送成功AAA的总数/Rx发送AAA的总数×100
（000179016）Diameter Rx结束成功率（%）|C000170200/C000170008×100|Rx发送成功STA的总数/Rx发送STA的总数×100
###### 告警和通知 
该特性不涉及告警消息的变化。 


###### 业务观察/失败观察 




该特性不涉及业务观察/失败观察的变化。 




###### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置特性 
###### 配置说明 
ZXUN RCP的VoNR特性主要是通过配置不同的PCC规则，设置不同媒体映射不同的PCC规则，建立语音、视频专载，达到对用户通话进行保障的目的。
###### 配置前提 
VoNR特性是RCP和SMF以及AF配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常。
对于N7接口，RCP与SMF之间的链路配置，SMF邻接局配置以及承载能力配置。 
对于Rx接口，RCP与AF之间的链路配置，AF邻接局配置。 
###### 配置过程 
图1  配置流程
[]images/image13.png)
在EM→配置
页面中，执行如下配置过程：
配置AF能力。
在Npcf_PolicyManagement_0服务下，执行[ADD
AFABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787329.html)命令，配置AF授权响应方式。
在Npcf_PolicyManagement_0服务下，执行[ADD
DEFAFAPP](../../Npcf_PolicyManagement\zh-CN\mml\1787026.html)命令，配置默认AF应用标识。
在Npcf_PolicyManagement_0服务下，执行[ADD
EMERGAPN](../../Npcf_PolicyManagement\zh-CN\mml\1787437.html)命令，配置IMS域APN的类型。
配置业务映射。 
在Npcf_PolicyManagement_0服务下，执行[ADD
AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html)命令，配置AF业务应用标识映射。
在Npcf_PolicyManagement_0服务下，执行[ADD
APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，配置应用标识属性。
在Npcf_PolicyManagement_0服务下，进入策略管理页面，配置基于VoLTE业务的控制策略。
在Npcf_PolicyManagement_0服务下，进入策略管理页面，提交配置的策略数据。
###### 配置实例1-用户使用VoNR视频呼叫 
######## 配置场景 
用户从ims APN接入使用VoNR视频呼叫业务（AF应用标识为ims）。AF发送请求RCP进行资源预留，RCP为该视频呼叫下发策略，指示SMF为音频媒体建立QCI为1的专有承载，为视频媒体建立QCI为2专有承载，保障用户的语音和视频通话质量。语音和视频的QoS带宽参数由AF网元提供。
######## 数据规划 
数据规划参见下表： 
类别|参数|取值
---|---|---
APN|APN值|ims
类型|APN|VoLTE_APN
AF应用标识|AF请求|ims
默认参数|AF应用标识|10001
Gx应用标识|音频媒体RTP流|1050000004
音频媒体RTCP流|Gx应用标识|1050000006
视频媒体RTP流|Gx应用标识|1050000005
视频媒体RTCP流|Gx应用标识|1050000007
AF信令|Gx应用标识|1050000003
业务标识|音频业务标识|1
视频业务标识|业务标识|2
AF信令|业务标识|3
策略规划参见下表： 
类别|条件|动作参数
---|---|---
业务规则|Gx应用标识=1050000004|规则名=volte_audio，QCI=1
Gx应用标识=1050000006|业务规则|规则名=volte_audio_rtcp，QCI=1
Gx应用标识=1050000005|业务规则|规则名=volte_video，QCI=2
Gx应用标识=1050000007|业务规则|规则名=volte_video_rtcp，QCI=2
Gx应用标识=1050000003|业务规则|规则名=volte_afsignalling，QCI=5
######## 业务配置关系图 
业务配置关系如[图2](ZUF-90-06-002-14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__379fd2fc-47d1-4ae6-8b67-919196096239)所示。
图2  业务配置关系图
[]images/%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B1.png)
######## 配置步骤 
配置基础信息。
配置邻接主机组。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置邻接主机通配配置。 
现场根据实际信息配置，如AF有具体的主机名，优先配置具体的主机名称。 
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=10,HOSTNAME="*",HOSTTYPE="SMF",ADJHOSTGRPID=11,PRIOR=1
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=11,HOSTNAME="*.ims.mnc011.mcc460.3gppnetwork.org",HOSTTYPE="3GPP-AF",ADJHOSTGRPID=0
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=12,HOSTNAME="*.epc.mnc011.mcc460.3gppnetwork.org",HOSTTYPE="3GPP-AF",ADJHOSTGRPID=0
配置承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID",PREDIST="YES",TIMERULENUM=0,REVALIDTIME="NO",SVCREDIRECT="NO",BEARCTRMODE="UE_NW",SESSCCTIME="YES",SVCCCTIME="YES",SESSCHARGE="NO",ROAMCOND="MCCMNC",RELRGCHG="NO",ACC3GPPQRY="YES",TRUSTWLANQRY="YES",UNTRUSTWLANQRY="YES",EXTENDBW="YES"
配置AF能力。 
[ADD AFABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787329.html):ADJHOSTID=11
[ADD AFABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787329.html):ADJHOSTID=12
配置默认AF应用标识。 
[ADD DEFAFAPP](../../Npcf_PolicyManagement\zh-CN\mml\1787026.html):INTERFACETYPE="Rx",AFAI="10001";
配置IMS域APN。 
[ADD EMERGAPN](../../Npcf_PolicyManagement\zh-CN\mml\1787437.html):APN="IMS_APN",TYPE="VOLTE_APN";
配置AF应用标识映射配置。 
AFAI根据现场实际情况配置。 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=12,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=13,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=14,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=15,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=16,AFAI="ims",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000005;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=17,AFAI="ims",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000005;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=18,AFAI="ims",MEDIATYPE="VIDEO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000007;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=19,AFAI="ims",MEDIATYPE="VIDEO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000007;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=20,AFAI="ims",MEDIATYPE="OTHER",FLOWUSE="AFSIGNAL",FLOWDIRECT="UP",APPID=1050000003;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=21,AFAI="ims",MEDIATYPE="OTHER",FLOWUSE="AFSIGNAL",FLOWDIRECT="DOWN",APPID=1050000003;
若AF请求中不携带AF-Application-Identifier，则上述配置中的AFAI需要替换为“默认AF应用标识配置”中的内容，其他不变。 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=1,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=2,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=3,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=4,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=5,AFAI="10001",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000005;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=6,AFAI="10001",MEDIATYPE="VIDEO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000005;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=7,AFAI="10001",MEDIATYPE="VIDEO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000007;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=8,AFAI="10001",MEDIATYPE="VIDEO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000007;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=9,AFAI="10001",MEDIATYPE="OTHER",FLOWUSE="AFSIGNAL",FLOWDIRECT="UP",APPID=1050000003;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=10,AFAI="10001",MEDIATYPE="OTHER",FLOWUSE="AFSIGNAL",FLOWDIRECT="DOWN",APPID=1050000003;
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000004,APPDESC="audio",SUBSID="1",SUBSDESC="audio",PREPROV="NO";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000006,APPDESC="audio_rtcp",SUBSID="1",SUBSDESC="audio_rtcp",PREPROV="NO";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000005,APPDESC="video",SUBSID="2",SUBSDESC="video",PREPROV="NO";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000007,APPDESC="video_rtcp",SUBSID="2",SUBSDESC="video_rtcp",PREPROV="NO";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000003,APPDESC="af-signal",SUBSID="3",SUBSDESC="af-signal",PREPROV="NO";
配置系统全局变量。 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1081,CURVAL="1",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1082,CURVAL="1",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1006,CURVAL="0",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1116,CURVAL="2",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1135,CURVAL="1",EXTFLAG=0
配置规则条件。
条件名称|参数|取值
---|---|---
ims apn|选择策略变量|其他
策略变量类别|ims apn|会话信息类
策略变量|ims apn|APN
操作符|ims apn|In
参考值|ims apn|ims
1050000004_audio|选择策略变量|其他
策略变量类别|1050000004_audio|会话信息类
策略变量|1050000004_audio|Gx应用标识
操作符|1050000004_audio|=
参考值|1050000004_audio|1050000004
1050000006_audio_rtcp|选择策略变量|其他
策略变量类别|1050000006_audio_rtcp|会话信息类
策略变量|1050000006_audio_rtcp|Gx应用标识
操作符|1050000006_audio_rtcp|=
参考值|1050000006_audio_rtcp|1050000006
1050000005_video|选择策略变量|其他
策略变量类别|1050000005_video|会话信息类
策略变量|1050000005_video|Gx应用标识
操作符|1050000005_video|=
参考值|1050000005_video|1050000005
1050000007_video_rtcp|选择策略变量|其他
策略变量类别|1050000007_video_rtcp|会话信息类
策略变量|1050000007_video_rtcp|Gx应用标识
操作符|1050000007_video_rtcp|=
参考值|1050000007_video_rtcp|1050000007
1050000003_afsignalling|选择策略变量|其他
策略变量类别|1050000003_afsignalling|会话信息类
策略变量|1050000003_afsignalling|Gx应用标识
操作符|1050000003_afsignalling|=
参考值|1050000003_afsignalling|1050000003
配置规则动作参数。
业务控制策略动作参数 
动作参数名称|参数名称|取值
---|---|---
VOLTE_N7_default_5QI|参数类型|N7会话参数集
会话规则ID|VOLTE_N7_default_5QI|volte_session
5QI|VOLTE_N7_default_5QI|5
ARP优先级|VOLTE_N7_default_5QI|1
ARP抢占能力|VOLTE_N7_default_5QI|可以抢占
ARP被抢占能力|VOLTE_N7_default_5QI|不允许被抢占
VOLTE_N7_RG_1050000004|参数类型|Charging参数集
计费控制策略ID|VOLTE_N7_RG_1050000004|audio
费率组|VOLTE_N7_RG_1050000004|1050000004
VOLTE_N7_qci1_arp2|参数类型|QoS参数集
QoS控制策略ID|VOLTE_N7_qci1_arp2|audio_rtp
5QI|VOLTE_N7_qci1_arp2|1
ARP优先级|VOLTE_N7_qci1_arp2|2
ARP抢占能力|VOLTE_N7_qci1_arp2|可以抢占
ARP被抢占能力|VOLTE_N7_qci1_arp2|不允许被抢占
VOLTE_N7_qci1_arp2_2|参数类型|QoS参数集
QoS控制策略ID|VOLTE_N7_qci1_arp2_2|audio_rtcp
5QI|VOLTE_N7_qci1_arp2_2|1
ARP优先级|VOLTE_N7_qci1_arp2_2|2
ARP抢占能力|VOLTE_N7_qci1_arp2_2|可以抢占
ARP被抢占能力|VOLTE_N7_qci1_arp2_2|不允许被抢占
VOLTE_N7_audio|参数类型|N7 PCC规则参数集
PCC规则ID|VOLTE_N7_audio|volte_audio
PCC规则类型|VOLTE_N7_audio|动态规则
优先级|VOLTE_N7_audio|0
QoS控制策略ID|VOLTE_N7_audio|VOLTE_N7_qci1_arp2
计费控制策略ID|VOLTE_N7_audio|VOLTE_N7_RG_1050000004
VOLTE_N7_audio_rtcp|参数类型|N7 PCC规则参数集
PCC规则ID|VOLTE_N7_audio_rtcp|volte_audio_rtcp
PCC规则类型|VOLTE_N7_audio_rtcp|动态规则
优先级|VOLTE_N7_audio_rtcp|1
QoS控制策略ID|VOLTE_N7_audio_rtcp|VOLTE_N7_qci1_arp2_2
计费控制策略ID|VOLTE_N7_audio_rtcp|VOLTE_N7_RG_1050000004
VOLTE_N7_RG_1050000005|参数类型|Charging参数集
计费控制策略ID|VOLTE_N7_RG_1050000005|video
费率组|VOLTE_N7_RG_1050000005|1050000005
VOLTE_N7_qci2_arp4|参数类型|QoS参数集
QoS控制策略ID|VOLTE_N7_qci2_arp4|video_rtp
5QI|VOLTE_N7_qci2_arp4|2
ARP优先级|VOLTE_N7_qci2_arp4|4
ARP抢占能力|VOLTE_N7_qci2_arp4|可以抢占
ARP被抢占能力|VOLTE_N7_qci2_arp4|不允许被抢占
VOLTE_N7_qci2_arp4_2|参数类型|QoS参数集
QoS控制策略ID|VOLTE_N7_qci2_arp4_2|video_rtcp
5QI|VOLTE_N7_qci2_arp4_2|2
ARP优先级|VOLTE_N7_qci2_arp4_2|4
ARP抢占能力|VOLTE_N7_qci2_arp4_2|可以抢占
ARP被抢占能力|VOLTE_N7_qci2_arp4_2|不允许被抢占
VOLTE_N7_video|参数类型|N7 PCC规则参数集
PCC规则ID|VOLTE_N7_video|volte_video
PCC规则类型|VOLTE_N7_video|动态规则
优先级|VOLTE_N7_video|2
QoS控制策略ID|VOLTE_N7_video|VOLTE_N7_qci2_arp4
计费控制策略ID|VOLTE_N7_video|VOLTE_N7_RG_1050000005
VOLTE_N7_video_rtcp|参数类型|N7 PCC规则参数集
PCC规则ID|VOLTE_N7_video_rtcp|volte_video_rtcp
PCC规则类型|VOLTE_N7_video_rtcp|动态规则
优先级|VOLTE_N7_video_rtcp|3
QoS控制策略ID|VOLTE_N7_video_rtcp|VOLTE_N7_qci2_arp4_2
计费控制策略ID|VOLTE_N7_video_rtcp|VOLTE_N7_RG_1050000005
VOLTE_N7_RG_1050000003|参数类型|Charging参数集
计费控制策略ID|VOLTE_N7_RG_1050000003|afsignalling
费率组|VOLTE_N7_RG_1050000003|1050000003
VOLTE_N7_qci5|参数类型|QoS参数集
QoS控制策略ID|VOLTE_N7_qci5|afsignalling
5QI|VOLTE_N7_qci5|5
最大上行带宽(kbps)|VOLTE_N7_qci5|10
最大下行带宽(kbps)|VOLTE_N7_qci5|10
保障上行带宽(kbps)|VOLTE_N7_qci5|10
保障下行带宽(kbps)|VOLTE_N7_qci5|10
ARP优先级|VOLTE_N7_qci5|1
ARP抢占能力|VOLTE_N7_qci5|可以抢占
ARP被抢占能力|VOLTE_N7_qci5|不允许被抢占
VOLTE_N7_afsignalling|参数类型|N7 PCC规则参数集
PCC规则ID|VOLTE_N7_afsignalling|volte_afsignalling
PCC规则类型|VOLTE_N7_afsignalling|动态规则
优先级|VOLTE_N7_afsignalling|4
QoS控制策略ID|VOLTE_N7_afsignalling|VOLTE_N7_qci5
计费控制策略ID|VOLTE_N7_afsignalling|VOLTE_N7_RG_1050000003
配置场景。
场景规则关联配置。 
场景名称|参数|取值
---|---|---
VOLTE_ims|入口1|入口类型|会话信息类
已选入口|VOLTE_ims|入口1|APN
取值|VOLTE_ims|入口1|ims
策略类型|VOLTE_ims|N7会话决策|VOLTE_N7_Default_5QI
N7业务决策|策略类型|VOLTE_ims|VOLTE_N7_audio
VOLTE_N7_audio_rtcp|N7业务决策|策略类型|VOLTE_ims
VOLTE_N7_video|N7业务决策|策略类型|VOLTE_ims
VOLTE_N7_video_rtcp|N7业务决策|策略类型|VOLTE_ims
VOLTE_N7_afsignalling|N7业务决策|策略类型|VOLTE_ims
业务控制策略规则。 
规则名称|参数|取值
---|---|---
VOLTE_N7_Default_5QI|优先级|55
动作类型|VOLTE_N7_Default_5QI|参数填充
日志开关|VOLTE_N7_Default_5QI|关
条件表达式|VOLTE_N7_Default_5QI|{APN In ims}
动作参数名称|VOLTE_N7_Default_5QI|VOLTE_N7_default_5QI
VOLTE_N7_audio|优先级|55
动作类型|VOLTE_N7_audio|参数填充
日志开关|VOLTE_N7_audio|关
条件表达式|VOLTE_N7_audio|{Gx应用标识 = 1050000004}
动作参数名称|VOLTE_N7_audio|VOLTE_N7_audio
VOLTE_N7_audio_rtcp|优先级|55
动作类型|VOLTE_N7_audio_rtcp|参数填充
日志开关|VOLTE_N7_audio_rtcp|关
条件表达式|VOLTE_N7_audio_rtcp|{Gx应用标识 = 1050000006}
动作参数名称|VOLTE_N7_audio_rtcp|VOLTE_N7_audio_rtcp
VOLTE_N7_video|优先级|55
动作类型|VOLTE_N7_video|参数填充
日志开关|VOLTE_N7_video|关
条件表达式|VOLTE_N7_video|{Gx应用标识 = 1050000005}
动作参数名称|VOLTE_N7_video|VOLTE_N7_video
VOLTE_N7_video_rtcp|优先级|55
动作类型|VOLTE_N7_video_rtcp|参数填充
日志开关|VOLTE_N7_video_rtcp|关
条件表达式|VOLTE_N7_video_rtcp|{Gx应用标识 = 1050000007}
动作参数名称|VOLTE_N7_video_rtcp|VOLTE_N7_video_rtcp
VOLTE_N7_afsignalling|优先级|55
动作类型|VOLTE_N7_afsignalling|参数填充
日志开关|VOLTE_N7_afsignalling|关
条件表达式|VOLTE_N7_afsignalling|{Gx应用标识 = 1050000003}
动作参数名称|VOLTE_N7_afsignalling|VOLTE_N7_afsignalling
######## 配置脚本 
/*Role:VOLTE_ims---Start*/ 
ADD DM COND:NAME="ims apn",SVCKEY="SYS.GX_APN",OPERATOR="In",VALTYPE="VALUE",VALUE="ims"&"ims1";
ADD DM COND:NAME="1050000004_audio",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000004";
ADD DM COND:NAME="1050000006_audio_rtcp",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000006";
ADD DM COND:NAME="1050000005_video",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000005";
ADD DM COND:NAME="1050000007_video_rtcp",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000007";
ADD DM COND:NAME="1050000003_afsignalling",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000003";
ADD DM ACTION:NAME="VOLTE_default_QCI",TYPE="BEARER_CTRL",PARAMS="SYS.BEAR_QCI"-"0"-"5"&"SYS.BEAR_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.BEAR_ARP_PRE_EMPTION_CAP"-"0"-"PRE-EMPTION_CAPABILITY_ENABLED"&"SYS.BEAR_ARP_PRE_EMPTION_VULNERABILITY"-"0"-"PRE-EMPTION_VULNERABILITY_DISABLED";
ADD DM ACTION:NAME="volte_audio",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"2"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000004"&"SYS.QOS_CLASS"-"0"-"1"&"SYS.PRE_PRECEDENCE"-"0"-"0"&"SYS.PRE_RATING_GROUP"-"0"-"1050000004"&"SYS.SERVICE_ID"-"0"-"1050000004"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_audio";
ADD DM ACTION:NAME="volte_audio_rtcp",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"2"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000006"&"SYS.QOS_CLASS"-"0"-"1"&"SYS.PRE_PRECEDENCE"-"0"-"1"&"SYS.PRE_RATING_GROUP"-"0"-"1050000004"&"SYS.SERVICE_ID"-"0"-"1050000004"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_audio_rtcp";
ADD DM ACTION:NAME="volte_video",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"4"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000005"&"SYS.QOS_CLASS"-"0"-"2"&"SYS.PRE_PRECEDENCE"-"0"-"2"&"SYS.PRE_RATING_GROUP"-"0"-"1050000005"&"SYS.SERVICE_ID"-"0"-"1050000005"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_video";
ADD DM ACTION:NAME="volte_video_rtcp",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"4"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000007"&"SYS.QOS_CLASS"-"0"-"2"&"SYS.PRE_PRECEDENCE"-"0"-"3"&"SYS.PRE_RATING_GROUP"-"0"-"1050000005"&"SYS.SERVICE_ID"-"0"-"1050000005"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_video_rtcp";
ADD DM ACTION:NAME="volte_afsignalling",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"1"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000003"&"SYS.QOS_CLASS"-"0"-"5"&"SYS.MAX_BR_UL"-"0"-"10"&"SYS.MAX_BR_DL"-"0"-"10"&"SYS.GBR_UL"-"0"-"10"&"SYS.GBR_DL"-"0"-"10"&"SYS.PRE_PRECEDENCE"-"0"-"4"&"SYS.PRE_RATING_GROUP"-"0"-"1050000003"&"SYS.SERVICE_ID"-"0"-"1050000003"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_afsignalling";
ADD DM ACTION:NAME="VOLTE_N7_default_5QI",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"volte_session"&"SYS.DEF_QOS_5QI"-"0"-"5"&"SYS.DEF_QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.DEF_QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.DEF_QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_RG_1050000004",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"audio"&"SYS.CHG_RATING_GROUP"-"0"-"1050000004"&"SYS.CHG_SERVICE_ID"-"0"-"1050000004";
ADD DM ACTION:NAME="VOLTE_N7_qci1_arp2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"audio_rtp"&"SYS.QOS_5QI"-"0"-"1"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"2"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_audio",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_audio"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"0"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_qci1_arp2"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000004";
ADD DM ACTION:NAME="VOLTE_N7_qci1_arp2_2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"audio_rtcp"&"SYS.QOS_5QI"-"0"-"1"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"2"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_audio_rtcp",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_audio_rtcp"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"1"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_qci1_arp2_2"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000004";
ADD DM ACTION:NAME="VOLTE_N7_RG_1050000005",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"video"&"SYS.CHG_RATING_GROUP"-"0"-"1050000005"&"SYS.CHG_SERVICE_ID"-"0"-"1050000005";
ADD DM ACTION:NAME="VOLTE_N7_qci2_arp4",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"video_rtp"&"SYS.QOS_5QI"-"0"-"2"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"4"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_video",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_video"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"2"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_qci2_arp4"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000005";
ADD DM ACTION:NAME="VOLTE_N7_qci2_arp4_2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"video_rtcp"&"SYS.QOS_5QI"-"0"-"2"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"4"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_video_rtcp",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_video_rtcp"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"3"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_qci2_arp4_2"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000005";
ADD DM ACTION:NAME="VOLTE_N7_RG_1050000003",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"afsignalling"&"SYS.CHG_RATING_GROUP"-"0"-"1050000003"&"SYS.CHG_SERVICE_ID"-"0"-"1050000003";
ADD DM ACTION:NAME="VOLTE_N7_qci5",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"afsignalling"&"SYS.QOS_5QI"-"0"-"5"&"SYS.QOS_MBR_UL"-"0"-"10"&"SYS.QOS_MBR_DL"-"0"-"10"&"SYS.QOS_GBR_UL"-"0"-"10"&"SYS.QOS_GBR_DL"-"0"-"10"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_afsignalling",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_afsignalling"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"4"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_qci5"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000003";
ADD DM RULE:NAME="VOLTE_Default_QCI",PLCTYPE="BEARER_CTRL",PRIOR=1,CONDEXP="{ims apn}",ACTTYPE="PARAM",ACTNAME="VOLTE_default_QCI",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_audio",PLCTYPE="SVC_CTRL",PRIOR=55,CONDEXP="{1050000004_audio}",ACTTYPE="PARAM",ACTNAME="volte_audio",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_audio_rtcp",PLCTYPE="SVC_CTRL",PRIOR=55,CONDEXP="{1050000006_audio_rtcp}",ACTTYPE="PARAM",ACTNAME="volte_audio_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_video",PLCTYPE="SVC_CTRL",PRIOR=55,CONDEXP="{1050000005_video}",ACTTYPE="PARAM",ACTNAME="volte_video",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_video_rctp",PLCTYPE="SVC_CTRL",PRIOR=55,CONDEXP="{1050000007_video_rtcp}",ACTTYPE="PARAM",ACTNAME="volte_video_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_afsignalling",PLCTYPE="SVC_CTRL",PRIOR=55,CONDEXP="{1050000003_afsignalling}",ACTTYPE="PARAM",ACTNAME="volte_afsignalling",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_Default_5QI",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=55,CONDEXP="{ims apn}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_default_5QI",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_audio",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=55,CONDEXP="{1050000004_audio}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_audio",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_audio_rtcp",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=55,CONDEXP="{1050000006_audio_rtcp}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_audio_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_video",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=55,CONDEXP="{1050000005_video}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_video",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_video_rtcp",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=55,CONDEXP="{1050000007_video_rtcp}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_video_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_afsignalling",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=55,CONDEXP="{1050000003_afsignalling}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_afsignalling",LOGFLAG="OFF",RULENO=0;
ADD DM ROLE:NAME="VOLTE_ims",ENTRANCE="SYS.GX_APN"-"ims",RULENAME="VOLTE_Default_QCI"&"volte_audio"&"volte_audio_rtcp"&"volte_video"&"volte_video_rctp"&"volte_afsignalling"&"VOLTE_N7_Default_5QI"&"VOLTE_N7_audio"&"VOLTE_N7_audio_rtcp"&"VOLTE_N7_video"&"VOLTE_N7_video_rtcp"&"VOLTE_N7_afsignalling",VALIDFLAG="ENABLE";
/*Role:VOLTE_ims--End*/ 
###### 配置实例2-用户使用VoNR紧急呼叫 
######## 场景说明 
用户从sos APN接入使用VoNR紧急呼叫业务（AF应用标识为IMS_Call_AppID），紧急呼叫Service-URN为“sos”。AF从邻接局发送请求RCP进行资源预留，RCP为该紧急呼叫下发策略，指示SMF为音频媒体建立QCI为1的专有承载，并且其ARP抢占优先级为1，保障用户高优先级的语音通话质量。语音的QoS带宽参数由AF网元提供。
######## 数据规划 
数据规则参见下表： 
类别|参数|取值
---|---|---
APN|APN值|sos
类型|APN|EMERG_APN
AF应用标识|AF请求|ims
默认参数|AF应用标识|10001
Gx应用标识|音频媒体RTP流|1050000004
音频媒体RTCP流|Gx应用标识|1050000006
业务标识|音频业务标识|1
策略规划参见下表： 
类别|条件|动作参数
---|---|---
业务规则|Gx应用标识=1050000004|规则名=volte_sos_audio，QCI=1
Gx应用标识=1050000006|业务规则|规则名=volte_sos_audio_rtcp，QCI=1
######## 业务配置关系图 
业务配置关系如[图3](ZUF-90-06-002-14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B2-%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8VoLTE%E7%B4%A7%E6%80%A5%E5%91%BC%E5%8F%AB-0C7C3DF6__087b0cbd-6482-4f14-86e6-a3c6965b38f2)所示。
图3  业务配置关系图
[]images/%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B2.png)
######## 配置步骤 
配置基础信息。
配置邻接主机组。 
[ADD ADJHOSTGRP](../../Npcf_PolicyManagement\zh-CN\mml\1787589.html):ADJHOSTGRPID=10,HOSTTYPE="SMF"
配置邻接主机通配配置。 
现场根据实际信息配置，如AF有具体的主机名，优先配置具体的主机名。 
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=10,HOSTNAME="*",HOSTTYPE="SMF",ADJHOSTGRPID=11,PRIOR=1
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=11,HOSTNAME="*.ims.mnc011.mcc460.3gppnetwork.org",HOSTTYPE="3GPP-AF",ADJHOSTGRPID=0
[ADD ADJHOSTWD](../../Npcf_PolicyManagement\zh-CN\mml\1787011.html):ADJHOSTID=12,HOSTNAME="*.epc.mnc011.mcc460.3gppnetwork.org",HOSTTYPE="3GPP-AF",ADJHOSTGRPID=0
配置承载能力。 
[ADD BEARABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787317.html):ADJHOSTGRPID=10,INTERFACE="PGW",SERVMODE="SERVICEID",PREDIST="YES",TIMERULENUM=0,REVALIDTIME="NO",SVCREDIRECT="NO",BEARCTRMODE="UE_NW",SESSCCTIME="YES",SVCCCTIME="YES",SESSCHARGE="NO",ROAMCOND="MCCMNC",RELRGCHG="NO",ACC3GPPQRY="YES",TRUSTWLANQRY="YES",UNTRUSTWLANQRY="YES",EXTENDBW="YES"
配置AF能力。 
[ADD AFABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787329.html):ADJHOSTID=11
[ADD AFABILITY](../../Npcf_PolicyManagement\zh-CN\mml\1787329.html):ADJHOSTID=12
配置默认AF应用标识。 
[ADD DEFAFAPP](../../Npcf_PolicyManagement\zh-CN\mml\1787026.html):INTERFACETYPE="Rx",AFAI="10001";
配置IMS域APN。 
[ADD EMERGAPN](../../Npcf_PolicyManagement\zh-CN\mml\1787437.html):APN="sos",TYPE="EMERG_APN";
配置IMS紧急呼叫Service-URN。 
[ADD EMERGSVCURN](../../Npcf_PolicyManagement\zh-CN\mml\1787586.html):SVCURNPREFIX="urn:service:sos.fire";
[ADD EMERGSVCURN](../../Npcf_PolicyManagement\zh-CN\mml\1787586.html):SVCURNPREFIX="urn:service:sos.police";
[ADD EMERGSVCURN](../../Npcf_PolicyManagement\zh-CN\mml\1787586.html):SVCURNPREFIX="urn:service:sos.ambulance";
[ADD EMERGSVCURN](../../Npcf_PolicyManagement\zh-CN\mml\1787586.html):SVCURNPREFIX="urn:service:sos.traffic";
配置AF应用标识映射。 
AFAI根据现场实际情况配置。 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=12,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=13,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=14,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=15,AFAI="ims",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000006;
若AF请求中不携带AF-Application-Identifier，则上述配置中的AFAI需要替换为“默认AF应用标识配置”中的内容，其他不变。 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=1,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="UP",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=2,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="NOINFO",FLOWDIRECT="DOWN",APPID=1050000004;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=3,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="UP",APPID=1050000006;
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=4,AFAI="10001",MEDIATYPE="AUDIO",FLOWUSE="RTCP",FLOWDIRECT="DOWN",APPID=1050000006;
配置应用标识。 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000004,APPDESC="audio",SUBSID="1",SUBSDESC="audio",PREPROV="NO";
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1050000006,APPDESC="audio_rtcp",SUBSID="1",SUBSDESC="audio_rtcp",PREPROV="NO";
配置系统全局变量。 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1081,CURVAL="1",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1082,CURVAL="1",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1006,CURVAL="0",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1116,CURVAL="2",EXTFLAG=0
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1135,CURVAL="1",EXTFLAG=0
配置规则条件。
条件名称|参数|取值
---|---|---
sos apn|选择策略变量|其他
策略变量类别|sos apn|会话信息类
策略变量|sos apn|APN
操作符|sos apn|In
参考值|sos apn|sos,emergency
1050000004_audio|选择策略变量|其他
策略变量类别|1050000004_audio|会话信息类
策略变量|1050000004_audio|Gx应用标识
操作符|1050000004_audio|=
参考值|1050000004_audio|1050000004
1050000006_audio_rtcp|选择策略变量|其他
策略变量类别|1050000006_audio_rtcp|会话信息类
策略变量|1050000006_audio_rtcp|Gx应用标识
操作符|1050000006_audio_rtcp|=
参考值|1050000006_audio_rtcp|1050000006
配置规则动作参数。
业务控制策略动作参数 
动作参数名称|参数名称|取值
---|---|---
VoLTE_N7_sos_default_5QI|参数类型|N7会话参数集
会话规则ID|VoLTE_N7_sos_default_5QI|volte_sos_session
5QI|VoLTE_N7_sos_default_5QI|5
ARP优先级|VoLTE_N7_sos_default_5QI|1
ARP抢占能力|VoLTE_N7_sos_default_5QI|可以抢占
ARP被抢占能力|VoLTE_N7_sos_default_5QI|不允许被抢占
VoLTE_N7_RG_1050000004|参数类型|Charging参数集
计费控制策略ID|VoLTE_N7_RG_1050000004|audio
费率组|VoLTE_N7_RG_1050000004|1050000004
VoLTE_N7_sos_qci1_arp1|参数类型|QoS参数集
QoS控制策略ID|VoLTE_N7_sos_qci1_arp1|sos_rtp
5QI|VoLTE_N7_sos_qci1_arp1|1
ARP优先级|VoLTE_N7_sos_qci1_arp1|1
ARP抢占能力|VoLTE_N7_sos_qci1_arp1|可以抢占
ARP被抢占能力|VoLTE_N7_sos_qci1_arp1|不允许被抢占
VoLTE_N7_sos_qci1_arp1_1|参数类型|QoS参数集
QoS控制策略ID|VoLTE_N7_sos_qci1_arp1_1|sos_rtcp
5QI|VoLTE_N7_sos_qci1_arp1_1|1
ARP优先级|VoLTE_N7_sos_qci1_arp1_1|1
ARP抢占能力|VoLTE_N7_sos_qci1_arp1_1|可以抢占
ARP被抢占能力|VoLTE_N7_sos_qci1_arp1_1|不允许被抢占
VoLTE_N7_sos_audio|参数类型|N7 PCC规则参数集
PCC规则ID|VoLTE_N7_sos_audio|volte_sos_audio
PCC规则类型|VoLTE_N7_sos_audio|动态规则
优先级|VoLTE_N7_sos_audio|0
QoS控制策略ID|VoLTE_N7_sos_audio|VoLTE_N7_sos_qci1_arp1
计费控制策略ID|VoLTE_N7_sos_audio|VoLTE_N7_RG_1050000004
VoLTE_N7_sos_audio_rtcp|参数类型|N7 PCC规则参数集
PCC规则ID|VoLTE_N7_sos_audio_rtcp|volte_sos_audio_rtcp
PCC规则类型|VoLTE_N7_sos_audio_rtcp|动态规则
优先级|VoLTE_N7_sos_audio_rtcp|1
QoS控制策略ID|VoLTE_N7_sos_audio_rtcp|VoLTE_N7_sos_qci1_arp1_1
计费控制策略ID|VoLTE_N7_sos_audio_rtcp|VoLTE_N7_RG_1050000004
配置场景。
场景规则关联配置 
场景名称|参数|取值
---|---|---
VoLTE_sos|入口1|入口类型|会话信息类
已选入口|VoLTE_sos|入口1|紧急APN指示
取值|VoLTE_sos|入口1|紧急APN
策略类型|VoLTE_sos|N7会话决策|VoLTE_N7_sos_Default_5QI
N7业务决策|策略类型|VoLTE_sos|VoLTE_N7_sos_audio
VoLTE_N7_sos_audio_rtcp|N7业务决策|策略类型|VoLTE_sos
业务控制策略规则 
规则名称|参数|取值
---|---|---
VoLTE_N7_sos_Default_5QI|优先级|60
动作类型|VoLTE_N7_sos_Default_5QI|参数填充
日志开关|VoLTE_N7_sos_Default_5QI|关
条件表达式|VoLTE_N7_sos_Default_5QI|{APN In sos,emergency}
动作参数名称|VoLTE_N7_sos_Default_5QI|VoLTE_N7_sos_Default_5QI
VoLTE_N7_sos_audio|优先级|66
动作类型|VoLTE_N7_sos_audio|参数填充
日志开关|VoLTE_N7_sos_audio|关
条件表达式|VoLTE_N7_sos_audio|{Gx应用标识 = 1050000004}
动作参数名称|VoLTE_N7_sos_audio|VoLTE_N7_sos_audio
VoLTE_N7_sos_audio_rtcp|优先级|60
动作类型|VoLTE_N7_sos_audio_rtcp|参数填充
日志开关|VoLTE_N7_sos_audio_rtcp|关
条件表达式|VoLTE_N7_sos_audio_rtcp|{Gx应用标识 = 1050000006}
动作参数名称|VoLTE_N7_sos_audio_rtcp|VoLTE_N7_sos_audio_rtcp
######## 配置脚本 
/*Role:VOLTE_sos---Start*/ 
ADD DM COND:NAME="1050000004_audio",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000004";
ADD DM COND:NAME="1050000006_audio_rtcp",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="1050000006";
ADD DM COND:NAME="sos apn",SVCKEY="SYS.GX_APN",OPERATOR="In",VALTYPE="VALUE",VALUE="sos"&"emergency";
ADD DM ACTION:NAME="volte_sos_audio",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"1"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000004"&"SYS.QOS_CLASS"-"0"-"1"&"SYS.PRE_PRECEDENCE"-"0"-"0"&"SYS.PRE_RATING_GROUP"-"0"-"1050000004"&"SYS.SERVICE_ID"-"0"-"1050000004"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_sos_audio";
ADD DM ACTION:NAME="volte_sos_audio_rtcp",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"0"-"1"&"SYS.ARP_PRE_EMP_CAP"-"0"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"0"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"0"-"DYM_RULE"&"SYS.PRE_APPID"-"0"-"1050000006"&"SYS.QOS_CLASS"-"0"-"1"&"SYS.PRE_PRECEDENCE"-"0"-"1"&"SYS.PRE_RATING_GROUP"-"0"-"1050000004"&"SYS.SERVICE_ID"-"0"-"1050000004"&"SYS.CHARGING_CORRELATION_INDICATOR"-"0"-"CHARGING_IDENTIFIER_REQUIRED"&"SYS.CHARGING_RULE_NAME"-"0"-"volte_sos_audio_rtcp";
ADD DM ACTION:NAME="VOLTE_SOS_default_QCI",TYPE="BEARER_CTRL",PARAMS="SYS.BEAR_QCI"-"0"-"5"&"SYS.BEAR_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.BEAR_ARP_PRE_EMPTION_CAP"-"0"-"PRE-EMPTION_CAPABILITY_ENABLED"&"SYS.BEAR_ARP_PRE_EMPTION_VULNERABILITY"-"0"-"PRE-EMPTION_VULNERABILITY_DISABLED";
ADD DM ACTION:NAME="VOLTE_N7_sos_default_5QI",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"0"-"volte_sos_session"&"SYS.DEF_QOS_5QI"-"0"-"5"&"SYS.DEF_QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.DEF_QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.DEF_QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_RG_1050000004",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"0"-"audio"&"SYS.CHG_RATING_GROUP"-"0"-"1050000004"&"SYS.CHG_SERVICE_ID"-"0"-"1050000004";
ADD DM ACTION:NAME="VOLTE_N7_sos_qci1_arp1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"sos_rtp"&"SYS.QOS_5QI"-"0"-"1"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_sos_audio",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_sos_audio"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"0"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_sos_qci1_arp1"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000004";
ADD DM ACTION:NAME="VOLTE_N7_sos_qci1_arp1_1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"sos_rtcp"&"SYS.QOS_5QI"-"0"-"1"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE";
ADD DM ACTION:NAME="VOLTE_N7_sos_audio_rtcp",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"volte_sos_audio_rtcp"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_PRECEDENCE"-"0"-"1"&"SYS.N7_PCC_QoS_ID"-"0"-"VOLTE_N7_sos_qci1_arp1_1"&"SYS.N7_PCC_CHARGING_ID"-"0"-"VOLTE_N7_RG_1050000004";
ADD DM RULE:NAME="volte_sos",PLCTYPE="SVC_CTRL",PRIOR=60,CONDEXP="{1050000004_audio}",ACTTYPE="PARAM",ACTNAME="volte_sos_audio",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="volte_sos_audio_rtcp",PLCTYPE="SVC_CTRL",PRIOR=60,CONDEXP="{1050000006_audio_rtcp}",ACTTYPE="PARAM",ACTNAME="volte_sos_audio_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_SOS_Default_QCI_ARP",PLCTYPE="BEARER_CTRL",PRIOR=1,CONDEXP="{sos apn}",ACTTYPE="PARAM",ACTNAME="VOLTE_SOS_default_QCI",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_sos_Default_5QI",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=60,CONDEXP="{sos apn}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_sos_default_5QI",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_sos_audio",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=60,CONDEXP="{1050000004_audio}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_sos_audio",LOGFLAG="OFF",RULENO=0;
ADD DM RULE:NAME="VOLTE_N7_sos_audio_rtcp",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=60,CONDEXP="{1050000006_audio_rtcp}",ACTTYPE="PARAM",ACTNAME="VOLTE_N7_sos_audio_rtcp",LOGFLAG="OFF",RULENO=0;
ADD DM ROLE:NAME="VOLTE_sos",ENTRANCE="SYS.EMERGENCY_SESS_FLAG"-"EMERGENCY",RULENAME="volte_sos"&"volte_sos_audio_rtcp"&"VOLTE_SOS_Default_QCI_ARP"&"VOLTE_N7_sos_Default_5QI"&"VOLTE_N7_sos_audio"&"VOLTE_N7_sos_audio_rtcp",VALIDFLAG="ENABLE";
/*Role:VOLTE_sos--End*/ 
##### 测试用例 
####### 测试用例1–用户使用VoLTE视频呼叫 
测试项目|验证5G用户可正常进行视频通话
---|---
预置条件|网络中各网元系统及操作维护台运行正常。5G、LTE及VoLTE IMS网络支持VoNR相关要求。5G用户通过5G网络在VoLTE IMS网络注册成功。
测试步骤|主叫5G用户发起一个视频呼叫到被叫5G用户。记录接续时延。被叫选择视频接通，通话一段时间后释放呼叫。
通过准则|主叫侧信令流程：UE发送SIP invite消息给P-CSCF/BAC；P-CSCF/BAC向PCF发送AAR消息。PCF响应AAA消息触发建专用QoS Flow的流程。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify request消息通知AMF创建语音专有Qos Flow。SMF响应Npcf_SMPolicyControl_UpdateNotify response消息。SMF向AMF发送Namf_Communication_N1N2MessageTransfer，消息中携带SM相关信息。AMF响应Namf_Communication_N1N2MessageTransfer response消息。AMF向NG-RAN发送N2 session request消息，通知NG-RAN建立语音和视频QOS flow资源，NG-RAN建立语音和视频QOS flow，响应成功的N2 Session response消息。AMF向SMF发送Nsmf_PDUSession_UpdateSMContext request。SMF响应Nsmf_PDUSession_UpdateSMContext response消息。SMF向PCRF/PCF发送Npcf_SMPolicyControl_update request消息，消息中携带IRAT-Type等信息，这些信息都是5G的信元。PCF之后向P-CSCF/BAC发送RAR消息，P-CSCF/BAC响应RAA消息。被叫侧信令流程：P-CSCF/BAC向UE发送SIP invite消息，UE向P-CSCF/BAC响应183；P-CSCF/BAC向PCF发送AAR消息。PCF响应AAA消息触发建专用QoS Flow的流程。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify request消息通知AMF创建语音专有Qos Flow。SMF响应Npcf_SMPolicyControl_UpdateNotify response消息。SMF向AMF发送Namf_Communication_N1N2MessageTransfer，消息中携带SM相关信息。AMF响应Namf_Communication_N1N2MessageTransfer response消息。AMF向NG-RAN发送N2 session request消息，通知NG-RAN建立语音和视频QOS flow资源，NG-RAN建立语音和视频QOS flow，响应N2 Session response消息。AMF向SMF发送Nsmf_PDUSession_UpdateSMContext request。SMF响应Nsmf_PDUSession_UpdateSMContext response消息。SMF向PCF发送Npcf_SMPolicyControl_update request消息，消息中携带RAT-Type等信息，这些信息都是5G的信元。PCF之后向P-CSCF/BAC发送RAR消息，P-CSCF/BAC响应RAA消息。
信令流程|
####### 测试用例2–用户呼叫EPS Fallback 
测试条目|5G用户通过EPS Fallback做主/被叫
---|---
预置条件|网络中各网元系统及操作维护台运行正常。5G、LTE及VoLTE IMS网络支持EPS Fallback相关要求。网络配置支持N26接口。5G基站配置邻区关系。网络侧开启precondition。终端支持precondition。5G用户通过5G网络在VoLTE IMS注册成功。
测试步骤|主叫5G用户发起一个语音呼叫到被叫5G用户。记录接续时延。呼叫接通，通话一段时间后释放呼叫。
通过准则|主叫侧信令流程：UE发送SIP invite消息给P-CSCF/BAC；P-CSCF/BAC向PCF发送AAR消息。PCF响应AAA消息触发建专用QoS Flow的流程。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify request消息通知AMF创建语音专有Qos Flow。SMF响应Npcf_SMPolicyControl_UpdateNotify response消息。SMF向AMF发送Namf_Communication_N1N2MessageTransfer，消息中携带SM相关信息。AMF响应Namf_Communication_N1N2MessageTransfer response消息。AMF向NG-RAN发送N2 session request消息，通知NG-RAN建立语音QOS flow资源，NG-RAN拒绝语音QOS flow，响应N2 Session response消息，并携带IMS voice EPS fallback原因值。AMF向SMF发送Nsmf_PDUSession_UpdateSMContext request携带IMS voice EPS fallback原因值。SMF响应Nsmf_PDUSession_UpdateSMContext response消息。NG-RAN发起5GS to EPS HO流程。HO之后的TAU流程。PGW发起IMS语音专有承载创建流程。PGW向PCRF/PCF发送Npcf_SMPolicyControl_update request消息，消息中携带RAT-Type等信息，这些信息都是4G的信元。PCF之后向P-CSCF/BAC发送RAR消息，P-CSCF/BAC响应RAA消息。被叫侧信令流程：P-CSCF/BAC向UE发送SIP invite消息，UE向P-CSCF/BAC响应183；P-CSCF/BAC向PCF发送AAR消息。PCF响应AAA消息触发建专用QoS Flow的流程。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify request消息通知AMF创建语音专有Qos Flow。SMF响应Npcf_SMPolicyControl_UpdateNotify response消息。SMF向AMF发送Namf_Communication_N1N2MessageTransfer，消息中携带SM相关信息。AMF响应Namf_Communication_N1N2MessageTransfer response消息。AMF向NG-RAN发送N2 session request消息，通知NG-RAN建立语音QOS flow资源，NG-RAN拒绝语音QOS flow，响应N2 Session response消息，并携带IMS voice EPS fallback原因值。AMF向SMF发送Nsmf_PDUSession_UpdateSMContext request携带IMS voice EPS fallback原因值。SMF响应Nsmf_PDUSession_UpdateSMContext response消息。NG-RAN发起5GS to EPS HO流程。HO之后的TAU流程。PGW发起IMS语音专有承载创建流程。PGW向PCRF/PCF发送Npcf_SMPolicyControl_update request消息，消息中携带RAT-Type等信息，这些信息都是4G的信元。PCF之后向P-CSCF/BAC发送RAR消息，P-CSCF/BAC响应RAA消息。
信令流程|
####### 测试用例3–用户使用VoNR紧急呼叫 
测试条目|IMS紧急呼叫
---|---
预置条件|网络中各网元系统及操作维护台运行正常。EPC/5GC及PCRF配置IMS为默认承载。网络侧开启precondition。VoLTE用户A在IMS注册成功。被叫用户为LTE覆盖下的VoLTE用户B。PCF配置紧急呼叫VoLTE QoS 映射策略，基于AF-Application-identifier 、媒体类型等信息映射生成规则的优先级；映射流描述到指定的动态规则；根据P-CSCF（VoLTE  SBC）请求的AF-Application-identifier 、媒体类型等信息授权QCI；根据P-CSCF（VoLTE  SBC）请求的媒体部件的最大请求带宽授权语音、视频流的MBR、GBR；根据P-CSCF（VoLTE  SBC）请求的媒体子部件的流用途、RS-Bandwidth、RR-Bandwidth授权RTCP流的MBR、GBR；配置动态规则ARP授权原则，授权ARP=1。SMF/BSF已存储UE的会话绑定信息。在P-CSCF、DRA、PCF上正确配置主机名路由数据。
测试步骤|VoLTE用户A发起紧急音频呼叫。呼叫接通，通话一段时间后释放呼叫。
通过准则|被叫正常振铃，呼叫成功接通，并成功释放。信令流程符合要求。检查会话建立SIP消息流程，符合Precondition流程。检查Rx接口的AAR请求消息中，P-CSCF识别出紧急呼叫会话后，支持在Rx接口通过Service-URN=sos通知PCF执行紧急呼叫的承载控制策略。检查N7接口的Notify请求和响应消息中，PCF发起携带有QoS（QoS关键参数包含QCI，ARP，GBR和MBR）和事件触发信息的门控策略（共两个规则）发送请求至SMF/PGW，其中ARP=1。语音清晰流畅。
### 缩略语 
### 缩略语 
#### 3GPP 
3rd Generation Partnership Project第三代合作伙伴计划
#### 5GC 
5G Core Network5G核心网
#### 5QI 
5G QoS Indicator5G QoS指示
#### AAA 
Answer-Auth-Answer应答鉴权响应
#### AAR 
Answer-Auth-Request应答鉴权请求
#### AF 
Application Function应用功能
#### AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### APN 
Access Point Name接入点名称
#### ARP 
Allocation and Retention Priority分配保持优先级
#### ASR 
Abort-Session-Request中断会话请求
#### BSF 
Binding Support Function绑定支持功能
#### CHF 
Charging Function计费功能
#### CSFB 
Circuit Switched Fallback电路域回落
#### DNN 
Data Network Name数据网名称
#### DRA 
Diameter Routing AgentDiameter路由代理
#### EPC 
Evolved Packet Core演进的分组核心网
#### EPS 
Evolved Packet System演进的分组系统
#### eSRVCC 
Enhanced Single Radio Voice Call Continuity增强的双模单待无线语音呼叫连续性
#### FQDN 
Fully Qualified Domain Name完全限定域名
#### GBR 
Guaranteed Bandwidth Requested最大保证带宽
#### GCID 
GPRS Charging
IdentifierGPRS计费标识
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### GUI 
Graphical User Interface图形用户界面
#### ICID 
IM CN
subsystem charging identifierIM子系统计费标识
#### IMEISV 
International Mobile Equipment Identity and Software Version number国际移动设备识别码和软件版本号
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### IMSI 
International Mobile Subscriber Identity国际移动用户标识
#### IP 
Internet Protocol因特网协议
#### IPv4 
Internet Protocol Version 4互联网通信协议第四版
#### IPv6 
Internet Protocol Version 6互联网通信协议第六版
#### LTE 
Long Term Evolution长期演进
#### MBR 
Maximum Bandwidth Requested最大请求带宽
#### MPS 
Multimedia Priority Service多媒体优先业务
#### MSISDN 
Mobile Station International Subscriber Directory Number移动台国际用户目录号
#### NEF 
Network Exposure Function网络开放功能
#### NF 
Network Function网络功能
#### NR 
New Radio新无线
#### NRF 
NF Repository Function网络仓储功能
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCC 
Policy and Charging Control计费和策略控制
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PCF 
Policy Control Function策略控制功能
#### PCRF 
Policy and Charging Rules Function策略和计费规则功能
#### PDU 
Packet Data Unit分组数据单元
#### PEI 
Permanent Equipment Identifier永久设备标识
#### PGW 
PDN Gateway分组数据网网关
#### PLMN 
Public Land Mobile Network公共陆地移动网
#### QCI 
QoS Class IdentifierQoS类别标识
#### QoS 
Quality of Service服务质量
#### RAA 
Re-Auth-Answer重新鉴权响应
#### RAN 
Radio Access Network无线接入网
#### RAR 
Re-Auth-Request重新鉴权请求
#### RCP 
Resource Control Platform资源控制平台
#### RTCP 
Real-time Transport Control Protocol实时传输控制协议
#### RTP 
Real-time Transport Protocol实时传输协议
#### S-CSCF 
Serving-Call Session Control Function服务呼叫会话控制功能
#### S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
#### SBC 
Session Border Controller会话边界控制器
#### SDP 
Session Description Protocol会话描述协议
#### SIM 
Subscriber Identity Module用户识别卡
#### SIP 
Session Initiation Protocol会话发起协议
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### SRVCC 
Single Radio Voice Call Continuity单射频语音呼叫连续性
#### STA 
Session-Termination-Answer会话终止响应
#### STR 
Session-Termination-Request会话终止请求
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### UDR 
Unified Data Repository统一数据存储
#### UE 
User Equipment用户设备
#### UPF 
User Plane Function用户平面功能
#### URI 
Uniform Resource Identifier统一资源标识符
#### URN 
Uniform Resource Name统一资源名
#### VoIP 
Voice over Internet Protocol在IP协议上传送语音
#### VoLTE 
Voice over LTELTE语音
#### VoNR 
Voice over New Radio新空口承载语音
### ZUF-59-55-052 AF影响业务路由 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
PDU会话|UE通过SMF/UPF和数据网建立的一个连接，用于传输数据报文（Packet Data Unit）。
DNAI|数据网接入标识，PCF通过决策下发业务规则时可将用户业务引流到本地数据网络。
QoS|QoS是网络的一种安全机制，是用来解决网络延迟和阻塞等问题的一种技术。当网络过载或拥塞时，QoS能确保重要业务不受延迟或丢弃，同时保证网络的高效运行。
##### 描述 
####### 特性定义 
AF影响业务路由功能用于5GC向AF开放业务路由选择能力，将用户业务流路由到本地数据网络，从而减少传输时延、提升用户体验。
AF影响业务路由是5GC相比EPC的新增功能，是5GC能力开放和MEC的重要组成部分。
####### 背景知识 
未来5G网络数据流量密度和用户体验速率的急剧增长，除了对无线接入网带来极大挑战，核心网同样也经受着更大数据流量的冲击，因此需要启用AF业务本地分流，减轻核心网流量传输压力。 
5G提出的高可靠低时延应用场景（如车联网、工业控制）也需要启用AF业务本地分流，从而降低业务时延。 
AF种类和数量繁多，不同的AF业务有不同的本地分流要求，很难在5GC中预配置，因此需要向AF开放业务路由选择功能。 
##### 应用场景 
AF业务流量影响路由可作用于一个PDU会话（即有UE IP场景）或一组PDU会话（即无UE IP场景）。
有UE IP场景如果AF业务流量只影响一个PDU会话的业务路由，AF请求需要包含PDU会话的IP地址。对于单个PDU会话，AF直接发送业务影响路由请求给PCF或者通过NEF发送业务影响路由请求给PCF。请求内容包括受影响的业务，目标DNAI（数据网访问标识，该标识由AF提供或NEF通过AF提供目标位置信息产生），PCF构造PCC规则指示SMF选择/重新选择UPF，快速将用户业务引流到本地数据网处理。 
无UE IP场景如果AF业务流量影响一组PDU会话的业务路由，AF请求需要包含DNN和切片信息/用户组信息/用户标识，或者这些信息的组合，以过滤出受影响的PDU会话。对于一组PDU会话，AF请求通过NEF存储到UDR中，PCF向UDR订阅了相关业务路由数据通知。UDR收到AF请求后，通知已订阅的PCF，PCF构造PCC规则指示SMF选择/重新选择UPF，快速将用户业务引流到本地数据网处理。 
##### 客户收益 
受益方|受益描述
---|---
运营商|AF影响业务路由使得运营商能够向AF开放MEC能力，加速创新型业务的开发以及部署应用。AF影响业务路由能够实现AF业务本地分流，减轻核心网流量传输压力。
终端用户|AF影响业务路由能够通过AF业务本地分流优化AF业务传输路径，减少业务时延，提升用户体验。

##### 实现原理 

###### 系统架构 
AF影响业务路由功能用于5GC向AF开放业务路由选择能力，将用户业务分流到本地数据网络处理。
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元|描述
---|---
RCP|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策。向AMF提供接入和移动性策略。向SMF提供PDU会话策略。对AF业务进行策略授权。
SMF|向RCP提供PDU会话信息。从RCP获取PDU会话策略，下发给UPF执行。
UPF|执行PDU会话策略。
AF|向RCP提供应用层的业务信息，请求RCP进行策略授权。例如，对于VoNR（Voice over New Radio）业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给RCP。收到RCP授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力。对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
UDR|向PCF提供策略签约信息和业务影响路由信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
###### 业务流程 
根据AF业务路由请求影响的PDU会话范围，可以分为影响单PDU会话和影响多PDU会话两种应用场景，两种场景下的信令流程和所涉及的网元有所不同。
此外，AF业务路由请求中还可以订阅DNAI改变事件通知，收到此事件上报后，AF可能调整对UE的分布式服务。
######## AF影响路由选择涉及单个PDU会话 
[]images/1627874071369.png)流程说明如下：
0. SMF与RCP间建立PDU会话。 
AF影响业务路由有两种场景： 
A场景：AF通过NEF向RCP发起影响业务路由授权请求。 
B场景：授信的AF，不经过NEF直接向RCP发起影响业务路由授权请求。 
场景1A：
1a. 为了创建新的影响业务路由授权请求，AF调用Nnef_TrafficInfluence_Create向NEF发起HTTP POST请求。 
为了更新一个已存在的影响业务路由授权请求，AF调用 Nnef_TrafficInfluence_Update发送HTTP PUT或PATCH请求。 
为了删除一个已存在的影响业务路由授权请求，AF调用Nnef_TrafficInfluence_Delete发送HTTP DELETE 请求。 
1b. NEF收到AF请求后，对AF影响业务路由授权信息映射。 
1c. 如果NEF收到Nnef_TrafficInfluence_Create请求，在完成影响业务路由授权参数映射后，调用 Npcf_PolicyAuthorization_Create向RCP发起HTTP POST会话影响业务路由授权请求。 
如果NEF收到Nnef_TrafficInfluence_Update请求，在完成影响业务路由授权参数映射后，调用 Npcf_PolicyAuthorization_Update向RCP发起HTTP PATCH更新会话务影响路由授权请求。 
如果NEF收到Nnef_TrafficInfluence_Delete请求，调用Npcf_PolicyAuthorization_Delete 向RCP发起HTTP POST 删除会话授权请求。 
1d. RCP收到1c的授权请求后，存储相关影响业务路由信息，向NEF回复应答。 
1e. NEF向AF回复会话影响业务路由应答。 
场景1B：
1a. 为了创建新的影响业务路由授权请求，AF调用Npcf_PolicyAuthorization_Create向RCP发起HTTP POST请求。 
为了更新一个已存在的影响业务路由授权请求，AF调用 Npcf_PolicyAuthorization_Update发送HTTP PATCH请求。 
为了删除一个已存在的影响业务路由授权请求，AF调用Npcf_PolicyAuthorization_Delete发送HTTP POST请求。 
1b. RCP向AF回复影响业务路由授权应答。 
RCP根据步骤1存储的AF授权业务信息，并根据运营规划决策PCC规则，包括DNAI、订阅业务路由用户面路径变化事件通知等信息。 
RCP下发影响业务路由规则给SMF，SMF根据下发的DNAI等信息选择相应的UPF引流业务到本地数据网。 
3a. RCP调用Npcf_SMPolicyControl_UpdateNotify，包含构造好的影响业务路由规则，通过HTTP POST请求下发给SMF。 
3b. SMF向RCP回复更新通知应答。 
SMF收到业务路由用户面路径变化事件通知，根据场景1A、场景1B情况通知AF。 
场景4A（对应1A）：
4a. SMF 观察到订阅业务路由路径变化的PDU会话收到了用户面路径变化通知，调用Nsmf_EventExposure_Notify通过HTTP POST请求发送给NEF。 
4b. NEF 根据之前存储的参数关系（如AF事务内部标识转换为AF事务标识，SUPI转换为GPSI等），调用Nnef_TrafficInfluence_Notify 转发通知给AF。 
4c. AF回复通知应答给NEF。 
4d. NEF 将通知应答转发给SMF。 
场景4B（对应1B）：
4a. SMF 观察到订阅业务路由路径变化的PDU会话收到了用户面路径变化通知，调用Nsmf_EventExposure_Notify通过HTTP POST请求发送给AF。 
4b. AF 回复通知应答给SMF。 
######## AF影响路由选择涉及多个PDU会话 
AF影响路由选择涉及到多个PDU会话时，可能存在两种业务场景： 
PDU会话在AF影响业务路由存入UDR后建立。 
PDU会话在AF影响业务路由存入UDR前建立，或PDU会话建立后影响业务路由信息有变更。 
######## PDU会话建立前存在影响业务路由信息 
 
流程说明如下： 
AF通过NEF向UDR存储影响业务路由信息。 
1a. 为了创建新的影响业务路由信息，AF调用Nnef_TrafficInfluence_Create向NEF发起HTTP POST请求。 
为了更新一个已存在的影响业务路由信息，AF调用 Nnef_TrafficInfluence_Update发送HTTP PUT或PATCH请求。 
为了删除一个已存在的影响业务路由信息，AF调用Nnef_TrafficInfluence_Delete发送HTTP DELETE 请求。 
1b. NEF收到AF请求后，对影响业务路由信息映射。 
1c. 如果NEF收到Nnef_TrafficInfluence_Create请求，在完成影响业务路由参数映射后，调用 Nudr_DataRepository_Create向UDR发起HTTP POST存储影响业务路由信息。 
如果NEF收到Nnef_TrafficInfluence_Update请求，在完成影响业务路由参数映射后，调用 Nudr_DataRepository_Update向UDR发起HTTP PUT或PATCH更新存储影响业务路由信息。 
如果NEF收到Nnef_TrafficInfluence_Delete 请求，调用 Nudr_DataRepository_Delete 向RCP发起HTTP POST 删除影响业务路由信息。 
1d. UDR收到1c的授权请求后，存储相关影响业务路由信息，向NEF回复应答。 
1e. NEF向AF回复会话影响业务路由应答。 
SMF发起PDU会话创建请求，RCP从UDR获取影响业务路由信息，并根据运营规划决策PCC规则，包括DNAI、订阅业务路由用户面路径变化事件通知等信息，SMF根据下发DNAI等信息选择相应的UPF引流业务到本地数据网。 
2a. SMF为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收RCP下发的该SM策略关联策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
2b. 如果RCP本地没有该用户的策略签约信息，则向UDR获取该用户的策略签约信息，并向UDR订阅该用户的策略签约信息变更通知。 
2c. 如果RCP确定对该PDU会话策略控制需要用到该用户的影响业务路由信息，并且RCP本地没有该用户的影响业务路由信息，则RCP向UDR获取该用户的影响业务路由信息，并向UDR订阅该用户的影响业务路由信息变更通知。 
2d. RCP根据从UDR获取的影响业务路由信息，并根据运营规划决策PCC规则，包括DNAI、订阅业务路由用户面路径变化事件通知等信息。 
2e. RCP向SMF发送Npcf_SMPolicyControl_Create响应。 
SMF收到业务路由用户面路径变化事件通知： 
3a. SMF 观察到订阅业务路由路径变化的PDU会话收到了用户面路径变化通知，调用Nsmf_EventExposure_Notify 通过HTTP POST请求发送给NEF。 
3b. NEF 根据之前存储的参数关系（如AF事务内部标识转换为AF事务标识，SUPI转换为GPSI等），调用Nnef_TrafficInfluence_Notify 转发通知给AF。 
3c. AF回复通知应答给NEF。 
3d. NEF 将通知应答转发给SMF。 
######## PDU会话建立后产生影响业务路由信息 
[]images/1627874239815.png)流程说明如下： 
0. SMF与RCP间建立PDU会话。 
AF通过NEF向RCP发起影响业务路由授权请求。 
1a. 为了创建新的影响业务路由授权请求，AF调用Nnef_TrafficInfluence_Create向NEF发起HTTP POST请求。 
为了更新一个已存在的影响业务路由授权请求，AF调用 Nnef_TrafficInfluence_Update发送HTTP PUT或PATCH请求。 
为了删除一个已存在的影响业务路由授权请求，AF调用Nnef_TrafficInfluence_Delete发送HTTP DELETE 请求。 
1b. NEF收到AF请求后，对AF影响业务路由授权信息映射。 
1c. 如果NEF收到Nnef_TrafficInfluence_Create请求，在完成影响业务路由授权参数映射后，调用 Nudr_DataRepository_Create向UDR发起HTTP POST存储影响业务路由信息。 
如果NEF收到Nnef_TrafficInfluence_Update请求，在完成影响业务路由授权参数映射后，调用 Nudr_DataRepository_Update向UDR发起HTTP PUT或PATCH更新存储影响业务路由信息。 
如果NEF收到Nnef_TrafficInfluence_Delete 请求，调用 Nudr_DataRepository_Delete 向RCP发起HTTP POST 删除影响业务路由信息。 
1d. UDR收到1c的授权请求后，存储相关影响业务路由信息，向NEF回复应答。 
1e. NEF向AF回复会话影响业务路由应答。 
RCP从UDR收到影响业务路由信息后，并根据运营规划决策PCC规则，包括DNAI、订阅业务路由用户面路径变化事件通知等信息，SMF根据下发DNAI等信息选择相应的UPF引流业务到本地数据网。 
2a. UDR收到影响业务路由信息变更后，调用Nudr_DataRepository_Notify Request发送变更请求。 
2b. RCP收到UDR的变更通知后，存储业务引导路由信息，向UDR回复Nudr_DataRepository_Notify响应。 
2c. 对AF业务进行决策，构造PCC规则，包含DNAI和路径通知订阅信息。 
2d. RCP调用Npcf_SMPolicyControl_UpdateNotify 包含构造好的影响业务路由规则，通过HTTP POST请求下发给SMF。 
2e. SMF向RCP回复更新通知应答。 
SMF收到业务路由用户面路径变化事件通知： 
3a. SMF观察到订阅业务路由路径变化的PDU会话收到了用户面路径变化通知，调用Nsmf_EventExposure_Notify 发送通过HTTP POST请求给NEF。 
3b. NEF 根据之前存储的参数关系（如AF事务内部标识转换为AF事务标识，SUPI转换为GPSI等），调用Nnef_TrafficInfluence_Notify 转发通知给AF。 
3c. AF回复通知应答给NEF。 
3d. NEF 将通知应答转发给SMF。 
###### 本网元实现 
######## AF影响路由选择涉及单个PDU会话的实现 
影响业务路由层次AF影响业务路由分为AF会话级影响业务路由和媒体级影响业务路由：会话级影响业务路由影响业务路由信息携带在AF会话层次下，对该会话的所有流信息都生效。媒体级影响业务路由影响业务路由信息携带在AF会话的媒体层次下，只对该媒体下的所有流信息生效。AF影响业务路由信息的优先级：媒体级影响业务路由 > 会话级影响业务路由媒体携带了流信息，则该流规则携带媒体级的影响业务路由信息。媒体未携带流信息，但该AF会话携带了影响路由信息，则该流规则携带会话级的影响业务路由信息。媒体未携带流信息，且该AF会话也未携带影响路由信息，则该流规则不携带影响业务路由信息。 
授权业务映射授权业务映射与其它N5接口普通业务映射过程类似。RCP取策略授权请求的AF应用标识、媒体类型、流用途、流方向、流状态、赞助商标识、内容提供商标识等信息根据“AF应用标识映射配置”唯一映射出一个决策使用的应用标识，后续业务决策时对该应用进行业务决策，包括QoS决策、业务影响路由决策等信息。 
######## AF影响路由选择涉及多个PDU会话的实现 
影响业务路由触发时机使用全局变量（编号1212）配置用户是否通过UDR获取AF业务影响路由策略 ，默认值为0：  当全局开关为0时，用户不通过UDR获取业务影响路由策略。当全局开关为1时，用户通过UDR获取该用户的业务影响路由策略。用户获取签约后，RCP决定根据全局开关取值决定是否需要获取和订阅该用户的业务影响路由数据。 
影响业务路由配置映射通过UDR获取业务影响路由策略的授权业务映射与“AF影响路由选择涉及单个PDU会话的实现”中的“授权业务映射”类似：UDR返回的业务影响路由标识业务的字段包括：AF业务标识（afAppId）、业务流过滤信息（trafficFilters），这两个字段至少会携带一个。如果返回的业务影响路由为携带AF业务标识，可以取系统默认配置的AF业务标识，即从“授权配置”中的“默认AF应用标识配置”获取.UDR返回的业务影响路由中没有媒体类型、流用途、流状态、流方向等信息，通过“AF应用标识映射配置”映射决策业务标识时，媒体类型、流用途、流状态需要配置为OTHER(0xffffffff)，流方向配置为ALL(0xffffffff)，唯一映射出一个待决策使用的应用标识，后续业务决策时对该应用进行业务决策，包括QoS决策、业务影响路由决策等信息。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性基于N5接口和N36接口实现的，可参考ZUF-59-51-052 N5接口
 、ZUF-59-51-055 N36接口
。
##### 遵循标准 
标准类别|标准名称|标准用途
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System
3GPP|TS 23.502|Procedures for the 5G System
3GPP|TS 23.503|Policy and Charging Control Framework for the 5G System
3GPP|TS 29.512|Session Management Policy Control Service
3GPP|TS 29.514|Policy Authorization Service
##### 特性能力 
名称|指标
---|---
单PCC规则最大支持DNAI个数|8
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.21.10|首次发布。
####### License要求 
该特性为RCP网元的基本特性，无需License支持。
####### 对其他网元的要求 
本特性需要NEF/AF、UDR、SMF配合完成。
##### O&M相关 
####### 命令 
本特性涉及配置的变化可参考ZUF-59-51-052 N5接口
 、ZUF-59-51-055 N36接口
。
####### 性能统计 
该特性不涉及性能统计的变化。 
####### 告警和通知 
该特性不涉及告警和通知的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置基于无UE标识的流量引导申请 
###### 配置说明 
AF影响业务路由特性通过配置实现用户业务流路由到本地数据网络，从而减少传输时延、提升用户体验。
###### 配置前提 
AF影响业务路由特性是PCF、SMF以及UDR配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常。
###### 配置过程 
[]images/1627460643963.png)配置过程包含如下步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html)命令，配置HTTP客户端模板。
执行[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html)命令，配置HTTP服务端模板。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html)命令，配置关联的HTTP客户端模板。
执行[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html)命令，配置服务基础信息。
根据用户关键字配置对应的SUPI或者GPSI号段，两种方式二选一。
配置GPSI范围组执行ADD SBIGPSIRANGEARRID命令，配置GPSI范围组编号。执行ADD SBIGPSIRANGEARRPARAM命令，配置GPSI范围组参数。 
配置SUPI范围组执行ADD SBISUPIRANGEARRID命令，配置SUPI范围组编号。执行ADD SBISUPIRANGEARRPARAM命令，配置SUPI范围 
执行[ADD SBICHFINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220961.html)命令，配置UDR信息。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0节点。
执行[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html)命令，配置IPv6地址。
执行[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html)命令，配置IP端点。
执行[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html)命令，配置进行IP端点组编号。
执行[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html)命令，配置IP端点组参数。
执行[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html)命令，配置NF服务版本组编号。
执行[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html)命令，配置NF服务版本组参数。
执行[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html)命令，配置对端NF基本信息。
执行[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html)命令，配置对端NF扩展信息。
执行[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html)命令，配置对端NF实例。
执行[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html)命令，配置重选。
执行[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html)命令，配置服务发现方式。
执行[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html)命令，配置路由策略。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改系统全局变量1212值为1（用户级）。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改系统全局变量1002值为2（用户签约来源设置为UDR）。
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，配置应用标识。
执行[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html)命令，配置AF应用标识映射。
在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。 
###### 配置实例 
######## 场景说明 
UE无IP地址的业务影响路由是通过PCF与UDR之间的N36接口来传递业务影响路由策略，PCF下发业务影响路由策略给SMF。
######## 数据规划 
类别|参数|取值
---|---|---
HTTP客户端模板配置|编号|1
IP地址|HTTP客户端模板配置|4003::19:5
起始端口|HTTP客户端模板配置|20000
终止端口|HTTP客户端模板配置|30000
HTTP服务端模板配置|编号|1
IP地址|HTTP服务端模板配置|4003::19:5
端口|HTTP服务端模板配置|8080
关联HTTP客户端模板配置|服务类型|Nudr_DataRepository
HTTP IPv6模板ID|关联HTTP客户端模板配置|1
服务基础配置|服务类型|NPCF
Fqdn|服务基础配置|pcf.zte.com.cn
版本|服务基础配置|v1
优先级|服务基础配置|1
通知URI服务端模板配置（可选）|服务类型|Nudr_DataRepository
服务端模板ID1|通知URI服务端模板配置（可选）|1
GPSI范围组编号配置|GPSI范围组编号|100
GPSI范围组参数配置|配置索引|100
GPSI范围组编号|GPSI范围组参数配置|100
开始|GPSI范围组参数配置|0000000000000
结束|GPSI范围组参数配置|9999999999999
UDR信息配置|CHF信息编号|100
GPSI范围组编号|UDR信息配置|100
IPv6地址配置1|IPv6地址编号|100
IP地址|IPv6地址配置1|4004::19:3
IPv6地址配置2|IPv6地址编号|101
IP地址|IPv6地址配置2|4004::19:4
IP端点配置1|IP端点编号|100
端口|IP端点配置1|8080
IPv6地址编号|IP端点配置1|100
IP端点配置2|IP端点编号|101
端口|IP端点配置2|8080
IPv6地址编号|IP端点配置2|101
IP端点组编号配置1|IP端点组编号|100
IP端点组编号配置2|IP端点组编号|101
IP端点组参数配置1|配置索引|100
IP端点组编号|IP端点组参数配置1|100
IP端点编号|IP端点组参数配置1|100
IP端点组参数配置2|配置索引|101
IP端点组编号|IP端点组参数配置2|101
IP端点编号|IP端点组参数配置2|101
NF服务版本组编号配置|NF服务版本组编号|100
NF服务版本组参数配置|配置索引|100
NF服务版本组编号|NF服务版本组参数配置|100
API URI版本号|NF服务版本组参数配置|v1
API完整版本号|NF服务版本组参数配置|v1
对端NF基本信息配置1|对端NF信息编号|100
NF实例标识|对端NF基本信息配置1|100
NF类型|对端NF基本信息配置1|UDR
NF状态|对端NF基本信息配置1|REGISTERED
NF实例名称|对端NF基本信息配置1|260e6cfe-5eea-4036-8566-77744b5e7101
对端NF基本信息配置2|对端NF信息编号|101
NF实例标识|对端NF基本信息配置2|101
NF类型|对端NF基本信息配置2|UDR
NF状态|对端NF基本信息配置2|REGISTERED
NF实例名称|对端NF基本信息配置2|260e6cfe-5eea-4036-8566-77744b5e7199
对端NF扩展信息配置1|对端NF信息编号|100
UDR信息编号|对端NF扩展信息配置1|100
对端NF扩展信息配置2|对端NF信息编号|101
UDR信息编号|对端NF扩展信息配置2|100
对端NF实例配置1|配置索引|100
归属NF编号|对端NF实例配置1|100
服务实例标识|对端NF实例配置1|100
服务名称|对端NF实例配置1|nudr_dr
服务版本组编号|对端NF实例配置1|100
协议模式|对端NF实例配置1|HTTP
服务实例状态|对端NF实例配置1|REGISTERED
域名|对端NF实例配置1|udr1.zte.com.cn
IP端点组编号|对端NF实例配置1|100
优先级|对端NF实例配置1|1
对端NF实例配置2|配置索引|101
归属NF编号|对端NF实例配置2|101
服务实例标识|对端NF实例配置2|101
服务名称|对端NF实例配置2|nudr_dr
服务版本组编号|对端NF实例配置2|100
协议模式|对端NF实例配置2|HTTP
服务实例状态|对端NF实例配置2|REGISTERED
域名|对端NF实例配置2|udr2.zte.com.cn
IP端点组编号|对端NF实例配置2|101
优先级|对端NF实例配置2|2
重选配置|目的NF类型|全部
服务发现方式配置|目的NF类型|UDR_TYPE
发现方式|服务发现方式配置|STATIC_ONLY
地址选择方式|服务发现方式配置|RANDOM
http默认端口|服务发现方式配置|8080
https默认端口|服务发现方式配置|443
路由策略配置|目的NF类型|全部
NF类型|路由策略配置|PCF_TYPE
全局变量配置|全局变量1212|1
全局变量1002|全局变量配置|2
应用标识配置1|应用标识|1001
应用标识描述|应用标识配置1|1001
签约业务标识|应用标识配置1|1
签约业务标识描述|应用标识配置1|1
应用标识配置2|应用标识|1002
应用标识描述|应用标识配置2|1002
签约业务标识|应用标识配置2|2
签约业务标识描述|应用标识配置2|2
AF应用标识映射配置1|AFAI|1
应用标识|AF应用标识映射配置1|1001
AF应用标识映射配置2|AFAI|2
应用标识|AF应用标识映射配置2|1002
策略类型|控制条件|决策参数
---|---|---
N7业务策略|Gx应用标识1001|N7 PCC规则参数集1
Gx应用标识1002|N7业务策略|N7 PCC规则参数集2
######## 业务配置关系图 
[]images/%E4%B8%9A%E5%8A%A1%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB.png)
######## 配置步骤 
配置基础数据
配置HTTP客户端版本 
[ADD CLIENTPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220001.html):ID=1,IPADDR=4003::19:5,STARTPORT=20000,ENDPORT=30000,VPNID=0,CONNNUM=2,CONNELASTIC="SWITCH_ON",RESPBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2"
配置HTTP服务端版本 
[ADD SERVERPROFILE](../../CommonS_HTTP_LB\zh-cn\mml\1220005.html):ID=1,IPADDR=4003::19:5,PORT=8080,VPNID=0,REQBODYMAXLENGTH=204800,RESPTIMER=30,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",VERIFYCLI="SWITCH_OFF"
配置关联HTTP客户端模板 
[ADD SVCHTTPCLTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788138.html):ID=2,SERVICETYPE="NUDR_DR",HTTP4CLTID=0,HTTP6CLTID=1,HTTPS4CLTID=0,HTTPS6CLTID=0,HTURI="IP"
配置服务基础配置 
[ADD PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787186.html):SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf.zte.com.cn",PRIORITY=1,SERVERID="1",TOPHIDE="NOTHIDE",SCHEMA="HTTP"
（可选）配置通知URI服务端模板 
[ADD NOTIURISVRTPROF](../../Npcf_PolicyManagement\zh-CN\mml\1788170.html):SERVICETYPE="NUDR_DR",SVRID1=1
配置GPSI范围组编号 
[ADD SBIGPSIRANGEARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220693.html):ARRAYID=100
配置GPSI范围组参数 
[ADD SBIGPSIRANGEARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220697.html):INDEX=100,ARRAYID=100,START="0000000000000",END="9999999999999"
配置UDR信息 
[ADD SBIUDRINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220817.html):ID=100,GPSIRANGEARRAY=100
配置IPv6地址1 
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=100,IP="4004::19:3"
配置IPv6地址2 
[ADD SBIIPV6ADDR](../../CommonS_HTTP_LB\zh-cn\mml\1220645.html):ID=101,IP="4004::19:4"
配置IP端点1 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=100,IPV6=100,PORT=8080
配置IP端点2 
[ADD SBIIPENDPOINT](../../CommonS_HTTP_LB\zh-cn\mml\1220657.html):INDEX=101,IPV6=101,PORT=8080
配置IP端点组编号1 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=100
配置IP端点组编号2 
[ADD SBIIPENDPOINTARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220661.html):ARRAYID=101
配置IP端点组参数1 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=100,ARRAYID=100,IPENDPOINT=100
配置IP端点组参数2 
[ADD SBIIPENDPOINTARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220665.html):INDEX=101,ARRAYID=101,IPENDPOINT=101
配置NF服务版本组编号 
[ADD SBINFSVERSIONARRID](../../CommonS_HTTP_LB\zh-cn\mml\1220669.html):ARRAYID=100
配置NF服务版本组参数 
[ADD SBINFSVERSIONARRPARAM](../../CommonS_HTTP_LB\zh-cn\mml\1220673.html):INDEX=100,ARRAYID=100,APIVERSIONINURI="v1",APIFULLVERSION="v1"
配置对端NF基本信息1 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=100,NFINSTANCEID="100",NFTYPE="UDR_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7101",PRIORITY=1
配置对端NF基本信息2 
[ADD SBIPEERNFBASEINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220805.html):ID=101,NFINSTANCEID="101",NFTYPE="UDR_TYPE",NFSTATUS="REGISTERED",NFINSTANCENAME="260e6cfe-5eea-4036-8566-77744b5e7199",PRIORITY=2
配置对端NF扩展信息1 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=100,UDRINFO=100
配置对端NF扩展信息2 
[ADD SBIPEERNFEXTINFO](../../CommonS_HTTP_LB\zh-cn\mml\1220809.html):ID=101,UDRINFO=100
配置对端NF实例1 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=100,NFINDEX=100,SRVINSTANCEID="100",SERVICENAME="NUDR_DR",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="udr1.zte.com.cn",IPENDPOINTARRAY=100,PRIORITY=1
配置对端NF实例2 
[ADD SBIPEERNFSERVICEINSTANCE](../../CommonS_HTTP_LB\zh-cn\mml\1220813.html):INDEX=101,NFINDEX=101,SRVINSTANCEID="101",SERVICENAME="NUDR_DR",SERVICEVERSIONARRAY=100,SCHEME="HTTP",NFSERVICESTATUS="REGISTERED",FQDN="udr2.zte.com.cn",IPENDPOINTARRAY=101,PRIORITY=2
配置重选 
[ADD SBIRESELECT](../../CommonS_HTTP_LB\zh-cn\mml\1220517.html):TARGETNFTYPE="ALL"
配置服务发现方式 
[ADD SBISRVDISCOVERYMODE](../../CommonS_HTTP_LB\zh-cn\mml\1220535.html):TARGETNFTYPE="UDR_TYPE",DISCOVERYMODE="STATIC_ONLY",IPSELECTMODE="RANDOM",DEFAULTPORTFORHTTP=8080,DEFAULTPORTFORHTTPS=443
配置路由策略 
[ADD SBIROUTEPOLICY](../../CommonS_HTTP_LB\zh-cn\mml\1220531.html):TARGETNFTYPE="ALL",NFTYPE="PCF_TYPE"
配置1212全局变量 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1212,CURVAL="1",EXTFLAG=0
配置1002全局变量 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1002,CURVAL="2",EXTFLAG=0
配置应用标识 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1001",SUBSDESC="1001"
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="1002",SUBSID="1002",SUBSDESC="1002"
配置AF应用标识映射1 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=1,AFAI="3",MEDIATYPE="OTHER",FLOWUSE="OTHER",FLOWDIRECT="OTHER",FLOWSTATUS="ALL",SPID="N/A",ASPID="N/A",APPID=1001
配置AF应用标识映射2 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=2,AFAI="4",MEDIATYPE="OTHER",FLOWUSE="OTHER",FLOWDIRECT="OTHER",FLOWSTATUS="ALL",SPID="N/A",ASPID="N/A",APPID=1002
配置规则条件
配置Gx标识条件 
条件名称|参数|取值
---|---|---
GxAPPID1001|选择策略变量|其他
策略变量类别|GxAPPID1001|会话信息类
策略变量|GxAPPID1001|Gx应用标识
操作符|GxAPPID1001|=
值类型|GxAPPID1001|值
值|GxAPPID1001|1001
GxAPPID1002|选择策略变量|其他
策略变量类别|GxAPPID1002|会话信息类
策略变量|GxAPPID1002|Gx应用标识
操作符|GxAPPID1002|=
值类型|GxAPPID1002|值
值|GxAPPID1002|1002
配置规则动作参数
配置QoS参数集 
动作参数名称|参数名称|取值
---|---|---
N7QoS1|动作参数类型|QoS参数集
动作参数名称|N7QoS1|N7QoS1
QoS控制策略ID|N7QoS1|QoS1
5QI|N7QoS1|6
ARP优先级|N7QoS1|10
ARP抢占能力|N7QoS1|可以抢占
ARP被抢占能力|N7QoS1|可以被抢
N7QoS2|动作参数类型|QoS参数集
动作参数名称|N7QoS2|N7QoS2
QoS控制策略ID|N7QoS2|QoS2
5QI|N7QoS2|5
ARP优先级|N7QoS2|20
ARP抢占能力|N7QoS2|可以抢占
ARP被抢占能力|N7QoS2|可以被抢占
配置路由目的地参数集 
动作参数名称|参数名称|取值
---|---|---
TCRoute1|动作参数类型|路由目的地参数集
动作参数名称|TCRoute1|TCRoute1
DNAI|TCRoute1|dnai1
TCRoute2|动作参数类型|路由目的地参数集
动作参数名称|TCRoute2|TCRoute2
DNAI|TCRoute2|dnai2
配置TC参数集 
动作参数名称|参数名称|取值
---|---|---
N7RouteTC1|动作参数类型|TC参数集
动作参数名称|N7RouteTC1|N7RouteTC1
流量控制策略ID|N7RouteTC1|TC1
路由目的地|N7RouteTC1|TCRoute1
N7RouteTC2|动作参数类型|TC参数集
动作参数名称|N7RouteTC2|N7RouteTC2
流量控制策略ID|N7RouteTC2|TC2
路由目的地|N7RouteTC2|TCRoute2
配置N7业务决策动作参数 
动作参数名称|参数名称|取值
---|---|---
action_N7pcc1|动作参数类型|N7业务参数集
PCC规则名称|action_N7pcc1|N7pcc1
PCC规则类型|action_N7pcc1|动态规则
QoS控制策略ID|action_N7pcc1|N7QoS1
流量控制策略ID|action_N7pcc1|N7RouteTC1
action_N7pcc2|动作参数类型|N7业务参数集
PCC规则名称|action_N7pcc2|N7pcc2
PCC规则类型|action_N7pcc2|动态规则
QoS控制策略ID|action_N7pcc2|N7QoS2
流量控制策略ID|action_N7pcc2|N7RouteTC2
配置场景
配置N7业务策略规则 
规则名称|规则参数|参数取值
---|---|---
rule_serv1|优先级|10
动作类型|rule_serv1|参数填充
日志开关|rule_serv1|关闭
条件表达式|rule_serv1|GxAPPID1001
选中动作参数名称|rule_serv1|action_N7pcc1
rule_serv2|优先级|10
动作类型|rule_serv2|参数填充
日志开关|rule_serv2|关闭
条件表达式|rule_serv2|GxAPPID1002
选中动作参数名称|rule_serv2|action_N7pcc2
配置场景规则关联 
场景名称|参数|取值
---|---|---
TrafficInfluRole|入口1|入口类型|接入信息类
已选入口|TrafficInfluRole|入口1|接入类型
取值|TrafficInfluRole|入口1|3GPP接入
######## 配置脚本 
//配置Gx标识条件 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="GxAPPID1001",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="1001"
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="GxAPPID1002",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="1002"
//配置QoS参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS1"&"SYS.QOS_5QI"-"0"-"6"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"10"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS2"&"SYS.QOS_5QI"-"0"-"5"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"20"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
//配置路由目的地参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="TCRoute1",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"VALUE"-"dnai1";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="TCRoute2",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"VALUE"-"dnai2";
//配置TC参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC1",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC1"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"TCRoute1"
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC2",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC2"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"TCRoute2"
//配置N7业务决策动作参数 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc1",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc1"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC1"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS1"
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc2",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc2"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC2"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS2"
//配置N7业务策略规则 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv1",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{GxAPPID1001}",ACTTYPE="PARAM",ACTNAME="action_N7pcc1"
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv2",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{GxAPPID1002}",ACTTYPE="PARAM",ACTNAME="action_N7pcc2"
//配置场景规则关联 
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="TrafficInfluRole",ENTRANCE="SYS.ACCESS_TYPE"-"3GPP_ACCESS",RULENAME="rule_serv1"&"rule_serv2",VALIDFLAG="ENABLE";
##### 配置基于UE标识的流量引导申请 
###### 配置说明 
AF影响业务路由特性通过配置实现用户业务流路由到本地数据网络，从而减少传输时延、提升用户体验。
###### 配置前提 
AF影响业务路由特性是PCF、SMF以及UDR配合共同完成的，因此在配置此特性之前保证三个网元的功能及交互正常。
###### 配置过程 
[]images/1627460725990.png)配置过程包含如下步骤： 
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择Npcf_PolicyManagement_0节点。
执行[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html)命令，配置SPR邻接主机。
执行[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html)命令，配置用户（组）资料接入局。
执行[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html)命令，配置号码段分析。
执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html)命令，修改系统全局变量1002值为1（用户签约来源设置为SPR）。
执行[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html)命令，配置应用标识。
执行[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html)命令，配置AF应用标识映射。
在策略元素配置中自定义策略变量、条件、动作参数、场景和规则配置。 
###### 配置实例 
######## 场景说明 
基于UE标识的流量引导申请需要AF请求包含PDU会话的IP地址，AF直接发送业务影响路由请求给PCF或者通过NEF发送业务影响路由请求给PCF。请求内容包括受影响的业务，目标DNAI（数据网访问标识，该标识由AF提供或NEF通过AF提供目标位置信息产生），无需通过PCF与UDR之间的N36接口来传递业务影响路由信息，PCF构造PCC规则指示SMF选择/重新选择UPF，快速卸载用户业务流到本地数据网处理。
######## 数据规划 
类别|参数|取值
---|---|---
1002全局变量|参数值|1
邻接主机配置|邻接主机编号|1
主机名|邻接主机配置|spr.hatt.zte.com.cn
域名|邻接主机配置|hatt.zte.com.cn
邻接主机类型|邻接主机配置|SPR
邻接主机组编号|邻接主机配置|0
用户（组）资料接入局配置|用户（组）资料接入局配置编号|1
邻接主机编号|用户（组）资料接入局配置|1
签约和用量接口交互模式|用户（组）资料接入局配置|签约和用量都有交互
号码段分析配置|号码段分析类型|用户资料接入局IMSI分析
起始号码|号码段分析配置|000000000000000
结束号码|号码段分析配置|999999999999999
号码段分析结果|号码段分析配置|1
AF应用标识映射配置1|AFAI|1
应用标识|AF应用标识映射配置1|1001
AF应用标识映射配置2|AFAI|2
应用标识|AF应用标识映射配置2|1002
策略类型|控制条件|决策参数
---|---|---
N7业务策略|Gx应用标识1001|N7 PCC规则参数集1
Gx应用标识1002|N7业务策略|N7 PCC规则参数集2
######## 配置步骤 
配置基础信息
配置1002全局变量 
[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1002,CURVAL="1",EXTFLAG=0
配置邻接主机 
[ADD ADJHOST](../../Npcf_PolicyManagement\zh-CN\mml\1787004.html):ADJHOSTID=1,HOSTNAME=spr.hatt.zte.com.cn,REALM=hatt.zte.com.cn,HOSTTYPE=SPR,CONNECTDRA=NO
配置用户（组）资料接入局 
[ADD USERACC](../../Npcf_PolicyManagement\zh-CN\mml\1787391.html):ID=1,ADJHOSTID=1,ACTMODE=SUBS_USG
配置号码段分析 
[ADD NUMANA](../../Npcf_PolicyManagement\zh-CN\mml\1787171.html):ID=1,ANATYPE="USERACC_MSISDN",NUMBEGIN="0000000000000",NUMEND="9999999999999",RESULTID=1
配置Gx应用标识 
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1001,APPDESC="1001",SUBSID="1001",SUBSDESC="1001"
[ADD APPSUBS](../../Npcf_PolicyManagement\zh-CN\mml\1787138.html):APPID=1002,APPDESC="1002",SUBSID="1002",SUBSDESC="1002"
配置AF应用标识映射1 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=1,AFAI="1",MEDIATYPE="OTHER",FLOWUSE="OTHER",FLOWDIRECT="OTHER",FLOWSTATUS="ALL",SPID="N/A",ASPID="N/A",APPID=1001
配置AF应用标识映射2 
[ADD AFAPPMEDIA](../../Npcf_PolicyManagement\zh-CN\mml\1787033.html):ID=2,AFAI="2",MEDIATYPE="OTHER",FLOWUSE="OTHER",FLOWDIRECT="OTHER",FLOWSTATUS="ALL",SPID="N/A",ASPID="N/A",APPID=1002
配置规则条件
配置Gx标识条件 
条件名称|参数|取值
---|---|---
GxAPPID1001|选择策略变量|其他
策略变量类别|GxAPPID1001|会话信息类
策略变量|GxAPPID1001|Gx应用标识
操作符|GxAPPID1001|=
值类型|GxAPPID1001|值
值|GxAPPID1001|1001
GxAPPID1002|选择策略变量|其他
策略变量类别|GxAPPID1002|会话信息类
策略变量|GxAPPID1002|Gx应用标识
操作符|GxAPPID1002|=
值类型|GxAPPID1002|值
值|GxAPPID1002|1002
配置规则动作参数
配置QoS参数集 
动作参数名称|参数名称|取值
---|---|---
N7QoS1|动作参数类型|QoS参数集
动作参数名称|N7QoS1|N7QoS1
QoS控制策略ID|N7QoS1|QoS1
5QI|N7QoS1|6
ARP优先级|N7QoS1|10
ARP抢占能力|N7QoS1|可以抢占
ARP被抢占能力|N7QoS1|可以被抢
N7QoS2|动作参数类型|QoS参数集
动作参数名称|N7QoS2|N7QoS2
QoS控制策略ID|N7QoS2|QoS2
5QI|N7QoS2|5
ARP优先级|N7QoS2|20
ARP抢占能力|N7QoS2|可以抢占
ARP被抢占能力|N7QoS2|可以被抢
配置路由目的地参数集 
动作参数名称|参数名称|取值
---|---|---
TCRoute1|动作参数类型|路由目的地参数集
动作参数名称|TCRoute1|TCRoute1
DNAI|TCRoute1|dnai1
路由配置标识|TCRoute1|1
IPV6地址|TCRoute1|4003::19:3
端口|TCRoute1|8080
TCRoute2|动作参数类型|路由目的地参数集
动作参数名称|TCRoute2|TCRoute2
DNAI|TCRoute2|dnai2
路由配置标识|TCRoute2|2
IPV6地址|TCRoute2|4004::19:3
端口|TCRoute2|8081
配置TC参数集 
动作参数名称|参数名称|取值
---|---|---
N7RouteTC1|动作参数类型|TC参数集
动作参数名称|N7RouteTC1|N7RouteTC1
流量控制策略ID|N7RouteTC1|TC1
路由目的地|N7RouteTC1|TCRoute1
N7RouteTC2|动作参数类型|TC参数集
动作参数名称|N7RouteTC2|N7RouteTC2
流量控制策略ID|N7RouteTC2|TC2
路由目的地|N7RouteTC2|TCRoute2
配置N7业务决策动作参数 
动作参数名称|参数名称|取值
---|---|---
action_N7pcc1|动作参数类型|N7业务参数集
PCC规则名称|action_N7pcc1|N7pcc1
PCC规则类型|action_N7pcc1|动态规则
QoS控制策略ID|action_N7pcc1|N7QoS1
流量控制策略ID|action_N7pcc1|N7RouteTC1
action_N7pcc2|动作参数类型|N7业务参数集
PCC规则名称|action_N7pcc2|N7pcc2
PCC规则类型|action_N7pcc2|动态规则
QoS控制策略ID|action_N7pcc2|N7QoS2
流量控制策略ID|action_N7pcc2|N7RouteTC2
配置场景
配置N7业务策略规则 
规则名称|规则参数|参数取值
---|---|---
rule_serv1|优先级|10
动作类型|rule_serv1|参数填充
日志开关|rule_serv1|关闭
条件表达式|rule_serv1|GxAPPID1001
选中动作参数名称|rule_serv1|action_N7pcc1
rule_serv2|优先级|10
动作类型|rule_serv2|参数填充
日志开关|rule_serv2|关闭
条件表达式|rule_serv2|GxAPPID1002
选中动作参数名称|rule_serv2|action_N7pcc2
配置场景规则关联 
场景名称|参数|取值
---|---|---
TrafficInfluRole|入口1|入口类型|接入信息类
已选入口|TrafficInfluRole|入口1|接入类型
取值|TrafficInfluRole|入口1|3GPP接入
######## 配置脚本 
//配置Gx标识条件 
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="GxAPPID1001",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="1001"
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="GxAPPID1002",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="1002"
//配置QoS参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS1"&"SYS.QOS_5QI"-"0"-"6"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"10"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7QoS2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"QoS2"&"SYS.QOS_5QI"-"0"-"5"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"20"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"PREEMPTABLE";
//配置路由目的地参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="TCRoute1",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"VALUE"-"dnai1"&"SYS.ROUTE_PROF_ID"-"VALUE"-"1"&"SYS.DNAI_IPV6_ADDR"-"VALUE"-"4003::19:3"&"SYS.DNAI_PORT_NUMBER"-"VALUE"-"8080";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="TCRoute2",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"VALUE"-"dnai2"&"SYS.ROUTE_PROF_ID"-"VALUE"-"2"&"SYS.DNAI_IPV6_ADDR"-"VALUE"-"4004::19:3"&"SYS.DNAI_PORT_NUMBER"-"VALUE"-"8081";
//配置TC参数集 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC1",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC1"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"TCRoute1"
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="N7RouteTC2",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"TC2"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"TCRoute2"
//配置N7业务决策动作参数 
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc1",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc1"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC1"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS1"
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="action_N7pcc2",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"N7pcc2"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_TC_ID"-"0"-"N7RouteTC2"&"SYS.N7_PCC_QoS_ID"-"0"-"N7QoS2"
//配置N7业务策略规则 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv1",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{GxAPPID1001}",ACTTYPE="PARAM",ACTNAME="action_N7pcc1"
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="rule_serv2",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{GxAPPID1002}",ACTTYPE="PARAM",ACTNAME="action_N7pcc2"
//配置场景规则关联 
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="TrafficInfluRole",ENTRANCE="SYS.ACCESS_TYPE"-"3GPP_ACCESS",RULENAME="rule_serv1"&"rule_serv2",VALIDFLAG="ENABLE";
##### 测试用例 
测试项目|基于无UE标识的流量引导申请
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP已完成“配置实例”中基础数据配置及策略配置。
测试过程|SMF发消息给RCP建立PDU会话。RCP向UDR获取流量引导数据，返回AFAI为3。UDR通知RCP有新的流量引导数据，通知消息中携带AFAI为4。
通过准则|SMF与RCP间建立PDU会话。RCP根据流量引导数据生成PCC规则，下发AFAI为3对应的TCRoute1信息。UDR通知RCP有新的流量引导数据，RCP根据新的流量引导数据生成PCC规则，下发AFAI为4对应的TCRoute2信息。
测试项目|基于UE标识的流量引导申请
---|---
预置条件|RCP运行正常，与周边NF通讯正常。RCP已完成“配置实例”中基础数据配置及策略配置。
测试过程|SMF发消息给RCP建立PDU会话。AF向RCP发起HTTP POST请求，携带AFAI为3、AFAI为4及对应的媒体信息。
通过准则|SMF与RCP间建立PDU会话。RCP根据AF携带的流量引导数据生成PCC规则，下发TCRoute1、TCRoute2对应信息。
### 缩略语 
### 缩略语 
#### 5GC 
5G Core Network5G核心网
#### AF 
Application Function应用功能
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### DNAI 
DN Access Identifier数据网络接入标识符
#### DNN 
Data Network Name数据网名称
#### EM 
Element Management网元管理
#### EPC 
Evolved Packet Core演进的分组核心网
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### HTTP 
Hypertext Transfer Protocol超文本传输协议
#### IMS 
IP Multimedia SubsystemIP多媒体子系统
#### MEC 
Mobile Edge Computing移动边缘计算
#### NEF 
Network Exposure Function网络开放功能
#### NF 
Network Function网络功能
#### P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
#### PCC 
Policy and Charging Control计费和策略控制
#### PCF 
Policy Control Function策略控制功能
#### PDU 
Packet Data Unit分组数据单元
#### QoS 
Quality of Service服务质量
#### RCP 
Resource Control Platform资源控制平台
#### SDP 
Session Description Protocol会话描述协议
#### SIP 
Simple Internet Protocol简单IP协议
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### UDR 
Unified Data Repository统一数据存储
#### UPF 
User Plane Function用户平面功能
#### VoNR 
Voice over New Radio新空口承载语音
### ZUF-59-55-053 UE无感分流策略控制 
#### 特性描述 

#### 特性描述 


 

##### 术语 
术语|含义
---|---
双域|指公网（ToC）域和专网（ToB）域。
公网业务|指ToC用户终端访问互联网的业务，使用的是访问互联网业务的通用DNN。
专网业务|指ToB企事业单位、政务系统仅对特定人群开放的、访问其专网的业务，例如：校园、医院、政务、文旅等。这类业务通常采用专用DNN承载，存在跨省漫游的业务需求。
通用DNN会话|由UE发起的会话建立，可用于访问互联网业务，UE和网络侧都感知该会话。
专用DNN会话（又名专网DNN会话）|由网络侧检测UE访问的专网业务报文触发建立的会话，用于访问专网业务，UE不感知该会话。
##### 描述 
####### 定义 
为提升双域专网漫游场景下的业务体验，满足用户无感知访问公网及内网的业务需求，提出了无感分流策略控制功能，该功能需要： 
RCP网元支持基于签约等信息，在N7接口传递指定的URL、APN/DNN和切片等无感分流策略信息给SMF/P-GW网元。 
RCP网元支持在用户激活流程、RCP网元发起的更新流程中下发无感分流策略信息给SMF/P-GW网元，下发方式均为全覆盖模式，不支持修改操作。 
RCP网元支持删除无感分流策略信息。针对N7接口，支持通过显性方式（在通知消息中将对应的无感分流策略信息置NULL）通知SMF网元。 
RCP网元支持基于签约管理、配置无感分流策略相关信息。 
####### 背景知识 
随着5G专网业务不断拓展，越来越多场景提出ToB/ToC双域专网需求，运营商希望利用5G网络与目前已有的WiFi网络协同（或替代已有WiFi），解决公专网协同访问问题，涉及校园、医院、政务、文旅等多个行业。 
##### 应用场景 
本特性有如下应用场景： 
签约专网的用户能在本地访问园区内网及互联网，公专网流量分别计费，主要场景为校园、医疗（办公）、工厂（办公）等。 
签约专网的用户能在外地访问园区内网及互联网，公专网流量分别计费，主要场景为政府工作人员在外地访问政务网等。 
##### 客户收益 
受益方|受益描述
---|---
运营商|解决公专网协同访问问题。
用户|用户“不换卡、不换号”，通过5G终端访问园区内网及互联网“双域”网络。

##### 实现原理 


 

###### 系统架构 
本特性涉及的系统架构如[图1](1675754831971.html#zc002989e358145749be296f377ee03d7__3dcb90fb-9198-46f2-81e4-9f65f6bb1fb8)所示。RCP作为PCF，无感分流流程中主要和SPR、SMF发生交互。
图1  系统架构
[]images/5gc%E7%89%B9%E6%80%A7-%E6%9E%B6%E6%9E%84%E5%9B%BE-pcf.png)
###### 涉及的网元 
网元|说明
---|---
RCP|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向RCP提供UE接入信息，从RCP获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向RCP提供PDU会话信息，从RCP获取PDU会话控制策略，下发给UPF执行。
UPF|对用户面数据报文执行SMF下发的PDU会话控制策略。
AF|向RCP提供应用层的业务信息，请求RCP进行策略授权。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|RCP收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和RCP的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的RCP。
UDR/SPR|向RCP提供用户的策略签约信息，并允许RCP将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向RCP提供消费门限信息，例如告诉RCP某用户的月累计流量是否超过了特定门限。
###### 业务流程 
######## SM策略关联建立流程 
[]images/sm%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E5%BB%BA%E7%AB%8B%E6%B5%81%E7%A8%8B.png)流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向PCF发送Npcf_SMPolicyControl_Create请求，请求中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /npcf-smpolicycontrol/v1/sm-policies:authority: PCF主机:端口，端口可选，默认80，主机可以是IPv4、IPv6或FQDN，例如[2409:8069:5003:803::2:121]:80
pduSessionType|PDU会话类型，取值IPV4、IPV6、IPV4V6等。
pduSessionId|PDU会话标识，整型，取值范围0～255。supi+pduSessionId唯一定位一个PDU会话。
dnn|数据网名称（Data Network Name），等同于EPC中的APN。
sliceInfo|切片信息，其中包含S-NSSAI（Single Network Slice Selection Assistance Information，单个网络切片选择辅助信息）。
notificationUri|通知URI，即SMF后续发送SM策略更新通知请求（SMPolicyControl.UpdateNotify.request）的URI地址。
supi|签约用户永久标识（Subscriber Permanent Identifier），例如IMSI，紧急呼叫时可不携带。
gpsi|一般公共签约用户标识（Generic Public Subscription Identifier），例如MSISDN。
pei|永久设备标识PEI（Permanent Equipment Identifier），例如IMEISV。
subsSessAmbr|签约的会话聚合带宽（Subscribed Session AMBR）。
subsDefQos|签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp。
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type。
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN等，类似于Gx接口的RAT-Type。
servingNetwork|接入网的PLMN ID，类似于Gx接口的3GPP-SGSN-MCC-MNC。
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号guami：全局唯一AMF标识对4G接入，包含：anGWAddr：SGW的IP地址对2/3G接入，包含：sgsnAddr：SGSN的IP地址
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置eutraLocation：4G（含NBIOT）接入位置utraLocation：3G接入位置geraLocation：2G接入位置n3gaLocation：非3GPP接入位置
smfId|SMF的NF实例编号。
recoveryTime|SMF重启时间戳。
ipv4Address|UE的IPv4地址。
ipv6AddressPrefix|UE的IPv6地址前缀。
ipDomain|IP域，当存在UE IPv4地址池重叠时，ipDomain + ipv4Address应当唯一。
suppFeat|支持特性列表，16进制数字串，对应的2进制数字串的每位代表N7接口的一个可选特性，个位代表第一个特性，十位代表第二个特性，以此类推。每位设置为0，表示不支持该特性；设置为1，表示支持该特性。具体特性列表参见3GPP 29.512的5.8章节。SMF在Create请求中提供其所支持的特性列表全集，PCF在Create响应中提供协商后的特性列表，为PCF支持特性列表和SMF支持特性列表的交集。
accNetChId|缺省QoS Flow或整个PDU会话的接入网计费标识。包含如下参数：accNetChaIdValue：接入网计费标识取值refPccRuleIds：关联PCC规则，会话粒度的计费标识不用携带此参数sessionChScope：是否会话粒度的计费标识
chargEntityAddr|接入网计费地址，包含IPv4或IPv6地址或两者都有：anChargIpv4Addr：接入网计费地址IPv4anChargIpv6Addr：接入网计费地址IPv6
online|指示PDU会话是否开启在线计费。
offline|指示PDU会话是否开启离线计费。
qosFlowUsage|缺省QoS Flow的用途，取值：GENERAL：通用IMS_SIG：用于IMS信令
对5G接入，SMF在SM策略关联建立请求中通常不携带UE IP地址信息，而是在N7会话建立后选择UPF，SMF分配UE地址，再通过SM策略关联更新请求上报PCF。 
对4G接入，SMF一般会在SM策略关联建立请求中携带UE IP地址。 
如果RCP判断对该PDU会话策略控制需要用到该用户的SPR签约信息，并且RCP本地没有该用户的SPR签约信息，则RCP向SPR发生Sp接口UDR消息，请求获取该用户的签约信息。 
SPR在Sp接口UDA中返回用户签约。 
RCP再向SPR发送Sp'接口UDR消息，请求获取该用户的用量信息。 
SPR在Sp'接口UDA中返回用户用量。 
RCP根据会话接入信息、用户签约、用量信息等进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。如果会话是通用数据会话（比如dnn为cmnet），还会根据用户签约的套餐信息进行多DNN决策，生成多DNN策略。 
向SMF发送Npcf_SMPolicyControl_Create响应，响应消息的HTTP头域Location字段中包含RCP为此SM策略关联生成的ResourceURI，json正文除正常的会话，业务决策之外，还会包含多DNN策略相关参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 201 Created —— http头域的status类似于diameter响应的Result-Code:location: {authority}/npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}，其中smPolicyId为PCF根据supi+pduSessionId+时间戳等信息生成的SM策略关联ID，例如：http://[2409:8069:5003:803::2:121]:80/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f
sessRules|SessionRule列表。
pccRules|PccRule列表。
qosDecs|QoSData列表。
chgDecs|ChargingData列表。
traffContDecs|TrafficControlData列表。
umDecs|UsageMonitoringData列表。
qosChars|QosCharacteristics列表。
conds|ConditionData列表。
chargingInfo|计费信息，主要包含：primaryChfAddress：首选CHF地址，FQDN格式的URI。secondaryChfAddress：次选CHF地址，FQDN格式的URI。
MulDNNSessRules|MulDNNSessRule列表，每个MulDNNSessRule包括：MulDNNSessRuleId：网络侧多DNN会话方案对应规则的规则名称。serviceURL：网络侧多DNN会话方案对应规则中业务的URL信息，网关侧在检测到该URL对应业务的时候，需基于serviceDNN或serviceNSSAI建立相关会话信息。serviceDNN：网络侧多DNN会话方案对应规则中业务触发建立会话时所使用的DNN信息。serviceNSSAI：网络侧多DNN会话方案对应规则中业务触发建立会话时所使用的切片信息。MulDNNSessRules下发的方式为全量下发。
online|指示PDU会话是否开启在线计费。
offline|指示PDU会话是否开启离线计费。
revalidationTime|重授权时间点，SMF到该时间点时需要再向PCF发送SM策略关联更新请求。
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求。
lastReqRuleData|RequestedRuleData列表。
lastReqUsageData|用于PCF向SMF查询用量，包含：refUmIds：相关UmId。allUmIds：所有UmId。refUmIds和allUmIds二选一使用。
ipv4Index|IPv4地址索引，用于指导SMF选择IPv4地址池。
ipv6Index|IPv6地址索引，用于指导SMF选择IPv6地址池。
suppFeat|PCF/SMF协商支持的特性列表，为PCF支持特性列表和SMF支持特性列表的交集。
######## SMF发起的SM策略关联修改流程 
[]images/smf%E5%8F%91%E8%B5%B7%E7%9A%84sm%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B.png)流程说明如下： 
当PCF订阅的事件发生时（例如PCF向SMF订阅了PLMN change事件后，UE移动导致用户接入的PLMN发生了变化），SMF向PCF发送Npcf_SMPolicyControl_Update请求，携带SM策略关联ID、事件号及事件相关信息。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/update，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./update:authority: PCF主机:端口
policyCtrlReqTriggers|策略控制请求事件触发器列表，当相关事件满足时，SMF需要再向PCF发送SM策略关联更新请求。
notificationUri|通知URI，即SMF后续接收PCF为该SM策略关联下发的SM策略更新通知请求(SMPolicyControl.UpdateNotify.request)的URI地址。
subsSessAmbr|签约的会话聚合带宽（Subscribed Session AMBR）。
subsDefQos|签约的缺省QoS（Subscribed Default QoS），其中包含5qi和arp。
accessType|接入类型，取值为3GPP_ACCESS或NON_3GPP_ACCESS，类似于Gx接口的IP-CAN-Type。
ratType|无线接入类型，取值NR/EUTRA/UTRA/GERA/NBIOT/WLAN等，类似于Gx接口的RAT-Type。
servingNetwork|接入网的PLMN ID，类似于Gx接口的3GPP-SGSN-MCC-MNC。
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号。guami：全局唯一AMF标识。对4G接入，包含：anGWAddr：SGW的IP地址。对2/3G接入，包含：sgsnAddr：SGSN的IP地址。
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置。eutraLocation：4G（含NBIOT）接入位置。utraLocation：3G接入位置。geraLocation：2G接入位置。n3gaLocation：非3GPP接入位置。
userLocationInfoTime|SMF获取userLocationInfo的NTP时间。
ueTimeZone|UE所在时区。
ipv4Address|UE的IPv4地址。
relIpv4Address|释放的IPv4地址。
ipv6AddressPrefix|UE的IPv6地址前缀。
relIpv6AddressPrefix|释放的Ipv6地址前缀。
addIpv6AddrPrefixes|增加的多个IPv6地址前缀。
addRelIpv6AddrPrefixes|释放的多个IPv6地址前缀。
ipDomain|IP域，当存在UE IPv4地址池重叠时，ipDomain + ipv4Address应当唯一。
accNetChId|缺省QoS Flow或整个PDU会话的接入网计费标识。包含如下参数：accNetChaIdValue：接入网计费标识取值。refPccRuleIds：关联PCC规则，会话粒度的计费标识不用携带此参数。sessionChScope：是否会话粒度的计费标识。
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-Key。volUsage：流量使用量。volUsageUplink：上行流量使用量。volUsageDownlink：下行流量使用量。timeUsage：时长使用量。nextVolUsage：下个流量使用量（在monitoringTime之后的使用量）。nextVolUsageUplink：下个上行流量使用量（在monitoringTime之后的使用量）。nextVolUsageDownlink：下个下行流量使用量（在monitoringTime之后的使用量）。nextTimeUsage：下个时长使用量（在monitoringTime之后的使用量）。
appDetectionInfos|应用探测信息列表，每个appDetectionInfo包含：appId：应用标识。instanceId：应用实例编号。sdfDescriptions：业务流描述。
ruleReports|ruleReport列表，每个ruleReport主要包含：pccRuleIds：PCC规则标识。ruleStatus：PCC规则状态。failureCode：PCC规则失败码。
sessRuleReports|sessRuleReport列表，每个sessRuleReport主要包含：ruleId：会话规则标识。ruleStatus：会话规则状态。sessRuleFailureCode：会话规则失败码。
PCF根据最新的会话接入信息、用户签约及用量信息重新进行策略决策，可能更新SM策略。 
PCF向SMF发送Npcf_SMPolicyControl_Update响应，响应消息中可能携带更新后的多DNN策略。 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK:location: update响应的http头域Location字段为空
SmPolicyDecision相关参数|参考“SM策略关联建立流程”Create响应的SmPolicyDecision相关参数。
MulDNNSessRules|参考“SM策略关联建立流程”Create响应的MulDNNSessRules相关参数。
如果此次流程中SMF上报了用量，则PCF累计出最新的用量（例如当月用户总流量），并可以通过Sp'接口UDR消息更新到SPR，以便下次PDU会话建立时PCF能够从SPR取回再用于策略决策。 
SPR回复Sp'接口UDA消息。 
######## PCF发起的SM策略关联修改流程 
[]images/pcf%E5%8F%91%E8%B5%B7%E7%9A%84sm%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E4%BF%AE%E6%94%B9%E6%B5%81%E7%A8%8B.png)流程说明如下： 
PCF收到内部事件触发（如时段切换）或外部事件触发（如SPR通知PCF某用户的策略签约信息发生了变更），重新进行SM策略决策。如果决策出的SM策略发生变化，则PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify通知，其中包含最新的SM策略；如果会话是通用数据会话（比如dnn为cmnet），还会根据用户签约的套餐信息进行多DNN决策，生成多DNN策略，如果PCF决策出的多DNN策略发生变化，则PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify通知，其中包含最新的多DNN策略。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: {notificationUri}/update，{notificationUri}为SMF在Create请求中提供的notificationUri，例如：/nsmf-pdusession/v1/sm-contexts/sessionId-0000000013580c71026b/update:authority: SMF的主机:端口
resourceUri|SMF策略关联URI，和Creae响应http头域Location字段分配的resourceUri一致。
smPolicyDecision|SM策略，具体参数参见“SM策略关联建立流程”Create响应参数。
MulDNNSessRules|参考“SM策略关联建立流程”Create响应的MulDNNSessRules相关参数。
SMF执行最新的SM策略，向PCF发送Npcf_SMPolicyControl_UpdateNotify响应。响应消息中包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:status: 200 OK或204 No Content或400 Bad Request。
UeCampingRep|如果PCF在UpdateNotify中订阅了ACC_TY_CH、PLMN_CH、SAREA_CH、SCELL_CH等事件，SMF在UpdateNotify响应回复200 OK时可选携带UeCampingRep，提供UE最新接入信息，包含：accessType：接入类型。ratType：无线接入类型。servNfId：接入网关标识。servingNetwork：接入网络。userLocationInfo：用户位置信息。ueTimeZone：UE所在时区。netLocAccSupp：是否支持网络位置查询。
PartialSuccessReport|SMF回复200 OK但部分策略安装失败时携带PartialSuccessReport，包括如下参数：failureCause：失败原因。ruleReports：PCC规则报告。sessRuleReports：会话规则报告。ueCampingRep：UE位置信息。policyDecFailureReports：包含一组PolicyDecisionFailureCode，取值如下：TRA_CTRL_DECS_ERR：业务流控制决策错误。QOS DECS_ERR：QoS决策错误。CHG DECS_ERR：计费决策错误。USA_MON_DECS_ERR：用量监控决策错误。QOS_MON_DECS_ERR：QoS监控决策错误。CON_DATA_ERR：条件数据错误。
ErrorReport|如果PCF下发的全部策略在SMF安装或执行失败，SMF回复400 Bad Request，并携带ErrorReport，包含如下参数：error：含具体失败信息ProblemDetails。ruleReports：PCC规则报告。sessRuleReports：会话规则报告。
######## SMF发起的SM策略关联终止流程 
[]images/smf%E5%8F%91%E8%B5%B7%E7%9A%84sm%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E7%BB%88%E6%AD%A2%E6%B5%81%E7%A8%8B.png)流程说明如下： 
在UE或SMF发起的PDU会话释放流程中，SMF查找到某PDU会话有相关的SM策略关联，向PCF发送Npcf_SMPolicyControl_Delete请求，请求PCF删除SM策略关联。请求中携带SM策略关联ID，可能还包含最后用量上报（即SM策略关联删除前SMF统计到用户已使用但SMF但还未上报的用量）。 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: /npcf-smpolicycontrol/v1/sm-policies/{smPolicyId}/delete，例如/npcf-smpolicycontrol/v1/sm-policies/ims-gpsi_8618287920067.11682ba252e3054f./delete:authority: PCF主机:端口
servNfId|包含接入网元（AMF或SGW或SGSN）信息。对5G接入，包含下面2个参数之一或全部：servNfInstId：AMF的NF实例编号。guami：全局唯一AMF标识。对4G接入，包含：anGWAddr：SGW的IP地址。对2/3G接入，包含：sgsnAddr：SGSN的IP地址。
userLocationInfo|UE位置信息，类似于Gx接口的3GPP-User-Location-Info。包含如下参数：nrLocation：5G接入位置。eutraLocation：4G（含NBIOT）接入位置。utraLocation：3G接入位置。geraLocation：2G接入位置。n3gaLocation：非3GPP接入位置。
userLocationInfoTime|SMF获取userLocationInfo的NTP时间。
ueTimeZone|UE所在时区。
accuUsageReports|AccuUsageReport列表，每个AccuUsageReport代表SMF上报的一份累计用例，每个AccuUsageReport主要包含：umId：用量监控标识，类似于Gx接口的Montioring-Key。volUsage：流量使用量。volUsageUplink：上行流量使用量。volUsageDownlink：下行流量使用量。timeUsage：时长使用量。nextVolUsage：下个流量使用量（在monitoringTime之后的使用量）。nextVolUsageUplink：下个上行流量使用量（在monitoringTime之后的使用量）。nextVolUsageDownlink：下个下行流量使用量（在monitoringTime之后的使用量）。nextTimeUsage：下个时长使用量（在monitoringTime之后的使用量）。
pduSessRelCause|PDU会话释放原因。可选，取值：PS_TO_CS_HO：sRVCC切换。
PCF向SMF发送Npcf_SMPolicyControl_Delete响应。 
参数|说明
---|---
HTTP Header关键参数|204  No Content
如果Npcf_SMPolicyControl_Delete请求中有最后用量上报，PCF通过Sp'接口UDR消息将最后用量上报给SPR。 
SPR回复Sp'接口UDA消息。 
如果PCF确定此PDU会话结束后，PCF已不需要为该用户接收SPR策略签约变更通知（PCF本地已无该用户的其它会话），则PCF向SPR发送Sp接口UDR消息，通知SPR该用户在本PCF下线。 
SPR回复Sp接口UDA消息。 
######## PCF发起的SM策略关联终止流程 
[]images/pcf%E5%8F%91%E8%B5%B7%E7%9A%84sm%E7%AD%96%E7%95%A5%E5%85%B3%E8%81%94%E7%BB%88%E6%AD%A2%E6%B5%81%E7%A8%8B.png)流程说明如下： 
PCF收到内部事件（如套餐过期）或外部事件（如SPR删除用户签约，通过Sp接口PNR消息通知PCF）。PCF进行策略决策，确定需要终止相关的SM策略关联。PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify通知，包含如下关键参数： 
参数|说明
---|---
HTTP Header关键参数|:method: POST:scheme: http 或https:path: {notificationUri}/terminate，{notificationUri}为SMF在Create请求中提供的notificationUri:authority: SMF的主机:端口
resourceUri|SMF策略关联URI，和“SM策略关联建立流程”Creae响应http头域Location字段分配的resourceUri一致。
cause|PCF终止SM策略关联的原因。
SMF向PCF回复Npcf_SMPolicyControl_UpdateNotify响应。 
参数|说明
---|---
HTTP Header关键参数|204  No Content。
后续流程同“[SMF发起的SM策略关联终止流程](1675754831971.html#zdfb5247cfa544355897fd68e1c50d091__cd5e7e9d-6e02-4a87-bebf-e44ef5d926bb)”。
###### 本网元实现 
######## 公网DNN的配置 
运营商要求仅针对公网会话（比如cmnet会话）需要下发分流策略，其他DNN不应该下发分流策略。系统需要区分哪些会话是公网会话，哪些会话是专网会话。 
系统在DNN属性配置表中增加无感分流公网DNN标识字段，可以支持通过此配置表将某个DNN配置为配置为公网DNN。如果某个DNN未在此配置表中被配置为公网DNN，则被认为是非公网DNN。 
######## 专网会话和公网会话的区分 
新增会话类型业务键，以便后续决策中使用，会话类型获取逻辑： 
如果当前会话是Gx会话，该会话为“普通会话”，如果当前会话是N7会话，继续下面的判断。 
如果无感分流功能开关（1379开关）未开启，该会话为“普通会话”；如果开启了，继续下面的判断。 
如果在DNN属性配置表中将该DNN配置为“PUBDNN”，该会话为“公网会话”；如果未配置，继续下面的判断。 
如果在套餐无感分流策略配置表中配置了对应DNN索引，该会话为“专网会话”。 
如果上述步骤都没匹配到，则该会话为“普通会话”。 
######## 公网N7数据会话决策流程 
判断无感分流功能是否开启（增加全局开关控制），如果开启，则继续下面的流程。如果未开启，则不进行公网DNN会话决策，不下发无感分流策略。 
判断会话是否是公网会话，如果不是公网会话，则不进行公网DNN会话决策，不下发无感分流策略。如果是公网会话，则继续下面的流程。 
针对用户所有签约的在有效期内的有效套餐，逐一套餐查询配置表，获取套餐对应的业务分流策略。如果有匹配的内容，记录规则名称，查询是否已经决策出来，没有则新增。 
由于接口限制一个会话最多下发5个分流规则，如果签约套餐最后对应的分流规则超过5个，则取前5个下发，并且上报warning到流程跟踪中，增加对应的内部统计。 
######## 专网N7数据会话决策流程 
目前规范中，认为创建新会话流程对于N7接口及PCF/PCRF网元均无特殊要求，遵守现有3GPP标准流程即可。 
不需要考虑专网会话和公网会话之间的策略联动，也不需要汇聚到一个PCF处理。 
PCF对非专网会话的决策流程按照目前正常流程进行。 
######## 向SMF下发无感分流策略的方式 
当PCF决策出无感分流策略后，通过在N7接口消息中携带“MulDNNSessRules”字段进行下发，“MulDNNSessRules”字段中携带的内容来源于网管上的无感分流策略配置。 
如：网管上配置了无感分流策略为 ADD PKGSHUNT:RULENAME="PKGSHUNT1",PKGID="100",DNN="cmnet",SST=1,SD="NULL",SERVICEURL1="IPv4-_-192.168.1.11/14"，当N7会话携带公网DNN上线时，获取签约，并且当匹配上对应规则时，下发的“MulDNNSessRules”字段为： 
`    "MulDNNSessRules" : {
         "PKGSHUNT1" : {
             "MulDNNSessRuleId" : "PKGSHUNT1",
             "serviceURL" : [ "IPv4-_-192.168.1.11/14" ],
             "serviceDNN" : "cmnet",
             "serviceNSSAI" : {
                 "sst" : 1
             }
         }
     }` 
当N7会话未携带公网DNN或未匹配上规则时，不下发“MulDNNSessRules”字段。 
在N7会话更新流程中，如果决策出的无感分流策略匹配结果发生了新增、修改或删除，在更新响应中下发新的规则，对端SMF网元进行全量更新，即丢弃之前的规则，只保存这次新下发的规则。 
如：上线时下发了无感分流策略“PKGSHUNT1”，又在更新消息中仅下发了无感分流策略“PKGSHUNT2”，那么更新后规则“PKGSHUNT1”会被删除，只保留规则“PKGSHUNT2”。 
当N7会话更新决策出删除所有无感分流策略时，下发“MulDNNSessRules”字段为： 
`    "MulDNNSessRules" : null` 
######## 无感分流策略中SERVICEURL字段配置规则 
当在网管上配置无感分流策略时，针对4个SERVICEURL字段，格式要求如下： 
该字段支持携带包括IP（段）、FQDN、URL等多种流描述信息。每个serviceURL仅携带一类流描述信息，但可携带多个流信息，每个流信息使用“;”作为分隔符，支持“*”通配符。每类流描述信息增加标识符（目前支持4类标识符：“IPv4-_-”、“IPv6-_-”、“FQDN-_-”、“URL-_-”）说明，标识符不区分大小写。可以多个serviceURL都携带同一种类型的流描述信息。 
IPv4：标识符为“IPv4-_-”，IPv4段格式支持“X.X.X.X/Y” 和“from X.X.X.X to X.X.X.Y”两种模式，其中/Y为掩码长度（可选）。当IPV4地址段为from ... to ...格式时，严格要求‘from’与‘to’关键字和IP地址之间只能有一个英文空格。支持“*”作为通配符。不同的IP地址之间通过“;”分割。输入的X.X.X.X，X.X.X.Y地址需要满足IPV4地址格式。 
IPv6：标识符为“IPv6-_-”，IPv6段格式支持“X:X:X::X/Y”和“from X:X:X::X to X:X:X::Y”两种模式，其中/Y为前缀长度（可选）。当IPV6地址段为from ... to ...格式时，严格要求‘from’与‘to’关键字和IP地址之间只能有一个英文空格。支持“*”作为通配符。不同的IP地址之间通过“;”分割。输入的X:X:X::X，X:X:X::Y地址需要满足IPV6地址格式。 
FQDN：标识符为“FQDN-_-”，FQDN应该只包含"a-z"，"A-Z"，"0-9"，"-"，".",“*”，不同的FQDN之间通过“;”分割。 
URL：标识符为“URL-_-”，URL格式非常多，暂无固定格式。 
######## 无感分流策略配置变更后能及时生效（可选功能） 
正常系统级策略变更之后，系统对于原先已下发策略的用户，需要等用户由于其他请求导致决策时，修改后的策略才能对此用户生效。 
由于目前数据会话变更频率较低，运营商希望配置变更之后，能及时通知用户更新策略。 
经过前期和运营商的沟通，运营商认为可以先根据设备能力来配，PCF系统暂定先配置一天2个时间点主动触发策略更新。 
当前系统已支持套餐优先级决策，可以通过套餐优先级决策引用时段的方式来达到触发签约此套餐的用户策略更新的目的。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该功能只有N7数据会话支持。 
该功能受1379开关控制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|TS 23.501|System Architecture for the 5G System (R15)
3GPP|TS 23.502|Procedures for the 5G System (R15)
3GPP|TS 23.503|Policy and Charging Control Framework for the 5G System (R15)
3GPP|TS 29.512|Session Management Policy Control Service
##### 特性能力 
名称|指标
---|---
无感分流策略限制|每个会话最多下发5个无感分流策略，每条无感分流策略中最多4个URL，单URL长度限制为5000，4个URL总长度限制也为5000。
PCF最多可配置无感分流策略|20000
PCF最多可配置的向NRF注册的DNN个数|1024
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.22.20.B3|首次发布
####### License要求 
该特性为RCP网元的基本特性，无需License支持。 
####### 对其他网元的要求 
SMF版本需要支持无感分流功能。 
SPR需要开启记录多PCF地址功能。 

##### O&M相关 


 

###### 命令 
######## 配置项 
命令项|命令名称|描述
---|---|---
套餐无感分流策略配置|ADD PKGSHUNT|新增套餐无感分流策略配置
SET PKGSHUNT|套餐无感分流策略配置|修改套餐无感分流策略配置
DEL PKGSHUNT|套餐无感分流策略配置|删除套餐无感分流策略配置
SHOW PKGSHUNT|套餐无感分流策略配置|查询套餐无感分流策略配置
SHOW ALLPKGSHUNT|套餐无感分流策略配置|查询所有套餐无感分流策略配置
 说明： 
本配置中的字段大小写不做转换，下发内容与配置内容一致。 
命令项|命令名称|描述
---|---|---
DNN属性配置|ADD DNNATTR|新增PUBLICDNN字段，无感分流公网DNN标识。
######## 全局变量 
参数编号|参数名称|英文名称|显示方式|最小值|最大值|缺省值|用途
---|---|---|---|---|---|---|---
1379|无感分流功能开关|Switch of senseless shunting function|隐藏|0|1|0|0-关闭；1-打开
######## 动态管理 
SHOW_DPI_IPCAN_SESS查看N7会话信息，可查到下发的多DNN会话规则，再根据规则名查询“套餐无感分流策略配置”，可获得详细规则内容。 
SHOW_SYS查看系统信息，可查到当前无感分流专载会话个数。 
###### 性能统计 
该特性不涉及计数器的变化。 
###### 告警和通知 
告警名称|描述
---|---
3340370213 配置表容量一级负荷|配置表R_PKGSHUNT容量告警。
3341418789 配置表容量二级负荷|配置表R_PKGSHUNT容量告警。
3342467365 配置表容量三级负荷|配置表R_PKGSHUNT容量告警。
3343515941 配置表容量四级负荷|配置表R_PKGSHUNT容量告警。
###### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
#### 特性配置 

#### 特性配置 


 


##### 配置特性 


 

###### 配置说明 
无感分流策略控制特性配置主要是配置DNN属性和套餐到无感分流规则的对应关系，用户携带公网DNN上线之后，PCF从SPR获取用户套餐ID，本地匹配无感分流策略，以及详细信息。 
###### 配置前提 
无感分流策略下发需要RCP、SMF、SPR配合完成。因此在配置此特性之前需保证RCP、SMF和SPR网元的功能和交互正常。 
###### 配置过程 
图1  无感分流策略配置过程
[]images/ue%E6%97%A0%E6%84%9F%E5%88%86%E6%B5%81%E7%AD%96%E7%95%A5%E6%8E%A7%E5%88%B6.png)
配置过程包含如下几个步骤： 
全局开关配置 
要实现无感分流策略下发，需要将无感分流功能开关1379打开。 
在EM客户端中，执行[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1379,CURVAL="1"命令。
DNN属性配置 
在EM客户端中，执行[ADD DNNATTR](../../Npcf_PolicyManagement\zh-CN\mml\1789089.html)命令，配置DNN属性配置。
套餐配置 
在EM客户端中，执行[ADD PKGINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787190.html)命令，配置套餐基本信息。
无感分流策略配置 
在EM客户端中，执行[ADD PKGSHUNT](../../Npcf_PolicyManagement\zh-CN\mml\1789100.html)命令，配置套餐无感分流策略。
策略配置 
在EM客户端的策略管理页面，配置策略，包括条件、动作参数、场景和规则配置。 
DNN配置 
如果SMF需要通过专网DNN服务发现PCF，在EM客户端中，执行[ADD DNN](../../Npcf_PolicyManagement\zh-CN\mml\1788107.html)命令，配置向NRF注册的专网DNN信息。
###### 配置实例-PCF可以在N7接口下发公网分流规则 
######## 配置场景 
已配置套餐100、200对应的无感分流策略PKGSHUNT1、PKGSHUNT2，当用户携带公网DNN建立N7会话建立，签约业务套餐100、200，PCF下发无感分流策略PKGSHUNT1、PKGSHUNT2，以及其他对应业务等规则。 
######## 数据规划 
配置规划参见下表： 
类别|参数|取值
---|---|---
DNN属性配置|DNN值|cmnet
类型|DNN属性配置|PUBDNN
套餐|编号|100
套餐类型|套餐|业务套餐
无感分流策略|规则名称|PKGSHUNT1
套餐标识|无感分流策略|100
DNN|无感分流策略|multi_gzyd5goa
SST|无感分流策略|1
SD|无感分流策略|NULL
业务URL1|无感分流策略|IPv4-_-192.168.1.11
业务URL2|无感分流策略|URL-_-www.10086.com.cn
策略规划参见下表： 
类别|场景入口|条件|动作参数
---|---|---|---
套餐优先级规则|业务套餐=100|时间在3:00~15:00之间|套餐动态优先级=100
######## 配置步骤 
配置基础信息
全局开关配置 
打开无感分流功能开关。 
SET SYS GLOBPARA:IDX=1379,CURVAL="1"; 
DNN属性配置 
ADD DNNATTR:DNN="cmnet",DIP="YES",PUBLICDNN="PUBDNN" ； 
DNN配置 
ADD DNN:ID=1,DNN="multi_gzyd5goa"; 
套餐配置 
ADD PKGINFO:PKGID="100",PRIORITY=100,PKGATTR="SERVICE_PKG"； 
套餐对应的无感分流策略配置 
ADD PKGSHUNT:RULENAME="PKGSHUNT1",PKGID="100",DNN="multi_gzyd5goa",SST=1,SD="NULL",SERVICEURL1="IPv4-_-192.168.1.11",SERVICEURL2="URL-_-www.10086.com.cn"； 
（可选）时间配置 
ADD DM TIME:NAME="time3~15",PERIOD="NORMAL",PKGID="",STIME=03:00,ETIME=14:59; 
时段名称|参数|取值
---|---|---
time3~15|属性|正常
起始时间|time3~15|3:00:00
结束时间|time3~15|16:59:59
（可选）条件配置 
ADD DM COND:NAME="time3~15",SVCKEY="SYS.TIME",OPERATOR="TimeIn",VALTYPE="VALUE",VALUE="time3~15"; 
条件名称|参数|取值
---|---|---
time3~15|选择策略变量|其他
策略变量类别|time3~15|系统类
策略变量|time3~15|时间
操作符|time3~15|TimeIn
参考值|time3~15|time3~15
（可选）动作配置 
ADD DM ACTION:NAME="pkgpri",TYPE="PKG_PRIOR",PARAMS="SYS.PKG_DYNM_PRIORITY"-"VALUE"-"100"; 
动作参数名称|参数名称|取值
---|---|---
pkgpri|参数类型|套餐动态属性参数集
套餐动态优先级|pkgpri|100
（可选）规则配置 
新增套餐优先级规则，决策结果为套餐优先级100，这个规则的目的是为了将套餐和时段关联起来。 
规则里面引用两个时段：05:00~11:00，17:00~23:00。 
ADD DM RULE:NAME="pkgprirule",PLCTYPE="PKG_PRIOR",PRIOR=100,CONDEXP="{time3~15}",ACTTYPE="PARAM",ACTNAME="pkgpri",LOGFLAG="OFF",RULENO=0; 
规则名称|参数|取值
---|---|---
pkgprirule|优先级|100
动作类型|pkgprirule|参数填充
策略类型|pkgprirule|套餐动态优先级策略
日志开关|pkgprirule|关
条件表达式|pkgprirule|{time3~15}
动作参数名称|pkgprirule|pkgpri
（可选）场景配置 
ADD DM ROLE:NAME="role1",ENTRANCE="SYS.SERV_PAK_ID"-"100",RULENAME="pkgprirule",VALIDFLAG="ENABLE"; 
场景名称|参数|取值
---|---|---
role1|入口1|入口类型|用户信息类
已选入口|role1|入口1|业务套餐
取值|role1|入口1|100
策略类型|role1|套餐动态优先级策略|pkgprirule
##### 测试用例 
测试条目|PCF可以在N7接口下发公网分流规则
---|---
预置条件|RCP系统正常运行。前后台通讯正常，RCP策略管理正常运行。RCP和SMF、SPR之间通讯正常。EM客户端上按照“配置实例-PCF可以在N7接口下发公网分流规则” 进行配置。|RCP系统正常运行。前后台通讯正常，RCP策略管理正常运行。RCP和SMF、SPR之间通讯正常。EM客户端上按照“配置实例-PCF可以在N7接口下发公网分流规则” 进行配置。|RCP系统正常运行。前后台通讯正常，RCP策略管理正常运行。RCP和SMF、SPR之间通讯正常。EM客户端上按照“配置实例-PCF可以在N7接口下发公网分流规则” 进行配置。|RCP系统正常运行。前后台通讯正常，RCP策略管理正常运行。RCP和SMF、SPR之间通讯正常。EM客户端上按照“配置实例-PCF可以在N7接口下发公网分流规则” 进行配置。
测试步骤|用户上线携带DNN为cmnet。PCF向SPR获取签约信息，签约套餐100、200。|用户上线携带DNN为cmnet。PCF向SPR获取签约信息，签约套餐100、200。|用户上线携带DNN为cmnet。PCF向SPR获取签约信息，签约套餐100、200。|用户上线携带DNN为cmnet。PCF向SPR获取签约信息，签约套餐100、200。
通过准则|用户携带cmnet上线，RCP向SMF下发无感分流策略MulDNNSessRuleId携带PKGSHUNT1、PKGSHUNT2，以及对应的业务规则N7pccrule1。|用户携带cmnet上线，RCP向SMF下发无感分流策略MulDNNSessRuleId携带PKGSHUNT1、PKGSHUNT2，以及对应的业务规则N7pccrule1。|用户携带cmnet上线，RCP向SMF下发无感分流策略MulDNNSessRuleId携带PKGSHUNT1、PKGSHUNT2，以及对应的业务规则N7pccrule1。|用户携带cmnet上线，RCP向SMF下发无感分流策略MulDNNSessRuleId携带PKGSHUNT1、PKGSHUNT2，以及对应的业务规则N7pccrule1。
信令流程|信令流程|信令流程|信令流程|信令流程
## 高可用类特性 
### ZUF-59-56-002 地理容灾 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
容灾RCP|指与本地RCP配置相同、版本相同的对等RCP，两个RCP之间互为主备。
热备容灾|指RCP互为对端的容灾RCP。热备容灾的RCP间通过建立同步链路，实时备份用户数据。当某个RCP故障时，会短暂影响此RCP上用户的业务。
冷备容灾|指RCP互为对端的容灾RCP，冷备容灾的RCP间没有同步链路，不进行用户数据的实时备份。当某个RCP故障时，不会影响用户的业务。
##### 描述 
####### 定义 
容灾系统是指在容灾RCP间，当一个RCP出现故障时，容灾系统中其他RCP能承接故障RCP的业务功能。容灾RCP间根据是否需要实时备份用户数据，分成2类容灾：冷备容灾、热备容灾。
冷备容灾组网冷备容灾组网如图1所示。图1  冷备容灾组网 
热备容灾组网热备容灾组网如图2所示。图2  热备容灾组网 
####### 背景知识 
通信网络的特征要求电信设备具有高的可靠性。RCP是用户的策略决策生成网元。当电源故障、人为因素、火灾、雷击、爆炸、地震、水灾等导致RCP发生故障时，则会影响用户业务。 
因此，运营商通常对RCP进行容灾建设，使得RCP能够不中断地为用户提供服务。目前RCP支持冷备和热备两种容灾模式。 
##### 应用场景 
热备容灾热备容灾，主要用于保障RCP系统运行的可靠性和策略控制的连续性。此功能完全顺从现有3GPP PCC的架构。热备容灾的使用场景：正常场景：系统正常运行，实时同步备份相关用户数据。故障场景：系统异常故障时，实现容灾切换。 
冷备容灾冷备容灾要求对端网元能发起会话重建，保证业务和通话在重新激活之后都能正常使用。会话激活是自动的，用户无感知。 
##### 客户收益 
收益方|收益描述
---|---
运营商|热备：当一个RCP故障时，与其热备的RCP的能够接管相关的用户会话且保持策略控制的连续性，提升了RCP系统的可靠性。冷备：当一个RCP故障时，对端网元与其冷备的RCP交互，触发新建会话，保证业务和通话在重新激活后能正常使用。
终端用户|当一个RCP故障时，用户无感知，业务能正常使用。
##### 实现原理 
###### 系统架构 
容灾模式|RCP个数|工作模式|优点|缺点|推荐原则
---|---|---|---|---|---
冷备|2|1+1主备|部署简单维护（如：升级、扩容）简单快捷部署成本低部署运营商网络最多，维护经验最丰富的冷备组网|故障之后，故障局在线会话数据会丢失，需要通过新建会话来恢复|当出现以下场景时，推荐该组网：运营商不要求热备用户数据运营商要求主用局可用时，容灾局不工作
2|冷备|1+1互备|部署简单维护（如：升级、扩容）简单快捷部署成本低|故障之后，故障局在线会话数据会丢失，需要通过新建会话来恢复|当出现以下场景时，推荐该组网：运营商不要求热备用户数据运营商强调正常情况下，主用局容灾局设备都工作
N+M<=8|冷备|N+M|组网灵活|故障之后，故障局在线会话数据会丢失，需要通过新建会话来恢复|当出现以下场景时，推荐该组网：运营商不要求热备用户数据运营商规划多套PCF组Pool场景
热备|2|1+1主备|可保证容灾场景下业务连续性部署简单部署运营商网络最多，维护经验最丰富的热备组网|由于主备容灾局间存在用户数据同步，对承载网质量要求高|当出现以下场景时，推荐该组网：运营商要求热备用户数据时运营商要求主用局可用时，容灾局不工作
2|热备|1+1互备|可保证容灾场景下业务连续性部署简单|由于主备容灾局间存在用户数据同步，对承载网质量要求高|当出现以下场景时，推荐该组网：运营商要求热备用户数据运营商强调正常情况下，主用局容灾局设备都工作
N+M<=8|热备|N+M|可保证容灾场景下业务连续性组网灵活|部署复杂维护复杂（如：升级、扩容需要针对所有RCP进行操作）|当满足以下条件时，推荐该组网：运营商要求热备用户数据运营商规划多套PCF组Pool场景
####### 冷备容灾 
两个冷备容灾的RCP之间，没有数据同步。 
######### 1+1主备冷备容灾 
1+1主备冷备容灾组网如[图3](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z3e29d1722fb6446ea8e66afcdffac006__edf2b05e-bd4f-4306-8978-f44962df0149)所示，RCP1是主用RCP，RCP2是容灾RCP。
图3  1+1主备冷备容灾
[]images/image.png)
正常情况RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求消息（通过直连链路或通过DRA链路）给RCP1。RCP2不处理任何业务。RCP1和RCP2之间无链路，不同步用户数据。 
故障情况RCP1故障时，RCP2将接替RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求（通过直连链路或通过DRA链路）给RCP2，不再发消息给RCP1。RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，则返回失败响应给对端网元。 
 说明： 
RCP2故障时，对已有会话流程无任何影响。 
######### 1+1互备冷备容灾 
1+1互备冷备容灾组网如[图4](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z3e29d1722fb6446ea8e66afcdffac006__ccec681e-1411-4208-a77d-ff59fd96992b)所示，RCP1和RCP2同时处于工作状态，互相为对方的容灾局。
图4  1+1互备冷备容灾
[]images/1622770411688.png)
正常情况RCP1和RCP2均为对端网元提供策略控制功能。对端网元（PGW/DRA/AF/SMF/AMF）根据配置的用户IMSI/MSISDN号段，选择将业务请求消息发送（通过直连链路或通过DRA链路）给RCP1或RCP2。RCP1和RCP2之间无链路，不同步用户数据。 
故障情况RCP1故障时，RCP2将接替RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求（通过直连链路或通过DRA链路）给RCP2，而不再发消息给RCP1。当RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，则返回失败响应给对端网元。 
 说明： 
RCP2故障时，处理逻辑与RCP1故障时类似。 
####### 热备容灾 
两个热备容灾的RCP之间，通过建立容灾链路实现用户数据的实时备份。 
######### 1+1主备热备容灾 
1+1主备热备容灾组网如[图5](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z41b209d5bdfa4c328c178744832d076c__4a721c2e-ef0b-41c9-81af-7de2460f766c)所示，RCP1是主用RCP，RCP2是容灾RCP。
图5  1+1主备热备容灾
[]images/1622770730569.png)
正常情况RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求消息（通过直连链路或通过DRA链路）给RCP1。RCP2不处理任何业务。RCP1和RCP2之间有容灾链路，需要互相同步用户数据。 
故障情况RCP1故障时，RCP2将接替RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求消息（通过直连链路或通过DRA链路）给RCP2，不再发消息给RCP1。当RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，可以正常处理。 
故障恢复当RCP1恢复之后，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求（通过直连链路或通过DRA链路）给RCP1或者RCP2。当RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，回复重定向响应消息给对端网元，或者直接将消息转发给RCP1处理。 
 说明： 
主备模式，RCP2故障时对已有会话流程无任何影响。 
######### 1+1互备热备容灾 
1+1互备热备容灾组网如[图6](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z41b209d5bdfa4c328c178744832d076c__70dbe9fa-89f0-40bc-a10d-90ace866a471)所示，RCP1和RCP2同时处于工作状态，互相为对方的容灾局。
图6  1+1互备热备容灾
[]images/1622770828639.png)
正常情况RCP1和RCP2均为对端网元提供策略控制功能。对端网元（PGW/DRA/AF/SMF/AMF）根据配置的用户IMSI/MSISDN号段，选择将业务请求消息发送（通过直连链路或通过DRA链路）给RCP1或RCP2。同一个用户的多个会话消息，可能会被对端网元发送到不同的RCP。如果非锚定RCP收到了此用户的会话消息，会通过重定向功能通知对端网元消息应该发送给用户第一个会话锚定的RCP，或者直接将消息转发给用户第一个会话锚定的RCP进行处理。RCP1和RCP2之间有链路，RCP之间需要互相同步用户数据。 
故障情况RCP1故障时，RCP2将接替RCP1为对端网元提供策略控制功能，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求消息（通过直连链路或通过DRA链路）给RCP2，不再发消息给RCP1。当RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，可以正常处理。 
故障恢复当RCP1恢复之后，所有对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求（通过直连链路或通过DRA链路）给RCP1或者RCP2。当RCP2收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，回复重定向响应消息给对端网元，或者直接将消息转发给RCP1处理。 
 说明： 
互备模式，RCP2故障时的处理逻辑与RCP1类似。 
######### 组Pool（N+M）热备容灾 
组Pool（N+M）热备容灾组网如[图7](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z41b209d5bdfa4c328c178744832d076c__8a16bb28-afc5-4d4f-a0f9-4c41ab768897)所示，RCP1、RCP2、RCP3、RCP4同时处于工作状态，互相为对方的容灾局。
图7  组pool（N+M）热备容灾
[]images/1622770991632.png)
正常情况RCP1、RCP2、RCP3、RCP4均为对端网元提供策略控制功能。对端网元（PGW/DRA/AF/SMF/AMF）可以根据配置的用户IMSI/MSISDN号段，来选择将业务请求消息发送（通过直连链路或通过DRA链路）给RCP1或RCP2、RCP3、RCP4。同一个用户的多个会话消息，可能会被对端网元发送到不同的RCP。如果非锚定RCP收到了此用户的会话消息，会通过重定向功能通知对端网元消息应该发送给用户第一个会话锚定的RCP，或者直接将消息转发给用户第一个会话锚定的RCP进行处理。RCP之间需要互相同步用户数据。 
故障情况当RCP1故障时，RCP2、RCP3、RCP4将接替RCP1为对端网元提供策略控制功能，对端网元（PGW/DRA/AF/SMF/AMF）发送业务请求（通过直连链路或通过DRA链路）给RCP2、RCP3、RCP4，而不再发消息给RCP1。RCP2、RCP3、RCP4收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，可以正常处理。当对端网元（PGW/DRA/AF/SMF/AMF）选择的RCP和主动接管此用户会话的RCP不一致时，收到消息RCP回复重定向响应消息给对端网元，或者直接将消息转发给接管该用户的RCP进行处理。 
故障恢复在RCP1故障恢复之后，当其他RCP收到对端网元（PGW/DRA/AF/SMF/AMF）发来的消息之后，判断此消息是RCP1已建会话的后续消息，返回重定向响应消息给对端网元，或者直接将消息转发给RCP1处理。 
 说明： 
N+M模式，其他RCP故障时的处理逻辑与RCP1类似。 
###### 业务流程 
下面以SMF的交互流程为例，描述容灾场景下的消息交互。 
####### 冷备容灾，RCP局间数据无同步 
冷备容灾，RCP局间数据无同步流程如[图8](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zb7553313aa7a4c1bbda2f18a3fd8082d__d5cb5ee9-7ff7-4e8f-a7f7-6c0d83d70874)所示。
图8  冷备容灾，RCP局间数据备份流程
[]images/1622771186638.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀，IP地址域（可选），IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
####### 冷备容灾状态切换（外部消息触发） 
RCP故障时，触发的冷备容灾切换流程如[图9](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z137f64d06dab43828397c0390eabfcfd__367ffce3-809f-448c-86eb-8666499fd7f9)所示。
图9  冷备容灾状态切换（外部消息触发）
[]images/1622771249866.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
SMF检测到链路堵塞或者中断或者通过NRF得到RCP状态不可用通知。 
SMF/AMF切换局向到容灾RCP。 
SMF向备用RCP发送Npcf_SMPolicyControl_Update请求。 
容灾RCP无此会话的数据，会回复失败的Npcf_SMPolicyControl_Update响应给SMF，携带ProblemDetails中的cause为RESOURCE_URI_STRUCTURE_NOT_FOUND。 
SMF向容灾RCP发送Npcf_SMPolicyControl_Delete请求。 
容灾RCP无此会话的数据，会回复失败的Npcf_SMPolicyControl_Delete响应给SMF，携带ProblemDetails中的cause为RESOURCE_URI_STRUCTURE_NOT_FOUND。 
用户重新发起会话建立请求，SMF向容灾RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果容灾RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果容灾RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到容灾RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
容灾RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。容灾RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
####### 热备容灾，RCP局间数据同步 
热备容灾，RCP局间数据业务流程如[图10](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#za148827ecf684c57947d95f164327a49__eb37c4e4-7718-4c91-906a-c9a3696330ec)所示。
图10  热备容灾，RCP局间数据同步
[]images/1622771307206.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
本RCP向容灾RCP同步备份该用户数据。 
容灾RCP完成数据备份，并返回响应。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀、IP地址域（可选）、IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
####### 热备容灾状态切换（外部消息触发） 
外部消息触发，热备容灾状态切换流程如[图11](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z7230b2b43f0d453d93034eabd526fccc__cd1f8dcf-3de1-48f4-b248-b58a5417274a)所示。
图11  热备容灾状态切换（外部消息触发）
[]images/1622771366743.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀、IP地址域（可选）、IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
SMF检测到链路堵塞或者中断或者通过NRF得到RCP状态不可用通知。 
SMF/AMF切换局向到容灾RCP。 
SMF向容灾RCP发送Npcf_SMPolicyControl_Update请求。 
容灾RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。容灾RCP向SMF发送Npcf_SMPolicyControl_Update响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
容灾RCP检测到主用RCP故障，接管用户。触发向SPR重新订阅。 
容灾RCP判断是否向BSF进行了注册，如果已经注册过，并且打开了容灾后主动发送BSF局向变更消息的开关，需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
容灾RCP发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
容灾RCP判断已经和CHF建立了会话，并且打开了容灾后主动发送CHF局向变更消息的开关，则发送Nchf_SpendingLimitControl_Subscribe请求消息到CHF，更新订阅。 
CHF返回Nchf_SpendingLimitControl_Subscribe响应。 
主用RCP恢复，容灾RCP检测到主用RCP恢复，开始向主用RCP同步该用户数据。 
主用RCP完成数据同步，并返回响应。 
####### 热备容灾状态切换（RCP主动接管用户） 
主用RCP故障，容灾RCP主动接管用户的容灾状态切换流程如[图12](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zb75965b5dc1143ceb717264c43bc723e__2b745b03-6f95-4cbc-81a2-7ad76eb4e239)所示。
图12  热备容灾状态切换（RCP主动接管用户）
[]images/1622771590305.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀，IP地址域（可选），IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
主用RCP故障，容灾RCP检测到主用RCP故障，开始主动接管用户。接管每个用户的时候都会进行15~21的流程。 
容灾RCP检测到主用RCP故障，接管用户。触发向SPR重新订阅。 
容灾RCP判断是否向BSF进行了注册，如果已经注册过，并且打开了容灾后主动发送BSF局向变更消息的开关，需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
容灾RCP发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
容灾RCP判断已经和CHF建立了会话，并且打开了容灾后主动发送CHF局向变更消息的开关，发送Nchf_SpendingLimitControl_Subscribe请求消息到CHF，更新订阅。 
CHF返回Nchf_SpendingLimitControl_Subscribe响应。 
主用RCP恢复，容灾RCP检测到主用RCP恢复，开始向主用RCP同步该用户数据。 
主用RCP完成数据同步，并返回响应。 
####### 热备容灾状态切换（消息重定向） 
消息中转方式为重定向时，热备容灾状态切换流程如[图13](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#z61d68a5aa9de42c8b23c9a2bf2b095a4__a6e6f38e-d361-4493-b99a-c084138d2a9a)所示。
图13  热备容灾状态切换（消息重定向）
[]images/1622771834148.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀，IP地址域（可选），IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
本RCP向容灾RCP同步该用户数据。 
容灾RCP完成数据同步，并返回响应。 
SMF检测到链路堵塞或者中断或者通过NRF得到RCP状态不可用通知。 
SMF/AMF切换局向到容灾RCP2。 
SMF向容灾RCP2发送Npcf_SMPolicyControl_Update请求。 
容灾RCP2判断此用户归容灾RCP1接管，则返回Npcf_SMPolicyControl_Update响应，响应码为307，并且携带容灾RCP1的FQDN，指示SMF需将此消息发送到容灾RCP1。 
SMF向容灾RCP1发送Npcf_SMPolicyControl_Update请求。 
容灾RCP1基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。容灾RCP1向SMF发送Npcf_SMPolicyControl_Update响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
容灾RCP1检测到主用RCP故障，接管用户。触发向SPR重新订阅。 
容灾RCP1判断是否向BSF进行了注册，如果已经注册过，则需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
容灾RCP1发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
容灾RCP1发送Nchf_SpendingLimitControl_Subscribe请求消息到CHF，更新订阅。 
CHF返回Nchf_SpendingLimitControl_Subscribe响应。 
主用RCP恢复，容灾RCP1检测到主用RCP恢复，开始向主用RCP同步该用户数据。 
主用RCP完成数据同步，并返回响应。 
####### 热备容灾状态切换（消息代理转发） 
消息发送方式为Proxy转发时，热备容灾状态切换流程如[图14](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#zd60b0287762c4c3d99ffc43f414acf2f__0d5618d5-d3e4-4b91-9918-3880e9b62145)所示。
图14  热备容灾状态切换（消息Proxy）
[]images/1622772106433.png)
流程描述如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
如果RCP确定对该PDU会话需要用到策略计数器状态信息，并且RCP本地没有该用户的此信息，则向CHF发送Nchf_SpendingLimitControl_Subscribe请求该信息。 
CHF收到RCP的请求之后，CHF查询到策略计数器对应的状态，向RCP发送Nchf_SpendingLimitControl_Subscribe响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
本RCP向容灾RCP1同步备份该用户数据。 
容灾RCP1完成数据备份，并返回响应。 
SMF收到Create响应后，为UE分配IP地址，再通过NPCF_SMPolicyControl_Update请求向RCP1上报UE IP地址。更新请求中主要包含：用户IPv4地址或 IPv6地址前缀，IP地址域（可选），IP地址改变事件（policyCtrlReqTriggers参数中包含UE_IP_CH事件）。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
RCP记录下UE IP地址信息，向SMF回复NPCF_SMPolicyControl_Update响应。 
本RCP向容灾RCP1同步该用户数据。 
容灾RCP1完成数据同步，并返回响应。 
SMF检测到链路堵塞或者中断或者通过NRF得到RCP状态不可用通知。 
SMF/AMF切换局向到容灾RCP2。 
SMF向容灾RCP2发送Npcf_SMPolicyControl_Create/Update请求，容灾RCP2判断此用户归容灾RCP1接管，将此请求URI中authority部分替换为RCP1相同服务的ip/port，将消息发送到容灾RCP1。 
容灾RCP1收到容灾RCP2发送过来的Npcf_SMPolicyControl_Create/Update请求。 
容灾RCP1基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。容灾RCP1向容灾RCP2发送Npcf_SMPolicyControlCreate/Update响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。如果是Create响应，HTTP消息头域Location参数携带ResourceURI中authority部分为RCP1的ip/port或FQDN。 
容灾RCP2转发Npcf_SMPolicyControl_Create/Update响应给SMF，不修改响应HTTP部分。 
容灾RCP1检测到主用RCP故障，接管用户。触发向SPR重新订阅。 
容灾RCP1判断是否向BSF进行了注册，如果已经注册过，需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
容灾RCP1发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
容灾RCP1发送Nchf_SpendingLimitControl_Subscribe请求消息到CHF，更新订阅。 
CHF返回Nchf_SpendingLimitControl_Subscribe响应。 
容灾RCP1可能因外部（如AF）或内部（如时段切换）触发而需要调整会话策略，容灾RCP1向SMF发送Npcf_SMPolicyControl_UpdateNotify请求，更新会话策略，其中resourceUri参数的authority部分为容灾RCP1的ip/port或FQDN。 
SMF回复Npcf_SMPolicyControl_UpdateNotify响应。 
如果SMF解析了步骤19的Create响应的ResourceURI的authority部分或步骤27的UpdateNotify请求的ResourceURI的authority部分变化，则SMF可以将相关会话切换到容灾RCP1，后续SMF发起的Update流程按步骤30/31执行。 
如果SMF不解析authority变化，后续Update流程仍按步骤16~19，SMF的Update请求通过容灾RCP2转发给容灾RCP1，容灾RCP1的Update响应通过容灾RCP2转发给SMF。 
SMF因为事件订阅条件满足（如RAT_CH）等原因向容灾RCP1发送Npcf_SMPolicyControl_Update请求。 
容灾RCP1回复Npcf_SMPolicyControl_Update响应。 
###### 本网元实现 
######## 容灾所需服务 
Nudsf_UnstructuredDataManagement服务Nudsf_UnstructuredDataManagement服务简称UDSF，实现非结构化数据存储功能，既可以内置在NF中，也可以独立部署并被多个NF共享。UDSF按照租户来存储和管理网元的用户数据、与网元相关的数据。UDSF中的租户可分为公共租户和私有租户。公共租户存储和管理网元相关的公共数据，组成容灾局的网元需要使用相同的公共租户名称。私有租户存储和管理网元的私有用户数据，不同私有租户之间不可相互访问和操作其他私有租户管理的数据。RCP访问UDSF时，需要配置私有租户和公共租户。 
Ncudr_SystemManagement服务此服务主要用于管理UDSF配置。 
Nudr_Access服务Nudr_Access服务，简称CGW，是UDSF的接入网关，用于RCP和UDSF、UDSF和UDSF之间的通信，当容灾局的RCP或UDSF需要接入本局UDSF时，需要配置此服务配置。 
Ncudr_AccessManagement此服务主要用于管理CGW配置。 
不同的容灾模式下，各服务的部署方式也不一样，参见[表1](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newc98ccf9b83bc43298ea4582742d6db4b__2bad45f2-1d53-4c20-9390-391d4ad8efaa)。
部署方式|Nudsf_UnstructuredDataManagement服务|Ncudr_SystemManagement服务|Ncudr_Access服务|Ncudr_AccessManagement服务
---|---|---|---|---
冷备|部署|部署|-|-
热备（带UDSF）|部署|部署|部署|-
热备（不带UDSF）|-|-|部署|部署
######## 状态检测机制 

目前系统在下面几种情况下会认为本局故障： 
直接在网管上配置本局为“维护态”。 
定期检测本网元对外链路。目前会检测Diameter链路、RCP和通过流程触发服务发现返回的NF之间的HTTP链路、消息代理转发模式下和其他RCP的链路状态。这3种链路同时发生故障，就会认为本局故障了。 
一旦系统认为本局故障，会进行如下的操作： 
如果故障RCP还能访问UDSF，则会将本局状态更改为"故障态"，目的是通过UDSF通知容灾RCP需要接管故障RCP的用户。 
如果故障RCP和NRF的链路还是通的，则会更新本局在NRF中的注册状态为"Suspended"，目的是通过NRF通知其他网元（比如SMF/AMF等5GC网元）本RCP发生故障了。 
故障RCP将本局DATA中的数据设置为无效数据清掉。目的是在故障RCP恢复正常状态之后，再从UDSF中重新下载数据。 
目前系统在下面几种情况下会认为对端局故障： 
容灾RCP在UDSF中存储的状态变成了“故障态”。 
定时检测对端局在UDSF中的状态信息，如果超过一定时长都未更新状态时，则认定该RCP发生故障。目前检测RCP发生故障的时间间隔默认为30s，该时间值可以通过3072定时器配置。  
 一旦系统认为对端局故障，会进行如下的操作： 
如果是组Pool容灾，按照容灾接管算法，接管故障局的部分用户。 
如果是主备或者互备容灾，则会接管所有用户。 
目前系统在下面几种情况下会认为对端局正常： 
对端局在UDSF中存储的状态变成了“正常态”。 
定时检测对端局在UDSF中的状态信息，状态信息在检测时间内有更新。 
一旦系统认为对端局恢复，会进行如下的操作： 
本局会将DATA中已经接管的对端局用户清空。 
将用户交还给对端局处理。 
######## 容灾后更新局信息 
主用RCP发生故障后，容灾RCP对于接管的用户，需要主动更新关联网元存储的用户局向信息。 
主用RCP故障恢复后，主用RCP对于重新接管回来的用户，也需要再次主动更新关联网元存储的用户局向信息。 
目前更新局向信息可分为以下几类： 
BSF更新容灾RCP检测到主用RCP故障时，开始主动接管用户，在接管用户会话数据过程中判断会话是否向BSF进行了注册。如果注册过，容灾RCP判断是否主动发送BSF更新消息，默认是不主动发送（可通过“1353 容灾后主动发送BSF局向变更消息”开关打开），会向BSF发起更新流程更新局信息。 
SPR更新容灾RCP检测到主用RCP故障时，开始主动接管用户后，容灾RCP判断以前是否向SPR订阅过变更通知。如果订阅过变更通知，容灾RCP判断是否主动发送SPR更新局向消息，默认是主动发送（可通过“1352 容灾后主动发送SPR局向更新消息”开关关闭），会向SPR发起更新流程更新局信息。 
CHF更新容灾RCP检测到主用RCP故障时，开始主动接管用户后，容灾RCP判断是否主动发送CHF更新消息，默认是主动发送（可通过“1232 容灾后主动发送N28更新消息”开关关闭），会触发向CHF发送局向更新消息。 
######## 重定向/代理转发功能 
多个RCP组成Pool容灾局后，要求同一个用户的所有会话锚定在一个RCP上处理。在用户多会话场景下，对端网元将用户非首次上线的消息发往该用户的非归属RCP时，收到此消息的RCP局会判断用户归属局的状态。 
如果用户归属局状态正常，则会返回重定向消息，消息中携带该用户所属RCP的网元信息；或者会将消息转发到用户归属的RCP进行处理。 
如果用户归属局状态异常，收到消息的RCP局会判断此用户是否应该被本局接管。如果该用户归本局接管，则本局正常处理此消息。如果此用户不归本局接管，则会返回重定向消息，消息中携带应该接管此用户的RCP的网元信息；或者会将消息转发到应该接管此用户的RCP进行处理。 
采用重定向还是代理转发方式，通过容灾全局配置（执行[SET DRCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788111.html)命令）中的消息中转方式参数来配置。如果采用代理转发方式，还需要保证Pool内RCP间HTTP链路、Diameter链路正常连通。
######## 容灾部署 
容灾模式|工作模式|租户|租户间容灾关系|NRF注册优先级|NRF其他注册信息|每个RCP容量
---|---|---|---|---|---|---
冷备|主备|公共租户，私有租户一致所有局统一公共/私有租户|不需要配置|主用高，备用低|一致，特别是GroupID必须一致|A
互备|冷备|一致|公共租户，私有租户一致所有局统一公共/私有租户|不需要配置|A|一致，特别是GroupID必须一致
N+MN+M<=8|冷备|一致|公共租户，私有租户一致所有局统一公共/私有租户|不需要配置|A/N|一致，特别是GroupID必须一致
热备|主备|需要配置|公共租户，私有租户一致所有局统一公共/私有租户|主用高，备用低|A|一致，特别是GroupID必须一致
互备|热备|一致|需要配置|A|公共租户，私有租户一致所有局统一公共/私有租户|一致，特别是GroupID必须一致
N+MN+M<=8|热备|一致|需要配置|业务服务的容量：A/N每个UDSF的容量：A|公共租户，私有租户一致所有局统一公共/私有租户|一致，特别是GroupID必须一致
注：假设Pool内RCP需要支持的用户数为A。 
冷备
冷备的RCP之间相互没有交互，互相之间无心跳检测。当一个RCP故障之后，容灾RCP不接管故障RCP已有会话，故障RCP上的会话信息会丢失。如果后续有故障RCP用户会话的更新、释放等消息发送到容灾RCP，容灾RCP按照会话不存在处理。 
部署的注意事项： 
冷备的所有RCP都要部署UDSF。 
所有RCP公共租户名称和私有租户名称一致。租户不需要配置容灾关系。 
CDB租户表中，配置的访问策略为本地优先。 
所有RCP同时向NRF注册，如果是主备冷备，设置主用RCP优先级高于容灾RCP优先级（优先级值越小，优先级越高）。其他冷备情况下，优先级设置一致。 
所有RCP向NRF注册的GroupID应该一致。 
假设Pool内RCP需要支持的用户数为A，Pool内N+M个RCP局，每个局的用户容量应该为A/N。 
主备热备
主备RCP会通过UDSF互相检测心跳。主备局向NRF注册不同优先级，主用局优先级高，对端网元在主用局正常时优先选择主用局进行交互，主用局故障之后，备用局接管主用局的所有会话，并对收到的消息正常处理。当主用局恢复之后，主用局会将原先本局管理的用户主动接管，备用局会卸载接管的主用局用户数据。 
部署的注意事项： 
主备两个RCP都要部署CGW、UDSF。 
主备两个RCP私有、公共租户名称相同。租户需要配置容灾关系。 
CDB租户表中，配置的访问策略建议为主用优先。 
主备RCP同时向NRF注册，需要配置主备状态下不同的注册优先级，主用RCP优先级高于容灾RCP优先级（优先级值越小代表优先级越高）。 
所有RCP向NRF注册的GroupID、向NRF注册的号段、DNN等信息都应该一致。 
假设系统需要支持的用户数为A，每个RCP的用户容量应该为A。 
互备热备
互备RCP会通过UDSF互相检测心跳。互备的两个RCP都正常处理业务。一个RCP故障之后，容灾RCP接管故障RCP的所有会话，并对收到的消息正常处理。当故障RCP恢复之后，故障RCP会将原先本局管理的用户主动接管，容灾RCP会卸载接管的故障RCP的用户数据。 
部署的注意事项： 
UDSF内置，两个RCP都要部署CGW、UDSF。 
两个RCP的私有、公共租户名称要相同。租户需要配置容灾关系。 
CDB租户表中，配置的访问策略必须为主用优先。 
互备的RCP同时向NRF注册，配置两个RCP的注册优先级一致。 
所有RCP向NRF注册的GroupID、向NRF注册的号段、DNN等信息都应该一致。 
假设系统需要支持的用户数为A，每个RCP的用户容量应该为A。 
N+M热备
Pool内所有RCP会通过UDSF互相检测心跳。Pool内所有RCP都正常处理业务。一个RCP故障之后，其他的RCP各自接管故障RCP相应的会话，并对收到的消息正常处理。当故障RCP恢复之后，原故障RCP会将原先本RCP管理的用户主动接管。容灾RCP会卸载接管的故障RCP用户数据。 
部署的注意事项： 
UDSF内置，两个RCP要部署CGW、UDSF，其余的RCP需要部署CGW。 
Pool内所有RCP的私有、公共租户名称相同。租户需要配置容灾关系。 
CDB租户表中，配置的访问策略必须为主用优先。 
N+M个RCP同时向NRF注册，配置各RCP的注册优先级一致。 
向NRF注册的GroupID、向NRF注册的号段、DNN等信息都应该一致。 
N+M最多支持8个RCP。 
假设Pool内RCP需要支持的用户数为A，Pool内N+M个RCP，每个RCP的用户容量应该为A/N。带UDSF的局，UDSF的容量为A。 
##### 系统影响 
冷备容灾对系统无影响。 
热备容灾主备或者互备，开启热备容灾后RCP的容量约下降一半。假设两个RCP分别支持100万用户，两个RCP合起一起才能支持100万用户，因为每个RCP都要预留一半容量用于保存对方的会话数据和用户数据。N+M组Pool，开启热备容灾后RCP的容量同样会下降。按照M=1来说，如果Pool内5个RCP，每个RCP分别支持100万用户，那么整个Pool支持400万用户。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 


##### 遵循标准 




本特性采用中兴通讯内部的接口和协议，不涉及标准协议。 




##### 特性能力 
名称|指标
---|---
热备组Pool容灾|一个Pool内最多8个RCP。
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.20.20|首次发布
02|V7.21.30|容灾功能优化。主要优化点：VoLTE会话按会话容灾。容灾之后刷新BSF、SPR局向功能增加开关。容灾之后加载数据增加延时。Pool内PCF个数最大改为8个，支持M>1。
03|V7.23.10|容灾服务部署优化，所有热备局都需要部署CGW服务
####### License要求 
该特性为RCP网元的基本特性，无需License支持。
####### 对其他网元的要求 
容灾对本端和对端网元的要求
容灾对本端和对端网元的要求参见[表2](ZUF-90-06-002-1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_20175108424913__b57b5138-e205-4553-8db7-ec62b7289ea4)。
本端网元|对端网元
---|---
容灾方式|租户|容灾方式|配置要求|Diameter链路要求|HTTP链路要求|其他要求
冷备|1+1主备|两个RCP共用一个租户|容灾方式配置为冷备|针对主备两个RCP的主机名路由优先级都要求优先到主用局。RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-HostAVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。|无
1+1互备|冷备|两个RCP共用一个租户|RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-Host AVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|容灾方式配置为冷备|按用户号码选择RCP|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。
组Pool|冷备|多个RCP共用一个租户|容灾方式配置为冷备|RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-Host AVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。|按用户号码选择RCP
热备|1+1主备|两个RCP共用一个租户|容灾方式配置为热备|针对主备两个RCP的主机名路由优先级都要求优先到主用局。RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-Host AVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|如果容灾全局配置的消息中转方式参数配置为重定向：当RCP返回Diameter重定向响应时，对端网元能发送消息到指定的主机。当RCP返回HTTP重定向307/308响应时，对端网元能发送消息到指定的主机。|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。
1+1互备|热备|两个RCP共用一个租户|RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-Host AVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|容灾方式配置为热备|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。|如果容灾全局配置的消息中转方式参数配置为重定向：当RCP返回Diameter重定向响应时，对端网元能发送消息到指定的主机。当RCP返回HTTP重定向307/308响应时，对端网元能发送消息到指定的主机。
N+M|热备|多个RCP共用一个租户|RCP回复RESOURCE_URI_STRUCTURE_NOT_FOUND之后，需要SMF将用户下线后重新附着。在与主用RCP的链路中断或者NRF通知主用RCP故障之后，支持发送已经激活会话的更新/释放消息给备用RCP。|RCP回复DIAMETER_UNKNOWN_SESSION_ID之后，需要PGW将用户下线后重新附着。在与主用RCP的链路中断后，支持发送已经激活会话的更新/释放消息给备用RCP。当CCR消息中Destination-Host AVP值和CCA消息中Original-Host AVP值不同时，会保存CCA消息中Original-Host AVP值，并把会话切换到CCA消息的Original-Host AVP值所在的RCP。|容灾方式配置为热备|如果容灾全局配置的消息中转方式参数配置为重定向：当RCP返回Diameter重定向响应时，对端网元能发送消息到指定的主机。当RCP返回HTTP重定向307/308响应时，对端网元能发送消息到指定的主机。
容灾倒换过程对BSF网元的话务冲击
从DC1倒换到DC2，DC2的PCF会产生容灾接管告警，告警产生后，DC2的语音PCF会向BSF发起去注册及注册消息，通知BSF绑定的PCF信息发生变更，速率为xxx，需要BSF评估影响。同时要叠加上线带来的影响。 
速率计算方法：2 × 用户接入速率CAPS + 每SC的速率（即1102开关取值）× 每个GSU上PCM SC的个数 × GSU个数 × 2对消息。 
对BSF的话务冲击受开关“1353 容灾后主动发送BSF局向变更消息
”的控制，1353开关控制在RCP容灾接管之后是否发送更新局向消息到BSF，默认不发送。
RCP消息中转方式|开关打开前提|开关关闭前提
---|---|---
代理转发模式|BSF支持同一个用户多个会话。如果BSF不支持一个用户多会话，由会话上线，以及PCF容灾倒换触发的注册消息，都可能导致BSF中记录被覆盖的问题。但会话上线场景造成的BSF中记录被覆盖问题，是PCF无法避免的。|BSF需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然BSF中记录的是主用局局向，但可以将消息发送到备用PCF处理。BSF需要按照PCF Pool关系，为Pool中的每个PCF配置了主备路由，在某PCF故障之后，虽然BSF中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。
重定向模式|BSF支持同一个用户多个会话。如果BSF不支持一个用户多会话，由会话上线，以及PCF容灾倒换触发的注册消息，都可能导致BSF中记录被覆盖的问题。但会话上线场景造成的BSF中记录被覆盖问题，是PCF无法避免的。|BSF需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然BSF中记录的是主用局局向，但可以将消息发送到备用PCF处理。BSF需要按照PCF Pool关系，为Pool每个PCF配置了主备路由，在某个PCF故障之后，虽然BSF中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。BSF支持重定向。
容灾倒换过程对SPR网元的话务冲击
从DC1倒换到DC2，DC2的PCF会产生容灾接管告警，告警产生后，DC2的数据PCF会向SPR发起UDR消息，通知SPR用户所在的PCF发生变更，速率为xxx，需要SPR评估影响，同时要叠加上线带来的影响。 
速率计算方法：2 × 用户接入速率CAPS + 每SC的速率（即1102开关取值）× 每个GSU上PCM SC的个数 × GSU个数。 
对SPR的话务冲击受开关“1352 容灾后主动发送SPR局向更新消息
”的控制，1352开关控制在RCP容灾接管之后是否发送更新局向消息到SPR，默认发送。
RCP消息中转方式|开关打开前提|开关关闭前提
---|---|---
代理转发模式|无|SPR需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然SPR中记录的是主用局局向，但可以将消息发送到备用PCF处理。SPR需要按照PCF Pool关系，为Pool中的每个PCF配置了主备路由，在某个PCF故障之后，虽然SPR中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。忍受容灾期间SPR主动通知消息无法到达其他PCF的问题。
重定向模式|无|SPR需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然BSF中记录的是主用局局向，但可以将消息发送到备用PCF处理。SPR需要按照PCF Pool关系，为Pool每个PCF配置了主备路由，在某个PCF故障之后，虽然BSF中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。忍受容灾期间SPR主动通知消息无法到达其他PCF的问题。SPR支持重定向。
容灾倒换过程对CHF网元的话务冲击
DC1倒换到DC2，DC2的PCF会产生容灾接管告警，告警产生后，DC2的数据PCF会向CHF发起更新消息，通知CHF用户所在的PCF发生变更，速率为xxx，需要CHF评估影响，同时要叠加上线带来的影响。 
速率计算方法：2 × 带CHF用户接入速率CAPS + 每SC的速率（即1102开关取值）× 每个GSU上PCM SC的个数 × GSU个数 
对CHF的话务冲击受开关“1232 容灾后主动发送N28更新消息
”的控制，1232开关控制在RCP容灾接管之后是否发送更新消息到CHF，默认发送。
RCP消息中转方式|开关打开前提|开关关闭前提
---|---|---
代理转发模式|无|CHF需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然CHF中记录的是主用局局向，但可以将消息发送到备用PCF处理。CHF需要按照PCF Pool关系，为Pool中的每个PCF配置了主备路由，在某个PCF故障之后，虽然CHF中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。忍受容灾期间CHF主动通知消息无法到达其他PCF的问题。
重定向模式|无|CHF需要按照PCF主备关系，为每个PCF配置了主备路由，在主用PCF故障之后，虽然CHF中记录的是主用局局向，但可以将消息发送到备用PCF处理。CHF需要按照PCF Pool关系，为Pool每个PCF配置了主备路由，在某个PCF故障之后，虽然CHF中记录的是故障PCF的局向，但可以将消息发送到Pool内其他PCF处理。忍受容灾期间CHF主动通知消息无法到达其他PCF的问题。CHF支持重定向。
##### O&M相关 
####### 命令 
配置项命令项命令名称描述网元状态配置SET NFSTATUS修改网元状态。SHOW NFSTATUS查看网元状态。容灾全局配置SET DRCFG修改容灾全局。SHOW DRCFG查看容灾全局。热备容灾局信息配置ADD POOLCFG增加热备容灾局信息配置。DEL POOLCFG删除热备容灾局信息配置。SET POOLCFG修改热备容灾局信息配置。SHOW POOLCFG查询热备容灾局信息配置。 
定时器编号定时器名称系统缺省值（毫秒）建议3072DRSTATUSDETECTION30000不建议修改。3073DRLINKDETECTION10000不建议修改。 
全局变量全局参数名称系统缺省值建议1102 每秒主动加载其他局用户最大个数10不建议修改。1231 HTTP重定向失败码307不建议修改。1232 容灾后主动发送N28更新消息1建议按照现网N28接口能力进行修改。1351 主动加载其他局数据延时时长（分钟）30不建议修改。1352 容灾后主动发送SPR局向更新消息1建议按照现网SPR能力进行修改。1353 容灾后主动发送BSF局向变更消息0不建议修改。1151 GDB数据记录挂死时间300不建议修改。1152 GDB是否与业务进行保活1不建议修改。1153 CDB数据记录挂死时间900不建议修改。 
动态命令动态命令描述SHOW_DR_NFINFO查询容灾局信息。SHOW_DR_USER:USERKEYTYPE="IMSI",USERKEY="012345678900000"查询用户归属信息。SHOW_DR_SYS查询局用户信息。SHOW_DR_GROUP查询容灾局群组信息。SHOW_DR_PROGRESS查询容灾局接管进度。FORCE_DR_GROUP:OPERATETYPE="LOAD",NEID=1,DRGROUP=1强制加载容灾局向号为1的1号容灾分片。FORCE_DR_GROUP:OPERATETYPE="UNLOAD",NEID=1,DRGROUP=1强制卸载容灾局向号为1的1号容灾分片。 
####### 性能统计 
测量类型|描述
---|---
52011 RCP容灾按局向号统计|该类型中的所有计数器。统计接收和发送消息的处理方式：重定向、本地或转发。
00016 Diameter协议统计|编号为C000160051~C000160062的计数器，统计各接口转发的Diameter消息个数。
####### 告警和通知 
告警名称|描述
---|---
3339321606 容灾接管告警|当容灾RCP接管他局数据时上报此告警；他局恢复之后，恢复此告警。
3339321607 系统处于故障状态|系统处于容灾故障状态时，上报此告警；系统恢复之后，恢复此告警。
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


 

##### 配置特性 
###### 配置说明 
RCP组网通过配置容灾系统，实现当一个RCP出现故障时，其余RCP依然能够正常处理后续信令，保障了系统的稳定性和业务的连续性。 
配置注意事项： 
CDB租户表中，配置的访问策略必须为主用优先。 
主备容灾RCP同时向NRF注册，配置主备状态下不同的注册优先级（主用RCP的优先级高于备用RCP的优先级）。 
向NRF注册的GroupID应该一致。 
服务基础配置中的优先级，主用RCP高（值越小代表优先级越高）。 
服务基础配置中的FQDN配置为本局的FQDN。 
Ncudr_Access_0命令树节点下，执行SHOW CGW LINK命令，查询CGW的链路状态。如果链路状态不对，说明配置有误 。 
Npcf_SMPolicyControl_0命令树节点下，执行SHOW_DR_NFINFO命令，检查PCF容灾配置，要能获取到对端局的信息。 
PCF和CDB上租户名需要保持一致。 
PCF的NFINFO中局号、容灾配置中的局号需要一致，若不一致，需要参考“修改本局配置NFID”进行操作。 
PCF相关配置若修改过局号、主机名、租户信息，建议重启整局。 
###### 配置前提 
######## RCP配置要求 
租户配置检查在Ncudr_SystemManagement_0服务节点，执行SHOW
CDBTENANT命令，查询租户的配置信息，查询结果如图1所示。主备局号正确配置，租户名称为tenant_1，访问策略为主用访问优先。如果租户配置错误，请参考“修改租户配置”修改。图1  租户配置检查执行SHOW SERVICEINFO:SERVICETYPENAME="Nudsf_UnstructuredDataManagement"命令，检查SC类型ID是否正确，查询结果如图2所示。左右域SC TYPE对应值必须正确：V7.20.10.B4以前版本实例化是1和2，V7.20.10.B4及以后版本实例化是9和10。图2  检查SC类型 
本局配置检查在Npcf_PolicyManagement_0服务节点，执行SHOW NFINFO命令，查询本局信息，查询结果如图3所示。局号正确，租户名称需要为tenant_1，如果NFID配置错误，请参考“修改本局配置NFID”修改。图3  查询本局信息 
变化表检查执行SHOW CHG命令，检查是否无变化表，如有变化表请确认后传表。 
网元告警检查检查是否有异常告警，如果有需要确认是否影响容灾配置。 
时间同步检查在CommonS_TMSP_0服务节点，执行SHOW NTP命令，检查所有局的系统时间是否一致，NTP必须启用。 
网络平面检查需要规划独立的容灾网络平面(data平面）。 
######## NRF/SMF/DRA/BSF网元配置要求 
SMF配置要求查询PCF负载模式是否为“非绑定”，如果不是，执行如下命令修改，PROFILENAME参数根据实际配置填写。SET PCFDYNAMICPROFILE:PROFILENAME="ctnet",BALANCEMODE="PCF_NOT_BINGDING"SET PCFDYNAMICPROFILE:PROFILENAME="ims",BALANCEMODE="PCF_NOT_BINGDING" 
NRF配置要求在NRF上配置心跳检测时长：ADD HEARTBEATCHECK:NFTYPE="PCF",SENDINTERVAL=10,SENDTIMES=3 
BSF、DRA配置要求热备容灾组网中，某RCP故障后，对于新会话、老会话要求BSF、DRA能指向容灾RCP。 
###### 配置过程 
######## 组网配置说明 
RCP容灾配置包括： 
业务功能容灾配置 
UDSF功能容灾配置 
######## 业务功能容灾配置 
业务功能容灾配置流程如[图4](1622870309740.html#zcac685584f1f4db79115be6c420fe2d8__f5f55533-0794-4ddc-92e2-7f3fc51d8271)所示。
图4  业务功能容灾配置
[]images/%E4%B8%9A%E5%8A%A1%E5%AE%B9%E7%81%BE%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B.png)
配置步骤： 
登录EM客户端，打开配置→命令处理
页面，选择Npcf_PolicyManagement_0 服务。
执行[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html)命令，新增本局配置。
执行[SET DRCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788111.html)命令，设置容灾全局配置。
执行[ADD POOLCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788121.html)命令，增加本局的热备容灾局配置。
配置消息Proxy转发链路。 
选择CommonS_SIG_0服务，执行[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html)命令，新增偶联配置。
选择Npcf_PolicyManagement_0服务，执行[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html)命令，新增Diameter链路。
选择Npcf_PolicyManagement_0服务，执行[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html)命令，新增Diameter路由组。
选择Npcf_PolicyManagement_0服务，执行[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html)命令，新增Diameter路由。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传表生效配置。
执行[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html)命令，修改PCF服务基础配置，设置服务优先级。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传表生效配置。
######## UDSF容灾配置 
UDSF容灾配置流程如[图5](1622870309740.html#zcac685584f1f4db79115be6c420fe2d8__128eec7c-ccc5-42f4-85bf-d98c725ffe44)所示。
图5  UDSF容灾配置
[]images/9832616b1c4d477d8b8815c0f73550ae.png)
RCP带UDSF局,是指部署有Ncudr_SystemManagement_0及Nudsf_UnstructuredDataManagement_0的局，提供数据处理功能。 
RCP不带UDSF局，不部署Ncudr_SystemManagement_0及Nudsf_UnstructuredDataManagement_0服务，通过Ncudr_AccessManagement_0提供配置，比较如下：
类别|配置命令挂树位置|命令挂树
---|---|---
PCF带UDSF局|Ncudr_SystemManagement_0|在Ncudr_SystemManagement_0命令树下
PCF不带UDSF局|Ncudr_AccessManagement_0|在Ncudr_AccessManagement_0命令树下
配置步骤（以下以Ncudr_SystemManagement_0命令树为例，Ncudr_AccessManagement_0命令树下的配置相同）： 
登录EM客户端，打开配置→命令处理
页面，选择Ncudr_SystemManagement_0服务。
执行[ADD NFCFG](None)命令，新增NF标识配置。
执行[ADD CGWNODE](None)命令，新增CGW互联配置。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传表生效配置。
###### 配置实例-热备容灾（2个PCF） 
######## 配置场景 
两套PCF组成热备容灾。 
两套PCF部署时均配置为带UDSF。 
######## 数据规划 
规划数据示例参见[表1](1622870309740.html#z01665406cd334129affce113843d19f5__7c869eb3-4861-42d3-94e9-47adbe6cc8ba)，实际需要根据现网规划。
网元数据|部署UDSF的主用局|部署UDSF的备用局
---|---|---
局号|81|82
本局主机名|pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org
本局域名|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org
租户名称|tenant_1|tenant_1
POOL组ID|SC_pcf_pool1|SC_pcf_pool1
NF名称|PCF_81|PCF_82
容灾数据同步网络地址（用于PCF局间容灾数据同步）|240E:0180:02E1:FF00::000C|240E:0180:02E2:FF00::000C
SIG业务网络地址（用于PCF局间Diameter消息转发，推荐使用IPv6地址）|240E:0180:02E1:FF00::0015240E:0180:02E1:FF00::0016|240E:0180:02E2:FF00::0015240E:0180:02E2:FF00::0016
容灾数据同步网络对应的VPNID|21|21
SIG业务网络对应的VPNID|12|12
######## 配置步骤 
业务功能容灾配置
 说明： 
本配置在81局和82局上均需要配置，这里以81局举例说明。 
新增本局配置。 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=81,HOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="SC_pcf_pool1"
参数说明参见[表2](1622870309740.html#z01665406cd334129affce113843d19f5__c70fb6d9-0c9c-452e-b759-dfbfcce8874a)。
参数|参数名称|取值说明
---|---|---
NFID|本局局向号|需要与规划一致。
HOSTNAME|Diameter主机名|主机名。
REALM|Diameter域名|域名。
TENANTNAME|租户名称|取值为 tenant_1，需与网元部署时设置一致。
PUBTENANTNAME|公共租户名称|取值为 tenant_1，需与网元部署时设置一致。
GROUPID|网元组编号|示例：SC_pcf_pool1，根据规划修改。
 说明： 
本局配置若修改了局号、租户名称，则需要重启Npcf_SMPolicyControl服务。 
设置容灾全局配置。 
[SET DRCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788111.html):DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="NO"
参数说明参见[表3](1622870309740.html#z01665406cd334129affce113843d19f5__583d1022-3bd6-4114-a83b-95fb811fcf0c)。
参数|参数名称|取值说明
---|---|---
DRMODE|容灾模式|选择热备。
MSGTRANMODE|消息中转方式|选择代理转发。
UPDATEHN|切换后更新主机名|选择否。
增加本局的热备容灾局配置。 
[ADD POOLCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788121.html):NEID1=81,NEID2=82,NEID3=0,NEID4=0,NEID5=0,NEID6=0,NEID7=0,NEID8=0
参数说明参见[表4](1622870309740.html#z01665406cd334129affce113843d19f5__7e8213ae-d4d1-463f-b47d-db11d04c5101)。
参数|参数名称|取值说明
---|---|---
NEID1|PCF局向号1|填写81。
NEID2|PCF局向号2|填写82。
NEID3|PCF局向号3|保持默认值0。
NEID4|PCF局向号4|保持默认值0。
NEID5|PCF局向号5|保持默认值0。
NEID6|PCF局向号6|保持默认值0。
NEID7|PCF局向号7|保持默认值0。
NEID8|PCF局向号8|保持默认值0。
配置消息Proxy转发链路。 
配置SCTP。 
每局增加4条偶联。 
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=261,NAME="PCF01-PCF02-SCTP1",LOCPORT=8121,REMPORT=18121,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="SVR",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=262,NAME="PCF01-PCF02-SCTP2",LOCPORT=8122,REMPORT=18122,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="SVR",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=263,NAME="PCF01-PCF02-SCTP3",LOCPORT=8123,REMPORT=18123,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="CLT",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=264,NAME="PCF01-PCF02-SCTP4",LOCPORT=8124,REMPORT=18124,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="CLT",PROTOCALTYPE="DIAMETER";
参数说明参见[表5](1622870309740.html#z01665406cd334129affce113843d19f5__541d2a02-115a-4db9-96e6-bfff53067b83)。
参数|参数名称|取值说明
---|---|---
ID|SCTP标识|保持默认值。
NAME|别名|根据现网规划填写。
LOCPORT|本端端口|保持默认值。
REMPORT|对端端口|保持默认值。
VPNID1|VPNID1|根据现网规划填写。
LOCADDR1|本地IP地址1|根据现网规划填写。
REMADDR1|对端IP地址1|根据现网规划填写。
VPNID2|VPNID2|根据现网规划填写。
LOCADDR2|本地IP地址2|根据现网规划填写。
REMADDR2|对端IP地址2|根据现网规划填写。
PROTOCALTYPE|应用协议类型|选择DIAMETER。
配置Diameter链路。 
每局配置4条Diameter链路。 
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=261,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM1";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=262,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM2";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=263,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM3";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=264,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM4";
参数说明参见[表6](1622870309740.html#z01665406cd334129affce113843d19f5__71f4362a-9a24-4609-8d85-644c41d49446)。
参数|参数名称|取值说明
---|---|---
LINKNO|链路号|保持默认值。
LOCALHOSTNAME|本端主机名称|根据现网规划填写。
LOCALREALM|本端域名|根据现网规划填写。
DSTHOSTNAME|对端主机名称|根据现网规划填写。
DSTREALM|对端域名|根据现网规划填写。
ADJTYPE|邻接局类型|选择PCRF。
CONNID|SCTP标识|保持默认值。
PROTOCOL|承载协议类型|选择SCTP。
NAME|链路名称|根据现网规划填写。
配置Diameter路由组。 
每局配置3个Diameter路由组。 
[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=261,GROUPNAME="PCF02-Gx",GROUPPTY="LOADBALANCE";
[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=262,GROUPNAME="PCF02-Rx",GROUPPTY="LOADBALANCE";
[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=263,GROUPNAME="PCF02-Sy",GROUPPTY="LOADBALANCE";
参数说明参见[表7](1622870309740.html#z01665406cd334129affce113843d19f5__44e060ab-cff3-448d-be23-ab2c1ca66987)。
参数|参数名称|取值说明
---|---|---
GROUPNO|路由组编号|保持默认值。
GROUPNAME|路由组名称|根据现网规划填写。
GROUPPTY|路由组属性|选择负荷分担。
配置Diameter路由。 
每局配置12条Diameter路由。 
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2619,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2620,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2621,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2622,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
参数说明参见[表8](1622870309740.html#z01665406cd334129affce113843d19f5__b9debe1f-0c2c-4322-9692-b0a08a563a98)。
参数|参数名称|取值说明
---|---|---
ROUTENO|路由编号|保持默认值。
LOCALPROCESSID|本地动作|保持默认值。
MASTERLINKNO|主用链路|保持默认值。
ROUTEPRIORITY|路由优先级|选择高。
ROUTEAPPID|支持应用|选择Gx、Rx和Sy。
DESTURI|目的URI|根据现网规划填写。
ROUTEGROUPNO|路由组编号|保持默认值。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传表，生效配置。
配置服务优先级。 
PCF服务优先级调整，值越低优先级越高，按照运营商局数据规范保证主局（81局）优先级（X)高于备局(82局）优先级（Y）。 
81局配置： 
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF",PRIORITY=X
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",PRIORITY=X
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_AMPOLICYCONTROL",PRIORITY=X
82局配置： 
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF",PRIORITY=Y
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",PRIORITY=Y
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_AMPOLICYCONTROL",PRIORITY=Y
传表，生效配置。 
[ SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html):STYPE="ALL",INCREF="NO"
UDSF相关配置
 说明： 
部署UDSF的局需要配置，这里81和82局需要配置。 
配置NF标识。 
81局配置： 
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="self_nf"
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf"
82局配置： 
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="self_nf"
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf"
参数说明参见[表9](1622870309740.html#z01665406cd334129affce113843d19f5__3368f0d2-34db-4d56-a224-eb81159752a1)。
参数|参数名称|取值说明
---|---|---
NFID|NF标识|主局或者容灾局的局号。填写81或82。
NFNAME|NF名称|根据规划填写。
NFTYPE|NF类型|本局选择本地NF。容灾局选择不同TMSP内的NF。
配置网关通信。 
需要配置本局和容灾局各一条data_sync_1类型的链路，用于两个UDSF间的数据同步。 
81局配置： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
82局配置： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
参数说明参见[表10](1622870309740.html#z01665406cd334129affce113843d19f5__c445ecf6-d4b9-4bac-bab6-a3c716aedb61)。
参数|参数名称|取值说明
---|---|---
NFID|NF ID|CGW所在NF的唯一标识。主局或者备局局号，本次规划填写81、82。
NETTYPE|网络用途|数据同步选择数据同步网络1。
IP|IP地址|NFID对应的容灾业务地址，根据现网规划填写。
SERVERPORTSTART|监听端口最小值|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。
SERVERPORTEND|监听端口最大值|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。
CONNECTPORTSTART|连接端口最小值|连接端口最小值和最大值。按示例配置，不要修改。
CONNECTPORTEND|连接端口最大值|连接端口最小值和最大值。按示例配置，不要修改。
NFLIST|NF列表|NF列表，和NFID保持一致。
VPNID|VPN ID|容灾业务地址关联VPNID，根据现网规划填写。
传表，生效配置。 
[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html):STYPE="ALL",INCREF="NO"
######## 配置检查 
配置完成后，检查容灾功能是否正常。 
查询UDSF数据通信状态。 
在EM上网元服务Ncudr_Access_0命令树节点，执行[SHOW CGW LINK](../../Ncudr_Access\zh-cn\mml\1190751.html)命令，查询UDSF数据通信状态，所有链路状态需为正常。
查询容灾局信息。 
在EM上Npcf_SMPolicyControl_0命令树节点，执行[SHOW_DR_NFINFO](../../Npcf_SMPolicyControl\zh-cn\mml\1137123.html)命令，查询组成容灾关系的各局点的基本信息，能获取到各局点信息和运行情况。
查询Diameter链路状态。 
在EM上Npcf_SystemManagement_0命令树节点，执行[SHOW DIMLNKSTAT](../../Npcf_SystemManagement\zh-cn\mml\1137401.html)命令，查询所有Diameter链路的概要信息，查询结果中链路状态需要为建链成功。


###### 配置实例-热备容灾（2个以上PCF) 




######## 配置场景 

 
三套及以上PCF组成热备容灾。 

 
其中两套PCF配置为部署UDSF，其他PCF配置为不部署UDSF。 

 
针对不部署UDSF的PCF，实例化后先去激活UDSF配置，再激活CGW管理服务及CGW服务。具体操作参见“去激活服务（可选）”和“激活预埋服务（可选）”。 

 


######## 数据规划 
规划数据示例参见[表11](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__220ef780-6cbe-4f94-a951-e48b353d4853)，实际根据现网规划修改。
网元数据|部署UDSF的主用局|部署UDSF的备用局|不部署UDSF的局1|不部署UDSF的局2|不部署UDS的F局3
---|---|---|---|---|---
局号|81|82|83|84|85
本局主机名|pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org
本局域名|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org
租户名称|tenant_1|tenant_1|tenant_1|tenant_1|tenant_1
POOL组ID|SC_pcf_pool1|SC_pcf_pool1|SC_pcf_pool1|SC_pcf_pool1|SC_pcf_pool1
NF名称|PCF_81|PCF_82|PCF_83|PCF_84|PCF_85
容灾数据同步网络地址（用于PCF局间容灾数据同步）|240E:0180:02E1:FF00::000C|240E:0180:02E2:FF00::000C|240E:0180:02E1:FF00::003B|240E:0180:02E2:FF00::003B|240E:0180:02E1:FF00::003F
SIG业务网络地址（用于PCF局间Diameter消息转发，推荐IPv6）|240E:0180:02E1:FF00::0015240E:0180:02E1:FF00::0016|240E:0180:02E2:FF00::0015240E:0180:02E2:FF00::0016|240E:0180:02E1:FF00::003A240E:0180:02E1:FF00::004A|240E:0180:02E2:FF00::003A240E:0180:02E2:FF00::004A|240E:0180:02E1:FF00::003E240E:0180:02E1:FF00::004E
容灾数据同步网络对应的VPNID|21|21|21|21|21
SIG业务网络对应的VPNID|12|12|12|12|12
CGW通信端口规划参见[表12](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__616133e8-3bb7-423c-99c5-8fb53a63bcd4)（本文档举例为81~85，86~88为推荐后续规划）。
网络类型|局号|服务端端口范围规划|客户端端口范围规划|配置|原配置局|新配置所在局
---|---|---|---|---|---|---
data_sync_1|81|35000~35031|50000~50512|已有|81局、82局|81~88局
data_sync_1|82|36000~36031|56000~56512|已有|82局、82局|81~88局
data_sync_1|83|31000~31031|51000~51512|新增|无|83局
data_sync_1|84|32000~32031|52000~52512|新增|无|84局
data_sync_1|85|33000~33031|53000~53512|新增|无|85局
说明： 

 
为保留了与之前版本的兼容，各个局端口范围不是连续的，每个局客户端预留1000个端口，配置512个，其他预留。 

 
V7.23.10开始不再使用数据访问网络（data_access_1）配置。 

 
部分局点开局的时候没有单独规划DATA网络，可能导致端口冲突。分配端口的时候需要保证本服务分配的端口和其他服务已分配的端口不在一个段。 

 
PCF最多可以8个局组成容灾，另外3个局建议按如下规划： 

 
网络类型|局号|服务端端口范围规划|客户端端口范围规划|配置|原配置局|新配置所在局
---|---|---|---|---|---|---
data_sync_1|86|34000~34031|54000~54512|新增|无|86局
data_sync_1|87|37000~37031|57000~57512|新增|无|87局
data_sync_1|88|38000~38031|58000~58512|新增|无|88局


######## 配置步骤 
业务容灾配置
 说明： 
本配置在81局~85局上均需要配置，这里以81局进行举例，82~85局参考该配置。 


新增本局配置。 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=81,HOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="SC_pcf_pool1"
参数取值说明参见[表13](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__5364e9ae-56ba-4b5f-a8b2-79f04231fbd1)。
参数|参数名称|取值说明
---|---|---
NFID|本局局向号|需要与规划一致。
HOSTNAME|Diameter主机名|主机名。
REALM|Diameter域名|域名。
TENANTNAME|租户名称|取值为 tenant_1，需与网元部署时设置一致。
PUBTENANTNAME|公共租户名称|取值为 tenant_1，需与网元部署时设置一致。
GROUPID|网元组编号|示例：SC_pcf_pool1，根据规划修改。
 说明： 
本局配置若修改了局号、租户名称，则需要重启Npcf_SMPolicyControl服务。 


设置容灾全局配置。 
[SET DRCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788111.html):DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="NO"
参数说明参见[表14](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__1af8fc59-8754-4647-9732-dceac7d7c4c2)。
参数|参数名称|取值说明
---|---|---
DRMODE|容灾模式|选择热备。
MSGTRANMODE|消息中转方式|选择代理转发。
UPDATEHN|切换后更新主机名|选择否。


增加热备容灾局信息配置。 
[ADD POOLCFG](../../Npcf_PolicyManagement\zh-CN\mml\1788121.html):NEID1=81,NEID2=82,NEID3=83,NEID4=84,NEID5=85,NEID6=0,NEID7=0,NEID8=0
参数说明参见[表15](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__0cf7b97f-1de7-40c5-94bd-0ee074bfd973)。
参数|参数名称|取值说明
---|---|---
NEID1|PCF局向号1|填写81。
NEID2|PCF局向号2|填写82。
NEID3|PCF局向号3|填写83。
NEID4|PCF局向号4|填写84。
NEID5|PCF局向号5|填写85。
NEID6|PCF局向号6|保持默认值0。
NEID7|PCF局向号7|保持默认值0。
NEID8|PCF局向号8|保持默认值0。


配置消息Proxy转发链路。 


配置SCTP。 
每局增加4条偶联。 
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=261,NAME="PCF01-PCF02-SCTP1",LOCPORT=8121,REMPORT=18121,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="SVR",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=262,NAME="PCF01-PCF02-SCTP2",LOCPORT=8122,REMPORT=18122,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="SVR",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=263,NAME="PCF01-PCF02-SCTP3",LOCPORT=8123,REMPORT=18123,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="CLT",PROTOCALTYPE="DIAMETER";
[ADD SCTP](../../CommonS_SIG\zh-cn\mml\1251000.html):ID=264,NAME="PCF01-PCF02-SCTP4",LOCPORT=8124,REMPORT=18124,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="CLT",PROTOCALTYPE="DIAMETER";
参数说明参见[表16](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__391a4131-f849-4378-82f8-67b9cdf0a596)。
参数|参数名称|取值说明
---|---|---
ID|SCTP标识|保持默认值。
NAME|别名|根据现网规划填写。
LOCPORT|本端端口|保持默认值。
REMPORT|对端端口|保持默认值。
VPNID1|VPNID1|根据现网规划填写。
LOCADDR1|本地IP地址1|根据现网规划填写。
REMADDR1|对端IP地址1|根据现网规划填写。
VPNID2|VPNID2|根据现网规划填写。
LOCADDR2|本地IP地址2|根据现网规划填写。
REMADDR2|对端IP地址2|根据现网规划填写。
PROTOCALTYPE|应用协议类型|选择DIAMETER。


配置Diameter链路。 
每局配置4条Diameter链路。 
[ADD DIM
RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=261,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM1";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=262,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM2";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=263,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM3";
[ADD DIM RCPLINK](../../Npcf_PolicyManagement\zh-CN\mml\1437238.html):LINKNO=264,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM4";
参数说明参见[表17](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__d3ab0210-0152-4ded-b1f7-09f98ae75061)。
参数|参数名称|取值说明
---|---|---
LINKNO|链路号|保持默认值。
LOCALHOSTNAME|本端主机名称|根据现网规划填写。
LOCALREALM|本端域名|根据现网规划填写。
DSTHOSTNAME|对端主机名称|根据现网规划填写。
DSTREALM|对端域名|根据现网规划填写。
ADJTYPE|邻接局类型|选择PCRF。
CONNID|SCTP标识|保持默认值。
PROTOCOL|承载协议类型|选择SCTP。
NAME|链路名称|根据现网规划填写。


配置Diameter路由组。 
每局配置3个Diameter路由组。 
[ADD
DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=261,GROUPNAME="PCF02-Gx",GROUPPTY="LOADBALANCE";
[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=262,GROUPNAME="PCF02-Rx",GROUPPTY="LOADBALANCE";
[ADD DIM ROUTEGRPPTY](../../Npcf_PolicyManagement\zh-CN\mml\1437284.html):GROUPNO=263,GROUPNAME="PCF02-Sy",GROUPPTY="LOADBALANCE";
参数说明参见[表18](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__ce5b6425-c3ed-4366-a04f-415a5c73780f)。
参数|参数名称|取值说明
---|---|---
GROUPNO|路由组编号|保持默认值。
GROUPNAME|路由组名称|根据现网规划填写。
GROUPPTY|路由组属性|选择负荷分担。


配置Diameter路由。 
每局配置12条Diameter路由。 
[ADD DIM
ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2619,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2620,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2621,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
[ADD DIM ROUTE](../../Npcf_PolicyManagement\zh-CN\mml\1437230.html):ROUTENO=2622,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER";
参数说明参见[表19](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__22955a20-2e2b-4cf2-8feb-a04736eedab5)。
参数|参数名称|取值说明
---|---|---
ROUTENO|路由编号|保持默认值。
LOCALPROCESSID|本地动作|保持默认值。
MASTERLINKNO|主用链路|保持默认值。
ROUTEPRIORITY|路由优先级|选择高。
ROUTEAPPID|支持应用|选择Gx、Rx和Sy。
DESTURI|目的URI|根据现网规划填写。
ROUTEGROUPNO|路由组编号|保持默认值。


执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传送数据，生效配置。




配置服务优先级。 
配置PCF服务优先级，所有PCF局的服务优先级一致。 
[SET
PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF",PRIORITY=X
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_SMPOLICYCONTROL",PRIORITY=X
[SET PCFSERVICE](../../Npcf_PolicyManagement\zh-CN\mml\1787187.html):SERVICETYPE="NPCF_AMPOLICYCONTROL",PRIORITY=X


UDSF配置


配置NF标识。 
 说明： 

 
部署UDSF的局配置所有局的局NFID信息。 

 

 
未部署UDSF的局配置本局及主备UDSF局的NFID信息。 

 
部署UDSF的局（配置命令在Ncudr_SystemManagement_0服务下）： 
81局配置： 
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="self_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=84,NFNAME="PCF_84",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=85,NFNAME="PCF_85",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
82局配置： 
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="self_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=84,NFNAME="PCF_84",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=85,NFNAME="PCF_85",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
参数说明参见[表20](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__bc00efb3-0613-4399-89d2-ac82d6d9de6c)。
参数|参数名称|取值说明
---|---|---
NFID|NF标识|主局和pool中容灾局的局号。填写81~85。
NFNAME|NF名称|根据规划填写。
NFTYPE|NF类型|本局选择本地NF。容灾局选择不同TMSP内的NF。
未部署UDSF的局（配置命令在Ncudr_AccessManagement_0服务下）： 
83局配置： 
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=83,NFNAME="PCF_83",NFTYPE="self_nf",COMMTYPE="NULL";
84局配置： 
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=84,NFNAME="PCF_84",NFTYPE="self_nf",COMMTYPE="NULL";
85局配置： 
[ADD NFCFG](None):NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL";
[ADD NFCFG](None):NFID=85,NFNAME="PCF_85",NFTYPE="self_nf",COMMTYPE="NULL";
参数说明参见[表21](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__5134d71d-3f12-4064-9d21-22b77a4b74c1)。
参数|参数名称|取值说明
---|---|---
NFID|NF标识|配置本局和主备UDSF局局号。本局填写83或84或85，容灾局填写81、82。
NFNAME|NF名称|根据规划填写。
NFTYPE|NF类型|本局选择本地NF。容灾局选择不同TMSP内的NF。


配置网关通信。 
UDSF局和非UDSF局均需要配置。 
UDSF局配置所有局的CGW节点信息。 
非UDSF局配置本局和UDSF局的CGW节点信息。 
UDSF局配置（配置命令在Ncudr_SystemManagement_0服务下）： 
81局、82局配置相同： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
[ADD CGWNODE](None):NFID=83,NETTYPE="data_sync_1",IP="240E:0180:02E3:FF00::000C",SERVERPORTSTART=31000,SERVERPORTEND=31031,CONNECTPORTSTART=51000,CONNECTPORTEND=51512,NFLIST="83",VPNID=21;
[ADD CGWNODE](None):NFID=84,NETTYPE="data_sync_1",IP="240E:0180:02E4:FF00::000C",SERVERPORTSTART=32000,SERVERPORTEND=32031,CONNECTPORTSTART=52000,CONNECTPORTEND=52512,NFLIST="84",VPNID=21;
[ADD CGWNODE](None):NFID=85,NETTYPE="data_sync_1",IP="240E:0180:02E5:FF00::000C",SERVERPORTSTART=33000,SERVERPORTEND=33031,CONNECTPORTSTART=53000,CONNECTPORTEND=53512,NFLIST="85",VPNID=21;
参数说明参见[表22](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__f8e455f2-9031-48f9-8f0c-1ac8ebab158b)。
参数|参数名称|取值说明
---|---|---
NFID|NF ID|CGW所在NF的唯一标识。UDSF局配置所有局的局号。
NETTYPE|网络用途|数据同步选择数据同步网络1。
IP|IP地址|NFID对应的容灾业务地址，根据现网规划填写。
SERVERPORTSTART|监听端口最小值|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。
SERVERPORTEND|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。|监听端口最大值
CONNECTPORTSTART|连接端口最小值|连接端口最小值和最大值。按示例配置，不需要修改。
CONNECTPORTEND|连接端口最小值和最大值。按示例配置，不需要修改。|连接端口最大值
NFLIST|NF列表|NF列表，和NFID保持一致。
VPNID|VPN ID|容灾业务地址关联VPNID，根据现网规划填写。
非UDSF局配置（配置命令在Ncudr_AccessManagement_0服务下）： 
83局配置： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
[ADD CGWNODE](None):NFID=83,NETTYPE="data_sync_1",IP="240E:0180:02E3:FF00::000C",SERVERPORTSTART=31000,SERVERPORTEND=31031,CONNECTPORTSTART=51000,CONNECTPORTEND=51512,NFLIST="83",VPNID=21;
84局配置： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
[ADD CGWNODE](None):NFID=84,NETTYPE="data_sync_1",IP="240E:0180:02E4:FF00::000C",SERVERPORTSTART=32000,SERVERPORTEND=32031,CONNECTPORTSTART=52000,CONNECTPORTEND=52512,NFLIST="84",VPNID=21;
85局配置： 
[ADD CGWNODE](None):NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21;
[ADD CGWNODE](None):NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21;
[ADD CGWNODE](None):NFID=85,NETTYPE="data_sync_1",IP="240E:0180:02E5:FF00::000C",SERVERPORTSTART=33000,SERVERPORTEND=33031,CONNECTPORTSTART=53000,CONNECTPORTEND=53512,NFLIST="85",VPNID=21;
参数说明参见[表23](1622870309740.html#ze16a95a54b5a4dc8bb4ec0983b3b8e06__a24351eb-c34e-43c6-9eac-4eebe7884875)。
参数|参数名称|取值说明
---|---|---
NFID|NF ID|CGW所在NF的唯一标识。非UDSF局配置主局、备局局号以及本局局号。
NETTYPE|网络用途|数据同步选择数据同步网络1。
IP|IP地址|NFID对应的容灾业务地址，根据现网规划填写。
SERVERPORTSTART|监听端口最小值|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。
SERVERPORTEND|侦听端口最小值和最大值。根据现网规划填写。监听端口最大值=监听端口最小值+31。|监听端口最大值
CONNECTPORTSTART|连接端口最小值|连接端口最小值和最大值。按示例配置，不需要修改。
CONNECTPORTEND|连接端口最小值和最大值。按示例配置，不需要修改。|连接端口最大值
NFLIST|NF列表|NF列表，和NFID保持一致。
VPNID|VPN ID|容灾业务地址关联VPNID，根据现网规划填写。


传表，生效配置 
[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html):STYPE="ALL",INCREF="NO"




######## 配置检查 
配置完成后，检查容灾功能是否正常。 


查询UDSF数据通信状态。 
在EM上网元服务Ncudr_Access_0命令树节点，执行[SHOW CGW LINK](../../Ncudr_Access\zh-cn\mml\1190751.html)命令，查询UDSF数据通信状态，所有链路状态需要为正常。


查询容灾局信息。 
在EM上Npcf_SMPolicyControl_0命令树节点，执行[SHOW_DR_NFINFO](../../Npcf_SMPolicyControl\zh-cn\mml\1137123.html)命令，查询组成容灾关系的各局点的基本信息，能获取到各局点信息和运行情况。
 说明： 
如果能够查询到host_name、realm、qdn，检查配置是否正确。 


查询Diameter链路状态。 
在EM上Npcf_SystemManagement_0命令树节点，执行[SHOW DIMLNKSTAT](../../Npcf_SystemManagement\zh-cn\mml\1137401.html)命令，查询所有Diameter链路的概要信息，查询结果中链路状态需要为建链成功。




######## 配置脚本 
说明
PCF容灾主要有3种类型配置： 

 
PCF01（部署主用UDSF） 

 
PCF02（部署备用UDSF） 

 
PCF03（不部署UDSF） 

 
若只有2个局，参考PCF01和PCF02配置，若有3个及以上局参考PCF01~PCF03配置。 
PCF01配置
----------------------------- 
--部署主用UDSF的PCF局配置-------- 
--【1】~【3】为PCF的存储相关的UDSF相关的配置 
--【4】~【11】为PCF的业务相关功能配置 
----------------------------- 
--【1】 增加NF标识配置  
----------------------------- 
ADD NFCFG:NFID=81,NFNAME="PCF_81",NFTYPE="self_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
----------------------------- 
--【2】 增加租户配置 
--需要保证ACCESSPOLICY取值为master_access_pri 
----------------------------- 
SET CDBTENANT:TENANTID=1,ACCESSPOLICY="master_access_pri";
----------------------------- 
--【3】 增加CGW互联配置  
----------------------------- 
ADD CGWNODE:NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21,DSCP=0;
ADD CGWNODE:NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21,DSCP=0;
ADD CGWNODE:NFID=83,NETTYPE="data_sync_1",IP="240E:0180:02E3:FF00::000C",SERVERPORTSTART=31000,SERVERPORTEND=31031,CONNECTPORTSTART=51000,CONNECTPORTEND=51512,NFLIST="83",VPNID=21,DSCP=0;
----------------------------- 
--【4】 修改容灾全局  
----------------------------- 
SET DRCFG:DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="YES";
----------------------------- 
--【5】 增加POOL 
--需要把POOL中所有的局都列入进去，只在后面填没有的局0 
----------------------------- 
ADD POOLCFG:NEID1=81,NEID2=82,NEID3=83,NEID4=84,NEID5=85,NEID6=0,NEID7=0,NEID8=0;
----------------------------- 
--【6】 新增本局 
--若已有配置，需要保证本局局号与规划一致，TENANTNAME和PUBTENANTNAME取值与【2】配置的TENANTNAME取值一致 
----------------------------- 
ADD NFINFO:NFID=81,HOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="SC_pcf_pool1",LOCALITY="CHENGDU";
----------------------------- 
---【7】 新增SCTP  
---每个PCF和POOL中的其他PCF都需要配置 
---PCF01-PCF02-SCTP1 
---PCF01-PCF03-SCTP1 
---PCF01-PCF04-SCTP1 
---PCF01-PCF05-SCTP1 
------------------------------- 
ADD SCTP:ID=261,NAME="PCF01-PCF02-SCTP1",LOCPORT=8121,REMPORT=18121,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=262,NAME="PCF01-PCF02-SCTP2",LOCPORT=8122,REMPORT=18122,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=263,NAME="PCF01-PCF02-SCTP3",LOCPORT=8123,REMPORT=18123,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=264,NAME="PCF01-PCF02-SCTP4",LOCPORT=8124,REMPORT=18124,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=271,NAME="PCF01-PCF03-SCTP1",LOCPORT=8131,REMPORT=18131,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=272,NAME="PCF01-PCF03-SCTP2",LOCPORT=8132,REMPORT=18132,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=273,NAME="PCF01-PCF03-SCTP3",LOCPORT=8133,REMPORT=18133,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=274,NAME="PCF01-PCF03-SCTP4",LOCPORT=8134,REMPORT=18134,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=281,NAME="PCF01-PCF04-SCTP1",LOCPORT=8141,REMPORT=18141,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=282,NAME="PCF01-PCF04-SCTP2",LOCPORT=8142,REMPORT=18142,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=283,NAME="PCF01-PCF04-SCTP3",LOCPORT=8143,REMPORT=18143,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=284,NAME="PCF01-PCF04-SCTP4",LOCPORT=8144,REMPORT=18144,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=291,NAME="PCF01-PCF05-SCTP1",LOCPORT=8151,REMPORT=18151,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=292,NAME="PCF01-PCF05-SCTP2",LOCPORT=8152,REMPORT=18152,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=293,NAME="PCF01-PCF05-SCTP3",LOCPORT=8153,REMPORT=18153,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=294,NAME="PCF01-PCF05-SCTP4",LOCPORT=8154,REMPORT=18154,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
----------------------------- 
--【8】 增加Diameter链路 
--对应的Diameter链路配置 
----------------------------- 
ADD
DIM RCPLINK:LINKNO=261,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=262,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=263,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=264,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=271,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=271,PROTOCOL="SCTP",NAME="PCF01-PCF03-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=272,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=272,PROTOCOL="SCTP",NAME="PCF01-PCF03-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=273,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=273,PROTOCOL="SCTP",NAME="PCF01-PCF03-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=274,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=274,PROTOCOL="SCTP",NAME="PCF01-PCF03-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=281,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=281,PROTOCOL="SCTP",NAME="PCF01-PCF04-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=282,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=282,PROTOCOL="SCTP",NAME="PCF01-PCF04-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=283,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=283,PROTOCOL="SCTP",NAME="PCF01-PCF04-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=284,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=284,PROTOCOL="SCTP",NAME="PCF01-PCF04-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=291,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=291,PROTOCOL="SCTP",NAME="PCF01-PCF05-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=292,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=292,PROTOCOL="SCTP",NAME="PCF01-PCF05-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=293,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=293,PROTOCOL="SCTP",NAME="PCF01-PCF05-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=294,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=294,PROTOCOL="SCTP",NAME="PCF01-PCF05-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
----------------------------- 
--【9】 增加Diameter路由组属性 
----------------------------- 
ADD DIM ROUTEGRPPTY:GROUPNO=261,GROUPNAME="PCF02-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=262,GROUPNAME="PCF02-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=271,GROUPNAME="PCF03-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=272,GROUPNAME="PCF03-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=281,GROUPNAME="PCF04-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=282,GROUPNAME="PCF04-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=291,GROUPNAME="PCF05-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=292,GROUPNAME="PCF05-Rx",GROUPPTY="LOADBALANCE"; 
----------------------------- 
--【10】 增加Diameter路由  
----------------------------- 
ADD DIM ROUTE:ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2711,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2712,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2713,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2714,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2715,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2716,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2717,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2718,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2811,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2812,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2813,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2814,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2815,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2816,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2817,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2818,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2911,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2912,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2913,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2914,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2915,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2916,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2917,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2918,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
----------------------------- 
--【11】 和服务优先级相关的配置  
--基于实际需要配置，优先级高低与取值相反，主备方式，主局优先级取值要小，PCF局间为负荷模式，各个服务优先级保持一样 
----------------------------- 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf01-B-ze-dc01.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";
ADD PCFSERVICE:SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf01-B-ze-dc01.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";
PCF02配置
----------------------------- 
--部署备用UDSF的PCF局配置-------- 
--【1】~【3】为PCF的UDSF相关的配置 
--【4】~【11】为PCF的业务相关功能配置 
----------------------------- 
--【1】 增加NF标识配置  
--这里需要配置所有相关的局 
----------------------------- 
ADD NFCFG:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=82,NFNAME="PCF_82",NFTYPE="self_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
----------------------------- 
--【2】 增加租户配置 
--需要保证ACCESSPOLICY取值为master_access_pri 
----------------------------- 
SET CDBTENANT:TENANTID=1,ACCESSPOLICY="master_access_pri";
----------------------------- 
--【3】 增加CGW互联配置  
----------------------------- 
ADD CGWNODE:NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21,DSCP=0;
ADD CGWNODE:NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21,DSCP=0;
ADD CGWNODE:NFID=83,NETTYPE="data_sync_1",IP="240E:0180:02E3:FF00::000C",SERVERPORTSTART=31000,SERVERPORTEND=31031,CONNECTPORTSTART=51000,CONNECTPORTEND=51512,NFLIST="83",VPNID=21,DSCP=0;
----------------------------- 
--【4】 修改容灾全局  
----------------------------- 
SET DRCFG:DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="YES"; 
----------------------------- 
--【5】 增加POOL 
--需要把POOL中所有的局都列入进去，只在后面填没有的局0 
----------------------------- 
ADD POOLCFG:NEID1=81,NEID2=82,NEID3=83,NEID4=84,NEID5=85,NEID6=0,NEID7=0,NEID8=0;
----------------------------- 
--【6】 新增本局 
--若已有配置，需要保证本局局号与规划一致，TENANTNAME和PUBTENANTNAME取值与【2】配置的TENANTNAME取值一致 
----------------------------- 
ADD NFINFO:NFID=82,HOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="SC_pcf_pool1",LOCALITY="CHENGDU";
----------------------------- 
---【7】 新增SCTP  
---每个PCF和POOL中的其他PCF都需要配置 
---PCF01-PCF02-SCTP1 
---PCF01-PCF03-SCTP1 
---PCF01-PCF04-SCTP1 
---PCF01-PCF05-SCTP1 
------------------------------- 
ADD SCTP:ID=261,NAME="PCF02-PCF01-SCTP1",LOCPORT=18121,REMPORT=8121,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::0016",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=262,NAME="PCF02-PCF01-SCTP2",LOCPORT=18122,REMPORT=8122,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::0015",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=263,NAME="PCF02-PCF01-SCTP3",LOCPORT=18123,REMPORT=8123,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::0016",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=264,NAME="PCF02-PCF01-SCTP4",LOCPORT=18124,REMPORT=8124,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::0015",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=271,NAME="PCF02-PCF03-SCTP1",LOCPORT=8231,REMPORT=18231,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=272,NAME="PCF02-PCF03-SCTP2",LOCPORT=8232,REMPORT=18232,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=273,NAME="PCF02-PCF03-SCTP3",LOCPORT=8233,REMPORT=18233,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=274,NAME="PCF02-PCF03-SCTP4",LOCPORT=8234,REMPORT=18234,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=281,NAME="PCF02-PCF04-SCTP1",LOCPORT=8241,REMPORT=18241,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=282,NAME="PCF02-PCF04-SCTP2",LOCPORT=8242,REMPORT=18242,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=283,NAME="PCF02-PCF04-SCTP3",LOCPORT=8243,REMPORT=18243,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=284,NAME="PCF02-PCF04-SCTP4",LOCPORT=8244,REMPORT=18244,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=291,NAME="PCF02-PCF05-SCTP1",LOCPORT=8251,REMPORT=18251,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=292,NAME="PCF02-PCF05-SCTP2",LOCPORT=8252,REMPORT=18252,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=293,NAME="PCF02-PCF05-SCTP3",LOCPORT=8253,REMPORT=18253,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0015",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0016",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=294,NAME="PCF02-PCF05-SCTP4",LOCPORT=8254,REMPORT=18254,VPNID1=12,LOCADDR1="240E:0180:02E2:FF00::0016",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E2:FF00::0015",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
----------------------------- 
--【8】 增加Diameter链路 
--对应的Diameter链路配置 
----------------------------- 
ADD
DIM RCPLINK:LINKNO=261,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF02-PCF01-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=262,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF02-PCF01-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=263,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF02-PCF01-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=264,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF02-PCF01-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=271,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=271,PROTOCOL="SCTP",NAME="PCF02-PCF03-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=272,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=272,PROTOCOL="SCTP",NAME="PCF02-PCF03-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=273,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=273,PROTOCOL="SCTP",NAME="PCF02-PCF03-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=274,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=274,PROTOCOL="SCTP",NAME="PCF02-PCF03-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=281,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=281,PROTOCOL="SCTP",NAME="PCF02-PCF04-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=282,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=282,PROTOCOL="SCTP",NAME="PCF02-PCF04-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=283,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=283,PROTOCOL="SCTP",NAME="PCF02-PCF04-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=284,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=284,PROTOCOL="SCTP",NAME="PCF02-PCF04-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=291,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=291,PROTOCOL="SCTP",NAME="PCF02-PCF05-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=292,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=292,PROTOCOL="SCTP",NAME="PCF02-PCF05-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=293,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=293,PROTOCOL="SCTP",NAME="PCF02-PCF05-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=294,LOCALHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=294,PROTOCOL="SCTP",NAME="PCF02-PCF05-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
----------------------------- 
--【9】 增加Diameter路由组属性 
----------------------------- 
ADD DIM ROUTEGRPPTY:GROUPNO=261,GROUPNAME="PCF01-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=262,GROUPNAME="PCF01-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=271,GROUPNAME="PCF03-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=272,GROUPNAME="PCF03-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=281,GROUPNAME="PCF04-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=282,GROUPNAME="PCF04-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=291,GROUPNAME="PCF05-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=292,GROUPNAME="PCF05-Rx",GROUPPTY="LOADBALANCE"; 
----------------------------- 
--【10】 增加Diameter路由  
----------------------------- 
ADD DIM ROUTE:ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2711,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2712,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2713,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2714,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2715,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2716,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2717,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2718,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2811,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2812,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2813,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2814,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2815,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0; 
ADD DIM ROUTE:ROUTENO=2816,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0; 
ADD DIM ROUTE:ROUTENO=2817,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2818,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2911,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2912,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2913,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2914,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2915,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2916,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2917,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2918,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
----------------------------- 
--【11】 和服务优先级相关的配置  
--基于实际需要配置，优先级高低与取值相反，主备方式，主局优先级取值要小，PCF局间为负荷模式，各个服务优先级保持一样 
----------------------------- 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf02-B-ze-dc02.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";
ADD PCFSERVICE:SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf02-B-ze-dc02.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";
PCF03配置
----------------------------- 
--没有部署UDSF的PCF局配置-------- 
--【1】~【4】为PCF的的UDSF相关的配置 
--【5】~【12】为PCF的业务相关功能配置 
----------------------------- 
--【1】 增加NF配置 
--需要配置所有相关的局 
----------------------------- 
ADD NFCFG:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"; 
ADD NFCFG:NFID=83,NFNAME="PCF_83",NFTYPE="self_nf",COMMTYPE="NULL"; 
----------------------------- 
--【2】增加CGW互联配置  
----------------------------- 
ADD CGWNODE:NFID=81,NETTYPE="data_sync_1",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35031,CONNECTPORTSTART=50000,CONNECTPORTEND=50512,NFLIST="81",VPNID=21,DSCP=0; 
ADD CGWNODE:NFID=82,NETTYPE="data_sync_1",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36031,CONNECTPORTSTART=56000,CONNECTPORTEND=56512,NFLIST="82",VPNID=21,DSCP=0; 
ADD CGWNODE:NFID=83,NETTYPE="data_sync_1",IP="240E:0180:02E3:FF00::000C",SERVERPORTSTART=31000,SERVERPORTEND=31031,CONNECTPORTSTART=51000,CONNECTPORTEND=51512,NFLIST="83",VPNID=21,DSCP=0; 
----------------------------- 
--【5】 修改容灾全局  
----------------------------- 
SET DRCFG:DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="YES"; 
----------------------------- 
--【6】 增加POOL 
--需要把POOL中所有的局都列入进去，只在后面填没有的局0 
----------------------------- 
ADD POOLCFG:NEID1=81,NEID2=82,NEID3=83,NEID4=84,NEID5=85,NEID6=0,NEID7=0,NEID8=0;
----------------------------- 
--【7】 新增本局 
--若已有配置，需要保证本局局号与规划一致，TENANTNAME和PUBTENANTNAME取值与带UDSF局的【2】配置的TENANTNAME取值一致 
----------------------------- 
ADD NFINFO:NFID=81,HOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="SC_pcf_pool1",LOCALITY="CHENGDU";
----------------------------- 
---【8】 新增SCTP  
---每个PCF和POOL中的其他PCF都需要配置 
---PCF03-PCF01-SCTP1 
---PCF03-PCF02-SCTP1 
---PCF03-PCF04-SCTP1 
---PCF03-PCF05-SCTP1 
------------------------------- 
ADD SCTP:ID=261,NAME="PCF03-PCF01-SCTP1",LOCPORT=18131,REMPORT=8131,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E1:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E1:FF00::0016",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=262,NAME="PCF03-PCF01-SCTP2",LOCPORT=18132,REMPORT=8132,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E1:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E1:FF00::0015",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=263,NAME="PCF03-PCF01-SCTP3",LOCPORT=18133,REMPORT=8133,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E1:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E1:FF00::0016",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=264,NAME="PCF03-PCF01-SCTP4",LOCPORT=18134,REMPORT=8134,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E1:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E1:FF00::0015",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=271,NAME="PCF03-PCF02-SCTP1",LOCPORT=18231,REMPORT=8231,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E2:FF00::0016",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=272,NAME="PCF03-PCF02-SCTP2",LOCPORT=18232,REMPORT=8232,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E2:FF00::0015",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=273,NAME="PCF03-PCF02-SCTP3",LOCPORT=18233,REMPORT=8233,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E2:FF00::0016",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=274,NAME="PCF03-PCF02-SCTP4",LOCPORT=18234,REMPORT=8234,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E2:FF00::0015",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=281,NAME="PCF03-PCF04-SCTP1",LOCPORT=8341,REMPORT=18341,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=282,NAME="PCF03-PCF04-SCTP2",LOCPORT=8342,REMPORT=18342,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=283,NAME="PCF03-PCF04-SCTP3",LOCPORT=8343,REMPORT=18343,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E2:FF00::003A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E2:FF00::004A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=284,NAME="PCF03-PCF04-SCTP4",LOCPORT=8344,REMPORT=18344,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E2:FF00::004A",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E2:FF00::003A",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=291,NAME="PCF03-PCF05-SCTP1",LOCPORT=8351,REMPORT=18351,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=292,NAME="PCF03-PCF05-SCTP2",LOCPORT=8352,REMPORT=18352,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="SVR",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=293,NAME="PCF03-PCF05-SCTP3",LOCPORT=8353,REMPORT=18353,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::003A",REMADDR1="240E:0180:02E1:FF00::003E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::004A",REMADDR2="240E:0180:02E1:FF00::004E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
ADD SCTP:ID=294,NAME="PCF03-PCF05-SCTP4",LOCPORT=8354,REMPORT=18354,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::004A",REMADDR1="240E:0180:02E1:FF00::004E",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::003A",REMADDR2="240E:0180:02E1:FF00::003E",VPNID3=0,VPNID4=0,ROLE="CLT",INSTRM=16,OUTSTRM=16,MAXRTRY=5,MAXRTO=500,MINRTO=50,INITRTO=100,QOSTYPE="NULL",QOSVALUE=0,HB=500,MAXBURST=0,FIXNH="CLOSE",SCTPMAXRTRYNUM=10,DELAYACK=20,PMTU=0,PRIMARYPATH="REMIP1",BREAKTIME=0,CB=50,MINCWND=0,PLTIMER=10,MPPLTHRD=100,DPLEN="MTU",CHECKSUM="ADAPTIVE",CROSSLINK="CLOSE",SCTPALARM="CONFORM",DROPPKTSTREAM=0,DROPPKTSWITCH="ON",SNDBUFLEN=0,RCVBUFLEN=0,OFCID=0,PROTOCALTYPE="DIAMETER",MPDTHRD=0;
----------------------------- 
--【9】 增加Diameter链路 
--对应的Diameter链路配置 
----------------------------- 
ADD
DIM RCPLINK:LINKNO=261,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF03-PCF01-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=262,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF03-PCF01-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=263,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF03-PCF01-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=264,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF03-PCF01-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=271,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=271,PROTOCOL="SCTP",NAME="PCF03-PCF02-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=272,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=272,PROTOCOL="SCTP",NAME="PCF03-PCF02-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=273,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=273,PROTOCOL="SCTP",NAME="PCF03-PCF02-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=274,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=274,PROTOCOL="SCTP",NAME="PCF03-PCF02-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=281,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=281,PROTOCOL="SCTP",NAME="PCF03-PCF04-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=282,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=282,PROTOCOL="SCTP",NAME="PCF03-PCF04-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=283,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=283,PROTOCOL="SCTP",NAME="PCF03-PCF04-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=284,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=284,PROTOCOL="SCTP",NAME="PCF03-PCF04-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=291,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=291,PROTOCOL="SCTP",NAME="PCF03-PCF05-DIM1",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=292,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=292,PROTOCOL="SCTP",NAME="PCF03-PCF05-DIM2",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=293,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=293,PROTOCOL="SCTP",NAME="PCF03-PCF05-DIM3",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
ADD DIM RCPLINK:LINKNO=294,LOCALHOSTNAME="pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=294,PROTOCOL="SCTP",NAME="PCF03-PCF05-DIM4",HEARTBEAT="YES",HEARTBEATCYCLE=30,HEARTBEATTIMES=3,TLSENABLED="NO",PPID="ANY",BLOCKFLAG="UNBLOCK";
----------------------------- 
--【10】 增加Diameter路由组属性 
----------------------------- 
ADD DIM ROUTEGRPPTY:GROUPNO=261,GROUPNAME="PCF02-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=262,GROUPNAME="PCF02-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=271,GROUPNAME="PCF03-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=272,GROUPNAME="PCF03-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=281,GROUPNAME="PCF04-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=282,GROUPNAME="PCF04-Rx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=291,GROUPNAME="PCF05-Gx",GROUPPTY="LOADBALANCE"; 
ADD DIM ROUTEGRPPTY:GROUPNO=292,GROUPNAME="PCF05-Rx",GROUPPTY="LOADBALANCE"; 
----------------------------- 
--【11】 增加Diameter路由  
----------------------------- 
ADD DIM ROUTE:ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=261,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=262,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2711,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2712,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2713,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2714,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=271,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2715,LOCALPROCESSID="RELAY",MASTERLINKNO=271,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2716,LOCALPROCESSID="RELAY",MASTERLINKNO=272,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2717,LOCALPROCESSID="RELAY",MASTERLINKNO=273,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2718,LOCALPROCESSID="RELAY",MASTERLINKNO=274,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=272,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2811,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2812,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0; 
ADD DIM ROUTE:ROUTENO=2813,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2814,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=281,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2815,LOCALPROCESSID="RELAY",MASTERLINKNO=281,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2816,LOCALPROCESSID="RELAY",MASTERLINKNO=282,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2817,LOCALPROCESSID="RELAY",MASTERLINKNO=283,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2818,LOCALPROCESSID="RELAY",MASTERLINKNO=284,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=282,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2911,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2912,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2913,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2914,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=291,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2915,LOCALPROCESSID="RELAY",MASTERLINKNO=291,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2916,LOCALPROCESSID="RELAY",MASTERLINKNO=292,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2917,LOCALPROCESSID="RELAY",MASTERLINKNO=293,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
ADD DIM ROUTE:ROUTENO=2918,LOCALPROCESSID="RELAY",MASTERLINKNO=294,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DESTURIOPTYPE="LMFR",SPECFLAG="COMM",ROUTEGROUPNO=292,MASTERFLAG="MASTER",OTHCONDNO1=0,OTHCONDNO2=0,OTHCONDNO3=0,OTHCONDNO4=0,PEERHOSTNAME="",WEIGHT=0;
----------------------------- 
--【12】 和服务优先级相关的配置  
--基于实际需要配置，优先级高低与取值相反，主备方式，主局优先级取值要小，PCF局间为负荷模式，各个服务优先级保持一样 
----------------------------- 
ADD PCFSERVICE:SERVICETYPE="NPCF",VERSION="v1",FQDN="pcf03-B-ze-dc01.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";
ADD PCFSERVICE:SERVICETYPE="NPCF_SMPOLICYCONTROL",VERSION="v1",FQDN="pcf03-B-ze-dc01.cd.sc.node.5gc.mnc011.mcc460.3gppnetwork.org",PRIORITY=1,CAPACITY=0,SERVERID=1&0,TOPHIDE="NOTHIDE";




##### 测试用例 
测试条目|数据业务SA接入的PCF容灾
---|---
预置条件|UDR独立部署，2套PUDR实时主备。2套PCF组成Pool与主备PUDR链路正常。SA网络中各网元运行正常，SMF（AMF可选）开启PCC功能。UE1、UE2在UDM中已签约5G SA业务。UE1、UE2在主用PUDR中已开户并签约业务。
测试步骤|用户UE1发起PDU会话建立请求，AMF根据DNN和切片信息选择SMF，并转发该请求给SMF。SMF从UDM获取用户会话签约信息，核实用户的PDU会话建立请求，并分配用户IP地址，选择UPF建立PDU会话。同时，SMF通过NRF查询用户的数据DNN对应的PCF，向PCF请求用户的PDU会话策略。SMF成功建立PDU会话。PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。SMF使用PCF2。用户UE1的PDU会话发起修改请求，此时SMF标记PCF1故障，SMF为用户使用本地的PCC规则，完成PDU会话修改。用户UE2发起PDU会话建立请求，AMF为该用户会话选择SMF。SMF为用户UE2选择PCF2，请求PCC策略。SMF完成用户UE2的PDU会话建立请求。
通过准则|PCF1故障，SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。PCF1故障后，PCF2可以接管PCF1上的业务。UE2在SMF感知PCF1故障后建立会话，会直接选择PCF2，流程正常。PCF1恢复正常，NRF通知SMF，后续的用户PDU会话建立请求，SMF根据该用户DNN和切片对应的PCF地址表，按照负荷分担的方式选择PCF，为用户获取PDU会话的PCC策略。
测试条目|语音业务SA接入的PCF容灾流程
---|---
预置条件|2套PCF组成Pool。SA网络中各网元运行正常，SMF/AMF开启PCC功能，N7接口链路配置正常。UE1、UE2在UDM中已签约5G SA业务。
测试步骤|用户UE1发起PDU会话建立请求，AMF根据DNN和切片信息选择SMF，并转发该请求给SMF。SMF从UDM获取用户会话签约信息，核实用户的PDU会话建立请求，并分配用户IP地址，选择UPF建立PDU会话。同时，SMF通过NRF查询用户的语音DNN对应的本地PCF列表， 按照负荷分担方式选择PCF1发送用户PDU会话建立消息。SMF成功建立语音IMS PDU会话。PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。SMF使用PCF2。用户UE1的PDU会话发起修改请求，此时SMF标记PCF1故障，向PCF2发送用户的PCC事件上报消息，通知用户语音会话的事件信息。用户UE2发起PDU会话建立请求，AMF为该用户的语音会话选择SMF。SMF为用户UE2选择PCF2，请求PCC策略。SMF成功完成用户UE2的语音PDU会话建立请求。PCF1恢复正常，NRF通知SMF，后续的新用户语音PDU会话建立请求，SMF在PCF的可用列表中，按照负荷分担方式选择PCF，为用户获取PDU会话的PCC策略。
通过准则|PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。PCF1故障后，PCF2可以接管PCF1上的业务。PCF1恢复正常，NRF会通知SMF对应的PCF恢复，后续的用户PDU会话建立请求，SMF根据该用户DNN和切片对应的PCF地址表中，按照负荷分担的方式选择PCF，为用户获取PDU会话的PCC策略。
测试条目|数据业务NSA接入（XGW等传统网关接入）的PCF容灾
---|---
预置条件|2套PCF组成Pool。NSA网络中各网元运行正常，XGW等传统网关和PCF间网络正常。UE1、UE2在UDM中已签约5G SA业务。
测试步骤|用户UE1发起PDU会话建立请求，AMF根据DNN和切片信息选择SMF，并转发该请求给SMF。SMF从UDM获取用户会话签约信息，核实用户的PDU会话建立请求，并分配用户IP地址，选择UPF建立PDU会话。SMF通过NRF查询用户的数据DNN对应的PCF，向PCF请求用户的PDU会话策略。SMF成功建立PDU会话。PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。SMF使用PCF2。用户UE1的PDU会话发起修改请求，SMF标记PCF1故障，SMF为用户使用本地的PCC规则，完成PDU会话修改。用户UE2发起PDU会话建立请求，AMF为该用户会话选择SMF。SMF为用户UE2选择PCF2，请求PCC策略。SMF完成用户UE2的PDU会话建立请求。
通过准则|PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。PCF1故障后，PCF2可以接管PCF1上的业务。PCF1恢复正常，NRF会通知SMF对应的PCF恢复，后续的用户PDU会话建立请求，SMF根据该用户DNN和切片对应的PCF地址表，按照负荷分担的方式选择PCF，为用户获取PDU会话的PCC策略。
测试条目|语音业务NSA接入（XGW等传统网关接入）的PCF容灾
---|---
预置条件|2套PCF组成Pool。NSA网络中各网元运行正常，XGW等传统网关和PCF间网络正常。UE1、UE2在UDM中已签约5G SA业务。
测试步骤|用户UE1发起PDN连接建立请求，MME根据用户5G签约信息，以及DNN选择SAE GW-C/SMF，并转发该请求给SAE GW-C/SMF。SAE GW-C/SMF通过NRF获取用户语音会话的本地PCF地址，并选择PCF1。SAE GW-C/SMF向PCF1，发送语音PDN连接建立消息，获取PCC策略。SAE GW-C/SMF成功建立语音IMS PDU会话。PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。SMF使用PCF2。用户UE1的语音业务激活，PCF2发起承载修改请求， PCF2获取了用户的PCC上下文信息，PCF2向用户会话所在的SAE GW-C/SMF发送语音业务流承载建立请求。SAE GW-C/SMF向MME发送更新承载请求消息。MME通知eNB为用户建立专用承载。eNB通知UE1建立语音业务流的专用承载。UE1发送应答消息给eNB，eNB发送承载建立响应消息给MME。MME发送更新承载响应消息给SAE GW-C/SMF，SAE GW-C/SMF发送专用承载建立成功消息给PCF2。用户UE1语音业务流专用承载建立成功。用户UE2发起语音PDN连接建立请求，MME根据用户5G签约和DNN信息，选择SAE GW-C/SMF。SAE GW-C/SMF向PCF2发送语音PDN连接建立消息，获取PCC策略。SAE GW-C/SMF与MME交互，完成用户UE2语音业务承载的建立流程。
通过准则|PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。PCF1故障后，PCF2可以接管PCF1上的业务。如果PCF1恢复正常，NRF会通知SMF对应的PCF恢复，后续的用户PDU会话建立请求，SMF根据该用户DNN和切片对应的PCF地址表中，按照负荷分担的方式选择可用PCF，为用户获取PDU会话的PCC策略。
测试条目|冷备的PCF容灾场景
---|---
预置条件|2套PCF配置为非容灾（PCF网元需要携带本地CDB且本地工作），两套PCF共用SPR。PCF各周边网元工作正常。UE1在UDM中已签约5G SA业务。
测试步骤|用户UE1发起PDN连接建立请求，MME根据用户5G签约信息，以及DNN选择SAE GW-C/SMF，并转发该请求给SAE GW-C/SMF。SAE GW-C/SMF通过NRF获取用户语音会话的本地PCF地址，并选择PCF1。SAE GW-C/SMF向PCF1发送语音PDN连接建立消息，获取PCC策略。SAE GW-C/SMF成功建立数据/语音IMS PDU会话。PCF1故障。SMF可以通过NRF的网元状态通知，或者业务信令监测机制，识别到PCF1故障。SMF使用PCF2。SMF将用户UE1后续请求发往PCF2，PCF2返回失败。用户PDN网络建立失败，用户UE1重新建立PDN网络连接请求，发往PCF2。PCF2返回成功，用户UE1PDN连接成功。
通过准则|PCF1故障后，后续请求发给PCF2，PCF2通过拒绝会话，使得用户重新接入。PCF2和PCF1均可以正常获取用户签约数据，两个PCF处理效果一致。
##### 常见问题处理 
###### 修改本局配置NFID 
卸载用户 
通过配置拒绝用户接入，使在线用户下线。 
清空本地UDSF数据。 
容灾局点的Ncudr_SystemManagement_0服务： 
[TRUNCATE CDB](../../Ncudr_SystemManagement\zh-cn\mml\1190615.html):TENANTID=1,CLEAR_NF_RANGE="ALL_NF"
修改本局配置NFID。 
 说明： 
本局配置NFID无法直接修改，需要先删除原来的配置，再增加新的配置。 
Npcf_PolicyManagement_0服务： 
[ADD NFINFO](../../Npcf_PolicyManagement\zh-CN\mml\1787416.html):NFID=83,HOSTNAME="pcf13-B-ze.cq.cq.node.epc.mnc011.mcc460.3gppnetwork.org",REALM="epc.mnc011.mcc460.3gppnetwork.org",TENANTNAME="tenant_1",PUBTENANTNAME="tenant_1",GROUPID="pcf-he-pool1",LOCALITY="HB.BAD.4F01"
参数说明参见[表24](1622870309740.html#z93d6734309a44702b53e1695720fd839__0ee4c2dc-9351-4596-b630-852be813a67d)。
参数|参数名称|取值说明
---|---|---
NFID|本局局向号|本局局号，根据实际填写。
HOSTNAME|Diameter主机名|4G主机名，根据现网规划填写。
REALM|Diameter域名|4G域名，根据现网规划填写。
TENANTNAME|租户名称|填写tenant_1。
PUBTENANTNAME|公共租户名称|填写tenant_1。
GROUPID|网元组编号|Pool组ID，根据现网规划填写。
LOCALITY|网元位置|位置信息，根据现网规划填写。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令同步配置数据。
###### 修改租户配置 
 小心！ 
修改租户配置，将造成整个资源池数据损失，请谨慎修改。 
清空UDSF数据。 
Ncudr_SystemManagement_0服务： 
[TRUNCATE CDB](../../Ncudr_SystemManagement\zh-cn\mml\1190615.html):TENANTID=1,CLEAR_NF_RANGE="ALL_NF"
修改租户配置。 
通过[SET CDBTENANT](../../Ncudr_SystemManagement\zh-cn\mml\1190001.html)命令修改相关参数，例如“租户名称”、“主用NF（局）标识”、“容灾NF（局）标识”。
Ncudr_SystemManagement_0服务： 
[SET CDBTENANT](../../Ncudr_SystemManagement\zh-cn\mml\1190001.html):TENANTID=1,TENANTNAME="tenant_1",NFID1=81,NFID2=82,ACCESSPOLICY="master_access_pri"
参数说明参见[表25](1622870309740.html#za376d92306a043b890f161edaae875fa__bc885739-c5cf-42c8-8325-7efd37d4cf3d)。
参数|参数名称|取值说明
---|---|---
TENANTID|租户ID|填写1。
TENANTNAME|租户名称|填写tenant_1。
NFID1|主用NF(局)标识|带UDSF主局局号，根据现网规划填写。
NFID2|备用NF(局)标识|带UDSF备局局号，根据现网规划填写。
ACCESSPOLICY|访问策略|访问策略，选择主用访问优先。
执行[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)命令，传送数据。
执行[RESET CDB](../../Ncudr_SystemManagement\zh-cn\mml\1190616.html)命令，生效配置。
V7.21.20.B2以前版本SSH方式登录到OMU浮动IP，执行RESET CDB命令。操作示例如下：[root@localhost admin]# ssh admin@10.43.224.212 -p 7722
The authenticity of host '[10.43.224.212]:
               7722 ([10.43.224.212]:7722) can't be established.
RSA key fingerprint is SHA256:dKPLkoRK12xxV/WiWuSkyy5aqoU0II+M+K+3lSc2Y0U.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[10.43.224.212]:7722' (RSA) to the list of known hosts.
admin@10.43.224.212's password:
PTY allocation request failed on channel 0
 
login username:admin
password:***********               
    //使用实际密码，可以尝试Z_tywg_2020，输错3次会锁定账户，避免操作错误。
zte:>查找类似CUDR-NF_10-40-66-233.Ncudr_SystemManagement_0.d6cc5cbb-aa55-4058-96aa-be0a2842e93b的服务名。zte:>show all appmode
ACK SHOW ALL APPMODE:
INFO="CUDR-NF_10-40-66-233.CommonS_TMSP_0.d6cc5cbb-aa55-4058-96aa-be0a2842e901"
-"V7.19.12.B3_patch_20191007"-"CommonS_TMSP_0"-"CommonS_TMSP_0"
&"CUDR-NF_10-40-66-233.Ncudr_SystemManagement_0.d6cc5cbb-aa55-4058-96aa-be0a2842e93b"
-"V7.19.10.B14a"-"Ncudr_SystemManagement_0"-"Ncudr_SystemManagement_0"
&"CUDR-NF_10-40-66-233.Nudsf_UnstructuredDataManagement
_0.d6cc5cbb-aa55-4058-96aa-be0a2842e938"
-"V7.19.10.B14a"-"Nudsf_UnstructuredDataManagement_0"
-"Nudsf_UnstructuredDataManagement_0"
&"CUDR-NF_10-40-66-233.Nudsf_Testjob_0.d6cc5cbb-aa55-4058-96aa-be0a2842e90c"
-"V7.19.10.B14a"-"Nudsf_Testjob_0"-"Nudsf_Testjob_0",SYS_VERSION="",SYS_RESULT="0";
zte:>enter appmode:
appmodename=CUDR-NF_10-40-66-233.Ncudr_SystemManagement
_0.d6cc5cbb-aa55-4058-96aa-be0a2842e93b;
zte:>RESET CDB;
This operation will restart all CDN nodes and the user data will be lost. 
Are you sure you want to continue?[Y/N]:y
ACK RESET CDB:
OUTP="successful",SYS_VERSION="0",SYS_RESULT="0",SYS_CMDCODE="1190616",
SYS_SESSIONID="10010",SYS_SEQUENCEID="1048582",SYS_USERID="254",
SYS_USERNAME="admin",SYS_NETYPE="1",SYS_TERMTYPE="2",SYS_ISTRANS="0",SYS_PATH="/",
SYS_ISDISP="0",SYS_DISPMODE="0",SYS_LASTPACK="1",SYS_WRITELOG="1",SYS_IP="",
SYS_APPMODE="CUDR-NF_10-40-66-233.Ncudr_SystemManagement
_0.d6cc5cbb-aa55-4058-96aa-be0a2842e93b",
SYS_ACCTYPE="0",SYS_TID="15720737785511048582",
SYS_TOKEN="oam_6057b1c0-e2bb-4ecb-a17d-47999bc76185";
zte:>
 
V7.21.20.B2及以后版本登录EM客户端，执行命令RESET CDB 。 
检查域状态。 
在Ncudr_SystemManagement_0服务，执行[SHOW CDBNODE](../../Ncudr_SystemManagement\zh-cn\mml\1190602.html)命令，检查所有左右域的运行状态都是NORMAL，且个数一致，EM上没有CDN相关告警。
执行NRF重新注册。 
### 缩略语 
### 缩略语 
#### AMF 
Access and Mobility Management Function接入和移动管理功能
#### APN 
Access Point Network接入点网络
#### BSF 
Binding Support Function绑定支持功能
#### CCA 
Credit Control Answer信用控制应答
#### CCR 
Credit Control Request信用控制请求
#### DNN 
Data Network Name数据网名称
#### DRA 
Diameter Routing AgentDiameter路由代理
#### GPSI 
Generic Public Subscription Identifier一般公共用户标识
#### HTTP 
Hypertext Transfer Protocol超文本传输协议
#### IPv4 
Internet Protocol Version 4互联网通信协议第四版
#### IPv6 
Internet Protocol Version 6互联网通信协议第六版
#### NF 
Network Function网络功能
#### NRF 
NF Repository Function网络仓储功能
#### PCEF 
Policy and Charging Enforcement Function计费和策略控制实施功能
#### PDU 
Packet Data Unit分组数据单元
#### PEI 
Permanent Equipment Identifier永久设备标识
#### PGW 
PDN Gateway分组数据网网关
#### QoS 
Quality of Service服务质量
#### RCP 
Resource Control Platform资源控制平台
#### S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
#### SM 
Session Management会话管理
#### SMF 
Session Management Function会话管理功能
#### SPR 
Subscription Profile Repository用户签约数据库
#### SUPI 
Subscriber Permanent Identifier用户永久标识
#### UDR 
Unified Data Repository统一数据存储
#### UE 
User Equipment用户设备
#### URI 
Uniform Resource Identifier统一资源标识符
## 虚拟化特性 
### ZUF-59-58-002 VNF自动部署 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
服务预埋|PCF网元提供了Ncudr_Access、Npcf_LOG和Npcf_LogStoreUnit可选服务。这些服务在不同场景可能不部署、也可能部署其中的一种或多种。并且还存在某个服务原本不部署，后期由于需求变化又要求部署的情况。因此PCF启用了“服务预埋”功能，即预埋以上服务，默认不实例化。在需要该服务时再激活该服务，根据需要进行实例化部署。
##### 描述 
####### 特性定义 
VNF自动部署是指由运维人员发起，通过NFVO为VNF实例分配所需的NFVI资源、并实例化VNF网元的过程。
####### 背景知识 
传统的电信网络架构，很多业务应用都基于专有的硬件资源进行开发和部署。业务应用部署上线以后，如果业务需求发生变动，往往涉及硬件资源和网络结构的变更，重新修改相应网络设备（路由器、交换机、防火墙），重新采购、部署硬件资源是一件非常繁琐的事情，这就给信息提供者和网络通讯运营商对各种硬件资源和应用管理带来了极大的负担。 
由于应用软件与硬件资源的绑定，限制了应用部署和组网的灵活性。因此，网元的虚拟化成为越来越多运营商的需求，创建基于云的基础设施和平台，以提高其数字化能力，这将使其能够在竞争日益激烈的市场中更好地满足客户的需求。 
云化的网络和应用平台建立后，自动化部署也就有了可能，并且越来越成为必要。 
##### 应用场景 
运营商部署VIM云管理平台，在云管理平台上部署VNF。
##### 客户收益 
受益方|受益描述
---|---
运营商|可以根据运营商需求对用户容量和业务量进行定制化部署，节省硬件资源。可以提供自动化的软件安装和功能加载，快速完成部署，降低运维成本。可以针对不同虚拟化云平台自动部署各种VNF，实现高可用性。
终端用户|此特性对终端用户不可见。

##### 实现原理 

###### 系统架构 
本特性遵从ETSI NFV架构，架构图如下所示。
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元名称|描述
---|---
NFVO|提供网元自动部署界面，负责VNF资源编排。
VNFM|负责计算VNF需要的虚机资源，提供给NFVO编排，提供VNF版本包下载服务给VNF。
VIM|负责基础设施层虚拟资源管理，提供创建虚机及相关资源的接口。
VNF|从VNFM下载自身软件版本，并完成自身的安装和配置。
###### 业务流程 
######## 自动化部署流程 
[]images/%E9%83%A8%E7%BD%B2.png)操作员发起实例化请求到NFVO，其中携带实例化需要的VNF信息。
NFVO校验请求的合法性。 
NFVO向VNFM发起VNF实例化，携带VNFD信息、实例化信息、软件版本信息。
VNFM收到VNF实例化请求，校验请求的合法性，计算需要的虚机资源。 
VNFM向NFVO申请创建和分配虚机资源。 
NFVO处理相关的资源分配工作。 
NFVO向VIM申请创建资源。
VIM创建虚机，将虚机绑定到网络和存储。 
VIM返回VNF创建结果。 
NFVO返回VNFM申请到的创建资源结果。 
VNFM启动创建的资源。 
VIM启动虚机。 
VNF从VNFM下载软件包。 
虚机开始安装自身软件，并配置相关的数据。 
向VNFM返回VNF实例化完成。 
VNFM向NFVO返回VNF实例化完成。 
NFVO向用户反馈实例化完成。 
######## 服务激活流程 
ZXUN RCP提供了Ncudr_Access、Npcf_LOG和Npcf_LogStoreUnit可选服务，这些服务在不同的场景部署需求不同。
因此ZXUN RCP启用了“服务预埋”功能，即预埋Ncudr_Access、Npcf_LOG和Npcf_LogStoreUnit服务，默认不实例化，在需要时再激活预埋的服务。
预埋服务的激活流程如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new79873e72183c497dafebb0b4f2375a2e__f40d8897-0fb5-4d44-8e9b-d6526f8e1eed)所示。
图1  服务激活流程
[]images/%E6%9C%8D%E5%8A%A1%E9%A2%84%E5%9F%8B%E6%BF%80%E6%B4%BB.png)
操作员通过EM发起激活NFS请求。
EM将激活NFS请求发送到VNF。 
VNF收到激活服务请求，查询到无未使用的VM，则向VNFM发送VM弹扩请求。
VNFM向NFVO发送VM弹扩请求。 
NFVO收到VM弹扩请求，与VIM交互完成VM弹扩。 
VNF向VNFM查询VM弹扩完成情况。 
VNFM向NFVO查询VM弹扩完成情况。 
NFVO向VNFM返回VM弹扩完成情况。 
VNFM向VNF返回VM弹扩完成情况。 
VNF查询发现VM弹扩完成，则开始部署相应服务的SC。
VNF完成SC部署后，向EM发送NFS激活响应消息。 
VNF向VNFM上报SC副本数量更新。 
VNFM向NFVO上报SC副本数量更新，流程结束。 
 说明： 
Ncudr_Access服务由私有插件控制，其实例化过程略有不同，在激活前需要使用[ADD NFS](../../CommonS_TMSP\zh-cn\mml\1242303.html)命令将服务加入管理范围。
######## 服务去激活流程 
服务去激活（删除）是服务预埋反向过程。当不需要某个服务时，可删除该服务以节省资源。 
服务去激活流程如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new79873e72183c497dafebb0b4f2375a2e__29a80fdf-3a98-4c92-a254-5c77e2fb2cb3)所示。
图2  服务去激活流程
[]images/%E6%9C%8D%E5%8A%A1%E9%A2%84%E5%9F%8B%E5%8E%BB%E6%BF%80%E6%B4%BB.png)
操作员通过EM发起去激活NFS请求。 
EM将去激活NFS请求发送到VNF。 
VNF删除对应的虚机。 
VNF向VNFM上报SC副本数量更新。 
VNMF向NFVO上报SC副本数量更新。 
VNF删除相应SC后，向EM发送NFS去激活响应消息。 
操作员通过EM发起回收虚机请求。 
EM将回收虚机请求发送到VNF。 
VNF收到回收虚机请求，向VNFM发送VM弹缩请求。 
VNFM向NFVO发送VM弹缩请求。 
NFVO收到VM弹缩请求，与VIM交互完成VM弹缩。 
VNF向VNFM查询VM弹缩完成情况。 
VNFM向NFVO查询VM弹缩完成情况。 
NFVO向VNFM返回VM弹缩完成情况。 
VNFM向VNF返回VM弹缩完成情况。 
VNF发送弹缩响应，流程结束。 
###### 本网元实现 
自动部署依赖CloudStudio（包括NFVO和VNFM）完成，NFVO根据PCF版本包提供的信息（包括：整局用户容量、流量、网络信息等），与VNFM交互协同，完成自动部署。
##### 系统影响 
该特性不涉及对系统业务的影响。 
##### 应用限制 
该特性运行在支持ETSI NFV规范的虚拟化软硬件平台上。
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准编号
---|---
ETSI GS NFV|ETSI GS NFV 001 V1.1.1(2013-10)ETSI GS NFV 002 V1.1.1(2013-10)ETSI GS NFV 003 V1.1.1(2013-10)ETSI GS NFV 004 V1.1.1(2013-10)ETSI GS NFV-PER 001 V1.1.1(2014-06)
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
02|V7.21.30|支持服务激活和去激活功能
01|V7.19.10|首次发布版本
####### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
####### 对其他网元的要求 
部署过程中ZXUN RCP作为VNF，需要NFVO和VNFM配合，在VIM平台上部署。
##### O&M相关 
####### 命令 
命令名称|描述
---|---
SHOW NF|查看TMSP上部署的所有NF信息，信息内容包括NF实例名称、标识、NS信息、部署状态等。
SHOW NFS|查看TMSP中的所有NFS实例。
SHOW VM|查看TMSP平台运行的虚机信息。
SHOW VMDETAIL|查看指定TMSP上部署的虚机详细信息。
SHOW VMTYPE|查看VNF的虚机类型信息，信息内容包括虚机规格及其部署数量。
SHOW VRU|查看TMSP中部署的所有VRU信息。信息内容包括容器名称、运行状态、所在的虚机、归属的NFS等信息。
SHOW VERSION|查看运行的VNF版本信息。
SHOW VERSION DETAIL|查看NF、NFS运行的版本信息。
SHOW PKG|查看加载的所有版本包。
ACTIVATE NFS|激活指定的服务实例。
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警与通知 
该特性不涉及告警/通知消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置自动部署特性 
ZXUN RCP自动部署过程参见“VNF部署
”。
##### 配置服务激活特性 
服务激活过程参见“激活预埋服务（可选）
”。
##### 配置服务去激活特性 
服务去激活过程参见“去激活服务（可选）
”。
##### 测试用例 
测试项目|MANO上自动部署VNF
---|---
测试目的|验证MANO上自动部署VNF功能。
预置条件|已进行网络数据规划。已在TECS OpenStack云平台上创建虚拟资源，如项目、网络平面等。
测试过程|登录NFVO客户端。上传版本包（包括基础版本包、镜像版本包、业务软件包），并注册镜像版本包。快速创建VNF部署包。注册VNF部署包。实例化VNF。
通过准则|VNF实例化成功执行，VNF实例的状态显示为active。
测试目的|验证服务预埋功能
---|---
预置条件|实例化的版本支持服务预埋功能。资源充足，网元运行正常。
测试过程|登录NFVO客户端。在NFVO客户端里打开对应网元的自动扩容开关和自动缩容开关。登录EM客户端。添加预埋的服务NFS（此步骤只针对CGW服务，LOG和LSU直接跳过该步骤，执行步骤5）。激活预埋服务。检查各虚机和容器的状态，确保服务激活成功。登录NFVO客户端，关闭该网元的自动扩容开关和自动缩容开关。
通过准则|服务被成功激活。激活服务相关的虚机、容器状态正常。激活服务相关的SC工作正常，实例数准确。
### 缩略语 
### 缩略语 
#### CDU 
Cloud Database Unit云数据库单元
#### CGW 
CDB GatewayCDB接入网关
#### EM 
Element Management网元管理
#### ETSI 
European Telecommunications Standards Institute欧洲电信标准化协会
#### LSU 
Log Storage Unit日志存储单元
#### MANO 
Management and Orchestration管理和编排
#### NF 
Network Function网络功能
#### NFS 
Network Function Service网络功能服务
#### NFV 
Network Functions Virtualization网络功能虚拟化
#### NFVI 
Network Functions Virtualization Infrastructure网络功能虚拟化基础设施
#### NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
#### NS 
Network Service网络服务
#### PCF 
Policy Control Function策略控制功能
#### SC 
Service Component服务组件
#### TECS 
Tulip Elastic Cloud System郁金香弹性云系统
#### TMSP 
Telecom Microservices Platform电信级微服务平台
#### UDSF 
Unstructured Data Storage Function非结构化数据存储功能
#### VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
#### VM 
Virtual Machine虚拟机
#### VNF 
Virtualized Network Function虚拟化网络功能
#### VNFD 
Virtualized Network Function Descriptor虚拟化网络功能描述符
#### VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
#### VRU 
Virtual Running Unit虚拟运行单元
### ZUF-59-58-004 VNF自动弹性 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
弹性|通过弹扩（增加资源）或弹缩（减少资源）来协调系统的资源占用与系统性能间的平衡，弹性功能包括弹扩和弹缩。弹扩（Scale Out）：即申请占用虚拟资源，并创建相应的调度单元。弹缩（Scale In）：即删除调度单元，并释放所占用的虚拟资源。
SC|Service Component，服务组件。一个虚拟化网元NF包含多个服务NFS，每个NFS可由多个服务组件SC实现。服务组件是一种可独立开发、测试、部署的单元。
##### 描述 
####### 特性定义 
自动弹性是指VNF将当前的VM或SC负载情况和与EM上或MANO中配置的弹缩/弹扩的门限值进行比较，当负载超过弹扩的门限值时，开始进行VM或SC的弹扩处理；当负载小于弹缩的门限值时，开始进行VM或SC的弹缩处理。
对于VM弹性，ZXUN RCP只支持手工弹性的方式，不支持自动弹性的方式。所以对于自动弹性，仅表示SC自动弹性，本特性后文描述为SC自动弹性。
####### 背景知识 
从弹性的对象分区，弹性功能分为VM弹性和SC弹性。 
VM弹性VM弹性是指运营商可以按实际需求申请或释放VM所占用的虚拟资源，可提高整个系统对虚拟资源的利用率。 
SC弹性SC弹性是指运营商可以按实际需求申请或释放SC所占用的虚拟资源，可提高整个系统对虚拟资源的利用率。 
根据实际的操作方式，弹性功能分为两种方式。 
自动弹性自动弹性是指VNF将当前的VM或SC负载情况和与EM上或MANO中配置的弹缩/弹扩的门限值进行比较，当负载超过弹扩的门限值时，开始进行VM或SC的弹扩处理；当负载小于弹缩的门限值时，开始进行VM或SC的弹缩处理。 
手工弹性手工弹性是指操作员通过在MANO或EM上手工配置数据来人为的调整VM个数。 
这两种方式的区别在于：自动弹性是系统通过采集实时的VM或SC的负荷数据与本地配置的弹缩/弹扩的门限值进行比较，根据结果来自动调整VM或SC的个数；手工弹性则是指操作员通过MANO或EM手工配置数据来人为的调整VM个数。 
##### 应用场景 
运营商希望系统运行时能智能分配资源。话务高峰期，如突发热点事件导致网络流量大增时，现有网络容量不能满足用户需求，VNF可以通过自动弹扩增强处理能力。话务低潮期，如凌晨业务负荷降低时，VNF可以通过自动弹缩将多余的资源收回。
##### 客户收益 
受益方|受益描述
---|---
运营商|实现虚拟资源根据实际业务负荷，动态的申请或释放资源，既体现了高资源利用率又符合节能减排的理念。
终端用户|此特性对终端用户不可见。

##### 实现原理 

###### 系统架构 
ZXUN RCP自动弹性特性基于ETSI NFV架构，如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newa007f24234fc4ea2bcee1bb147223764__c195ca29-ad20-4c41-b91e-c0456226389e)所示。
图1  系统架构图
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
该特性由NFVO、VNFM、VIM与ZXUN RCP协作完成，自动弹性特性中各网元作用参见下表。
网元|作用
---|---
NFVO|提供网元自动部署界面，负责VNF资源编排。
VNFM|负责计算VNF需要的虚机资源，提供给NFVO编排。
VIM|负责基础设施层虚拟资源管理，提供创建/删除虚机操作接口及相关查询资源接口。
ZXUN RCP|对应图1中的VNF，通过负荷检测触发Scale Out/In流程，完成用户数据的负载均衡。
###### 本网元实现 
ZXUN RCP会实时监控自身业务处理SC的资源使用情况。
当ZXUN RCP检测到SC负荷超出超过了设定的阈值时，会创建新的SC。若需要新的虚机来部署SC时，ZXUN RCP向MANO申请弹出新的虚机。由NFVO、VNFM、VIM三者交互，完成虚机的Scale Out流程。虚机弹扩后，ZXUN RCP会自动调整所有业务虚机的负载，最终所有业务虚机上的用户负载基本持平。 
当ZXUN RCP检测到SC的负荷情况低于设定的系统最低能力阈值时，ZXUN RCP选定需要弹缩的SC。将该SC上的用户数据均匀的迁移到其他SC上。若某虚机上的SC缩减为0，ZXUN RCP向MANO申请弹缩虚机，由NFVO、VNFM、VIM三者交互，完成虚机的Scale In流程。 
###### 业务流程 
######## SC自动Scale Out（有空闲VM） 
VNF内有空闲同规格虚机的场景下，SC弹扩的流程如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newf218b313c9654856aefb392fe6a9102d__9ead86de-bfef-4147-9fdf-5b12f67c1131)所示。
图2  SC自动Scale Out（有空闲VM）
[]images/1627876915996.png)
操作员通过EM进行SC弹性配置（包括弹性控制开关和触发的阈值），VNF获取此配置数据。 
VNF定时进行采样，统计系统运行数据。 
VNF将统计数据与在EM上配置的弹性数据进行比较。当系统负荷超过设置的弹扩阈值时，VNF查询当前是否有未使用的适合规格的VM。如果存在这样的VM，则在该虚机上部署新的SC实例，实现弹扩。 
VNF完成弹扩后，会向VNFM更新SC的副本数。VNFM更新成功，通知VNF修改SC信息。 
######## SC自动Scale Out（无空闲VM） 
VNF内没有空闲同规格虚机的场景下，SC弹扩的流程如[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newf218b313c9654856aefb392fe6a9102d__da42db3a-8105-4822-8812-3c5c355ffce7)所示。
图3  SC自动Scale Out（无空闲VM）
[]images/1627876976998.png)
操作员通过EM进行SC弹性配置（包括弹性控制开关和触发的阈值），VNF获取此配置数据。 
VNF定时进行采样，统计系统运行数据。 
VNF根据统计信息和在EM上配置的弹性数据进行比较，当高于设置的弹扩阈值，查询当前是否存在未使用的VM。如果当前不存在未使用VM，则不能先进行SC的弹扩。 
VNF向VNFM发送VM弹扩请求。 
VNFM向NFVO发送VM弹扩请求。 
NFVO收到VM弹扩请求，与VIM交互完成VM弹扩。 
VNF向VNFM查询VM弹扩完成进度。 
VNFM向NFVO查询VM弹扩完成进度。 
NFVO响应VNFM的查询请求，返回VM弹扩完成进度。 
VNFM响应VNF的查询请求，返回VM弹扩完成进度。 
VNF查询发现VM弹扩完成，则继续进行SC弹扩操作。 
VNF完成SC弹扩操作后，向VNFM更新SC副本数。VNFM更新成功，通知VNF修改SC信息。 
######## SC自动Scale In 
SC弹缩的流程如[图4](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newf218b313c9654856aefb392fe6a9102d__ed5c0ce9-fbb6-4ae6-8225-102a11797813)所示。
图4  SC自动Scale In
[]images/1627877014685.png)
操作员通过EM进行SC弹性配置（包括弹性控制开关和触发的阈值），VNF获取此配置。 
VNF定时进行采样，统计系统运行数据。 
VNF根据统计信息和弹性配置比较，如果低于设置的弹缩阈值，则开始迁移业务数据。 
VNF进行SC弹缩处理。 
VNF向VNFM更新SC副本数。VNFM更新成功，通知VNF修改SC信息。 
VNF完成SC弹缩处理后，如果查询发现对应VM上已无其他SC运行，则开始尝试VM回收操作，向VNFM发送VM弹缩请求。 
VNFM向NFVO发起VM弹缩请求。 
NFVO收到VM弹缩请求，与VIM交互完成VM弹缩。 
VNF向VNFM查询VM弹缩完成进度。 
VNFM向NFVO查询VM弹缩完成进度。 
NFVO响应VNFM的查询请求，返回VM弹缩完成进度。 
VNFM响应VNF的查询请求，返回VM弹缩完成进度。VM弹缩完成，流程结束。 
##### 系统影响 
该特性使业务SC的负荷保持在合理区间。既保持容量的合理冗余，又减少虚机资源占用。
##### 应用限制 
本功能执行时ZXUN RCP会改变对虚拟资源（vCPU、内存、存储、网络等）的占用情况。
虚机弹扩，增加虚拟资源占用。 
虚机弹缩，减少虚拟资源占用。 
##### 特性交互 
相关特性|交互关系
---|---
ZUF-59-58-002 VNF自动部署|只有通过ZUF-59-58-002 VNF自动部署对网元进行实例化成功，才能对VM进行弹扩和弹缩操作。
ZUF-59-58-043 VNF手工弹性|自动弹性功能只支持对SC进行自动弹性，手工弹性功能支持对VM和SC进行手动弹性。
##### 遵循标准 
标准类别|标准名称
---|---
ETSI GS NFV|ETSI GS NFV 001 V1.1.1(2013-10)ETSI GS NFV 002 V1.1.1(2013-10)ETSI GS NFV 003 V1.1.1(2013-10)ETSI GS NFV 004 V1.1.1(2013-10)ETSI GS NFV-PER 001 V1.1.1(2014-06)
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.19.10|首次发布。
####### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
####### 对其他网元的要求 
本网元作为VNF，需要NFVO和VNFM配合，在VIM平台上部署。
##### O&M相关 
####### 命令 
命令名称|描述
---|---
SET SCALEGLBBASECFG|弹性全局基本配置
SET SCALEPOLICYGLB|弹性全局策略配置
ADD SCALEBASECFGBYSC|按服务组件的弹性基本配置
ADD SCALEPOLICYBYSC|按服务组件的弹性策略配置
####### 性能统计 
测量类型|性能计数器
---|---
1|C555010003 VRU数目
####### 告警和通知 
编号|告警和通知
---|---
1|3490709504 SC弹缩开始
2|3490709505 SC弹缩结束
3|3490709506 SC自动scale out失败
4|3490709507 SC自动scale In失败
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置SC自动弹性 
###### 配置说明 
ZXUN RCP只支持SC自动弹性，不支持VM自动弹性。
自动弹性默认不开启，需要通过MML启动自动弹性。配置SC自动弹性策略，触发SC自动扩缩容。
###### 配置前提 
NF已经通过CloudStudio操作实例化成功。 
NF已经接入EM。 
###### 配置过程 
登录EM的Web客户端。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_TMSP_0。
执行[SET SCALEGLBBASECFG](../../CommonS_TMSP\zh-cn\mml\1241500.html)命令，设置弹性模式为自动。
执行[SET SCALEPOLICYGLB](../../CommonS_TMSP\zh-cn\mml\1241502.html)命令，配置SC自动弹性策略。
###### 配置实例 
######## 场景说明 
配置SC自动弹性策略。
当ZXUN RCP检测到SC负荷超过了设定的扩容门限值时，会创建新的SC。若当前无空闲虚机，则需要新的虚机来部署SC时，ZXUN RCP向MANO申请VM弹扩。 
当ZXUN RCP检测到SC负荷低于设定的缩容门限值时，会弹缩SC。若某虚机上的SC缩减为0，则ZXUN RCP向MANO申请VM弹缩。 
######## 数据规划 
参数|取值
---|---
弹性模式|自动
自动弹性类型|业务负载占用率
扩容门限（%）|10
缩容门限（%）|5
PCF GSU虚拟机初始个数|3
PCF GSU虚拟机最大个数|8
######## 配置步骤 
登录EM的Web客户端。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_TMSP_0。
配置支持自动弹性。 
[SET SCALEGLBBASECFG](../../CommonS_TMSP\zh-cn\mml\1241500.html):MODE="automatic"
[]images/%E9%85%8D%E7%BD%AE1.png)
配置SC自动弹性的策略。 
[SET SCALEPOLICYGLB](../../CommonS_TMSP\zh-cn\mml\1241502.html):POLICY_TYPE="CPU_RATIO",SCALEOUT_THRESHOLD=10,SCALEIN_THRESHOLD=5
[]images/%E9%85%8D%E7%BD%AE2.png)
##### 测试用例 
测试项目|PCF的自动弹性
---|---
测试目的|验证PCF的SC自动弹性功能
预置条件|PCF已经实例化完成，设置业务GSU虚机个数的初始值为3，最大值为8。PCF已经接入EM。在EM上配置PCF支持自动弹性。SET SCALEGLBBASECFG:MODE="automatic"在EM上配置SC自动弹性的策略。SET SCALEPOLICYGLB:POLICY_TYPE="CPU_RATIO",SCALEOUT_THRESHOLD=10,SCALEIN_THRESHOLD=5
测试过程|跑业务流程，加大话务，使业务GSU CPU占用满足扩容条件。30分钟后，停止话务。
通过准则|业务GSU的CPU占用率达到10%后，GSU VM扩容，从TECS OpenStack云平台上可以看到GSU VM增加。停止话务，GSU的CPU占用率降低到5%以下后，一个GSU VM被缩容，在TECS OpenStack云平台上可以看到GSU VM减少。
### 缩略语 
### 缩略语 
#### EM 
Element Management网元管理
#### ETSI 
European Telecommunications Standards Institute欧洲电信标准化协会
#### GSU 
General Service Unit通用业务单元
#### MANO 
Management and Orchestration管理和编排
#### MML 
Man Machine Language人机语言
#### NF 
Network Function网络功能
#### NFS 
Network Function Service网络功能服务
#### NFV 
Network Functions Virtualization网络功能虚拟化
#### NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
#### SC 
Service Component服务组件
#### VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
#### VM 
Virtual Machine虚拟机
#### VNF 
Virtualized Network Function虚拟化网络功能
#### VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
### ZUF-59-58-005 VNF虚机自愈 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
虚拟化|虚拟化是指计算机元件在虚拟的基础上而不是真实的基础上运行，是一个简化管理，优化资源的解决方案。
虚拟机|一种虚拟化的计算环境，与实体电脑/服务器功能行为非常相似。
网元|网络中的元素，即网络设备。在通信网络中，代表提供某个特定网络功能或服务的载体。本文主要指核心网网元。
容器|虚机环境下的应用运行单元。一个或多个关联的容器运行在一个虚机下，提供一个微服务。
##### 描述 
####### 特性定义 
在VNF虚机或其关键组件的运行过程中，由于硬件故障、VIM状态管理异常、虚机自身运行故障、人为误操作等原因，导致部分虚机有可能处于异常状态（包括被删除、挂起、休眠、错误等）。针对这种状态异常的虚机，云系统提供了VNF自动恢复的功能，称为虚机自愈。
####### 背景知识 
云计算和虚拟化背景，对系统的自我修复能力提出了更高的要求。虚机自愈就是这样一种自我修复的异常保护机制，自愈的目的是使本地虚机的状态和VIM上的虚机状态一致，且虚机上运行的容器状态正常，因此虚机自愈的过程中可能存在容器重建、虚机重建、虚机重启、虚机删除等操作。 
##### 应用场景 
运营商部署VIM云管理平台，在云平台上部署VNF。当VNF检测到VIM云平台上虚机的状态和本地的虚机状态不一致时，会先触发虚机状态不一致告警，之后触发虚机自愈。
##### 客户收益 
受益方|受益描述
---|---
运营商|及时检测状态异常的虚机资源，并自动将其恢复，由此维护系统的高可用性和健壮性。
终端用户|此特性对终端用户不可见。

##### 实现原理 

###### 系统架构 
虚机自愈特性基于ETSI NFV架构，如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new08e3d3ea8f7c4147abeb0274101d2126__e6c8f17c-f432-4deb-b0d1-8653b5292e57)所示。
图1  系统架构
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
该特性由MANO、VIM与ZXUN RCP协作完成。
网元|作用
---|---
ZXUN RCP|对应图1中的VNF，负责定时发消息给MANO，查询VIM云平台上的虚机状态，并结合本地状态来决定是否触发告警和虚机自愈。
MANO|提供接口给虚机进行状态查询，以及完成后续的虚机自愈操作。
VIM|负责基础设施层虚拟资源管理，提供创建/删除虚机操作接口及相关查询资源接口。
###### 本网元实现 
系统周期检查虚机状态和容器状态，触发自愈流程。当系统检测到本地容器、虚机状态和VIM云平台上的容器、虚机状态不一致时，会先触发状态不一致通知，之后触发自愈过程。整个过程保证系统的正常运行，且不影响其他虚机正常工作。
系统定期更新虚机、容器的运行状态。 
系统根据自愈全局配置中的检查周期，定期检查虚机和容器的运行状态。 
如果虚机、容器的运行状态和VIM云平台上的虚机、容器部署状态不一致，且自愈功能为开启，则自动进行修复，保证二者状态一致。对于需要自愈的容器和虚机，还需要根据具体的自愈策略进行自愈。 
根据配置的自愈策略依次执行容器和虚机自愈手段，直到容器状态恢复正常。 
自愈功能默认是开启的，操作员可以自行关闭此功能，在某些操作中（如版本升级）需要关闭此功能，在操作完成后再开启。 
###### 业务流程 
VNF内置状态监控功能。当发现某个虚机或容器状态异常时，根据自愈策略发起自愈过程。 
如果自愈策略设置为SC重启，则直接重启虚机内所有SC。 
如果自愈策略设置为虚机重启或虚机重建，则发起虚机重启或重建流程。相关流程如图2和图3所示。 
图2  虚机重启流程
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B1.png)
VNF向VNFM发起虚机重启请求。
VNFM向NFVO转发虚机重启请求。
NFVO向VIM转发虚机重启请求。 
VIM重启虚机并向NFVO返回重启完成响应，虚机上电并部署容器。 
NFVO向VNFM转发重启完成响应。 
VNFM向VNF转发重启完成响应，VNF检测虚机上容器运行正常。 
图3  虚机重建流程
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B2.png)
VNF向VNFM发起虚机重建请求。 
VNFM向NFVO转发虚机重建请求。 
NFVO向VIM转发虚机重建请求。 
VIM删除虚机并重建，重建完成后向NFVO返回重建完成响应，虚机上电并部署容器。 
NFVO向VNFM转发重建完成响应。 
VNFM向VNF转发重建完成响应，VNF检测虚机上容器运行正常。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性必须运行在支持ETSI NFV规范的虚拟化软硬件平台上。
##### 特性交互 
相关特性|交互关系
---|---
ZUF-59-58-002 VNF自动部署|需要通过自动部署特性对网元进行实例化成功，虚机才能进行自愈操作。
##### 遵循标准 
标准类别|标准名称
---|---
ETSI GS NFV|ETSI GS NFV 001 V1.1.1(2013-10)ETSI GS NFV 002 V1.1.1(2013-10)ETSI GS NFV 003 V1.1.1(2013-10)ETSI GS NFV 004 V1.1.1(2013-10)ETSI GS NFV-PER 001 V1.1.1(2014-06)
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.19.10|首次发布。
####### License要求 
该特性为ZXUN RCP的基本特性，无需License支持。
####### 对其他网元的要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
命令名称|配置项
---|---
SET AUTOHEALINGGLB|自愈全局配置
SET AUTOHEALINGLV|自愈组别配置
ADD VMAUTOHEALING|指定VM类型的配置
ADD VMAUTOHEALINGLV|指定VM类型的自愈级别配置
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警和通知 
编号|告警名称
---|---
1|3490709515 模块自愈
2|3490709513 虚机状态不一致
3|3490709514 模块状态不一致
4|3490709534 虚机迁移
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置特性 


 

###### 配置说明 
自愈功能可通过EM系统配置不同的自愈策略，例如可以分别配置容器重建、虚机重启、虚机重建策略来实现自愈，还可以按照不同的虚机类型来配置对应的自愈策略。
###### 配置前提 
实例化已经完成，NF已经接入EM系统。
###### 配置过程 
登录EM的Web客户端。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_TMSP_0。
执行[SET AUTOHEALINGGLB](../../CommonS_TMSP\zh-cn\mml\1240000.html)命令，修改自愈全局配置。
执行[SET AUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240002.html)命令，修改自愈级别配置。
（可选）使用[ADD VMAUTOHEALING](../../CommonS_TMSP\zh-cn\mml\1240004.html)命令，指定VM类型的自愈配置。
（可选）使用[ADD VMAUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240008.html)命令，指定VM类型的自愈级别配置。
###### 配置实例 
######## 配置场景 
启用自愈全局配置，并设置自愈策略相关信息。 
######## 数据规划 
参数|示例
---|---
自愈功能总开关|启用
自愈级别|虚机重建
自愈超时|600 s
重试次数|2
虚机类型|IPU
指定VM类型的自愈功能开关|开启
自愈等待时间|30 s
自愈失败策略|无操作
自愈级别|虚机重建
自愈超时|600 s
重试次数|2
######## 配置步骤 
登录EM的Web客户端。
在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_TMSP_0。
执行[SET AUTOHEALINGGLB](../../CommonS_TMSP\zh-cn\mml\1240000.html)命令，修改自愈全局配置，设置自愈功能总开关为启用。
[SET AUTOHEALINGGLB](../../CommonS_TMSP\zh-cn\mml\1240000.html):HEALINGSWITCH="ENABLE"
[]images/%E9%85%8D%E7%BD%AE1.png)
执行[SET AUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240002.html)命令，设置自愈级别。
自愈级别虚机重建，使能开关启用，重试次数为2。
[SET AUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240002.html):LEVEL="VMREBUILD",HEALINGSWITCH="ENABLE",TIMEOUT=600,RETRYCOUNT=2
[]images/%E9%85%8D%E7%BD%AE2.png)
（可选）执行[ADD VMAUTOHEALING](../../CommonS_TMSP\zh-cn\mml\1240004.html)命令，增加VM自愈使能配置。
启用IPU的自愈，自愈等待时间为30s，自愈失败策略为无操作。
[ADD VMAUTOHEALING](../../CommonS_TMSP\zh-cn\mml\1240004.html):VMTYPE="IPU",HEALINGSWITCH="ENABLE",WAITTIME=30,FAILPOLICY="NOACTION"
[]images/%E9%85%8D%E7%BD%AE3.png)
（可选）使用[ADD VMAUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240008.html)命令，指定VM类型的自愈级别配置；
启用IPU虚机重建级别的自愈，自愈超时时长为600s、重试次数为2。
[ADD VMAUTOHEALINGLV](../../CommonS_TMSP\zh-cn\mml\1240008.html):VMTYPE="IPU",LEVEL="VMREBUILD",HEALINGSWITCH="ENABLE",TIMEOUT=600,RETRYCOUNT=2
[]images/%E9%85%8D%E7%BD%AE4.png)
##### 测试用例 
测试项目|验证虚机自愈功能
---|---
测试目的|验证ZXUN RCP的虚机自愈功能
预置条件|ZXUN RCP实例化完成。
测试过程|登录EM的Web客户端。在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_HTTP_LB_0。执行SET AUTOHEALINGGLB:HEALINGSWITCH="ENABLE"命令，设置自愈功能总开关为“启用”。执行SET AUTOHEALINGLV:LEVEL="VMREBUILD",HEALINGSWITCH="ENABLE"命令，修改自愈级别“虚机重建”，使能开关为“启用”。在TECS OpenStack平台删除一个GSU虚机。
通过准则|在设定的自愈时间到达后，被删除的GSU虚机自动创建成功。执行SHOW VM命令，查看自愈的GSU虚机状态正常。执行SHOW VRU命令，查看自愈的GSU虚机容器状态正常。
### 缩略语 
### 缩略语 
#### EM 
Element Management网元管理
#### ETSI 
European Telecommunications Standards Institute欧洲电信标准化协会
#### MANO 
Management and Orchestration管理和编排
#### NF 
Network Function网络功能
#### NFV 
Network Functions Virtualization网络功能虚拟化
#### NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
#### SC 
Service Component服务组件
#### VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
#### VM 
Virtual Machine虚拟机
#### VNF 
Virtualized Network Function虚拟化网络功能
#### VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
### ZUF-59-58-043 VNF手工弹性 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
弹性|通过弹扩（增加资源）或弹缩（减少资源）来协调系统的资源占用与系统性能间的平衡，弹性功能包括弹扩和弹缩。弹扩（Scale Out）：即申请占用虚拟资源。弹缩（Scale In）：即释放所占用的虚拟资源。
SC|Service Component，服务组件。一个虚拟化网元NF包含多个服务NFS，每个NFS可由多个服务组件SC实现。服务组件是一种可独立开发、测试、部署的单元。
##### 描述 
####### 特性定义 
手工弹性是指操作员通过在MANO或EM上手工配置数据来人为的调整VM个数或SC个数。
####### 背景知识 
从弹性的对象区分，弹性功能分为VM弹性和SC弹性。VM弹性VM弹性是指运营商可以按实际需求申请或释放VM所占用的虚拟资源，可提高整个系统对虚拟资源的利用率。SC弹性SC弹性是指运营商可以按实际需求申请或释放SC所占用的虚拟资源，可提高整个系统对虚拟资源的利用率。 
根据实际的操作方式，弹性功能分为两种方式。自动弹性自动弹性是指将当前的VM或SC负载情况与MANO或EM中配置的弹缩/弹扩的门限值进行比较，当负载超过弹扩的门限值时，开始进行VM或SC的弹扩处理；当负载小于弹缩的门限值时，开始进行VM或SC的弹缩处理。手工弹性手工弹性是指操作员通过在MANO或EM上手工配置数据来人为的调整VM个数。手工弹性包括VM手工弹性和SC手工弹性。自动弹性与手工弹性两种方式的区别在于：自动弹性是系统通过采集实际的VM或SC的负荷数据与本地配置的弹缩/弹扩的门限值进行比较，根据结果来自动调整VM或SC的个数；手工弹性是指操作员通过MANO或EM手工配置数据来人为的调整VM个数或SC个数。 
##### 应用场景 
在某些特定时期，如节假日，会发生用户集中接入和流量爆发现象。维护人员可利用此功能提前手动增加VM和SC的个数，以便适应大量用户的接入。
##### 客户收益 
受益方|受益描述
---|---
运营商|可以实现虚拟资源按需申请或释放，既提高了资源利用率又符合节能减排的理念。
终端用户|此特性对移动终端用户不可见。

##### 实现原理 

###### 系统架构 
ZXUN RCP手工弹性特性基于ETSI NFV架构，如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new5bf12e04bfda49f0a6e8dafb13ed8871__98676050-149d-4926-85f0-90c2cf71a85f)所示。
图1  ETSI NFV架构图
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
该特性由NFVO、VNFM、VIM与ZXUN RCP协作完成。
网元|作用
---|---
NFVO|提供网元自动部署界面，负责VNF资源编排。
VNFM|负责计算VNF需要的虚机资源，提供给NFVO编排。
VIM|负责基础设施层虚拟资源管理，提供创建/删除虚机操作接口及相关查询资源接口。
ZXUN RCP|对应图1中的VNF，响应操作员从EM或MANO上执行的操作，发起Scale Out/In流程，完成用户数据的负载均衡。
###### 本网元实现 
操作员登录NFVO配置界面，进行手工弹性配置。指定某类VM或SC进行手工弹性伸缩。
手工弹性伸缩允许VNF对其特定类型的VM或SC在一定的范围内进行弹扩（Scale Out）或弹缩（Scale In），VM弹扩和弹缩如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#newf40f2397e39d482ab13118dc9a6251a2__7633d737-0c44-4e33-b864-2aa4f3268cdb)所示。
图2  Scale Out/In
[]images/%E6%9C%AC%E7%BD%91%E5%85%83%E5%AE%9E%E7%8E%B0.png)
Scale Out：当网元的负荷较重时，可执行弹扩操作，以增加虚机的数量。 
Scale In：当网元的负荷较轻时，可执行弹缩操作，以减少虚机的数量，释放资源。 
VNF中允许手工弹性伸缩的模块类型和虚机数量由该VNF所使用的模板决定。VNF下的所有的虚机资源不能超过模板中设定的最大资源。 
###### 业务流程 
ZXUN RCP支持在MANO或EM上手工配置数据来人为的调整VM个数或SC个数。
支持MANO发起VM手工弹扩和弹缩。 
支持MANO发起SC手工弹扩和弹缩，从而触发VM弹扩和弹缩。 
支持EM发起SC手工弹扩和弹缩，从而触发VM弹扩和弹缩。 
######## MANO发起的VM手工Scale Out流程 
图3  MANO发起的VM手工Scale Out流程
[]images/1627876629752.png)
操作员通过MANO对虚机进行手工弹扩（Scale Out）的操作。
NFVO将弹扩请求消息发送给VNFM。
VNFM将此请求消息发送到VNF，操作类型为pre_scale手工弹扩请求。
VNF判断消息为VM手工弹扩，则保存相关信息，并选择满足条件的虚机，向VNFM返回pre_scale_rsp消息，携带满足条件的虚机列表。
VNFM收到pre_scale_rsp消息，将pre_scale_rsp消息转送给NVFO。 
NVFO和VIM进行交互，对VM进行Scale Out。 
NVFO将Scale Out的结果通过post_scale请求通知给VNFM。 
VNFM将Scale Out结果通过post_scale消息转发给VNF。 
VNF收到post_scale请求，记录弹出的VM信息，并给VNFM返回post_scale_rsp消息。 
VNFM将post_scale_rsp响应消息转发给NVFO。 
######## MANO发起的VM手工Scale In流程 
图4  MANO发起的VM手工Scale In流程
[]images/1627876658670.png)
1. 操作员通过MANO对虚机进行手工弹缩（Scale In）的操作。 
2. NFVO将手工弹缩请求消息发送给VNFM。 
3. VNFM将此请求消息发送到VNF，操作类型为pre_scale请求。 
4. VNF获得此VM手工弹缩请求，则保存相关信息，并选择满足条件的虚机。 
5-14. NFVO和VNFM不断交互信息，进行预弹缩处理，决策出需要弹缩的虚机，迁移要弹缩的虚机上的用户数据到其他虚机。 
15. 当预弹缩的进度为100%时，NFVO和VIM进行交互，对VM进行Scale In。 
16. NFVO将Scale In的结果通过post_scale通知给VNFM。 
17. VNFM将Scale In的结果通过post_scale通知给VNF。 
18. VNF收到post_scale请求，给VNFM回送post_scale_rsp消息。 
19. VNFM将post_scale_rsp消息转发给NVFO。 
######## MANO发起的SC手工Scale Out（有空闲VM） 
图5  MANO发起的SC手工Scale Out（有空闲VM）
[]images/1627876681050.png)
操作员通过MANO发起SC弹扩请求。 
NFVO将此请求发送到VNFM。 
VNFM将此请求发送到VNF。 
VNF收到SC弹扩请求，查询到有未使用VM，则在未使用VM上进行SC弹扩操作。 
VNF完成SC弹扩操作后，向VNFM发送SC弹扩响应消息。 
VNFM将SC弹扩响应消息发送到NFVO，流程结束。 
######## MANO发起的SC手工Scale Out（无空闲VM） 
图6  MANO发起的SC手工Scale Out（无空闲VM）
[]images/1627876709993.png)
操作员通过MANO发起SC弹扩请求。 
NFVO将此请求发送到VNFM。 
VNFM将此请求发送到VNF。 
VNF收到SC弹扩请求，查询到无未使用VM，则向VNFM发送VM弹扩请求。 
VNFM向NFVO发送VM弹扩展请求。 
NFVO收到VM弹扩请求，与VIM交互完成VM弹扩。 
VNF向VNFM查询VM弹扩完成情况。 
VNFM向NFVO查询VM弹扩完成情况。 
NFVO向VNFM返回VM弹扩完成情况。 
VNFM向VNF返回VM弹扩完成情况。 
VNF查询发现VM弹扩完成，则继续进行SC弹扩操作。 
VNF完成SC弹扩操作后，向VNFM发送SC弹扩响应消息。 
VNFM向NFVO发送SC弹扩响应消息，NFVO收到SC弹扩响应消息，流程结束。 
######## MANO发起的SC手工Scale In 
图7  MANO发起的SC手工Scale In
[]images/1627876735220.png)
操作员通过MANO发起SC弹缩请求。 
NFVO将此请求发送到VNFM。 
VNFM将此请求发送到VNF。 
VNF收到SC弹缩请求，进行SC弹缩处理，包括业务迁移及SC下电。 
VNF完成SC弹缩处理后，如果查询发现对应VM上已无其他SC运行，则开始尝试VM回收操作，向VNFM发送VM弹缩请求。否则，转第12步。 
VNFM向NFVO发送VM弹缩请求。 
NFVO收到VM弹缩请求，与VIM交互完成VM弹缩。 
VNF向VNFM查询VM弹缩完成情况。 
VNFM向NFVO查询VM弹缩完成情况。 
NFVO向VNFM返回VM弹缩完成情况。 
VNFM向VNF返回VM弹缩完成情况。 
VNF向VNFM发送SC弹缩响应消息。 
VNFM向NFVO发送SC弹缩响应消息，NFVO收到SC弹缩响应消息，流程结束。 
######## EM发起的SC手工Scale Out（有空闲VM） 
图8  EM发起的SC手工Scale Out（有空闲VM）
[]images/1627876761111.png)
操作员通过EM发起SC弹扩请求。 
EM将此请求发送到VNF。 
VNF收到SC弹扩请求，查询到有未使用VM，则在未使用VM上进行SC弹扩操作。 
VNF完成SC弹扩操作后，向EM发送SC弹扩响应消息。 
VNF向VNFM上报SC副本数量更新。 
VNFM向NFVO上报SC副本数量更新，流程结束。 
######## EM发起的SC手工Scale Out（无空闲VM） 
图9  EM发起的SC手工Scale Out（无空闲VM）
[]images/1627876790907.png)
操作员通过EM发起SC弹扩请求。 
EM将此请求发送到VNF。 
VNF收到SC弹扩请求，查询到无未使用VM，则向VNFM发送VM弹扩请求。 
VNFM向NFVO发送VM弹扩请求。 
NFVO收到VM弹扩请求，与VIM交互完成VM弹扩。 
VNF向VNFM查询VM弹扩完成情况。 
VNFM向NFVO查询VM弹扩完成情况。 
NFVO向VNFM返回VM弹扩完成情况。 
VNFM向NFVO返回VM弹扩完成情况。 
VNF查询发现VM弹扩完成，则继续进行SC弹扩操作。 
VNF完成SC弹扩操作后，向EM发送SC弹扩响应消息。 
VNF向VNFM上报SC副本数量更新。 
VNMF向NFVO上报SC副本数量更新，流程结束。 
######## EM发起的SC手工Scale In 
图10  EM发起的SC手工Scale In
[]images/1627876817886.png)
操作员通过EM发起SC弹缩请求。 
EM将此请求发送到VNF。 
VNF收到SC弹缩请求，进行SC弹缩处理，包括业务迁移等。 
VNF完成SC弹缩处理后，如果查询发现对应VM上已无其他SC运行，则开始尝试VM回收操作，向VNFM发送VM弹缩请求。否则转第11步。 
VNFM向NFVO发送VM弹缩请求。 
NFVO收到VM弹缩请求，与VIM交互完成VM弹缩。 
VNF向VNFM查询VM弹缩完成情况。 
VNFM向NFVO查询VM弹缩完成情况。 
NFVO向VNFM返回VM弹缩完成情况。 
VNFM向VNF返回VM弹缩完成情况。 
VNF向EM发送SC弹缩响应消息，EM收到SC弹缩响应消息，流程结束。 
##### 系统影响 
本功能执行时会改变对虚拟资源（vCPU、内存、存储、网络等）的占用情况。 
虚机弹扩（Scale Out），增加虚拟资源占用。 
虚机弹缩（Scale In），减少虚拟资源占用。 
##### 应用限制 
该特性必须运行在支持ETSI NFV规范的虚拟化软硬件平台上。
##### 特性交互 
相关特性|交互关系
---|---
ZUF-59-58-002 VNF自动部署|需要通过自动部署特性对网元进行实例化成功，才能对VM进行弹扩和弹缩操作。
ZUF-59-58-004  VNF自动弹性|自动弹性功能只支持对SC进行自动弹性，手工弹性功能支持对VM和SC进行手动弹性。
##### 遵循标准 
标准类别|标准名称
---|---
ETSI GS NFV|ETSI GS NFV 001 V1.1.1(2013-10)ETSI GS NFV 002 V1.1.1(2013-10)ETSI GS NFV 003 V1.1.1(2013-10)ETSI GS NFV 004 V1.1.1(2013-10)ETSI GS NFV-PER 001 V1.1.1(2014-06)
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.19.10|首次发布。
####### License要求 
该特性为的基本特性，无需License支持。 
####### 对其他网元的要求 
弹性操作过程中，本网元作为VNF，需要NFVO和VNFM配合，在VIM平台上实现弹性操作。
##### O&M相关 
####### 命令 
命令名称|描述
---|---
INC SC|增加当前NFS内的SC实例。
DEC SC|减少当前NFS内的SC实例。
####### 性能统计 
测量类型|性能计数器
---|---
1|C555010003 VRU数目
####### 告警和通知 
编号|告警和通知
---|---
1|3490709504 SC弹缩开始
2|3490709505 SC弹缩结束
3|3490709506 SC自动scale out失败
4|3490709507 SC自动scale In失败
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 

##### 配置EM发起SC弹扩 
###### 配置说明 
操作员通过EM客户端手工操作增加SC个数，从而触发VM弹扩。
###### 配置前提 
NF已经通过CloudStudio操作实例化成功。 
NF已经接入EM。 
###### 配置过程 
登录NFVO客户端，打开自动扩容开关。
登录EM客户端，在EM客户端配置页面的左侧命令树中，展开PCF节点，选择CommonS_TMSP_0。
执行[SET SCALEGLBBASECFG](../../CommonS_TMSP\zh-cn\mml\1241500.html):MODE="manual"命令，配置弹性模式是手动。
执行[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html)命令，配置SC弹扩。
###### 配置实例 
######## 场景说明 
在PCF实例化成功后，各个虚机都是最少个数，商用场景需要的虚机个数一般都比实例化时的个数多，操作员可根据商务合同，将各个虚机弹扩到要求的数量。
######## 数据规划 
每个虚机可运行不同的SC数量，根据HLD中虚机数量计算需要增加的SC数量，将每种SC类型的虚机扩容到HLD配置数量，满足商用容量要求。PCF涉及到弹性伸缩的虚机类型参见下表。
虚机类型|规格|SC类型名称|单虚机SC数量（最小弹性步长）|建议每次扩容最大SC个数
---|---|---|---|---
GSU（PolicyControl）|Common-C8M32|sc-pcf-pcm|7|35
GSU（HTTP_LB）|Common-C8|sc-http-lb|2|10
GSU（SIG）|Common-C8|sc-sig|6|30
sc-pcf-siglb|GSU（SIG）|Common-C8|1|5
IPU（非SDN组网）|C8|sc-ips|1|5
CDU|C-C4M32|sc-cudr-cdn-l-001|3|15
sc-cudr-cdn-r-001|CDU|C-C4M32|3|15
######## 配置步骤 
打开自动扩容开关
登录NFVO客户端，选择菜单编排→应用→VNF
，在界面右侧默认显示VNF页面，如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__b1f3e459-1092-4519-9718-ad6af6a7ca2f)所示。
图1  VNF页面
[]images/Snap089.png)
选择更多→自动扩缩容开关
，进入自动扩缩容开关设置页面，如[图2](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__e5d29fe2-52cc-4ba8-8b19-cdc0ca47fe1d)所示。
图2  自动扩缩容开关
[]images/Snap90.png)
查看网元的自动扩容开关状态是否为开，如[图3](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424919__59b6f745-8ee6-469c-9c70-e901dacb2175)所示。
图3  自动扩容开关状态
[]images/Snap91.png)
如果自动扩容开关状态为关，那么需将操作类型设置为扩容，开关设置为开启。设置完成后，单击提交按钮。
配置本地手工弹性
在EM客户端，切换到配置页面，在配置页面的左侧命令树中，展开需要进行手工弹性操作的PCF节点。
在PCF节点下选择CommonS_TMSP_0，在命令输入框中执行如下命令，修改弹性方式为本地手工弹性。
[SET SCALEGLBBASECFG](../../CommonS_TMSP\zh-cn\mml\1241500.html):MODE="manual",SOURCES="local"
GSU（PolicyControl）虚机扩容SC
在PCF节点下选择Npcf_SMPolicyControl_0，执行[SHOW SCTYPE](../../CommonS_TMSP\zh-cn\mml\1243505.html)命令，查询当前NFS内的SC类型名称和SC个数。
在命令输入框中执行如下命令： 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-pcf-pcm",SC_NUM=7
本示例中需要新增的GSU虚机个数为1。sc-pcf-pcm的弹扩最小步长为7，即增加7个SC就增加一个GSU，如果要弹扩2个GSU，需要进行弹性的SC数量需要设置为14，以此类推。
 说明： 
首次扩容SC_NUM步长固定设置为7，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过35。 
GSU（HTTP_LB）虚机扩容SC
在PCF节点下选择CommonS_HTTP_LB_0，执行[SHOW SCTYPE](../../CommonS_TMSP\zh-cn\mml\1243505.html)命令，查询当前NFS内的SC类型名称和SC个数。
在命令输入框中执行如下命令： 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-http-lb",SC_NUM=2
本示例中需要新增的GSU虚机个数为1。sc-http-lb的弹扩最小步长为2，即增加2个SC就增加一个GSU，如果要弹扩2个GSU，需要进行弹性的SC数量需要设置为4，以此类推。
 说明： 
首次扩容SC_NUM步长固定设置为2，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过10。 
GSU（SIG）虚机扩容SC
 说明： 
sc-sig和sc-pcf-siglb两种类型SC共用一个虚机，扩容1个虚机需扩容两类SC。
sc-sig类型SC：首次扩容SC_NUM步长固定设置为6，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过30。 
sc-pcf-siglb类型SC：首次扩容SC_NUM步长固定设置为1，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过5。 
在PCF节点下选择CommonS_SIG_0，执行[SHOW SCTYPE](../../CommonS_TMSP\zh-cn\mml\1243505.html)命令，查询当前NFS内的SC类型名称和SC个数。
在命令输入框中执行如下命令： 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-sig",SC_NUM=6
本示例中需要新增的GSU虚机个数为1。sc-sig的弹扩最小步长为6，即增加6个SC就增加一个GSU，如果要弹扩2个GSU，需要进行弹性的SC数量需要设置为12，以此类推。
在PCF节点下选择Npcf_SIGLB_0，执行[SHOW SCTYPE](../../CommonS_TMSP\zh-cn\mml\1243505.html)命令，查询当前NFS内的SC类型名称和SC个数。
在命令输入框中执行如下命令： 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-pcf-siglb",SC_NUM=1
本示例中需要新增的GSU虚机个数为1。sc-pcf-siglb的弹扩最小步长为1，即增加1个SC就增加一个GSU，如果要弹扩2个GSU，需要进行弹性的SC数量需要设置为2，以此类推。
IPU（非SDN组网）扩容SC
在PCF节点下选择CommonS_IPS_0，执行[SHOW SCTYPE](../../CommonS_TMSP\zh-cn\mml\1243505.html)命令，查询当前NFS内的SC类型名称和SC个数。
在命令输入框中执行如下命令： 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-ips",SC_NUM=1
本示例中需要新增的GSU虚机个数为1。sc-ips的弹扩最小步长为1，即增加1个SC就增加一个IPU，如果要弹扩2个IPU，需要进行弹性的SC数量需要设置为2，以此类推。
 说明： 
首次扩容SC_NUM步长固定设置为1，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过5。 
CDU虚机扩容SC
 说明： 
CDU虚机扩容SC时需要分别对sc-cudr-cdn-l-001和sc-cudr-cdn-r-001进行弹扩操作，才会创建新的CDU虚机。CDU虚机两种SC类型需要扩容的虚机数量分别为CDU需要扩容总虚机数的一半。例如现场需要扩容4个CDU，即扩容6个sc-cudr-cdn-l-001和6个sc-cudr-cdn-r-001。 
首次扩容SC_NUM步长固定设置为3，等单个虚机扩容成功后，后续扩容可以将SC_NUM步长设置为需要扩容的数量，SC_NUM最大不能超过15。 
例如现场需要扩容2个CDU，由于CDU虚机的最小弹性步长为3，则扩容3个sc-cudr-cdn-l-001和3个sc-cudr-cdn-r-001。 
在PCF节点下选择Nudsf_UnstructuredDataManagement_0，在命令输入框中执行如下命令，对sc-cudr-cdn-l-001进行弹扩操作。 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-cudr-cdn-l-001",SC_NUM=3
执行同样的操作，在命令输入框中执行如下命令，对sc-cudr-cdn-r-001进行弹扩操作。 
[INC SC](../../CommonS_TMSP\zh-cn\mml\1243507.html):SC_TYPE="sc-cudr-cdn-r-001",SC_NUM=3
##### 配置NFVO发起VM弹性 
###### 配置说明 
操作员通过NFVO客户端手工操作调整VM个数。
###### 配置前提 
NF已经通过CloudStudio操作实例化成功。
###### 配置过程 
登录NFVO的Web客户端。
选择菜单编排→VNF
。
选择需要扩容的网元，单击操作列的“扩缩容”按钮。
在弹出的扩缩容界面上，操作类型选择“扩容”，方式选择“按部署单元弹性”，在部署单元列表中选择需要扩容的虚机，增加虚机数，进行扩容。
在弹出的扩缩容界面上，操作类型选择“缩容”，方式选择“按部署单元弹性”，在部署单元列表中选择需要缩容的虚机，减少虚机数，进行缩容。
###### 配置实例 
######## 场景说明 
操作员通过NFVO客户端手工操作，弹扩CDU虚机和弹缩LOG虚机。
######## 数据规划 
虚机类型|弹性类型|弹性虚机个数
---|---|---
CDU|弹扩|2
LOG|弹缩|1
######## 配置步骤 
登录NFVO的Web客户端。 
选择菜单编排→VNF
。
选择需要扩容的网元，单击操作列的“扩缩容”按钮，如下图所示。
[]images/1628563385769.png)
在弹出的扩缩容界面上，操作类型选择“扩容”，方式选择“按部署单元弹性”，在部署单元列表中选择需要扩容的虚机，增加虚机数，进行扩容，如下图所示。
[]images/1628563471644.png)
在弹出的扩缩容界面上，操作类型选择“缩容”，方式选择“按部署单元弹性”，在部署单元列表中选择需要缩容的虚机，减少虚机数，进行缩容，如下图所示。
[]images/1628563492002.png)
##### 测试用例 
测试项目|在EM上配置SC弹扩
---|---
测试目的|验证手工弹扩PCF虚机的SC - 在EM客户端上操作
预置条件|已经通过CloudStudio操作实例化PCF成功。
测试过程|在NFVO客户端打开自动扩容开关。登录EM客户端，展开PCF节点，选择CommonS_TMSP_0。执行SET SCALEGLBBASECFG:MODE="manual"命令，配置弹性模式是手动。执行INC SC命令，分别弹扩GSU、IPU和CDU虚机的SC。
通过准则|各虚机手工弹扩成功，从TECS OpenStack云平台上可以看到GSU、IPU和CDU虚机增加。
测试项目|在NFVO上配置VM弹性
---|---
测试目的|验证手工弹性PCF虚机 - 在NFVO客户端上操作
预置条件|已经通过CloudStudio操作实例化PCF成功。
测试过程|登录NFVO客户端，选择菜单编排→VNF。单击待扩容PCF右侧的“扩缩容”按钮，选择“扩容”，方式选择“按部署单元弹性”。在部署单元列表内选择CDU虚机，弹扩VM个数为2，单击提交按钮执行操作。单击待缩容PCF右侧的“扩缩容”按钮，选择“缩容”，方式选择“按部署单元弹性”。在部署单元列表内选择LOG虚机，弹缩VM个数为1，单击提交按钮执行操作。
通过准则|手动扩容成功，CDU VM被成功弹扩。手动缩容成功，LOG VM被成功弹缩。
### 缩略语 
### 缩略语 
#### CDU 
Cloud Database Unit云数据库单元
#### EM 
Element Management网元管理
#### ETSI 
European Telecommunications Standards Institute欧洲电信标准化协会
#### GSU 
General Service Unit通用业务单元
#### HTTP 
Hypertext Transfer Protocol超文本传输协议
#### IPU 
Interface Process Unit接口处理单元
#### LB 
Load Balance负载均衡
#### MANO 
Management and Orchestration管理和编排
#### NF 
Network Function网络功能
#### NFS 
Network Function Service网络功能服务
#### NFV 
Network Functions Virtualization网络功能虚拟化
#### NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
#### PCF 
Policy Control Function策略控制功能
#### SC 
Service Component服务组件
#### SDN 
Software Defined Network软件定义网络
#### SIG 
Signal信令
#### VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
#### VM 
Virtual Machine虚拟机
#### VNF 
Virtualized Network Function虚拟化网络功能
#### VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
### ZUF-59-58-044 VNF虚机管理 
#### 特性描述 

#### 特性描述 

##### 术语 
术语|含义
---|---
虚机迁移|虚机从当前的宿主物理节点转移到另一个物理主机的过程。有冷迁移和热迁移两种方式。
冷迁移|将虚机下电后，在其他物理主机重生上电。
热迁移|又叫动态迁移、实时迁移，是将运行状态的虚拟机迁移到其他物理主机。
##### 描述 
####### 特性定义 
VNF虚机管理是指对实例化成功的VM进行管理，包括创建、查询、启动、停止、终止、删除、迁移等操作。
####### 背景知识 
云计算和虚拟化技术的发展，对运营商的运维提出了新的挑战，原来管理的固定、静止的物理设备，变成了虚拟的、可动态迁移的逻辑对象，从而对系统设备的运维提出了更高的要求。 
虚拟化ZXUN RCP支持手工操作虚机后，运营商可以对虚机实现更多个性化的操作，如创建、查询、启动、停止、终止、删除、迁移。这些操作在不影响业务的情况下，使得设备的运维更加高效便捷。
##### 应用场景 
VNF虚机管理一般应用于以下场景：
通过虚机迁移操作实现云平台软硬件设施的升级和维护。云平台自身升级和维护时，为降低对VNF的影响，一般采用各物理节点分批升级维护的方式。这样可以将当前维护的物理节点上的所有虚机迁移到其他物理节点。当前节点维护完成后，可以接受其他节点迁移出的虚机，从而进行下一批节点的硬件维护。 
通过虚机创建/删除/停止/启动/重启操作解决虚机异常。当虚机出现异常系统无法自愈或者未启用自愈功能时，可以手工创建/删除/停止/启动/重启尝试解决。 
##### 客户收益 
受益方|受益描述
---|---
运营商|当VNF发生节点系统性故障时，通过对故障节点的管理操作，使系统恢复正常，增加系统可用性，减少损失。
终端用户|享受更稳定的服务。

##### 实现原理 

###### 系统架构 
VNF虚机管理特性基于ETSI NFV架构，如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new97e9e2266a6d40918f4f0b20a0bb419c__a9b92532-4f93-48c2-bda1-baac2184837c)所示。
图1  ETSI NFV架构图
[]images/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
###### 涉及的网元 
网元名称|网元作用
---|---
NFVO|提供网元自动部署界面，负责VNF资源编排。
VNFM|负责计算VNF需要的虚机资源，提供给NFVO编排。提供VNF版本包下载服务给VNF。
VIM|负责基础设施层虚拟资源管理，提供创建、删除虚机操作接口及相关查询资源接口。
NFVI|提供VNF运行的物理资源和虚拟化运行环境。
ZXUN RCP|对应图1中的VNF。ZXUN RCP从VNFM下载自身软件版本，并完成自身的安装和配置。
###### 本网元实现 
本功能中，网元作为被管理对象，由操作员在MANO界面上发起对本网元虚机的管理。虚机管理的操作包括：
查询VNF虚机用户在MANO界面发起VNF的查询请求，可以选择查询一个VNF或多个VNF。主要查询VNF实例当前的所有虚机列表及状态等信息。 
迁移VNF虚机VNF虚机迁移操作是对VNF内虚机进行批量手动迁移处理。将VNF中的虚机从当前所在的物理主机迁移至其它的物理主机上。虚机迁移通常是对虚机资源分配进行优化，例如某物理主机上的资源占用较多，就可以将该主机上的虚机迁移一些到资源占用较少的物理主机上去。VNF虚机迁移分为虚机冷迁移和虚机热迁移两种方式。冷迁移与热迁移相比，在迁移过程中需要将被迁移的虚机关机。是否因此影响业务，取决于该虚机所对应业务层模块采用的备份方式。 说明：当目标主机的资源不够，会导致虚机热迁移失败，系统会自动进行回滚操作，该虚机仍可正常运行。VNF迁移操作支持优雅终止和强制终止。优雅终止方式：虚层在进行资源操作前会与VNF交互，由VNF进行校验和准备。如果检验成功，则会继续操作；如果校验失败，则操作不会继续进行。强制终止方式：直接终止现有虚机，在目的节点重新生成当前虚机。 
启动/停止VNF虚机对虚机进行启动或停止操作，是对该VNF下的虚机资源进行启动/停止。停止虚机后，该虚机的资源仍然被占用，可以随时再执行启动。 小心！停止虚机操作时，会停止该虚机上所提供的所有业务。 
删除虚机当不再需要某虚机时，可以删除该虚机，并释放其所占用的虚拟资源。 
###### 业务流程 
虚机管理流程如下图所示。 
[]images/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.png)具体的维护流程如下： 
操作员在NFVO发起虚机操作后，经VNFM通知VNF进行虚机操作前的预处理。
VNF进行虚机操作前的预处理。不同的虚机操作对应不同的预处理，具体参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new9ccbdce6b7b44c0e8571cd6981737000__ff119e64-5178-41a0-a835-f57d7f566cd7)。
VNF预处理完成后返回响应结果，通知VNFM操作虚机。 
MANO发起虚机操作，有优雅和强制两种方式，区别如下： 
优雅操作：VNF预处理操作成功后，VNFM才继续操作虚机流程；否则，结束操作虚机流程。 
强制操作：无论VNF预处理操作成功与否，VNFM均继续操作虚机流程。 
MANO操作虚机结束后，通知VNF进行虚机操作后的后处理。 
VNF进行虚机操作后的后处理。不同的虚机操作对应不同的后处理，具体参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#new9ccbdce6b7b44c0e8571cd6981737000__ff119e64-5178-41a0-a835-f57d7f566cd7)。
VNF后处理完成后返回响应结果。 
类型|虚机操作|预处理|后处理
---|---|---|---
OMU/AMU|删除|不涉及|相应虚机被删除，如果虚机上运行了SC实例，则该SC也被删除。
停止|OMU/AMU|不涉及|将虚机状态置为“未激活”。如果虚机上运行了SC实例，将SC实例状态置为“未激活”。
创建|OMU/AMU|不涉及|将虚机状态置为“激活”。
启动|OMU/AMU|不涉及|将虚机状态置为“激活”。如果虚机上运行了SC实例，则将SC实例状态置为“激活”。
重启|OMU/AMU|不涉及|不涉及
热迁移|OMU/AMU|不涉及|不涉及
冷迁移|OMU/AMU|不涉及|不涉及
IPU|删除|如果虚机上运行了SC实例，则迁移业务。|相应虚机被删除，如果虚机上运行了SC实例，则该SC也被删除。
停止|IPU|如果虚机上运行了SC实例，则迁移业务。|将虚机状态置为“未激活”。如果虚机上运行了SC，将SC实例状态置为“未激活”。
创建|IPU|不涉及|将虚机状态置为“激活”。
启动|IPU|不涉及|将虚机状态置为“激活”。如果虚机上运行了SC实例，则将SC实例状态置为“激活”。
重启|IPU|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，则迁回业务。
热迁移|IPU|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，则迁回业务。
冷迁移|IPU|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，则迁回业务。
GSU|删除|如果虚机上运行了SC实例，则迁移业务。|相应虚机被删除，如果虚机上运行了SC实例，则该SC也被删除。
停止|GSU|如果虚机上运行了SC实例，则迁移业务。|将虚机状态置为“未激活”。如果虚机上运行了SC，将SC实例状态置为“未激活”。
创建|GSU|不涉及|将虚机状态置为“激活”。
启动|GSU|不涉及|将虚机状态置为“激活”。如果虚机上运行了SC实例，则将SC实例状态置为“激活”。
重启|GSU|如果虚机上运行了SC实例，则迁移业务|如果虚机上运行了SC实例，迁回业务。
热迁移|GSU|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，迁回业务。
冷迁移|GSU|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，迁回业务。
CDU（用于部署CGW）|删除|如果虚机上运行了SC实例，则迁移业务。|相应虚机被删除，如果虚机上运行了SC实例，则该SC也被删除。
停止|CDU（用于部署CGW）|如果虚机上运行了SC实例，则迁移业务。|将虚机状态置为“未激活”。如果虚机上运行了SC，将SC实例状态置为“未激活”。
创建|CDU（用于部署CGW）|不涉及|将虚机状态置为“激活”。
启动|CDU（用于部署CGW）|不涉及|将虚机状态置为“激活”。如果虚机上运行了SC实例，则将SC实例状态置为“激活”。
重启|CDU（用于部署CGW）|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，迁回业务。
热迁移|CDU（用于部署CGW）|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，迁回业务。
冷迁移|CDU（用于部署CGW）|如果虚机上运行了SC实例，则迁移业务。|如果虚机上运行了SC实例，迁回业务。
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
标准类别|标准名称
---|---
ETSI GS NFV|ETSI GS NFN 001 V1.1.1(2013-10)
##### 特性能力 
该特性不涉及规格指标。 
##### 可获得性 
####### 版本要求及变更记录 
序号|发布版本|发布说明
---|---|---
01|V7.19.10|首次发布。
####### License要求 
该特性为的基本特性，无需License支持。 
####### 对其他网元要求 
该特性对其他网元无特殊要求。 
##### O&M相关 
####### 命令 
该特性不涉及命令的变化。 
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警和通知 
序号|告警和通知
---|---
1|3490709528 手动操作虚机开始
2|3490709529 手动操作虚机结束
3|3490709530 调整虚机容量开始
4|3490709531 调整虚机容量结束
5|3490709534 虚机迁移
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 

#### 特性配置 


##### 配置特性 


 

###### 配置说明 
虚机管理包括以下操作：创建、查询、启动、停止、终止、删除、迁移。 
###### 配置前提 
虚机实例化部署成功。 
在NFVO触发虚机管理操作，由VNFM控制VNF完成相关过程。 
###### 配置过程 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表。
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。选择待操作的虚机进行管理操作。
可以选择“优雅”、“强制”不同的方式操作虚机。
###### 配置实例 
######## 删除虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E5%88%A0%E9%99%A4%E8%99%9A%E6%9C%BA1.png)
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。选择待操作的虚机，单击删除，如下图所示。
[]images/%E5%88%A0%E9%99%A4%E8%99%9A%E6%9C%BA2.png)
可以选择“优雅”、“强制”选项，删除虚机。
######## 创建虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E5%88%9B%E5%BB%BA%E8%99%9A%E6%9C%BA1.png)
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。单击界面左上方的“新建”按钮，如下图所示。
[]images/%E5%88%9B%E5%BB%BA%E8%99%9A%E6%9C%BA2.png)
选择需要创建的虚机，方式可以选择“优雅”、“强制”，进行创建。
######## 停止虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E5%81%9C%E6%AD%A2%E8%99%9A%E6%9C%BA1.png)
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。选择待操作的虚机，单击右边“停止”按钮，如下图所示。
[]images/%E5%81%9C%E6%AD%A2%E8%99%9A%E6%9C%BA2.png)
可以选择“优雅”、“强制”两种方式停止虚机。
######## 启动虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E5%90%AF%E5%8A%A8%E8%99%9A%E6%9C%BA1.png)
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。选择待操作的虚机，单击右边“启动”按钮，如下图所示。
[]images/%E5%90%AF%E5%8A%A8%E8%99%9A%E6%9C%BA2.png)
可以选择“优雅”、“强制”两种方式启动虚机。
######## 迁移VNF虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E8%BF%81%E7%A7%BB%E8%99%9A%E6%9C%BA1.png)
单击某个VNF名称，并切换至虚机管理页，可以查看该VNF中所有虚机及每个虚机当前所在的物理主机，如下图所示。
[]images/1616744881751.png)
在需要迁移的虚机对应的操作列，选择更多→热迁移
或更多→冷迁移
，如下图所示。
热迁移：虚机不停用，热迁移过程中不中断业务。 
冷迁移：先停止虚机，再进行虚机冷迁移，业务有中断。 
[]images/%E8%BF%81%E7%A7%BB%E8%99%9A%E6%9C%BA2.png)
在弹出的迁移确认对话框中，单击确定，如下图所示。
[]images/%E8%BF%81%E7%A7%BB%E8%99%9A%E6%9C%BA3.png)
设置迁移的方式，如下图所示。 
[]images/%E8%BF%81%E7%A7%BB%E8%99%9A%E6%9C%BA4.png)参数名称|参数说明
---|---
资源需求|列出了当前虚机的资源需求。需要保证目标主机有足够的资源，迁移才能成功。
方式|虚机迁移时分为两种方式：优雅：执行迁移操作时，VNFM会与VNF交互，待VNF确认同意后，再继续迁移操作。强制：执行迁移操作时，VNFM不会通知VNF，在VNF无感知的情况下进行迁移操作。
指定目标主机|如果需要手工指定虚机迁移的目标主机，可勾选该项，并在下方目标主机列表中选择目标主机。注意：如果VNF中对虚机有亲和性/互斥性的要求，则手工指定的目标主机应符合这些要求，否则会导致迁移失败。
单击提交，系统开始迁移虚机，并将迁移结果显示在页面下方。
######## 重启虚机 
在NFVO客户端，选择菜单编排→应用→VNF
 ，进入VNF实例列表，如下图所示。
[]images/%E9%87%8D%E5%90%AF%E8%99%9A%E6%9C%BA1.png)
单击待操作的VNF名称，在虚机管理页，可以查看该VNF的所有虚机信息。选择待操作的虚机，单击右边“更多”按钮，选择“重启”。
[]images/%E9%87%8D%E5%90%AF%E8%99%9A%E6%9C%BA2.png)
方式可以选择“优雅”、“强制”，进行重启。
##### 测试用例 
测试项目|虚机删除
---|---
测试目的|验证虚机删除功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击删除按钮。分别选择优雅、强制删除操作。
通过准则|虚机删除成功
测试项目|虚机创建
---|---
测试目的|验证虚机创建功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。单击界面左上方的新建按钮，选择待创建的虚机名称。分别选择优雅、强制两种方式创建虚机。
通过准则|虚机创建成功
测试项目|虚机停止
---|---
测试目的|验证虚机停止功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击停止按钮。分别选择优雅、强制停止操作。
通过准则|虚机停止操作成功。
测试项目|虚机启动
---|---
测试目的|验证虚机启动功能
预置条件|ZXUN RCP实例化完成，待操作虚机已成功停止。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击启动按钮。分别选择优雅、强制启动操作。
通过准则|虚机启动操作成功。
测试项目|虚机热迁移
---|---
测试目的|验证虚机热迁移功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击右边更多按钮，选择热迁移。分别选择优雅、强制热迁移操作。指定目标主机分别选择是、否操作。
通过准则|虚机热迁移操作成功。查看虚机所在主机发生更改，指定主机迁移时，能正确迁移到指定主机上。
测试项目|虚机冷迁移
---|---
测试目的|验证虚机冷迁移功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击右边更多按钮，选择冷迁移。分别选择优雅、强制冷迁移操作。指定目标主机分别选择是、否操作。
通过准则|虚机冷迁移操作成功。查看虚机所在主机发生更改，指定主机迁移时，能正确迁移到指定主机上。
测试项目|虚机重启
---|---
测试目的|验证虚机停止功能
预置条件|ZXUN RCP实例化完成。
测试过程|在NFVO客户端的VNF列表中单击待操作VNF，进入虚机管理页面。选择待操作虚机，单击重启按钮。分别选择优雅、强制重启操作。
通过准则|虚机重启操作成功。
### 缩略语 
### 缩略语 
#### AMU 
Arbitration Management Unit仲裁管理单元
#### CDU 
Cloud Database Unit云数据库单元
#### CGW 
CDB GatewayCDB接入网关
#### ETSI 
European Telecommunications Standards Institute欧洲电信标准化协会
#### GSU 
General Service Unit通用业务单元
#### IPU 
Interface Process Unit接口处理单元
#### MANO 
Management and Orchestration管理和编排
#### NFV 
Network Functions Virtualization网络功能虚拟化
#### NFVI 
Network Functions Virtualization Infrastructure网络功能虚拟化基础设施
#### NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
#### OMU 
Operation & Management Unit操作管理单元
#### SC 
Service Component服务组件
#### VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
#### VM 
Virtual Machine虚拟机
#### VNF 
Virtualized Network Function虚拟化网络功能
#### VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
## 操作维护类 
### ZUF-59-57-002 分权分域 
#### 特性描述 
#### 特性描述 
##### 术语 
术语|含义
---|---
分权分域|业务特性按域配置，不同域的用户可享受不同的服务。同时将操作维护者的操作权限和域绑定授权，只允许对一定区域的业务和用户进行管理操作，以保证网管系统的操作安全。
##### 描述 
####### 定义 
分权分域包括“分权”和“分域”两部分功能。 
分域分域是指业务特性可以按域配置，不同域的用户可享受不同的服务。业务支持对用户按号码段和按IMSI段分域。 
分权分权指对操作员的操作权限进行授权，限定操作员只能配置和管理对特定业务区域生效的资源，以保证网管系统的操作安全。操作员通过菜单分域配置→模式切换来选定并进入待配置的域，并在相应的域中进行策略配置来实施对应业务域的配置。如果操作员只被授予单个域的管理权限，则系统自动为其切换至被授权的域，操作员无需执行模式切换操作。按域授权的配置数据包括规则配置和场景配置。 
####### 背景知识 
随着5GC集成化程度不断提升、网元容量越来大，一个网元的服务范围往往覆盖多个行政、地理区域。由于多方面原因，运营商对业务仍然是分区域运营的方式。为了避免各区域的运维出现相互干扰，本特性提供“对用户分级授权、对业务分区管理”的功能。
分域的目的，是为了对不同地域的用户提供不同的业务。分权是在分域条件下的权限控制行为。一般按业务功能类型或业务面向的服务区域设置操作者帐号。该账号被授予的操作权限只在所属区域有效，不能管理其他区域。特权账号可以管理多个或所有区域。 
##### 应用场景 
运营商网络如果运营商需要分区域或分目标用户群开展业务，希望相应的操作者的操作维护权限按区域授权、相应用户的业务配置按区域实行。 
物联网由于不同的物联网接入设备往往对应着不同的行业应用，不同物联网用户的业务特性需求有明显的差别，因此物联网应用时会有分权分域的需求。 
##### 客户收益 
对运营商和用户的收益说明参见[表1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_2017510842496__9673f295-3955-42fa-8640-6a640d00f138)。
收益方|收益说明
---|---
运营商|可以按区域、分用户群运营网络和开展业务。
终端用户|不同用户群体可享受定制化的业务。
##### 实现原理 
####### 系统架构 
RCP在5G核心网中位置如[图1](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_2017510842497__8238bb8c-111c-4ca5-8775-7697234a775b)。
图1  5GC核心网组网
[]images/%E6%9E%B6%E6%9E%84.png)
####### 各网元作用 
涉及的网元及其功能参见[表2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_2017510842497__abef2cf7-cd7b-43f0-9b26-c27efd1079fa)。
网元名称|网元作用
---|---
PCF|根据运营商的策略配置，结合周边NF的输入信息，进行策略决策，向AMF提供接入和移动性策略，向SMF提供PDU会话策略，对AF业务进行策略授权。
AMF|向PCF提供UE接入信息，从PCF获取接入和移动性策略，向RAN/UE部署接入和移动性策略。
SMF|向PCF提供PDU会话信息，从PCF获取PDU会话策略，下发给UPF执行。
UPF|执行PDU会话策略。
AF|向PCF提供应用层的业务信息，请求PCF进行策略授权。例如对于VoNR(Voice over New Radio)业务，IMS的P-CSCF充当AF。在VoNR呼叫建立阶段，P-CSCF从SIP/SDP信令中提取主被叫UE协商的媒体流信息，包含媒体流的类型（音频、视频等）、源目的IP地址和端口、请求带宽等，提供给PCF。收到PCF授权成功的响应消息后，P-CSCF可以继续处理和转发SIP/SDP信令。
NEF|向第三方AF开放5GC策略控制能力，对第三方AF请求进行鉴权（例如判断AF请求是否合法）和翻译（例如将体现AF所在位置的AF服务标识翻译成5GC能够理解的DNN和切片信息）。
BSF|PCF收到SMF上报的PDU会话的UE IP地址后，向BSF注册该UE IP地址和PCF的绑定关系，后续AF/NEF根据UE IP地址向BSF查询所绑定的PCF。
UDR/SPR|向PCF提供策略签约信息，并允许PCF将动态生成的策略数据保存在UDR/SPR中。目前商用部署时采用SPR，测试时可以采用SPR或UDR。
CHF|向PCF提供消费门限信息，例如通知PCF某用户的月累计流量是否超过了特定门限。
####### 本网元实现 
为了实现业务运维隔离，操作维护者被分域授予权限。操作者只能在指定域内进行配置管理。最小授权的操作维护人员只能配置指定的一个域内的业务数据。公共服务和公共配置也作为特殊的域进行权限管理。如[图2](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_2017510842497__e9f602a8-b4fd-4102-9110-474e33b42e5e)所示。
图2  操作员管理权限
[]images/%E6%93%8D%E4%BD%9C%E5%91%98%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90.png)
管理分域
操作维护的资源被划分到各个域。 
公共服务维护系统运行的基本配置，包括网络、虚机、网元服务相关的控制、状态监控等。 
公共配置业务相关的共有配置，如负荷控制参数、license、局向链路等。 
域内专有配置针对域的业务策略配置。分域配置包括策略场景和规则，这些配置只对归属域同域的UE用户有效。 
对于各个域的管理权限，被抽象成不同角色。操作员被管理员赋予若干角色，获得相应的管理权限。 
用户分域
终端用户被划分到不同的域，用户相关的业务按域进行策略控制。 
以终端的IMSI或MSISDN将用户划分到不同域，AMF、SMF、PCEF向RCP请求策略控制，RCP根据用户的IMSI或MSISDN确定用户的归属域，根据其归属域的策略配置，进行策略控制。 
####### 业务流程 
AMF、SMF、PCEF向RCP请求策略控制，RCP根据用户的IMSI或MSISDN确定用户的归属域，根据其归属域的策略配置，进行策略控制。 
以下以SM策略关联建立流程为例，说明分域进行策略控制的过程。如[图3](1-%E7%89%B9%E6%80%A7%E6%8F%8F%E8%BF%B0.html#T_2017510842497__3e664c25-790d-432e-a7fe-2954d3edfe37)所示。
图3  分权分域业务流程
[]images/33a500e97d0a46f3a9e771bf6d36425a.png)
流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求。 
RCP根据用户号码获取所在域，进行策略决策，生成规则，向SMF发送Npcf_SMPolicyControl_Create响应。对端网元收到消息后，根据消息内容安装规则。 
##### 系统影响 
该特性不涉及对系统的影响。 
##### 应用限制 
该特性不涉及应用限制。 
##### 特性交互 
该特性不涉及与其他特性的交互。 
##### 遵循标准 
本特性采用中兴公司内部的接口和协议，不涉及标准协议。 
##### 特性能力 
名称|指标
---|---
最大分域|64
##### 可获得性 
####### 版本要求及变更记录 
特性版本|发布版本|发布说明
---|---|---
01|V7.21.32|首次发布。
####### License要求 
该特性需要开启License。License中分权分域受控项标识为LIC_RCP_FUNC_MULTIDOMAIN，需将其权限设置为打开状态。
####### 对其他网元的要求 
该特性对其他网元无特殊要求。
##### O&M相关 
####### 命令 
命令项|命令名称|描述
---|---|---
业务域配置|ADD DOMAIN|新增业务域配置。
SET DOMAIN|业务域配置|修改业务域配置。
DEL DOMAIN|业务域配置|删除业务域配置。
SHOW DOMAIN|业务域配置|查询业务域配置。
用户归属域配置|ADD USERDOMAIN|新增一个号码段的用户所归属的域的配置。
SET USERDOMAIN|用户归属域配置|修改一个号码段的用户所归属的域的配置。
DEL USERDOMAIN|用户归属域配置|删除一个号码段的用户所归属的域的配置。
SHOW USERDOMAIN|用户归属域配置|查询一个号码段的用户所归属的域的配置。
####### 性能统计 
该特性不涉及计数器的变化。 
####### 告警和通知 
该特性不涉及告警消息的变化。 
####### 业务观察/失败观察 
该特性不涉及业务观察/失败观察的变化。 
####### 话单与计费 
该特性不涉及话单与计费的变化。 
#### 特性配置 
#### 特性配置 

##### 配置分权分域 


 

###### 配置说明 
使用admin用户创建不同的用户，并为用户分配业务域的配置操作权限。功能开启后，被分配权限的用户具备所在域网管命令及策略管理的配置权限。不同业务域的用户适用不同域中的规则。 
###### 配置前提 
网元已加载支持分权分域功能的License。 
###### 配置过程 
配置流程如[图1](14-%E7%89%B9%E6%80%A7%E9%85%8D%E7%BD%AE.html#T_20175108424918__8c46a1dc-7cd4-47b1-932e-747a29064305)所示。
图1  配置流程
[]images/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B.png)
步骤： 
admin用户登录EM，选择配置→命令终端
，进入命令终端页面。
执行[ADD DOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788252.html)命令新增业务域配置。
执行[ADD USERDOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788257.html)命令新增终端用户归属域配置。
配置策略基本数据、条件参数、动作参数。 
选择系统→角色管理
，新建系统角色（例如，角色A），给该角色分配相应业务域的权限。
选择系统→用户管理
，新建系统用户（例如，用户A），并为用户分配角色。
用户（例如，用户A）登录EM，任选如下两种方式中的一种，配置对应业务域的相关策略规则。 
命令方式执行ENTER DOMAIN命令，进入需要配置的业务域，并在对应域中配置相关策略规则。执行EXIT DOMAIN命令，退出业务域。执行SYNA命令传表。 
GUI方式选择配置→RCP策略管理，进入RCP策略管理页面。选择需要配置的业务域，并在对应域中配置相关策略规则。 
###### 配置实例 
######## 场景说明 
按照不同地区要求进行分权分域，创建不同的域并在对应的域中进行配置。 
######## 数据规划 
用户|角色|权限
---|---|---
A|A|Domain1
B|B|Domain2
C|C|Domain1和Domain2
类别|参数|取值
---|---|---
新增业务域配置|域编号|1
2|新增业务域配置|域编号
域描述|新增业务域配置|域描述1
域描述2|域描述|新增业务域配置
类别|参数|取值
---|---|---
新增用户归属域配置|记录标识|1
2|新增用户归属域配置|记录标识
用户类型|新增用户归属域配置|MSISDN
起始号码|新增用户归属域配置|123456789010000
123456789020000|起始号码|新增用户归属域配置
结束号码|新增用户归属域配置|123456789020001
123456789030000|结束号码|新增用户归属域配置
域编号|新增用户归属域配置|1
2|域编号|新增用户归属域配置
######## 配置步骤 
admin用户登录EM客户端，选择配置→命令终端
，进入命令终端页面。
新增业务域配置。 
[ADD DOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788252.html):DOMAINID=1,DOMAINNAME="域描述1"
[ADD DOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788252.html):DOMAINID=2,DOMAINNAME="域描述2"
新增用户业务归属配置。 
[ADD USERDOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788257.html):ID=1,USERTYPE=MSISDN,NUMBEGIN="123456789010000",NUMEND="123456789020000",DOMAINID=1
[ADD USERDOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788257.html):ID=2,USERTYPE=MSISDN,NUMBEGIN="123456789020001",NUMEND="123456789030000",DOMAINID=2
选择系统→角色管理
，进入角色管理页面，新增角色A、B、C，根据规划将业务域Domain1、Domain2操作权限分配给相应角色。
选择系统→用户管理
，进入用户管理页面，新增用户A、B、C，根据规划将用户赋予相应的角色。
配置策略基本数据、条件和动作参数。 
[ADD DM TIME](../../Npcf_PolicyManagement\zh-CN\mml\1787301.html):NAME="time1",PERIOD="SYS_BUSY",PKGID="",STIME=06:00,ETIME=9:00;
[ADD DM USGBASE](../../Npcf_PolicyManagement\zh-CN\mml\1787225.html):ID=1,NAME="Usage_Session_1",LAYER="MK_USER",PERIOD="DAY",USGTYPE="VOL",PKGID="",MKLIST="sessMK1",TIMEATTR="*",THRSH=0,LOGFLAG="OFF",ROLLNAME="";
[ADD DM COND](../../Npcf_PolicyManagement\zh-CN\mml\1787022.html):NAME="Gx=2001",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="2001";
[ADD DM ACTION](../../Npcf_PolicyManagement\zh-CN\mml\1787037.html):NAME="CHG_1",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"VALUE"-"chg001";
配置业务域策略规则和场景。 
 说明： 
以用户A为例，说明相关配置过程。用户B和C参考用户A的配置过程。 
用户A登录EM客户端，选择配置→命令终端
，进入命令终端页面。
进入业务域Domain1。 
[ENTER  DOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788261.html):DOMAINID=1
Domain1下进行规则配置，引用0域配置的条件、动作参数。 
[ADD DM RULE](../../Npcf_PolicyManagement\zh-CN\mml\1787305.html):NAME="Usage_Session_Rule_01",PLCTYPE="SESS_USG",PRIOR=5,CONDEXP="{Usage<2048}",ACTTYPE="PARAM",ACTNAME="Usage_Session_01",LOGFLAG="OFF",RULENO=0;
Domain1下进行场景配置，引用Domain1下的规则。 
[ADD DM ROLE](../../Npcf_PolicyManagement\zh-CN\mml\1787217.html):NAME="ROLE_套餐=1",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="Usage_Session_Rule_01"&"Usage_Session_Rule_02"&"Gx_Session_Rule_01"&"Gx_Session_Rule_02"&"Gx_Session_Rule_03"&"Gx_Service_Rule_01"&"Gx_Service_Rule_02"&"Gx_Service_Rule_03"&"N7_Session_Rule_01"&"N7_Session_Rule_02"&"N7_Session_Rule_03"&"N7_Service_Rule_01"&"N7_Service_Rule_02"&"N7_Service_Rule_03"&"N15_Session_Rule_01"&"N15_Session_Rule_02"&"N15_Session_Rule_03"&"UE_Session_Rule_01"&"UE_Session_Rule_02"&"UE_Session_Rule_03",VALIDFLAG="ENABLE";
退出业务域Domain1。 
[EXIT DOMAIN](../../Npcf_PolicyManagement\zh-CN\mml\1788262.html)
传表。 
[SYNA](../../CommonS_OAM\zh-CN\mml\1850234.html)
######## 配置脚本 
ADD DM TIME:NAME="time1",PERIOD="SYS_BUSY",PKGID="",STIME=06:00,ETIME=9:00; 
ADD DM TIME:NAME="time2",PERIOD="SYS_IDLE",PKGID="",STIME=15:00,ETIME=18:00; 
ADD DM USGBASE:ID=1,NAME="Usage_Session_1",LAYER="MK_USER",PERIOD="DAY",USGTYPE="VOL",PKGID="",MKLIST="sessMK1",TIMEATTR="*",THRSH=0,LOGFLAG="OFF",ROLLNAME=""; 
ADD DM USGBASE:ID=2,NAME="Usage_Session_2",LAYER="MK_USER",PERIOD="DAY",USGTYPE="VOL",PKGID="",MKLIST="sessMK2",TIMEATTR="*",THRSH=0,LOGFLAG="OFF",ROLLNAME=""; 
ADD DM USGBASE:ID=3,NAME="Usage_Session_3",LAYER="MK_USER",PERIOD="DAY",USGTYPE="VOL",PKGID="",MKLIST="sessMK3",TIMEATTR="*",THRSH=0,LOGFLAG="OFF",ROLLNAME=""; 
ADD DM COND:NAME="Gx=2001",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="2001"; 
ADD DM COND:NAME="Gx=2002",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="2002"; 
ADD DM COND:NAME="Gx=2003",SVCKEY="SYS.GX_APP_ID",OPERATOR="=",VALTYPE="VALUE",VALUE="2003"; 
ADD DM COND:NAME="usertype=1",SVCKEY="SYS.USER_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="1"; 
ADD DM COND:NAME="usertype=2",SVCKEY="SYS.USER_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="2"; 
ADD DM COND:NAME="usertype=3",SVCKEY="SYS.USER_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="3"; 
ADD DM COND:NAME="time1",SVCKEY="SYS.TIME",OPERATOR="TimeIn",VALTYPE="VALUE",VALUE="time1"; 
ADD DM COND:NAME="time2",SVCKEY="SYS.TIME",OPERATOR="TimeIn",VALTYPE="VALUE",VALUE="time2"; 
ADD DM COND:NAME="ratType=NR",SVCKEY="SYS.GX_RAT",OPERATOR="=",VALTYPE="VALUE",VALUE="NG-RAN"; 
ADD DM COND:NAME="ratType=EUTRA",SVCKEY="SYS.GX_RAT",OPERATOR="=",VALTYPE="VALUE",VALUE="EUTRAN"; 
ADD DM COND:NAME="ratType=WLAN",SVCKEY="SYS.GX_RAT",OPERATOR="=",VALTYPE="VALUE",VALUE="WLAN"; 
ADD DM COND:NAME="Usage<2048",SVCKEY="Usage_Session_1.TOTAL_REAL",OPERATOR="<",VALTYPE="VALUE",VALUE="2048"; 
ADD DM COND:NAME="Usage>2048",SVCKEY="Usage_Session_2.TOTAL_REAL",OPERATOR=">",VALTYPE="VALUE",VALUE="2048"; 
ADD DM COND:NAME="3GPP",SVCKEY="SYS.ACCESS_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="3GPP_ACCESS"; 
ADD DM COND:NAME="No_3GPP",SVCKEY="SYS.ACCESS_TYPE",OPERATOR="=",VALTYPE="VALUE",VALUE="NON_3GPP_ACCESS"; 
ADD DM ACTION:NAME="CHG_1",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"VALUE"-"chg001"; 
ADD DM ACTION:NAME="CHG_2",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"VALUE"-"chg002"; 
ADD DM ACTION:NAME="CHG_3",TYPE="CHARG_PARASET",PARAMS="SYS.CHARGING_ID"-"VALUE"-"chg003"; 
ADD DM ACTION:NAME="Qos_1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"VALUE"-"qos001"&"SYS.QOS_5QI"-"VALUE"-"10"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"VALUE"-"10"&"SYS.QOS_ARP_PREEMPTION_CAP"-"VALUE"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"VALUE"-"PREEMPTABLE"; 
ADD DM ACTION:NAME="Qos_2",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"VALUE"-"qos002"&"SYS.QOS_5QI"-"VALUE"-"20"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"VALUE"-"20"&"SYS.QOS_ARP_PREEMPTION_CAP"-"VALUE"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"VALUE"-"PREEMPTABLE"; 
ADD DM ACTION:NAME="Qos_3",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"VALUE"-"qos003"&"SYS.QOS_5QI"-"VALUE"-"30"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"VALUE"-"30"&"SYS.QOS_ARP_PREEMPTION_CAP"-"VALUE"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"VALUE"-"PREEMPTABLE"; 
ADD DM ACTION:NAME="TC_1",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"VALUE"-"tc001"; 
ADD DM ACTION:NAME="TC_2",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"VALUE"-"tc002"; 
ADD DM ACTION:NAME="TC_3",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"VALUE"-"tc003"; 
ADD DM ACTION:NAME="N7_Service_01",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"VALUE"-"N7ServiceRuleName01"&"SYS.N7_PCC_RULE_TYPE"-"VALUE"-"DYNA_RULE"&"SYS.N7_PCC_APPID"-"VALUE"-"2001"&"SYS.N7_PCC_QoS_ID"-"VALUE"-"Qos_1"&"SYS.N7_PCC_TC_ID"-"VALUE"-"TC_1"&"SYS.N7_PCC_CHARGING_ID"-"VALUE"-"CHG_1"&"SYS.N7_MONITOR_KEY"-"VALUE"-"2001_1"; 
ADD DM ACTION:NAME="N7_Service_02",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"VALUE"-"N7ServiceRuleName02"&"SYS.N7_PCC_RULE_TYPE"-"VALUE"-"DYNA_RULE"&"SYS.N7_PCC_APPID"-"VALUE"-"2002"&"SYS.N7_PCC_QoS_ID"-"VALUE"-"Qos_2"&"SYS.N7_PCC_TC_ID"-"VALUE"-"TC_2"&"SYS.N7_PCC_CHARGING_ID"-"VALUE"-"CHG_2"&"SYS.N7_MONITOR_KEY"-"VALUE"-"2002_2"; 
ADD DM ACTION:NAME="N7_Service_03",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"VALUE"-"N7ServiceRuleName03"&"SYS.N7_PCC_RULE_TYPE"-"VALUE"-"DYNA_RULE"&"SYS.N7_PCC_APPID"-"VALUE"-"2003"&"SYS.N7_PCC_QoS_ID"-"VALUE"-"Qos_3"&"SYS.N7_PCC_TC_ID"-"VALUE"-"TC_3"&"SYS.N7_PCC_CHARGING_ID"-"VALUE"-"CHG_3"&"SYS.N7_MONITOR_KEY"-"VALUE"-"2003_3"; 
ADD DM ACTION:NAME="Usage_Session_01",TYPE="SESS_USG",PARAMS="SYS.GX_ACTION_KEY_SESS_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SESS_TOTAL_THRESHOLD"-"VALUE"-"1024"&"SYS.MONITOR_KEY"-"VALUE"-"SessionMK1"; 
ADD DM ACTION:NAME="Usage_Session_02",TYPE="SESS_USG",PARAMS="SYS.GX_ACTION_KEY_SESS_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SESS_TOTAL_THRESHOLD"-"VALUE"-"2048"&"SYS.MONITOR_KEY"-"VALUE"-"SessionMK2"; 
ADD DM ACTION:NAME="Usage_Session_03",TYPE="SESS_USG",PARAMS="SYS.GX_ACTION_KEY_SESS_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SESS_TOTAL_THRESHOLD"-"VALUE"-"3072"&"SYS.MONITOR_KEY"-"VALUE"-"SessionMK3"; 
ADD DM ACTION:NAME="N15_area_01",TYPE="N15_SERV_AREA_RESTRICT",PARAMS="SYS.N15_SERVICE_AREA_TYPE"-"VALUE"-"AREA_CODE"&"SYS.N15_SERVICE_AREA_CODE"-"VALUE"-"11"; 
ADD DM ACTION:NAME="N15_area_02",TYPE="N15_SERV_AREA_RESTRICT",PARAMS="SYS.N15_SERVICE_AREA_TYPE"-"VALUE"-"AREA_CODE"&"SYS.N15_SERVICE_AREA_CODE"-"VALUE"-"22"; 
ADD DM ACTION:NAME="N15_area_03",TYPE="N15_SERV_AREA_RESTRICT",PARAMS="SYS.N15_SERVICE_AREA_TYPE"-"VALUE"-"AREA_CODE"&"SYS.N15_SERVICE_AREA_CODE"-"VALUE"-"33"; 
ADD DM ACTION:NAME="N15_Session_01",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.RFSP_INDEX"-"VALUE"-"11"&"SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"VALUE"-"CONFIG"&"SYS.SERVICE_AREA_RESTRICTION_TYPE"-"VALUE"-"ALLOW"&"SYS.SERVICE_AREA_RESTRICTION_ACT_ID"-"VALUE"-"N15_area_01"; 
ADD DM ACTION:NAME="N15_Session_02",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.RFSP_INDEX"-"VALUE"-"22"&"SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"VALUE"-"CONFIG"&"SYS.SERVICE_AREA_RESTRICTION_TYPE"-"VALUE"-"ALLOW"&"SYS.SERVICE_AREA_RESTRICTION_ACT_ID"-"VALUE"-"N15_area_02"; 
ADD DM ACTION:NAME="N15_Session_03",TYPE="ACCESS_POLICY_PARA",PARAMS="SYS.RFSP_INDEX"-"VALUE"-"33"&"SYS.SERVICE_AREA_RESTRICTION_DEC_METHOD"-"VALUE"-"CONFIG"&"SYS.SERVICE_AREA_RESTRICTION_TYPE"-"VALUE"-"ALLOW"&"SYS.SERVICE_AREA_RESTRICTION_ACT_ID"-"VALUE"-"N15_area_03"; 
ADD DM ACTION:NAME="UE_FlLOW_01",TYPE="UE_TRAFFIC",PARAMS="SYS.URSP_TRAF_TYPE"-"VALUE"-"FLOWLABEL"&"SYS.URSP_TRAF_VALUE"-"VALUE"-"11"; 
ADD DM ACTION:NAME="UE_FlLOW_02",TYPE="UE_TRAFFIC",PARAMS="SYS.URSP_TRAF_TYPE"-"VALUE"-"FLOWLABEL"&"SYS.URSP_TRAF_VALUE"-"VALUE"-"22"; 
ADD DM ACTION:NAME="UE_FlLOW_03",TYPE="UE_TRAFFIC",PARAMS="SYS.URSP_TRAF_TYPE"-"VALUE"-"FLOWLABEL"&"SYS.URSP_TRAF_VALUE"-"VALUE"-"33"; 
ADD DM ACTION:NAME="UE_ursd_01",TYPE="UE_ROUTE_DESC",PARAMS="SYS.URSD_PRECEDENCE"-"VALUE"-"1"&"SYS.URSD_SSC_MODE"-"VALUE"-"SSC_MODE_1"&"SYS.URSD_PDU_SESS_TYPE"-"VALUE"-"IPV4"&"SYS.URSD_DNN"-"VALUE"-"ZTE.COM_11"; 
ADD DM ACTION:NAME="UE_ursd_02",TYPE="UE_ROUTE_DESC",PARAMS="SYS.URSD_PRECEDENCE"-"VALUE"-"1"&"SYS.URSD_SSC_MODE"-"VALUE"-"SSC_MODE_2"&"SYS.URSD_PDU_SESS_TYPE"-"VALUE"-"IPV4"&"SYS.URSD_DNN"-"VALUE"-"ZTE.COM_22"; 
ADD DM ACTION:NAME="UE_ursd_03",TYPE="UE_ROUTE_DESC",PARAMS="SYS.URSD_PRECEDENCE"-"VALUE"-"1"&"SYS.URSD_SSC_MODE"-"VALUE"-"SSC_MODE_3"&"SYS.URSD_PDU_SESS_TYPE"-"VALUE"-"IPV4"&"SYS.URSD_DNN"-"VALUE"-"ZTE.COM_33"; 
ADD DM ACTION:NAME="UE_ursp_01",TYPE="URSP_RULE_DESC",PARAMS="SYS.URSP_RULE_NAME"-"VALUE"-"UE_UrspName_01"&"SYS.URSP_RULE_UPSC"-"VALUE"-"1"&"SYS.URSP_RULE_PRECEDENCE"-"VALUE"-"1"&"SYS.URSP_RULE_TRAF_DESC_ACT_ID"-"VALUE"-"UE_FlLOW_01"&"SYS.URSP_RULE_URSD_ACT_ID"-"VALUE"-"UE_ursd_01"; 
ADD DM ACTION:NAME="UE_ursp_02",TYPE="URSP_RULE_DESC",PARAMS="SYS.URSP_RULE_NAME"-"VALUE"-"UE_UrspName_02"&"SYS.URSP_RULE_UPSC"-"VALUE"-"1"&"SYS.URSP_RULE_PRECEDENCE"-"VALUE"-"1"&"SYS.URSP_RULE_TRAF_DESC_ACT_ID"-"VALUE"-"UE_FlLOW_02"&"SYS.URSP_RULE_URSD_ACT_ID"-"VALUE"-"UE_ursd_02"; 
ADD DM ACTION:NAME="UE_ursp_03",TYPE="URSP_RULE_DESC",PARAMS="SYS.URSP_RULE_NAME"-"VALUE"-"UE_UrspName_03"&"SYS.URSP_RULE_UPSC"-"VALUE"-"1"&"SYS.URSP_RULE_PRECEDENCE"-"VALUE"-"1"&"SYS.URSP_RULE_TRAF_DESC_ACT_ID"-"VALUE"-"UE_FlLOW_02"&"SYS.URSP_RULE_URSD_ACT_ID"-"VALUE"-"UE_ursd_03"; 
ADD DM ACTION:NAME="UE_action_01",TYPE="UE_ROUTE_POLICY",PARAMS="SYS.URSP_RULE_ACT_ID"-"VALUE"-"UE_ursp_01"; 
ADD DM ACTION:NAME="UE_action_02",TYPE="UE_ROUTE_POLICY",PARAMS="SYS.URSP_RULE_ACT_ID"-"VALUE"-"UE_ursp_02"; 
ADD DM ACTION:NAME="UE_action_03",TYPE="UE_ROUTE_POLICY",PARAMS="SYS.URSP_RULE_ACT_ID"-"VALUE"-"UE_ursp_03"; 
ADD DM ACTION:NAME="Gx_Session_01",TYPE="SESS_CTRL",PARAMS="SYS.APN_AGG_MAX_UL_BW"-"VALUE"-"2048"&"SYS.APN_AGG_MAX_DL_BW"-"VALUE"-"1024"; 
ADD DM ACTION:NAME="Gx_Session_02",TYPE="SESS_CTRL",PARAMS="SYS.APN_AGG_MAX_UL_BW"-"VALUE"-"3072"&"SYS.APN_AGG_MAX_DL_BW"-"VALUE"-"2048"; 
ADD DM ACTION:NAME="Gx_Session_03",TYPE="SESS_CTRL",PARAMS="SYS.APN_AGG_MAX_UL_BW"-"VALUE"-"4096"&"SYS.APN_AGG_MAX_DL_BW"-"VALUE"-"3072"; 
ADD DM ACTION:NAME="Gx_Service_01",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"VALUE"-"10"&"SYS.ARP_PRE_EMP_CAP"-"VALUE"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"VALUE"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"VALUE"-"DYM_RULE"&"SYS.PRE_APPID"-"VALUE"-"2001"&"SYS.QOS_CLASS"-"VALUE"-"10"&"SYS.MAX_BR_UL"-"VALUE"-"2048"&"SYS.MAX_BR_DL"-"VALUE"-"1024"&"SYS.CHARGING_RULE_NAME"-"VALUE"-"GxServiceRuleName01"; 
ADD DM ACTION:NAME="Gx_Service_02",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"VALUE"-"20"&"SYS.ARP_PRE_EMP_CAP"-"VALUE"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"VALUE"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"VALUE"-"DYM_RULE"&"SYS.PRE_APPID"-"VALUE"-"2002"&"SYS.QOS_CLASS"-"VALUE"-"20"&"SYS.MAX_BR_UL"-"VALUE"-"3072"&"SYS.MAX_BR_DL"-"VALUE"-"2048"&"SYS.CHARGING_RULE_NAME"-"VALUE"-"GxServiceRuleName02"; 
ADD DM ACTION:NAME="Gx_Service_03",TYPE="PCC_RULE",PARAMS="SYS.ARP_PRI_LEVEL"-"VALUE"-"30"&"SYS.ARP_PRE_EMP_CAP"-"VALUE"-"ENABLE"&"SYS.ARP_PRE_EMP_VUL"-"VALUE"-"DISABLE"&"SYS.SVC_RULE_TYPE"-"VALUE"-"DYM_RULE"&"SYS.PRE_APPID"-"VALUE"-"2003"&"SYS.QOS_CLASS"-"VALUE"-"30"&"SYS.MAX_BR_UL"-"VALUE"-"4096"&"SYS.MAX_BR_DL"-"VALUE"-"3072"&"SYS.CHARGING_RULE_NAME"-"VALUE"-"GxServiceRuleName03"; 
ADD DM ACTION:NAME="N7_Session_01",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"VALUE"-"N7SessionRuleName01"&"SYS.SESS_AMBR_UL"-"VALUE"-"110000"&"SYS.SESS_AMBR_DL"-"VALUE"-"100000"&"SYS.DEF_QOS_5QI"-"VALUE"-"10"&"SYS.SESS_UM_ID"-"VALUE"-"sessMK1"; 
ADD DM ACTION:NAME="N7_Session_02",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"VALUE"-"N7SessionRuleName02"&"SYS.SESS_AMBR_UL"-"VALUE"-"220000"&"SYS.SESS_AMBR_DL"-"VALUE"-"200000"&"SYS.DEF_QOS_5QI"-"VALUE"-"20"&"SYS.SESS_UM_ID"-"VALUE"-"sessMK2"; 
ADD DM ACTION:NAME="N7_Session_03",TYPE="SESSION_PARASET",PARAMS="SYS.SESS_RULE_ID"-"VALUE"-"N7SessionRuleName03"&"SYS.SESS_AMBR_UL"-"VALUE"-"330000"&"SYS.SESS_AMBR_DL"-"VALUE"-"300000"&"SYS.DEF_QOS_5QI"-"VALUE"-"30"&"SYS.SESS_UM_ID"-"VALUE"-"sessMK3"; 
ADD DM ACTION:NAME="Usage_Service_01",TYPE="SVC_USG",PARAMS="SYS.GX_ACTION_KEY_SVC_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SVC_TOTAL_THRESHOLD"-"VALUE"-"10240"; 
ADD DM ACTION:NAME="Usage_Service_02",TYPE="SVC_USG",PARAMS="SYS.GX_ACTION_KEY_SVC_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SVC_TOTAL_THRESHOLD"-"VALUE"-"20480"; 
ADD DM ACTION:NAME="Usage_Service_03",TYPE="SVC_USG",PARAMS="SYS.GX_ACTION_KEY_SVC_THRESHOLD_CTR_MOD"-"VALUE"-"FIXED_VALUE"&"SYS.GX_ACTION_KEY_SVC_TOTAL_THRESHOLD"-"VALUE"-"30720"; 
ADD DM RULE:NAME="Usage_Session_Rule_01",PLCTYPE="SESS_USG",PRIOR=5,CONDEXP="{Usage<2048}",ACTTYPE="PARAM",ACTNAME="Usage_Session_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Usage_Session_Rule_02",PLCTYPE="SESS_USG",PRIOR=10,CONDEXP="{Usage>2048}",ACTTYPE="PARAM",ACTNAME="Usage_Session_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Session_Rule_01",PLCTYPE="SESS_CTRL",PRIOR=5,CONDEXP="{usertype=1}",ACTTYPE="PARAM",ACTNAME="Gx_Session_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Session_Rule_02",PLCTYPE="SESS_CTRL",PRIOR=10,CONDEXP="{usertype=2}",ACTTYPE="PARAM",ACTNAME="Gx_Session_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Session_Rule_03",PLCTYPE="SESS_CTRL",PRIOR=15,CONDEXP="{usertype=3}",ACTTYPE="PARAM",ACTNAME="Gx_Session_03",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Service_Rule_01",PLCTYPE="SVC_CTRL",PRIOR=5,CONDEXP="{Gx=2001}",ACTTYPE="PARAM",ACTNAME="Gx_Service_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Service_Rule_02",PLCTYPE="SVC_CTRL",PRIOR=10,CONDEXP="{Gx=2002}",ACTTYPE="PARAM",ACTNAME="Gx_Service_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="Gx_Service_Rule_03",PLCTYPE="SVC_CTRL",PRIOR=15,CONDEXP="{Gx=2003}",ACTTYPE="PARAM",ACTNAME="Gx_Service_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Session_Rule_01",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=5,CONDEXP="{usertype=1}",ACTTYPE="PARAM",ACTNAME="N7_Session_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Session_Rule_02",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=10,CONDEXP="{usertype=2}",ACTTYPE="PARAM",ACTNAME="N7_Session_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Session_Rule_03",PLCTYPE="DM_RULE_TYPE_N7_SESS",PRIOR=15,CONDEXP="{usertype=3}",ACTTYPE="PARAM",ACTNAME="N7_Session_03",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Service_Rule_01",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=5,CONDEXP="{Gx=2001}",ACTTYPE="PARAM",ACTNAME="N7_Service_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Service_Rule_02",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=10,CONDEXP="{Gx=2002}",ACTTYPE="PARAM",ACTNAME="N7_Service_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N7_Service_Rule_03",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=15,CONDEXP="{Gx=2003}",ACTTYPE="PARAM",ACTNAME="N7_Service_03",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N15_Session_Rule_01",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=5,CONDEXP="{usertype=1}",ACTTYPE="PARAM",ACTNAME="N15_Session_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N15_Session_Rule_02",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=10,CONDEXP="{usertype=2}",ACTTYPE="PARAM",ACTNAME="N15_Session_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="N15_Session_Rule_03",PLCTYPE="DM_RULE_TYPE_N15_DEC",PRIOR=15,CONDEXP="{usertype=3}",ACTTYPE="PARAM",ACTNAME="N15_Session_03",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="UE_Session_Rule_01",PLCTYPE="DM_RULE_TYPE_UE_URSP_DEC",PRIOR=5,CONDEXP="{usertype=1}",ACTTYPE="PARAM",ACTNAME="UE_action_01",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="UE_Session_Rule_02",PLCTYPE="DM_RULE_TYPE_UE_URSP_DEC",PRIOR=10,CONDEXP="{usertype=2}",ACTTYPE="PARAM",ACTNAME="UE_action_02",LOGFLAG="OFF",RULENO=0; 
ADD DM RULE:NAME="UE_Session_Rule_03",PLCTYPE="DM_RULE_TYPE_UE_URSP_DEC",PRIOR=15,CONDEXP="{usertype=3}",ACTTYPE="PARAM",ACTNAME="UE_action_03",LOGFLAG="OFF",RULENO=0; 
ADD DM ROLE:NAME="ROLE_套餐=1",ENTRANCE="SYS.USER_PAK_ID"-"1",RULENAME="Usage_Session_Rule_01"&"Usage_Session_Rule_02"&"Gx_Session_Rule_01"&"Gx_Session_Rule_02"&"Gx_Session_Rule_03"&"Gx_Service_Rule_01"&"Gx_Service_Rule_02"&"Gx_Service_Rule_03"&"N7_Session_Rule_01"&"N7_Session_Rule_02"&"N7_Session_Rule_03"&"N7_Service_Rule_01"&"N7_Service_Rule_02"&"N7_Service_Rule_03"&"N15_Session_Rule_01"&"N15_Session_Rule_02"&"N15_Session_Rule_03"&"UE_Session_Rule_01"&"UE_Session_Rule_02"&"UE_Session_Rule_03",VALIDFLAG="ENABLE"; 
ADD DM ROLE:NAME="ROLE_APN=ims",ENTRANCE="SYS.GX_APN"-"ims",RULENAME="Gx_Session_Rule_01"&"Gx_Session_Rule_02"&"Gx_Session_Rule_03"&"Gx_Service_Rule_01"&"Gx_Service_Rule_02"&"Gx_Service_Rule_03"&"N7_Session_Rule_01"&"N7_Session_Rule_02"&"N7_Session_Rule_03"&"N7_Service_Rule_01"&"N7_Service_Rule_02"&"N7_Service_Rule_03",VALIDFLAG="ENABLE"; 
##### 测试用例 
测试条目|admin用户创建角色、用户，有单个域的配置权限
---|---
预置条件|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。
测试步骤|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1的权限，将此角色分配给用户A。新建角色B，给该角色分配包含Domain2的权限，将此角色分配给用户B。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、0域。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件、动作参数。Domain1下进行场景配置，引用Domain1下的规则。用户B登登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain2、0域。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1的权限，将此角色分配给用户A。新建角色B，给该角色分配包含Domain2的权限，将此角色分配给用户B。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、0域。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件、动作参数。Domain1下进行场景配置，引用Domain1下的规则。用户B登登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain2、0域。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1的权限，将此角色分配给用户A。新建角色B，给该角色分配包含Domain2的权限，将此角色分配给用户B。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、0域。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件、动作参数。Domain1下进行场景配置，引用Domain1下的规则。用户B登登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain2、0域。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1的权限，将此角色分配给用户A。新建角色B，给该角色分配包含Domain2的权限，将此角色分配给用户B。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、0域。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件、动作参数。Domain1下进行场景配置，引用Domain1下的规则。用户B登登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain2、0域。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件、动作参数。Domain2下进行场景配置，引用Domain2下的规则。
通过准则|用户可以正确进入相应的业务域，能正确配置策略规则和场景。|用户可以正确进入相应的业务域，能正确配置策略规则和场景。|用户可以正确进入相应的业务域，能正确配置策略规则和场景。|用户可以正确进入相应的业务域，能正确配置策略规则和场景。
测试条目|admin用户创建角色、用户，有多个域的配置权限
---|---
预置条件|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。
测试步骤|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1、Domain2的权限，将此角色分配给用户A。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、Domain2。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。Domain2下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=0，进入0域。0域下进行规则配置，引用0域配置的条件参数、动作参数。0域下进行场景配置，引用0域下的规则。0域下进行场景配置，引用Domain1下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1、Domain2的权限，将此角色分配给用户A。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、Domain2。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。Domain2下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=0，进入0域。0域下进行规则配置，引用0域配置的条件参数、动作参数。0域下进行场景配置，引用0域下的规则。0域下进行场景配置，引用Domain1下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1、Domain2的权限，将此角色分配给用户A。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、Domain2。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。Domain2下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=0，进入0域。0域下进行规则配置，引用0域配置的条件参数、动作参数。0域下进行场景配置，引用0域下的规则。0域下进行场景配置，引用Domain1下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。新建角色A，给该角色分配包含Domain1、Domain2的权限，将此角色分配给用户A。用户A登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行SHOW DOMAIN命令，查看当前用户拥有权限的业务域Domain1、Domain2。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。Domain2下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=0，进入0域。0域下进行规则配置，引用0域配置的条件参数、动作参数。0域下进行场景配置，引用0域下的规则。0域下进行场景配置，引用Domain1下的规则。
通过准则|Domain1下进行场景配置，引用Domain1下的规则，配置成功。Domain2下进行场景配置，引用Domain2下的规则，配置成功。0域下进行场景配置，引用0域下的规则，配置成功。Domain2下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。0域下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。|Domain1下进行场景配置，引用Domain1下的规则，配置成功。Domain2下进行场景配置，引用Domain2下的规则，配置成功。0域下进行场景配置，引用0域下的规则，配置成功。Domain2下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。0域下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。|Domain1下进行场景配置，引用Domain1下的规则，配置成功。Domain2下进行场景配置，引用Domain2下的规则，配置成功。0域下进行场景配置，引用0域下的规则，配置成功。Domain2下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。0域下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。|Domain1下进行场景配置，引用Domain1下的规则，配置成功。Domain2下进行场景配置，引用Domain2下的规则，配置成功。0域下进行场景配置，引用0域下的规则，配置成功。Domain2下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。0域下进行场景配置，引用Domain1下的规则，配置失败，网管能给出正确提示。
测试条目|admin用户有所有域的操作权限
---|---
预置条件|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。|EMS环境正常。网元环境正常。已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。
测试步骤|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。|admin用户登录EM，选择当前NF，并选择Npcf_PolicyManagement服务。执行ADD DOMAIN命令配置Domain1、Domain2。执行ADD USERDOMAIN命令，进行用户归属域配置。配置策略基本数据、条件参数、动作参数。执行命令ENTER DOMAIN:DOMAINID=1，进入Domain1业务域。Domain1下进行规则配置，引用0域配置的条件参数、动作参数。Domain1下进行场景配置，引用Domain1下的规则。执行命令ENTER DOMAIN:DOMAINID=2，进入Domain2业务域。Domain2下进行规则配置，引用0域配置的条件参数、动作参数。Domain2下进行场景配置，引用Domain2下的规则。
通过准则|用户可以正确进入并配置对应域|用户可以正确进入并配置对应域|用户可以正确进入并配置对应域|用户可以正确进入并配置对应域
测试条目|归属域下没有规则，0域有规则
---|---
预置条件|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为IMSI，次选用户标识类型为MSISDN。应用标识配置应用标识1001、1002、1003对应签约业务标识1、2、3。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属1域IMSI号段 333333333333334 ~ 633333333333333，归属2域IMSI号段 733333333333334 ~ 833333333333333，归属0域切换到1域配置N7业务策略场景入口=业务套餐1，appid=1002，下发N7业务规则2切换到0域配置N7业务策略场景入口=业务套餐1，appid=1001，下发N7业务规则1|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为IMSI，次选用户标识类型为MSISDN。应用标识配置应用标识1001、1002、1003对应签约业务标识1、2、3。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属1域IMSI号段 333333333333334 ~ 633333333333333，归属2域IMSI号段 733333333333334 ~ 833333333333333，归属0域切换到1域配置N7业务策略场景入口=业务套餐1，appid=1002，下发N7业务规则2切换到0域配置N7业务策略场景入口=业务套餐1，appid=1001，下发N7业务规则1|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为IMSI，次选用户标识类型为MSISDN。应用标识配置应用标识1001、1002、1003对应签约业务标识1、2、3。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属1域IMSI号段 333333333333334 ~ 633333333333333，归属2域IMSI号段 733333333333334 ~ 833333333333333，归属0域切换到1域配置N7业务策略场景入口=业务套餐1，appid=1002，下发N7业务规则2切换到0域配置N7业务策略场景入口=业务套餐1，appid=1001，下发N7业务规则1|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为IMSI，次选用户标识类型为MSISDN。应用标识配置应用标识1001、1002、1003对应签约业务标识1、2、3。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属1域IMSI号段 333333333333334 ~ 633333333333333，归属2域IMSI号段 733333333333334 ~ 833333333333333，归属0域切换到1域配置N7业务策略场景入口=业务套餐1，appid=1002，下发N7业务规则2切换到0域配置N7业务策略场景入口=业务套餐1，appid=1001，下发N7业务规则1
测试步骤|建立N7会话，请求消息携带supi号433333333333332，从SPR返回签约信息包含套餐1，业务1、业务2、业务3。SMF触发N7会话释放。|建立N7会话，请求消息携带supi号433333333333332，从SPR返回签约信息包含套餐1，业务1、业务2、业务3。SMF触发N7会话释放。|建立N7会话，请求消息携带supi号433333333333332，从SPR返回签约信息包含套餐1，业务1、业务2、业务3。SMF触发N7会话释放。|建立N7会话，请求消息携带supi号433333333333332，从SPR返回签约信息包含套餐1，业务1、业务2、业务3。SMF触发N7会话释放。
通过准则|supi号433333333333332的用户建立会话，下发业务规则1。（号码归属的2域没有配置规则和场景，则匹配0域的规则和场景。）执行SHOW_GUI_DATA命令，查询策略数据，查询结果中规则、场景对应的域信息正确。|supi号433333333333332的用户建立会话，下发业务规则1。（号码归属的2域没有配置规则和场景，则匹配0域的规则和场景。）执行SHOW_GUI_DATA命令，查询策略数据，查询结果中规则、场景对应的域信息正确。|supi号433333333333332的用户建立会话，下发业务规则1。（号码归属的2域没有配置规则和场景，则匹配0域的规则和场景。）执行SHOW_GUI_DATA命令，查询策略数据，查询结果中规则、场景对应的域信息正确。|supi号433333333333332的用户建立会话，下发业务规则1。（号码归属的2域没有配置规则和场景，则匹配0域的规则和场景。）执行SHOW_GUI_DATA命令，查询策略数据，查询结果中规则、场景对应的域信息正确。
测试条目|用户归属域中用户类型为MSISDN
---|---
预置条件|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置MSISDN号段 000000000000000 ~ 333333333333333，归属1域MSISDN号段 333333333333334 ~ 633333333333333，归属2域切换到1域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置MSISDN号段 000000000000000 ~ 333333333333333，归属1域MSISDN号段 333333333333334 ~ 633333333333333，归属2域切换到1域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置MSISDN号段 000000000000000 ~ 333333333333333，归属1域MSISDN号段 333333333333334 ~ 633333333333333，归属2域切换到1域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置MSISDN号段 000000000000000 ~ 333333333333333，归属1域MSISDN号段 333333333333334 ~ 633333333333333，归属2域切换到1域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。
测试步骤|建立N7会话，请求消息携带gpsi号233333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号533333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号933333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号233333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号533333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号933333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号233333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号533333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号933333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号233333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号533333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。建立N7会话，请求消息携带gpsi号933333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。
通过准则|gpsi号233333333333332的用户建立会话，下发N7会话规则1，PNR更新签约后，下发N7会话规则2。gpsi号533333333333332的用户建立会话，下发N7会话规则3，PNR更新签约后，下发N7会话规则4。gpsi号933333333333332的用户建立会话，由于0域没有规则，不下发规则，PNR更新签约后，由于0域没有规则，不下发规则。|gpsi号233333333333332的用户建立会话，下发N7会话规则1，PNR更新签约后，下发N7会话规则2。gpsi号533333333333332的用户建立会话，下发N7会话规则3，PNR更新签约后，下发N7会话规则4。gpsi号933333333333332的用户建立会话，由于0域没有规则，不下发规则，PNR更新签约后，由于0域没有规则，不下发规则。|gpsi号233333333333332的用户建立会话，下发N7会话规则1，PNR更新签约后，下发N7会话规则2。gpsi号533333333333332的用户建立会话，下发N7会话规则3，PNR更新签约后，下发N7会话规则4。gpsi号933333333333332的用户建立会话，由于0域没有规则，不下发规则，PNR更新签约后，由于0域没有规则，不下发规则。|gpsi号233333333333332的用户建立会话，下发N7会话规则1，PNR更新签约后，下发N7会话规则2。gpsi号533333333333332的用户建立会话，下发N7会话规则3，PNR更新签约后，下发N7会话规则4。gpsi号933333333333332的用户建立会话，由于0域没有规则，不下发规则，PNR更新签约后，由于0域没有规则，不下发规则。
测试条目|用户归属域中用户类型同时有MSISDN、IMSI，首选用户标识为MSISDN
---|---
预置条件|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属2域。切换到0域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属2域。切换到0域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属2域。切换到0域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。|已加载打开LIC_RCP_FUNC_MULTIDOMAIN项开关的License。用户标识类型优先级配置首选用户标识类型为MSISDN，次选用户标识类型为IMSI。用户归属域配置IMSI号段 000000000000000 ~ 333333333333333，归属2域。切换到0域配置N7会话策略场景入口为空，usertype=1，下发N7会话规则1，usertype=2，下发N7会话规则2。切换到2域配置N7会话策略场景入口为空，usertype=2，下发N7会话规则3，usertype=2，下发N7会话规则4。
测试步骤|建立N7会话，请求消息携带gpsi号833333333333332、supi号243333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号833333333333332、supi号243333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号833333333333332、supi号243333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。|建立N7会话，请求消息携带gpsi号833333333333332、supi号243333333333332，从SPR返回签约信息包含用户类型为1。PNR更新签约，用户类型变更为2。SMF触发N7会话释放。
通过准则|gpsi号833333333333332的用户建立会话，下发N7会话规则1。（首选用户标识在用户归属域中无配置，匹配0域规则。）PNR更新签约后，下发N7会话规则2。|gpsi号833333333333332的用户建立会话，下发N7会话规则1。（首选用户标识在用户归属域中无配置，匹配0域规则。）PNR更新签约后，下发N7会话规则2。|gpsi号833333333333332的用户建立会话，下发N7会话规则1。（首选用户标识在用户归属域中无配置，匹配0域规则。）PNR更新签约后，下发N7会话规则2。|gpsi号833333333333332的用户建立会话，下发N7会话规则1。（首选用户标识在用户归属域中无配置，匹配0域规则。）PNR更新签约后，下发N7会话规则2。
## License描述 
### License概念 
#### License概念 
License是供应商将所销售产品的使用范围、功能、期限等授权给客户的一种合约形式。客户通过License可以获得供应商所承诺的相应服务，包括产品的功能和资源。 
#### 客户收益 
收益者|收益描述
---|---
运营商|通过购买License获取新的功能，无需更换硬件，节约成本。通过购买License扩大容量，无需更换硬件，节约成本。通过查询命令直接获取License使用情况，简化运维。
#### 系统影响 
License不开启的功能，相应功能不能使用。 
超过License设置容纳的最大接入用户量时，系统会拒绝用户接入。 
若加载序列号不匹配的License，系统会在运行过程中发现并上报序列号不匹配告警。 
#### 应用限制 
License文件不可篡改，经人篡改则在系统上不能激活。 
License可以限制系统功能，如果License失效，与License控制功能相关的一些系统配置命令会失效，系统会按照当前的配置继续运行，确保系统不瘫局。但由于功能不能修改、该设备处于不可维护状态。 
License可以限制系统容量，接入量达到License的最大限制值之后，系统会拒绝用户接入，此时需要联系中兴通讯技术支持更换License，对系统进行扩容。 
### License控制项 
#### License控制项分类 
License资源控制项License资源控制项即为License文件中授权方式为数量形式的控制项。ZXUN RCP通过License可以限制系统的容量，如在线用户数等。通常硬件成本为一次支付，后期需要增加功能时，只需要支付License的费用，而不必再重新购买新的硬件。在ZXUN RCP的CPU资源充足的情况下，可通过扩大License来满足运营商的扩容需求。 
License功能控制项License功能控制项即为License文件中授权方式为开关形式的控制项。可以通过License设置为启用或不启用。 
#### License控制项 
ZXUN RCP的License控制项参见[表1](#License%E6%8E%A7%E5%88%B6%E6%9C%BA%E5%88%B6-F9257C5B__License%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6%E9%A1%B9-1B471901)。
控制项类别|控制项名称|说明|默认值
---|---|---|---
License资源控制项|在线用户数|在PCF网元中，已上线成功的N7接口和Gx接口用户数总和。|1000
在线会话数|License资源控制项|在PCF网元中，已上线成功的N7接口和Gx接口会话数总和。|1000
在线IMS会话数|License资源控制项|在PCF网元中，已上线成功的N7接口和Gx接口IMS会话数总和。|1000
在线DATA会话数|License资源控制项|在PCF网元中，已上线成功的N7接口和Gx接口数据会话数总和。|1000
规则容量|License资源控制项|在PCF网元中，允许配置的规则最大数量。|100
套餐容量|License资源控制项|在PCF网元中，允许配置的套餐最大数量。|10
容量突破时间（天/年）|License资源控制项|系统容量超过License授权容量时，允许一年内用户数超出License的天数。|30
容量突破比例（10%）|License资源控制项|系统容量超过License授权容量时，允许用户数超出License的比例。0：不控制比例。1~10：10%~100%。|5
超期递减比例（%）|License资源控制项|License超期后，业务数值型授权项的数值每月递减的比例，下一自然月开始生效。0：超期不递减。1~10：1%~10%，业务数值型授权项超期按比例月递减。|0
License功能控制项|短信通知|PCF支持短信通知功能。|OFF
Email通知|License功能控制项|PCF支持邮件通知功能。|OFF
Rx接口|License功能控制项|PCF支持Rx/N5接口。|OFF
Sy接口|License功能控制项|PCF支持Sy/N28接口。|OFF
策略日志|License功能控制项|PCF支持记录策略日志功能。|OFF
基本批价功能|License功能控制项|PCF支持基本批价功能，能根据用户的用量信息简单计算金额。|OFF
支持GDPR功能|License功能控制项|PCF支持通用数据保护功能。|OFF
分权分域|License功能控制项|PCF支持分权分域功能，能根据不同的域进行不同的策略控制。|OFF
支持容量突破|License功能控制项|系统容量超过License授权容量时，允许用户数超出一定数量或者一定天数。容量突破时间（天/年）和容量突破比例（10%）由单独的License项控制。|OFF
### License相关信息 
#### 命令 
与License相关的命令参见[表1](#zd1c79fe4fbba4c6a9300b4c12c17592f__865ea79e-eaa3-4389-bfb0-6718faba7c7a)。
命令|功能
---|---
IMP LICFILE|导入License文件。
EXP LICFILE|导出License文件。
SHOW LICFILE|查询指定导入的License文件详细信息。
DEL LICFILE|删除未激活的License文件。
SHOW LICFILE LIST|列表显示当前已导入的所有License文件。
LOAD LICENSE|加载指定的License文件。
ROLLBACK LICENSE|回滚到上次加载激活的License文件。
SHOW LICENSE|查询当前系统中是否加载License、如果已经加载License文件，则显示当前License的基本信息和授权项信息。
SHOW NFSN|查询网元序列号，用于申请制作License。
SET LICPOLICY|设置License的即将过期通知提前天数。
SHOW LICPOLICY|查询License的即将过期通知提前天数。
SHOW LIC BREAKTHR|查询License突破状态。
ACTIVATE LIC GRACE|激活License宽限。
SHOW LIC GRACE|查询License宽限。
#### 告警与通知 
与License相关的告警和通知参见[表2](#zd1c79fe4fbba4c6a9300b4c12c17592f__ccf9ffeb-404f-4dc7-914a-4fb4604100d4)。
告警与通知|告警级别
---|---
2988048651 License在线用户数一级负荷|严重
2989097227 License在线用户数二级负荷|主要
2990145803 License在线用户数三级负荷|次要
2988048660 License在线IMS会话数一级负荷|严重
2989097236 License在线IMS会话数二级负荷|主要
2990145812 License在线IMS会话数三级负荷|次要
2988048661 License在线DATA会话数一级负荷|严重
2989097237 License在线DATA会话数二级负荷|主要
2990145813 License在线DATA会话数三级负荷|次要
2988048662 License在线会话数一级负荷|严重
2989097238 License在线会话数二级负荷|主要
2990145814 License在线会话数三级负荷|次要
#### 性能指标与性能计数器 
与License相关的性能指标与性能计数器参见[表3](#zd1c79fe4fbba4c6a9300b4c12c17592f__0462dbff-58eb-4826-a5fc-a8d619b3ff4f)和[表4](#zd1c79fe4fbba4c6a9300b4c12c17592f__3a352f61-c08e-4f11-a7d4-1b466e516c1a)。
性能指标|说明
---|---
（000209040）License套餐配置容量占用率峰值（%）|统计配置的套餐数占License中“套餐容量”比例的峰值。
（000209041）License规则配置容量占用率峰值（%）|统计配置的规则数占License中“规则容量”比例的峰值。
（000209042）License在线IMS会话容量占用率峰值（%）|统计在线IMS会话数占License中“在线IMS会话数”比例的峰值。
（000209043）License在线DATA会话容量占用率峰值（%）|统计在线DATA会话数占License中“在线DATA会话数”比例的峰值。
（000209044）License用户容量占用率峰值（%）|统计激活的用户容量占License中“在线用户数”比例的峰值。
（000209045）License会话容量占用率峰值（%）|统计激活的会话容量占License中“在线会话数”比例的峰值。
性能计数器|说明
---|---
C000200088 License套餐配置容量|统计在每个测量周期内，RCP系统当前License中的套餐配置容量。
C000200092 License规则配置容量|统计在每个测量周期内，RCP系统当前License中的规则配置容量。
C000200093 License在线用户容量|统计在每个测量周期内，RCP系统当前License中的在线用户容量。
C000200094 License在线IMS会话容量|统计在每个测量周期内，RCP系统当前License中的在线IMS会话容量。
C000200095 License在线DATA会话容量|统计在每个测量周期内，RCP系统当前License中的在线DATA会话容量。
C000200096 License在线会话容量|统计在每个测量周期内，RCP系统当前License中的在线会话容量。
