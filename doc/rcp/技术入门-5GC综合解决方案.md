# 5GC安全解决方案 
## 需求与挑战 
### 5G网络架构 
为了满足增强移动宽带、高可靠低时延以及低功耗大连接等三大应用场景的需要，5G网络采用了全新的系统架构。为提高系统的灵活性和效率，并降低成本，5G网络架构将引入新的IT技术，如虚拟化和SDN/NFV。同时，5G将网络划分为接入平面、转发平面和控制平面。
在接入平面引入多站点协作、多连接机制和多制式融合技术，构建更灵活的接入网络拓扑。 
控制平面基于可重构的集中的网络控制功能，提供按需的接入、移动性和会话管理，支持精细化资源管控和全面能力开放。 
转发平面具备分布式的数据转发和处理功能，提供更动态的锚点设置以及更丰富的业务链处理能力。 
支持多种接入技术的5G网络架构图如[图1](d0e145.html#d0e145__G%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84%E5%9B%BE-48641C7E)所示。
图1  5G网络架构图
[???]images/image5-1.png)
各部分描述参见[表1](d0e145.html#d0e145__913a335b-f3a4-4e81-adf9-3a42d3bbe3f3)。
架构组件|名称|描述
---|---|---
物理基础设施|物理基础设施|物理基础设施
Storage|存储资源|使用高性价比的COTS服务器、磁阵和网络设备，通过虚拟化技术，将这些硬件资源转化为虚拟化的资源池，供上层APP使用。在降低成本的同时提升了硬件的使用效率。
Computing|计算资源|使用高性价比的COTS服务器、磁阵和网络设备，通过虚拟化技术，将这些硬件资源转化为虚拟化的资源池，供上层APP使用。在降低成本的同时提升了硬件的使用效率。
Networking|网络资源|使用高性价比的COTS服务器、磁阵和网络设备，通过虚拟化技术，将这些硬件资源转化为虚拟化的资源池，供上层APP使用。在降低成本的同时提升了硬件的使用效率。
虚拟化基础设施|虚拟化基础设施|虚拟化基础设施
SDN|软件定义网络|通过SDN技术，可以将网络设备的控制面和数据面分离，从而实现对网络流量的灵活控制，使网络更加智能，实现业务的自动化部署。
NFV|网络功能虚拟化|通过网络功能虚拟化技术，将通信设备的软硬件解耦，使网络设备功能不再依赖于专有硬件，使硬件资源得到充分的利用，并实现新业务的快速开发和部署。
OSS/BSS|运营支撑系统/业务支撑系统|OSS/BSS是运营商的一体化、信息资源共享的支撑系统，主要包含网络管理、系统管理、计费、营业、账务和客户服务等功能。
MANO|管理与编排功能|MANO负责对NFVI和VNF进行管理和编排，包含VIM（Virtualized Infrastructure Manager）、VNFM（VNF Manager）、NFVO（Orchestrator）三个模块，分别完成对NFVI、VNF、NS三个层次的管理。
网络功能|网络功能|网络功能
5G Core|5G核心网|5G网络的核心网部分，基于3GPP SBA标准构建，包含融合的控制面、转发面和用户数据，支持统一资源管理、统一认证授权、统一用户体验和统一运营维护，为运营商提供高效、开放和智能的新一代网络。
MEC|多接入边缘计算平台|边缘计算可以将无线网络和互联网有效融合在一起，在无线网络边缘提供云计算能力和无线网络能力。应用服务和内容部署在本地边缘，可以减少数据传输环节，提高数据安全性，降低端到端时延，减少带宽占用，并降低功耗。
5G RAN|5G无线接入网|5G网络的无线接入网部分，通常包括CU和DU两个功能实体。通过CU，可以统筹管理全局资源，并可以实现CU的虚拟化，降低网络硬件部署成本。CU还可以与MEC共同部署，实现业务快速创新和快速上线。
无线接入技术相关|无线接入技术相关|无线接入技术相关
3GPP RAT|3GPP接入技术|指由3GPP组织所提出的接入网技术，如WCDMA、TD-SCDMA等。
Non 3GPP RAT|非3GPP接入技术|指由其它组织所提出的接入网技术，如CDMA、WiFi等。
UE|终端功能|能够与网络基站通信的用户终端设备，包括手机、智能终端、多媒体设备等。
租户功能|租户功能|租户功能
Network Slice|网络切片|一种按需组网的方式，可以让运营商在统一的基础设施上分离出多个虚拟的端到端网络。在一个网络切片中，通常可以分为无线网子切片、承载网子切片和核心网子切片三部分。
### 5G安全需求分析 
#### 5G新技术、新特性带来的安全风险与挑战 
为提高系统的灵活性和效率，5G网络引入新的技术，如SDN和NFV、网络切片、边缘计算等。新技术、新特性的引入，也为5G网络安全带来了新的挑战。具体如下： 
软件定义网络和网络功能虚拟化软件定义网络（SDN）和网络功能虚拟化（NFV）技术将使传统网络体系结构发生重大转变。由于网络功能无需建立在专用的硬件和软件上，功能差异将主要体现在软件中。从安全的角度来看，漏洞的更新和修补将变得简便。但软件依赖度的提高以及频繁更新的需求将大大提升第三方供应商和补丁管理程序的地位。软件定义网络和网络功能虚拟化给网络安全带来了突出挑战，具体表现在以下几个方面：虚拟化服务化架构模糊了传统网络边界，给虚拟化软件及虚拟机间的通信安全带来风险。集中的控制点容易成为网络攻击的“重灾区”。分层解耦、多厂商集成导致快速定位和溯源安全问题困难。开源软件的脆弱性及安全漏洞，给自动化安全评估和修复带来挑战，同时新型网络架构对安全运维人员的经验、技能提出了新的挑战。 
边缘计算边缘计算节点可根据应用服务的需求部署于移动网络的边缘，提供超低时延的同时也能够降低高带宽业务的数据流对核心网的压力。但是，边缘计算带来便利的同时也带来了安全风险和挑战：移动边缘计算（MEC）基础设施通常部署在网络边缘，客观缩短了攻击者与MEC物理设施之间的距离，使得攻击者更容易接触到MEC网络基础设施，被攻击后可能会造成物理设备毁坏、服务中断、用户隐私和数据泄露等严重后果。由于性能、成本、部署灵活性要求等多种因素制约，MEC节点的安全能力不够完善，可抵御的攻击种类和抵御单个攻击的强度不够，容易被攻击，使5G网络面临风险。MEC服务不仅可由网络运营商提供，也可由第三方服务商提供。当MEC服务如果没有调用认证与鉴权接口，则面临恶意第三方接入网络提供非法服务的风险。 
网络切片5G网络切片为不同业务提供差异化安全服务的同时，也面临一定的安全风险：不同的网络切片承载不同的5G业务，但网络切片共享网络基础设施，这就对切片的安全隔离能力带来挑战。若网络切片的认证和授权能力不足，则可能造成敏感信息或隐私信息的泄漏，并且被攻击者利用。另外，在5G新业务场景下，运营商可能会以网络切片的模式向第三方企业、用户提供网络服务，对于此种服务中涉及的运营商、虚拟运营商、用户等不同层和不同域的安全责任主体划分问题面临挑战。 
网络能力开放5G网络基于网络能力开放技术，与垂直行业深度融合，使得垂直行业可以充分利用网络能力的同时灵活开发新业务，但也带来新的风险和挑战：5G网络能力开放架构可能会面临网络能力的非授权访问和使用、数据泄露、用户和网络敏感信息泄露等安全风险，同时攻击者还可以利用5G网络能力开放架构提供的应用程序编程接口（API）对网络进行拒绝服务攻击。随着跨行业应用的开展，需要开放共享相应的用户个人信息、网络数据和业务数据，这些信息和数据从运营商内部的封闭平台开放共享到垂直行业企业的开放平台上，运营商对数据的控制力减弱，数据泄露的风险增大。另外，跨行业数据共享过程中一旦发生用户数据泄露等安全事件，将面临主体间的责任划分不清的风险。 
海量多样化终端5G支持多种接入技术，终端类型复杂多样，终端的安全能力差异巨大，终端设备分散不便统一管理，应用需求复杂难以部署强有力安全防护。因此，5G时代海量多样化终端会给5G网络带来安全风险。巨量化、泛在化的智能终端易被利用成为新攻击源。在mMTC场景下，未来将有数以百亿计的终端接入物联网，一旦这些终端被入侵利用，形成规模化的设备僵尸网络，将成为新型高容量分布式拒绝服务（DDoS）攻击源，进而对用户应用、后台系统等发起攻击。物联网终端提供的数据信息量巨大，分类众多，应用场景多元化，但缺乏统一的安全标识和认证管理机制，这也增加了网络管理的难度。另外，终端上日趋开放的用户应用生态环境将加大安全管理挑战。在5G的泛在连接场景下，生产类、生活类应用可能同时安装在一台用户终端上，开放的应用生态环境在带来生产和生活便利的同时，也加剧了恶意应用威胁其他应用安全、终端安全以及后台生产系统安全的风险。 
#### 5G不同业务场景引发差异化安全需求 
5G网络不仅用于人与人之间的通信，还会用于人与物以及物与物之间的通信。目前，5G业务大致可以分为3种场景：eMBB（增强移动宽带）、mMTC（海量机器类通信）和URLLC（超可靠低时延通信），5G网络需要针对这三种业务场景的不同安全需求提供差异化安全保护机制。
eMBB聚焦对带宽有极高需求的业务，例如高清视频，VR（虚拟现实）/AR（增强现实）等，满足人们对于数字化生活的需求。eMBB广泛的应用场景将带来不同的安全需求，同一个应用场景中的不同业务其安全需求也有不同。例如，VR/AR等个人业务可能只要求对关键信息的传输进行加密，而对于行业应用可能要求对所有环境信息的传输进行加密。5G网络可以通过扩展LTE安全机制来满足eMBB场景所需的安全需求。 
mMTC覆盖对于连接密度要求较高的场景，例如智慧城市，智能农业等，能满足人们对于数字化社会的需求。mMTC场景中存在多种多样的物联网设备，如处于恶劣环境之中的物联网设备，以及技术能力低且电池寿命长（如超过10年）的物联网设备等。面向物联网繁杂的应用种类和成百上千亿的连接，5G网络需要考虑其安全需求的多样性。如果采用单用户认证方案则成本高昂，而且容易造成信令风暴问题，因此在5G网络中，需降低物联网设备在认证和身份管理方面的成本，支撑物联网设备的低成本和高效率海量部署（如采用群组认证等）。针对计算能力低且电池寿命需求高的物联网设备，5G网络应该通过一些安全保护措施（如轻量级的安全算法、简单高效的安全协议等）来保证能源高效性。 
URLLC聚焦对时延极其敏感的业务，例如自动驾驶/辅助驾驶、远程控制等，满足人们对于数字化工业的需求。低时延和高可靠性是URLLC业务的基本要求，如车联网业务在通信中如果受到安全威胁则可能会涉及到生命安全，因此要求高级别的安全保护措施且不能额外增加通信时延。5G超低时延的实现需要在端到端传输的各个环节进行一系列机制优化。从安全角度来看，降低时延需要优化业务接入过程中身份认证的时延、数据传输安全保护带来的时延，终端移动过程由于安全上下文切换带来的时延、以及数据在网络节点中加解密处理带来的时延。 
因此，面对多种应用场景和业务需求，5G网络需要一个统一的、灵活的、可伸缩的安全架构来满足不同应用的不同安全级别的安全需求，即5G网络需要一个统一的认证框架，用以支持多种应用场景的网络接入认证（即支持终端设备的认证、支持签约用户的认证、支持多种接入方式的认证、支持多种认证机制等）；同时5G网络应支持伸缩性需求，如网络横向扩展时需要及时启动安全功能实例来满足增加的安全需求、网络收敛时需要及时终止部分安全功能实例来达到节能的目的。 
另外，5G网络应支持按需的用户面数据保护，如根据三大业务类型的不同，或根据具体业务的安全需求，部署相应的安全保护机制。此类安全机制的选择，包括加密终结点的不同，或者加密算法的不同，或者密钥长度的不同等。 
## 5G安全架构 
### 设计原则 
5G网络安全架构设计需要遵循以下的原则： 
在5G网络架构之上叠加逻辑安全架构。5G安全架构应以5G通信网为基础，针对5G整体特征进行安全防护设计。5G安全功能相对解耦于其他网络特征或功能，在不影响5G整体的情况下具有一定的自我更新和扩展能力。 
分域、分面设计安全架构。遵循通信网分域、分面的协议设计原则，将安全特征嵌套其中，这样可以高效调用安全功能；这些安全功能在运营商网络中可以进行单独部署、配置或定制。同时从安全视角考虑风险级别，在设计上应进行安全边界防护设计，并将防护措施部署在靠近潜在攻击点的位置，提高反应速度、缩小影响范围。 
深刻剖析整网潜在攻击点，实现分布式安全策略。基于对电信网络的多年丰富经验和对电信行业协议的理解，中兴通讯从端到端视角分析整个5G网络中的潜在攻击点，采用分布式安全理念，层层纵深防护，避免了单一安全边界设计带来的风险点。 
深度结合5G业务，实现E2E保障。安全架构深度结合网络切片、服务化架构等5G新特性，切实保障5G应用的安全实现；安全架构包含无线、MEC、核心网、承载网、外部网络等多个方面，涉及用户媒体平面、业务控制平面和管理平面等多个维度，实现纵向和横向的综合防护。 
秉承业界先进理念，实现立体式安全防御。单纯的围墙式边界安全建设已经无法满足5G的复杂安全态势要求。宏观上：安全策略和防护必须涵盖边缘DC、区域DC和中心DC。微观上：安全策略必须贯穿5G网元形态，包含虚拟化、微服务化组件的安全交互。 
基于5G服务化架构，实现安全能力按需弹性扩展。基于5G服务化架构，安全作为5G中的逻辑能力，同样需要提供可以被调用的接口，并可以面向垂直行业提供安全能力的开放。安全能力以组件形式存在，根据不同的业务场景和用户对安全的期望，深度结合虚拟化和服务化，实现安全能力的动态部署和自动弹缩、自主编排等特性。 
### 5G网络安全架构 
参考5G PPP项目的5G-ENSURE成果以及X.805等规范，对5G网络进行分域分层的安全设计，5G网络安全的总体架构如[图1](d0e490.html#d0e490__G%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84-4864AF1B)所示。
图1  5G网络安全架构
[安全总体架构]images/image6.png)
5G网络安全架构通过域的概念展开，按照5G的网络架构、网络功能及部署方式，将网络划分为RAN、MEC、传输、5GC、切片等安全域，其中切片是跨多个域的复合域，在每个安全域下可以根据网元功能特性和安全级别，继续细分安全子域。
依据ISO 27001、ISO 17799中的技术及管理要求，在5G网络系统中，还应部署集中的安全管控区域，这个区域主要是对5G网络及IDC机房设备的安全管理，包含安全事件的采集与分析、运维审计、安全漏洞管理、配置基线核查等功能。
每个域按照分层的安全设计，包含基础设施层的安全、服务层的安全，以及管理层的安全设计。 
## 5GC安全 
### 5GC系统架构 


5GC的服务化架构如[图1](d0e521.html#d0e521__GC%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84-486500D0)所示。


图1  5GC系统架构


[???]images/image7.png)



各网元的功能描述参见[表1](d0e521.html#d0e521__GC%E5%90%84%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-4864E573)。


对外服务接口|网络功能|中文全称|功能描述
---|---|---|---
Namf|AMF|接入和移动管理功能|完成移动性管理、NAS MM信令处理、NAS SM信令路由、安全锚点和安全上下文管理等。
Nsmf|SMF|会话管理功能|完成会话管理、UE IP地址分配和管理、UP选择和控制等。
Nudm|UDM|统一数据管理|管理和存储签约数据、鉴权数据。
N3/4/6|UPF|用户平面功能|完成不同的用户面处理。
Npcf|PCF|策略控制功能|支持统一策略框架，提供策略规则。
Nnrf|NRF|网络功能仓储|维护已部署NF的信息，处理从其他NF过来的NF发现请求。
Nnef|NEF|网络开放功能|使内部或外部应用可以访问网络提供的信息或业务，为不同的使用场景定制化网络能力。
Naf|AF|应用功能|第三方或运营商的应用功能。
Nausf|AUSF|鉴权服务器功能|完成用户接入的身份认证功能。


### 5GC威胁分析 
5GC基于云化架构，通过引入虚拟化技术实现了软件与硬件的解耦，通过NFV技术的部署，使得网元以虚拟功能网元的形式部署在云化的基础设施上，不再使用专有通信硬件平台，传统的安全边界变得模糊，原先认为安全的物理环境已经变得不安全。另外，5G网络中通过引入SDN技术提高了网络的数据传输效率，实现了更好的资源配置，但同时也带来了新的安全问题。 
5G网络不仅用于人与人之间的通信，还会用于人与物以及物与物之间的通信。目前，5G业务大致可以分为3种场景：eMBB（增强移动宽带）、mMTC（海量机器类通信）和URLLC（超可靠低时延通信），不同的场景其安全需求也不一样，同一场景下的不同应用其安全需求也是不一样的，要结合业务的需求来考虑。
为了更好地支持各种差异化的业务场景，5GC采用网络切片，为不同业务提供差异化的服务，这也对安全提出了新的挑战。同时，5G网络提供能力开放，也增加了5G网络新的攻击点。 
与此同时，传统的安全风险也没有消失，新旧安全风险与挑战交叠，是5G面临的新的安全形势，下面分别从基础设施层、网元功能层以及管理和编排层对5GC的安全威胁进行分析： 
基础设施层安全威胁基础设施层的安全威胁包含传统的安全威胁和虚拟化安全威胁两方面，传统的安全威胁包含对物理设施的破坏和盗窃、物理环境的非法访问、自然灾害的影响、黑客或犯罪组织对网络边界的各种攻击等。虚拟化的安全威胁包含针对开源软件/OS/云平台的漏洞攻击、病毒木马攻击、虚拟资源的滥用、云平台内部的横向攻击、虚机及镜像破坏等。 
网元功能层安全威胁网元功能层的安全威胁包含非法用户接入网络、对身份认证接口发起DDoS攻击、对网元间接口的非法访问、对网元间通信数据的监听和篡改、针对漫游用户的流量欺诈、网元版本和配置数据的恶意篡改等攻击。 
管理和编排层的安全威胁针对管理平面的安全威胁包含非法用户访问、内部人员的恶意操作、权限滥用攻击、个人数据隐私暴露、API的非法访问、远程访问信息被窃听、针对MANO实体的南北向接口攻击等。 
### 5GC安全架构 
参照3GPP TS.33501等5G安全规范，中兴通讯提出的5GC安全架构如[图1](d0e741.html#d0e741__d57a2473-3007-466c-bd18-ce1bea351661)所示。
图1  5GC安全架构
[???]images/image8.png)
5GC安全架构分为以下几个方面： 
接入安全：关注接入时的认证、用户数据的加密和完整性保护、访问控制，以及反欺诈防护等。 
网络安全：关注核心网内部的安全域划分以及网络平面隔离。 
管理安全：关注用户管理、日志管理等内容。 
能力开放安全：针对5G网络开放特性，关注能力调用和开放接口的安全防护。 
数据安全：实现端到端的个人隐私和关键数据的泄露风险防护。 
### 5GC安全方案 
#### 接入安全 
#### 接入安全 
在接入方面，5GC主要提供如下几个方面的安全策略。 
##### 接入防护 
5GC系统的接入安全防护如[图1](d0e771.html#d0e776__7f0089d6-4e41-404e-a66d-6e3f885fee97)所示。
图1  接入安全
[???]images/image9.png)
在5GC系统中，可以采取以下接入手段来实现用户接入和业务接入时的安全防护： 
接入认证：保证用户合法接入；采用双向认证来保证用户和网络之间的相互可信。基于统一的5G认证框架，可以实现以下必要的安全接入特性。 
双向认证：基于统一认证架构提供用户和网络之间的双向认证。 
Non-3GPP访问：Non-3GPP使用和3GPP相同的认证方式，统一接入流程。 
多种认证方法：支持EPS-AKA、5G-AKA、EAP-AKA’等多种不同的认证方法。 
NAS/AS层防护：信令面保护提供空口AS和NAS层信令的加密和完整性保护；用户面按需提供空口和/或UE到核心网之间的用户面加密和完整性保护。 
标准密钥派生方法：基于3GPP安全规范，实现标准化的层次化密钥生成与派生机制。 
访问控制：防止接入用户的非授权访问网络切片。 
数据加密：空口、UE和核心网之间数据加密，防止被嗅探窃取。支持主流的加密算法，例如AES、Snow 3G、ZUC等。
完整性保护：空口、UE和核心网之间数据完整性校验，防止数据被篡改。支持主流的完整性保护算法，例如AES、Snow 3G、ZUC等。 
UE应用防护：UE可以按需建立IPSec/SSL VPN等安全隧道，保证数据传输安全。 
##### 反欺诈防护 
5G鉴权过程增强了归属网的控制，防止拜访网中可能存在的欺诈： 
EAP-AKA'是由归属网AUSF进行鉴权结果比对。 
5G-AKA通过鉴权确认过程来实现归属网的二次验证。 
除了鉴权机制，还可以关联authentication与后续registration过程实现进一步的防欺诈防护： 
鉴权完成后，AUSF可以向UDM上报最近鉴权时间、鉴权结果；UDM接收到后续注册请求后，检查是否有最近一段时间内的鉴权过程，如果没有，拒绝注册并指示立即进行一次鉴权。 
运营商可以选择每次收到注册请求时要求立即进行一次鉴权，也可以检查设定时间内是否进行过鉴权，不满足则立即鉴权。 
#### 网络安全 
#### 网络安全 
 
##### 安全域划分 
根据运营需求和网元功能，将网元进行安全等级分类，为不同的安全等级设置不同的安全域，每个功能网元或管理网元仅能归属于其中的一个安全域。 
网络资源分配：为每个安全域分配专用的基础网络资源池，不同安全域不能共享资源池。 
域间和域内安全策略：跨域的数据传输必须受安全策略控制，例如在域间配置防火墙、VPN、IPS等安全资源；域内的数据传输，根据需要，可选配置安全控制，例如VNF之间配置防火墙，VNF之间增加相互认证机制等。 
安全域名称|包含网元
---|---
暴漏业务区|UPF、N3WIF-U、NEF
非暴漏业务区|AMF、SMF、AUSF、PCF、N3IWF-C、NRF、CAF、……
安全业务区|UDM、CMF
管理业务区|VNFM、Orchestrator、VIM、EMS
##### 网络平面划分 
每个NF根据流量的不同，将数据网络划分不同的网络平面，各网络平面间隔离，网络平面示意如[图1](d0e839.html#d0e906__VNF%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB-4865E966)所示。
图1  VNF网络隔离
[???]images/image10.png)
网络名称|网络用途|备注
---|---|---
EMS/VNFM|和EMS/MANO通信网络，接入网管网络。|-
Mgt|内部网络，用于内部虚机/容器管理。|-
Service|内部网络，业务处理通信网络平面。|-
External（SBI/RAN等）|外部网络，其中SBI和无线使用不同网络。|对外网络需要根据现网环境规划。
#### 管理安全 
#### 管理安全 
##### 用户/角色管理 
系统安装时自动生成一个超级用户，具有系统的最高权限。超级用户可以创建其它用户/角色，为其它用户/角色分配权限。其它用户也可以创建用户，为其它用户分配权限，但是被创建用户的权限不会超过创建者的权限。 
角色是一些操作权限的集合，一个角色可以分配给多个用户，系统会根据用户角色来对用户进行鉴权。角色也可以被锁定，角色被锁定后，具有该角色的用户失去该角色的权限。 
用户账号同时有如下管理规则： 
口令策略：支持弱口令检查，例如，最小长度、至少包括三种不同字符等。 
密码修改规则：首次登录时强制修改密码；密码有效期到达之前提醒修改密码；新密码不允许跟之前N次密码重复（N为可配参数）。 
帐号锁定规则：包括从不锁定、永久锁定、临时锁定、N次密码输入错误后锁定（N为可配参数）。 
帐号检查：帐号不能与N天前删除的帐号相同，在N天前通知帐号过期 
管理登录用户：查看登录用户信息，其中包括用户登录IP、登录时间及连接类型。 
被迫断开用户：当超级管理员发现某些用户试图进行非法操作时，会强行断开这些用户。 
会话保护：同一个账户同时登录的会话数可配。登录账户长时间不活动强制退出。 
##### 日志管理 
系统提供日志管理，供稽查使用。在日志内容上，有以下三类： 
操作日志：记录用户操作信息，包括用户名、操作级别、操作名称、命令功能、操作目标、NE群组、NE地址、开始时间、结果、失败原因、主机地址及接入模式。 
安全日志：记录用户登入登出信息，包括用户名、主机地址、日志名称、操作时间、接入模式以及详细信息。 
系统日志：记录服务器定时任务的完成状态，包括来源、级别、日志名称、详细信息、主机地址、开始时间、结束时间以及相关日志。 
操作员查询各种日志，并制定日志查询条件，其中包括用户名、时间范围、操作许可等。操作员可以根据字段将显示的日志记录进行升序或降序排列。 
操作员可以设置过滤条件（诸如，过滤级别），对低于过滤级别的日志进行过滤。 
系统支持导出并打印当前页的查询结果或日志数据到特定路径。在数据导出之后，系统仍保存日志记录。支持多种文档格式，例如，TXT、HTML、PDF、Excel等。 
系统提供日志备份策略、日志恢复入库策略。通过日志备份策略，可以定时或周期将日志导出为文件形式。通过日志恢复入库策略，可以把写入数据库失败的日志重新记录到数据库中。同时，日志信息可通过FTP、SFTP、Syslog等协议传送到外部服务器。
#### 能力开放安全 
#### 能力开放安全 
 
##### 安全的协议规范 
对外提供的开放接口，使用安全的协议规范。 
北向接口涉及到的接口和协议参见[表1](d0e1112.html#d0e1115__b7a5d649-2057-4f4c-bf75-05a690739a23)。
名称|接口|协议
---|---|---
FM NBI|SNMP V2c, V3|SNMP
PM NBI|(S)FTP|(S)FTP
CM NBI|(S)FTP|(S)FTP
南向接口涉及到的接口和协议参见[表2](d0e1112.html#d0e1115__745826e8-b72c-432a-ae36-c5c2b15706cd)。
名称|接口|协议
---|---|---
API of loading FM/PM models|REST/FTP|HTTP(S)/FTP
API of VNF access to EMS|REST|HTTP(S)
API of alarm restore/notification reportingto EMS|SNMP V2c, V3|SNMP
API of MML|REST|-
API of alarm synchronization|REST|HTTP(S)
API of creating/querying/deleting alarm maskingrules|REST|HTTP(S)
API of clearing alarm|REST|HTTP(S)
API of collecting PM data|(s)FTP|(S)FTP
API of creating/deleting/modifying PM tasks|REST|HTTP(S)
API of PM task synchronization|REST|HTTP(S)
API of Security|REST|HTTP(S)
API of Backup/Restore|REST|HTTP(S)
API of log|REST|HTTP(S)
API of signal trace|MML/FTP|MML/FTP
NF提供的服务化架构的API接口也是采用HTTPS方式。


##### 认证 




第三方设备通过API接入时，必须通过认证。 


认证方式有用户名+密码和Token认证等方式。 


Token认证参见“[服务化架构安全](Toc9200.html)”。




#### 数据安全 
#### 数据安全 
5G网络中用户隐私信息可以在多种网络、服务、应用及网络设备中存储使用，因此5G网络需要支持安全、灵活、按需的隐私保护机制。 
5G网络中的数据收集、传输、存储和应用的过程如[图1](d0e1049.html#d0e1049__53b9a697-3f0c-437d-9d2a-2608ab33b28c)所示。
图1  数据安全
[]images/1604970823346.png)
数据泄露可能发生在从终端到业务网络的任何一个环节： 
数据收集：造成信息泄露。 
数据传输：信令、数据在传输过程中可能会泄露。 
数据传输、处理、存储、维护：信令、媒体数据在虚拟网络中的处理、存储、维护可能造成信息泄露。 
数据共享和应用：攻击者利用公用网络攻击业务系统获取用户信息，业务系统滥用、泄露用户信息。 
##### 数据保护原则 
从终端、网络、业务提供商各个层面，对信息的请求、提交、传输、存储、处理、使用操作，采用相应的技术和管理手段实现对关键数据的保护： 
数据最小化：严格定义每个网元处理业务所必须的信息，按照定义对信息获取进行严格限制。 
用户许可：因业务需要获取最小化数据之外的信息（例如路测、体验改进），需告知数据用途、风险和获取用户许可。 
匿名化：关键隐私数据在网络传输中进行匿名；需要公开、二次利用（大数据分析）的数据要进行匿名替代。 
加密传输：加密传输，并进行完整性校验，防止窃听、篡改加密存储，对关键敏感数据进行加密存储。 
访问控制：严格定义数据访问权限，防止非法访问、越权访问。 
##### 5G网络中的数据安全防护实现 
参见“[个人数据保护设计](d0e4645.html)”。
#### 服务化架构安全 
##### 传输层的保护 
服务化接口传输层协议采用TCP，当需要启用传输层安全时，通过TLS进行传输层保护。TLS用于在两个通信应用程序之间提供保密性和数据完整性。
首先加载证书套件，包括证书、密钥、根证书等信息。然后在网元上分别指定对应的客户端、服务端使用的TLS证书。 
##### NF间的认证和授权 
在NF注册和发现流程中，NRF和NF间需要进行双向认证。
在NRF和NF认证成功后，NRF应判定NF是否被授权执行注册和发现流程。 
针对非漫游场景，NRF应基于可能访问的NF或者NF上的服务授权配置，以及NF服务访问者的类型进行授权判定。NRF应决定NF服务访问者是否被允许发现特定的NF实例。 
针对漫游场景，NF被访问方的NRF应基于可能访问的NF或者NF上的服务授权配置、NF服务访问者的类型，以及访问者的PLMN进行授权判定。 
##### PLMN内接入令牌验证的处理 
在非漫游场景下，即同一PLMN内时，5G核心网控制面中的各NF之间采用基于Token的授权机制，NF业务访问者在访问业务API之前需要进行认证。 
5G核心网控制面中的各NF，与Oauth2.0中定义的若干角色之间的对应关系如下： 
NRF应作为Oauth2.0中的授权服务器。 
NF业务访问者应为Oauth2.0中的客户端。 
NF业务提供者应为Oauth2.0中的资源服务器。 
NF业务访问授权主要包括如下几个步骤： 
NF业务访问者向NRF的注册授权：在NF业务注册流程中，NRF应对NF业务访问者进行授权。其中，NF业务访问者充当Oauth2.0客户端的角色，NRF充当Oauth2.0授权服务器的角色。 
业务请求前的接入Token请求：NF业务访问者向同一PLMN中的NRF请求接入Token。如果NRF通过了对NF业务访问者的授权判定（基于NF业务访问者在接入Token请求消息中携带的信息），NRF将生成包含特定权限的接入Token。NRF应根据共享密钥或私钥对生成的接入Token进行数字签名。NRF将接入Token放入响应消息内回送给NF业务访问者。 
基于Token校验的业务接入请求：NF业务访问者在执行业务请求Service request消息过程中，NF业务提供者可以请求NRF验证Token的合法性。NRF验证Token后告知NF业务提供者是否验证通过。如果所有验证都通过，NF业务提供者将处理业务请求消息并向NF业务访问者返回响应消息。如果验证不通过，则拒绝向业务访问者提供服务。 
##### PLMN间的授权访问验证的处理 
在漫游场景中，即不同PLMN之间的NF授权时，拜访地的vNRF和归属地的hNRF需要做双向认证。 
Oauth2.0中定义角色与5G核心网网络功能之间的对应关系如下： 
拜访地的vNRF应作为拜访地的Oauth2.0中的授权服务器，在拜访网络中对NF业务请求者进行认证。 
归属地的hNRF应作为归属地的Oauth2.0中的授权服务器，并产生接入Token。 
拜访地中的NF业务访问者被视为Oauth2.0中的客户端。 
归属地中的NF业务提供者应被为Oauth2.0中的资源服务器。 
在业务请求前的独立接入Token获取流程中，拜访地vNRF比较PLMN为非本网的PLMN，转发到归属地的hNRF，其他流程跟非漫游场景基本一致。 
同样的，在归属地的业务提供者对业务接入请求的Token校验时，如果Token中业务请求NF的PLMN未携带，或者业务提供NF的PLMN和配置的不一致，Token验证不通过，则拒绝向业务请求NF提供服务。 
## MEC安全 
### MEC网络架构 
多接入边缘计算MEC是5G网络中的关键技术之一，通过核心网用户面下沉到网络边缘及用户侧，实现灵活的业务本地分流，同时提供云计算的基础设施，将服务能力和应用推向了网络边缘，来满足5G网络中的高带宽、低时延的业务保障。 
图1  MEC网络架构
[???]images/image12.png)
### MEC威胁分析 
MEC将云数据中心的计算能力下沉到了网络边缘，一方面，MEC基础设施通常部署在无线基站等网络边缘，使其更容易暴露在不安全的环境中。另一方面，MEC将采用开放应用编程接口（API）、开放的网络功能虚拟化（NFV）等技术，开放性的引入容易将MEC暴露给外部攻击者。同云数据中心相比，由于边缘设施的资源和能力有限，难以提供与云数据中心一致的安全能力，MEC面临的攻击和威胁来自以下几个方面，如[图1](d0e1516.html#d0e1516__MEC%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81%E5%88%86%E6%9E%90-48BECB1E)所示。
图1  MEC安全威胁分析
[???]images/image13.png)
针对MEC的威胁具体说明如下： 
#### 基础设施安全威胁 
MEC基础设施通常部署在无线基站或者更加靠近用户的网络边缘，使其更容易暴露在不安全的环境中，易受到恶意用户的非法访问和攻击的威胁。 
物理基础设施的安全威胁分布式部署的MEC设备易受到来自攻击者近距离的物理攻击、破坏，如遭受拆除、盗窃、恶意的断电/重启，链路网口的断开等。MEC的网络端口（本地端口、调试口、USB口等）易受到非授权的访问，恶意的用户也会通过部署伪设备来对用户的流量进行非法监听和篡改。 
虚拟化基础设施的安全威胁MEC承载在虚拟化基础设施之上，因此，其面临着与云虚拟化基础设施相似的安全风险。攻击者利用Host
OS或虚拟化软件漏洞攻击Host OS或利用Guest OS漏洞攻击MEC平台或者其他ME APP，会直接影响MEC服务的可用性，也会造成NFV环境中的用户数据的泄露。虚拟化软件的镜像也会受到攻击者的篡改，被篡改的镜像可能携带木马、病毒，对MEC的系统软件带来病毒的风险。 
#### 数据面安全威胁 
MEC通过下沉核心网的数据面功能，完成业务的本地分流，下沉的数据面易受到攻击，攻击者可通过下沉到MEC的核心网网元攻击整个核心网网络；数据流量可能被非法窃听、欺骗性计费。 
数据面下沉后的接口易受到非授权的访问。 
数据面下沉到网络边缘后，攻击者可以近距离接触数据面网元，获取敏感数据或者篡改数据网管配置，进一步攻击核心网。 
数据面与MEC平台之间传输的数据被篡改、拦截和重放等攻击。 
#### MEC平台（MEP）安全威胁 
MEC平台（MEP）提供了移动边缘应用（ME APP）部署和运行涉及的环境和服务，包括边缘应用的注册、发现等，并为其提供边缘服务的环境，以及无线能力的开放，其面临的安全威胁如下： 
MEC平台与管理系统、核心网网元、第三方应用之间传输的数据存在被拦截、篡改等风险。 
MEC平台提供APP部署环境，攻击者可通过恶意APP对MEC平台发起非授权访问，导致敏感数据泄露或(D)DoS攻击等。 
MEC平台自身以VNF或者容器的方式部署，存在虚拟化方面的安全威胁。 
#### ME APP安全威胁 
边缘应用ME APP部署在MEC提供的虚拟化环境，并可从MEC平台获得能力，也可通过MEC平台对外提供服务，供其他用户使用，其存在的安全威胁如下： 
恶意第三方APP可以接入网络提供非法服务。 
攻击者可以非法访问ME APP，导致应用的敏感数据发生泄露。 
ME APP生命周期管理中，存在非法创建、删除、更新风险。 
ME APP存在恶意消耗MEC系统的资源，造成MEC系统其它服务不可用的风险。 
ME APP在遭受攻击后产生的过载流量会造成对MEC系统的(D)DoS攻击。 
#### MEC组网安全威胁 
考虑到MEC上的核心网数据面的下沉，带来了各网络平面接口的下移，传统的组网比较封闭，引入MEC后，MEC不仅在封闭组网引入了本地出口，同时面临边缘云网络的安全风险。对于第三方应用的部署，还存在第三方应用在组网上带来的外部攻击的安全威胁。 
MEC在封闭的运营商网络中引入了本地出口，带来网络边界的安全风险。 
运营商网络功能与非授信的第三方应用在边缘云上，进一步导致网络边界模糊，存在数据窃取与篡改、资源隔离等诸多安全威胁。 
#### 管理安全威胁 
MEC架构引入了新的管理系统和接口，可导致如下的安全风险： 
MEC与管理域的接口易受到非授权的访问，恶意的攻击还可能通过篡改管理消息，下发错误的应用规则。 
MEC的管理门户易受到无授权用户恶意的操作，非法访问和恶意利用MEC编排系统等，导致错误的配置。 
不完善的操作日志无法追溯MEC系统维护操作，MEC系统的安全事件也无法追溯。 
### MEC安全架构 
MEC环境集成了虚拟化网络安全的风险，同时也引入了设备物理、网络功能、MEC平台以及第三方APP的风险，特别是在MEC的总体架构中，为了实现各个层次的互操作性（CT能力及应用、IT应用、MEC平台、边缘应用），使得MEC面临更多的安全风险。针对MEC的安全风险，突出基于分层的MEC安全架构，从基础网络、基础设施、虚拟化层、MEC平台、UPF、MEC
APP生命周期、管理安全等多维度应对MEC面临的安全挑战。 
图1  MEC安全架构
[???]images/image14.png)
### MEC安全方案 
#### 物理安全设计 


针对基础设施的安全威胁，在物理基础设施安全方面，边缘计算部署的机房通过加锁、视频监控、人脸识别以及人员管理等保证物理环境安全，遵循通用安全中的物理环境安全设计要求。同时通过如下的安全措施保障服务器或主机的安全。 



 
服务器开启防盗防拆、恶意断电、设备重启及网络端口的告警。 

 
禁用硬件服务器的本地串口、本地调试口、USB接口等本地维护端口，防止恶意攻击者的接入和破坏。 

 
在条件允许的情况下，部署可信计算保证物理服务器的可信。 

 
服务器的I/O开启访问控制，并采用IEEE 802.1X协议，对连接的物理设备进行认证，防止不安全的、非法的或者伪装的网络设备接入到边缘计算网络中。 

 
按需配置链路层加密，如采用MACSEC的MKA协议进行密钥协商，对链路上的以太网帧进行加密处理，防止非法用户对物理端口及物理网络的侦听。 

 


在虚拟基础设施安全方面，通过对Host OS、虚拟化软件、Guest OS进行安全加固，防止镜像被篡改，同时加强虚拟机之间的隔离，对不安全的设备进行严格隔离，防止用户流量流入恶意虚拟机中。 


当部署容器时，通过对内核的加固，并开启用户命名空间映射，对容器使用root权限的限制，默认以非root权限运行容器，防止容器逃逸而获得宿主机的权限。同时考虑容器之间的隔离，以及容器占用系统资源的限制，防止消耗所有主机资源引起的拒绝服务攻击等。 


#### 组网安全设计 
与传统的组网安全原则相同，包含三平面的安全隔离、安全域的划分和安全隔离。具体包括实现管理、业务和存储三平面的流量安全隔离，保证通信安全。 
在网络部署时，将管理面、数据业务面和存储面进行物理隔离，并通过不同的物理交换机进行汇聚连接，通过划分不同的VLAN/VXLAN或部署防火墙等实现不同安全域之间的逻辑隔离，或者使用物理隔离方式实现不同安全级别的安全域之间的安全隔离，保证安全风险不在业务、数据和管理面之间、安全域之间扩散。同时对资源池进行安全域划分并执行不同安全等级的安全域之间的隔离以及边界防护。
图1  MEC安全域划分
[???]images/image15.png)
实际部署时，对于N6和N9口，无论部署在地市、区县，还是低于区县，数据面承载通过防火墙隔离和保护，以保护核心网网络安全。对于N4/N5内部信令业务，承载在内部IP专网，建议部署信令VPN，N3口业务启用IPSec进行保护。 
#### 数据面安全设计 
与核心网的其它网元相比，用户面UPF下沉到边缘后，部署在相对不安全的环境。并且，UPF连接核心网，一旦被攻击者控制，攻击者可进一步攻击核心网，影响整个核心网的安全。所以，UPF的安全非常重要。 
图1  数据面安全
[???]images/image17.png)
在传输链路没有物理保护的情况下，N3接口通过IPSec对传输的数据进行机密性和完整性保护。N4和N9接口支持对传输的信令进行机密性和完整性保护。 
数据面接口通过ACL策略过滤功能，对其信令流量进行限制，防止信令流过载。 
#### 平台安全设计 
MEC平台（MEP）提供了移动边缘应用（ME APP）部署和运行涉及的环境和服务，包括边缘应用发现、通告、消费和提供边缘服务的环境。
在传输链路没有物理保护的情况下，MEC平台与外部网元之间的接口启用安全隧道，对其传输的数据进行加密和完整性保护，通信双方进行双向验证。 
MEC平台对来自边缘APP的访问开启认证和授权，对数据进行机密性、完整性、防重放保护。 
MEC平台本身通过漏洞及端口扫描以确认是否关闭不必要的端口和服务。 
移动边缘应用（ME APP）以VNF的方式运行在NFV基础设施上。当MEC APP以虚拟机或容器形态部署时，相应的虚拟化基础设施应支持MEC APP使用的虚拟CPU、虚拟内存以及I/O等资源与其它虚拟机或容器使用的资源进行隔离。APP镜像和镜像仓库具有完整性和机密性、访问控制保护等。MEP需满足虚拟层安全要求和容器安全要求，例如：
ME APP部署的虚拟资源之间开启安全隔离。 
ME APP之间以及与MEC系统其它网元之间部署虚拟防火墙，防止恶意的APP攻击其它APP。 
ME APP之间的组网采用VLAN隔离。 
MEC系统对ME APP占用的资源做限制，防止恶意占用其他虚拟化资源。 
对ME APP的带宽进行管理，防止其流量过载。 
ME APP通过MEC系统认证和授权，且访问MEC系统时使用加密传输，防止数据被篡改。 
MEC系统对ME APP的安全还包括其生命周期的安全，例如： 
ME APP软件包使用SHA2数字签名保护其完整性，防止非授权访问和篡改。 
ME APP软件包通过安全的加密通道传输，保证机密性和完整性。 
APP镜像、快照存储在安全的路径下，并启用加密存储，防止被恶意篡改。 
镜像包在注册、加载、更新时MEC系统对其进行完整性校验。 
#### 数据保护设计 
在MEC系统中，有多种数据在系统内传输，例如： 
身份标识信息：包含用户永久身份标识、设备身份标识、网络切片标识等身份标识。 
网络信息：例如IP地址、端口号、DNS域名等。 
策略信息：包括用户的分流规则、参数配置等内容。 
但是，由于MEC部署在网络边缘，运营商的管理和控制较弱，数据被窃取、泄露的风险也相对较高。另外第三方应用的入住，也会对数据的安全性提出了更高的要求。 
为了保护MEC系统中传输的数据，需要在MEC系统边缘设立安全防护，如[图1](d0e1800.html#d0e1800__810dd9e6-7938-4990-a464-3306f2fa87bb)所示。
图1  边界安全防护
[???]images/image16.png)
MEC系统的边缘安全防护包括： 
MEC与外部网络之间部署vFW或者硬件防火墙，确保边界安全防护。 
MEC内部安全MEC平台、自有服务、第三方APP划分不同的安全域，通过防火墙实现域间隔离。 
同时，MEC系统对用户数据从采集、传输、存储、处理等方面遵从通用安全设计中的数据保护方法，对涉及到的用户数据通过如下手段来保护用户的数据资产。 
MEC严格确定业务处理所必需的信息，按照定义对信息获取做严格控制。 
MEC采用加密传输，并进行完整性校验，防止数据在传输过程中被篡改、拦截或窃听。 
对用户的关键数据采用加密存储，如加密算法一般是SHA256、AES256等。 
对用户的数据访问，需要通过MEC的能力开放API接口，且该接口开启需要授权控制，未经授权不能访问用户信息，防止非法访问、越权访问等手段获取用户的数据。 
详细的数据保护设计参见“[通用安全设计](d0e4426.html)”。
#### 管理安全设计 
由于MEC分布式部署于网络边缘，管理域网元对其集中管理，其上的虚拟化网络功能是通过MANO系统统一编排管理。作为边缘云的统一云管系统，管理域也是用户或者运营商的统一管理portal界面，对其整体的安全设计包括用户管理、日志管理、管理编排接口等。 
##### 安全管理 
MEC提供安全管理功能，通过用户管理和权限管理提供安全地管理和访问系统机制，使不同类别的操作员具有不同的操作权限。这限制了未经授权的和错误的操作，增加了系统安全性，并确保了用户数据的完整性。 
图1  安全管理
[???]images/image18.png)
安全管理机制主要包括： 
用户管理：包括创建、删除、修改用户或用户组，用户密码维护等。可以设定密码强度要求、有效期、强制修改策略等。 
权限管理：权限是执行特定类型的管理任务的权利，由权限管理系统向用户授予或撤销某些权限。MEC为权限管理提供权限组。权限组是一组可以被授给用户的相关权限集合。MEC提供了内置的权限组功能来简化权限的管理，管理员也可以创建其他权限组。基于不同的权限组，不同的操作人员可访问的数据不同，保障信息安全。 
##### 日志管理 
如果与安全相关的事件没有被记录下来（例如：操作员执行的与安全相关的操作、系统本身产生的与安全相关的事件，或者未授权的用户盗用授权的账号进行的操作未被记录），则可能导致后续无法对安全相关的事件进行追溯。 
MEC提供日志维护功能，用来详细记录系统运行状态和操作员的操作行为，使系统易于维护和管理。 
图2  日志管理
[???]images/image19.png)
日志分为两类：业务处理/操作日志和系统日志。 
业务处理/操作日志记录业务处理人员/操作者的所有进行的操作。能够准确和详细的记录操作者的操作行为，包括操作时间、涉及的功能模块、操作者、操作终端ID、操作状态（成功或失败）和操作的每一个事件内容。日志可根据操作者名字、操作终端、功能模块和操作时间进行过滤和显示。 
系统日志记录系统的运行状态。 
MEC支持对于日志能够进行记录、备份，确保能够随时对安全相关的事件进行审计。 
##### 管理编排 
MEC采用虚拟化技术，其架构遵守电信级NFV基本架构，虚拟网元采用统一的编排管理系统。作为MEC的管理域，编排管理网元采用如下的安全防护： 
管理编排网元启用病毒防护，定时查杀病毒及木马，防止病毒通过管理域攻击MEC系统。 
管理编排网元与分布式的MEC系统的接口进行加密和授权，保护传输的数据，如管理域配置参数、用户规则等，防止管理数据被篡改、拦截等。 
管理系统对其接入的用户终端上的访问做限制，防止大量恶意终端的APP发送生命周期代理请求来实现MEC平台上的APP加载、实例化、终止等，对MEC编排网元造成D(DoS)攻击。 
## 切片安全 
### 端到端切片架构 
5G网络切片是基于无线接入网、承载网与核心网基础设施，以及网络虚拟化技术构建的一个面向不同业务特征的逻辑网络。运营商可以为不同行业应用在共享的网络基础设施上通过能力开放、智能调度、安全隔离等技术分别构建彼此隔离的5G网络切片，提供差异化的网络服务。 
端到端切片网络架构如[图1](d0e1919.html#d0e1919__3a0788ad-07ba-46fe-8847-42bca8505a20)所示，上面是切片管理层，切片管理层主要是切片的全局编排管理，实现切片自动闭环端到端的生命周期管理。下面是切片的物理资源层，包括无线接入、承载、核心网等，叠加切片管理层实现端到端的切片架构。
图1  端到端切片架构
[切片架构]images/image20.png)
### 切片威胁分析 
为了更好地支持各种差异化的业务场景，5G采用网络切片，为不同业务提供差异化的服务，这也对安全提出了新的挑战，如切片之间的安全隔离，以及虚拟网络的安全部署和安全管理等。针对切片的安全威胁分析如下： 
切片接入安全威胁：主要包括用户的非法接入、用户的接入信息泄露、用户接入信息被截取等。 
切片间安全威胁：包括切片间非法访问、切片间资源争夺、切片间非法攻击等。 
切片内安全威胁：包括切片内不同安全域间的非法访问、用户数据被窃听、针对公共NF的拒绝服务攻击等。 
切片与DN网络间的安全威胁：来自外部网络的非法访问、病毒木马攻击等。 
切片管理的安全威胁：非法租户非法访问、管理员权限滥用、切片敏感信息的篡改等。 
### 切片安全架构 
区别于传统物理专网的私有性与封闭性，5G网络切片是建立在共享资源之上的虚拟化专用网络，切片安全除了提供传统移动网络安全机制之外（例如接入认证、接入层和非接入层信令和数据的加密与完整性保护等），还需要提供网络切片之间端到端安全隔离机制。 
切片端到端的安全架构如[图1](d0e1951.html#d0e1951__f08da2c0-0e65-4904-afc8-9750ff9d50dd)所示。
图1  切片安全架构
[切片安全架构]images/image21.png)
切片安全架构包括切片的接入安全、RAN切片安全隔离、承载切片安全隔离以及核心网切片的安全隔离。 
其中核心网的安全隔离又可细分为： 
切片接入安全：包括接入策略控制、PDU会话机制、IPSec or SSL VPN安全连接。 
公共NF与切片NF安全：包括白名单机制控制是否访问、NSSF保证AMF连接正确NF，以及在AMF中监测请求频率。 
切片间安全：包括VLAN/VxLAN隔离、VM/容器进行资源隔离。 
VNF安全：互相鉴权保证通信安全、以及通过TLS安全连接。 
5GC与DN之间的安全：包括vFW/vIPS/anti-DDOS防止外部攻击、IPSec or SSL VPN安全连接。 
### 切片安全方案 
#### 切片接入安全 
终端在注册及PDU会话建立时都会选择特定的切片，实现切片接入的隔离： 
UE初始注册时，会提供允许NSSAI或者配置NSSAI字段，RAN及CN根据该字段确定合适的目标AMF。 
UE非初始注册时，携带了Temp ID字段，RAN会基于Temp ID来选择对应的AMF；如果UE没有携带Temp ID和NSSAI，RAN选择缺省的AMF。 
UE会话建立时，根据APP信息选择合适的S-NSSAI，AMF通过NSSF/NRF选择服务S-NSSAI的切片实例ID及切片中选择合适的SMF实例，SMF再结合S-NSSAI/NSI、DNN等信息选择UPF，从而实现切片接入的隔离。 
5G提供多重认证方式，在UE接入切片时，可以根据策略配置，由AMF对UE发起切片接入认证流程，确保接入切片的终端是合法的。 
#### RAN切片设计 
网络切片在RAN侧的隔离主要面向无线频谱资源以及基站处理资源。5G OFDMA系统中，无线频谱从时域、频域、空域维度被划分为不同的资源块，用于承载终端和基站之间数据传输。频谱资源的隔离可以分为物理隔离和逻辑隔离。
物理隔离是给网络切片分配专用频谱带宽，这时分配给切片的资源块是连续的。 
逻辑隔离是资源块按照不同切片的要求按需分配，分配给每个切片的资源块是不连续的，多个切片共享总的频谱资源。 
无论是物理隔离还是逻辑隔离，由于资源块的正交性，两者的隔离能力基本相当。但是专用频谱的覆盖范围和覆盖效果通常不如共享频谱，当数据文件较大，或者用户处于小区边缘时，由于无法使用更宽的频谱传输，使用物理隔离的切片往往无法达到更高的传输速率。另外由于物理隔离方式实现成本较高，资源分配不够灵活，因此频谱租赁代价高昂。逻辑隔离可以实现基站调度器根据不同切片的传输要求，对资源块动态调配，提高了频谱资源利用率，因此，行业应用在无特殊要求的情况下，应首选逻辑隔离方案。 
DU和CU是对传统RAN功能的进一步重构。 
DU用于处理L1(PHY)和L2(MAC)层功能，例如资源块调度、调制编码、功控等功能。 
CU用于处理L2层以上的功能，例如分组数据汇聚、切换等功能。 
基站处理资源的隔离可以从DU和CU两个方面考虑，DU软件目前依赖于专用硬件实现，CU软件则既可以在专用硬件运行，也可以虚拟化在通用服务器上运行。 
网络切片在DU的处理资源隔离可通过物理隔离的方式，为不同的切片分配不同的DU单板或处理核，也可以通过逻辑隔离的方式共享处理资源。从专用硬件成本和处理效率的角度，DU更多采用共享处理资源的方式。当CU软件运行在专用硬件上时，策略可以类似于DU，更倾向于共享处理资源。当CU软件运行在通用服务器上时，网络切片在CU的隔离可基于NFV隔离技术实现，通过虚机/容器隔离实现CU隔离。根据切片的安全隔离要求，在DU、CU上的隔离机制可单独或组合使用。 
#### 传输切片设计 
承载网网络切片是面向网络链路、节点、端口等网络拓扑资源进行切片和虚拟化，构建虚拟网络(vNet)。一个物理网元可虚拟化成多个逻辑vNode，物理链路可虚拟化成多个逻辑vLink。对物理网络虚拟资源进行规划、分配，将逻辑虚拟的vNode和vLink组合成逻辑网络vNet，即网络切片(vNet=vNode+vLink)。虚拟网络(vNet)具有类似物理网络的特征，切片形成的虚拟网络和物理网络类似，包括逻辑独立的管理面、控制面和转发面，满足网络之间的隔离特征。 
网络切片技术可以在一个硬件基础设施中切分出多个虚拟的端到端网络，不同网络切片实现逻辑隔离，适配各种类型业务并满足用户的不同需求。对每一个网络切片而言，网络带宽、服务质量、安全性等专属资源都可以得到充分保证。整体切片的架构图如[图1](d0e1993.html#d0e1993__%E6%89%BF%E8%BD%BD%E5%88%87%E7%89%87%E6%9E%B6%E6%9E%84-48DC90FF)所示。
图1  承载切片架构
[???]images/image22.png)
##### 承载切片间安全隔离 
目前承载切片的技术既有硬切片实现的方式，如FlexE，也有软硬切片相结合的方式，如Flex
Algo+FlexE。无论是硬切片，还是软硬切片相结合的方案，都是通过将一个物理端口划分为多个逻辑端口实现切片。支持任意子速率分片和隔离，某切片发生拥塞，不影响其他切片业务流量，各切片之间业务隔离，业务约束在某切片中承载，即一切片的业务流量不会串入其它无关切片，确保切片间的安全隔离。 
##### 承载网网络切片方案选择及部署原则 
硬切片实现方式（如FlexE）与软硬切片相结合方式（如Flex Algo+FlexE）的主要区别与优缺点如下：
硬切片：优点是完全刚性的资源配置，每个切片对应一个FlexE client子端口及网络带宽资源，不同切片之间完全隔离；缺点是上层业务与底层网络资源为一个紧耦合的关系，资源调整比较困难和复杂。 
软+硬切片：用户切片与底层网络资源松耦合关系。用户基于一定的意图以及约束条件形成一个算法空间FA，用户可以基于FA实现与底层FlexE之间的M：N映射。 
中兴通讯可以实现以上方式的组网，可以按需提供部署，部署的基本原则及方案思路： 
针对政企网优质客户以及移动业务考虑切片技术。 
无线业务接入侧通过VLAN子接口进行区分，部署ToB以及ToC两个FlexE硬切片，与承载网ToB以及ToC切片实现对接承载。 
某个切片上，针对承载的不同业务可以部署不同QoS优先级，并可根据需要进行调整。 
##### 承载网络切片流程 
用户通过SDN控制器，进行承载网络切片规划设计及配置操作，包括切片规划、模板配置等。 
用户确认编排配置结果，并部署切片；控制器把抽象的切片意图自动翻译为设备的相关配置并下发给物理网络，进行资源分配；ZENIC
ONE基于vNet拓扑进行路径计算和资源分配，并在vNet上创建业务。 
用户调整vNet网络资源，例如调整vLink带宽，增加vNodes和vLinks等。 
ZENIC ONE监控切片业务质量，包括时延、带宽等SLA质量；ZENIC ONE反馈给操作员切片的业务质量监控数据。
操作员基于切片业务质量调整切片资源，或通过闭环自优化系统自动优化切片业务。 
#### 5GC切片设计 
5G核心网基于虚拟化基础设施构建，并且由很多种不同的网络功能构成，有些网络功能为切片专用，有些则在多个切片之间共享，因此在核心网侧的切片安全需要采用多重机制，包括切片间安全隔离、公共NF与切片NF的安全、切片内VNF安全、切片与DN网络间安全隔离、切片管理隔离等。 
##### 切片间安全隔离 
由于网络切片共享统一的核心网基础设施，为了确保一个切片的异常不会影响到其他切片，一方面，核心网可以采用物理隔离的方案，为安全性要求较高的切片分配相对独立的物理资源，另一方面，还可以采用逻辑隔离方案，借助成熟的虚拟化技术，在网络层通过划分VLAN/VXLAN子网进行隔离，在管理层通过分权分域实现切片管理和编排的隔离。相对于物理隔离方案，逻辑隔离对资源分配更加灵活，更为经济。 
##### 公共NF与切片NF安全 
对于公共NF与其他切片NF间的安全，采用如下措施： 
设置允许VNF之间访问的白名单，例如定义每个NF可以被哪些NF访问。 
在NRF注册切片，保证UE接入到正确的切片。 
通过公共AMF和切片入口网元SMF之间认证，建立公共NF和切片的信任。 
通过设置访问频率监控等技术，防止公共NF被DoS攻击引起的资源耗尽。 
##### 切片内VNF安全 
切片内的NF之间通信前，先进行认证，保证对方NF是可信的。 
通过安全通道机制（TLS/IPSec），保证NF间信息传输的安全。 
##### 切片与DN之间的安全 
部署FW/IPS/Anti-DDos等设备，保护切片内网与外网的安全。 
通过建立安全隧道（例如IPSec），保证应用的通信安全。 
##### 切片管理隔离机制 
不同切片下的核心网各类网元，其资源数据应尽量保持独立性，避免相互影响，特别是网元在不同切片间共享的情况。 
切片管理域的隔离由系统管理员、管理组、用户、角色和操作等要素组成切片间安全管理框架，根据切片的资源范围灵活授权，实现切片间不同用户对资源管理的隔离。基于角色的用户授权访问，实现切片实例相关的各类资源数据的访问控制和隔离。对于切片的操作维护实现分权分域管理。设置不同的租户认证管理不同的切片，每个切片属于一个租户，每个租户分配DC隔离的虚拟资源，保证租户的虚拟资源的隔离。每个切片操作者只允许一个租户，不能查看其他租户的切片所包括的信息。 
配置数据隔离配置数据是切片管理系统通过EMS向网元下发的。不同切片对应的各类资源数据范围在切片规划时已确定，并且导入EMS系统中。基于这些资源规划结果实现配置数据的切片间访问控制和隔离。 
性能统计数据的隔离切片管理系统支持结合客户标识、切片标识及子切片标识等，对包括测量任务、门限任务、测量对象、计数器在内的性能统计数据进行隔离。 
## 传输安全 
### 传输网络架构 
根据DU和CU的位置，在5G网络中，5G承载网可分为前传网（AAU到DU），中传网（DU到CU）和回传网（CU到核心网），如[图1](d0e2576.html#d0e2576__G%E4%BC%A0%E8%BE%93%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84-48E29C22)所示。
图1  5G传输网络架构
[???]images/image26.png)
5G前传网除了光纤直连之外，在光纤资源不足的区域，可以采用有源OTN、无源WDM方案解决。 
中传网是5G网路CU、DU分离后新增的承载网络层次，目前中传DU带宽和回传网络相当，从流量看CU/DU分离对承载网无影响。 
5G回传网实现CU和核心网、CU和CU之间等相关流量的承载，可以由接入、汇聚和核心三层组成。 
中传网和回传网在5G承载中基于带宽、网络切片、组网灵活性等方面的需求基本一致，所以在一般建设中考虑统一承载。 
### 传输威胁分析 


在5G网络中，安全的焦点主要集中在无线和核心网，包括NR（新空口）安全、接入和认证安全、MEC安全，端到端的切片安全等，满足5G业务的安全要求。 


5G业务的端到端安全，主要还是由无线和核心网配合完成。5G承载作为5G流量的中间管道，主要还是在带宽、时延、高精度时钟同步等方面，满足无线和核心网的配套要求。但是，在5G承载网络中，会引入编排器、SDN控制器等新网元，因此，安全方面除了设备自身传统的数据面、控制面和管理面安全之外，还需要考虑应用安全以及SDN控制器在内的网络虚拟化安全等内容。 


另外，根据欧盟2019年11月发布的5G网络威胁全景，主要列出了9种主要的风险及场景，其中和设备自身密切相关的主要是前三点： 



 
R1：网络的配置错误 

 
R2：缺乏访问控制 

 
R3：产品质量差 

 


因此，产品安全除了安全相关的功能，还包括提升源代码安全水平、提供安全配置检查能力、加严设备访问控制等措施，保证产品能满足5G时代的安全要求。 


### 传输安全架构 
ZTE 5G传输安全架构如[图1](d0e2619.html#d0e2619__%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84-48E34B50)所示，主要包括数据平面安全、控制平面安全和管理平面安全，在每个层面上，针对不可抵赖性、可用性、隐私、通讯安全、保密性、认证、数据完整性、接入控制八个方向做考虑，设计安全的系统架构。同时，产品遵循三层次分离的设计原则，能够保证任何一个平面在遭受攻击时，不会影响其他平面的正常运行。
图1  传输安全架构
[???]images/image27.png)
### 传输安全方案 
#### 管理面安全 
管理面安全模块设计如[图1](d0e2631.html#d0e2631__%E7%AE%A1%E7%90%86%E9%9D%A2%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1-48E38ABF)所示。
图1  管理面安全设计
[???]images/image28.png)
管理平面，为了保障产品的操作系统和管理应用能够正常运行，围绕配置管理接入服务的可用性、安全性，以及重要数据的安全性，主要覆盖包括： 
安全登录 
账号安全认证、口令安全策略 
账号的防暴力攻击 
服务授权、CLI授权 
SNMP访问授权 
FTP访问授权、文件授权 
Web访问安全 
审计日志功能 
管理面安全建议使用原则： 
禁用未使用的管理协议服务：网络设备需要的管理协议服务需要按需开启，对于不需要使用的管理协议，建议关闭相应服务。 
基于设备VTY的ACL访问控制对终端登录进行保护：Telnet/STelnet提供ACL限制远程访问的IP地址范围，优先使用SSH、SFTP、HTTPS、SNMPv3替代Telnet、FTP、SNMPv1/2等不安全的明文协议进行设备远程访问。 
支持多种Security Access Protocol。 
##### 认证授权功能 
认证授权模块支持以下模式：无认证、本地认证、RADIUS认证、TACACS+认证、Diameter认证及混合认证。混合认证包括：RADIUS-local、local-RADIUS、RADIUS-none以及TACACS+-local、local-TACACS+、TACACS+-none。认证通过的账号继续完成授权处理，不通过的则返回适配层失败。
安全模块根据认证返回的信息及授权模板，进行用户授权。支持的授权方式：本地授权、RADIUS授权、TACACS+授权，Diameter授权、RADIUS混合授权，TACACS+混合授权。 
管理面的服务(NETCONF、FTP/SFTP）的服务接入认证均与Telnet/SSH等采用类似登录认证管理来实现。 
##### 访问类型控制 


基于每个用户账号，可以配置其能够使用的管理层管道服务，例如：串口管理服务、Telnet服务、SSH服务、FTP服务等。一个用户账户可以享受其中一种服务，也可以是多种的组合。当用户登录进行认证时，系统不仅对其账号的合法性进行校验，同时也检查其登录管道是否受限，只有都与系统配置吻合的账号，才被允许登录，享受设备为其提供的管理服务。 


##### 管理终端控制 
###### 用户在线空闲超时断开 
管理面所有的登录均具备空闲超时锁定功能。在设定的时间段内没有任何操作的情况下，管理面的服务（串口/telnet/netconf）都会终止登录账号建立的会话，用户需要再次进行身份鉴别才能够重新操作。管理面服务均有各自的缺省最大空闲时长值，授权管理员也可以自己设定。 
###### 用户在线最大超时断开 
支持最大在线超时时间设置，即连接在线时间总长度，超过配置的时间长度，会自动断开连接。 
###### 黑白名单设置 
支持通过配置ACL来限制特定源地址、源端口、目的地址、目的端口的客户端是否能登录设备。 
支持ACL规则动态响应，当客户端连接在线时，如果ACL规则发生变更，相关配置立即生效。 
###### 报文优先级设置 
支持指定控制面报文的DSCP值。
###### 远程登录会话数限制 
用来配置同一本地用户同时在线的最大数目。 
当用户名和授权模板绑定后，用户同时接入数目就会受该命令限制：接入数目统计的是同一账号同时通过Telnet、SSH或FTP等方式共同累计的接入次数，如果串口认证打开了，串口认证的次数也统计在内。 
某个账号超过接入限制后，使用该用户名进行本地认证接入的用户将被拒绝。 
如果本地不存在的远端服务器用户，其使用的授权模板下有该限制，远端服务器用户超过接入限制后，使用该用户名进行认证接入的用户将被拒绝。 
如果配置的限制数目小于当前某个用户已登录次数时，使用该用户名进行本地认证接入的用户将被拒绝，但已登录用户的不下线。 
###### 单个源IP最大并发连接数设置 
支持配置单个源IP允许的最大并发连接数，单个源IP允许的最大连接数不区分用户名，该配置对已有链接不会强制断链，源IP区分VRF、IPv4、IPv6。 
##### 用户账户支持密码强度检查 
###### 密码复杂度检查 
用于设置用户密码的强度。当用户希望密码满足某种强度要求时，设置密码之前，执行该命令。支持本地密码最小长度（6-32），支持密码中至少包含4类字符合集（数字、大写字母、小写字母、特殊字符）。 
###### 用户账号密码支持密码字典 
用户账号密码增加支持密码字典的功能，根据系统安全需求不同，管理员可以通过命令开启该功能。开启后，当用户设定或修改密码时，系统检查设定的密码是否和密码字典中的密码相同，如果相同，系统将不允许设置，并给出错误提示。 
###### 用户账号密码支持连续字符数限制 
用户账号密码增加支持连续字符数限制的功能（密码中相同的并且连续出现的字符长度的最大限制），根据系统安全需求不同，管理员可以通过命令开启该功能，并设置最大限制数。开启后，当用户设定或修改密码时，系统检查设定的密码是否超过该最大限制，如果超过，系统将不允许设置，并给出错误提示。 
###### 密码和账户相关性检查 
通过配置strong-password username-related-chk命令，可以对密码和用户的相关性进行检查： 
密码不能是用户名的反向串（大小写敏感）。 
用户名和密码，二者中较短的作为子串，长串不能包含子串（大小写不敏感）。 
###### 密码日期相关性检查 
通过配置strong-password date-check命令，可以对密码和日期的相关性进行检查： 
密码中不允许包含从1970年1月1日至2037年12月31日之间的日期； 
密码中不允许包含YYYY-MM-DD、MM-DD-YYYY、DD-MM-YYYY、YYYYMMDD、MMDDYYYY、DDMMYYYY六种日期格式。 
###### 支持账户锁定功能 
支持主动锁定或者解锁本地用户，被锁定的用户将不被允许登录。 
##### 防暴力破解 
###### 连续认证失败锁定账户 
支持连续认证失败后锁定用户，失败次数范围3-6可配置，锁定时间范围1-1440分钟可配置。 
###### 多次认证失败锁定设备 
通过配置login block ＜block-seconds＞
attempts ＜try-times＞ within ＜watch-seconds＞支持阻塞模式和安静模式的配置。通过使能防攻击检测策略，可以设置路由器设备在发现有重复的远程登录尝试失败时，以阻塞的方式拒绝所有远程登录请求。这种阻塞可配置为一段时间，称为“安静期”。 
设备管理层的服务端（如SNMP、Telnet、SSH、FTP），初始为“正常模式”，当防暴检测功能启动后，就进入“监测模式”。 
在“监测模式”下，服务接受各连接的建立尝试，并以“监测周期”为单位，对失败次数进行统计累计，如果失败次数累计达到“最大失败尝试次数”，则切换到“安静模式”。 
进入“安静模式”后，服务端不再响应任何非信赖节点的建链报文，直接丢弃这些报文，这个状态持续“阻塞时间（安静期时长）”结束后，则服务重新切换到“监测模式”，继续响应新建链请求。 
安静期，可以通过配置安全期的ACL，保证ACL中的特定用户可以继续登录设备。 
##### 密码安全性 
###### 一次性密码设置 
通过配置once-password配置一次性密码，用户使用一次性密码登录时强制修改密码。新密码必须满足当前强密码要求。密码修改成功后，一次性密码自动删除，新密码生效。 
###### 密码过期时间 
通过配置password-duration设置密码的过期时间。在密码过期前3天，每次用户登录时都会提示用户修改密码，并在过期前上报告警。如果超过设置的过期时间，用户仍然不更改密码，该用户不能再登录。 
###### 历史密码限制 
缺省情况下，密码不能与最近5次以内的历史密码相同（与当前密码相同不视为与历史密码相同，即当前密码不包含在历史密码之内），可以配置为2-10. 
###### 密码恢复功能 
当用户忘记密码时，可以对密码进行恢复。恢复密码的前提是对应的用户账号配置了密码恢复问题及答案。恢复密码时，只要用户能够正确回答恢复密码的问题，就可以重新设置密码。 
###### 密码保存 
选择关键字irreversible时，明文密码进行不可逆加密，采用的不可逆加密算法是SHA256。不选择关键字irreversible时，明文密码进行可逆加密，采用的可逆加密算法是3DES。无论是明文输入还是密文输入，配置文件中都以密文形式体现。 
###### 密码显示 
密码不明文显示，在日志等中以****显示。在配置密码时，通过***掩码显示，通过两次输入确认。 
##### 分权分域 
###### 支持用户权限级别设置 
通过default-privilege-level <level>配置缺省权限等级。不同的用户可以配置不同的权限级别，同时，不同的命令也可以配置不同的使用权限级别要求。 
###### 支持命令权限级别要求配置 
通过privilege <logic-mode>[all]
level {<level>| default}<command-keywords>可以给不同的命令配置不同的使用权限级别要求。 
###### 基于角色的命令行鉴权 
在用户的操作维护权限控制方面，支持基于角色的安全模型。将权限的控制与访问通道隔离，无论用户是通过命令行访问设备，还是通过Web、网管访问设备，只要这些用户归属的“角色”是同一个，就可以获得设备上完全一致的访问授权。这种模型给管理层的账户权限安全的统一奠定了理论基础。 
Usergroup和Taskgroup都可配置，其中Taskgroup包括有AAA、ACL、组播等十几个缺省组。 
###### 支持通过License对功能、性能进行限制 
支持通过License的方式，使能/去使能Licence文件。成功安装License文件后，默认该License文件中的功能项和性能项都是生效的。 
##### 安全传输协议SSH 
SSH由IETF网络工作小组（Network Working Group）制定，是建立在应用层和传输层基础上的安全协议。当前SSH支持V2版本。可以使用缺省的端口号22，也可以配置为<49152-65535>中的指定端口号。可以通过ACL限制SSH的客户端。 
支持的秘钥交换协议包括DH、RSA，并支持关闭不安全的DH方式。 
支持的加密类型包括AES128、AES192、AES256、BlowFish、3DES，并支持关闭不安全的加密算法。 
支持通过证书+密码方式的双因子认证。 
##### SFTP访问控制 
SFTP是一种安全的文件传输协议，一种通过网络传输文件的安全方法，确保使用私有和安全的数据流来安全地传输数据。 
SFTP要求客户端用户必须由服务器进行身份验证，并且数据传输必须通过安全通道（SSH）进行，即不传输明文密码或文件数据。 
SFTP相关控制同FTP，从安全角度考虑，建议FTP禁止使用，采用SFTP进行替代。 
##### WEBGUI安全访问 
HTTP协议通常承载于TCP协议之上，更安全的传输承载于TLS或SSL协议层之上即HTTPS。目前可以支持TLS1.2版本。 
##### 安全审计（日志管理） 
###### 日志访问鉴权 
对设备日志的管理权限进行授权，日志文件目前按类型可分为如下四类： 
命令日志 
系统日志 
告警日志 
业务日志 
对日志的操作包括读、拷贝、写等。 
基于每个用户账号，可以为其配置可维护的日志类型及操作类型等，从而实现对日志授权的管理功能。通过配置，某个账号具备对某些日志类型的某些权限，这些权限包括：没有任何授权、只读、拷贝、可写（创建、修改、删除、重命名）。 
用户1日志授权：命令日志，只读、拷贝。 
用户2日志授权：告警日志，读写、拷贝。 
用户3服务授权：命令日志、告警日志、业务日志，只读、拷贝。 
权限控制基于日志类型，不是基于某个文件。 
###### 日志文件的访问授权 
结合产品情况，目前支持的日志文件按类型主要分为： 
命令日志 
系统日志 
告警日志 
业务日志 
NAT日志 
LI日志（BRAS产品特有） 
各类日志文件按日志类型分类并分目录存放。 
命令日志和系统日志都存放在/sysdisk0/（该目录可以修改，启动时通过回调函数修改，启动后不能修改）中，分2个目录分别存放。 
告警日志、业务日志、NAT日志和LI日志都存放在/datadisk0/（该目录固定，不能修改）中，分4个目录分别存放。 
文件访问授权需要支持按用户账号分配日志文件的操作权限。权限控制基于日志类型，不基于某个文件。权限包括：没有任何授权、只读、拷贝、写（创建、修改、删除、重命名）。 
###### 日志管理 
日志管理，需要满足各种接入方式（CLI、NETCONF等）操作日志记录。ROSNG的管理面的日志管理模块，实现日志的统一接收、保存、输出、查询等处理。告警日志、操作日志、debug日志、安全日志和之后的各种系统日志都可以在日志管理模块中统一管理。 
日志管理的功能包括：日志的收集、输出、保存、分析等。 
系统中有告警日志、操作日志、debug等多种日志，这些日志都需要记录到设备上，最终输出到终端、通过某种协议发送到外部服务器，或者生成log文件保存到外设。不管哪种日志，其处理过程都是类似的，只不过发生源和具体内容不同而已，因此都要纳入日志管理模块。 
###### 操作日志 
记录每个用户执行的最近有限条命令，这些日志信息保存在本地的缓冲区中，此缓存由Log
server管理。 
缓存1000条最近操作日志，并支持写到本地文件。 
序号|字段|含义
---|---|---
1|终端类型|终端类型，如CLI、Qx等。CLI日志可以没有，其他终端需要。
2|终端号|Con0表示串口，vtyX表示telnet终端。
3|用户名|登录设备的用户，串口用户没有用户名。
4|时间|时间是月日年时分秒的格式，时间格式可配置，可带时区。
5|源地址|telnet登录的源地址。
6|命令|用户执行的命令串描述或命令ID（对于Qx口是如此）。
支持多种终端的操作日志，如CLI日志、NETCONF操作日志、SNMP操作日志等，并且这些日志要支持分类保存和统一保存。分类保存便于查看某个类型终端的操作情况，统一保存有利于在多种类型终端同时操作时分析其对配置修改的相互影响。 
###### 安全（登录）日志 
在本地记录用户登录和注销登录的日志，登录认证失败也要记录，由安全模块发给日志模块管理。 
安全日志与命令日志记录到一起，这样的优点是可以明显的看出登入、退出其他操作序列。所以保留这种方式，为缺省方式。用户也可以通过日志分类的方法单独记录安全日志。 
序号|字段|含义
---|---|---
1|终端类型|因为有多种终端接入，所以需要。CLI终端可以不携带。
2|终端号|Con0表示串口，vtyX表示telnet终端（失败时可不记录）。
3|用户名|登录设备的用户，串口用户没有用户名。
4|时间|时间是月日年时分秒的格式，时间格式可配置，可带时区。
5|源地址|telnet登录的源地址。
6|标志串|表示登录还是离开的字串，如/*** user log in ***/和/***user log out ***/。对于串口，可在系统启动时记录登录日志，从用户模式退出或超时退出时记录登出日志。
###### 其他类型日志 
除了命令和登录日志外，还有告警日志、debug日志、系统日志、安全日志等。日志模块支持这些类型日志的记录。有些日志在缺省状态下需要记录，具体策略参见[表3](d0e2906.html#d0e2906__%E5%85%B6%E5%AE%83%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%86%85%E5%AE%B9%E7%A4%BA%E4%BE%8B-48E6F862)。
编号|日志类型|备注
---|---|---
1|告警日志|缺省记录到缓存和文件。缓存200KB，满后写文件。
2|操作维护日志|就是命令日志。固定记录1000条，缺省满后循环写。
3|NAT日志|缺省不记录。
4|备用|-
5|Debug日志|缺省不记录。
7|业务日志|缺省记录到缓存和文件。缓存200KB，满后写文件+1h定时写。
8|SNMP日志|SNMP操作日志日志。缺省满后循环写。
10|NETCONF日志|NETCONF操作日志日志。缺省满后循环写。
11|登录日志|含登录日志，记录到告警日志中。
###### 日志分类 
日志具有多样性特征，根据用途分了大类。但在实际使用中，这些分类可能并不满足要求。所以要支持自定分类策略，通过分类策略定义分类规则、buffer大小，以及分类后处理规则（写文件、Syslog、FTP等）。 
###### 日志输出 
分类的日志可输出到多种目的，分别为内存、串口、session、Syslog、SFTP以及文件等，告警还可以通过SNMP
Trap发给SNMP server。 
##### 服务质量分析SQA 
支持对ICMP、UDP、FTP、DNS、HTTP、SNMP、UDP Jitter、ICMP Jitter等在IP、L2VPN、L3VPN场景下进行服务质量的测试。支持通过Time range方式定时调用。 
##### Banner信息定制（最小化） 


可以通过banner incoming命令定制系统欢迎语，保证系统对外信息的最小化。根据需求也可以配置为通过认证后再显示Banner信息。 


#### 控制面安全 
控制面安全主要包括CPU安全、路由安全以及报文防攻击等。 
图1  控制面安全
[IMG_256]images/image29.png)
##### CPU安全 
支持基于Control Plane Security策略： 
动态白名单与flowtype支持控制面协议根据协议连接状态，动态建立协议白名单/灰名单。对于信任白名单，采用高优先级、高带宽保证。对于非信任的灰名单，分配低优先级、低带宽。整个系统的白名单是基于flowtype来分配的。系统支持的所有协议，均定义出相应的flowtype，每种flowtype对应分配相应的优先级以及缺省的限速值。 
CPU多级流控支持控制面和转发面分离：确保业务流量不会影响设备管理。支持采用多级流控机制：包括用户、协议类型、子接口限速、端口优先级调度、CPU总体流控等，保证了设备能在即其严重的攻击下保持正常工作。单个用户或者部分用户的攻击不会影响其他用户，单个协议的攻击也不会影响其他协议正常工作。 
CTM队列优先级调度控制平面流量管理器上进行的调度。控制平面流量管理器支持按照CTM优先级队列、目的CPU的两级调度模式。CTM队列调度对于不同的来源单板，到目的CPU之间，为不同的flowtype分配不同的优先级（0-7级）。通过此级调度，可以使同一物理端口下送往不同CPU的报文，按照优先级次序上送，高优先级报文优先保证。 
CPU队列优先级调度报文上送CPU后，在CPU的收包线程，根据flowtype，区分了0-5个优先级队列，以PQ+WFQ的方式进行调度处理。 
控制平面ACL策略控制平面ACL策略主要通过配置黑白名单策略，策略match ACL规则来匹配所有上送控制面的流量。命中白名单，则放行通过，命中黑名单则丢弃。 
静态白名单策略支持配置静态IPv4白名单策略：match IPv4 ACL、Action。忽略ACL条目的permit/deny，只匹配rule，命中后，动作为放行通过。支持配置静态IPv6白名单策略：match IPv6 ACL、Action。忽略ACL条目的permit/deny，只匹配rule，命中后，动作为放行通过。ipv4-white-list与ipv6-white-list各支持32个ACL条目，通过性能参数指定。 
静态黑名单策略支持配置静态IPv4黑名单策略：match IPv4 ACL、Action。忽略ACL条目的permit/deny，只匹配rule，命中后，动作为丢弃报文。支持配置静态IPv6黑名单策略：match IPv6 ACL、Action。忽略ACL条目的permit/deny，只匹配rule，命中后，动作为丢弃报文。 
##### 禁用未使用的服务 
为避免安全隐患，支持关闭IP网络设备不需要使用的管理与控制平面、服务控制面的业务。在设计时，要求业务可以提供命令开关进行服务的开启/关闭。这样产品在部署时，根据业务场景需要，对不需要启用的服务通过开关进行关闭。 
##### ARP防攻击 
对于系统的路由协议（应用协议）需要关注并使用的ARP，通过ARP白名单保护方案实施安全保护。 
支持ARP抑制：对接口收到的ARP报文速率进行限制，当收到的ARP报文速率达到抑制上限时，在ARP抑制时间内不进行ARP报文处理。 
支持ARP保护：当ARP条目到达指定值时，停止学习ARP。 
支持ARP学习限制：非本设备请求的ARP应答报文属于无效报文，如果不区别处理，会浪费设备的CPU资源，如果收到大量这样的报文，也产生了攻击。接口配置了ARP学习限制之后，只要不是自己请求回来的响应报文都丢弃，不学习ARP。 
支持接口的控制面安全可信任属性：当配置了接口为控制面安全的信任接口时，设备收到需要上送控制面的ARP请求/应答报文后会判断ARP报文目的地址是否为配置接口的主地址。如果是，则作为优先级高的信任报文进行安全保护上送控制面。 
支持ARP源过滤：当开启ARP源过滤功能时，路由器对于收到的ARP报文会根据报文源IP地址查找路由表，检查该ARP报文的出接口是否为收到该ARP报文的入接口。如果ARP报文的出接口是入接口，则学习该ARP；否则，丢弃该ARP报文。ARP源过滤能防止某些病毒产生的攻击，默认情况下，路由器的ARP源过滤功能是开启的。 
##### IGMP防攻击 
支持IGMP报文抑制。
支持限制一个查询周期中IGMP接口允许的最大组加入数。 
##### 路由协议防攻击 
对路由协议的攻击主要是通过使用非法的或未授权的路由设备与网络中的合法设备建立路由邻接关系，获取网络中的路由信息。通过路由协议的认证功能可以有效阻止这种攻击。 
承载设备能够对收到的各种路由协议进行认证：RIPv2、OSPF、IS-IS都支持对协议报文的明文认证和MD5加密认证；BGP、LDP等协议则依靠TCP的MD5加密认证来保证协议报文的安全性。
不同路由协议的认证方式虽然不同，但只要是明文认证，安全性均存在很大隐患；而密文认证的安全性在可预见的时间内是可以得到保证的，在承载产品上配置路由协议时，通常建议配置密文认证。 
Keychain认证：多个认证密钥组成，每个密钥包含一个ID和密码。密钥存在生命期，通过密钥的生命期可以在Keychain中滚动选择不同的认证密钥。Keychain可以滚动选择认证密钥来增强防攻击性。 
HMAC-SHA256认证：通过将配置的密码进行HMAC-SHA256算法加密之后再加入报文中，提高密码的安全性。 
##### TCP防攻击 
支持通过对SYN等待老化时间、半连接老化个数、限制TCP连接总数、限制一分钟连接数门限、开启TCP防攻击白名单功能等来保证TCP协议的安全性。 
##### TCP/IP防攻击 
###### 泛洪攻击 
TCP SYN flood攻击、ICMP flood攻击：速率限制。 
UDP flood攻击（fraggle攻击、UDP诊断端口攻击）：检测UDP端口号，对7/13/19的报文直接丢弃。 
###### 畸形报文攻击 
没有IP载荷的泛洪攻击：只有IP头没有任何高层数据，认为无用，丢弃。 
LAND攻击：TCP syn中源和目的一致，则丢弃。 
Smurf攻击：对目的地址是广播或者子网广播地址的ICMP echo request报文，丢弃。 
TCP标志位非法攻击：TCP的URG、ACK、PSH、RST、YSN、FIN全0或者全1，SYN和FIN同时为1，丢弃。 
###### 分片报文攻击 
泪滴攻击：丢弃重组有重叠的报文。 
巨大offset攻击：offset总长度大于65515，丢弃。 
重复分片类攻击：限速。 
##### GTSM 
GTSM机制通过对IP报文头中TTL的检测来达到防止攻击的目的。
如果攻击者模拟真实的BGP/BGP4+/OSPF协议报文，对一台设备不断地发送报文，设备转发层面接收到报文后，检测是否是BGP/OSPF报文。对非BGP/OSPF报文，将按照配置的缺省处理策略进行转发或丢弃。 
对BGP/OSPF报文，如果设备使用了GTSM功能，首先进行GTSM策略匹配。如果匹配了GTSM策略，再判断报文的TTL是否在策略允许的范围内。超过则认为是攻击报文，丢弃，并不匹配GTSM策略，按照缺省策略丢弃或者上送；如果设备没有使能GTSM功能，报文直接上送控制层面。 
目前已经支持BGP、OSPF、LDP GTSM功能。 
##### Keychain 
目前，路由协议、TCP、信令协议（如LDP）等应用程序通过交换认证报文保证数据传输安全，但是这些认证机制不够健全。这些应用程序使用固定的认证密钥，只有在管理员手工更改这些密钥时，密钥才会改变。手工更改认证算法和密钥是一个复杂的过程，在所有路由器上瞬间更改所有密码是十分困难的，将会导致报文丢失。 
当前认证机制的另一个缺点是不能通过一个应用程序有效控制所有的认证。目前每个应用程序独立拥有自己的认证规则。如果有许多应用实例需要配置相同的认证算法，将会导致数据和过程重复。因此，当前系统需要一个能集中控制所有的认证过程，并且能够动态更改认证密钥而不需要人工过多参与的认证算法。为了实现该功能，系统中添加了Keychain。 
Keychian是一个集中控制应用程序，它可以为所有需要认证的应用程序提供认证功能。在认证过程中，Keychain可以动态的更改认证密钥。Keychain是一系列key-id的集合，key-id用来唯一表示认证信息。认证信息包括认证密码和认证算法。通过设置key-id的接收和发送时间实现动态变更认证信息。Keychain支持MD5、SHA1-1、HMAC-MD5、HMAC-SHA1-12、HMAC-SHA1-20、sha256、3DES、AES128、AES192、AES256、SM4、SM1等加密算法。 
##### 路由策略 
通过操纵路由选择信息，攻击者可以把用户流量重定向到其他网络中，或者向被攻击承载产品发送大量的流量。此外，承载产品要具有能够拒绝明显的利用控制信息过量耗用资源的能力，这也要求承载产品有丰富的路由策略和过滤能力。 
路由协议都提供了丰富的路由策略和路由过滤功能，可以控制路由协议对路由信息的发布和接收，可以只发布某些指定的路由，也可以只接收符合某些条件的路由。这样可以在满足需要的前提下减少承载产品的资源消耗，达到更好的性能，也可以对非法流量进行过滤，避免路由攻击。 
目前主要支持的路由策略如下：  
路由图（route-map）：根据匹配条件进行设置，主要由match和set语句组成。 
访问控制列表（access control list）：用于配置匹配条件。 
前缀列表（prefix-list）：作用类似ACL，用于配置匹配条件，可单独使用，也可与路由图、区域过滤列表结合使用。 
自治系统路径访问列表（as-path access-list）：仅针对BGP协议，用于匹配BGP路由信息的自治系统路径域，与路由图结合使用。 
团体属性列表（community-list）：仅针对BGP协议，用于匹配BGP路由信息的自治系统团体域，与路由图结合使用。 
OSPF路由过滤器（filter）：仅针对OSPF协议，用于过滤Type-5、Type-7 LSA。 
OSPF区域过滤列表（area filter-list）：仅针对OSPF协议区域间路由过滤，过滤Type-3 LSA。 
#### 转发面安全 
##### ACL访问控制列表 
ACL访问控制列表，即ACL规则，使用其中的网络报文信息可以对报文流量进行分类，判断是否符合该规则来决定是否实施预先定义的动作。一个ACL可以包含1个或者多个规则，进行更复杂的匹配，从而达到访问控制的目的。
支持通过Time range方式定时调用。 
##### URPF 
URPF的主要功能是用于防止基于源地址欺骗的网络攻击行为。 
URPF通过检查数据包中源IP地址以及根据接收到数据包的接口和路由表中是否存在源地址路由信息条目，来确定流量是否真实有效，并选择数据包是转发或丢弃。 
支持严格URPF、松散URPF和忽略缺省路由的URPF。 
##### IP-Source-guard 
开启ip-source-guard检查功能的端口，收到报文后查找IP Source Guard绑定表项，如果报文中的源IP和源MAC与绑定表项匹配，则端口转发该报文，否则做丢弃处理。配置功能是针对端口的，一个端口被配置后，仅该端口被限制，其他端口不受该配置影响。源IP和源MAC必须都符合才转发报文，否则丢弃。 
##### 镜像 
镜像功能可以把源端口的部分或全部流量拷贝到另一个专门指定的“镜像端口”或“目的端口”，在不严重影响源端口正常吞吐流量的情况下，通过镜像端口对网络的流量进行监控分析。 
镜像的功能简单地说就是将被监控流量镜像到监控端口，以便对被监控流量进行故障定位、流量分析、流量备份等。被监控流量所在端口就称为源端口，监控端口也称为目的端口，目的端口直接与网络分析器等相连。 
支持本地端口镜像和本地流镜像。 
##### DHCP SNOOPING 
DHCP Snooping通过配置信任端口，只接收来自信任端口的DHCP服务器报文，丢弃非信任端口的DHCP服务器报文，隔绝非法DHCP服务器。通过侦听DHCP报文，生成一张IP+MAC的DHCP Snooping绑定表。当收到用户报文时，将其中的IP和MAC与DHCP Snooping表进行比较，如果有匹配项，则认为是合法用户，允许用户接入网络；如果没有匹配项，则认为是非法用户，从而限制用户私自配置静态IP接入网络。 
支持中国电信的82选项格式和DSL论坛的82选项格式。 
##### IPSec 
支持LAN-to-LAN IPSec。IPSec提供对等体间连接性VPN有局限：
IPSec只能加解密IP数据流。 
IPSec无法处理多播和广播数据流，则IP多播数据流无法通过IPSec隧道。同时，不能在IPSec对等体使用多播的动态协议进行动态路由选择。 
解决方案：支持IPSec+GRE。要解决这个问题，采取在对等体之间配置一条封装IP的GRE隧道，用IPSec保护GRE/IP隧道。
GRE模型和IPSec模型区别在于IPSec保护的地址范围。加密数据流时，数据流先封装为GRE隧道接口封装，然后再使用IPSec对封装后的报文进行加密。解密数据流时，先解密数据流，然后再脱掉GRE隧道封装进行转发。 
## 通用安全设计 
### 物理环境安全 
物理环境安全需求是对机房的物理安全防护需求。机房是放置5G系统网络与信息处理设施的物理区域，保证系统各种设备的物理环境安全是保障整个5G网络系统安全的前提。机房设计要符合EIA/TIA568、TIA-942、GB9361等安全标准，实行分区管理。对于机房内设备的安全防护，要设置安全防盗报警装置和监视系统，采用电源保护、防线路截获、防辐射泄漏、防雷电击、利用噪声干扰等措施来保护设备的物理安全，同时通过板卡、设备冗余，保障设备自身的安全性。 
具体的安全防护措施包含机房物理位置选择、物理访问控制、防盗窃和防破坏、防火、防雷击、防水和防潮、防静电、温湿度控制、电力供应设计及电磁防护以及机房环境管理安全等内容。 
物理位置选择选择具有安全环境的机房是保证物理环境安全的前提。机房地址的选择和设计应考虑火灾、洪水、雷击、爆炸、骚乱及其他形式的自然或人为灾害导致的破坏，还应考虑相关的卫生、安全条例标准及周边的任何安全威胁。备用设备和备份媒介应安置在与主场所保持安全距离的区域内，以防主场所发生灾难时可能造成的破坏。机房场地应避免设在建筑物的顶层或地下室，否则应加强防水和防潮措施。 
物理访问控制为防止非授权人员进入机房，必须对机房及其各区域的人员访问实施控制措施，避免由于非授权人员的擅自进入，造成系统运行中断、设备丢失或损坏、数据被窃取或篡改等。具体措施有：在机房的物理边界设立人工接待处或采取其他限制物理出入的措施，控制安全区域的进出，只有经过授权的人员才可以访问。所有应急通道出入口都关闭，并设置报警装置。所有访问者应办理出入手续并接受监督或检查，记录其进入和离开的日期和时间。访问者的访问目的必须经过批准，并只允许访问经授权的目标。提前告知访问者该区域的安全要求及有关应急程序。机房安全区域要使用身份识别技术（例如门禁卡、个人识别码等）对所有访问活动进行授权和验证。所有访问活动的审计跟踪记录要安全地保管。 
防盗窃和防破坏为保证机房设备、设施和介质的安全，需要对机房采取防盗窃和防破坏措施，具体措施有：将设备或主要部件进行固定，并设置明显的不易除去的标识。将通信线缆铺设在隐蔽安全处。设置机房防盗报警系统或设置有专人值守的视频监控系统。 
防雷击雷击是一种常见的自然灾害，对电子设备的损坏非常大。有必要对机房建筑、内部电源线、信号线及电子设备等采取必要的防雷措施，具体措施有：将各机柜、设施和设备等通过接地系统安全接地。采取措施防止感应雷，例如设置防雷保安器或过压保护装置等。 
防火防火工作关乎生命和财产安全，是物理安全防护的重要内容，具体措施有：设置火灾自动消防系统，能够自动检测火情、自动报警，并自动灭火。机房及相关的工作房间和辅助房应采用具有耐火等级的建筑材料。对机房划分区域进行管理，区域和区域之间设置隔离防火措施。定期检查和维护防火系统。 
防水和防潮采取必要的防水和防潮措施，避免机房设备、设施因水患或潮湿威胁发生故障，具体措施有：采取措施防止雨水通过机房窗户、屋顶和墙壁渗透。采取措施防止机房内水蒸气结露和地下积水的转移与渗透。安装对水敏感的检测仪表或元件，对机房进行防水检测和报警。湿度较高的地区，安装除湿装置并正常运行。 
防静电静电对电子设备的危害较大，采取如下措施避免静电的发生：采用防静电地板或地面并采用必要的接地防静电措施。采用静电消除器、佩戴防静电手环等措施防止静电的产生。 
温湿度控制理想的空气湿度范围被定义在40-70%，高的湿度可能会在天花板、墙面及设备表面形成水珠，造成危害，甚至还可能产生电连接腐蚀问题。低于40%的低湿度增加了静电产生的危害。温度控制在20℃左右是设备正常工作的良好温度条件。应设置温湿度自动调节设施，使机房温湿度的变化在设备运行所允许的范围之内。 
电力供应持续、稳定的电力供应是维持信息系统持续正常工作的必要条件。一方面，外界因素的干扰造成的电力波动将对一些精密的电子配件造成严重物理损害；另一方面，电力供应的意外中断会造成设备无法正常工作。因此，应采取必要的措施避免电力中断对系统造成的影响：在机房供电线路上配置稳压器和过电压防护设备。提供短期的备用电力供应，至少满足设备在断电情况下的正常运行要求。设置冗余或并行的电力电缆线路为计算机系统供电。 
电磁防护电子设备的电磁辐射不仅会导致设备之间的互相干扰，也可能造成重要数据的信息泄露。一些线路铺设和设计的不合理也可能造成电磁耦合与干扰，造成数据传输错误。为避免这些电磁辐射和干扰所带来的危害，应当采取必要的屏蔽或抗干扰措施：电源线和通信线缆应隔离铺设，避免互相干扰。对关键设备实施电磁屏蔽。 
环境管理安全要确保机房的运行环境良好和安全，应指定专门的部门或人员定期进行设施设备的维护管理，建立机房安全管理制度，规范环境人员行为等，具体包含：机房内部员工都应佩戴明显的、可视的身份识别证明，并应主动向无内部员工陪伴的陌生人和未佩戴可视标志的人员提出质疑。制订机房工作规章制度，对在此区域内工作的人员及被授权进入此区域的其他人员加强管理。工作规章制度可采取以下控制措施：明确基本安全原则。落实机房区域内资产保护的责任。出于安全原因和防止恶意破坏，机房内应避免不受监督的工作。第三方支持人员应仅在需要时才能进入机房，使用信息处理设施。这种访问必须经过授权并受到相应的限制，同时应接受监督。除非经过授权，否则不允许使用摄影、摄像、音频、视频及其他记录设备。明确紧急情况下的处理措施，例如火灾等。落实机房基础设施的定期维护保养制度和责任人。 
 说明： 
有关物理环境安全的具体建设项目，不在本文的描述范畴之内，通常由IDC的建设和运维方来提供。 
### 个人数据保护设计 
个人数据（Personal Data）是指与已识别或者可识别的自然人（数据主体）相关的任何数据。可识别的自然人是指尤其通过姓名、身份证号、定位数据、网络标识符号以及特定的身体、心理、基因、精神状态、经济、文化、社会身份等识别符，能够被直接或间接识别到身份的自然人。 
5G网络中的个人数据可以包含： 
身份标识保护：包含临时身份标识、永久身份标识、设备身份标识、网络切片标识等身份标识。 
位置信息：例如5G TAI、小区ID等，需要能够防止通过位置信息分析和预测用户轨迹。 
服务信息：包括用户使用的服务类型、服务内容等5G通信内容。 
在通讯网络和大数据、云计算等技术高速发展的背景下，越来越多的个人数据通过网络来采集、存储、传输、使用。为了保护这些重要数据的安全，全球主要国家和地区陆续颁布了一批数据保护领域的法律法规，如欧盟《通用数据保护条例》（GDPR），美国《2018加州消费者隐私法案》、中国《网络安全法》。对于中兴通讯来说，个人数据保护不仅仅是法律要求，更是公司合规治理和安全管理的重要一环。
#### 个人数据保护基本原则 
中兴通讯将欧盟GDPR作为整体合规的遵循基准，适度吸纳各国的属地化监管要求，最大限度地确保“一次导入，全球适用”。在个人数据保护方面，遵循以下原则：
合法、公平和透明：合法、公平地并且以透明的方式处理个人数据。 
目的限制：收集个人数据应当基于具体、明确、合法的目的，且不应以与此目的相违背的方式进行处理。 
最小范围：处理的个人数据应与处理数据的目的是适当、相关且必要的。 
准确性：个人数据应当是准确的，并在必要的情况下及时更新；根据数据处理的目的，采取合理的措施确保及时删除或更正错误数据。 
存储限制：存储个人数据不得超过处理目的所必要的期限。 
完整性和保密性：采取必要的技术或组织措施确保个人数据安全。 
可追责：应当对上述原则的落实情况承担责任并予以证明。 
#### 个人数据保护实施策略 
遵循GDPR的要求，中兴将隐私保护设计（Privacy by Design，PbD）流程嵌入5G系统产品的HPPD研发流程中。在个人数据处理全过程中，PbD实施策略如[图1](d0e4679.html#d0e4679__%E4%B8%AA%E4%BA%BA%E6%95%B0%E6%8D%AE%E4%BF%9D%E6%8A%A4PbD%E7%9A%84%E5%AE%9E%E6%96%BD%E7%AD%96%E7%95%A5-48EB49DA)所示。
图1  个人数据保护PbD的实施策略
[pbD实施策略]images/image30.png)
各实施策略说明如下： 
最小化：要求数据收集和处理尽可能限定在最小限度和最低频次之内，这是最核心的设计策略。通过确保没有数据或没有多余的数据被收集和处理，系统对于个人信息的影响将受到最大程度的限制。此外，必须要确保系统收集的数据与其目的相当。 
隐藏：要求系统收集的所有数据以及彼此之间的联系都应当进行隐藏处理，以便让数据具备不可链接性和不可观察性，进而避免被滥用的可能。例如，将数据“年龄：27”改为数据“年龄：25～35”。 
分离：要求数据尽可能以一种分散、分区域的方式来储存和处理。通过对同一用户不同来源的数据进行分离储存和处理，增加获取用户完整画像的难度。实践中，不同来源的数据应当存储在不同数据库中，并且彼此之间不存在链接关系。所有的数据都应尽可能本地化处理和储存，数据库列表应尽可能地分割，以便让数据之间很难建立联系。 
聚合：指数据在保证可用性的前提下，应尽可能以高度聚合形态来处理，以便将数据细节模糊化。通过将不同性质或不同群体的数据聚合在一起，可以有效限制数据的细节信息，让数据变得不那么敏感。当数据足够粗粒状，涵盖的群体足够大的话，特定用户的数据被暴露的可能性就越小。例如，将18～24岁的值与24～30岁的值聚合为18～30岁的值。差分隐私是一种典型的聚合技术。 
通知：指系统应当通知用户有关数据收集和处理的目的、方式、范围等信息。当数据被第三方分享时，用户也应得到通知。此外，系统还应通知用户对于收集的数据享有何种权利以及如何行使这些权利。 
控制：指用户有权控制自己个人信息的收集、处理和流转。法律规范通常会赋予用户查阅、更新、删除个人信息等权利，而控制策略就是要突出用户享有的这些权利，并要求系统的设计应当有助于用户行使这些权利。 
执行：要求企业应当依据个人信息保护法律规范制定适当的隐私政策，采取措施执行这些政策。隐私政策的执行可以立足于企业实际情况，但不得低于个人信息保护法律规范的要求。 
展示：指企业需要展示个人信息保护法律规范以及制定的隐私政策是如何得到遵守的。 
通过体系化建设，中兴通讯建立了覆盖核心业务脉络的数据保护合规指引和标准规范，并严格执行公司适用的规范和流程；签署了符合GDPR要求的数据处理协议（DPA）、标准协议条款（SCC，数据跨境转移）并辅以《通知函》、《授权函》等；嵌入了加密、匿名化、假名化等安全技术，双因素认证、权限管理、访问监测等安全措施，支撑个人数据在采集、存储、使用、传递、销毁等环节的数据保护和安全防护。 
#### 个人数据保护方案 


5G产品中涉及的个人数据如下： 



 
用户标识以及其他签约信息：SUPI/SUCI/IMSI、IMEI、MS-ISDN、5G-GUTI/TMSI、其他签约数据、策略配置信息等。 

 
用户位置信息：LAI、CI等。 

 
用户IP地址：UE IP。 

 
用户通信数据：用户的通信信息（包含与DN网络交互的所有信息）、CDR等。 

 
用户账号信息：运维用户的账号信息，包含用户名、口令、证书等信息。 

 


##### 5G NR涉及的个人数据及保护措施 
5G NR涉及个人数据处理的功能点以及保护措施参见[表1](d0e4717.html#d0e4717__GNR%E6%B6%89%E5%8F%8A%E4%B8%AA%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%8F%8A%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD-48F3B24B)。
功能点|数据类型|采集|传输|存储|使用|销毁|风险分析
---|---|---|---|---|---|---|---
空口业务处理|SUPI、IMSI、LAI、UE IP|不采集只转发|基站和终端间按3GPP规定的加密（可选）和完保。基站和核心网之间走IPSec隧道（可选）。|不涉及|不涉及|不涉及|3GPP对空口消息加密和完保支持Null算法，此时空口消息实际是明文，容易被侦听泄漏。
空口业务处理|5G-GUTI/TMSI|不采集只转发|基站和终端间按3GPP规定的加密（可选）和完保。基站和核心网之间走IPSec隧道（可选）。|不涉及|不涉及|不涉及|5G-GUTI/TMSI是临时分配标识，用户每次呼叫都会更新，无隐私泄露风险。
空口业务处理|SUCI|不采集只转发|基站和终端间按3GPP规定的加密（可选）和完保。基站和核心网之间走IPSec隧道（可选）。|不涉及|不涉及|不涉及|SUCI本身已经做了加密处理，无隐私泄露风险。
业务优化|UE IP|采集功能开启有开关控制，要授权才能开启|只在模块内部使用，不传输|临时存储在内存，用户连接释放后删除|模块内部解析数据时使用，无控制手段|UE下线后自动删除|采集和存储用户临时IP，一段时间内有隐私泄露风险，用户释放后IP地址即失效。
空口用户面处理|用户通信数据|不采集只转发|基站和终端间按3GPP规定的加密（可选）和完保。基站和核心网之间走IPSec隧道（可选）。|不涉及|不涉及|不涉及|可选功能。如不部署，会有泄露风险。
信令跟踪|SUPI、IMSI、LAI、UE IP、SUCI、5G-GUTI/TMSI|脱敏（对NAS消息置0）|TLS安全传输|不涉及|不涉及|不涉及|采集时就已经对个人信息做了脱敏处理，无隐私泄露风险。


##### 5GC涉及的个人数据及保护措施 
5GC涉及个人数据处理的功能点以及保护措施参见[表2](d0e4717.html#d0e4717__GC%E6%B6%89%E5%8F%8A%E7%9A%84%E4%B8%AA%E4%BA%BA%E6%95%B0%E6%8D%AE%E5%8F%8A%E4%BF%9D%E6%8A%A4%E6%8E%AA%E6%96%BD-48F3F659)。
功能点|数据类型|采集|传输|存储|使用|销毁|风险分析
---|---|---|---|---|---|---|---
NAS信令消息处理|SUPI、IMSI、MS-ISDN、LAI、UE IP|通过标准接口获取|UE和AMF间按3GPP规定的加密（可选）和完保。5GC内部TLS传输（可选）。|临时存储在内存，用户连接释放后删除|模块内部使用，无控制手段|用户下线后删除数据区内容|加密功能不开启时，消息实际是明文，容易被侦听泄漏。
NAS信令消息处理|IMEI|通过标准接口获取|按3GPP规定，IMEI必须加密处理（紧急呼叫除外）。|临时存储在内存，用户连接释放后删除|模块内部使用，无控制手段|用户下线后删除数据区内容|IMEI总是加密传输，无风险。
NAS信令消息处理|5G-GUTI /TMSI|通过标准接口获取|UE和AMF间按3GPP规定的加密（可选）和完保。5GC内部TLS传输（可选）。|临时存储在内存，用户连接释放后删除|模块内部使用，无控制手段|用户下线后删除数据区内容|5G-GUTI/TMSI是临时分配标识，用户每次呼叫都会更新，无隐私泄露风险。
NAS信令消息处理|SUCI|通过标准接口获取|UE和AMF间按3GPP规定的加密（可选）和完保。5GC内部TLS传输（可选）|临时存储在内存，用户连接释放后删除|模块内部使用，无控制手段|用户下线后删除数据区内容|SUCI本身已经做了加密处理，无隐私泄露风险。
紧急呼叫流程处理|SUPI、IMSI、MS-ISDN、IMEI|通过标准接口获取|无控制手段。|临时存储在内存，用户连接释放后删除|模块内部使用，无控制手段|用户下线后删除数据区内容|3GPP定义如此。
N3消息处理|用户的通信数据|不采集只转发|5GC和基站之间走IPSec隧道（可选）。|不涉及|模块内部使用，无控制手段|不涉及|IPSec可选，如不部署会有泄漏风险。
CDR的生成和处理|CDR|通过标准接口获取|5GC内部TLS传输（可选）。CG与第三方计费系统通过SFTP传输。|SMF与CG断链时会在本地加密缓存。CG对CDR做匿名化处理后存储|模块内部使用，无控制手段|SMF在链路恢复后将缓存CDR传输给CG并删除本地文件。CG定期删除CDR文件|如果TLS不启用，会有泄漏风险，但5GC整体处于信任区域，风险低。
N32接口消息处理|SUPI、IMSI|通过标准接口获取|通过SEPP实现PLMN间的安全传输。|不涉及|通过SEPP做认证和访问控制|不涉及|按照3GPP规定做保护，无风险。
处理用户签约流程|SUPI、IMSI、MS-ISDN等所有用户签约数据|通过标准接口获取|与受理台之间通过HTTPS等加密通道。|Ki等敏感信息本地加密存储N+k备份机制|模块内部使用，无控制手段|销户时删除|关键数据安全处理，风险低。
网管配置数据|用户权限等关信息|通过客户端配置|网管客户端与服务器间通过加密通道。|不涉及|基于角色的权限控制|网元删除时销毁|存储不加密时，有泄漏风险。
网管性能数据|SUPI、IMSI|通过客户端配置|网管客户端与服务器间通过加密通道。|加密存储|基于角色的权限控制|客户按需删除|存储不加密时，有泄漏风险。只有一个统计功能涉及个人数据，可以不启动该统计项。
网管用户账号信息|用户名|通过客户端配置|网管客户端与服务器间通过加密通道。|加密存储|基于角色的权限控制|销户时删除|存储不加密时，有泄漏风险。
网管用户账号信息|用户密码|采集时使用散列/加密等算法进行敏感信息安全防护|网管客户端与服务器间通过加密通道。|不可逆加密|基于角色的权限控制|销户时删除|用户密码全程非明文，不存在泄漏风险。
信令跟踪、失败观察流程|SUPI、IMSI、MS-ISDN|采集时使用散列/加密等算法进行敏感信息脱敏|网管客户端与服务器间通过加密通道。|关键信息脱敏|基于角色的权限控制|定期删除|采集时已经做了加密处理，不存在泄漏风险。
用户查询流程|SUPI、IMSI、IMEI|通过客户端输入|网管客户端与服务器间通过加密通道。|关键信息脱敏|基于角色的权限控制|不涉及|运维人员员有需要时使用，会有风险。
配置备份数据|网元配置|定期备份|网管客户端与服务器间通过加密通道。|加密存储|基于角色的权限控制|客户按需删除|备份文件已加密，无风险。
网管审计日志|运维用户的账号信息、操作信息等|模块自动生成|网管客户端与服务器间通过加密通道。|关键信息脱敏|基于角色的权限控制|客户按需删除|存储不加密时，有泄漏风险。
网管调试日志|SUPI、IMEI、MS-ISDN|模块自动生成|网管客户端与服务器间通过加密通道。|关键信息脱敏|基于角色的权限控制|客户按需删除|存储不加密时，有泄漏风险。


## 集中安全管控 
依据ISO27001、ISO17799中的技术及管理要求，在5G网络系统中，应部署集中的安全管控区域。这个区域主要是对5G网络及IDC机房设备的安全管理，通过管理平面来连接到各个安全设备、网络设备、主机、存储等网元的管理面上。
具体提供的管控功能有： 
4A接入管控：对接运营商的4A系统，提供对内部管理人员和第三方维护人员集中的身份管理与访问控制，对人员行为进行全面的记录和审计，对所有操作做到事前防范、事中控制、事后审计的能力。 
SIEM：包括安全事件管理、日志采集与审计、流量采集与审计、安全态势分析等功能，对物理访问、系统访问、业务操作等各类日志信息和所有安全事件信息进行统一分析审计，具备事后追查能力。 
防病毒管理：对主机以及运维终端提供集中的防病毒管理功能，对防病毒策略做统一管控，提供病毒库统一升级服务等。 
安全基线控制：应定期进行安全配置核查、系统漏洞扫描和Web漏洞扫描。对发现的脆弱性问题进行分析和安全加固，对安全漏洞及时进行修补；至少每半年对服务器等进行漏洞扫描，对高危漏洞应及时修补。 
远程运维管理：对远程接入的运维终端提供网络准入、接入认证、访问控制、传输加密等功能。 
终端安全管理：对接入系统的PC终端做集中地安全管控，包含终端准入、终端安全管理、终端资产管理以及行为审计等功能。 
### 4A接入管控 
运营网络中有大量的IT资产，主机、网络设备、安全设备、数据库、云平台、各网元功能、IT业务系统等，设备规模庞大且种类繁多，运维操作也复杂，随着运维人员数量的增加，权限管理任务也会越来越重，同时运维人员还经常需要在各个系统之间切换，每次访问资源时，还需要详细的操作审计过程，便于事后责任追溯。 
为了解决这些问题，通常会在网络中部署统一的4A管控平台，为网络中的各类资产提供准确的组织人员数据，并可以高效、方便的进行账号数据安全管理。实现网络设备、主机系统、数据库、云平台以及网元层面的集中的帐号管理、集中认证、集中授权和集中审计（AAAA）。 
#### 4A管控功能 


4A管控平台的功能主要有： 



 
集中的账号管理：对运营商内部人员、第三方运维人员、设备厂商维护人员等所有账号的全生命周期身份管理服务，提供完整、统一且权威的身份数据源，实现所有主账号、从账号的自动代维。 

 
集中认证：对运营商内部人员、第三方运维人员、设备厂商维护人员等统一的身份认证和单点登录服务，具体实现内容包括主帐号的认证服务、应用资源和系统资源的从帐号单点登录认证服务。 

 
细粒度授权：提供实体及细粒度的权限控制，对高危命令、敏感数据做到操作管控和临时授权。 

 
安全审计：对各类资源的登录、配置、操作等详细的记录并传送到4A管控平台，为监测和处理安全事件提供有效的工具。 

 


#### 4A接入部署 
5G网络中的各类存在人机操作界面的系统，包括所有硬件设备的管理口、云计算平台、MANO、EMS、Host OS、VNF的网管模块都需要接入4A安全管控系统；统一纳入4A进行集中管理，实现运维管理的规范化和可视化，对网络的各项运维操作做到可管、可控、可审计，避免不正常渠道的非法访问，同时缩减网络对外暴露面，规避内外部维护人员的异常操作风险。
具体部署如[图1](d0e5737.html#d0e5737__09198f0c-f8da-412c-94c4-bd1a8b2ad7a4)所示，在各管理域部署4A安全管控前置机。前置机作为4A管控平台的执行代理，与后台的4A中心交互，实现对资源访问的统一安全认证服务，实现资源的认证集中控制，保障资源的访问安全性，对所有操作进行记录并上报到4A中心，提供集中的安全审计。
图1  4A接入控制
[???]images/image31.png)
### 安全信息事件管理（SIEM） 
SIEM是Security Information Event Management的缩写，即安全信息事件管理平台。 
5G SIEM面向电信运营商领域实现5G场景下的SIEM功能深度定制和实现，包括资产、安全数据的收集、聚合、分析关联、联动处置和安全态势展现等功能。5G SIEM作为构建5G网络安全体系的核心产品支撑运管体系，共同助力运营商构建出具备内生安全能力的5G网络。 
#### SIEM功能特性 
SIEM的功能主要有： 
资产信息盘点：通过对MANO、EMS接口及主机Agent、设备及流量日志等多种采集方式全面采集5G网络中的切片、网元、管理系统、基础软件、应用框架、中间件、网络服务等资产相关信息并建立基础设施层、切片层、网元层等各层资产关联关系，实现统一的多维度资产盘点和管理服务。 
5G漏洞库管理：基于公开的漏洞源或合作方漏洞信息，结合5G资产相关的系统、应用软件、中间件等信息建立5G资产定制化漏洞库，并具备漏洞信息的导入、更新、删除等基础功能。 
脆弱性资产发现：SIEM分析层实现资产指纹数据的分析功能，结合漏洞库、安全事件日志信息实现脆弱性资产、异常资产的发现，对漏洞影响网元、切片、基础设施等范围评估分析，对高价值资产和高危漏洞告警，并实时更新全网资产风险状态。 
异常流量检测：集成自研高级可持续威胁检测系统并基于5G核心网定制和适配，对控制面信令及用户面业务流量进行基于流量指纹特征、基于基线模型特征、基于机器学习和深度学习模型特征的分析，实现流量安全事件的实时发现和预警。 
系统安全分析：能通过网元日志、网管日志、主机系统日志、安全设备日志及漏洞扫描结果数据，分析网元系统、主机系统和业务系统的安全情况。分析类型包括异常鉴权检测、系统提权检测、错误日志检测等，事件类型包括不限于漏洞利用分析、基线合规分析、弱口令分析等。 
安全态势分析：支持对资产的安全状况进行分析，包括已发现的资产安全事件威胁及脆弱性信息，对网络攻击态势进行关联分析，预测以位置、切片、网元、组件、虚机等多角度画像并进行丰富的大屏趋势展示，详细信息展示威胁目标资产、攻击来源、攻击类型、攻击事件等。 
#### 组网部署 
图1  SIEM组网设计
[???]images/image32.png)
5G SIEM部署在运营商网络管理域或根据运营商要求部署在独立的安全域中。 
北向与运营商SOC/态势感知系统对接，满足运营商安全监管需求，屏蔽敏感信息对外暴露。 
南向与中兴通讯的EMS、MANO、网元、主机Agent、安全设备等对接。 
支持独立物理服务器部署、基于TECS的预置虚机节点部署，或支持MANO统一安全模块。 
#### 架构和原理 
图1  SIEM产品架构
[???]images/image33.png)
业务层：主要是针对分析后的结果做可视化直观的呈现，建立全网络安全态势感知。该层主要包含的功能有威胁告警、态势感知、溯源取证、统计报表、资产管理、工单处理等。通过可视化技术直观呈现当前全局网络安全态势，让全网安全态势可知可见可控。 
分析层：主要实现对各种数据的深入加工处理，包括运行监控、安全分析、关联分析、脆弱性管理等。并利用关联分析引擎以AI算法基线模型等提供多种技术手段实现高级威胁检测。 
数据采集层：完成全量数据的集中采集、处理、存储，为上层数据分析层提供数据分析基础，同时采用ES、HBase等大数据分布式存储架构实现对海量数据的全量存储和平滑的数据扩容。主要实现数据采集及数据清洗、结构化、数据存储等功能。 
#### 技术实现 
数据源采集：多数据源多方位日志采集，通过EMS接口、MANO/VIM接口、主机Agent方式对包括5G全网资产信息、网元安全日志、安全设备日志等全面采集。 
资产安全管理：通过EMS、MANO等多信息源进行资产获取和关联，分析资产间的业务关系，并进行基于业务的安全风险分析实时感知资产安全态势。 
安全分析：同时对5G切片网络的网元和设备日志及基于5G信令和业务流量的威胁检测分析，实现5G网络端对端威胁关联分析。 
响应处置：北向与运营商SOC工单系统对接，南向与EMS、MANO、VIM系统对接，实现安全策略的联动和安全业务编排，快速完成威胁事件的应急处置。 
### 安全基线控制 
安全基线是网络安全最基本的保证，做好安全基线配置和加固是5G网络安全运维工作中很基础的工作。应从安全漏洞基线、安全配置基线两方面着手，定期进行全面的检测和评估，对发现的问题进行加固整改。 
安全基线主要包括安全漏洞基线和安全配置基线两部分。 
#### 安全漏洞管理 
近年来，利用安全漏洞进行网络攻击的安全事件数量日益上升，重大漏洞致使信息系统遭受前所未有的灾难。随着技术的不断发展，漏洞发掘的水平和速度一直在提高，而漏洞的利用技术也一直在发展。5G网络中使用了大量的通用基础设施和开源组件，应制定严格的漏洞管理和补丁更新流程，并落实到日常安全运维活动中。 
中兴通讯将安全作为产品研发和服务交付活动中最高优先级之一，产品发布前均经过严格的白盒测试、漏洞扫描和病毒检测，确保产品交付安全，无任何高危漏洞。在产品运行期，在网络环境日益复杂、安全威胁层出不穷的情况下，运维人员应通过专业的漏洞扫描和分析平台，定期对系统中的主机、云平台、数据库、Web系统等进行全面的漏洞扫描和脆弱性分析，并对发现的安全漏洞进行及时的修补。 
漏扫平台可以采用分布式的部署方式，在集中安全管控区部署漏洞管理控制中心，在各个扫描区域部署漏洞扫描引擎。管控中心实现扫描策略的统一下发，扫描结果的集中分析以及漏洞库更新等功能。通过各扫描引擎实现对分布在5G网络中的各主机、云平台、数据库、Web系统等资产的漏洞及时发现和管理。 
系统漏洞管理在5G网络中部署系统漏洞扫描引擎，以发现操作系统、数据库、中间件等基础软件的漏洞情况，配置扫描任务进行定期扫描，汇总结果并上报高风险漏洞预警。系统漏洞扫描引擎部署在每个资源池的管理域，周期性或按需对各个网元的管理模块进行扫描，同时周期性或按需对所有硬件设备的管理口、MANO、EMS、Host
OS进行扫描；系统漏洞扫描引擎通过管理平面接入集中安全管控区的漏洞扫描平台，以实现漏洞的及时更新、扫描策略的定制下发等。 
Web漏洞管理通过Web漏洞扫描系统，对于具有Web页面的管理类网元（VIM、VNFM、GSO、EMS）、网元的管理模块、组网设备管理口、以及DMZ资源池中部署的能力开放Portal等，进行监测和防护。Web漏扫引擎部署在每个资源池的管理域，负责管理类网元、网元的管理模块及组网设备管理口的Web漏洞扫描；对于DMZ区，建议单独部署Web漏扫引擎，所有的Web漏扫引擎统一接入集中安全管控区的漏洞扫描平台，以实现漏洞的及时更新、扫描策略的定制下发等。 
#### 安全配置基线 
主机操作系统、Web应用服务器、数据库等系统软件均具备强大的自身安全功能，但默认安装一般不会开启，需要进一步进行安全配置。安全配置包括系统的账号口令、授权、审计等方面的安全管理配置，以及系统运行过程中的网络端口状态、进程状态、服务运行状态、账号状态以及重要文件状态等配置。 
安全配置问题反映了系统在上线过程和运维过程中人为因素造成的脆弱性，应当通过基线控制来进行规避。安全运维人员应定期对系统的各项安全配置进行检查和加固，内容应至少包括以下： 
最小化服务：遵循安全最小化原则，关闭未使用的服务组件和端口。 
服务加固：对SSH、Xinetd等常用服务进行安全加固；禁止对0.0.0.0（本机所有IP）启动监听，如有必要启用，应进行说明（比如在产品手册中描述使用0.0.0.0的场景）。 
内核参数调整：修改内核参数，增强操作系统安全性。如有条件禁用IP转发，有条件禁止响应ping请求，禁止接受/转发ICMP重定向消息，禁止使用core
dump，禁止CTRL+ALT+DEL重启系统，但内核oops后应支持系统自动重启。 
文件目录权限设置：结合业界加固规范及应用要求，保证文件权限最小化。 
帐号口令安全：删除无用账号，启动口令复杂度、密码有效期、登录失败重试次数等检查。 
系统认证和授权：禁止root远程登录，尽量不用root账号安装运行进程，禁止空密码用户。普通用户切换为root（su）用户，需要输入密码。 
数据库：配置连接数据库的白名单列表，删除数据库无用账号。 
数据库：仅安装必需的数据库组件，并及时更新补丁。 
数据库：严格控制数据库操作权限，如敏感数据表的操作权限、访问行数等的控制，以及限制“无条件”查询，避免大规模数据篡改及泄露。 
中间件：各种异常界面替换或重新设定，防止系统信息泄露。 
中间件：中间件版本/补丁及时更新。 
中间件旗标（软件名/版本号等）修改，防止系统信息泄露。 
日志和审计：记录服务、内核进程运行日志，可以与日志服务器对接，可部署专业的数据库审计设备，对各种SQL操作进一步解析并记录审计。 
可以通过部署专业的安全配置核查系统来实现自动化检测。 
## 参考规范 


编号|名称
---|---
YD/T xxx|移动通信网络设备安全保障通用要求
3GPP TS 33.501|5G系统安全架构和流程（Security architecture and proceduresfor 5G system）
3GPP TS 33.926|3GPP网络设备安全保障要求威胁和重要资产（Security Assurance Specification(SCAS) threats and critical assets in 3GPP network product classes）
3GPP TR 21.905|3GPP规范词汇表（Vocabulary for 3GPP Specifications）
3GPP TS 33.310|网络域安全性（NDS）; 认证框架（AF）（Network Domain Security(NDS); Authentication Framework (AF)）
3GPP TS 23.501|5G系统架构（System Architecture for the 5G System）
3GPP TS 33.401|3GPP系统架构演进; 安全架构（3GPP System Architecture Evolution(SAE); Security architecture）
3GPP TS 33.926|3GPP网络设备安全保障要求威胁和重要资产（Security Assurance Specification(SCAS) threats and critical assets in 3GPP network product classes）
3GPP TS 33.102|3G安全：安全架构（3G security; Security architecture）
3GPP TS 33.117|通用安全保证要求目录（Catalogue of general security assurancerequirements）
3GPP TS 33.122|用于3GPP北向API的通用API框架的安全性方面（Security Aspectsof Common API Framework for 3GPP Northbound APIs）
3GPP TS 33.210|3G安全;网络域安全（NDS）; IP网络层安全（3G security; NetworkDomain Security (NDS); IP network layer security）
3GPP TS 33.220|通用认证架构（GAA）;通用引导架构（GBA）（Generic AuthenticationArchitecture (GAA); Generic Bootstrapping Architecture (GBA)）
3GPP TS 33.310|网络域安全性（NDS）; 认证框架（AF）（Network Domain Security(NDS); Authentication Framework (AF)）
3GPP TS 33.402|3GPP系统架构演进（SAE）; 非3GPP接入的安全方面（3GPP System ArchitectureEvolution (SAE); Security aspects of non-3GPP accesses）
3GPP TS 35.215|3GPP机密性和完整性算法UEA2和UIA2的规范; 文档1：UEA2和UIA2规范（Specificationof the 3GPP Confidentiality and Integrity Algorithms UEA2 & UIA2;Document 1: UEA2 and UIA2 specifications）
IETF RFC 3748|可扩展认证协议（EAP）（Extensible Authentication Protocol(EAP)）
IETF RFC 4187|用于第三代认证和密钥协商的可扩展认证协议方法（EAP-AKA）（ExtensibleAuthentication Protocol Method for 3rd Generation Authentication andKey Agreement (EAP-AKA)）
IETF RFC 4279|用于传输层安全（TLS）的预共享密钥密码组件（Pre-Shared Key Ciphersuitesfor Transport Layer Security (TLS)）
IETF RFC 4282|网络接入标识符（The Network Access Identifier）
IETF RFC 4301|Internet协议安全结构（Security Architecture for theInternet Protocol）
IETF RFC 4303|IP封装安全负载（ESP）（IP Encapsulating Security Payload(ESP)）
IETF RFC 4346|传输层安全（TLS）协议版本1.1（The Transport Layer Security(TLS) Protocol Version 1.1）
IETF RFC 5216|EAP-TLS认证协议（The EAP-TLS Authentication Protocol）
IETF RFC 5246|传输层安全（TLS）协议版本1.2 （The Transport Layer Security(TLS) Protocol Version 1.2）


# 缩略语 
# 缩略语 
## 3GPP 
3rd Generation Partnership Project第三代合作伙伴计划
## 4A 
Account, Authorization, Authentication, Audit认证、账号、授权、审计
## 5GC 
5G Core Network5G核心网
## ACL 
Access Control List访问控制列表
## AES 
Advanced Encryption Standard高级加密标准
## AF 
Application Function应用功能
## AKA 
Authentication and Key Agreement鉴权和密钥协商
## AMF 
Access and Mobility Management Function接入和移动管理功能
## API 
Application Programming Interface应用编程接口
## APP 
Application应用
## AR 
Augmented Reality增强现实
## AUSF 
Authentication Server Function鉴权服务器功能
## BGP 
Border Gateway Protocol边界网关协议
## BIOS 
Basic Input/Output System基本输入/输出系统
## BMC 
Baseboard Management Controller主板管理控制器
## BSS 
Business Support System业务支撑系统
## CCC 
China Compulsory Certificate中国强制性产品认证制度
## CDMA 
Code Division Multiple Access码分多址
## CDR 
Call Detail Record呼叫详细记录，即话单
## CE 
CONFORMITE EUROPENDE欧洲合格认证的简称
## CI 
Cell Identity小区标识号
## CMF 
Charging Management Function计费管理功能
## COTS 
Commercial Off The Shelf商用货架产品
## CU 
Centralized Unit集中式单元
## DC 
Data Center数据中心
## DDoS 
Distributed Denial of Service分布式拒绝服务
## DMZ 
Demilitarized Zone隔离区
## DSCP 
Differentiated Services Code Point差分服务编码点
## DU 
Distributed Unit分布式单元
## E2E 
End-to-End终端到终端
## ECC 
Error Check and Correction错误检查和纠正
## eMBB 
Enhanced Mobile Broadband增强移动宽带
## EMS 
Element Management System网元管理系统
## FCC 
Federal Communication Commission联邦通信委员会（美国）
## FlexE 
Flex Ethernet灵活以太网
## FTP 
File Transfer Protocol文件传输协议
## GDPR 
General Data Protection Regulation通用数据保护条例
## GRE 
General Routing Encapsulation通用路由封装
## GSO 
Global Service Orchestrator全局业务编排器
## GTSM 
Generalized TTL Security Mechanism通用TTL安全保护机制
## GUTI 
Globally Unique Temporary Identity全球唯一临时标识
## IDC 
Internet Data Center互联网数据中心
## IEEE 
Institute of Electrical and Electronics Engineers电气与电子工程师学会
## IGMP 
Internet Group Management Protocol因特网组播管理协议
## IMEI 
International Mobile Equipment Identity国际移动设备标识
## IMSI 
International Mobile Subscriber Identity国际移动用户标识
## IO 
Input &
Output输入输出
## IP 
Internet Protocol因特网协议
## IPSec 
IP Security ProtocolIP安全协议
## ISDN 
Integrated Services Digital Network综合业务数字网
## ISO 
International Organization for Standardization国际标准化组织
## IT 
Information Technology信息技术
## LAI 
Location Area Information移动台位置信息
## LDP 
Label Distribution Protocol标记分发协议
## LRDIMM 
Load Reduced Dual Inline Memory Module低负载双列直插内存模块
## LTE 
Long Term Evolution长期演进
## MAC 
Media Access Control媒介接入控制
## MANO 
Management and Orchestration管理和编排
## MEC 
Mobile Edge Computing移动边缘计算
## MEP 
MEC Platform多接入边缘计算平台
## mMTC 
Massive Machine Type Communication海量机器类通信
## MS 
Mobile Station移动台
## NAS 
Network Access Service网络接入服务
## NE 
Network Element网络单元（网元）
## NEF 
Network Exposure Function网络开放功能
## NF 
Network Function网络功能
## NFV 
Network Functions Virtualization网络功能虚拟化
## NFVI 
Network Functions Virtualization Infrastructure网络功能虚拟化基础设施
## NFVO 
Network Functions Virtualization Orchestrator网络功能虚拟化编排器
## NR 
New Radio新无线
## NRF 
NF Repository Function网络仓储功能
## NS 
Network Service网络服务
## OFDMA 
Orthogonal Frequency Division Multiple Access正交频分多址接入
## OSS 
Operation Support System运营支撑系统
## PC 
Personal Computer个人电脑
## PCF 
Policy Control Function策略控制功能
## QoS 
Quality of Service服务质量
## RADIUS 
Remote Authentication Dial In User Service远端鉴权拨号用户服务
## RAID 
Redundant Array of Independent Disks独立冗余磁盘阵列
## RAN 
Radio Access Network无线接入网
## RAT 
Radio Access Technology无线接入技术
## RDIMM 
Registered Dual Inline Memory Module带寄存器的双列直插内存模块
## RIP 
Routing Information Protocol路由信息协议
## SBA 
Service Based Architecture基于服务的架构
## SBI 
Service Based Interface基于服务的接口
## SDN 
Software Defined Network软件定义网络
## SFTP 
Secure File Transfer Protocol安全文件传输协议
## SMF 
Session Management Function会话管理功能
## SQL 
Structured Query Language结构化查询语言
## SSH 
Secure Shell安全外壳协议
## SUCI 
Subscription Concealed Identifier签约的隐藏标识符
## SUPI 
Subscriber Permanent Identifier用户永久标识
## TACACS 
Terminal Access Controller Access Control System终端访问控制器访问控制系统
## TCM 
Trusted Cryptography Module可信密码模块
## TCP 
Transmission Control Protocol传输控制协议
## TD-SCDMA 
Time Division-Synchronization Code Division
Multiple Access时分同步码分多址接入
## TLS 
Transport Layer Security传输层安全
## TMSI 
Temporary Mobile Subscriber Identity临时移动用户识别码
## TPM 
Trusted Platform Module可信平台模块
## UDM 
Unified Data Management统一数据管理
## UE 
User Equipment用户设备
## UL 
Underwriters Laboratories美国保险商实验所安全标准
## UPF 
User Plane Function用户平面功能
## URLLC 
Ultra Reliable Low Latency Communication超高可靠超低时延通信
## USB 
Universal Serial Bus通用串行总线
## VDC 
Virtual Data Center虚拟数据中心
## vFW 
virtual Firewall虚拟防火墙
## VIM 
Virtualized Infrastructure Manager虚拟化基础设施管理系统
## VLAN 
Virtual Local Area Network虚拟局域网
## VNF 
Virtualized Network Function虚拟化网络功能
## VNFM 
Virtualized Network Function Manager虚拟化网络功能管理器
## VPN 
Virtual Private Network虚拟专用网
## VR 
Virtual Reality虚拟现实
## VXLAN 
Virtual Extensible Local Area Network虚拟可扩展局域网
## WAF 
Web Application FirewallWeb应用防火墙
## WCDMA 
Wideband Code Division Multiple Access宽带码分多址
## WiFi 
Wireless Fidelity无线保真
## ZENIC 
ZTE Elastic Network Intelligent Controller中兴通讯弹性网络智能控制器
## ZTE 
Zhongxing Telecommunications Equipment中兴通讯
# 5GC容灾解决方案 
## 方案概述 
### 概述 
随着5G业务的全面铺开，越来越多的用户可以享受5G更快的速度、更低的时延、更大的网络容量等优势。接入5G网络的设备也越来越多样化，包括传统的人网、海量的物联网、低延时高智能的车联网等。 
随着信息化在各个行业的不断深入，诸如医疗、金融、能源等对于通讯网络的依赖性也越来越强。以上既为5G网络带来了无限的机遇与广阔的前景，同时也对5G网络提出了更高、更严格的要求。 
对于因为设备故障、停电、自然灾害等种种原因导致的网络服务中断而引发的通讯不畅、数据丢失、资金损失甚至生命危险是不可想象的。5GC提供了丰富的容灾手段来应对上述问题，使得即使遇到不可抗因素而导致部分网络设备不可用时，也可以通过多种方式保障业务的可用性。5GC相对于传统EPC网络演进了一些新的特性，基于这些新特性5GC的容灾方式与EPC的容灾方式也不尽相同。 
虚拟化相对于传统EPC网元，5GC所有网元均运行在虚拟化的服务器上。当出现虚拟机级或服务器级的故障，从而导致网元部分功能或整个网元功能不可用时，可借助虚拟机的重生机制快速恢复正常业务。 
服务化5GC采用全新的总线型网络结构，每个网元对外提供自身的服务。所有的网元/服务均由NRF管理，网元间不用维护彼此是否可用的状态。当某个网元服务不可用时，NRF可以通过订阅通知知会相关网元，并提供重新选择同类型其它可用网元服务的功能。 
计算存储分离5GC网元按无状态设计，当前处理流程完成后，将用户及会话上下文状态数据保存在UDSF中。UDSF对数据进行多副本保存，包括UDSF内以及UDSF之间。当某个网元不可用时，其他同类型网元可以从UDSF读取上下文状态数据并继续用户业务。 
控制面用户面分离控制面与用户面分离后，控制面SMF与用户面UPF分别部署。一般来说SMF为集中部署，UPF根据网络规划及业务需要分级、分布部署。SMF与UPF之间可以采用FullMesh的方式互联，当某个UPF不可用时，SMF可以选择其他可用的UPF立即恢复用户业务。 
考虑到可能发生地域大范围的火灾、停电、地震等不可抗因素导致的网络设备不可用，5GC采用跨地域的异地容灾部署方式（如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示）。在两个不同地域分别部署两个DC，当某地DC中的网络设备不可用时，由另一地DC迅速接管业务，从而保障5G业务的可用性。
图1  跨地域异地容灾部署
[]images/%E5%BC%82%E5%9C%B0%E5%AE%B9%E7%81%BE.png)
### 容灾基本原理 
本方案从以下方面，介绍容灾的基本原理。 
基本原理|说明
---|---
架构可靠性|架构可靠性
部署可靠性|部署可靠性
资源可靠性|资源可靠性
数据可靠性|数据可靠性
Bypass|Bypass方案
### 容灾部署方式 
容灾部署方式主要分类参见下表。 
部署方式|说明|应用网元
---|---|---
1+1主备|网元采用1+1主备组网时：主用网元处理业务，备用网元不处理业务。主备网元之间会进行业务数据实时同步。主用网元不可用时，备用网元承接业务。|UDM、NSSF
1+1互备|网元采用1+1互备组网时：互备的网元均独立处理业务。互备的网元之间的业务数据支持双向同步。某网元不可用时，与其互备的网元承接其业务。|NRF、BSF、CHF
POOL模式|网元采用POOL模式组网时：POOL内所有网元采用负荷分担业务。当POOL内某个网元不可用时，新接入业务会在POOL内选择其他可用网元进行业务。|AMF、SMF、PCF、UPF
### 故障检测机制 
本方案主要介绍以下三种检测机制，并在后续章节中详细说明。 
检测机制|应用接口|协议|详细说明
---|---|---|---
HTTP PING探测|服务化接口，服务化网元与网元之间的互相检测，例如：SMF和CHF|HTTP|HTTP PING探测
PATCH心跳探测|NRF与支持注册发现的NF间接口，包括：AMF、SMF、UDM、PCF、NSSF、BSF|HTTP|PATCH心跳探测
非服务化接口检测|N4、N3、N9、N26、N2、Rx|N4：PFCPN3、N9：GTPN26：GTPN2：SCTPRx：Diameter|非服务化接口检测
### 各网元容灾方案 
各网元推荐的容灾方案参见下表，并在后续章节中详细说明。 
网元|容灾部署方式|故障检测机制|容灾简要说明|详细链接
---|---|---|---|---
NRF|1+1互备|服务化NF：PATCH心跳探测|在NRF间需要实现数据同步，保证各NF注册数据一致性。维护其他NF状态，识别NF故障后，根据订阅数据向订阅者发送NF故障状态通知；并在对应的NF发现流程中，返回可用NF列表。|NRF容灾
AMF|POOL|服务化NF：PATCH心跳探测RAN/MME：非服务化接口检测|AMF POOL由多个为相同区域和网络切片提供服务的AMF组成，区域内的RAN与AMF POOL内的所有AMF均进行互联。AMF在正常运行中将用户标识及其位置信息（如SUPI/TAList/5G-GUTI）备份到AMF POOL内的其他AMF（即备份AMF）上，为完成用户数据备份，需要为每台AMF指定备份AMF。某AMF发生故障后：对于(R)AN发起的上行流程，(R)AN选择AMFPOOL内其他正常的AMF，由AMF触发用户重注册，从而恢复业务处理。对于CPNF发起的下行流程，CPNF选择故障AMF的备份AMF，由备份AMF根据用户备份数据先寻呼用户，在用户发起业务请求后再触发用户重注册，从而恢复业务处理。|AMF容灾
SMF|POOL|服务化NF：PATCH心跳探测UPF：非服务化接口检测|SMF POOL容灾方式是指一组SMF组成一个POOL。当POOL中某SMF故障时，AMF会在POOL中重新选择一个可用的SMF继续业务。|SMF容灾
UPF|POOL|服务化NF：PATCH心跳探测SMF/UPF/gNodeB：非服务化接口检测|UPF POOL容灾方式是指一组UPF组成一个POOL。当POOL中某UPF故障时，SMF会在POOL中重新选择一个可用的UPF继续业务。|UPF容灾
CHF|1+1互备|通过前端网元SMF检测|CHF 1+1互备容灾方式是指两套独立的CHF互为主备并且同时运行业务。如果主用CHF异常，SMF可能短时间内收不到CHF的计费响应消息（或者和CHF的HTTPPING探测失败），未响应计费消息会在SMF本地临时缓存，后续通过回放的方式发向备用CHF，后续所有新的计费消息也会发向备用CHF。如果主备CHF都不可用，对当前异常消息SMF会打上failure标记，进行持久化存储。待CHF恢复可用时，SMF通过回放的方式发送给可用的CHF，若该回放话单中MUU有效（即产生了流量），CHF会将该话单的ratingIndicator设置=1，Billing需要对ratingIndicator=1的话单做排重处理。|CG容灾
PCF|POOL|服务化NF：PATCH心跳探测和HTTP PING探测非服务化接口：非服务化接口检测中的SCTP/Diameter链路检测|PCF POOL容灾方式是指一组SMF组成一个POOL。当POOL中某PCF故障时，AMF/SMF/AF会在POOL中重新选择一个可用的PCF继续业务。|PCF容灾
UDM|1+1主备|服务化NF：PATCH心跳探测|UDM 1+1主备容灾方式是指正常情况下，所有话务由主站点UDM承担，站点内部业务处理虚机为N+1负荷分担模式。主备站点间有数据同步机制。当主用UDM故障时，其他网元重新选择备用UDM继续业务。|UDM容灾
BSF|1+1互备|服务化NF：PATCH心跳探测DRA/PCF：非服务化接口检测|BSF 1+1互备容灾方式是指一对BSF正常情况下同时处于工作状态，用户的会话绑定数据在一对BSF间实时同步，保证数据一致性。当某BSF故障时，其他网元重新选择另一个可用的BSF继续业务。|BSF容灾
NSSF|1+1主备|服务化NF：PATCH心跳探测|NSSF 1+1主备容灾方式是指正常情况下，所有话务由主站点NSSF共同承担，站点内部业务处理虚机为N+1负荷分担模式。主备站点间有数据同步机制，心跳检测机制保障。NSSF主局故障宕机时，主备局之间通过心跳检测机制，备局激活，提供切片查询服务。AMF根据业务消息判断机制，配置主用和备用地址，判断发生切换时，把消息送到备局进行处理。|NSSF容灾
## 容灾场景 
### 虚机级容灾 


#### 场景说明 
虚拟化网元系统中，相同规格的虚机一般使用1+1主备、1+1互备或N+M负荷分担部署。 
实际运行过程中，如果出现一个虚机损坏，该损坏虚机的功能（或角色）会容灾到其他虚机中正常运行，不会对功能和性能产生影响。 


#### 组网 
5GC网元内虚机容灾组网如[图1](2.html#T_1604980389579__2ee3ed0c-b972-44b0-9790-4cb28f959a00)所示。
图1  虚机容灾组网


[]images/%E8%99%9A%E6%9C%BA%E7%BA%A7%E5%AE%B9%E7%81%BE.png)



#### 实现原理 
NF|虚机容灾方案
---|---
虚机类型|容灾方式|功能说明
---|---|---
NRF|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
NRF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
NRF|GSU LB|N+M负荷分担|转发业务请求到业务处理机GSU。
NRF|GSU业务|N+M负荷分担|完成NF管理、发现、授权业务相关的处理，业务数据保存在CDU。
NRF|CDU|N+M负荷分担|保存NF Profile。
AMF|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
AMF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
AMF|GSU LB|N+M负荷分担|转发业务请求到业务处理机GSU。
AMF|GSU业务|N+M负荷分担|完成用户业务相关的处理，用户上下文保存在本地CDU云数据库或者通过CDU保存。
AMF|CDU|1+1互备|保存用户上下文，上下文分组互备，虚机成对配置。
SMF|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
SMF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
SMF|GSU LB|N+M负荷分担|转发业务请求到业务处理机GSU。
SMF|GSU业务|N+M负荷分担|完成用户业务相关的处理，用户上下文保存在本地CDU云数据库或者通过CDU保存。
SMF|CDU|1+1互备|保存用户上下文，上下文分组互备，虚机成对配置。
UPF|MPU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
UPF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
UPF|GSU|1+1主备|对外与SMF交互，对内负责协调、管理所有其他组件，负责PFU的负载均衡。
UPF|PFU|N+M主备|用户上下文集中式备份到LDB，负责用户面报文收发、业务处理。由UPM分配GTPU节点、用户地址段，处理UPM分发过来的会话业务流程，在本地保存会话相关的上下文，并向备份节点进行同步。
UPF|LDB|1+1主备|集中式备份时使用的本地数据库,备份所有PFU的会话上下文，当单个PFU不可用或进行弹性伸缩时，由其他PFU从LDB拉取会话上下文分担其业务。
CHF|-|N+1负荷分担|CHF网元内所有虚机规格相同。运行过程中，若任意一个虚机损坏，该损坏虚机的功能会容灾到其他虚机中运行，不会对功能和性能产生影响。若N个虚机损坏，只剩下1个虚机正常，也可保证CHF网元功能运行正常，但性能会按一定比例下降。
PCF|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
PCF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
PCF|GSU HTTP LB|N+M负荷分担|在IPU和业务GSU间转发HTTP业务消息。
PCF|GSU SIG LB|N+M负荷分担|在IPU和业务GSU间转发Diameter/SMS业务消息。
PCF|GSU业务|N+M负荷分担|完成用户业务相关的处理，用户上下文保存在CDU。
PCF|GSU GW|N+M负荷分担|用于CDU跨局访问（例如PCF间热备，或无CDU的PCF将用户上下文保存到有CDU的PCF）。
PCF|CDU|1+1互备|保存用户上下文，上下文分组互备，虚机成对配置。
PCF|LOG|N+1负荷分担|保存策略日志。
PCF|LSU|N+1负荷分担（至少部署3个节点）|策略日志分析。
UDM/AUSF/UDR|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
UDM/AUSF/UDR|IPU|N+M负荷分担|接口单元，转发外部业务请求。
UDM/AUSF/UDR|GSU LB|N+M负荷分担|转发业务请求到业务处理机GSU。
UDM/AUSF/UDR|GSU业务|N+M负荷分担|完成用户鉴权、签约数据查询、上下文管理等处理。
UDM/AUSF/UDR|CDU DSA|1+1主备|保存用户签约数据，分组主备，虚机成对配置。
UDM/AUSF/UDR|CDU PROV|1+1主备|完成用户静态数据受理功能。
BSF|OMM|1+1主备|操作维护管理服务器虚机。
BSF|OMP|1+1主备|操作维护代理。
BSF|SIPI|N+M负荷分担|接口单元，转发外部业务请求。
BSF|CMP|N+M负荷分担|Diameter及HTTP业务请求处理。
BSF|SMP|N+M负荷分担|Diameter信令处理。
BSF|SMPHTTP|N+M负荷分担|HTTP信令处理。
BSF|DDB|1+1互备|保存会话绑定数据，虚机成对配置。
BSF|RGW|N+M负荷分担|会话绑定数据传输网关，用于绑定数据同步处理。
NSSF|OMU|1+1+1三节点主备|同步虚机状态，下发负荷分担策略。
NSSF|IPU|N+M负荷分担|接口单元，转发外部业务请求。
NSSF|GSU LB|N+M负荷分担|转发业务请求到业务处理机GSU。
NSSF|GSU业务|N+M负荷分担|完成切片选择、可用性更新业务相关的处理，业务数据保存在CDU。
NSSF|CDU|N+M负荷分担|保存切片信息。


#### 应用限制 

 
部署时要考虑主备跨物理节点部署。 

 
确认有足够的冗余备份的空闲服务器资源，以便可以快速进行VM重生。 

 


#### 容灾配置 
配置前提
网元部署时，需按照“[实现原理](2.html#T_1604980389579__13a5d9b6-7e21-419f-99b6-12b14c782189)”中各网元的“容灾方式”要求进行部署。
配置过程
参见[网元级容灾](4.html)。


### 服务器级容灾 


#### 场景说明 
服务器级容灾包括以下场景： 

 
服务器故障单个/多个物理服务器或连接到某个/多个物理服务器的网络端口/链路故障。 

 
网络设备故障
一个TOR交换机发生故障，所有业务切换到另一个TOR交换对应的网络平面。
一个EOR交换机发生故障，所有业务切换到另一个EOR交换对应的网络平面。
 

 


#### 组网 
容灾组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。


#### 实现原理 
VNF内部VM有容灾机制，故障服务器上的虚机运行的业务自动倒换到其他正常的VM上。


#### 应用限制 

 
部署时要考虑主备跨物理节点部署。 

 
确认有足够的冗余备份的空闲服务器资源，以便可以快速进行VM重生。 

 


#### 容灾配置 
配置前提
网元部署时，需按照[虚机级容灾](2.html)的“容灾原理”中各网元的“容灾方式”的要求进行部署，并且保证同一类型的虚机部署在不同的服务器上。
配置过程
参见[网元级容灾](4.html)。


### 网元级容灾 
#### 场景说明 
一个网元实例发生故障，所有业务相关网元的连接切换到其他备份网元实例。 
#### 组网 
5GC核心网，部署两个DC，放置5GC控制面网元。同时对于UPF采用专U方案进行建设，部署在5GC核心网机房，连接5GC CE。
网元容灾逻辑组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。
#### 实现原理 
NF|部署方式|容灾方案|方案详情
---|---|---|---
NRF|互备|在NRF间需要实现数据同步，保证各NF注册数据一致性。维护其他NF状态，识别NF故障后，根据订阅数据向订阅者发送NF故障状态通知；并在对应的NF发现流程中，返回可用NF列表。|NRF容灾
AMF|POOL|按照注册区域，根据切片维度，以POOL方式组网，POOL内进行容灾，AMF POOL内进行用户容量冗余，AMF1故障时，NR重选AMF2。|AMF容灾
SMF|POOL|按照服务区域划分POOL，POOL内进行容灾，POOL内SMF进行会话容量冗余，SMF1故障时，AMF重选SMF2。|SMF容灾
UPF|POOL|多个UPF负荷分担方式容灾，任一UPF故障，SMF重选其他新的UPF。|UPF容灾
CHF|互备|主用CHF异常，SMF可能短时间内收不到计费响应消息（或默认开启HTTP PING探测失败），未响应计费消息会在本地临时缓存，后续通过回放的方式发向备用CHF，后续新的计费消息也会发向备用CHF。如果主备CHF都不可用，对当前异常消息SMF会打上failure标记，进行持久化存储。等CHF恢复可用时，SMF通过回放的方式发送给可用的CHF，若该话单中MUU有效（即产生了流量），CHF会将该话单的ratingIndicator设置=1，BOSS需要对ratingIndicator=1的话单做排重处理。|CG容灾
PCF|POOL|多个PCF PooL容灾，PCF1故障时，业务重选PCF2。|PCF容灾
UDM/AUSF/UDR|主备|按主备方式容灾，BE 1+1部署，FE 1+1，主用故障后其他NF选择备用接管业务。|UDM容灾
BSF|互备|业务负荷分担，会话绑定数据在两套设备中保证同步。|BSF容灾
NSSF|主备|切片相关信息需要OMC保证在各NSSF中数据配置一致性。|NSSF容灾
#### 可获得性 
AMF网元“AMF支持无UDSF容灾部分备份功能”需License支持。 
### 机柜级容灾 


#### 场景说明 
通信云硬件资源池按照层次化架构设计，自下而上分为接入层、核心层、出口层三层，各层部署以下设备： 

 
接入层：部署TOR和各类计算型服务器、存储设备。 

 
核心层：部署EOR和EOR配对路由器，并按需配置防火墙等设备，EOR向下汇聚交换网络内的所有接入层交换设备，并向上与出口路由设备互联。 

 
出口层：出口层部署DCGW或者复用现网承载、传输网络组网设备。出口层作为通信云站点内部和外部网络互联互通的纽带，对外完成与外部设备高速互联，对内负责与通信云站点核心层交换设备互联，完成与站点外部路由信息转发和维护。  

 
由于大区单资源池规模较大，计算型服务器和网络设备都比较多，为便于标准化设计，考虑组网层次化和模块化，便于接入层组网在本机柜内或相邻机柜实现端口汇聚，通常设计为： 

 
计算服务器每机柜最大部署n台计算服务器以及TOR交换机。 

 
存储型服务器每机柜最大部署n台存储服务器以及TOR交换机。 

 
组网设备EOR或DCGW单独一个机柜。  

 
因此，机柜级容灾的主要场景包括： 

 
单个计算节点机柜掉电，该机柜内所有服务器上运行的虚机全部故障，VNF基于内部VM容灾机制，故障服务器上的虚机运行的业务自动倒换到其他正常的VM上。 

 
单个存储节点机柜掉电，该机柜上所有存储服务器不可用，由其他机柜的存储节点提供存储服务。 

 
单个网络设备EOR/DCGW机柜掉电，单个平面EOR/DCGW交换机故障，所有业务切换到另一个平面EOR/DCGW交换对应的网络平面。  

 


#### 组网 
一个机房包含一个或多个资源池，每个资源池由大量机柜构成，网络设计时要考虑机柜故障场景下的冗余备份，同一VNF的下相同类型的VM考虑分布在不同机柜的服务器上，提高可靠性。 
容灾组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。


#### 实现原理 

 
VNF内部VM有容灾机制，故障服务器上的虚机运行的业务自动倒换到其他正常的VM上。 

 
存储系统采用多备份节点机制，数据文件有多份复制备份，当某一节点故障时，由其他存储节点接管服务。 

 
交换设备采用双平面部署方式，当某一平面设备故障，业务切换至另一平面设备。 

 


#### 应用限制 

 
网络设计时要考虑机柜故障场景下的冗余备份，部署时要考虑同类型VM跨物理机柜部署。 

 
确认有足够的冗余备份的空闲服务器资源，以便可以快速进行VM重生。 

 


#### 容灾配置 
参见[网元级容灾](4.html)。


### 资源池级容灾 


#### 场景说明 
资源池级容灾指承载层(TOR/EOR)的资源池发生故障时的容灾，某个资源池不可用，如EOR交换机故障，需要将该资源池内的所有VNF切换到同Pool内的其他资源池中的VNF上。 


#### 组网 
容灾组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。


#### 实现原理 
5GC业务应用层各VNF在多资源池进行冗余部署。在一个资源池故障时，由其它资源池的VNF设备自动接管业务，可以使用本DC内的其它资源池的VNF接管业务，也可以使用其他DC的资源池的VNF接管业务。 


#### 应用限制 
网络设计时要考虑资源池故障场景下的冗余备份。 


#### 容灾配置 
参见[网元级容灾](4.html)。


### 机房级容灾 


#### 场景说明 
机房级容灾的应用场景主要包括： 

 
机房整体故障：例如机房整体掉电，或机房出口传输设备或链路故障。 

 
机房计划关闭：例如沿海发达省份在春节务工人员返乡期间关闭某些机房。 

 
一个机房可以部署多个VNF，这些VNF属于相同或不同的Pool/Set。当一个机房整体故障或关闭时，这些VNF中的业务能够迁移至各自Pool/Set在其它机房的VNF。 


#### 组网 
一个机房包含一个或多个资源池，网络设计时要考虑机房故障场景下的冗余备份，不能将一个Pool/Set内的全部VNF都部署到一个机房。 
容灾组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。


#### 容灾原理 
5GC业务应用层各VNF在多机房进行冗余部署。在一个机房故障时，由其它机房的VNF设备自动接管业务。 


#### 应用限制 
网络设计时要考虑机房故障场景下的冗余备份。 


#### 容灾配置 
参见[网元级容灾](4.html)。


### 机楼级容灾 


#### 场景说明 
在两个或多个机楼部署多套功能相同的设备，当机楼因意外停止工作时，通过部署在其它机楼的容灾设备可以快速接管业务，保证业务的连续性和可用性，降低突发意外事件对系统正常运行的影响。 
机楼级容灾的场景主要包括： 

 
设备故障，例如机楼出口传输设备或链路故障。 

 
电力故障，例如全套供电设施故障。 

 
自然灾害，例如地震、火灾、海啸等。 

 
社会事件，例如战争破坏等。 

 


#### 组网 
一个机楼包含一个或多个资源池，网络设计时要考虑机楼故障场景下的冗余部署，支持将容灾Pool/Set内VNF在多个机楼进行容灾部署。 
容灾组网如[图1](0.html#T_1604980389569__461e0c4f-56a5-4ba3-afc5-708e4f35c313)所示。


#### 实现原理 
5GC业务应用层各VNF在多机楼进行冗余部署。在一个机楼故障时，由其它机楼的VNF设备自动接管业务。 


#### 应用限制 
网络设计时要考虑机楼故障场景下的冗余备份。 


#### 容灾配置 
参见[网元级容灾](4.html)。


### DC级容灾 


#### 场景说明 
在发生大范围故障或灾难的情况下，有整DC设备宕机及退出服务的可能，如DC级范围的火灾、掉电，DC出口网络设备范围性的故障或掉电等场景。针对此场景，可以根据运营商的规划提供DC级容灾功能。


#### 组网 
在规划提供DC级容灾功能的情况下，需要保证每种类型的设备在本DC外均有其备份设备部署和运行。一般情况下，需要提供双DC组网。同时，双DC之间的承载网络也需要实现互联及冗余备份。  

 
对于POOL工作方式运行的设备（如AMF，SMF等），需要将POOL内的设备均匀部署到两个DC中；同时，每个DC内设备的部署容量均为总用户容量，即单个DC的设备能够满足总用户数的接入；另外，对于需要指定备份关系的设备（如AMF），也需要将主用设备的备用设备指定为另一个DC中的设备。 

 
对于主备/互备工作方式运行的设备（如NRF，NSSF，AUSF，UDM等），需要将主用和备用设备分别部署到两个DC中；同时，每个DC内设备的部署容量均为总用户容量，即单个DC内的主用或备用设备能够满足总用户数的接入。  

 
对于为同一业务区域/省份服务的RAN设备，需要同时与双DC中的设备进行网络互联。 

 


#### 实现原理 
5GC各网络设备均提供了NF级的容灾备份机制。当某台设备发生故障后，其备份设备处于正常工作状态，则话务将由其备份设备进行处理。  
在DC级容灾的场景，RAN设备在识别其中一个DC（如DC1）的AMF设备故障后，会将话务分发到状态正常的另一个DC（如DC2）的AMF设备上。AMF接收话务的后续处理，将转化为AMF容灾处理流程，其他NF正常处理流程或容灾处理流程，流程处理中由于DC1中的设备均不可用，则最终会由DC2中的设备完成用户接入及会话建立等处理流程，进而实现业务恢复。 


#### 应用限制 
部署DC级容灾，在设备的冗余容量上，需要每个DC能够接入总用户数。 


#### 容灾配置 
参见[网元级容灾](4.html)。


## 容灾原理 
### 架构可靠性 
#### 概述 
5GC容灾解决方案支持负荷分担、主备实例功能和无状态特性，从而实现架构可靠性。 
#### 负荷分担 
负荷分担是指运行实例采用负荷分担的工作方式，即所有运行实例共同分担处理业务。当部分运行实例异常宕机时，由其余运行正常的实例共同分担处理业务，从而保证业务正常运行。 
采用N+M冗余方式，即当N个实例可以满足系统容量的业务处理时，再提供M个实例用于冗余。 
采用N+M个实例共同分担处理业务，此时系统能够承受最多M个实例的异常宕机而不影响系统处理能力。 
采用实例负荷分担工作方式的服务运行实例，全部为主用（Active）工作状态。运行实例分别运行在不同的资源之上，如不同的虚机或容器、不同的硬件服务器，以及不同的资源分区（ZONE）。当部分（小于等于M个）运行实例出现故障宕机时，其业务由其他正常运行的实例继续处理，从而能够不间断提供服务。 
采用N+M冗余的负荷分担的系统架构如[图1](11.html#T_1604980389589__57b3135a-c78e-41bf-9657-5e12c631c04c)所示。
图1  负荷分担方式系统架构图
[]images/1621944804578.png)
上图中N=3，M=1。当任何1个运行实例故障时，其他3个运行实例继续工作，从而保证系统容量及业务处理不受影响。 
#### 主备实例 
主备实例是指运行实例采用主用和备用的工作方式，即一个主用，一个备用。正常工作状态时，主用实例提供服务，备用实例对主用实例的数据进行备份。当主用实例异常宕机或执行主备倒换命令时，备用实例转换为主用实例提供服务，从而保证业务正常运行。引入主备实例特性的目的在于提高运行实例的可靠性，从而进一步提高NF的可靠性。  
主备实例的系统架构如[图2](11.html#T_1604980389589__5b10ad95-f0f7-4cab-8ce8-9de056b51b46)所示。
图2  主备实例系统架构图
[]images/1621944772744.png)
#### 无状态 
无状态是指微服务的无状态设计，任何状态信息或数据都需要被抽取出来，并通过后端服务的方式保存在数据库、缓存等。业务逻辑APP随时可以执行弹性、扩容、销毁、重生、迁移操作。在此过程中，由于状态数据通过后端数据库进行存储，可以保障业务处理不受影响，使系统实现和系统运行更富有可恢复性和敏捷的适应性。 

3GPP TS 23.501标准规范提出了计算和存储分离的概念，并定义了UDSF用于统一存储NF的状态数据（又称为非结构化数据），实现业务逻辑执行与状态数据分离。 
中兴通讯系列产品采用无状态的设计思路实现各个NF，业务处理逻辑实现了计算与存储分离。系统的负载均衡器（Stateless Load Balancer），也按无状态的方式负责对话务进行均衡分发，简化了业务处理，保障了业务逻辑在执行弹性伸缩、自愈及重生时，系统负荷分担可以敏捷均衡。 
NF的无状态设计如[图3](11.html#T_1604980389589__23dadbf1-0956-408f-ab67-2d9c23d121d1)所示。
图3  无状态设计
[]images/%E6%97%A0%E7%8A%B6%E6%80%81%E8%AE%BE%E8%AE%A1.png)
### 部署可靠性 
#### 概述 
5GC容灾解决方案支持网元分域部署、双DC部署、互斥部署，同时采用网卡Bond模式和网络双平面，从而实现部署可靠性。
#### 分域部署 
采用管理域、业务域、转发域分离的方式进行网元部署。 
#### 双DC部署 
采用网元部署在双DC内，DC内的同种类型网元组POOL，保证地域容灾的可靠性。 
#### 互斥部署 
互斥部署也称为反亲和部署，指同质的虚机部署在不同的物理机上，从而保证当某个物理机出现异常时，多个同质虚机仍能够提供服务。当前支持的反亲和组方式有： 
软反亲和：组内虚机软互斥，尽量实现每个虚机部署在不同的主机（计算节点）上。 
硬反亲和：组内虚机互斥，严格保证每个虚机部署在不同的主机（计算节点）上。 
不反亲和：不生成对应的亲和组。 
 说明： 
同质虚机是指虚机子类型相同的虚机，类型与规格都相同，例如GSU C2M8。 
#### 网卡Bond模式 
网卡配置Bond（绑定）模式是指将两个或者多个物理网卡绑定成一个虚拟逻辑网卡，从而实现本地网卡的冗余，带宽扩容和负载均衡，保证网络的可靠性。 
#### 网络双平面 
网络双平面是指NF对内与对外的所有逻辑网络接口，都需要支持至少2个不同的物理网络平面互为备份。当其中一个物理网络平面发生故障时，另一个物理网络平面依旧能够接管所有的网络流量，保证业务不中断。
网络双平面支持NF的所有网络接口，包括：内部管理面、内部业务平面以及所有的对外接口。 
### 资源可靠性 
#### 概述 
5GC的资源包括以下两种： 
计算资源：如VM、容器、进程。 
通信资源：如Management通信平面、Service通信平面、TOR/EOR。 
业务功能的正常运行，依赖以上的资源正常运行。而以上资源的可靠性，可通过链路检测、自愈、防脑裂等机制来保障。 
#### 链路检测 
业务内部通信平面包括Management通信平面、Service通信平面。每个通信平面都有链路检测功能。业务节点会定时发送心跳保活报文给管理节点，管理节点检测出长时间未发心跳的节点，则判定为故障节点，从而触发业务迁移流程，把故障节点的业务迁移到其他正常节点，从而保证业务的可靠性。 
#### 自愈 
对于持续出现故障的业务处理节点，系统会进行节点的多级自愈。根据用户的自愈策略配置，系统依次采用重启容器、重建容器、重启虚机、重建虚机逐级上升的策略进行自愈，从而尽快恢复业务。 
#### 防脑裂 
防脑裂指主控节点采用仲裁形式，防止主控节点脑裂的发生。当主备之间无法通信，需要决定主备状态时，引入仲裁节点，辅助主备决策。 
### 数据可靠性 
#### 概述 
5GC的NF按无状态设计，在当前处理流程完成后，将用户及会话上下文状态数据保存在UDSF中，由UDSF对数据进行多副本保存。当NF故障时，NF
SET内的其他NF在接管故障NF的业务时可以从UDSF读取上下文状态数据并继续话务处理。NF可以共享UDSF存储各自的非结构化数据，或者可以各自拥有自己的UDSF。 
UDSF地理容灾方案是在多个地理位置部署数据节点，数据节点在不同的地理位置以站点为单位进行组织。多个站点之间相互协作，呈现为一个有机的完整的系统，对外提供稳定可靠的服务。UDSF支持的容灾方式有： 
1+1冗余存储在DC内，数据存储节点之间通过可靠的复制机制，实现用户数据的双副本存储。通过互斥组设置，用户数据的两个副本，可以存储在不同的物理机上，确保一个物理机的故障，不会影响用户数据的所有副本。 
1+1地理容灾在DC内1+1冗余存储的基础上，将用户数据存储在2个DC，每个DC的双副本存储，可以确保DC级故障不会影响数据的可靠性。 
#### 基本概念 
CDN节点UDSF数据存储和处理节点，通常是虚机中的一个容器。 
UDSF租户（Tenant）一个或两个站点的若干CDN节点的集合，在UDSF租户的每个站点内，每个CDN节点存储FE
NF的部分数据，所有CDN节点的数据构成了FE NF的全部数据。租户是容灾的基本单位。 
UDSF控制中心（Control Center）负责监控所有CDN节点和UDSF租户的工作状态，确保FE的数据访问在合适的CDN节点上完成。 
主用站点（Home Site）和备用站点（BackupSite）将租户的其中一个站点设置为主用站点，另外一个站点设置为备用站点。主用站点和备用站点的设置只影响数据访问的优先级，不影响数据的访问功能。两个站点都可以提供增、删、查、改等全部数据访问操作。 
#### 应用场景 
无容灾场景
不需要地理容灾功能时，UDSF租户的节点只部署在一个站点，如[图1](14.html#T_1604980389599__c8649993-42ed-4f94-b258-34b90f67fc5a)所示。
图1  无容灾场景
[]images/%E6%97%A0%E5%AE%B9%E7%81%BE%E5%9C%BA%E6%99%AF.png)
无容灾的UDSF租户部署，不具备地理级的可靠性，通常应用于以下场合： 
非正式商用的测试环境。 
业务不需要容灾的场景。 
FE自身具备不依赖于UDSF的容灾功能。 
1+1主备容灾场景
UDSF租户的节点部署在两个站点，所有租户都设置其中一个站点为主用站点，另外一个站点为备用站点，如[图2](14.html#T_1604980389599__fb2e0d0c-fda4-4340-a041-70fad5ddfb08)所示。
图2  1+1主备容灾场景
[]images/1+1%E4%B8%BB%E5%A4%87%E5%AE%B9%E7%81%BE%E5%9C%BA%E6%99%AF.png)
业务集中在主用站点，备用站点作为热备份，当主用站点故障时接管业务。 
1+1互备容灾场景
两个UDSF租户，每个租户的节点都部署在两个站点，并且分别将不同的站点设置为主用站点，如[图3](14.html#T_1604980389599__d6d4c025-d377-4bd0-84f6-1cde5809f040)所示。
图3  1+1互备容灾场景
[]images/1+1%E4%BA%92%E5%A4%87%E5%AE%B9%E7%81%BE%E5%9C%BA%E6%99%AF.png)
UDSF租户1将站点1设置为主用站点，站点2设置为备用站点 
UDSF租户2将站点2设置为主用站点，站点1设置为备用站点。 
正常情况下，站点1的FE访问租户1中站点1的节点，站点2的FE访问租户2中的站点2的节点。如果站点1发生故障，站点2的FE将访问租户1和租户2中的站点2的节点。 
1+1+1环备容灾场景
三个或以上UDSF租户，每个租户的CDN节点都依次部署在两个站点，并且分别将不同的站点设置为主用站点，如[图4](14.html#T_1604980389599__38f4a695-04a3-46ef-9685-aa50806cc93c)所示。
图4  1+1+1环备容灾场景
[]images/1+1+1%E7%8E%AF%E5%A4%87%E5%AE%B9%E7%81%BE%E5%9C%BA%E6%99%AF.png)
数据按就近原则存储在各自的主用站点中（租户1对应站点1，租户2对应站点2，租户3对应站点3），并选择另外一个站点作为备用站点（租户1对应站点2，租户2对应站点3，租户3对应站点1）。 
任意一个站点发生故障，数据和业务都可以在另外一个站点恢复，在确保数据访问效率的同时，提供了数据的高可靠性和可用性。 
N+1集中容灾场景
每个UDSF租户的CDN节点都部署在各自的主用站点，且有一个额外的站点，集中部署了所有租户的节点作为备用站点，如[图5](14.html#T_1604980389599__336a8f0b-bf0f-4256-9d81-9886bc892a20)所示。
图5  N+1集中容灾场景
[]images/N+1%E9%9B%86%E4%B8%AD%E5%AE%B9%E7%81%BE%E5%9C%BA%E6%99%AF.png)
N+1集中容灾场景，除了集中的备用站点，其他站点的FE都不需要预留处理能力用于接管业务。FE的资源利用率更高，且由于不需要接管业务，各个站点的FE之间不会相互影响。 
### Bypass方案 
#### 概述 
Bypass（旁路）方案是指在某种类型的NF均发生故障而无法正常交互的情况下，将此NF进行旁路（不再交互），从而使业务处理流程得以继续进行。 
#### AMF提供的Bypass方案 
NRF Bypass：在NRF均故障的情况下，AMF为继续提供服务，支持如下处理功能：NRF均故障时，本地缓存停止老化，继续使用缓存选择NF/NFS。NRF均故障时，本地缓存发现失败的情况下，根据配置可以使用本地配置发现和选择NF/NFS。 
NSSF Bypass：在NSSF均故障的情况下，AMF为继续提供服务，支持如下处理功能：NSSF均故障时，当“请求切片和签约切片的交集”AMF均无法支持时，AMF支持向NRF发现满足切片交集的AMF，根据返回结果择优选择AMF并视需要选择执行AMF
re-allocation流程。NSSF均故障时，当“请求切片和签约切片的交集”AMF可以部分支持时，根据配置，AMF可以选择执行上述NRF发现流程或直接采用自身为用户提供服务。 
PCF Bypass：在PCF均故障的情况下，AMF为继续提供服务，支持如下处理功能：PCF均故障时，对于移动性策略，AMF支持使用本地配置策略继续处理业务。PCF均故障时，对于UE策略，AMF支持无UE策略而继续处理业务。 
#### SMF提供的Bypass方案 
NRF Bypass：在NRF均故障的情况下，SMF为继续提供服务，支持如下处理功能：NRF均故障时，本地缓存停止老化，继续使用缓存选择NF/NFS。NRF均故障时，本地缓存发现失败的情况下，根据配置可以使用本地配置发现和选择NF/NFS。 
CHF Bypass：在CHF均故障的情况下，SMF为继续提供服务，支持如下处理功能：CHF均故障时，对于计费策略，SMF支持使用本地计费策略继续处理业务。CHF均故障时，对于话单，SMF支持将话单缓存在本地。 
PCF Bypass：在PCF均故障的情况下，SMF为继续提供服务，支持如下处理功能：PCF均故障时，SMF可以转本地策略，继续处理业务。 
UDM Bypass：在UDM均故障的情况下，SMF为继续提供服务，支持如下处理功能：UDM均故障时，SMF可以使用本地最小签约数据完成会话管理流程。 
## 故障检测 
### HTTP PING探测 
HTTP PING探测的方式适用于服务化接口之间的链路检测，通过HTTP/2协议的PING帧进行检测，接收方收到PING帧时，必须回送PING
ACK帧。 
在TCP链路建立后，源NF根据配置情况，周期性（默认30s）发送PING探测请求给目的NF。 
如果在下次检测请求发起之前收到PING ACK，则认为本次检测成功。 
如果在下次检测请求发起之前未收到PING ACK，则认为本次检测失败。 
如果当连续检测失败次数达到配置值时(默认3次)，则将该链路状态设置为不可用状态。 
HTTP/2链接的两端都可以发起HTTP/2的PING探测。 
客户端发起的HTTP/2 PING流程示意图如图1所示。图1  客户端发起的HTTP/2 PING流程 
服务端发起的HTTP/2 PING流程示意图如图2所示。图2  服务端发起的HTTP/2 PING流程 
### PATCH心跳探测 
PATCH心跳探测适用于NRF与支持注册发现的NF之间的链路检测。 
NF在向NRF注册时，协商心跳定时器T1。注册成功后，NF使用PATCH方法向NRF发送Nnrf_NFManagement_NFUpdate_Request消息启动心跳探测。 
如果在心跳检测周期内，NRF返回Nnrf_NFManagement_NFUpdate_Response消息响应心跳请求，则表示NRF和NF状态都正常。 
如果NRF在连续多个心跳检测周期内（默认3个）未收到NF发送的心跳请求，NRF将NF状态设置为Suspended故障态。 
NF与NRF之间的心跳保活示意图如下： 
图1  NF与NRF之间的心跳保活示意图
[]images/NF2NRF%E4%BF%9D%E6%B4%BB%E7%A4%BA%E6%84%8F%E5%9B%BE.png)
### 非服务化接口检测 


非服务化接口（N4、N3、N9、N26、N2、Rx）的检测根据探测方式的不同分为如下五种检测方式。 


探测方式|功能描述|探测网元|默认检测参数|配置方法
---|---|---|---|---
GTP-U echo检测|在通信路径上发GTPU Echo Request给对端设备，对端设备在收到Echo Request后，返回Echo Response响应消息。|UPF和UPF之间gNB和UPF之间|开启/关闭GTPU心跳检测功能：OFF心跳检测发送间隔：60s心跳重发次数：3次心跳检测老化间隔：3次开启/关闭GTPU心跳检测路径恢复后通知CP的开关：OFF|UPF配置命令举例：如下设置GTPU心跳检测参数。打开心跳检测开关，心跳检测发送间隔是70s，重发次数设置为3次，老化间隔设置为3次，路径恢复通知CP开关设置为关闭。SET GTPUECHO:SWITCH="ON",INTERVAL=70,RETRYTIMES=3,COUNT=3,NOTIFYCPSWITCH="OFF"
PFCP心跳检测|在通信路径上发送PFCP Heartbeat Request给对端设备，对端设备在收到PFCP Heartbeat Request后，返回PFCPHeartbeat Response响应消息。|SMF和UPF之间|用于开启/关闭UP心跳检测功能：ENABLE心跳检测发送间隔：60s心跳重发次数：5次心跳检测应答策略：ACKWORK异常处理策略：ALARMDELASSOC|UPF配置命令举例：如下设置心跳检测发送参数。其中心跳检测开关开启，心跳检测重发次数设置为5次，心跳检测应答策略为应答所有心跳检测，心跳检测的发送间隔为3秒。SET HEARTBEAT:ENABLEHEARTBEAT="ENABLE",RESENDTIMES=5,HEARTBEATACKPOLICY="ACKALL",SENDINTERVAL=3，ERRHANDLEPOLICY=“ALARMDELASSOC”
SCTP检测|通过SCTP偶联状态进行检测，SCTP协议通过HEARTBEAT/HEARTBEAT ACK消息机制检测对端状态及维护SCTP偶联状态。当以配置间隔发送HEARTBEAT消息而未收到ACK的次数达到最大配置次数后，则判定故障。|AMF与gNB之间BSF与PCF之间BSF与DRA之间|AMF配置（N2接口）：心跳间隔(单位:10毫秒)：500SCTP重传的最大次数：10通路数据重传的最大次数：5BSF配置（Rx接口）心跳间隔(单位:10毫秒)：500SCTP重传的最大次数：10通路数据重传的最大次数：5|AMF配置命令举例：配置SCTP标识为1的偶联，通路数据重传的最大次数5，心跳间隔500，SCTP重传的最大次数10。SET SCTP:ID=1,MAXRTRY=5,HB=500,SCTPMAXRTRYNUM=10BSF配置命令举例：配置SCTP标识为1的偶联，通路数据重传的最大次数5，心跳间隔500，SCTP重传的最大次数10。SET DSCTP:ID=1,MAXRTRY=5,HB=500,SCTPMAXRTRYNUM=10
GTP-C echo检测|对于使用GTP协议的接口，GTP协议通过ECHO Request/ECHO Response消息机制检测对端状态。当以配置间隔发送ECHORequest消息而未收到ECHO Response的次数达到最大配置次数后，则判定故障。|AMF与MME之间|AMF配置（N26接口）：ECHO消息发送次数：5次ECHO消息重发间隔(秒)：10秒|AMF配置命令举例：主动发送ECHO消息(是)、ECHO消息发送次数(5次)、ECHO消息重发间隔(10秒)。SET GTPNODEPOLICY:ECHOCONTROL="ENABLE",RETRYTIMES=5,RETRYINTERVAL=10
Diameter看门狗检测|Diameter支持设备看门狗消息。DWR、DWA是在本端实体与某个对等端实体之间的SCTP连接或者TCP连接建立成功且完成能力交换后，在连接上传送的Diameter心跳消息。当本节点发送DWR消息时设置定时器（时长为心跳检测时长），如果在定时器超时前收到DWA（Device-Watchdog-Answer，设备看门狗应答）消息，则本节点的链路状态检测为正常，定时器超时时重新发送DWR消息，且重新设置该定时器。如果定时器超时时未接收到DWA消息，则链路状态检测为异常。|BSF与PCF之间BSF与DRA之间|BSF配置：心跳检测： 无业务时周期检测心跳检测周期(秒)：30秒|BSF配置命令举例：针对Diameter链路ID=1的链路配置为“无业务时周期性检测”，检测周期为30秒。SET DLINK:ID=1,HB="NO_SERVICE",HBCYCLE=30;


## 各网元容灾方案 
### NRF 
#### NRF容灾 
##### 容灾组网 
NRF容灾组网如[图1](21.html#T_1604980389609__36bb894e-4173-48fa-886f-2a1e37491bfd)所示，NF的注册信息会在2个DC的NRF上自动同步，保证网元的注册数据不会因节点故障而丢失。
NRF提供本地备份功能，网元重启会重新导入本地备份的数据，并和另一NRF进行同步，保证重启后的NRF数据和工作NRF的数据同步。 
2个DC内的NRF之间的数据会自动同步，要求NRF节点间的数据同步网络具有较高的可靠性，因此部署NRF时需要使用DATA网络进行数据互通。 
图1  NRF容灾组网图
[]images/NRF%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%91.png)
##### 容灾原理 
一般情况下，各NF配置如下： 
相同DC的NRF，配置为主用NRF。 
不同DC的NRF，配置为备用NRF。 
特殊情况下，部分运营商根据自身网络规划，将所有NF都注册到主用NRF，备用NRF仅作为备用。 
正常情况下，NF和相同DC的NRF（即主用NRF）通讯。当主用NRF异常不能提供服务时，各NF请求超时或收到失败响应，判断主用NRF不能提供服务，则根据本地配置的备用NRF地址进行通讯。当主用NRF恢复正常后，NF可以把业务自动倒回到主用NRF上。 
##### 部署要求 
网元到NRF注册，采用互备模式，NF与NRF采用如下方式注册： 
DC1内的NF，主用连接DC1的NRF1，备用连接DC2的NRF2。 
DC2内的NF，主用连接DC2的NRF2，备用连接DC1的NRF1。 
##### 容灾业务流程 
如[图2](21.html#T_1604980389609__24ac0caa-625f-48e9-a489-ceac406e1f15)所示，以AMF为例说明NF到NRF的容灾流程，其他NF与NRF交互流程一致。
AMF通过本DC的NRF进行服务注册，同时通过本DC的NRF发现用户注册的AUSF/UDM，以及用户PDU会话的SMF。AMF通过保活消息检测到主NRF的状态，当保活消息在配置的指定次数内无响应时，AMF认为主用NRF故障，AMF选择备用NRF进行网元服务发现操作。
图2  NRF容灾业务流程
[]images/NRF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)流程说明如下： 
用户UE1发起注册请求，NR转发给AMF1。 
AMF1根据用户的SUPI和切片信息，查询本地配置的主用NRF，获取AUSF/UDM网元的IP地址。
AMF1通过主用NRF发现AUSF/UDM，为用户注册调用鉴权服务。 
AMF1通过主用AUSF/UDM获取用户的移动性管理签约信息，注册用户的连接管理信息，并订阅签约管理改变服务。 
完成UE1用户注册。 
AMF1通过保活检测，发现主用NRF故障。AMF1启用配置的备用NRF，为用户执行网元服务发现操作。 
用户UE2发起注册请求，NR转发给AMF1。 
AMF1向备用NRF发起AUSF/UDM网元的服务发现请求，获取高优先级AUSF/UDM。 
AMF1通过备用NRF发现的高优先级AUSF/UDM，为用户UE2的注册调用鉴权服务。 
成功完成用户鉴权后，AMF1通过主用AUSF/UDM获取用户的移动性管理签约信息，注册用户的连接管理信息，并订阅签约管理改变服务。 
完成UE2用户注册。 

AMF通过保活检测，定时向主用NRF进行检测，一旦发现主用NRF恢复，AMF使用主用NRF提供的服务。 
#### NRF容灾配置 
##### 配置前提 
已完成网元的基本配置。 
##### 数据规划 
LNRF数据规划
LNRF（二级NRF）的数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
主用LNRF|备用LNRF
---|---
增加NF标识配置ADD NFCFG|NF标识|141|142|NF的唯一标识。
NF名称|增加NF标识配置ADD NFCFG|NRF141|NRF142|NF的名称。
NF类型|增加NF标识配置ADD NFCFG|本局：self_nf对端局：diff_tmsp_nf|本局：self_nf对端局：diff_tmsp_nf|NF的类型。包括：self_nf：本地NFsame_tmsp_nf：和本地NF部署在同一TMSP的其他NFdiff_tmsp_nf：和本地NF部署在不同TMSP的其他NF
增加本地网络配置ADD NFNET|ID|141|142|配置记录唯一标识，无实际含义。
IP地址类型|增加本地网络配置ADD NFNET|IPV6|IPV6|本端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加本地网络配置ADD NFNET|240e:180:2e1:ff00::11|240e:180:2e2:ff00::11|本端IP地址，支持IPV4和IPV6。本端IP地址不可同时用于其他用途。
VPNID|增加本地网络配置ADD NFNET|21|21|VPN ID。
增加对端网络配置ADD NFSEED|ID|1|1|配置记录唯一标识。
NF ID|增加对端网络配置ADD NFSEED|142|141|对端节点归属的NF的唯一标识。
节点类型|增加对端网络配置ADD NFSEED|CUDR_DMCC|CUDR_DMCC|对端节点类型。包括CUDR_DMCC：CUDR控制中心PROV_PDM_SRV_SCCU：受理服务SCCUPROV_PGW_SCCU：受理网关SCCU
IP地址类型|增加对端网络配置ADD NFSEED|IPV6|IPV6|对端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加对端网络配置ADD NFSEED|240e:180:2e2:ff00::11|240e:180:2e1:ff00::11|对端IP地址，支持IPV4和IPV6。
IP端口|增加对端网络配置ADD NFSEED|60001|60001|对端IP监听端口，根据对端节点类型配置，包括：CUDR控制中心：固定配置为60001受理服务SCCU：固定配置为30001受理网关SCCU：固定配置为20001
NRF容灾策略配置SET BACKUPPOLICY|容灾方式|POOL|POOL|定义NRF容灾策略为POOL双活或STANDBY主备模式。
UDR功能选项配置SET UDSFUNC|租户ID|1|1|租户的唯一标识。通过SHOW UDSTENANT命令可以查看已创建的租户ID。
是否启用动态数据合并功能|UDR功能选项配置SET UDSFUNC|YES|YES|是否启用动态数据合并功能。例如集群内节点间断链，此时会造成数据失步或流水号不接序等，此时需要进行动态数据合并。可以选择：是：启用动态数据合并功能。否：不启用动态数据合并功能。该参数默认为启用动态数据合并。使用默认值。修改取值会对业务造成影响，不建议自行修改。如要修改，请务必先联系ZTE进行确认
增加动态合并规则配置1ADD MERGERULE|Schema工程名|uspp|uspp|Schema工程名，通过SHOW UDSTENANT命令可以查看已创建的schema工程名。
序号|增加动态合并规则配置1ADD MERGERULE|1|1|序号，从1开始连续，在一个Schema工程名下唯一，不同的schema中可以重复。
长度|增加动态合并规则配置1ADD MERGERULE|500|500|指示合并规则字段Context的长度，便于读取。
合并规则内容|增加动态合并规则配置1ADD MERGERULE|{$RID = 1; $TID = 19;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfIdLog ==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex+$SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|{$RID = 1; $TID = 19;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfIdLog ==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex+$SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|合并规则的内容。
增加动态合并规则配置2ADD MERGERULE|Schema工程名|uspp|uspp|Schema工程名，通过SHOW UDSTENANT命令可以查看已创建的schema工程名。
序号|增加动态合并规则配置2ADD MERGERULE|2|2|序号，从1开始连续，在一个Schema工程名下唯一，不同的schema中可以重复。
长度|增加动态合并规则配置2ADD MERGERULE|500|500|指示合并规则字段Context的长度，便于读取。
合并规则内容|增加动态合并规则配置2ADD MERGERULE|{$RID = 1; $TID = 21;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfInstanceID == $SRC.nfInstanceID + $SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|{$RID = 1; $TID = 21;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfInstanceID == $SRC.nfInstanceID + $SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|合并规则的内容。
HNRF数据规划
HNRF（即PNRF，一级NRF）数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
主用HNRF|备用HNRF
---|---
增加NF标识配置ADD NFCFG|NF标识|231|232|NF的唯一标识。
NF名称|增加NF标识配置ADD NFCFG|HNRF231|HNRF232|NF的名称。
NF类型|增加NF标识配置ADD NFCFG|NRF141：self_nfNRF142：diff_tmsp_nf|NRF142：self_nfNRF141：diff_tmsp_nf|NF的类型。包括：self_nf：本地NFsame_tmsp_nf：和本地NF部署在同一TMSP的其他NFdiff_tmsp_nf：和本地NF部署在不同TMSP的其他NF
增加本地网络配置ADD NFNET|ID|231|232|配置记录唯一标识，无实际含义。
IP地址类型|增加本地网络配置ADD NFNET|IPV6|IPV6|本端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加本地网络配置ADD NFNET|240E:0180:02E1:FF00::0045|240E:0180:02E2:FF00::0045|本端IP地址，支持IPV4和IPV6。本端IP地址不可同时用于其他用途。
VPNID|增加本地网络配置ADD NFNET|21|21|VPN ID。
增加对端网络配置ADD NFSEED|ID|1|1|配置记录唯一标识。
NF ID|增加对端网络配置ADD NFSEED|232|231|对端节点归属的NF的唯一标识。
节点类型|增加对端网络配置ADD NFSEED|CUDR_DMCC|CUDR_DMCC|对端节点类型。包括CUDR_DMCC：CUDR控制中心PROV_PDM_SRV_SCCU：受理服务SCCUPROV_PGW_SCCU：受理网关SCCU
IP地址类型|增加对端网络配置ADD NFSEED|IPV6|IPV6|对端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加对端网络配置ADD NFSEED|240E:0180:02E2:FF00::0045|240E:0180:02E1:FF00::0045|对端IP地址，支持IPV4和IPV6。
IP端口|增加对端网络配置ADD NFSEED|60001|60001|对端IP监听端口，根据对端节点类型配置，包括：CUDR控制中心：固定配置为60001受理服务SCCU：固定配置为30001受理网关SCCU：固定配置为20001
NRF容灾策略配置SET BACKUPPOLICY|容灾方式|POOL|POOL|定义NRF容灾策略为POOL双活或STANDBY主备模式。
UDR功能选项配置SET UDSFUNC|租户ID|1|1|租户的唯一标识。通过SHOW UDSTENANT命令可以查看已创建的租户ID。
是否启用动态数据合并功能|UDR功能选项配置SET UDSFUNC|YES|YES|是否启用动态数据合并功能。例如集群内节点间断链，此时会造成数据失步或流水号不接序等，此时需要进行动态数据合并。可以选择：是：启用动态数据合并功能。否：不启用动态数据合并功能。该参数默认为启用动态数据合并。使用默认值。修改取值会对业务造成影响，不建议自行修改。如要修改，请务必先联系ZTE进行确认。
增加动态合并规则配置1ADD MERGERULE|Schema工程名|uspp|uspp|Schema工程名，通过SHOW UDSTENANT命令可以查看已创建的schema工程名。
序号|增加动态合并规则配置1ADD MERGERULE|1|1|序号，从1开始连续，在一个Schema工程名下唯一，不同的schema中可以重复。
长度|增加动态合并规则配置1ADD MERGERULE|500|500|指示合并规则字段Context的长度，便于读取。
合并规则内容|增加动态合并规则配置1ADD MERGERULE|{$RID = 1; $TID = 19;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfIdLog ==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex+$SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|{$RID = 1; $TID = 19;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfIdLog ==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex+$SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|合并规则的内容。
增加动态合并规则配置2ADD MERGERULE|Schema工程名|uspp|uspp|Schema工程名，通过SHOW UDSTENANT命令可以查看已创建的schema工程名。
序号|增加动态合并规则配置2ADD MERGERULE|2|2|序号，从1开始连续，在一个Schema工程名下唯一，不同的schema中可以重复。
长度|增加动态合并规则配置2ADD MERGERULE|500|500|指示合并规则字段Context的长度，便于读取。
合并规则内容|增加动态合并规则配置2ADD MERGERULE|{$RID = 1; $TID = 21;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfInstanceID == $SRC.nfInstanceID + $SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|{$RID = 1; $TID = 21;$TIMEID=; $REF={};$OPER= {$UPDATE $FLT={$DEST.nfInstanceID == $SRC.nfInstanceID + $SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}|合并规则的内容。
##### 配置步骤 
LNRF141配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NFCFG:NFID=141,NFNAME="NRF141",NFTYPE="self_nf"ADD NFCFG:NFID=142,NFNAME="NRF142",NFTYPE="diff_tmsp_nf"
2|增加NF网络参数配置|ADD NFNET:ID=141,IPTYPE="IPV6",IP="240e:180:2e1:ff00::11",VPNID=21
3|增加NFSEED配置|ADD NFSEED:ID=1,NFID=142,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240e:180:2e2:ff00::11",PORT=60001
4|NRF容灾策略配置|SET BACKUPPOLICY:BACKUPPOLICY="POOL"
5|UDR功能选项配置|SET UDSFUNC:TENANTID=1,DYNMERGEFLAG="YES"
6|增加动态合并规则配置|ADD MERGERULE:SCHPRJNAME="uspp",INDEX=1,LEN=500,CONTEXT="{$RID= 1; $TID = 19;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfIdLog==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex +$SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"ADD MERGERULE:SCHPRJNAME="uspp",INDEX=2,LEN=500,CONTEXT="{$RID= 1; $TID = 21;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfInstanceID== $SRC.nfInstanceID + $SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"
LNRF142配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NF:NFID=142,NFNAME="NRF142",NFTYPE="self_nf"ADD NF:NFID=141,NFNAME="NRF141",NFTYPE="diff_tmsp_nf"
2|增加NF网络参数配置|ADD NFNET:ID=142,IPTYPE="IPV6",IP="240e:180:2e2:ff00::11",VPNID=21
3|增加NFSEED配置|ADD NFSEED:ID=1,NFID=141,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240e:180:2e1:ff00::11",PORT=60001
4|NRF容灾策略配置|SET BACKUPPOLICY:BACKUPPOLICY="POOL"
5|UDR功能选项配置|SET UDSFUNC:TENANTID=1,DYNMERGEFLAG="YES"
6|增加动态合并规则配置|ADD MERGERULE:SCHPRJNAME="uspp",INDEX=1,LEN=500,CONTEXT="{$RID= 1; $TID = 19;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfIdLog==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex +$SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"ADD MERGERULE:SCHPRJNAME="uspp",INDEX=2,LEN=500,CONTEXT="{$RID= 1; $TID = 21;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfInstanceID== $SRC.nfInstanceID + $SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"
HNRF231配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NFCFG:NFID=231,NFNAME="HNRF231",NFTYPE="self_nf"ADD NFCFG:NFID=232,NFNAME="HNRF232",NFTYPE="diff_tmsp_nf"
2|增加NF网络参数配置|ADD NFNET:ID=231,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::0045",VPNID=21
3|增加NFSEED配置|ADD NFSEED:ID=1,NFID=232,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::0045",PORT=60001
4|NRF容灾策略配置|SET BACKUPPOLICY:BACKUPPOLICY="POOL"
5|UDR功能选项配置|SET UDSFUNC:TENANTID=1,DYNMERGEFLAG="YES"
6|增加动态合并规则配置|ADD MERGERULE:SCHPRJNAME="uspp",INDEX=1,LEN=500,CONTEXT="{$RID= 1; $TID = 19;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfIdLog==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex +$SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"ADD MERGERULE:SCHPRJNAME="uspp",INDEX=2,LEN=500,CONTEXT="{$RID= 1; $TID = 21;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfInstanceID== $SRC.nfInstanceID + $SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"
HNRF232配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NF:NFID=232,NFNAME="HNRF232",NFTYPE="self_nf"ADD NF:NFID=231,NFNAME="HNRF231",NFTYPE="diff_tmsp_nf"
2|增加NF网络参数配置|ADD NFNET:ID=232,IPTYPE="IPV6",IP="240E:0180:02E2:FF00::0045",VPNID=21
3|增加NFSEED配置|ADD NFSEED:ID=1,NFID=231,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::0045",PORT=60001
4|NRF容灾策略配置|SET BACKUPPOLICY:BACKUPPOLICY="POOL"
5|UDR功能选项配置|SET UDSFUNC:TENANTID=1,DYNMERGEFLAG="YES"
6|增加动态合并规则配置|ADD MERGERULE:SCHPRJNAME="uspp",INDEX=1,LEN=500,CONTEXT="{$RID= 1; $TID = 19;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfIdLog==$SRC.nfIdLog + $DEST.nfProfileIndex==$SRC.nfProfileIndex +$SRC.validityTime> $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"ADD MERGERULE:SCHPRJNAME="uspp",INDEX=2,LEN=500,CONTEXT="{$RID= 1; $TID = 21;$TIMEID=; $REF={};$OPER = {$UPDATE $FLT={$DEST.nfInstanceID== $SRC.nfInstanceID + $SRC.validityTime > $DEST.validityTime} $VAL=$SRC.*};$NTF={}}"
周边网元配置
网元|配置说明|配置命令
---|---|---
AMF1|配置主备NRF的信息|ADD NRFNODECFG:NRFNODELISTID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E1:FF00::009",PRIORITY=1,PORT=8080,APIVERSION="V1"
ADD NRFNODECFG:NRFNODELISTID=2,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E2:FF00::009",PRIORITY=1,PORT=8080,APIVERSION="V1"|AMF1|配置主备NRF的信息
配置NRF注册的HTTP模板|AMF1|ADD NRFNODETEMPCFG:NRFNODEID=1,HTTPCLIENTTMPID=1
ADD NRFNODETEMPCFG:NRFNODEID=2,HTTPCLIENTTMPID=1|配置NRF注册的HTTP模板|AMF1
配置NRF工作模式、倒换模式|AMF1|SET NRFPOLICYCFG:NRFPATTERN="DUAL_ACTIVE",NRFENABLEMODE="AUTO"
AMF2|配置主备NRF的信息|ADD NRFNODECFG:NRFNODELISTID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E2:FF00::009",PRIORITY=1,PORT=8080,APIVERSION="V1"
ADD NRFNODECFG:NRFNODELISTID=2,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E1:FF00::009",PRIORITY=1,PORT=8080,APIVERSION="V1"|AMF2|配置主备NRF的信息
配置NRF注册的HTTP模板|AMF2|ADD NRFNODETEMPCFG:NRFNODEID=1,HTTPCLIENTTMPID=1
ADD NRFNODETEMPCFG:NRFNODEID=2,HTTPCLIENTTMPID=1|配置NRF注册的HTTP模板|AMF2
配置NRF工作模式、倒换模式|AMF2|SET NRFPOLICYCFG:NRFPATTERN="DUAL_ACTIVE",NRFENABLEMODE="AUTO"
SMF1|配置主备NRF的信息|ADD NRFNODEIP:NRFNODEID=1,HTTPCLIENTTMPID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E1:FF00::009",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"
ADD NRFNODEIP:NRFNODEID=2,HTTPCLIENTTMPID=1,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E2:FF00::009",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"|SMF1|配置主备NRF的信息
配置NRF工作模式、倒换模式|SMF1|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
配置NRF响应等待时长|SMF1|SET NRFHTTPRSPTIMER:NRFHTTPRSPTIMER=1000 /*数值仅供参考，需确认后实施。*/
SMF2|配置主备NRF的信息|ADD NRFNODEIP:NRFNODEID=1,HTTPCLIENTTMPID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E2:FF00::009",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"
ADD NRFNODEIP:NRFNODEID=2,HTTPCLIENTTMPID=1,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="240E:0180:02E1:FF00::009",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"|SMF2|配置主备NRF的信息
配置NRF工作模式、倒换模式|SMF2|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
配置NRF响应等待时长|SMF2|SET NRFHTTPRSPTIMER:NRFHTTPRSPTIMER=1000 /*数值仅供参考，需确认后实施。*/
PCF1|配置主备NRF的信息|ADD NRF:ID=1,MSTIPADDR="240E:0180:02E1:FF00:0000:0000:0000:0009",MSTPORT=8080,IPTYPE="IPV6",UPDATEMODE="INCREMENT",CLIENTPROFID=1,ROLE="MASTER",PRIORITY=1,VERSION="v1"
ADD NRF:ID=2,MSTIPADDR="240E:0180:02E2:FF00:0000:0000:0000:0009",MSTPORT=8080,IPTYPE="IPV6",UPDATEMODE="INCREMENT",CLIENTPROFID=1,ROLE="SLAVE",PRIORITY=1,VERSION="v1"|PCF1|配置主备NRF的信息
配置NRF工作模式、倒换模式|PCF1|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
PCF2|配置主备NRF的信息|ADD NRF:ID=1,MSTIPADDR="240E:0180:02E2:FF00:0000:0000:0000:0009",MSTPORT=8080,IPTYPE="IPV6",UPDATEMODE="INCREMENT",CLIENTPROFID=1,ROLE="MASTER",PRIORITY=1,VERSION="v1"
ADD NRF:ID=2,MSTIPADDR="240E:0180:02E1:FF00:0000:0000:0000:0009",MSTPORT=8080,IPTYPE="IPV6",UPDATEMODE="INCREMENT",CLIENTPROFID=1,ROLE="SLAVE",PRIORITY=1,VERSION="v1"|PCF2|配置主备NRF的信息
配置NRF工作模式、倒换模式|PCF2|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
UDM1|配置主备NRF的信息|ADD NRFNODE:NRFID=1,TYPE="ACTIVE",IP="240E:0180:02E1:FF00::009",PORT=8080,PRIORITY=0,SCHEMA="http",HTTPCLTTMPID=1
ADD NRFNODE:NRFID=2,TYPE="BACKUP",IP="240E:0180:02E2:FF00::009",PORT=8080,PRIORITY=1,SCHEMA="http",HTTPCLTTMPID=1|UDM1|配置主备NRF的信息
UDM2|配置主备NRF的信息|ADD NRFNODE:NRFID=1,TYPE="ACTIVE",IP="240E:0180:02E2:FF00::009",PORT=8080,PRIORITY=0,SCHEMA="http",HTTPCLTTMPID=1
ADD NRFNODE:NRFID=2,TYPE="BACKUP",IP="240E:0180:02E1:FF00::009",PORT=8080,PRIORITY=1,SCHEMA="http",HTTPCLTTMPID=1|UDM2|配置主备NRF的信息
HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。|ADD NRFSETNRFINFO:NRFINDEX="SC_LNRF1",NFINSTANCEID="34c2a3ee-0c63-4a87-bd87-181151010100",ACCESSTYPE="BYIP"
ADD NRFSETNRFINFO:NRFINDEX="SC_LNRF2",NFINSTANCEID="df7b8fe9-2050-45ae-96a7-011151010200",ACCESSTYPE="BYIP"|HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_LNRF1",NRFSETINDEX="SC_LNRF",PRIORITY=5|HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_LNRF2",NRFSETINDEX="SC_LNRF",PRIORITY=4|HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_LNRF1",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E1:FF00::009",NRFPORT=8080|HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_LNRF2",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E2:FF00::009",NRFPORT=8080|HNRF01|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。|ADD NRFSETNRFINFO:NRFINDEX="SC_LNRF1",NFINSTANCEID="34c2a3ee-0c63-4a87-bd87-181151010100",ACCESSTYPE="BYIP"
ADD NRFSETNRFINFO:NRFINDEX="SC_LNRF2",NFINSTANCEID="30f4379b-2b10-470e-bfa5-181151010200",ACCESSTYPE="BYIP"|HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_LNRF1",NRFSETINDEX="SC_LNRF",PRIORITY=4|HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_LNRF2",NRFSETINDEX="SC_LNRF",PRIORITY=5|HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_LNRF1",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E1:FF00::009",NRFPORT=8080|HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_LNRF2",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E2:FF00::009",NRFPORT=8080|HNRF02|主要配置LNRF的信息，和其他大区的HNRF的信息。举例为配置的本地LNRF的数据，由优先级判断主用还是备用。数值越大优先级越高。
LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。|ADD NRFSETNRFINFO:NRFINDEX="SC_HNRF1",NFINSTANCEID="0b221612-863f-40ad-b3b6-c941bfd9d8ce",ACCESSTYPE="BYIP"
ADD NRFSETNRFINFO:NRFINDEX="SC_HNRF2",NFINSTANCEID="df7b8fe9-2050-45ae-96a7-e0979c261130",ACCESSTYPE="BYIP"|LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_HNRF1",NRFSETINDEX="SC_HNRF",PRIORITY=5|LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_HNRF2",NRFSETINDEX="SC_HNRF",PRIORITY=4|LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_HNRF1",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E1:FF00::0045",NRFPORT=8080|LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_HNRF2",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E2:FF00::0045",NRFPORT=8080|LNRF1|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。|ADD NRFSETNRFINFO:NRFINDEX="SC_HNRF1",NFINSTANCEID="0b221612-863f-40ad-b3b6-c941bfd9d8ce",ACCESSTYPE="BYIP"
ADD NRFSETNRFINFO:NRFINDEX="SC_HNRF2",NFINSTANCEID="df7b8fe9-2050-45ae-96a7-e0979c261130",ACCESSTYPE="BYIP"|LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_HNRF1",NRFSETINDEX="SC_HNRF",PRIORITY=4|LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD NRFSETNRFMAP:NRFINDEX="SC_HNRF2",NRFSETINDEX="SC_HNRF",PRIORITY=5|LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_HNRF1",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E1:FF00::0045",NRFPORT=8080|LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
ADD ROUTENRFIP:NRFINDEX="SC_HNRF2",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="240E:0180:02E2:FF00::0045",NRFPORT=8080|LNRF2|主要配置HNRF的信息，由优先级判断主用还是备用。数值越大优先级越高。
BSF1|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。|ADD DNFDISC:ID=1,NRFIPTYPE="IPTYPE6",NRFIP="240E:0180:02E1:FF00:0000:0000:0000:0009",NRFPORT=8080,STANDBY="MASTER",PRIORITY=100,SCHEMA="HTTP",VERSION="V1",LOCALNFTYPE="AF"
ADD DNFDISC:ID=2,NRFIPTYPE="IPTYPE6",NRFIP="240E:0180:02E2:FF00:0000:0000:0000:0009",NRFPORT=8080,STANDBY="SLAVE",PRIORITY=200,SCHEMA="HTTP",VERSION="V1",LOCALNFTYPE="AF"|BSF1|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
ADD SELPF:ID=1,IPFAMILY="IPV6",STARTIP="240E:0180:02E1:FF00:0000:0000:0000:0009",ENDIP="240E:0180:02E1:FF00:0000:0000:0000:0009",PORT=8080,CPROFILE=1-1|BSF1|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
ADD SELPF:ID=2,IPFAMILY="IPV6",STARTIP="240E:0180:02E2:FF00::009",ENDIP="240E:0180:02E2:FF00::009",PORT=8080,CPROFILE=1-1|BSF1|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
BSF2|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。|ADD DNFDISC:ID=1,NRFIPTYPE="IPTYPE6",NRFIP="240E:0180:02E2:FF00:0000:0000:0000:0009",NRFPORT=8080,STANDBY="MASTER",PRIORITY=100,SCHEMA="HTTP",VERSION="V1",LOCALNFTYPE="AF"
ADD DNFDISC:ID=2,NRFIPTYPE="IPTYPE6",NRFIP="240E:0180:02E1:FF00:0000:0000:0000:0009",NRFPORT=8080,STANDBY="SLAVE",PRIORITY=200,SCHEMA="HTTP",VERSION="V1",LOCALNFTYPE="AF"|BSF2|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
ADD SELPF:ID=1,IPFAMILY="IPV6",STARTIP="240E:0180:02E2:FF00:0000:0000:0000:0009",ENDIP="240E:0180:02E2:FF00:0000:0000:0000:0009",PORT=8080,CPROFILE=1-1|BSF2|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
ADD SELPF:ID=2,IPFAMILY="IPV6",STARTIP="240E:0180:02E1:FF00::009",ENDIP="240E:0180:02E1:FF00::009",PORT=8080,CPROFILE=1-1|BSF2|主要需要配置主备NRF的信息，以及到LNRF的客户端模板选择配置。
##### 指标监控 
性能统计
NRF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|Nnrf_NFDiscovery接口|C540070001 接收Nnrf Discovery Request次数
2|C540070002 发送Nnrf Discovery SuccessResponse次数|Nnrf_NFDiscovery接口
3|NF发现过程|C540040011 NF发起的发现AMF请求次数
4|C540040021 NF发起的发现AMF成功次数|NF发现过程
5|C540040012 NF发起的发现SMF请求次数|NF发现过程
6|C540040022 NF发起的发现SMF成功次数|NF发现过程
7|C540040013 NF发起的发现AUSF请求次数|NF发现过程
8|C540040023 NF发起的发现AUSF成功次数|NF发现过程
9|C540040014 NF发起的发现UDM请求次数|NF发现过程
10|C540040024 NF发起的发现UDM成功次数|NF发现过程
11|C540040015 NF发起的发现PCF请求次数|NF发现过程
12|C540040025 NF发起的发现PCF成功次数|NF发现过程
13|C540040016 NF发起的发现BSF请求次数|NF发现过程
14|C540040026 NF发起的发现BSF成功次数|NF发现过程
告警与通知
NRF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|3406823426 注册NF的状态变更
2|3407216643 NF网元管理QPS超过门限告警
3|3407216644 服务发现QPS超过门限告警
4|3406823440 主备局断链告警
5|3406888961 容灾数据恢复失败通知
### AMF 
#### AMF容灾 
##### 容灾组网 
AMF容灾组网方式为AMF POOL。 
一个AMF POOL由多个为相同区域和网络切片提供服务的AMF组成。AMF POOL内的AMF为区域内的UE提供服务，共同分担处理区域内所有UE的业务。UE在AMF POOL所服务的区域间移动不需要改变服务AMF。区域内的(R)AN与AMF POOL内的所有AMF均进行互联。 
图1  AMF POOL逻辑组网图
[]images/Ch-0XF-H-F6AMPfqAAFVKpLx6sA298.png)
目前运营商多采用大区组网方式，在此组网方式下，为某个业务区域（或省份）提供网络服务的多个AMF组成AMF POOL。出于容灾考虑，将POOL内的AMF同时分布于主用大区和备用大区中。区域（或省份）内的业务将由(R)AN根据各AMF的容量、权重、负荷分担等因素选择POOL内的AMF进行处理。 
DC级组网方式，AMF容灾的工作原理与大区级组网方式类似。 
##### 容灾原理 
正常情况下，AMF POOL内的各AMF共同分担区域内的话务。当AMF发生故障或外部链路故障后，由(R)AN或其他控制面NF（如SMF/PCF/UDM等）将话务发送至正常的AMF进行业务恢复。 
具体原理如下： 
对AMF用户数据进行备份。在AMF正常运行过程中，需要将用户标识及其位置信息（如SUPI/TAList/5G-GUTI）备份到POOL内的其他AMF（即备份AMF）上，当此AMF发生故障后，备份AMF可以通过用户备份数据对用户进行寻呼，从而实现终呼（即终端作为被叫）流程触发的业务恢复流程。因此，为完成用户数据备份，需要为每台AMF配置其备份AMF。在大区组网的情况下，若考虑大区级容灾，则备份AMF需要选择与本AMF部署在不同大区中的AMF。DC级组网等场景与该场景类似。 
AMF需要通过NRF注册功能将备份关系注册到NRF上，以便其他控制面NF（如SMF/PCF/UDM等）可以通过服务发现功能来获取备份AMF信息。AMF及备份AMF分别向NRF注册，并携带与其相关的主备AMF信息。备份AMF将其与AMF的备份关系同时注册到NRF中，其他NF可以通过NRF获取AMF之间的备份关系。同时，AMF在与CPNF（SMF，PCF等）交互中，也会将其备份AMF的信息通过交互信令携带给CPNF。AMF与NRF之间进行心跳检测。当NRF检测到当前和AMF之间的心跳消息异常，则判定该AMF异常并更新其状态。同时，AMF在计划性移除流程（即主动移除当前AMF的流程）中，主动发起到NRF的状态更新，异常AMF退出服务。在其它NF订阅AMF状态的情况下，当AMF发生异常，NRF会主动推送AMF状态异常信息给订阅者。同时，在其他控制面NF（如SMF/PCF/UDM等）通过NRF获取AMF时，NRF不会返回当前异常状态的AMF信息，而会返回其备份AMF信息。其他控制面NF（如SMF/PCF/UDM等）在AMF故障后，重新选择其备份AMF，并与备份AMF交互。 
通过上述处理，某AMF发生故障后： 
对于(R)AN发起的上行流程，(R)AN选择AMF POOL内其他正常的AMF，由AMF触发用户重注册，从而恢复业务处理。 
对于其他控制面NF（如SMF/PCF/UDM等）发起的下行流程，NF选择故障AMF的备份AMF，由备份AMF根据用户备份数据先寻呼用户，在用户发起业务请求后再触发用户重注册，从而恢复业务处理。 
##### 部署要求 
一个POOL中需要部署两套或以上的AMF设备，为相同区域和网络切片提供服务。 
区域内的(R)AN与AMF POOL内的所有AMF均需要进行网络互联。 
为AMF POOL内的每个AMF指定备份AMF。 
##### 容灾业务流程 
AMF状态订阅及故障检测
AMF的状态订阅及故障检测流程如下图所示。 
图2  AMF状态订阅及故障检测
[]images/Ch4MdF-H-JSAMBAAAAD5Ur9ifGk730.png)
AMF1（为了与备份AMF区分，称为原AMF）投入服务后，向NRF发起NF注册，携带GUAMI List。 
AMF2（即步骤1中AMF1的备份AMF）投入服务后，向NRF发起NF注册，携带GUAMI List，同时携带backupInfoAmfFailure及backupInfoAmfRemoval参数，取值均为原AMF的GUAMI，用于指示AMF2将作为AMF1的备份。 
AMF2向NRF发起AMF状态订阅，对AMF1的状态变更进行订阅，以便在AMF1维护或故障后获得订阅通知。 
AMF1在发送给gNodeB的NG SETUP RESPONSE消息中携带GUAMI List，此处可以根据配置选择是否携带Backup AMF Name。 
若AMF1未携带Backup AMF Name，对于(R)AN发起的上行流程，(R)AN可以选择POOL内的任意AMF执行业务恢复流程。 
若AMF1携带Backup AMF Name，对于(R)AN发起的上行流程，(R)AN选择备份AMF执行业务恢复流程。 
AMF1相邻的其他NF如SMF、PCF等向NRF发起AMF状态订阅，对有业务交互的AMF的状态变更进行订阅，以便在AMF维护或故障后获得通知。 
AMF1在正常工作状态，会周期性向NRF发送更新消息，实现NF与NRF之间的Heartbeat保活机制，以便NRF识别AMF故障。 
gNodeB向AMF1发送请求消息，但AMF1故障，无法响应请求消息。 
AMF1故障，无法正常向NRF发送Heartbeat保活机制的更新消息。 
gNodeB和NRF判定AMF1故障。 
NRF向订阅了AMF1状态的其他AMF（如备份AMF）发送状态变更通知消息，其他AMF（如备份AMF）获知AMF1故障。 
NRF向订阅了AMF1状态的其他NF发送状态变更通知消息，其他NF获知AMF1故障。 
(R)AN主动发起业务的AMF容灾流程
由(R)AN主动发起业务，容灾流程如下图所示。 
图3  (R)AN主动发起业务的AMF容灾流程
[]images/Ch4MdF-H-KqANwjDAACcY5ZBu6Y650.png)
AMF1（为了与备份AMF区分，称为原AMF）将Served GUAMI下发给gNodeB。 
AMF2（即步骤1中AMF1的备份AMF）通过NF注册流程将其备份的GUAMI保存到NRF中，供其他NF获取。 
用户接入网络并进行业务流程处理。 
AMF1在业务处理流程中，将用户关键信息同步到为其备份的AMF2中（AMF1和AMF2中均配置独占的UDSF服务）。备份AMF2保存同步数据。 
某时刻，AMF1发生故障。UE发起业务，gNodeB向AMF1发送消息但无响应。gNodeB判断AMF1故障。 
gNodeB将用户的请求消息发送给此AMF POOL内的其他AMF，如AMF2。 
若AMF1未携带Backup AMF Name给(R)AN，则对于(R)AN发起的上行流程，(R)AN可以选择POOL内的任意AMF执行业务恢复流程。 
若AMF1携带Backup AMF Name给(R)AN，则对于(R)AN发起的上行流程，(R)AN选择备份AMF执行业务恢复流程。 
AMF2接收用户请求后，无法正常获取用户上下文数据，按3GPP协议要求，触发用户重注册。对于移动性注册及业务请求，AMF2执行拒绝流程，并携带原因值Implicitly de-registered给UE触发UE重新发起注册。 
后续此UE执行注册流程，AMF2正常处理，业务恢复。 
控制面NF主动发起业务的AMF容灾流程
由控制面NF主动发起业务，容灾流程如下图所示。 
图4  控制面NF主动发起业务的AMF容灾流程
[]images/1605167512970.png)
各AMF在正常业务处理流程中，其中UE1用户的业务由AMF1处理。 
业务流程处理完毕，AMF1将用户关键信息同步到为其备份的AMF2中（AMF1和AMF2中均配置独占的UDSF服务，UDSF服务提供上下文数据存储的功能）。备份AMF2保存同步数据。 
某时刻，AMF1发生故障，无法正常向NRF发送Heartbeat保活机制的更新消息，NRF识别并判定AMF1故障。NRF向订阅了AMF1状态的备份AMF2以及其他NF如SMF，PCF等发送状态变更通知消息，备份AMF2以及其他NF等获知AMF1故障。 
（可选）在其他NF（如SMF、PCF等）本地没有保存AMF1的备份AMF信息的情况下，使用GUAMI向NRF发起AMF发现流程，用于获取AMF1的备份AMF信息。 
其他NF在需要主动发起业务流程的情况下，选择AMF1的备份AMF（即AMF2）。 
其他NF将业务消息发送给AMF2。 
AMF2查询用户上下文失败后，查询用户备份数据。 
AMF2使用用户备份数据寻呼用户。 
UE接收寻呼后，发起业务请求。 
AMF2接收用户请求后，无法正常获取用户上下文数据，按3GPP协议要求，触发用户重注册。AMF2返回业务请求拒绝消息，并携带原因值Implicitly de-registered以触发UE重新发起注册流程。 
后续此UE执行初始注册流程，AMF2正常处理，业务恢复。 
AMF计划性移除/维护处理的容灾流程
有计划的对AMF进行移除或维护处理时，AMF的容灾流程如下图所示。 
图5  AMF计划性移除/维护处理的容灾流程
[]images/1605785859285.png)
当AMF1升级或需要进行维护改造时，需要执行维护退服流程。 
根据不同的退服方式，可以选择执行如下操作。 
2a. 采用逐步退服的方式（即逐步将指定GUAMI的用户及业务迁移到AMF2），则向NRF发送NF更新消息，将后续不可用的GUAMI从NF Profile中移除。 
2b. 采用一次性退服的方式（即将全部GUAMI的用户及业务一次性迁移到AMF2），则向NRF发送去注册消息。 
AMF1向gNodeB发送AMF STATUS INDICATION消息，携带不可用的GUAMI List，用于指示不可用GUAMI的业务，这些业务需要gNodeB选择AMF2继续处理。 
NRF接收AMF1的更新或去注册消息后，根据具体的消息类型，向订阅了此AMF状态的备份AMF发送状态变更通知。 
NRF接收AMF1的更新或去注册消息后，根据具体的消息类型，向订阅了此AMF状态的其他NF（如SMF、PCF、UDM等）发送状态变更通知。 
后续gNodeB及其他NF将选择AMF2（即备份AMF），并向AMF2发送消息。根据消息类型不同，选择执行如下操作 。 
6a. 对于用户发起的注册消息，AMF2按局间流程尝试从AMF1获取上下文并继续后续处理。 
6b. 对于用户发起的其他请求，消息中无5G-GUTI信息，则触发用户进行重注册。 
6c. 其他NF将业务消息发送给AMF2，AMF2使用用户备份数据寻呼用户，用户发起业务请求。AMF2接收用户的业务请求后，无法正常获取用户上下文数据，按3GPP协议要求，触发用户重注册。 
#### AMF容灾配置 
##### 配置前提 
执行SHOW AMFLOCALOFFICECFG命令，查询并确认AMF POOL中各个AMF在本局配置中的权重一致。 
执行SHOW TACFG、SHOW REGAREACFG、SHOW REGAREA TAIDLIST命令，查询并确认在POOL内各AMF的配置一致。 
执行SHOW BACKUPDATA命令，在备份容灾AMF上查询用户的位置信息。 
##### 数据规划 
数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
AMF1|AMF2
---|---
修改容灾开关SET DISASTERSWITCHPARA|是否支持容灾功能|是|是|该参数用于配置是否开启AMF容灾功能，此选项涉及到多个业务功能。一般情况下，AMF在一开始部署时，就需要确认支持容灾功能，在不支持容灾功能的情况下，与容灾相关的所有配置都无法生效。
无UDSF时SBI是否携带NotifyIp|修改容灾开关SET DISASTERSWITCHPARA|是|是|该参数用于配置5GC网络中没有部署单独UDSF，即UDSF和AMF合一部署时，SBI（Service BasedInterface，基于服务的接口）是否携带NotifyIp。NotifyIp一般的作用为指示其它NF，在本NF故障或维护时，根据配置的NotifyIp，向备份NF发送消息，NotifyIp是通过 ADD NOTIFYIP命令配置的，具体配置数据可通过SHOW NOTIFYIP命令查询获取。
其他参数|修改容灾开关SET DISASTERSWITCHPARA|默认值|默认值|其他参数保持默认即可。
修改容灾策略SET DISASTERRECOVERYPOLICY|容灾策略配置|无UDSF部分备份|无UDSF部分备份|本参数用于设置AMF的容灾策略。有UDSF，表示5GC网络中部署了单独UDSF且备份方式为全量用户信息。此种情况下，POOL内所有AMF共享一个UDSF，此UDSF包括所有AMF的租户信息和所有AMF的用户数据。无UDSF全量备份，表示5GC网络中没有部署单独UDSF且备份方式为全量用户信息。此种情况下，UDSF会跟AMF一起部署，UDSF内置在AMF中，POOL内所有AMF按照GUAMI粒度相互备份，单个UDSF包含其主用AMF及可接管GUAMI对应AMF的租户信息和用户数据。无UDSF部分备份，表示5GC网络中没有部署单独UDSF且备份方式为部分用户信息。此种情况下，UDSF会跟AMF一起部署，UDSF内置在AMF中，POOL内所有AMF按照GUAMI粒度相互备份，单个UDSF包含其主用AMF的租户信息和用户数据及可接管GUAMI对应AMF的在线用户数据（包括SUPI、GUTI和TA List信息）。一个POOL内所有的AMF应当设置为相同的策略。
控制策略配置SET CONTROLPOLICY|携带备份AMF开关|携带|携带|本参数用于配置部分备份容灾功能启用时，是否携带备份AMF给RAN。
其他参数|控制策略配置SET CONTROLPOLICY|默认值|默认值|其他参数保持默认即可。
GUAMI池配置ADD GUAMICFG|GUAMI标识|1|2|该参数用于配置AMF的GUAMI ID，后续可以通过此ID获取详细的GUAMI信息。
移动国家码|GUAMI池配置ADD GUAMICFG|460|460|该参数用于配置MCC（Mobile CountryCode，移动国家码），由运营商根据国际电联分配的国家码进行规划配置，用于在移动网络中，唯一标识一个国家信息，例如中国为460。MCC对于所有的记录都是唯一的。
移动网络码|GUAMI池配置ADD GUAMICFG|11|11|该参数用于配置MNC（Mobile NetworkCode，移动网络号），由运营商根据国际电联分配的网络号进行规划配置，用于在移动网络中，基于MCC唯一标识一个运营商网络信息。例如运营商“中国移动“在中国运营的GSM网络的MNC为01。MCC和MNC标识唯一的一个PLMN，标识移动用户的归属PLMN，也就是移动用户归属的运营商的移动网络。
Region标识|GUAMI池配置ADD GUAMICFG|37|37|该参数用于配置AMF Region标识，是当前AMF服务区域的标识，由运营商统一规划。
Set标识|GUAMI池配置ADD GUAMICFG|37|37|该参数用于配置AMF Set标识，是当前AMF所归属的AMF Set的标识，在AMF Region内唯一，由运营商统一规划。
Point标识|GUAMI池配置ADD GUAMICFG|11|14|该参数用于配置AMF Pointer标识，是当前AMF所对应的AMF Set内的一个Pointer，由运营商统一规划。
本局GUAMI配置ADD LOCALGUAMI|Guami标识|1|2|本参数用于配置本AMF对应的GUAMI ID的列表，后续还需要通过ADD GUMMEICFG命令配置与GUAMI ID对应的真实GUAMI。
AMF资源标识配置ADD AMFNRI|AMF名称|amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|该参数用于配置AMF名称，和AMF NRI是一一对应关系，AMF根据AMF NRI查询获取到AMF名称，就可以确认该N2APID是由AMF Set中的哪个AMF分配的。
AMF资源标识|AMF资源标识配置ADD AMFNRI|1|2|该参数用于配置AMF NRI，AMF NRI是N2AP ID的一部分。AMF向每个终端分配N2APID来关联当前终端的N2连接。
修改AMF本局配置SET AMFLOCALOFFICECFG|AMF名称|amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|本参数用于配置AMF名称。举例：amf1.cluster1.net2.amf.5gc.mnc012.mcc345.3gppnetwork.org，其中amf.5gc.mnc012.mcc345.3gppnetwork.org，需要严格按照协议定义格式来配置。如果本参数发生了变化，AMF需要通知NR和NRF等NF，会触发AMF向NR、NRF发起更新流程。AMF名称需要和UDSF租户名称保持一致，修改后需要重启业务相关容器（Communication、EEX、MT以及RM）。
备份AMF配置ADD BACKUPAMF|GUAMI标识|1|2|该参数用于设置需要备份的AMF的GUAMI ID。
AMF名称|备份AMF配置ADD BACKUPAMF|amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|该参数用于设置备份AMF的名称，本AMF的所有GUAMI只需要配置同一个AMF Set的其他AMF作为备份AMF。本参数的取值来源需要到备份AMF上获取，在备份AMF上通过SHOW BACKUPAMF命令，查询备份AMF的名称。每条记录中指定的备份AMFName必须跟指定备份AMF所配置的AMF Name保持一致。
接管AMF配置ADD TAKEOVERAMF|backup GUAMI标识|2|1|该参数用于设置本AMF需要接管的AMF的GUAMI ID，这些GUAMI ID应该来自同一AMF。本参数的取值来源需要到接管的对应AMF上获取，在接管AMF上通过SHOW LOCALGUAMI命令，查询接管AMF的GUAMI ID。
主用amf名称|接管AMF配置ADD TAKEOVERAMF|amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|本参数用于配置本AMF需要接管的AMF的名称。本AMF上电时，需要提前为需要接管的AMF建立租户DB，依据的就是这个主用AMF Name，配置中有几个主用AMF Name，就需要额外建立相应的租户DB。这样本AMF在接管这些主用AMFName的GUAMI上的终端用户数据时，依据该主用AMF Name对应的租户，向UDSF获取对应的终端用户数据。本参数的取值需要到对应的待接管AMF上获取，在待接管AMF上通过SHOWBACKUPAMF命令，查询待接管AMF的名称。
部分备份配置SET CONTROLPARA|备份AMF的GTPC地址|38.16.16.16|37.16.16.16|该参数用于配置备份AMF的GTPC地址，该AMF用来备份用户动态信息数据。该地址需要配置为IPv4地址或IPv6地址。
Set内其他AMF配置ADD OTHERAMFCFG|Pointer标识|14|11|该参数用于配置Set内其他AMF的Pointer标识。
IP地址|Set内其他AMF配置ADD OTHERAMFCFG|192.38.80.100|192.37.80.100|该参数用于配置Set内其他AMF的IP地址，用于获取用户上下文数据。
端口号|Set内其他AMF配置ADD OTHERAMFCFG|8080|8080|该参数用于配置Set内其他AMF的端口号，用于获取用户上下文数据。
URI Schema|Set内其他AMF配置ADD OTHERAMFCFG|http|http|该参数用于设置Set内其他AMF的URI Scheme。比如 "http"、"https"。
API版本|Set内其他AMF配置ADD OTHERAMFCFG|v1|v1|该参数用于配置Set内其他AMF的API版本号。比如V1或V2。
租户配置SET CDBTENANT|租户ID|1|1|该参数用于唯一标识一个租户，不可重复。
租户名称|租户配置SET CDBTENANT|amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org|该参数用于指示租户名称，不可重复。注：如果AMF Name有变化（比如修改了amf name），则一定要重启AMF。否则和CDB之间不通。
主用NF(局)标识|租户配置SET CDBTENANT|37|38|该参数用于指示租户对应的主用NF标识。与部署时规划的值一致。
备用NF(局)标识|租户配置SET CDBTENANT|0|0|该参数用于指示租户对应的备用NF标识。无备用NF时，默认为0。
访问策略|租户配置SET CDBTENANT|缺省|缺省|该参数用于指示租户访问UDSF的访问策略。取值如下：default_access：缺省local_access_pri：本地访问优先master_access_pri：主用访问优先local_only：仅本地访问
Notify IP配置ADD NOTIFYIP|通知IP名称|amf38|amf37|参数用于设置本AMF对应的备份AMF的Notify IP地址的名称。每个SBI（Service BasedInterface，基于服务的接口）服务的接口地址可能会不一样，用该名称进行标识。
通知IP地址类型|Notify IP配置ADD NOTIFYIP|ipv4|ipv4|本参数用于设置本AMF对应的备份AMF的Notify IP地址类型，包括IPv4和IPv6两种类型。
通知IP地址|Notify IP配置ADD NOTIFYIP|192.38.80.100|192.37.80.100|本参数用于设置本AMF对应的备份AMF的Notify IP地址。Notify IP即其他NF向AMF发起反向Notify通知时，使用的AMF的NotifyIP地址。
##### 配置步骤 
AMF1配置
步骤|操作说明|操作
---|---|---
1|打开容灾开关，开启容灾功能。|SET DISASTERSWITCHPARA:SUPPORTDISASTER="YES",TAKETIMERAPPROACH="NO",TAKENOTIIPWITHUDSF="NO",TAKENOTIIPNOUDSF="YES"
2|配置容灾策略，设置AMF1的容灾策略为无UDSF部分备份方式。|SET DISASTERRECOVERYPOLICY:DISASTERPOLICY="WITHOUT_UDSF_PARTIAL"
3|配置部分备份容灾功能启用时，携带备份AMF开关配置为携带，即携带备份AMF给RAN。|SET CONTROLPOLICY:BACKUPSWITCH="CARRY"
4|GUAMI配置，增加AMF POOL内所有AMF的GUAMI，这些GUAMI具有相同的MCC、MNC、Region ID及Set ID，只有Pointer ID不相同。|ADD GUAMICFG:GUAMIID=1,MCC="460",MNC="11",REGIONID=37,SETID=37,POINTID=11ADD GUAMICFG:GUAMIID=2,MCC="460",MNC="11",REGIONID=37,SETID=37,POINTID=14
5|配置本局GUAMI，只关联本局的GUAMI ID。|ADD LOCALGUAMI:GUAMIID=1
6|配置AMF资源标识，增加本局的和备份局的AMF NRI。AMFNRI是十进制值，AMF POOL内NRI不能重复。|ADD AMFNRI:AMFNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",AMFNRI=1ADD AMFNRI:AMFNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",AMFNRI=2
7|本局配置，设置本局AMF name，此处的AMF name要与AMFNRI配置的AMF name相同。|SET AMFLOCALOFFICECFG:AMFNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
8|备份AMF配置，增加本AMF的备份AMF信息，将本AMF的GUAMI ID关联对应的备份AMF名称。该命令配置的AMFname是备份AMF的AMFname。|ADD BACKUPAMF:GUAMIID=1,AMFNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
9|接管AMF配置，增加本AMF对应的待接管AMF，即当接管AMF故障时，本AMF可以接管其数据。该命令配置的GUAMI和AMFname都是待接管AMF的GUAMI和AMFname。|ADD TAKEOVERAMF:BACKUPGUAMI=2,MASTERAMFNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
10|部分备份控制参数，设置备份AMF的GTPC地址，该AMF用来备份用户动态信息数据。该GTPC地址与N26口的GTPC地址共用。|SET CONTROLPARA:BACKAMFIP="38.16.16.16"
11|AMF POOL内其他AMF配置，增加其他AMF的Point标识和服务化IP地址等信息。当AMF的容灾策略配置为无UDSF部分备份方式时，接管局AMF使用该命令配置主用局AMF的信息，用于在注册流程中尝试向主用局获取上下文，从而能够继续处理用户业务。|ADD OTHERAMFCFG:POINTERID=14,IPADDRESS="192.38.80.100",PORT=8080,SCHEMA="HTTP",APIVERSION="V1"
12|租户配置，增加本局的CDB租户配置。该命令配置的AMF name是本局的AMF name。|SET CDBTENANT:TENANTID=1,TENANTNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",NFID1=37,NFID2=0,ACCESSPOLICY="default_access"
13|新增notifyIp配置，配置本AMF对应的备份AMF的Notify IP，即其他NF向AMF发起反向Notify通知时，所使用的AMF的HTTP服务端地址。|ADD NOTIFYIP:IPADDRNAME="amf38",IPADDRTYPE="IPV4",IPADDRESS="192.38.80.100"
AMF2配置
步骤|操作说明|操作
---|---|---
1|打开容灾开关，开启容灾功能。|SET DISASTERSWITCHPARA:SUPPORTDISASTER="YES",TAKETIMERAPPROACH="NO",TAKENOTIIPWITHUDSF="NO",TAKENOTIIPNOUDSF="YES"
2|配置容灾策略，设置AMF1的容灾策略为无UDSF部分备份方式。|SET DISASTERRECOVERYPOLICY:DISASTERPOLICY="WITHOUT_UDSF_PARTIAL"
3|配置部分备份容灾功能启用时，携带备份AMF开关配置为携带，即携带备份AMF给RAN。|SET CONTROLPOLICY:BACKUPSWITCH="CARRY"
4|GUAMI配置，增加AMF POOL内所有AMF的GUAMI，这些GUAMI具有相同的MCC、MNC、Region ID及Set ID，只有Pointer ID不相同。|ADD GUAMICFG:GUAMIID=1,MCC="460",MNC="11",REGIONID=37,SETID=37,POINTID=11ADD GUAMICFG:GUAMIID=2,MCC="460",MNC="11",REGIONID=37,SETID=37,POINTID=14
5|配置本局GUAMI，只关联本局的GUAMI ID。|ADD LOCALGUAMI:GUAMIID=2
6|配置AMF资源标识，增加本局的和备份局的AMF NRI。AMFNRI是十进制数字，AMFPOOL内NRI不能重复。|ADD AMFNRI:AMFNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",AMFNRI=1ADD AMFNRI:AMFNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",AMFNRI=2
7|本局配置，设置本局AMF name，此处的AMF name要与AMFNRI配置的AMF name相同。|SET AMFLOCALOFFICECFG:AMFNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
8|备份AMF配置，增加本AMF的备份AMF信息，将本AMF的GUAMI ID关联对应的备份AMF名称。该命令配置的AMFname是备份AMF的AMFname。|ADD BACKUPAMF:GUAMIID=2,AMFNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
9|接管AMF配置，增加本AMF对应的待接管AMF，即当接管AMF故障时，本AMF可以接管其数据。该命令配置的GUAMI和AMFname都是待接管AMF的GUAMI和AMFname。|ADD TAKEOVERAMF:BACKUPGUAMI=1,MASTERAMFNAME="amfc11.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org"
10|部分备份控制参数，设置备份AMF的GTPC地址，该AMF用来备份用户动态信息数据。该GTPC地址与N26口的GTPC地址共用。|SET CONTROLPARA:BACKAMFIP="37.16.16.16"
11|AMF POOL内其他AMF配置，增加其他AMF的Point标识和服务化IP地址等信息。当AMF的容灾策略配置为无UDSF部分备份方式时，接管局AMF使用该命令配置主用局AMF的信息，用于在注册流程中尝试向主用局获取上下文，从而能够继续处理用户业务。|ADD OTHERAMFCFG:POINTERID=11,IPADDRESS="192.37.80.100",PORT=8080,SCHEMA="HTTP",APIVERSION="V1"
12|租户配置，增加本局的CDB租户配置。该命令配置的AMF name是本局的AMF name。|SET CDBTENANT:TENANTID=1,TENANTNAME="amfc14.amfsi37.amfri37.amf.5gc.mnc011.mcc460.3gppnetwork.org",NFID1=38,NFID2=0,ACCESSPOLICY="default_access"
13|新增notifyIp配置，配置本AMF对应的备份AMF的Notify IP，即其他NF向AMF发起反向Notify通知时，所使用的AMF的HTTP服务端地址。|ADD NOTIFYIP:IPADDRNAME="amf37",IPADDRTYPE="IPV4",IPADDRESS="192.37.80.100"
周边网元配置
网元|配置说明|配置命令
---|---|---
SMF|设置SMF支持AMF备份。通过NRF发现备用AMF功能开关设置为打开的场景：如果现场AMF向NRF注册时未携带备用AMF信息，通过NRF发现备用AMF的方式应当配置为通过REGIONID与SETID发现备用AMF。如果现场AMF向NRF注册时携带备用AMF信息，通过NRF发现备用AMF的方式应当配置为通过GUAMI发现备用AMF。|SET BACKUPAMF:BACKUPAMFSWITCH="ENABLE",SELECTIONNUM=1,DISCBACKUPAMFSWITCH="ENABLE"
##### 指标监控 
性能统计
AMF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|初始注册流程测量|以C51001开头的所有计数器。
2|业务请求流程测量|以C51004开头的所有计数器。
3|PDU会话流程测量|以C51007开头的所有计数器。
4|N8接口测量|以C51052开头的所有计数器。
5|N11接口测量|以C51053开头的所有计数器。
6|N12接口测量|以C51054开头的所有计数器。
7|用户数测量|以C51350开头的所有计数器。
告警与通知
AMF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|3305242924 gNB断链退服告警
2|2114322577 DNS服务器TCP链路中断
3|2114322576 DNS服务器不可达
4|3305242626 NRF节点不可达告警
5|3506438145 HTTP静态链路断链
6|150101 接口IPv4协议态Down
7|150102 接口IPv6协议态Down
8|150111 接口二层协议态Down
9|3305242920 PCF不可达
10|3305242916 SMF不可达
11|3305242915 UDM不可达
12|3305242914 AUSF不可达
### SMF 
#### SMF容灾 
##### 容灾组网 
SMF采用组POOL方式进行容灾组网部署，POOL中的SMF负荷分担业务。 
考虑到异地容灾的要求，POOL内的SMF应该部署在不同地域的DC中，如下图所示。 
图1  容灾组网
[]images/SMF%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%91.png)
说明如下： 
SMF跨DC组POOL容灾，POOL中的SMF为负荷分担模式。 
某个SMF故障后，由AMF选择POOL中其它可用的SMF。 
##### 容灾原理 
SMF POOL容灾原理说明
SMF POOL容灾是指两个以上SMF设备进行POOL组网，POOL内的SMF设备正常运行时进行负荷分担。一旦有某个SMF设备发生故障时，其他设备可以承担故障设备上的用户业务，以保证网络的可靠性。 
POOL容灾方式的优点如下： 
资源消耗低：不需要专门部署备用设备，所有设备都参与负荷分担，降低对冗余资源的要求。 
带宽消耗低：POOL内的多个设备之间不需要进行数据同步，对带宽要求低。 
部署灵活：可以根据具体容灾要求决策在POOL内部署SMF设备的数量以满足一台或多台设备同时发生故障的容灾场景。 
POOL容灾方式的缺点如下： 
会话中断：当某个SMF设备故障时，用户迁移到POOL中的其他设备上时，会话会中断，用户需要下线再重新上线。 
SMF POOL容灾过程说明
SMF采用SBI接口，SMF的POOL容灾如下图所示。 
图2  SMF POOL容灾
[]images/SMF%20POOL%E5%AE%B9%E7%81%BE.png)
说明如下： 
故障检测：AMF通过向NRF订阅SMF状态通知获取SMF的状态，NRF通过心跳检测SMF的状态（需要SMF先向NRF注册）。 
会话释放：AMF将故障SMF设备对应的全部用户会话释放。 
设备重选：用户重新上线，AMF通过NRF发现可用的SMF，NRF会自动将故障SMF过滤掉，将可用的SMF发送给AMF。 
SMF故障对周边网元的影响
SMF故障不可用时，其影响的5GC中SMF周边网元如下图所示。 
图3  SMF故障对周边网元的影响
[]images/SMF%E6%95%85%E9%9A%9C%E5%AF%B9%E5%91%A8%E8%BE%B9%E7%BD%91%E5%85%83%E7%9A%84%E5%BD%B1%E5%93%8D.png)
网元|感知方式|影响
---|---|---
AMF|通过向NRF订阅SMF状态获知SMF不可用|AMF获知SMF不可用时：新用户接入时AMF不再选择该SMF，会重新选择其他可用SMF。与该SMF相关的已在线用户，AMF会进行批量会话释放。当用户发起业务时，AMF触发用户重新选择其他可用SMF建立会话。
UPF|通过PFCP Heartbeat感知SMF不可用|UPF通过心跳检测感知SMF不可用时，会批量释放与该SMF相关的所有用户资源。
PCF|通过向NRF订阅SMF状态获知SMF不可用|新用户上线重新选择SMF，对PCF没有影响。
UDM|通过向NRF订阅SMF状态获知SMF不可用|新用户上线重新选择SMF，对UDM没有影响。
CHF|通过向NRF订阅SMF状态获知SMF不可用|无影响。
NRF|通过心跳检测感知SMF不可用|SMF故障后，NRF要将SMF状态不可用的信息通知给订阅SMF状态的网元。
##### 部署要求 
SMF POOL容灾对于SMF设备部署的要求如下： 
一个POOL中需要部署两套或以上SMF设备。 
POOL中的SMF设备需要部署在不同地域DC中。 
部署时规划好容量与实际接入量的关系，确保容灾时接管设备可以承接故障设备的业务量。 
另外，根据现场规划，SMF POOL容灾有以下几种负荷分担方式。 
非均匀负荷分担方式：SMF向NRF注册的优先级配置中，两个SMF优先级配置相同，但是权重配置不同。业务接入时权重大的SMF设备被选择承接业务的概率更大，如7：3业务承接方式。当高权重SMF不可用时，所有业务由低权重SMF承接。这种方式如果POOL中有两个以上SMF，则在容灾时需要预先考虑可能出现另一个高权重SMF过负荷的情况，如下图所示。 
均匀负荷分担方式：SMF向NRF注册的优先级配置中，两个SMF优先级配置相同，且权重配置也相同，则POOL内的所有SMF均匀承担业务量。当某个SMF不可用时，它的业务会由POOL中其它SMF均衡分担。 
##### 容灾业务流程 
数据业务SA接入的SMF Pool容灾流程
用户发起数据PDU会话建立请求后，AMF通过用户的DNN、切片、SMF的优先级及权重等信息从满足要求的SMF列表中选择一个可用的SMF，为用户建立PDU会话。 
一旦AMF通过NRF的网元状态订阅通知消息，获知SMF故障，AMF应发起用户数据会话释放流程。 
图4  数据业务SA接入的SMF Pool容灾流程
[]images/%E6%95%B0%E6%8D%AE%E4%B8%9A%E5%8A%A1SA%E6%8E%A5%E5%85%A5%E7%9A%84SMF%20Pool%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
流程说明如下： 
用户UE1发起数据业务PDU会话建立请求。 
AMF1根据DNN和切片信息，负荷分担选择SMF1，为用户建立PDU会话。 
SMF1从UDM获取用户的会话签约信息，并完成接入鉴权、授权和连接注册流程。 
SMF1从PCF获取用户的PCC策略。 
SMF1根据用户PDU会话的DNN、切片和TA等参数，选择一个UPF，为用户建立PDU会话转发资源。 
SMF1应答AMF1，并通知AMF1用户的PDU会话信息。 
SMF1携带用户的会话参数，通知AMF1为用户的数据会话，建立空口资源。 
AMF1通知NR，为用户的PDU会话建立空口资源。NR通知用户UE1，对应数据PDU会话建立接受。 
UE1向NR回复PDU会话建立接受应答，NR向AMF1回复PDU会话建立接受应答。 
AMF1通知SMF1对应的用户下行隧道信息。 
SMF1通知UPF对应的用户下行隧道信息。 
此时，用户可以发送上下行的业务流到Internet。 
此后，AMF1检测到SMF故障（通过NRF订阅通知）。 
AMF1触发与该SMF相关的所有PDU会话释放流程。 
AMF1通知NR和UE1，释放PDU会话。 
UE释放数据PDU会话。 
此后，用户重新发起数据业务PDU会话建立后，AMF为用户重新选择可用的SMF，保证用户的PDU会话可以成功建立。当故障的SMF恢复后，AMF仍然可以为新接入用户选择该SMF。 
语音和短信业务SA接入的SMF Pool容灾流程
用户发起语音PDU会话建立请求后，AMF通过用户的DNN、切片、SMF的优先级及权重等信息从满足要求的SMF列表中选择一个可用的SMF，为用户建立PDU会话。 
一旦AMF通过NRF的网元状态订阅通知消息，获知SMF故障，AMF应发起用户数据会话释放流程。 
图5  语音和短信业务SA接入的SMF Pool容灾流程
[]images/%E8%AF%AD%E9%9F%B3%E5%92%8C%E7%9F%AD%E4%BF%A1%E4%B8%9A%E5%8A%A1SA%E6%8E%A5%E5%85%A5%E7%9A%84SMF%20Pool%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
具体流程与“[数据业务SA接入的SMF Pool容灾流程](23.html#T_1604980389609__5e0e7cd2-95f3-47bc-9b9e-7db6084ea81e)”基本一致，唯一不同的是，此时用户的业务流由UPF接入到P-CSCF，发起语音接入流程。
数据业务NSA接入的SMF Pool容灾流程
5G用户从NSA接入，请求建立数据PDN连接，MME根据用户的5G签约信息以及APN，为该PDN连接，负荷分担地选择融合的SAE GW-C/SMF。 
图6  数据业务NSA接入的SMF Pool容灾流程
[]images/%E6%95%B0%E6%8D%AE%E4%B8%9A%E5%8A%A1NSA%E6%8E%A5%E5%85%A5%E7%9A%84SMF%20Pool%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
流程说明如下： 
用户UE1发起附着请求。 
MME1根据5G签约信息和数据业务APN选择融合SAE GW-C/SMF1，并发送创建承载请求给SAE GW-C/SMF1。 
SAE GW-C/SMF1获取用户的PCC策略。 
SAE GW-C/SMF1根据APN选择UPF Pool，从中负荷分担选择一个UPF，为用户默认承载建立转发资源。 
SAE GW-C/SMF1响应MME1，默认承载建立成功。 
MME1通知无线侧和终端，默认承载建立成功，附着请求已接受。 
UE应答，无线侧默认承载已建立。 
MME1通知SAE GW-C/SMF1，更新承载信息。 
SAE GW-C/SMF1通知UPF建立下行数据隧道。 
此时，用户可以发送上下行的业务流到Internet。 
此后，MME通过GTP口的echo消息检测到SAE GW-C/SMF不可用。 
MME触发与该SAE GW-C/SMF1相关的所有用户的去附着流程。MME1通知eNodeB，要求进行用户释放。 
用户发起去附着释放，无线侧回复MME1。 
此后，用户重新发起数据PDN连接的建立后，MME为用户重新选择可用的融合SAE GW-C/SMF，SAE GW-C/SMF为用户成功建立PDN连接。当故障的SAE GW-C/SMF恢复后，MME仍然可以为新接入用户选择该SAE GW-C/SMF。 
语音和短信业务NSA接入的SMF Pool容灾流程
用户发起语音PDN连接建立请求后，MME根据用户5G签约信息，从DNS中负荷分担选择融合的SAE GW-C/SMF网元。 
图7  语音和短信业务NSA接入的SMF Pool容灾流程
[]images/%E8%AF%AD%E9%9F%B3%E5%92%8C%E7%9F%AD%E4%BF%A1%E4%B8%9A%E5%8A%A1NSA%E6%8E%A5%E5%85%A5%E7%9A%84SMF%20Pool%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
具体流程与“[数据业务NSA接入的SMF Pool容灾流程](23.html#T_1604980389609__93576bbf-182a-496f-9c80-408aa9f95a4d)”基本一致，唯一不同的是，此时用户的业务流由UPF接入到P-CSCF，发起语音接入流程。
#### SMF容灾配置 
##### 配置前提 
已完成数据、语音、短信、彩信等基础流程的配置。 
##### 数据规划 
数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
SMF1|SMF2
---|---
NRF地址配置ADD NRFNODEIP|NRF地址列表ID|1|2|1|2|NRF地址列表ID。
HTTP客户端模板ID|NRF地址配置ADD NRFNODEIP|1|1|1|1|HTTP客户端模板ID，该参数需要通过ADD CLIENTPROFILE命令预先配置。同时该模板的IP地址类型应该与本配置的NRFIP地址类型一致。
主备类型选择|NRF地址配置ADD NRFNODEIP|主用|备用|主用|备用|主备类型选择。主用表示配置的是主用NRF节点地址信息；备用表示配置的备用NRF节点地址信息。
NRF IP地址类型|NRF地址配置ADD NRFNODEIP|IPv6|IPv6|IPv6|IPv6|NRF的IP地址类型，取值为IPv4或IPv6。
NRF IPV6地址|NRF地址配置ADD NRFNODEIP|195:168:68:1::11|195:168:69:1::11|195:168:69:1::11|195:168:68:1::11|NRF的IPv6地址。若NRF IP地址类型的值为IPv6，则须在此填写符合IPv6格式的有效的NRF地址。
NRF IP地址优先级|NRF地址配置ADD NRFNODEIP|1|1|1|1|NRF的IP地址优先级，用于比较同一主备类型的NRF地址优先级。该参数的数值越低表示优先级越高。
NRF端口号|NRF地址配置ADD NRFNODEIP|8080|8080|8080|8080|NRF的端口号。
URI Scheme|NRF地址配置ADD NRFNODEIP|Http|Http|Http|Http|URI scheme，用于选择与NRF交互的消息协议类型（HTTP/HTTTPS）。
API版本|NRF地址配置ADD NRFNODEIP|v1|v1|v1|v1|API版本，用于选择与NRF交互的API版本（V1/V2）。
NRF模式配置SET NRFPATTERN|NRF 备用模式|互备双活模式|互备双活模式|互备双活模式|互备双活模式|NRF 备用模式，该参数可配置为主备模式与互备双活模式，默认值为主备模式。主备模式是指两套NRF，一个为主用NRF，一个为备用NRF，正常情况下使用主用NRF，主用NRF不可用时启用备用NRF。互备双活模式是指两套NRF均为可用状态，正常情况下使用主用NRF，主用NRF不可用时使用备用NRF。
NRF 切换模式|NRF模式配置SET NRFPATTERN|自动倒回|自动倒回|自动倒回|自动倒回|NRF 切换模式，该参数可配置为自动倒回与手动倒回，默认值为自动倒回。自动倒回指的是当主用NRF从不可用状态变为可用状态时，自动从备用NRF切换到主用NRF。手动倒回模式指的是当主用NRF从不可用状态变为可用状态时，不会自动切换到主用NRF，需要通过动态命令ACTIVENRF ENABLED手工切换到主用NRF。
NRF注册管理配置SET NRFREGMANAGE|权重|65535|1|65535|1|该参数表示SMF在NRF中的权重，范围为0-65535。
其他参数|NRF注册管理配置SET NRFREGMANAGE|默认值|默认值|默认值|默认值|无特殊需求，保持默认值。
Sx口心跳检测消息配置SET HEARTBEATMSG|是否主动发送心跳检测请求消息|是|是|是|是|该参数用于设置SMF是否主动发送心跳检测请求消息。取值为否(FALSE)或者是(TRUE)。
请求发送周期(s)|Sx口心跳检测消息配置SET HEARTBEATMSG|20|20|20|20|该参数用于设置请求发送周期，即每隔多长时间发送一次心跳请求。取值范围是11~3600，单位：秒。
最大连续无响应次数|Sx口心跳检测消息配置SET HEARTBEATMSG|5|5|5|5|该参数用于设置最大连续无响应次数，即连续多少次没收到心跳响应，则认为断链。取值范围是1~100。
##### 配置步骤 
SMF1配置
步骤|操作说明|操作
---|---|---
1|增加NRF地址配置。|ADD NRFNODEIP:NRFNODEID=1,HTTPCLIENTTMPID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="195:168:68:1::11",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"ADD NRFNODEIP:NRFNODEID=2,HTTPCLIENTTMPID=1,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="195:168:69:1::11",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"
2|设置NRF工作模式，工作模式的选择要与实际NRF的工作模式一致。|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
3|在NRF注册管理配置中设置SMF权重，根据现场规划配置。|SET NRFREGMANAGE:NRFCAPACITY=65535
4|Sx口心跳检测消息配置。|SET HEARTBEATMSG:SNDREQ="true",SNDPERIOD=20,MAXNORSPNUM=5
5|设置PCF动态模板中的负载模式为”非PCF绑定“。执行SHOW DNNPCCPROFILE命令，查看APN关联的PCC N7 CCFH模板名称，以及PCF动态模板名称。根据PCF动态模板名称，查看负载模式，应当配置“非PCF绑定”模式。|SET PCFDYNAMICPROFILE:PROFILENAME="default",BALANCEMODE="PCF_NOT_BINGDING"
SMF2配置
步骤|操作说明|操作
---|---|---
1|增加NRF地址配置。|ADD NRFNODEIP:NRFNODEID=1,HTTPCLIENTTMPID=1,TYPECHOICE="ACTIVE",IPTYPE="IPV6",IPV6ADDR="195:168:69:1::11",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"ADD NRFNODEIP:NRFNODEID=2,HTTPCLIENTTMPID=1,TYPECHOICE="BACKUP",IPTYPE="IPV6",IPV6ADDR="195:168:68:1::11",PRIORITY=1,PORT=8080,SCHEME="HTTP",APIVERSION="V1"
2|设置NRF工作模式，工作模式的选择要与实际NRF的工作模式一致。|SET NRFPATTERN:NRFSTANDBYPATTERN="DOUBLE_LIVE",NRFSWITCHPATTERN="AUTO_SWITCH"
3|NRF注册管理配置中设置SMF权重，根据现场规划配置。|SET NRFREGMANAGE:NRFCAPACITY=1
4|Sx口心跳检测消息配置。|SET HEARTBEATMSG:SNDREQ="true",SNDPERIOD=20,MAXNORSPNUM=5
5|设置PCF动态模板中的负载模式为“非PCF绑定”。执行SHOW DNNPCCPROFILE命令，查看APN关联的PCC N7 CCFH模板名称，以及PCF动态模板名称。根据PCF动态模板名称，查看负载模式，应当配置“非PCF绑定”模式。|SET PCFDYNAMICPROFILE:PROFILENAME="default",BALANCEMODE="PCF_NOT_BINGDING"
周边网元配置
网元|配置说明|配置命令
---|---|---
AMF|开启过负荷控制，具体的控制量需要根据实际情况来计算。|SET OVERLOADCFG:OLSWITCH="AMFOLSWITCHON"
配置AMF网元“向NRF的订阅策略”。|AMF|SET NFSUBSCRIBEPOLICY:NFSUBSCRIBEPOLICY="SUPPORTSUB",NFUPDATESUBPOLICY="SUPPORTUPTSUB"
设置HTTP重新选择配置：NF链路重选次数为0。IP重选次数为1。|AMF|ADD RESELECTION:NFTYPE="SMF",LINKRESELTIME=0,IPRESELTIME=1
修改201软参为1，用于配置业务请求中AMF因底层链路问题向SMF发送失败时删除会话信息。|AMF|SET COMMU SOFTWARE PARAMETER:ID=201,VALUE=1
修改202软参为1，用于配置业务请求中与SMF交互无响应时删除会话信息。|AMF|SET COMMU SOFTWARE PARAMETER:ID=202,VALUE=1
打开NRF检测开关。|AMF|SET NFDETECPROCCFG:NRFSWITCH="ON"
UPF|设置PFCP心跳检测参数。|SET HEARTBEAT:ENABLEHEARTBEAT="ENABLE",RESENDTIMES=5,SENDINTERVAL=30
##### 指标监控 
性能统计
SMF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|5G基于DNN的PDU会话测量|以C51521开头的所有计数器
2|4/5G互操作流程测量|以C51539开头的所有计数器
3|会话建立流程测量|以C51501开头的所有计数器
4|I-SMF会话建立流程测量|以C51533开头的所有计数器
5|会话数测量|以C51507开头的所有计数器
6|GSU性能测量|以C04909开头的所有计数器
告警与通知
SMF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|3506438145 HTTP静态链路断链
2|3322019843 NRF节点不可达告警
3|109201 UPF节点不可达
4|103007 和GTP控制面节点之间链路故障
5|150101 接口IPv4协议态Down
6|150102 接口IPv6协议态Down
7|150111 接口二层协议态Down
### UPF 
#### UPF容灾 
##### 容灾组网 
UPF系统容灾目前主要通过CU Full Mesh组POOL的方式：一组设备组成一个POOL，为一个区域或一组区域的用户提供服务。当POOL中某个设备宕机后，该设备上的用户会被全部下线，SMF/GW-C后续在  POOL中重新选择一个可用的UPF/GW-U设备上线。
如下图所示， 一个SMF/GW-C可以与多个UPF/GW-U对接，一个UPF/GW-U也可以和多个SMF/GW-C对接。 
图1  CU Full Mesh组网图
[]images/1580894448140.png)
说明如下: 
UPF/GW-U设备跨DC组POOL容灾，POOL中的UPF/GW-U设备可以为负荷分担模式。 
C面与U面为Full Mesh全互联，POOL中任何一个UPF/GW-U设备故障，SMF/GW-C重新选择UPF/GW-U建立连接。 
某个UPF/GW-U设备故障后，用户需要重新上线接入POOL中其他可用的UPF/GW-U设备。 
##### 容灾原理 
POOL容灾原理
POOL容灾是指两个以上UPF进行POOL组网，POOL内的UPF设备正常运行时进行负荷分担；一旦有某个设备发生故障时，其他设备可以承担故障设备上的用户业务，以保证网络的可靠性。 
POOL容灾包括故障设备检测、用户重新接入、设备重选这几个部分。 
POOL容灾方式的优缺点参见下表。 
优点|缺点
---|---
资源消耗低，不需要专门部署备用设备，所有设备都参与负荷分担，降低对冗余资源的要求。带宽消耗低，POOL内的多个设备之间不需要做数据同步，对带宽要求低。部署灵活，可以根据具体容灾要求决策在POOL内部署UPF设备的数量以满足一台或多台设备同时故障的容灾场景。|会话中断，当某个UPF设备故障，用户迁移到POOL中的其他设备上时，会话会中断，用户需要下线重新上线。
CU Full Mesh组网原理
N4/Sx偶联建立。 
在Full Mesh方式下，UPF/GW-U支持与需要互联的所有SMF/GW-C建立N4/Sx偶联。 
在SMF/GW-C发起偶联建立的流程中，UPF/GW-U支持接收多个SMF/GW-C发来的偶联建立、更新、删除请求，完成相关的偶联流程，并记录与各SMF/GW-C的偶联状态。 
在UPF/GW-U发起偶联建立的流程中，UPF/GW-U支持主动向多个SMF/GW-C发送偶联建立、更新、删除请求，并记录与各SMF/GW-C的偶联状态。 
UPF/GW-U与各SMF/GW-C偶联建立成功后，UPF/GW-U需要维护多条N4/Sx链路，针对每条链路维护对应的状态，并根据维护的链路信息在每条链路上周期性发送Heart
beat消息，以检测到对端SMF/GW-C是否正常。同样SMF/GW-C也通过Heart beat消息检测UPF/GW-U是否正常。 
UPF/GW-U支持TEID的分配。在Full
Mesh组网下，在多个SMF/GW-C上激活的用户，可能会选择同一个UPF/GW-U，为避免同一个UPF/GW-U的TEID重叠，因此需要由UPF/GW-U来分配TEID。UPF/GW-U通过偶联流程，把UPF/GW-U分配TEID的能力发送给SMF/GW-C，这样SMF/GW-C在业务接入流程中，就会使用UPF/GW-U分配的TEID以完成流程。 
##### 部署要求 
一个Full Mesh组网内最大支持64个SMF和128个UPF。 
Full Mesh组网下仅支持UPF分配用户面的全量隧道端点标识。 
Full Mesh组网下主推UPF分配UE IP地址，系统部署时需要提前规划UPF的UE IP地址池。 
不支持不同厂家的SMF和UPF对接。 
在容灾部署时，需要先根据应用场景和实际网络与设备情况做好规划。对于POOL容灾方式，需要考虑好POOL中参与业务负荷分担的设备数量。当设备数量较多时，每个设备的资源使用率较低，可以同时承接多个设备故障倒换；当设备数量较少时，每个设备的资源使用率较高，可能一个设备故障，也只能承接部分用户业务。 
##### 容灾业务流程 
容灾业务流程如下图所示。 
图2  容灾流程图
[]images/UPF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B%E5%9B%BE.png)
流程说明如下： 
POOL中SMF/GW-C通过N4/Sx接口的心跳消息检测到某个UPF/GW-U故障，例如UPF/GW-U2出现了故障。 
SMF/GW-C收不到UPF/GW-U2返回的心跳应答消息，等待超时后可以确认UPF/GW-U2出现了问题，此时SMF会删除与故障UPF/GW-U2相关的全部会话，并删除对应的用户资源，用户下线。 
当用户重新激活时，SMF/GW-C根据POOL中各UPF/GW-U的负荷情况等因素，重新选择正常运行的UPF/GW-U。 
SMF/GW-C发送PFCP Session Establishment Request消息给正常运行的UPF/GW-U建立会话，此时用户可以正常继续开展业务。 
#### UPF容灾配置 


##### 配置前提 

 
POOL内的所有UPF都分别跟主备SMF建立了N4口连接。 

 
UPF上的地址池、地址段及与DNN关联关系的配置，跟对应SMF上的地址池相关配置一致。 

 


##### 数据规划 
不涉及数据规划。 


##### 配置步骤 
UPF配置
不涉及UPF的配置。 
周边网元配置
网元|配置说明|配置命令
---|---|---
SMF|Sx口心跳检测消息配置|SET HEARTBEATMSG:SNDREQ="true",SNDPERIOD=20,MAXNORSPNUM=5


##### 指标监控 
性能统计
UPF容灾需要监控的性能统计数据参见下表。 
编号|测量类型|性能计数器
---|---|---
1|N4-C接口测量|以C55021开头的所有计数器
2|PFU性能测量|以C08711开头的所有计数器
3|PGW流量测量|以C04931开头的所有计数器
4|SGW系统流量测量|以C05124开头的所有计数器
5|虚拟机基本测量|以C55700开头的所有计数器
告警与通知
不涉及告警与通知的监控。 


### CHF 
#### CG容灾 


##### 容灾组网 
CG采用1+1互备方式进行容灾组网部署，即两套CG分别部署在两个DC，对外呈现两套IP地址，两套独立的CG互为主备并且同时运行业务。两个DC的SMF可以同时访问这两套CG，每个SMF都需要配置到两套CG的链路（一个作为主链路，另一个作为备链路）。BOSS需要同时获取这两套CG的话单文件，容灾组网示意如[图1](25.html#T_1604980389619__e0a63989-496f-4884-896a-e0e4ad80c667)所示。
图1  容灾组网


[]images/%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%91.png)

其中SMF(A1)、SMF(A2)选择CG(A)作为主用，选择CG(B)作为备用；SMF(B1)、SMF(B2)选择CG(B)作为主用，选择CG(A)作为备用。BOSS需要同时采集CG(A)和CG(B)的话单文件。 


##### 容灾原理 
若主用CG异常，SMF可能短时间内收不到CG的计费响应消息（或者和CG的HTTP PING探测失败），未响应计费消息会在SMF本地临时缓存，后续通过回放的方式发送给备用CG，后续所有新的计费消息也会发送给备用CG。
如果主备CG都不可用，SMF会对当前异常计费消息打上Failure标记，并进行持久化存储。当CG恢复可用时，SMF通过回放的方式发送给可用的CG。若该回放话单中的MUU（Multiple
Unit Usage）字段有效（即产生了流量），CG会将该话单的ratingIndicator设置为1，Billing需要对ratingIndicator=1的话单进行排重处理。


##### CG故障对周边网元的影响 
对SMF的影响

 
SMF收不到计费响应消息，未响应计费消息会在SMF本地临时缓存，后续通过回放的方式发送给备用CG。 

 
SMF和CG的HTTP PING探测失败，后续所有新的计费消息会发送给备用CG。 

 
对BOSS的影响

 
BOSS已经接收计费消息，却无法向CG发送响应消息。 

 
当前已经存在的计费会话，无法通过原主用CG发送Notify消息。 

 
对计费NRF的影响
CG故障后不会向计费NRF发送去订阅消息，计费NRF感知到和CG的链路中断也不会向CG发送通知消息。


##### 部署要求 
要求在主备DC中分别部署相同数量、相同规格的CG。 


##### 容灾业务流程 
其中一套CG故障，其他可用CG承接所有计费负荷。SMF检测到该CG无应答消息后，SMF将用户计费消息发送给其他可用CG，容灾业务流程如[图2](25.html#T_1604980389619__8815b452-9e16-43ef-960f-1ae77fd7a9a2)所示。
SMF可以连接多套CG，按照权重方式，将不同用户计费消息转发到各自对应的CG。 
图2  容灾业务流程


[]images/%E5%AE%B9%E7%81%BE%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.png)

流程说明如下： 


用户建立PDU会话，使用数据业务。SMF为用户的具体数据业务，根据RG粒度进行计费。


特定信令或者计费事件发生，触发SMF发送计费消息给CG。 


SMF等待计费消息的应答，如果在配置的超时时间内，没有收到CG的应答消息，SMF重发计费消息，如果超过指定次数，SMF认为CG故障。 


SMF选择其他可用CG，发送用户的计费消息。 


当SMF检测到所有CG都故障后，SMF缓存计费消息。当CG恢复后，SMF发送缓存的计费消息，以及用户当前的计费消息到CG，缓存计费消息设置故障指示字段，用于CG区分正常和异常计费消息。 


#### CHF容灾配置 
##### 配置前提 
CHF已完成和周边网元的对接，且能正常出话单。 
SMF上已完成计费相关的基本配置。融合会话离线计费模板标识融合在线计费模板标识在线计费上报策略模板标识在线异常模板标识在线计费处理策略模板标识CCFH模板名称 
##### 数据规划 
CHF数据规划示意图如[图1](1606294047410.html#zbb0281d876ca47fd9f2c695c67996e46__3630c985-fd29-4981-aa69-cab4e8510d7b)所示。
图1  CHF数据规划示意图
[]images/CHF%E6%95%B0%E6%8D%AE%E8%A7%84%E5%88%92%E7%A4%BA%E6%84%8F%E5%9B%BE.png)
对接SMF配置配置命令参数名称参数取值CHF1参数取值CHF2说明本端配置ADD NCHFLOCAL编号1212Nchf本端配置编号，唯一，范围1-36。主用地址191:1:1::9:7195:168:171::10195:168:172::10195:168:173::10主CHF IP。主用端口5586558655865586主CHF侦听端口，取值范围：5586-5595，开通可采用缺省值。对端配置ADD NCHFPEER编号1212Nchf对端配置节点编号，范围：1-1024。对端地址195:168:41::11195:168:42::11195:168:41::11195:168:42::11SMF端IP地址。开启Http2发送PING包EnableEnableEnableEnable开启Http2发送PING包，默认启用。开关启用时，CHF将主动以PING间隔向SMF发送PING包，用于检测链路状态。PING间隔（秒）3333ping包发送时间间隔，单位s。名称smf01smf02smf01smf02名称。通知消息本端配置ADD
NCHFNOTIFY编号1212通知消息本端配置编号，唯一，范围：1-12。本端地址191:1:1::9:7195:168:171::10195:168:172::10195:168:173::10CHF输入机信令（eth1）面浮动地址，CHF使用此IP地址将通知消息转发给SMF，与本端配置中的地址一致。本端起始端口5596559655965596本端起始端口，开通采用缺省配置。本端结束端口5615561556155615本端终止端口，开通采用缺省配置。 
对接NRF配置配置命令参数名称参数取值CHF1参数取值CHF2说明创建本端配置ADD
NRFLOCAL编号1212记录编号，唯一，范围1-12。本端地址191:1:1::19:7195:168:181::10195:168:182::10195:168:183::10CHF的OCS网络平面eth13浮动地址。本端起始端口5626562655865586CHF与OCS对接建立连接可以使用的端口范围的起始端口，默认5626，开通采用默认值。本端终止端口5645564556455645CHF与OCS对接建立连接可以使用的端口范围的终止端口，默认5645，开通采用默认值。创建对端配置ADD
NCHFPEER编号1212记录编号，唯一，范围1-5。对端地址195:168:68::11195:168:135::11195:168:68::11195:168:135::11NRF的IP地址，开通时与NRF协商确定。对端端口8080808080808080NRF的端口号，开通时与NRF协商确定。优先级1212优先级，范围0 - 4。优先级数值越小，优先级越高。CHF通过NRF的优先级区分主备NRF。别名NRF68NRF135NRF68NRF135名称。对此条数据记录起的名称。订阅消息本端配置ADD
NRFSUB编号1212通知消息本端配置编号，唯一，范围：1-12。本端地址191:1:1::19:7195:168:181::10195:168:182::10195:168:183::10CHF的OCS网络平面eth13浮动地址。本端端口5616561656165616CHF接收NRF通知消息的地址端口号，默认端口号：5616。开启Http2发送PING包EnableEnableEnableEnable开启Http2发送PING包，默认启用。开关启用时，CHF将主动以PING间隔向NRF发送PING包，用于检测链路状态。PING间隔（秒）3333ping包发送时间间隔，单位s。计费消息路由状态订阅策略配置SET OCSSUBOCS状态订阅策略NF Type订阅策略：No Subscription：不订阅（默认）。Instance ID：OCS实例ID。NF Type：网元类型。Service Name：服务名称。订阅OCS通知事件"NF_DEREGISTERED"&"NF_PROFILE_CHANGED"&"NF_REGISTERED"订阅事件：NF_DEREGISTERED：注册。NF_PROFILE_CHANGED：更新。NF_DEREGISTERED：去注册。当OCS发生注册/更新/去注册时，NRF将会向CHF发送通知消息（携带OCS相关信息）。 
##### 配置步骤 
CHF1配置-对接SMF
步骤|操作说明|操作
---|---|---
1|CHF本端配置：CHF为4虚机（2输入机），与SMF对接的CHF地址为191:1:1::9:7/195:168:171::10（两个输入机eth1浮动地址）输入机个数与配置记录个数应相同|ADD NCHFLOCAL:ID=1,PRIMARYIP=191:1:1::9:7,PRIMARYPORT=5586ADD NCHFLOCAL:ID=2,PRIMARYIP=195:168:172::10,PRIMARYPORT=5586
2|对端配置|ADD NCHFPEER:ID=1,IP="195:168:41::11",PING="Enable",PINGINTVL=3,NAME="smf01"
3|通知消息本端配置|ADD NCHFNOTIFY:ID=1,IP=191:1:1::9:7,STARTPORT=5596,ENDPORT=5615ADD NCHFNOTIFY:ID=2,IP=195:168:172::10,STARTPORT=5596,ENDPORT=5615
CHF1配置-对接NRF
步骤|操作说明|操作
---|---|---
1|CHF本端配置：CHF为4虚机（2输入机），与NRF对接的CHF地址为191:1:1::19:7/195:168:181::10输入机个数与配置记录个数应相同|ADD NRFLOCAL:ID=1,IP=191:1:1::19:7,STARTPORT=5626,ENDPORT=5645,NAME="CHF输入机1"ADD NRFLOCAL:ID=2,IP=195:168:181::10,STARTPORT=5626,ENDPORT=5645,NAME="CHF输入机2"
2|对端配置|（主）ADD NRFPEER:ID=1,IP="195:168:68::11",PORT=8080,PRIORITY=1（备）ADD NRFPEER:ID=2,IP="195:168:135::11",PORT=8080,PRIORITY=2
3|订阅消息本端配置|ADD NRFSUB:ID=1,IP="191:1:1::19:7",PORT=5616,PING="Enable",PINGINTVL=3,NAME="NRF01"ADD NRFSUB:ID=2,IP="195:168:181::10",PORT=5616,PING="Enable",PINGINTVL=3,NAME="NRF02"
4|计费消息路由状态订阅策略配置|SET OCSSUB:SUBPOLICY="NF Type",SUBEVENTS="NF_DEREGISTERED"&"NF_PROFILE_CHANGED"&"NF_REGISTERED"
CHF2配置-对接SMF
步骤|操作说明|操作
---|---|---
1|CHF本端配置：CHF为4虚机（2输入机），与SMF对接的CHF地址为195:168:171::10/195:168:173::10（两个输入机eth1浮动地址）输入机个数与配置记录个数应相同|ADD NCHFLOCAL:ID=1,PRIMARYIP=195:168:171::10,PRIMARYPORT=5586ADD NCHFLOCAL:ID=2,PRIMARYIP=195:168:173::10,PRIMARYPORT=5586
2|对端配置|ADD NCHFPEER:ID=1,IP="195:168:41::11",PING="Enable",PINGINTVL=3,NAME="smf01"
3|通知消息本端配置|ADD NCHFNOTIFY:ID=1,IP=195:168:171::10,STARTPORT=5596,ENDPORT=5615ADD NCHFNOTIFY:ID=2,IP=195:168:173::10,STARTPORT=5596,ENDPORT=5615
CHF2配置-对接NRF
步骤|操作说明|操作
---|---|---
1|CHF本端配置：CHF为4虚机（2输入机），与NRF对接的CHF地址为195:168:182::10/195:168:183::10输入机个数与配置记录个数应相同|ADD NRFLOCAL:ID=1,IP=195:168:182::10,STARTPORT=5626,ENDPORT=5645,NAME="CHF输入机1"ADD NRFLOCAL:ID=2,IP=195:168:183::10,STARTPORT=5626,ENDPORT=5645,NAME="CHF输入机2"
2|对端配置|（主）ADD NRFPEER:ID=1,IP="195:168:135::11",PORT=8080,PRIORITY=1（备）ADD NRFPEER:ID=2,IP="195:168:68::11",PORT=8080,PRIORITY=2
3|订阅消息本端配置|ADD NRFSUB:ID=1,IP="195:168:182::10",PORT=5616,PING="Enable",PINGINTVL=3,NAME="NRF01"ADD NRFSUB:ID=2,IP="195:168:183::10",PORT=5616,PING="Enable",PINGINTVL=3,NAME="NRF02"
4|计费消息路由状态订阅策略配置|SET OCSSUB:SUBPOLICY="NF Type",SUBEVENTS="NF_DEREGISTERED"&"NF_PROFILE_CHANGED"&"NF_REGISTERED"
周边网元配置
网元|配置说明|配置命令
---|---|---
SMF1|配置到CHF的TCP静态链路，其中：LOCALIP：本端地址，与HttpLb客户端模板中的地址一致LOCALPORT：本端端口，不能使用HttpLb客户端模板中端口范围内端口（10000-60000），否则会冲突|ADD CLIENTTCPLINK:LINKID=1,PROFILEID=,LOCALIP="195:168:41::11",LOCALPORT=9041,REMOTEIP="191:1:1::9:7",REMOTEPORT=5586,VPNID=0,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9042,REMOTEIP="195:168:171::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9043,REMOTEIP="195:168:172::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9044,REMOTEIP="195:168:173::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50
查询静态链路状态，TCP链路状态和HTTP链路状态都应该是“已激活”状态|SMF1|SHOW LINK INFO:LINKTYPE="STATICLINK"
N40全局配置，设置不通过NRF发现CHF；SMF生成ChargingDataRef并带给CHF|SMF1|ADD N40GLOBALCONFIG:HTTPPROFILEIDIPV6=1,FINDCHFBYNRF="DISABLE",TXTIMER=10,CDREFGENERATEDNF="SMF",N40ENCODETMPLNAME="default"
CHF Node配置|SMF1|ADD CHFNODECONFIG:CHFNODENAME="chfnodem01",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="191:1:1::9:7",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodes01",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:171::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodem02",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:172::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodes02",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:173::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10
CHF Profile配置|SMF1|ADD CHFPROFILECONFIG:CHFPROFILENAME="chfproifle01",FAILOVER="ENABLE",FAILBACK="DISABLE",N40ENCODETMPLNAME="default",CHFREROUTETEMPNAME="default"ADD CHFPROFILECONFIG:CHFPROFILENAME="chfproifle02",FAILOVER="ENABLE",FAILBACK="DISABLE",N40ENCODETMPLNAME="default",CHFREROUTETEMPNAME="default"
配置CHF Node和CHF Profile的映射关系|SMF1|ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle01",CHFNODENAME="chfnodem01",CHFNODEROLE="PRIMARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle01",CHFNODENAME="chfnodes01",CHFNODEROLE="SECONDARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle02",CHFNODENAME="chfnodem02",CHFNODEROLE="PRIMARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle02",CHFNODENAME="chfnodes02",CHFNODEROLE="SECONDARY"
配置CHF Profile Group和CHF Profile的映射关系|SMF1|ADD CHFPROFILEGROUPMAP:CHFPROFILEGROUPNAME="chfproiflegroup01",CHFPROFILENAME="chfproifle01",WEIGHT=100ADD CHFPROFILEGROUPMAP:CHFPROFILEGROUPNAME="chfproiflegroup01",CHFPROFILENAME="chfproifle02",WEIGHT=10
配置DNN和CHF Profile Group的映射关系|SMF1|ADD CONVERGETEMP:CONVERGETEMPNAME="cmnet",TRIGGERCAPNAME="default",CHFPROFILETYPE="PROFILEGROUP",CHFPROFILEGROUPNAME="chfproiflegroup01",CONVERGETARIFFNAME="cmnet",CONVERGEOFFTEMPNAME="cmnet",CONVERGEONTEMPNAME="cmnet",CCRREPORTPOLICYNAME="cmnet",ONLINEABNORMALNAME="cmnet",CCAPOLICYNAME="cmnet",CCFHNAME="ccfh_cmnet",APPRESULTCODENAME="app_resultcode_temp",MUIRESULTCODENAME="mui_resultcode_temp",CHANGECONDITIONNUM=1,DISCOVERYCHFBYSUPI="DISABLE",DISCOVERYCHFBYGPSI="DISABLE",DISCOVERYCHFBYPLMN="DISABLE"
SMF2|配置到CHF的TCP静态链路，其中：LOCALIP：本端地址，与HttpLb客户端模板中的地址一致LOCALPORT：本端端口，不能使用HttpLb客户端模板中端口范围内端口（10000-60000），否则会冲突|ADD CLIENTTCPLINK:LINKID=1,PROFILEID=,LOCALIP="195:168:41::11",LOCALPORT=9041,REMOTEIP="191:1:1::9:7",REMOTEPORT=5586,VPNID=0,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9042,REMOTEIP="195:168:171::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9043,REMOTEIP="195:168:172::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="195:168:41::11",LOCALPORT=9044,REMOTEIP="195:168:173::10",REMOTEPORT=5586,MAXSTREAMID=4294967295,RESPBODYMAXLENGTH=2097152,RESPTIMER=30,CONNREADTIMER=32,MAXCONCURRENTSTREAMS=1000,KEEPALIVECNT=3,KEEPALIVETIMER=30,KEEPALIVESWITCH="SWITCH_ON",HTTPVERSION="HTTP_2",PRIORITY=0,WEIGHT=50
查询静态链路状态，TCP链路状态和HTTP链路状态都应该是“已激活”状态|SMF2|SHOW LINK INFO:LINKTYPE="STATICLINK"
N40全局配置，设置不通过NRF发现CHF；SMF生成ChargingDataRef并带给CHF|SMF2|ADD N40GLOBALCONFIG:HTTPPROFILEIDIPV6=1,FINDCHFBYNRF="DISABLE",TXTIMER=10,CDREFGENERATEDNF="SMF",N40ENCODETMPLNAME="default"
CHF Node配置|SMF2|ADD CHFNODECONFIG:CHFNODENAME="chfnodem01",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:171::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodes01",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="191:1:1::9:7",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodem02",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:173::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10ADD CHFNODECONFIG:CHFNODENAME="chfnodes02",CHFADDRESSTYPE="IPV6",CHFIPADDRESS="195:168:172::10",CHFPORT=5586,SCHEMA="HTTP",HTTPPROFILEID=1,SPROFILEID4CHF=1,TXTIMER=10
CHF Profile配置|SMF2|ADD CHFPROFILECONFIG:CHFPROFILENAME="chfproifle01",FAILOVER="ENABLE",FAILBACK="DISABLE",N40ENCODETMPLNAME="default",CHFREROUTETEMPNAME="default"ADD CHFPROFILECONFIG:CHFPROFILENAME="chfproifle02",FAILOVER="ENABLE",FAILBACK="DISABLE",N40ENCODETMPLNAME="default",CHFREROUTETEMPNAME="default"
配置CHF Node和CHF Profile的映射关系|SMF2|ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle01",CHFNODENAME="chfnodem01",CHFNODEROLE="PRIMARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle01",CHFNODENAME="chfnodes01",CHFNODEROLE="SECONDARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle02",CHFNODENAME="chfnodem02",CHFNODEROLE="PRIMARY"ADD CHFNODEPROFILEMAP:CHFPROFILENAME="chfproifle02",CHFNODENAME="chfnodes02",CHFNODEROLE="SECONDARY"
配置CHF Profile Group和CHF Profile的映射关系|SMF2|ADD CHFPROFILEGROUPMAP:CHFPROFILEGROUPNAME="chfproiflegroup01",CHFPROFILENAME="chfproifle01",WEIGHT=100ADD CHFPROFILEGROUPMAP:CHFPROFILEGROUPNAME="chfproiflegroup01",CHFPROFILENAME="chfproifle02",WEIGHT=10
配置DNN和CHF Profile Group的映射关系|SMF2|ADD CONVERGETEMP:CONVERGETEMPNAME="cmnet",TRIGGERCAPNAME="default",CHFPROFILETYPE="PROFILEGROUP",CHFPROFILEGROUPNAME="chfproiflegroup01",CONVERGETARIFFNAME="cmnet",CONVERGEOFFTEMPNAME="cmnet",CONVERGEONTEMPNAME="cmnet",CCRREPORTPOLICYNAME="cmnet",ONLINEABNORMALNAME="cmnet",CCAPOLICYNAME="cmnet",CCFHNAME="ccfh_cmnet",APPRESULTCODENAME="app_resultcode_temp",MUIRESULTCODENAME="mui_resultcode_temp",CHANGECONDITIONNUM=1,DISCOVERYCHFBYSUPI="DISABLE",DISCOVERYCHFBYGPSI="DISABLE",DISCOVERYCHFBYPLMN="DISABLE“
##### 指标监控 
性能监控
CHF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|分布式CG负荷测量|以C40929开头的所有性能计数器
2|Nchf接口统计|以C40932开头的所有性能计数器
3|计费信息路由链路接口统计|以C40933开头的所有性能计数器
4|CHF计费话单统计|以C40935开头的所有性能计数器
5|计费信息路由链路地址查询统计|以C40937开头的所有性能计数器
告警与通知
CHF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|2365981697 网元与网管服务端链路断
2|2265317446 节点容灾告警
### PCF 
#### PCF容灾 
##### 容灾组网 
5G网络中的RCP融合了PCF和PCRF功能，通常采用Pool组网，Pool内多个RCP间采用冷备或热备模式。组网图如[图1](26.html#T_1604980389619__e6be1f50-561b-46a9-a623-144a688e290f)所示。
冷备模式下RCP间不同步用户会话上下文，热备模式下RCP间需要同步用户会话上下文。 
图1  PCF容灾组网图
[]images/PCF%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%911.png)
仅两个RCP时也可以主备或互备组网，主备或互备组网可以视为Pool组网的特殊形式。 
在对数据业务做策略控制时，一个RCP Pool一般配置一对主备SPR，SPR存放用户签约及PCF/PCRF需要持久化的用户数据（如累计用量等）。 
仅对VoLTE/VoNR业务做策略控制时，RCP Pool可以不配置SPR。     
##### 容灾原理（冷备模式） 
PCF冷备模式如[图2](26.html#T_1604980389619__f4306c5f-9607-4e56-9d65-aca18ac5d40e)所示，冷备模式下，RCP间不同步用户会话上下文。每个RCP的用户上下文只保存在自己的CDU模块中。
一个RCP故障后，该RCP上的用户会话上下文丢失，相关会话的后续请求如果发到其他RCP，其他RCP会因为找不到对应的会话而回复失败，但用户的新会话可以在其他RCP上正常处理。 
 说明： 
其他RCP回复失败： 
Diameter接口（如Gx/Rx）回复DIAMETER_UNKNOWN_SESSION_ID。 
HTTP接口（如N7/N15/N5）回复404 Not Found。 
图2  PCF冷备模式
[]images/PCF%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%912.png)
SMF/PGW和PCF交互失败时，可以配置失败处理流程。目前默认是Create流程失败，SMF/PGW会使用本地策略维持会话30分钟，再释放会话并指示UE重建会话。如果是Update流程失败，则立即释放会话并指示UE重建会话。
##### 容灾原理（热备模式） 
PCF热备模式如[图3](26.html#T_1604980389619__8808c010-03f8-4bca-900d-98cc1ce6bc22)所示，热备模式下，RCP间同步用户会话上下文。每个用户上下文会保存在两个RCP的CDU中，当Pool内有多个RCP时，只需要选择两个RCP内置CDU及GSU(GW)。GSU(GW)用于CDU的跨局访问，其他RCP不需要配置CDU和GSU(GW)。
当一个RCP故障后，其所承载的用户会话按一定的用户分片算法均匀分担到Pool内其他RCP。 
例如Pool内有三个RCP，RCP1故障后，其上用户A和用户B的会话分别由RCP2和RCP3接管。但周边网元不知道用户在RCP间如何重分布，假如SMF把用户A当前会话的后续请求发送到RCP3，RCP3会判断用户A应当在RCP2处理，将请求通过Proxy方式转发给RCP3，或通过Redirect方式通知SMF将请求重发给RCP2。 
图3  PCF热备模式
[]images/1614582716090.png)故障RCP的某用户会话被其他正常RCP接管后，即便该用户会话没有收到外部请求，接管该RCP的正常RCP也可能主动处理该用户会话。 
例如向SPR更新该用户所在PCF局向，向BSF重新注册该用户会话绑定信息关联的PCF信息，向CHF更新NotificationURL，以及扫描该用户会话是否需要时段相关的策略，在时段条件满足时触发相关业务流程。
##### 部署要求 
热备模式下，一个Pool内最多7个RCP，其中两个RCP内置CDU和GSU(GW)，这两个RCP要分布在不同DC，且只允许宕机一个，其他不含内置CDU和GSU(GW)的RCP可以宕机多个。
##### 容灾业务流程（冷备模式） 
RCP故障时，触发的冷备容灾切换流程如[图4](26.html#T_1604980389619__f0a50b02-409a-4c14-8272-78662b40c913)所示。
图4  PCF冷备容灾切换流程图
[]images/PCF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B1.png)流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
SMF检测到链路堵塞、中断或者通过NRF得到RCP状态不可用通知。
SMF/AMF切换局向到容灾RCP。
SMF向RCP发送Npcf_SMPolicyControl_Update请求。 
备用RCP无此会话的数据，会回复失败的Npcf_SMPolicyControl_Update响应给SMF，携带ProblemDetails中的cause为RESOURCE_URI_STRUCTURE_NOT_FOUND。 
SMF向RCP发送Npcf_SMPolicyControl_Delete请求。 
备用RCP无此会话的数据，会回复失败的Npcf_SMPolicyControl_Delete响应给SMF，携带ProblemDetails中的cause为RESOURCE_URI_STRUCTURE_NOT_FOUND。 
用户重新发起会话建立请求，SMF向RCP发送新的Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
##### 容灾业务流程（热备模式） 
热备容灾状态切换（外部消息触发）
外部消息触发的热备容灾状态切换流程如[图5](26.html#T_1604980389619__4786b925-796b-46fe-a28b-11081154c0fd)所示。
图5  PCF热备容灾状态切换（外部消息触发）
[]images/PCF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B2.png)流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
本RCP向容灾RCP同步备份该用户的稳态数据。 
容灾RCP完成数据备份，并返回响应。 
SMF检测到链路堵塞、中断或者通过NRF得到RCP状态不可用通知。 
SMF/AMF切换局向到容灾RCP。 
SMF向RCP发送Npcf_SMPolicyControl_Update请求。 
RCP检测到主用RCP故障，接管用户。触发向SPR重新订阅。 
RCP判断是否向BSF进行了注册，如果已经注册过，需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
RCP发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Update响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
主用RCP恢复，容灾RCP检测到主用RCP恢复，开始向主用RCP同步备份该用户的稳态数据。 
主用RCP完成数据备份，并返回响应。 
热备容灾状态切换（RCP主动接管用户）
RCP主动接管用户的热备容灾状态切换流程如[图6](26.html#T_1604980389619__df6b76e0-eee2-473b-99ad-d741d8671515)所示。
图6  PCF热备容灾状态切换（RCP主动接管用户）
[]images/PCF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B3.png)流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
本RCP向容灾RCP同步备份该用户的稳态数据。 
容灾RCP完成数据备份，并返回响应。 
主用RCP故障，容灾RCP检测到主用RCP故障，开始主动接管用户。接管每个用户的时候都会进行下面的流程。 
RCP判断以前向SPR订阅过变更通知，则会触发向SPR重新订阅。 
RCP判断是否向BSF进行了注册，如果已经注册过，需要发送Nbsf_Management_Deregister请求消息到BSF。 
BSF返回Nbsf_Management_Deregister响应。 
RCP发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
热备容灾状态切换（REDIRECT方式）
REDIRECT方式的热备容灾状态切换流程如[图7](26.html#T_1604980389619__108c04eb-f3f0-407c-aeef-472eaa7a1ea9)所示。
图7  PCF热备容灾状态切换（REDIRECT方式）
[]images/PCF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B4.png)流程说明如下： 
在PDU会话建立流程中，如果SMF确定需要向RCP请求PDU会话策略控制，SMF需要先为该PDU会话向RCP请求建立SM策略关联。为此SMF向RCP发送Npcf_SMPolicyControl_Create请求，请求中包含SUPI、PDU会话标识、DNN、S-NSSAI、订阅通知指示（即SMF后续接收PCF为该SM策略关联下发的策略更新通知的URI地址），可选包含UE的IPv4地址和（或）IPv6地址前缀、GPSI、PEI、签约的会话聚合带宽（Subscribed Session AMBR）和签约的缺省QoS（Subscribed Default QoS）等信息。 
如果RCP确定对该PDU会话策略控制需要用到该用户的策略签约信息，并且RCP本地没有该用户的策略签约信息，则RCP向SPR/UDR获取该用户的策略签约信息，并向SPR/UDR订阅该用户的策略签约信息变更通知。 
RCP基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP向SMF发送Npcf_SMPolicyControl_Create响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
RCP根据N7会话的DNN判断是否要向BSF注册N7会话绑定信息（即N7会话和RCP的关联信息）。如果需要注册，RCP向BSF发送Nbsf_Management_Register请求。 
BSF记录下绑定信息，向RCP回复Nbsf_Management_Register响应。 
本RCP向容灾RCP同步备份该用户的稳态数据。 
容灾RCP完成数据备份，并返回响应。 
SMF检测到链路堵塞、中断或者通过NRF得到RCP状态不可用通知。 
SMF切换局向到容灾RCP2。 
SMF向容灾RCP2发送Npcf_SMPolicyControl_Update请求。 
容灾RCP2判断此用户归容灾RCP1接管，则返回Npcf_SMPolicyControl_Update响应，响应码为307，并且携带容灾RCP1的FQDN，指示SMF需将此消息发送到RCP1。 
SMF收到RCP的响应之后，切换局向到容灾RCP1。 
SMF向RCP1发送Npcf_SMPolicyControl_Update请求。 
RCP1检测到主用RCP故障，接管用户。如果RCP1尚未向SPR重新订阅，则发起重新订阅，如果RCP1已经重新订阅过，则跳过此步骤。 
RCP1判断是否向BSF进行了注册，如果已经注册过，并且RCP1尚未向BSF发起重新注册，则需要发送Nbsf_Management_Deregister请求消息到BSF。否则，跳过下面和BSF交互的步骤。 
BSF返回Nbsf_Management_Deregister响应。 
RCP1发送Nbsf_Management_Register请求消息到BSF，重新注册。 
BSF返回Nbsf_Management_Register响应。 
RCP1基于运营商配置的策略规则和各NF的输入信息进行策略决策，生成SM策略，并确定需要为此SM策略关联向SMF订阅的事件。RCP1向SMF发送Npcf_SMPolicyControl_Update响应，其中包含PCF生成的SM策略关联ID、SM策略、订阅的事件列表。 
主用RCP恢复，容灾RCP1检测到主用RCP恢复，开始向主用RCP同步备份该用户的稳态数据。 
主用RCP完成数据备份，并返回响应。 
热备容灾状态切换（PROXY方式）
当RCP组Pool且开启热备时，RCP间按用户粒度进行数据同步，要求一个用户的所有会话在一个RCP上处理（即便还未发生容灾切换时也是这样要求）。如果一个用户的多个会话分发到不同RCP，RCP可以通过REDIRECT（重定向）或PROXY（代理转发）方式将用户多会话汇聚到一个RCP上处理。此外，在容灾切换时，也可能用到REDIRECT或PROXY。例如，RCP1故障，RCP2接管了RCP1的某个用户会话，但SMF将该用户会话的后续请求发给了RCP3，RCP3就会采用REDIRECT或PROXY方式将请求转给RCP2处理。 
REDIRECT方式要求对端网元支持HTTP/DIAMETER重定向，当RCP收到对端网元的请求消息并回复重定向时，对端网元要能按RCP的重定向指示将请求转发到目标RCP。而PROXY方式在RCP间转发请求/响应，对对端网元基本没有要求，兼容性更好，但PROXY方式会增加RCP间的信令开销，对RCP的性能影响较REDIRECT方式更为显著。RCP采用REDIRECT还是PROXY方式可以通过配置决定（容灾全局配置→消息中转方式
，选择REDIRECT或PROXY）。如果采用PROXY方式，并且使用Gx/Gxx/Sd/Rx/Sy接口，还需要配置RCP两两间的Diameter链路用于转发这些Diameter接口的请求/响应消息。
以N7接口为例，PROXY方式下N7接口典型流程如下。 
Create流程PROXY方式（Create）的热备容灾状态切换流程如图8所示。图8  PCF热备容灾状态切换（PROXY方式）- Create流程SMF向RCP1发送Create请求，Request URI的authority部分填的是RCP1的IP/PORT或FQDN。RCP1分析该用户应当在RCP2处理（该用户在RCP2上已有会话），将Create请求转发给RCP2。RCP2收到Create请求，分析该用户在本RCP处理，进行策略决策，生成Create响应，其中Resource URI的authority部分填的是RCP2的IP/PORT或FQDN。RCP2将Create响应发给RCP1。RCP1将Create响应转发给SMF。 
Update流程1PROXY方式（Update）的热备容灾状态切换流程如图9所示。适用于SMF不能根据Create响应Resource URI的authority部分重新分析PCF局向的场景，此时SMF认为该会话仍在RCP1处理。图9  PCF热备容灾状态切换（PROXY方式）- Update流程1流程说明如下：SMF向RCP1发送Update请求。RCP1分析此用户应该在RCP2处理，将Update请求转发给RCP2。RCP2收到Update请求，分析此用户在本RCP处理，进行策略决策，回复Update响应给RCP1。RCP1将Update响应转发给SMF。 
Update流程2PROXY方式（Update）的热备容灾状态切换流程如图10所示。适用于SMF能根据Create响应Resource URI的authority部分重新分析PCF局向的场景，此时SMF知道该会话仍在RCP2处理。 说明：目前大部分SMF不支持此场景。图10  PCF热备容灾状态切换（PROXY方式）- Update流程2流程说明如下：SMF将Update请求直接发送给RCP2，请求中Request URI的authority部分填的是RCP2的IP/PORT或FQDN。RCP2生成Update响应后直接回复给SMF。 
UpdateNotify流程PROXY方式（UpdateNotify）的热备容灾状态切换流程如图11所示。图11  PCF热备容灾状态切换（PROXY方式）- UpdateNotify流程流程说明如下：当RCP2判断需要主动更新策略控制时，RCP2直接向SMF发送UpdateNotify请求，消息体中的ResourceURI的authority部分填的是RCP2的IP/PORT或FQDN。SMF回复UpdateNotify响应。 
从上述流程可以看出，PROXY方式下，中间RCP（上例中的RCP1）仅转发上行请求/响应，最终业务在目标RCP（上例中的RCP2）处理。反向请求则由目标RCP直接发给对端网元，不经过中间RCP。Diameter消息的处理方式和HTTP类似，主要差异在于RCP1转Diameter请求给RCP2时，会将RCP2填到消息的Destination-Host上，而RCP1转发HTTP请求给RCP2时则不用修改消息内容。 
RCP的PROXY/REDIRECT方式适用的接口范围相同，既包括服务接口如N7、N15、N5，也包括Diameter接口如Gx、Gxx、Sd、Rx、Sy，但都不处理Sp/Sp'接口的PNR消息。收到PNR时，如果RCP判断非本网元处理，直接丢弃（容灾接管RCP会主动发UDR到SPR注册，此外存在SPR广播PNR的场景，因此PNR不适合做PROXY或REDIRECT）。
#### PCF容灾配置 
##### 配置前提 
完成以下检查。 
序号|检查项目|通过标准|备注
---|---|---|---
1|租户配置检查|主备局号需要正确，租户名称需要为tenant_1，访问策略为主用访问优先。左右域SC TYPE对应值必须正确（老版本升级的是1和2，新版本实例化是9和10）。|检查主备局号、租户名称和访问策略：在Ncudr_SystemManagement_0服务下，执行SHOW CDBTENANT命令。检查SC类型ID：在CommonS_TMSP_0服务下，执行SHOW SERVICEINFO:SERVICETYPENAME="Nudsf_UnstructuredDataManagement"命令。
2|本局配置检查|PCF的局号需要正确，租户名称需要为tenant_1。|在Npcf_PolicyManagement_0服务下，执行SHOW NFINFO命令。
3|变化表检查|检查是否无变化表，如有变化表请确认后传表。|在PCF节点下，执行SHOW CHG命令。
4|网元告警检查|检查是否有异常告警，如果有则需要确认是否影响容灾配置。|-
5|时间同步检查|检查所有局的系统时间是否一致，NTP必须启用。|在CommonS_TMSP_0下，执行SHOW NTP命令。
6|网络平面检查|需要规划独立的容灾网络平面（data平面）。|-
##### 数据规划 
数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
带UDSF主局|带UDSF备局|不带UDSF局1|不带UDSF局2|不带UDSF局3
---|---|---|---|---
ADD SCTP（增加SCTP偶联配置）|本端IP地址1|240E:0180:02E1:FF00::0015|240E:0180:02E2:FF00::0015|240E:0180:02E1:FF00::003A|240E:0180:02E2:FF00::003A|240E:0180:02E1:FF00::003E|该参数为偶联第一对地址本端IP。
本端IP地址2|ADD SCTP（增加SCTP偶联配置）|240E:0180:02E1:FF00::0016|240E:0180:02E2:FF00::0016|240E:0180:02E1:FF00::004A|240E:0180:02E2:FF00::004A|240E:0180:02E1:FF00::004E|该参数为偶联第二对地址本端IP。
VPNID|ADD SCTP（增加SCTP偶联配置）|12|12|12|12|12|该参数为偶联第一对地址的VPNID。
ADD DIM RCPLINK（增加DIAMETER链路）|本端主机名称|pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf03-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf04-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|pcf05-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org|本参数用于指定该Diameter信令链路的本端主机名，与已配置的本局主机名一致，参见ADD HOST。本端主机名称在处理基本DIAMETER消息、动态生成路由、通过上行请求消息查找路由等场景使用。
本端域名|ADD DIM RCPLINK（增加DIAMETER链路）|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|epc.mnc011.mcc460.3gppnetwork.org|本参数用于指定Diameter信令链路的本端域名，与已配置的本局域名一致，参见ADD REALM。本端域名称在RCP处理基本Diameter消息、动态生成路由等场景使用。
ADD DIM ROUTEGRPPTY（增加DIAMETER路由组属性）|路由组属性|LOADBALANCE|LOADBALANCE|LOADBALANCE|LOADBALANCE|LOADBALANCE|该参数用于指定关联该Diameter路由组属性配置的Diameter路由之间的关系。该参数的选项有以下两种：负荷分担（LOADBALANCE）。采用负荷分担方式时，可以通过ADD DIM ROUTE命令配置路由组中各路由的权重。RCP进行路由分析时，根据权重配置在各路由之间实现负荷分担。主备模式（BACKUP）。采用主备模式时，可以通过ADD DIM ROUTE命令配置路由组中的路由为主用路由或备用路由。RCP进行路由分析时，优先选择主用路由。当主用路由发生故障时，RCP才会选择备用路由。
ADD DIM ROUTE（增加DIAMETER路由）|本地动作|RELAY|RELAY|RELAY|RELAY|RELAY|当Diameter子系统接收到本网元发出的Diameter消息、或者来自上一跳对等端的Diameter消息时，通过该参数来确定本网元的处理方式。处理方式支持一种：RELAY，消息直接发往下一跳的服务器，且不修改消息中任何与路由无关的属性。
路由优先级|ADD DIM ROUTE（增加DIAMETER路由）|HIGH|HIGH|HIGH|HIGH|HIGH|该参数用于指定路由的优先级，当存在多条路由时，将依据优先级从高到低进行选路。可配置的优先级有以下三种：低（LOW）中（MID）高（HIGH）
支持应用|ADD DIM ROUTE（增加DIAMETER路由）|GxRxSy|GxRxSy|GxRxSy|GxRxSy|GxRxSy|该参数用于指定该Diameter路由支持的应用。可选的应用有以下10种：COMMON：Diameter在线计费协议/离线计费协议。E4/Sp：用于RCP和SPR的签约消息的交互。Sp'：用于RCP和SPR的用量消息的交互。RX：用于RCP和AF的消息交互。Gx：用于RCP和PCEF的消息交互。Gxx：用于RCP和BBERF的消息交互。S9：RCP内部模块消息交换。Sy：用于RCP和OCS的消息交互。Sd：用于RCP和TDF的消息交互。Sy+：用于RCP和OCS的消息交互。
路由主用标识|ADD DIM ROUTE（增加DIAMETER路由）|MASTER|MASTER|MASTER|MASTER|MASTER|该参数用于指示该Diameter路由为主用路由还是备用路由。只有路由组编号为非0的有效值，且该路由组的路由组属性为主备模式时，本配置才有效。该参数的选项有以下两种：主用（MASTER）备用（SLAVE）
SET DRCFG（修改容灾全局）|容灾模式|N+M|N+M|N+M|N+M|N+M|该参数用于指定本局的容灾模式。不容灾：表示本局不支持容灾。组POOL冷备：表示本局和其他局点之间组成负荷负担的关系。主备：表示本局支持容灾，且和另外一个局点组成主用备用的关系。互备：表示本局支持容灾，且和另外一个局点组成互相备份的关系。N+M：表示本局支持容灾，且和多个局点之间是互相备份的关系。
消息中转方式|SET DRCFG（修改容灾全局）|PROXY|PROXY|PROXY|PROXY|PROXY|该参数用于指定本局接收到不属于本局处理的消息时的处理方式。使用重定向方式选择REDIRECT。使用代理转发方式选择PROXY。
切换后更新主机名|SET DRCFG（修改容灾全局）|YES|YES|YES|YES|YES|该参数用于指定当发生容灾接管时，是否更新Diameter主机名，方便后续消息能够更准确地分发到实际的处理局，减少消息交互。否：表示Diameter主机名填写的是用户归属局的主机名。是：表示Diameter主机名填写的是当前局的主机名。
ADD POOLCFG（增加POOL）|PCF局向号|81|82|83|84|85|该参数用于指定N+M容灾或组POOL冷备的局向号。
ADD NFCFG（增加NF标识配置）|NF标识|81|82|N/A|N/A|N/A|NF的唯一标识。
NF名称|ADD NFCFG（增加NF标识配置）|PCF_81|PCF_82|N/A|N/A|N/A|NF的名称。
NF类型|ADD NFCFG（增加NF标识配置）|81：self_nf82：diff_tmsp_nf83：diff_tmsp_nf84：diff_tmsp_nf85：diff_tmsp_nf|82：self_nf81：diff_tmsp_nf83：diff_tmsp_nf84：diff_tmsp_nf85：diff_tmsp_nf|N/A|N/A|N/A|NF的类型。包括：self_nf：本地NF。same_tmsp_nf：和本地NF部署在同一TMSP的其他NF。diff_tmsp_nf：和本地NF部署在不同TMSP的其他NF。
ADD UDSFCLIENTNF（增加NF配置）|NF类型|81：self_nf82：diff_tmsp_nf|82：self_nf81：diff_tmsp_nf|83：self_nf81：diff_tmsp_nf82：diff_tmsp_nf|84：self_nf81：diff_tmsp_nf82：diff_tmsp_nf|85：self_nf81：diff_tmsp_nf82：diff_tmsp_nf|NF的类型。包括：self_nf：本地NF。same_tmsp_nf：和本地NF部署在同一TMSP的其他UDSF。diff_tmsp_nf：和本地NF部署在不同TMSP的其他UDSF。
ADD CGWNODE（增加CGW互联配置）|网络用途|data_access_1data_sync_1|data_access_1data_sync_1|N/A|N/A|N/A|网络用途，指示用于和网元的数据访问通讯或用于和其他CGW的数据复制通讯，以及所在网络平面。包括：data_access_1：通过数据访问网络平面1，和使用UDSF的网元通讯。data_access_2：通过数据访问网络平面2，和使用UDSF的网元通讯。data_sync_1：通过数据复制网络平面1，和其他UDSF的CGW通讯。data_sync_2：通过数据复制网络平面2，和其他UDSF的CGW通讯。如果只有一个网络平面，则必须配置为网络平面1。
IP地址|ADD CGWNODE（增加CGW互联配置）|240E:0180:02E1:FF00::000C|240E:0180:02E1:FF00::000C|N/A|N/A|N/A|本端的IP地址，支持IPv4和IPv6。使用不同的端口范围时，一个IP地址既可以用于和网元通讯，也可用于和其他CGW通讯。
监听端口最小值|ADD CGWNODE（增加CGW互联配置）|数据访问网络1：30000数据同步网络1：35000数据同步网络1：36000|数据访问网络1：30000数据同步网络1：35000数据同步网络1：36000|N/A|N/A|N/A|接收对端网元或CGW的TCP链接的本端起始端口。
监听端口最大值|ADD CGWNODE（增加CGW互联配置）|数据访问网络1：30003数据同步网络1：35003数据同步网络1：36003|数据访问网络1：30003数据同步网络1：35003数据同步网络1：36003|N/A|N/A|N/A|接收对端网元或CGW的TCP链接的本端终止端口。
连接端口最小值|ADD CGWNODE（增加CGW互联配置）|数据访问网络1：51000数据同步网络1：50000数据同步网络1：56000|数据访问网络1：53000数据同步网络1：50000数据同步网络1：56000|N/A|N/A|N/A|主动连接对端CGW的本端起始端口。网络用途为数据访问时，不需要配置。
连接端口最大值|ADD CGWNODE（增加CGW互联配置）|数据访问网络1：52000数据同步网络1：50050数据同步网络1：56050|数据访问网络1：54000数据同步网络1：50050数据同步网络1：56050|N/A|N/A|N/A|主动连接对端CGW的本端终止端口。网络用途为数据访问时，不需要配置。
VPNID|ADD CGWNODE（增加CGW互联配置）|21|21|N/A|N/A|N/A|VPN的ID。在CommonS_TMSP节点下的Rosng配置中，使用SHOW IP VRF DETAIL命令，获取VRF TST中的VPNID进行配置。如果没有Rosng配置，则VPNID为0。
ADD UDSFSERVER（增加UDSF服务端配置）|主用UDSF的NF ID|N/A|N/A|81|81|81|主用UDSF的唯一NF标识。
备用UDSF的NF ID|ADD UDSFSERVER（增加UDSF服务端配置）|N/A|N/A|82|82|82|备用UDSF的唯一NF标识。
ADD CGWSERVER（增加CGW服务端配置）|NF ID|N/A|N/A|NF1 ID：81NF2 ID：82|NF1 ID：81NF2 ID：82|NF1 ID：81NF2 ID：82|UDSF的唯一NF标识。
IP地址|ADD CGWSERVER（增加CGW服务端配置）|N/A|N/A|NF1 IP：240E:0180:02E1:FF00::000CNF2 IP：240E:0180:02E2:FF00::000C|NF1 IP：240E:0180:02E1:FF00::000CNF2 IP：240E:0180:02E2:FF00::000C|NF1 IP：240E:0180:02E1:FF00::000CNF2 IP：240E:0180:02E2:FF00::000C|CGW接收网元数据访问的TCP链接的IP地址，支持IPv4和IPv6。
监听端口最小值|ADD CGWSERVER（增加CGW服务端配置）|N/A|N/A|30000|30000|30000|CGW接收网元数据访问的TCP链接的IP起始端口。
监听端口最大值|ADD CGWSERVER（增加CGW服务端配置）|N/A|N/A|30003|30003|30003|CGW接收网元数据访问的TCP链接的IP终止端口。
NF列表|ADD CGWSERVER（增加CGW服务端配置）|N/A|N/A|NF1：81NF2：82|NF1：81NF2：82|NF1：81NF2：82|CGW可以为部署在同一TMSP的多个UDSF服务，该参数列出了通过该CGW可访问的所有UDSF的NF标识，多个UDSF标识使用'&'连接。通常设置为和NFID参数一致。
ADD CGWCLIENT（增加CGW客户端配置）|服务类型|N/A|N/A|44|44|44|NFS类型取值为44，表示PCF。
服务组件类型|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|30|30|30|SC类型取值为30，表示SMPolicyControl服务。
IP地址|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|240E:0180:02E1:FF00::003B|240E:0180:02E2:FF00::003B|240E:0180:02E1:FF00::003F|本端IP地址，支持IPv4和IPv6。一个IP地址，可以被多个同一NFS或不同NFS的服务组件使用，只要这些服务组件使用不同的端口范围。
连接端口最小值|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|51000|51000|51000|服务组件使用的起始IP端口。
连接端口最大值|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|54000|54000|54000|服务组件使用的终止IP端口。端口总数应不小于NFS实例总数和每个NFS实例内的服务组件实例总数的乘积。
端口数/服务实例|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|1001|1001|1001|业务SC个数，填写1001。
VPNID|ADD CGWCLIENT（增加CGW客户端配置）|N/A|N/A|21|21|21|容灾业务地址关联VPNID，根据现网规划填写。
SET PCFSERVICE（修改服务基础）|服务类型|NPCFNPCF_SMPOLICYCONTROLNPCF_AMPOLICYCONTROL|NPCFNPCF_SMPOLICYCONTROLNPCF_AMPOLICYCONTROL|NPCFNPCF_SMPOLICYCONTROLNPCF_AMPOLICYCONTROL|NPCFNPCF_SMPOLICYCONTROLNPCF_AMPOLICYCONTROL|NPCFNPCF_SMPOLICYCONTROLNPCF_AMPOLICYCONTROL|该参数用于设置服务类型：NPCF_SMPOLICYCONTROL：表示使用Npcf_SMPolicyControl服务作为服务类型。NPCF_AMPOLICYCONTROL：表示使用Npcf_AMPolicyControl服务作为服务类型。NPCF_UEPOLICYCONTROL：表示使用NPCF_UEPOLICYCONTROL服务作为服务类型。NPCF_POLICYAUTHORIZATION：表示使用Npcf_PolicyAuthorization服务作为服务类型。Npcf：表示通配服务类型。
优先级|SET PCFSERVICE（修改服务基础）|10|10|10|10|10|本参数指定该服务的优先级。取值范围为0~65535，数值越小，优先级越高。
##### 配置步骤 
PCF配置
Proxy链路配置 
PCF使用Proxy方式容灾时需要配置。 
同一个POOL里所有PCF局之间需要配置局间Diameter链路，本局到每个PCF局需要配置4条SCTP偶联、4条Diameter链路、2-3个路由组（Gx、Rx、Sy（中国电信需要额外配置））、8-12条路由（Gx、Rx、Sy（中国电信需要额外配置））。 
以PCF81配置到PCF82的1个局向为例，配置过程参见下表。 
步骤|操作说明|操作
---|---|---
a|增加SCTP偶联配置|ADD SCTP:ID=261,NAME="PCF01-PCF02-SCTP1",LOCPORT=8121,REMPORT=18121,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="SVR",PROTOCALTYPE="DIAMETER"ADD SCTP:ID=262,NAME="PCF01-PCF02-SCTP2",LOCPORT=8122,REMPORT=18122,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="SVR",PROTOCALTYPE="DIAMETER"ADD SCTP:ID=263,NAME="PCF01-PCF02-SCTP3",LOCPORT=8123,REMPORT=18123,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0015",REMADDR1="240E:0180:02E2:FF00::0015",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0016",REMADDR2="240E:0180:02E2:FF00::0016",ROLE="CLT",PROTOCALTYPE="DIAMETER"ADD SCTP:ID=264,NAME="PCF01-PCF02-SCTP4",LOCPORT=8124,REMPORT=18124,VPNID1=12,LOCADDR1="240E:0180:02E1:FF00::0016",REMADDR1="240E:0180:02E2:FF00::0016",VPNID2=12,LOCADDR2="240E:0180:02E1:FF00::0015",REMADDR2="240E:0180:02E2:FF00::0015",ROLE="CLT",PROTOCALTYPE="DIAMETER"
b|增加DIAMETER链路|ADD DIM RCPLINK:LINKNO=261,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=261,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM1"ADD DIM RCPLINK:LINKNO=262,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=262,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM2"ADD DIM RCPLINK:LINKNO=263,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=263,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM3"ADD DIM RCPLINK:LINKNO=264,LOCALHOSTNAME="pcf01-B-ze-dc01.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",LOCALREALM="epc.mnc011.mcc460.3gppnetwork.org",DSTHOSTNAME="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",DSTREALM="epc.mnc011.mcc460.3gppnetwork.org",ADJTYPE="PCRF",CONNID=264,PROTOCOL="SCTP",NAME="PCF01-PCF02-DIM4"
c|增加DIAMETER路由组属性|ADD DIM ROUTEGRPPTY:GROUPNO=261,GROUPNAME="PCF02-Gx",GROUPPTY="LOADBALANCE"ADD DIM ROUTEGRPPTY:GROUPNO=262,GROUPNAME="PCF02-Rx",GROUPPTY="LOADBALANCE"ADD DIM ROUTEGRPPTY:GROUPNO=263,GROUPNAME="PCF02-Sy",GROUPPTY="LOADBALANCE"
d|增加DIAMETER路由|ADD DIM ROUTE:ROUTENO=2611,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2612,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2613,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2614,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Gx",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=261,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2615,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2616,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2617,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2618,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="RX",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=262,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2619,LOCALPROCESSID="RELAY",MASTERLINKNO=261,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2620,LOCALPROCESSID="RELAY",MASTERLINKNO=262,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2621,LOCALPROCESSID="RELAY",MASTERLINKNO=263,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER"ADD DIM ROUTE:ROUTENO=2622,LOCALPROCESSID="RELAY",MASTERLINKNO=264,ROUTEPRIORITY="HIGH",ROUTEAPPID="Sy",DESTURI="pcf02-B-ze-dc02.cd.sc.node.epc.mnc011.mcc460.3gppnetwork.org",ROUTEGROUPNO=263,MASTERFLAG="MASTER"
容灾全局配置 
所有PCF局都需要配置，代理转发或重定向，两种方式配置二选一。 
操作说明|操作
---|---
代理转发方式|SET DRCFG:DRMODE="N_M",MSGTRANMODE="PROXY",UPDATEHN="YES"
重定向方式|SET DRCFG:DRMODE="N_M",MSGTRANMODE="REDIRECT",UPDATEHN="YES"
POOL配置 
仅PCF组Pool时需要配置，Pool内所有局都需要配置。 
操作说明|操作
---|---
增加POOL，该配置需要包含所有PCF局向号，不要把局号0设置在非0之前。|ADD POOLCFG:NEID1=81,NEID2=82,NEID3=83,NEID4=84,NEID5=85,NEID6=0,NEID7=0
NF标识配置 
步骤|操作说明|操作
---|---|---
a|带UDSF主局PCF_81配置|ADD NFCFG:NFID=81,NFNAME="PCF_81",NFTYPE="self_nf",COMMTYPE="NULL"ADD NFCFG:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=84,NFNAME="PCF_84",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=85,NFNAME="PCF_85",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD UDSFCLIENTNF:NFID=81,NFNAME="PCF_81",NFTYPE="self_nf"ADD UDSFCLIENTNF:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf"
b|带UDSF备局PCF_82配置|ADD NFCFG:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=82,NFNAME="PCF_82",NFTYPE="self_nf",COMMTYPE="NULL"ADD NFCFG:NFID=83,NFNAME="PCF_83",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=84,NFNAME="PCF_84",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD NFCFG:NFID=85,NFNAME="PCF_85",NFTYPE="diff_tmsp_nf",COMMTYPE="NULL"ADD UDSFCLIENTNF:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf"ADD UDSFCLIENTNF:NFID=82,NFNAME="PCF_82",NFTYPE="self_nf"
c|不带UDSF局PCF_83配置|ADD UDSFCLIENTNF:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf"ADD UDSFCLIENTNF:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf"ADD UDSFCLIENTNF:NFID=83,NFNAME="PCF_83",NFTYPE="self_nf"
d|不带UDSF局PCF_84配置|ADD UDSFCLIENTNF:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf";ADD UDSFCLIENTNF:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf";ADD UDSFCLIENTNF:NFID=84,NFNAME="PCF_84",NFTYPE="self_nf";
e|不带UDSF局PCF_85配置|ADD UDSFCLIENTNF:NFID=81,NFNAME="PCF_81",NFTYPE="diff_tmsp_nf";ADD UDSFCLIENTNF:NFID=82,NFNAME="PCF_82",NFTYPE="diff_tmsp_nf";ADD UDSFCLIENTNF:NFID=85,NFNAME="PCF_85",NFTYPE="self_nf";
CGW互联配置 
步骤|操作说明|操作
---|---|---
a|带UDSF主局PCF_81配置：主备UDSF之间可以通过CGW相互通讯，实现数据访问和数据同步。监听端口段包含端口个数一定要等于CGW节点个数。CGW节点个数通过SHOW CGW STATUS命令查询，查询到几条记录就是几个节点。|ADD CGWNODE:NFID=81,NETTYPE="data_access_1",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=30000,SERVERPORTEND=30003,CONNECTPORTSTART=51000,CONNECTPORTEND=52000,NFLIST="81",VPNID=21ADD CGWNODE:NFID=81,NETTYPE="data_sync_1",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35003,CONNECTPORTSTART=50000,CONNECTPORTEND=50050,NFLIST="81",VPNID=21ADD CGWNODE:NFID=82,NETTYPE="data_sync_1",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36003,CONNECTPORTSTART=56000,CONNECTPORTEND=56050,NFLIST="82",VPNID=21
b|带UDSF备局PCF_82配置：主备UDSF之间可以通过CGW相互通讯，实现数据访问和数据同步。监听端口段包含端口个数一定要等于CGW节点个数。CGW节点个数通过SHOW CGW STATUS命令查询，查询到几条记录就是几个节点。|ADD CGWNODE:NFID=81,NETTYPE="data_sync_1",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=35000,SERVERPORTEND=35003,CONNECTPORTSTART=50000,CONNECTPORTEND=50050,NFLIST="81",VPNID=21ADD CGWNODE:NFID=82,NETTYPE="data_access_1",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=30000,SERVERPORTEND=30003,CONNECTPORTSTART=53000,CONNECTPORTEND=54000,NFLIST="82",VPNID=21ADD CGWNODE:NFID=82,NETTYPE="data_sync_1",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=36000,SERVERPORTEND=36003,CONNECTPORTSTART=56000,CONNECTPORTEND=56050,NFLIST="82",VPNID=21
UDSF服务端配置 
操作说明|操作
---|---
仅不带UDSF局PCF需要配置|ADD UDSFSERVER:NFID=81,NFID2=82
CGW服务端配置 
操作说明|操作
---|---
仅不带UDSF局PCF需要配置|ADD CGWSERVER:NFID=81,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000C",SERVERPORTSTART=30000,SERVERPORTEND=30003,NFLIST="81"ADD CGWSERVER:NFID=82,IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000C",SERVERPORTSTART=30000,SERVERPORTEND=30003,NFLIST="82"
CGW客户端配置 
步骤|操作说明|操作
---|---|---
a|仅不带UDSF局PCF需要配置，PCF_83配置|ADD CGWCLIENT:NFSTYPE=44,SCTYPE=30,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::003B",CLIENTPORTSTART=51000,CLIENTPORTEND=54000,COUNTPERINST=1001,VPNID=21
b|仅不带UDSF局PCF需要配置，PCF_84配置|ADD CGWCLIENT:NFSTYPE=44,SCTYPE=30,IPTYPE="IPV6",IP="240E:0180:02E2:FF00::003B",CLIENTPORTSTART=51000,CLIENTPORTEND=54000,COUNTPERINST=1001,VPNID=21
c|仅不带UDSF局PCF需要配置，PCF_85配置|ADD CGWCLIENT:NFSTYPE=44,SCTYPE=30,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::003F",CLIENTPORTSTART=51000,CLIENTPORTEND=54000,COUNTPERINST=1001,VPNID=21
服务优先级配置 
所有局PCF服务优先级一致，所有局都需要配置。电信暂不启用NPCF_AMPOLICYCONTROL服务，仅提供NPCF、NPCF_SMPOLICYCONTROL服务。 
操作说明|操作
---|---
PCF服务配置|SET PCFSERVICE:SERVICETYPE="NPCF",PRIORITY=XSET PCFSERVICE:SERVICETYPE="NPCF_SMPOLICYCONTROL",PRIORITY=XSET PCFSERVICE:SERVICETYPE="NPCF_AMPOLICYCONTROL",PRIORITY=X
改造后配置及容灾状态检查 
对所有局进行检查，预期结果参见下表。 
检查项|预期变化
---|---
SHOW DRCFG|所有局为N+M模式。
SHOW MSCFG|无
SHOW POOLCFG|显示所有局向号。
SHOW PCFSERVICE|各局优先级一致。
SHOW_DR_NFINFO|能获取到对端局的主机名，FQDN等信息。
SHOW CGW LINK|查询的结果均正常。
SHOW CDBTENANT|查询UDSF两个局的局号、租户正确。
SHOW NFINFO|查询PCF局号、租户和UDSF租户信息一致。
SHOW CHG|无
网元告警检查|无异常告警。
周边网元配置
网元|配置说明|配置命令
---|---|---
SMF|查询PCF负载模式是否为非绑定，如果不是，则需修改，PROFILENAME参数根据实际配置填写。|SET PCFDYNAMICPROFILE:PROFILENAME="ctnet",BALANCEMODE="PCF_NOT_BINGDING"SET PCFDYNAMICPROFILE:PROFILENAME="ims",BALANCEMODE="PCF_NOT_BINGDING"
NRF|在NRF上配置心跳检测时长。|ADD HEARTBEATCHECK:NFTYPE="PCF",SENDINTERVAL=10,SENDTIMES=3
BSF/DRA|BSF、DRA要求指向POOL PCF，且某PCF故障后对于新会话、老会话要能指向POOL内其他PCF。|-
##### 指标监控 
性能统计
PCF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|N15接口测量|以C52002开头的所有计数器
2|IPS性能测量|以C55800开头的所有计数器
3|以太接口测量|以C55851开头的所有计数器
4|SCTP静态偶联测量|以C55900开头的所有计数器
5|TMSP基本测量|以C55501开头的所有计数器
6|虚拟机磁盘分区空间测量|以C55701开头的所有计数器
7|虚拟机vCPU核测量|以C55702开头的所有计数器
8|虚拟机基本测量|以C55700开头的所有计数器
9|HTTP服务端建链流程消息测量|以C55604开头的所有计数器
告警与通知
PCF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|2399471874 DIAMETER静态链路建链不成功或链路断
2|8402690 偶联断链
3|8417537 偶联通路断
4|3339321605 NRF节点不可达告警
5|150101 接口IPv4协议态Down
6|150102 接口IPv6协议态Down
7|150111 接口二层协议态Down
8|2987001347 短信链路组不可用
9|2987001345 短信中心链路建立失败
10|3339321607 系统处于故障状态
### UDM 
#### UDM容灾 
##### 容灾组网 
UDM由FE、BE两部分组成，支持以下地理容灾方案。 
1+1主备两个UDM站点跨DC主备部署，如图1所示。UDM FE跨DC主备部署，UDM BE跨DC主备部署。图1  1+1主备容灾组网正常情况下只有主用FE以及主用BE处理业务。容灾FE作为信令处理的备份，不处理业务。容灾BE和主用BE之间通过数据复制消息，保持主备BE间的数据一致性。BOSS系统只接入主用BE，通过主用FE向对端网元同步下发修改后的用户数据。 
1+1互备两个UDM站点跨DC互备部署，如图2所示。UDM FE跨DC互备部署，UDM BE跨DC互备部署。图2  1+1互备容灾组网两个站点FE均提供信令处理，且互为备份。每个FE均有归属自身的主用号段，同时作为另一FE号段的备份。任一FE故障情况下，另一FE可接管全部号段的所有业务。用户数据在每个BE都有副本存储，实现两个站点互为备份。BE之间通过数据复制消息，保持数据一致性。BOSS系统集中接入UDM站点（图2中以BE1为例），通过号段归属的FE向对端网元同步下发修改后的用户数据。 
##### 容灾原理 
FE容灾
UDM FE容灾主要采用1+1主备模式，如[图3](27.html#T_1604980389619__816eedc5-b43e-4f6d-949a-8a0ac9b22061)所示。
图3  FE容灾
[]images/FE%E5%AE%B9%E7%81%BE.png)
主、备UDM的FE均向NRF发起注册，携带优先级Priority、SUPI号段、GPSI号段、GroupID、静态容量Capacity、动态容量Load等信息，用于AMF/SMF发现UDM。UDM在完成注册后，以NRF下发的心跳定时器为周期向NRF更新自身状态。 
AMF/SMF通过NRF服务发现UDM，并根据优先级Priority选择高优先级（主用）的UDM FE。同时，AMF/SMF向NRF订阅UDM状态信息。 
NRF通过和UDM之间的心跳消息检测到主用UDM故障。 
NRF向已订阅UDM状态的AMF/SMF发送UDM状态更新通知。 
AMF/SMF根据NRF的UDM状态更新通知消息，判断主用UDM状态异常，选择备用UDM FE。 
BE容灾
BE容灾主要采用1+1主备模式，如[图4](27.html#T_1604980389619__f2f4bb4a-523c-4292-a749-8e0e186eb693)所示。
图4  BE容灾
[]images/BE%E5%AE%B9%E7%81%BE.png)
DSA（Directory System
Agent）节点是服务的核心处理节点，用多个DSA节点构建DSA集群，再将DSA节点跨DC分布。
系统正常状态时，所有PDS（Primary Directory Server）状态的DSA节点都在主用BE。备用BE仅提供读访问操作，所有的写访问操作都只能在主用BE进行。 
主用BE发生故障时，备用BE接管所有的业务。 
DSA集群按照如下方式协同工作： 
集群内只允许一个节点写数据，确保节点间数据的一致性。 
节点间通过数据复制机制，确保数据的同步性，确保能够提供读数据服务能力。 
通过负荷分担的方式对外提供读数据服务。 
容灾可靠性
容灾可靠性主用BE故障时自动倒换主用FE与主用BE间链路发生故障的场景下，主用FE自动切换访问备用BE，如图5所示。图5  主用BE故障时自动倒换FE1（主用）检测到BE1（主用）间的通信链路发生故障，FE1自动切换数据访问路由至BE2（备用）。BE2无缝接管FE1的数据访问。 
无可用BE时整体倒换主用FE与主、备BE间链路均发生故障的场景下，UDM系统支持触发容灾整体倒换，提升容灾系统的可靠性，如图6所示。图6  无可用BE时整体倒换FE1（主用）检测到与BE1（主用）、BE2（备用）之间的通信链路全部发生故障。FE1检测到BE的通信故障满足整体倒换条件，FE1向NRF更新自身NF注册状态为“UNDISCOVERABLE”。同时闭塞所有M3UA、Diameter链路，触发STP、DRA外部网元设备倒换信令路由到备用UDM。NRF向已订阅UDM状态的AMF/SMF发送UDM状态更新通知。AMF/SMF检测到主用UDM状态异常，在进行UDM路由选择时，选择备用UDM完成用户业务。 
业务域故障时联动倒换UDM为5GC网络提供统一用户数据管理服务，同时也融合提供了传统2/3G、4G、IMS业务域功能。为保障用户语音、数据业务连续性，UDM在单一业务域故障时支持业务域间的联动倒换。如图7所示，以2/3G业务域故障为例，介绍联动倒换的过程。图7  业务域故障时联动倒换FE1（主用）检测到与2/3G（或者4G、IMS）业务域关键局向发生通信故障。FE1判断满足整体倒换条件，闭塞所有M3UA信令局向、Diameter链路，触发STP、DRA外部网元设备倒换信令路由到备用UDM。同时向NRF更新自身NF注册状态为“UNDISCOVERABLE”。NRF向已订阅UDM状态的AMF/SMF发送UDM状态更新通知。AMF/SMF检测到主用UDM状态异常，在进行UDM路由选择时，选择备用UDM完成用户业务。 
##### 部署要求 
UDM容灾部署的要求如下： 
UDM与NRF之间的心跳检测周期为5秒，检测次数5次。 
BOSS系统接入主用UDM。 
UDM的FE配置为优先访问本地BE。 
容灾组网方案选取原则如下： 
容灾主备方案部署、操作维护简单。容灾方案成熟，运维经验、技能完善。推荐首选。 
容灾互备方案部署简单，操作维护相对较复杂。容灾运维技能相对较高。BE之间数据一致性同步对IP承载网质量有较高要求。建议在IP承载网质量良好情况下选用。 
##### 容灾业务流程 
UDM故障容灾
AMF、SMF通过向NRF订阅UDM状态通知，获取UDM状态。AMF、SMF根据NRF的UDM状态通知选择容灾UDM，如[图8](27.html#T_1604980389619__02def4e8-9ca6-42e7-a5d4-bc327c9b4cff)所示。
图8  UDM故障容灾
[]images/UDM%E6%95%85%E9%9A%9C%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
流程说明如下： 
主用、备用UDM分别向NRF注册自身NF信息，携带相同的SUPI、GPSI号段列表、优先级信息。其中主用UDM携带高优先级，备用UDM携带低优先级。 
5G用户UE1发起注册请求。AMF通过NRF发现，选择高优先级的主用UDM请求5G鉴权向量。 
AMF完成鉴权认证，AMF向主用UDM获取用户的移动性管理签约信息。 
AMF向UDM订阅数据变更通知。 
AMF向NRF订阅主用UDM状态。 
AMF根据DNN和切片信息，负荷分担选择SMF，为用户建立PDU会话。 
SMF通过NRF发现，选择高优先级的主用UDM请求会话管理签约数据。 
SMF向UDM订阅数据变更通知。 
SMF向NRF订阅主用UDM状态。 
NRF通过和UDM之间心跳检测到主用UDM故障，通知到已订阅UDM状态的AMF、SMF。 
AMF/SMF通过HTTP链路探测，或者NRF通知检测出主用UDM故障。 
AMF/SMF对新用户业务，选择备用UDM并向NRF订阅备用UDM状态。备用UDM接管新用户业务。 
AMF/SMF对已有用户的业务，切换选择备用UDM。 
UDM故障恢复
AMF、SMF通过向NRF订阅UDM状态通知，获取UDM状态。AMF、SMF根据NRF的UDM状态通知重新恢复选择主用UDM，如[图9](27.html#T_1604980389619__535bb95d-64ad-4267-bc91-e1df0f44e73c)所示。
图9  UDM故障恢复流程
[]images/UDM%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B.png)
流程说明如下： 
AMF收到来自UE1的注册消息，AMF检测到主用UDM故障，选择备用UDM发起位置登记。 
主用UDM故障恢复，向NRF更新自身NF状态信息，携带高优先级。 
NRF向已订阅UDM状态的AMF、SMF发送主用UDM状态正常通知。AMF/SMF本地更新主用UDM状态。 
AMF/SMF对新用户业务，选择主用UDM。 
AMF/SMF对已有用户的业务，切换选择主用UDM。 
#### UDM容灾配置 
##### 配置前提 
系统运行状态检查序号检查项目通过标准备注1容灾局巡检所有FE和BE局无异常告警所有BE局的WEB受理台可用所有FE局信令链路正常营帐路由可达信令链路状态检查，包括SCTP链路、M3UA偶联、Diameter链路和SBI链路检查：SCTP链路：在CommonS_SIG_0服务下，执行SHOW ALLSCTPSTAT命令。M3UA偶联：在CommonS_SIG_0服务下，执行SHOW ALLASPSTAT命令。Diameter链路：在CommonS_DAP_0服务下，执行SHOW DIMLNKSTAT命令。SBI链路：在CommonS_HTTP_LB_0服务下，执行SHOW LINK INFO命令。2UDS数据节点主备状态UDS的集群PDS主节点驻留在其用户数据归属的BE主用局，SDS备节点在其用户数据归属BE容灾局并处于SSDS状态。节点状态查询：在 Ncudr_SystemManagement_0服务下，执行SHOW
DSANODE STATUS命令。在任意一个BE局都可以查询到所有DSA节点状态，包括：主用BE局节点状态和备用BE局节点状态。BE主备局确认：在 Ncudr_SystemManagement_0服务下，执行SHOW
UDSTENANT命令。租户的归属NF ID和归属的第二监控中心NFID标识了当前用户所在租户下主备BE局配置。3DST节点状态各DST显示集群状态和数据状态均为正常。在 Ncudr_SystemManagement_0服务下，执行SHOW DSTNODE
STATUS命令。4容灾FE重同步定时器检查备用FE局的重同步定时器时长需调整为2小时。在备用FE局的SDM_CMS_0服务下，执行以下命令调整重同步定时器时长：SET DEFPRETMR:TIMERID=210365,CURRENTVAL=7200000说明：启用域GT后，如果因为网络原因导致的链路瞬断，业务会自动切换到容灾FE上，当链路恢复后自动切回主用FE。业务切回过程中，会存在部分业务的回程消息发到主用FE上，导致容灾FE上业务失败，引起重同步。
这种重同步消息会连续发送两个小时，导致这些用户连续两小时无法正常做被叫。 
用户数据与网管配置一致性检查序号检查项目通过标准备注1用户数据一致性主备BE局无数据复制异常告警，所有备节点处于数据同步的SSDS状态。主备BE局用户数性能统计数值基本一致，无大量差异（由于有实时业务和统计时差，无法保证完全一致）。在 Ncudr_SystemManagement_0服务下，执行SHOW DSTNODE
STATUS命令。节点状态只有PDS和SSDS，且所有备用节点状态为SSDS。2全局业务配置数据一致性EM上无变化表数据，所有全局配置数据都全同步到前台OMU。本局NF无变化表数据，所有配置数据都同步到前台OMU。分别在UMM节点和USPP名称节点下执行SHOW UMMCHG命令，确认无变化表。 
跨局通讯链路状态检查序号检查项目通过标准备注1链路状态检查如果跨局链路使用的是TCP链路，需要在FE局和BE局检查建链状态和DSA节点状态。FE局跨局链路状态正常：检查结果为“no record”。BE局跨局链路状态正常：检查结果为“no record”。DSA节点状态状态正常：查询结果中能够显示出所有租户和NF下的所有集群和节点。每个集群内只有一个节点状态为PDS，其他节点为SSDS状态。本次存储状态为Normal。DST存储状态Normal（如果没有部署DST存储，本条忽略）。FE局检查跨局建链状态：分别在SDM_FE_HSS_0和SDM_FE_UDM_0服务下，执行SHOW LMLINKINFO:TYPE="BROKEN"命令。BE局检查建链状态：分别在SDM_PROV_PDM_0和SDM_PROV_PGW_0服务下，执行SHOW LMLINKINFO:TYPE="BROKEN"命令。检查DSA节点状态：在Ncudr_SystemManagement_0服务下，执行SHOW
DSANODE STATUS命令。如果跨局链路使用的是SCTP链路，需要在FE局和BE局检查建链状态和DSA节点状态。FE局所有跨局SCTP偶联建链成功。BE局所有跨局SCTP偶联建链成功。DSA节点状态状态正常：查询结果中能够显示出所有租户和NF下的所有集群和节点。每个集群内只有一个节点状态为PDS，其他节点为SSDS状态。本次存储状态为Normal。DST存储状态Normal（如果没有部署DST存储，本条忽略）。FE局检查跨局SCTP偶联状态：在CommonS_SIG_X（X代表SIG服务多实例时，用于跨局通信SCTP的SIG服务实例名称编号）服务下，执行SHOW ALLSCTPSTAT命令。BE局检查跨局SCTP偶联状态：在CommonS_SIG_0服务下，执行SHOW ALLSCTPSTAT命令。检查DSA节点状态：在Ncudr_SystemManagement_0服务下，执行SHOW
DSANODE STATUS命令。 
UDM/AUSF链路状态检查序号检查项目通过标准备注1HTTP链路状态检查检查跨局组网下，所有FE局HTTP动态链路的TCP链路状态和HTTP2连接状态都为“已激活”。主备FE到NRF的链路，要求已建立链路且状态正常。在FE局检查HTTP动态链路状态：在CommonS_HTTP_LB_0服务下，执行SHOW
LINK INFO:LINKTYPE="DYNAMIC LINK"命令。2NRF注册状态检查在主备NRF上检查AUSF和UDM的注册状态，主备NRF上的注册状态都应该为“REGISTERED”状态。在UDM/AUSF侧的EM上跟踪NRF信令消息，UDM/AUSF和NRF间心跳正常。在NRF上检查主备UDM/AUSF注册状态：在Nnrf_NFManagement_0服务下，执行SHOW ALL NFID命令。 
受理配置检查序号检查项目通过标准备注1WEB受理台登录检查分别登录主用和备用BE所在的WEB受理台，使用预设的受理账户可以成功登录，且受理操作可成功执行。在SDM_CMS_0服务下，执行SHOW UWEBACFG查询WEB受理台配置。WEB受理台登录地址示例：http://[IPV6]:8080/webagent/index32.html#2远端地址PING测试在主用和备用BE局的ROSNG中，执行PING远端地址测试，源地址填写PGW（Provision Gateway，受理网关）的虚地址。远端地址可以从UMCFGITEM配置的Remoteinfo节点中查看，远端地址可包括：BOSS地址，对端MI地址（开启RELAY功能需要测试）PGW虚地址可以从UMCFGITEM配置的LocalInfo节点中查看进入ROSNG：在CommonS_TMSP_0服务下，选择Rosng配置管理→router配置。 
##### 数据规划 
数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
UDM01|UDM02|UDR01|UDR02
---|---|---|---
增加NF标识配置ADD NFCFG|NF标识|91|92|91|92|92|92|92|92|91|91|91|91|111|112|NF的唯一标识
NF名称|增加NF标识配置ADD NFCFG|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B|SC-CD-BS-RP0001B-A-5GC-ZE-UUDR01-B|SC-CD-XX-RP0002B-A-5GC-ZE-UUDR02-B|NF的名称。
NF类型|增加NF标识配置ADD NFCFG|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|本地NF|不同TMSP内的NF|不同TMSP内的NF|NF的类型。包括：self_nf：本地NFsame_tmsp_nf：和本地NF部署在同一TMSP的其他NFdiff_tmsp_nf：和本地NF部署在不同TMSP的其他NF
其他参数|增加NF标识配置ADD NFCFG|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|使用参数默认值
本端网络配置ADD NFNET|ID|91|92|91|92|92|92|92|92|91|91|91|91|111|112|配置记录唯一标识，无实际含义。
IP地址类型|本端网络配置ADD NFNET|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|本端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|本端网络配置ADD NFNET|240E:0180:02E1:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E1:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E2:FF00::0027|240E:0180:02E1:FF00::0027|240E:0180:02E1:FF00::0027|240E:0180:02E1:FF00::0027|240E:0180:02E1:FF00::0027|240E:0180:02E1:FF00::000E|240E:0180:02E2:FF00::000E|本端IP地址，支持IPV4和IPV6。本端IP地址不可同时用于其他用途。
VPNID|本端网络配置ADD NFNET|0|0|0|0|0|0|0|0|0|0|0|0|0|0|VPN ID。在CommonS_TMSP节点下的Rosng配置中，使用“showip vrf detail”命令，获取可用VPN ID（VRF ID）。如果没有Rosng配置，则VPN ID为0。
对端网络配置ADD NFSEED|ID|1|2|3|4|5|6|1|2|3|4|5|6|1|1|配置记录唯一标识。
NF ID|对端网络配置ADD NFSEED|111|111|111|112|112|112|111|111|111|112|112|112|112|111|对端节点归属的NF的唯一标识。
节点类型|对端网络配置ADD NFSEED|CUDR_DMCC|PROV_PDM_SRV_SCCU|PROV_PGW_SCCU|CUDR_DMCC|PROV_PDM_SRV_SCCU|PROV_PGW_SCCU|CUDR_DMCC|PROV_PDM_SRV_SCCU|PROV_PGW_SCCU|CUDR_DMCC|PROV_PDM_SRV_SCCU|PROV_PGW_SCCU|CUDR_DMCC|CUDR_DMCC|对端节点类型。包括CUDR_DMCC：CUDR控制中心PROV_PDM_SRV_SCCU：受理服务SCCUPROV_PGW_SCCU：受理网关SCCU
IP地址类型|对端网络配置ADD NFSEED|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|IPV6|对端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|对端网络配置ADD NFSEED|240E:0180:02E1:FF00::000E|240E:0180:02E1:FF00::000E|240E:0180:02E1:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E1:FF00::000E|240E:0180:02E1:FF00::000E|240E:0180:02E1:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E2:FF00::000E|240E:0180:02E1:FF00::000E|对端IP地址，支持IPV4和IPV6。
IP端口|对端网络配置ADD NFSEED|60001|30001|20001|60001|30001|20001|60001|30001|20001|60001|30001|20001|60001|60001|对端IP监听端口，根据对端节点类型配置，包括：CUDR控制中心：固定配置为60001受理服务SCCU：固定配置为30001受理网关SCCU：固定配置为20001
UDM优先级配置SET UDMNFREGBASE|优先级|0|65535|0|65535|65535|65535|65535|65535|0|0|0|0|-|-|NF优先级，用于指示服务优先级，数值越低优先级越高。
其他参数|UDM优先级配置SET UDMNFREGBASE|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|其他参数保持默认值即可。|-|-
AUSF优先级配置SET AUSFNFREGBASE|优先级|0|65535|0|65535|65535|65535|65535|65535|0|0|0|0|-|-|NF优先级，用于指示服务优先级，数值越低优先级越高。
其他参数|AUSF优先级配置SET AUSFNFREGBASE|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|默认值|其他参数保持默认值即可。|-|-
##### 配置步骤 
UDM01配置
步骤|操作说明|操作
---|---|---
1|NF标识配置：NFID参数配置成局号，NFNAME按照命名规范配置，如：“SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B”。NFTYPE包括：self_nf（本地NF）same_tmsp_nf（和本地NF部署在同一TMSP的其他NF）diff_tmsp_nf（和本地NF部署在不同TMSP的其他NF）|ADD NFCFG:NFID=91,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B",NFTYPE="self_nf"ADD NFCFG:NFID=111,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UUDR01-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=112,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UUDR02-B",NFTYPE="diff_tmsp_nf"
2|本地网络配置，地址IP为UDM和UDR对接的地址。|ADD NFNET:ID=91,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::0027",VPNID=0
3|对端网络配置，配置主备局BE：TYPE为CUDR_DMCC、PROV_PDM_SRV_SCCU、PROV_PGW_SCCU的三条记录。NFID配置为对端局BE的远端局号。参数IP和PORT配置为对端局BE的IP及端口号。|ADD NFSEED:ID=1,NFID=111,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000E",PORT=60001ADD NFSEED:ID=2,NFID=111,TYPE="PROV_PDM_SRV_SCCU",IP="240E:0180:02E1:FF00::000E",PORT=30001ADD NFSEED:ID=3,NFID=111,TYPE="PROV_PGW_SCCU",IP="240E:0180:02E1:FF00::000E",PORT=20001ADD NFSEED:ID=4,NFID=112,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000E",PORT=60001ADD NFSEED:ID=5,NFID=112,TYPE="PROV_PDM_SRV_SCCU",IP="240E:0180:02E2:FF00::000E",PORT=30001ADD NFSEED:ID=6,NFID=112,TYPE="PROV_PGW_SCCU",IP="240E:0180:02E2:FF00::000E",PORT=20001
4|在SDM_CMS_0节点配置主局UDM/AUSF的优先级。|SET UDMNFREGBASE:PRIORITY=0SET AUSFNFREGBASE:PRIORITY=0
5|在网元节点传变化表。|SYNA:STYPE="CHG",INCREF="NO"
6|完成修改后，向NRF网元注册。|NRF REGISTRATION:REG_TYPE="Register",NF_TYPE="AUSF",NF_STATUS="REGISTERED"NRF REGISTRATION:REG_TYPE="Register",NF_TYPE="UDM",NF_STATUS="REGISTERED"
UDM02配置
步骤|操作说明|操作
---|---|---
1|NF标识配置：NFID参数配置成局号，NFNAME按照命名规范配置，如：“SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B”。NFTYPE包括：self_nf（本地NF）same_tmsp_nf（和本地NF部署在同一TMSP的其他NF）diff_tmsp_nf（和本地NF部署在不同TMSP的其他NF）|ADD NFCFG:NFID=92,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B",NFTYPE="self_nf"ADD NFCFG:NFID=111,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UUDR01-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=112,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UUDR02-B",NFTYPE="diff_tmsp_nf"
2|本地网络配置，地址IP为UDM和UDR对接的地址。|ADD NFNET:ID=92,IPTYPE="IPV6",IP="240E:0180:02E2:FF00::0027",VPNID=0
3|对端网络配置，配置主备局BE。TYPE为CUDR_DMCC、PROV_PDM_SRV_SCCU、PROV_PGW_SCCU的三条记录。NFID配置为对端局BE的远端局号。参数IP和PORT配置为对端局BE的IP及端口号。|ADD NFSEED:ID=1,NFID=111,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000E",PORT=60001ADD NFSEED:ID=2,NFID=111,TYPE="PROV_PDM_SRV_SCCU",IP="240E:0180:02E1:FF00::000E",PORT=30001ADD NFSEED:ID=3,NFID=111,TYPE="PROV_PGW_SCCU",IP="240E:0180:02E1:FF00::000E",PORT=20001ADD NFSEED:ID=4,NFID=112,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000E",PORT=60001ADD NFSEED:ID=5,NFID=112,TYPE="PROV_PDM_SRV_SCCU",IP="240E:0180:02E2:FF00::000E",PORT=30001ADD NFSEED:ID=6,NFID=112,TYPE="PROV_PGW_SCCU",IP="240E:0180:02E2:FF00::000E",PORT=20001
4|在SDM_CMS_0节点配置备局UDM/AUSF的优先级。|SET UDMNFREGBASE:PRIORITY=65535SET AUSFNFREGBASE:PRIORITY=65535
5|在网元节点传变化表。|SYNA:STYPE="CHG",INCREF="NO"
6|完成修改后，向NRF网元注册。|NRF REGISTRATION:REG_TYPE="Register",NF_TYPE="AUSF",NF_STATUS="REGISTERED"NRF REGISTRATION:REG_TYPE="Register",NF_TYPE="UDM",NF_STATUS="REGISTERED"
UDR01配置
步骤|操作说明|操作
---|---|---
1|NF标识配置：NFID参数配置成局号，NFNAME按照命名规范配置，如：“SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B”。NFTYPE包括：self_nf（本地NF）same_tmsp_nf（和本地NF部署在同一TMSP的其他NF）diff_tmsp_nf（和本地NF部署在不同TMSP的其他NF）|ADD NFCFG:NFID=111,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UUDR01-B",NFTYPE="self_nf"ADD NFCFG:NFID=91,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=92,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=112,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UUDR02-B",NFTYPE="diff_tmsp_nf"
2|本地网络配置，地址IP为UDR01和UDM对接的地址。|ADD NFNET:ID=111,IPTYPE="IPV6",IP="240E:0180:02E1:FF00::000E",VPNID=0
3|对端网络配置，配置UDR02的对接参数。|ADD NFSEED:ID=1,NFID=112,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP=240E:0180:02E2:FF00::000E,PORT=60001
UDR02配置
步骤|操作说明|操作
---|---|---
1|NF标识配置：NFID参数配置成局号，NFNAME按照命名规范配置，如：“SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B”。NFTYPE包括：self_nf（本地NF）same_tmsp_nf（和本地NF部署在同一TMSP的其他NF）diff_tmsp_nf（和本地NF部署在不同TMSP的其他NF）|ADD NFCFG:NFID=112,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UUDR02-B",NFTYPE="self_nf"ADD NFCFG:NFID=91,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UDM01-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=92,NFNAME="SC-CD-XX-RP0002B-A-5GC-ZE-UDM02-B",NFTYPE="diff_tmsp_nf"ADD NFCFG:NFID=111,NFNAME="SC-CD-BS-RP0001B-A-5GC-ZE-UUDR01-B",NFTYPE="diff_tmsp_nf"
2|本地网络配置，地址IP为UDR02和UDM对接的地址。|ADD NFNET:ID=112,IPTYPE="IPV6",IP="240E:0180:02E2:FF00::000E",VPNID=0
3|对端网络配置，配置UDR02的对接参数。|ADD NFSEED:ID=1,NFID=111,TYPE="CUDR_DMCC",IPTYPE="IPV6",IP=240E:0180:02E1:FF00::000E,PORT=60001
周边网元配置
不涉及周边网元的配置。 
##### 指标监控 
性能统计
UDM容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|EPC HSS:S6a/S6d接口ULR业务|以40701开头的所有计数器
2|EPC HSS:S6a/S6d接口CLR业务|以40702开头的所有计数器
3|EPC HSS:S6a/S6d接口IDR业务|以40704开头的所有计数器
4|EPC HSS:S6a/S6d接口DSR业务|以40705开头的所有计数器
5|EPC HSS:S6a/S6d接口AIR业务|以40706开头的所有计数器
6|EPC HSS:S6a/S6d接口NOR业务|以40708开头的所有计数器
7|EPC HSS:SLh接口RIR业务|以50008开头的所有计数器
8|IMS HSS:Cx接口SAR业务|以40441开头的所有计数器
9|IMS HSS:Cx接口UAR业务|以40442开头的所有计数器
10|IMS HSS:Cx接口LIR业务|以40443开头的所有计数器
11|IMS HSS:Cx接口PPR/RTR业务|以40444开头的所有计数器
12|IMS HSS:Cx接口MAR业务|以40445开头的所有计数器
13|IMS HSS:Sh接口UDR业务|以40454开头的所有计数器
14|IMS HSS:Sh接口PUR业务|以40452开头的所有计数器
15|IMS HSS:Sh接口SNR/PNR业务|以40453开头的所有计数器
16|WCDMA: 业务失败率统计|以40581开头的所有计数器
17|SPR:SP接口业务|以40752开头的所有计数器
18|SPR:SP'接口业务|以40753开头的所有计数器
19|UDM用户鉴权服务测量|以53016开头的所有计数器
21|UDM数据管理服务测量|以53012开头的所有计数器
22|UDM上下文管理服务测量|以53010开头的所有计数器
23|UDM事件开放服务测量|以53014开头的所有计数器
24|WCDMA: WCN业务受理|以40489开头的所有计数器
25|IMS HSS:HSS业务受理|以40484开头的所有计数器
26|WCDMA:WCDMA过负荷性能统计|以40431开头的所有计数器
27|EPC HSS:EPC过负荷统计信息|以51001开头的所有计数器
28|IMS HSS:HSS过负荷统计|以40754开头的所有计数器
29|AUSF鉴权服务消息成功率（%）|cn.uspp.52502（PI）
30|UDM用户鉴权服务消息成功率（%）|cn.uspp.53016（PI）
31|UDM数据管理服务消息成功率（%）|cn.uspp.53012（PI）
32|UDM上下文管理服务消息成功率（%）|cn.uspp.53010（PI）
33|UDIWF服务消息成功率（%）|cn.uspp.52504（PI）
告警与通知
UDM容灾需要监控的告警与通知参见下表。 
编号|告警名称
---|---
1|3356098565 对端网元无响应次数超出阀值
2|3356098566 NRF节点不可达
3|3356098569 网元注册信息配置错误
4|3356098570 网元实例注册配置错误
5|3356114945 邻接NF通讯中断
6|3456237573 网卡端口down检测告警
##### 常见问题处理 
故障现象
两套UDR主备同步不成功，都为主用状态。 
故障分析
备用UDR实例化时UDR Site
No.设置不正确，主备UDR均设置为1。应该主用局设置为1、备用局设置为2。 
处理方法
重新实例化UDR，确保参数填写正确。 
### BSF 
#### BSF容灾 


##### 容灾组网 
在5GC网络中，一般使用双DC容灾方式，BSF部署在不同机房，异地容灾，两个BSF为互备方式负荷分担，如[图1](28.html#T_1604980389619__c81e0f3f-f8a0-458e-a6cd-5286199d1489)所示。单DC中如果网元自身或者周边网元发生故障，通过备份路由方式保证现网业务正常。
图1  BSF双DC容灾组网


[]images/BSF%E5%8F%8CDC.png)



##### 容灾原理 
BSF支持1+1互备容灾。正常情况下，互为备份的两个BSF将BSF服务注册到NRF，PCF到NRF完成服务发现后，会将BSF接口消息负荷分担发到两个BSF。当其中一个BSF故障宕机时，PCF根据NRF的服务通知，将消息发送给另一个BSF进行处理。 
对于Diameter Rx接口的路由，DRA按照负荷分担方式选择BSF。当DRA检测到与一个BSF之间的路由不可用时，将选择另一个BSF进行信令消息转发。 
互为备份的BSF支持会话绑定数据实时自动同步，接收到绑定数据信息的BSF在完成本设备数据更新后，主动将更新数据同步到另一个BSF，确保两个BSF的数据完全一致。 


##### 部署要求 
一对BSF到NRF注册，采用互备模式，注册相同的NF优先级。 
DRA选择到一对BSF的Diameter路由时，按照负荷分担方式进行路由。 


##### 容灾业务流程 
PCF选择BSF的容灾流程
正常情况下，用户数据会话从SA或NSA接入后，SAE GW-C/SMF会向PCF上报用户数据会话建立消息，请求PCC策略，同时PCF会将用户的IP地址和PCF的IP地址注册给BSF。 
PCF选择BSF的容灾流程如[图2](28.html#T_1604980389619__fbeb4d89-73f3-49a1-bc50-4b233ab9c528)所示。
图2  PCF选择BSF的容灾流程


[]images/PCF%E9%80%89%E6%8B%A9BSF%E7%9A%84%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)

具体流程如下： 


用户发起PDU会话建立请求，AMF向SMF发送请求消息，调用会话建立请求服务。 


SMF建立用户数据PDU会话资源，向PCF报告用户会话建立，获取PCC策略。 


PCF通过NRF服务发现，根据用户IP地址获取对应的BSF。向BSF1发送用户会话注册消息，携带用户IP地址和PCF
IP地址。 
BSF1保存用户会话绑定数据并同步至BSF2。PCF同时向NRF订阅BSF状态。SMF成功建立PDU会话。 


若BSF1发生故障，PCF通过NRF的网元状态通知，识别到BSF1故障。 


用户的PDU数据会话发起释放请求，AMF调用SMF的PDU会话释放服务。 


SMF为该用户会话进行资源释放，并通知PCF用户会话释放，删除该会话的PCC策略管理关联。 


PCF向BSF2发送消息，删除用户会话的IP地址和PCF地址的注册。 


另一个用户从NSA接入，MME发送创建默认承载请求给SAE GW-C/SMF。 


SAE-GW/SMF为用户默认承载分配资源，并报告PCF用户数据会话建立，获取PCC策略。 


PCF通知BSF2，用户的数据会话建立，携带用户的IP地址和PCF IP地址信息。 


若BSF1恢复正常，NRF会通知PCF。后续的用户PDU会话建立请求以及PDN连接建立请求，PCF可以再次选择BSF1，为用户会话和PCF的绑定关系进行注册。 
DRA Rx接口选择BSF容灾流程
用户被叫语音业务时，IMS网络需通过BSF将用户语音业务的媒体流建立消息转发给PCF。若BSF故障，由DRA选择另一个BSF，转发IMS网络的语音媒体流建立消息给PCF。 
DRA Rx接口选择BSF容灾的流程如[图3](28.html#T_1604980389619__d148eed0-2c93-47b6-9512-cee441a5c8f0)所示。
图3  DRA Rx接口选择BSF容灾流程


[]images/DRA%20Rx%E6%8E%A5%E5%8F%A3%E9%80%89%E6%8B%A9BSF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)

具体流程如下： 


用户1发起语音业务，S-CSCF建立语音链路，并协商语音媒体流参数。S-CSCF要求P-CSCF为用户1语音媒体流建立专用承载。 


P-CSCF通过Rx消息，触发到PCF的专有承载建立消息。P-CSCF转发该承载建立消息给DRA。 


DRA根据消息中携带的用户的IP地址信息，根据IP地址段配置按照负荷分担方式转发该消息到BSF1。 


BSF1查找用户1的会话绑定信息，获取PCF地址信息。BSF1转发该承载建立的Diameter消息给PCF。 


PCF完成用户1语音媒体流的QoS flow建立后，发送应答给BSF1。 


BSF1转发响应消息给DRA。 


DRA转发响应消息给P-CSCF。P-CSCF向S-CSCF返回语音流协商响应。 


若BSF1发生故障，DRA通过Diameter链路检测消息发现BSF1故障，DRA后续将选择BSF2进行路由。 


用户1再次发起语音业务，S-CSCF触发P-CSCF为用户1语音媒体流建立承载。 


P-CSCF发送专用承载建立消息给DRA。 


DRA转发语音业务流承载建立消息给BSF2。 


BSF2转发语音业务流承载建立消息给用户会话所在的PCF。 


PCF成功完成语音业务流对应的专用承载建立。PCF发送媒体流建立成功响应消息给BSF2。 


BSF2转发响应消息给DRA。 


DRA转发响应消息到P-CSCF。P-CSCF向S-CSCF返回语音流协商响应。 


若BSF1恢复正常，DRA会通过Diameter链路保活消息，检测到BSF1正常。后续的用户语音承载建立或修改请求，DRA可以再次转发给BSF1。 


#### BSF容灾配置 


##### 配置前提 

 
BSF到PCF
BSF到PCF路由选路（如图1所示）：第一路由：用户会话记录所在的PCF。第二路由：异机房BSF的路由选择。第三路由：容灾PCF。图1  BSF到PCF的路由


配置准则：BSF配置三个对等端组，分别为PCF01、PCF02和异机房BSF，每个对等端组内仅包含对应的对等端设备。分别配置到PCF01和到PCF02的路由出口，路由出口优选对应设备的对等端组，备选异机房BSF对等端组和容灾PCF对等端组不同PCF的目的主机名路由，选择对应的PCF路由出口。
 

 
BSF到DRA
BSF到DRA路由选路（如图2所示）：第一路由：同机房BSF到DRA的路由选路。第二路由：异机房BSF的路由选路。第三路由：异机房BSF到DRA的路由选路。图2  BSF到DRA的路由


配置准则：BSF配置三个对等端组，分别为DRA01、DRA02和异机房BSF，每个对等端组内仅包含对应的对等端设备。BSF到DRA的路由出口，优选同机房的DRA对等端组，备选异机房BSF对等端组和异机房DRA对等端组。Rx接口（如图3所示）中，SBC的目的主机名路由的下一跳路由策略引用BSF到DRA的路由出口。图3  Rx接口消息路径


 

 


##### 数据规划 
BSF配置数据规划
配置命令|参数名称|参数取值|说明
---|---|---|---
BSF01|BSF02
---|---
新增对等端组配置ADD DPGROUP|标识|BSF02  ID：100PCF01 ID：101PCF02 ID：102DRA01 ID：103DRA02 ID：104|BSF01  ID：100PCF01 ID：101PCF02 ID：102DRA01 ID：103DRA02 ID：104|对等端组配置的唯一标识。
新增对等端组配置ADD DPGROUP|对等端设备参数|BSF02：100-1PCF01：101-1PCF02：102-1DRA01：103-1DRA02：104-1|BSF01：100-1PCF01：101-1PCF02：102-1DRA01：103-1DRA02：104-1|该项由对等端设备和对等端设备权重组成对等端设备：表示本对等端组内的对等端实体的标识，已配置的对等端ID可通过命令SHOW DPEER查询。一个对等端组最大支持16个对等端。 对等端实体必须属于分权分域配置中分配给用户角色的地域。对等端设备权重：表示对等端实体在该对等端组中所占权重的百分比。在路由选择对等端的时候，是根据对等端实体在对等端组中的权重选择的，例如，如果对等端组中有3个对等端P1，P2，P3，所占的权重分别为N1，N2，N3，那么在该对等端组中选择P1的权重为N1/(N1+N2+N3)
新增对等端组配置ADD DPGROUP|组名称|BSF02PCF01PCF02DRA01DRA02|BSF01PCF01PCF02DRA01DRA02|表示该对等端组配置项的名称，名称应该便于理解和记忆，无特殊字符限制
新增路由出口配置ADD DRTOUT|查询索引号|TO_PCF01：101TO_PCF02：102TO_SBC:103|TO_PCF01：101TO_PCF02：102TO_SBC:104|用于描述对应路由的查询索引号，限定本表数据的查询范围。索引号用于唯一匹配路由过程中前一操作的“下一路由索引号”，“查询索引号”和“路由出口”的组合一条路由出口配置信息数据记录，查询索引号不能重复。在进行数据匹配时，系统将会根据查询索引号的数据进行匹配。
新增路由出口配置ADD DRTOUT|优选Diameter对等端组ID|TO_PCF01：101TO_PCF02：102TO_SBC:103|TO_PCF01：101TO_PCF02：102TO_SBC:104|优选对等端组ID，需要取值为对等端组ID，对等端组可以通过ADD DPGROUP进行增加。优选对等端组为匹配到本条配置，优先选择的路由出口。优选对等端组必须属于分权分域配置中分配给用户角色的地域。
新增路由出口配置ADD DRTOUT|备份Diameter对等端组ID|TO_PCF01：100&102TO_PCF02：100&101TO_SBC:100&104|TO_PCF01：100&102TO_PCF02：100&101TO_SBC:100&103|备份对等端组ID，包括第一备份对等端组ID、第二备份对等端组ID、第三备份对等端组ID（优先级从高到低），各个备份对等端组ID的取值为对等端组ID，对等端组可以通过ADDDPGROUP进行增加备份对等端组必须属于分权分域配置中分配给用户角色的地域。
新增目的主机名路由配置ADD DRTDHOST|查询索引号|TO_PCF01：30006TO_PCF02：30006TO_SBC:30006|TO_PCF01：30006TO_PCF02：30006TO_SBC:30006|用于描述对应路由的查询索引号，限定本表数据的查询范围。 查询索引号用于唯一匹配路由过程中前一操作的“下一个路由索引号”，“查询索引号”和“目的主机名”的组合唯一标识一条目的主机路由配置信息数据记录，其组合不能重复。查询索引号可相同，在进行数据匹配时，系统将会对查询索引号相同的数据进行匹配。
新增目的主机名路由配置ADD DRTDHOST|目的主机名|PCF01：pcf01.epc.mnc011.mcc460.3gppnetwork.orgPCF02：pcf02.epc.mnc011.mcc460.3gppnetwork.orgSBC：psbc.epc.mnc011.mcc460.3gppnetwork.org|PCF01：pcf01.epc.mnc011.mcc460.3gppnetwork.orgPCF02：pcf02.epc.mnc011.mcc460.3gppnetwork.orgSBC：psbc.epc.mnc011.mcc460.3gppnetwork.org|用于进行路由条件匹配的Diameter消息中的目的主机名。该字段必须满足如下规则：所有字符只能是数字(0～9)、字母(a～z或A～Z)、“.”或“-”、通配符“*”。首字符必须是数字(0～9)或字母(a～z或A～Z)。任意两个“.”或“-”不允许相邻。最后一个字符不允许是“-”。如果有通配符“*”，必须在最后一位。用于进行路由条件匹配的HTTP消息的URL中的Authority部分。在DSC系统中，该参数统一转换为小写形式存储在配置数据库。需要指出的是，目的主机名的查询是按照从后向前按节点的最大匹配原则查询，数据规划时需重点关注。目的主机名的查询按照从后向前按节点的最大匹配原则查询不到，将匹配有通配符配置记录。其中，“ztedefault”为通配符，表示所有的目的主机名。如果系统有多条目的主机路由配置信息数据的“目的主机名”参数能够匹配Diameter消息中的目的主机名，则通配符的优先级最低，即系统优先对其它目的主机名进行匹配。“5gdefault”为5G通配符，表示所有的目的主机名。如果系统有多条目的主机路由配置信息数据的“目的主机名”参数能够匹配HTTP消息的URL中的Authority部分，则通配符的优先级最低，即系统优先对其它目的主机名进行匹配。
新增目的主机名路由配置ADD DRTDHOST|下一个路由规则|TO_PCF01：OUTTO_PCF02：OUTTO_SBC:OUT|TO_PCF01：OUTTO_PCF02：OUTTO_SBC:OUT|下一个路由规则，用于描述路由查询的下一规则，下一步路由查询时根据该字段配置内容查询对应的路由表。取值范围：“APN/DNN(APN)”：在APN/DNN路由配置中查找。“源主机名(OHOST)”：在源主机名路由配置中查找。“源域名(OREALM)”：在源域名路由配置中查找。“消息类型(CMD)”：在消息类型路由配置中查找。“IMSI/NAI(IMSI)”：在IMSI/NAI路由配置中查找。“ISDN/EXTID(ISDN)”：在ISDN/EXTID路由配置中查找。“PVI(PVI)”：在PVI路由配置中查找。“PUI(PUI)”：在PUI路由配置中查找。“IP-Domain-ID(IP_DOMAIN_ID)”：在IP-Domain-ID路由配置中查找。“IP(IP)”：在IP路由配置中查找。“AVP/ANY(AVP)”：在AVP/ANY路由配置中查找。“路由出口(OUT)”：在路由出口配置中查找。
新增目的主机名路由配置ADD DRTDHOST|下一个路由索引号|TO_PCF01：101TO_PCF02：102TO_SBC:103|TO_PCF01：101TO_PCF02：102TO_SBC:104|用于指定下一路由规则的查询范围，下一步路由查询时只能在该索引号的范围内查询。在下一个路由索引所标识的下一个路由规则中，必须包含属于分权分域配置中分配给用户角色的地域中的规则。
BSF间数据同步配置数据规划
每个BSF配置四条RGW链路，具体规划参见下表。
配置命令|参数名称|参数取值|说明
---|---|---|---
BSF01|BSF02
---|---
新增复制网关配置ADD DRGW|链路标识|链路1：1001链路2：1002链路3：1003链路4：1004|链路1：1001链路2：1002链路3：1003链路4：1004|该参数用于唯一标识一个复制网关链路。当协议类型为"SCTP"时，此标识的值不能与其他协议类型所使用的SCTP承载标识相同。
新增复制网关配置ADD DRGW|对端局号|152|151|标识本条复制网关链路配置所指向的对端局号。
新增复制网关配置ADD DRGW|本端角色|链路1：CLIENT链路2：SERVER链路3：CLIENT链路4：SERVER|链路1：CLIENT链路2：SERVER链路3：CLIENT链路4：SERVER|配置本端所属角色，规定本端属于服务端或是客户端。
新增复制网关配置ADD DRGW|归属模块号|链路1：101链路2：101链路3：102链路4：102|链路1：101链路2：101链路3：102链路4：102|表示该复制网关链路所属的信令处理模块。该模块必须是在ADD MODULE中已经配置的模块，且模块类型包含RGW。
新增复制网关配置ADD DRGW|本端IP|链路1："IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239"链路2："IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238"链路3："IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239"链路4："IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238"|链路1："IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239"链路2："IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238"链路3："IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239"链路4："IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238"|“本端IP”是指要配置SCTP/TCP绑定的源IP地址，本参数是个复合参数。 该参数如果是IPV4类型必须与ADDIP ADDRESS命令配置中的保持一致。如果是IPV6类型必须与ADD IPV6 ADDRESS命令配置中的保持一致。如果协议类型为"TCP",则IP地址个数配置为1，若协议类型为"SCTP",则IP地址个数可以配置一个也可以配置多个，最多可配置4个。
新增复制网关配置ADD DRGW|本端端口号|链路1：1001链路2：1002链路3：1003链路4：1004|链路1：1001链路2：1002链路3：1003链路4：1004|本局与对端信令设备的对接参数之一，用于指定本局与对端局的承载链路所使用的本端端口号。协议类型为"SCTP"时，由多个IP地址和此端口组成一条偶联实现多址传输功能。协议类型为"TCP"时，由一个IP地址和此端口组成一条TCP连接实现传输功能 。
新增复制网关配置ADD DRGW|对端IP|链路1："IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239"链路2："IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238"链路3："IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239"链路4："IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238"|链路1："IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239"链路2："IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238"链路3："IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239"链路4："IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238"|“对端IP”是指要配置SCTP/TCP绑定的目的IP地址，本参数是个复合参数。该IP地址需要对端设备提供。 该参数如果是IPV4类型必须与ADDIP ADDRESS命令配置中的保持一致。如果是IPV6类型必须与ADD IPV6 ADDRESS命令配置中的保持一致。如果协议类型为"TCP",则IP地址个数配置为1，若协议类型为"SCTP",则IP地址个数可以配置一个也可以配置多个，最多可配置4个。
新增复制网关配置ADD DRGW|对端端口号|链路1：1001链路2：1002链路3：1003链路4：1004|链路1：1001链路2：1002链路3：1003链路4：1004|本局与对端信令设备的对接参数之一，用于指定本局与对端局的承载链路所使用的对端端口号。


##### 配置步骤 
BSF01配置
步骤|操作说明|操作
---|---|---
1|增加对等端组配置|ADD DPGROUP:ID=100,PEER=100-1,NAME="BSF02";ADD DPGROUP:ID=101,PEER=101-1,NAME="PCF01";ADD DPGROUP:ID=102,PEER=102-1,NAME="PCF02";ADD DPGROUP:ID=103,PEER=103-1,NAME="DRA01";ADD DPGROUP:ID=104,PEER=104-1,NAME="DRA02";
2|增加路由出口配置|ADD DRTOUT:REFINDEX=101,PGROUPID=101,BAKPGROUPID=100&102,DESC="PCF01";ADD DRTOUT:REFINDEX=102,PGROUPID=102,BAKPGROUPID=100&101,DESC="PCF02";ADD DRTOUT:REFINDEX=103,PGROUPID=103,BAKPGROUPID=100&104,DESC="TO_SBC";
3|增加目的主机名路由配置|ADD DRTDHOST:REFINDEX=30006,DHOST="pcf01.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=101,DESC="PCF01";ADD DRTDHOST:REFINDEX=30006,DHOST="pcf02.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=102,DESC="PCF02";ADD DRTDHOST:REFINDEX=30006,DHOST="psbc.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=103,DESC="TO_SBC";
4|新增复制网关配置|ADD DRGW:ID=1001,BNO=151,ROLE="CLIENT",MODULE=101,LOCADDR="IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239",LOCPORT=1001,REMADDR="IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239",REMPORT=1001,NAME="session-to-bsf02-01",DESC="session-to-bsf01-01";ADD DRGW:ID=1002,BNO=151,ROLE="SERVER",MODULE=101,LOCADDR="IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238",LOCPORT=1002,REMADDR="IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238",REMPORT=1002,NAME="session-to-bsf02-02",DESC="session-to-bsf01-02";ADD DRGW:ID=1003,BNO=151,ROLE="CLIENT",MODULE=102,LOCADDR="IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239",LOCPORT=1003,REMADDR="IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239",REMPORT=1003,NAME="session-to-bsf02-03",DESC="session-to-bsf01-03";ADD DRGW:ID=1004,BNO=151,ROLE="SERVER",MODULE=102,LOCADDR="IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238",LOCPORT=1004,REMADDR="IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238",REMPORT=1004,NAME="session-to-bsf02-04",DESC="session-to-bsf01-04";
BSF02配置
步骤|操作说明|操作
---|---|---
1|增加对等端组配置|ADD DPGROUP:ID=100,PEER=100-1,NAME="BSF01";ADD DPGROUP:ID=101,PEER=101-1,NAME="PCF01";ADD DPGROUP:ID=102,PEER=102-1,NAME="PCF02";ADD DPGROUP:ID=103,PEER=103-1,NAME="DRA01";ADD DPGROUP:ID=104,PEER=104-1,NAME="DRA02";
2|增加路由出口配置|ADD DRTOUT:REFINDEX=101,PGROUPID=101,BAKPGROUPID=100&102,DESC="PCF01";ADD DRTOUT:REFINDEX=102,PGROUPID=102,BAKPGROUPID=100&101,DESC="PCF02";ADD DRTOUT:REFINDEX=103,PGROUPID=104,BAKPGROUPID=100&103,DESC="TO_SBC";
3|增加目的主机名路由配置|ADD DRTDHOST:REFINDEX=30006,DHOST="pcf01.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=101,DESC="PCF01";ADD DRTDHOST:REFINDEX=30006,DHOST="pcf02.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=102,DESC="PCF02";ADD DRTDHOST:REFINDEX=30006,DHOST="psbc.epc.mnc011.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=103,DESC="TO_SBC";
4|新增复制网关配置|ADD DRGW:ID=1001,BNO=151,ROLE="CLIENT",MODULE=101,LOCADDR="IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239",LOCPORT=1001,REMADDR="IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239",REMPORT=1001,NAME="session-to-bsf01-01",DESC="session-to-bsf01-01";ADD DRGW:ID=1002,BNO=151,ROLE="SERVER",MODULE=101,LOCADDR="IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238",LOCPORT=1002,REMADDR="IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238",REMPORT=1002,NAME="session-to-bsf01-02",DESC="session-to-bsf01-02";ADD DRGW:ID=1003,BNO=151,ROLE="CLIENT",MODULE=102,LOCADDR="IPV4"-12-"183.22.36.238"&"IPV4"-12-"183.22.36.239",LOCPORT=1003,REMADDR="IPV4"-12-"183.22.4.238"&"IPV4"-12-"183.22.4.239",REMPORT=1003,NAME="session-to-bsf01-03",DESC="session-to-bsf01-03";ADD DRGW:ID=1004,BNO=151,ROLE="SERVER",MODULE=102,LOCADDR="IPV4"-12-"183.22.36.239"&"IPV4"-12-"183.22.36.238",LOCPORT=1004,REMADDR="IPV4"-12-"183.22.4.239"&"IPV4"-12-"183.22.4.238",REMPORT=1004,NAME="session-to-bsf01-04",DESC="session-to-bsf01-04";


##### 指标监控 
性能统计
不涉及性能统计数据的监控。 
告警与通知
不涉及告警与通知的监控。 


### NSSF 
#### NSSF容灾 
##### 容灾组网 
NSSF容灾组网如[图1](29.html#T_1604980389619__36696ba1-6086-457c-9b60-ee5850d33f51)所示，一对NSSF分别部署在两个DC中，在AMF上静态配置NSSF的主备连接关系。
图1  NSSF容灾组网图
[]images/NSSF%E5%AE%B9%E7%81%BE%E7%BB%84%E7%BD%91.png)
##### 容灾原理 
NSSF支持1+1主备容灾方案，正常情况下，所有话务由主用NSSF承担，NSSF内部业务处理虚机为N+1负荷分担模式。主备NSSF间有数据同步机制和心跳检测机制保障。 
主用NSSF故障宕机时，主备NSSF之间通过心跳检测机制，备用NSSF被激活，提供切片查询服务。AMF根据业务消息判断机制，配置主用和备用地址，当NSSF发生切换时，AMF将业务消息发送至备用NSSF进行处理。 
##### 部署要求 
配置NSSF容灾之前，需要在主备局UDR配置中确认：
主备局的集群号DsaID一致。 
节点号DsaNodeId不同。 
在NSSF网元的Ncudr_SystemManagement_0模式下，使用[SHOW DSANODE
STATUS](None)命令分别查看主备NSSF的集群ID和节点ID是否满足要求。
##### 容灾业务流程 
如[图2](29.html#T_1604980389619__d5dd37b4-14d6-40a8-9f9d-a2e4b18ef4b7)所示，以SA接入为例，AMF为用户注册流程，提供切片授权功能。AMF从UDM获取用户的切片签约信息，并根据UE请求的切片信息，到NSSF查询用户本网络可以使用的切片信息集。AMF通过注册接收消息，将用户允许使用的切片信息集下发给UE。
图2  NSSF容灾流程图
[]images/NSSF%E5%AE%B9%E7%81%BE%E6%B5%81%E7%A8%8B.png)
具体流程描述如下： 
用户UE1发起初始化注册请求，NR转发用户的请求到已注册的AMF1。 
AMF1根据用户初始化注册请求信息，向NSSF查询用户的切片信息，是否符合网络接入要求。 
NSSF返回用户允许使用的切片信息。 
AMF1返回初始化注册接受类型消息。 
UE1发起PDU会话建立请求类型消息。
AMF1调用SMF的PDU会话建立服务，为用户建立PDU会话。 
SMF从UDM获取用户会话签约信息，并注册会话连接信息。
SMF选择PCF，为用户建立PDU会话资源。
SMF发送用户UE1的PDU会话建立响应给AMF1，AMF1通知空口与UE，建立PDU会话资源。 
AMF1通过业务消息检测到NSSF故障，AMF使用备用NSSF。 
用户UE2发起初始化注册请求，NR转发用户的请求到已注册的AMF1。 
AMF1根据用户初始化注册请求信息，向备用NSSF查询用户的切片信息，是否符合网络接入要求。 
备用NSSF返回用户允许的切片信息。 
AMF1返回初始化注册接受类型消息。 
UE2发起PDU会话建立请求类型消息。 
AMF1调用SMF的PDU会话建立服务，为用户UE2建立PDU会话。 
SMF从UDM获取用户会话签约信息，并注册会话连接信息。 
SMF选择PCF，为用户建立PDU会话资源。 
SMF发送用户UE2的PDU会话建立响应给AMF1，AMF1通知空口与UE，建立PDU会话资源。 
#### NSSF容灾配置 
##### 配置前提 
已完成网元的基本数据配置。 
##### 数据规划 
数据规划参见下表。 
配置命令|参数名称|参数取值|说明
---|---|---|---
主用NSSF|备用NSSF
---|---
增加NF标识配置ADD NFCFG|NF标识|131|132|NF的唯一标识。
NF名称|增加NF标识配置ADD NFCFG|NSSF131|NSSF132|NF的名称。
NF类型|增加NF标识配置ADD NFCFG|本局：self_nf对端局：diff_vnfp_nf|本局：self_nf对端局：diff_vnfp_nf|NF的类型。包括：self_nf：本地NFsame_tmsp_nf：和本地NF部署在同一TMSP的其他NFdiff_tmsp_nf：和本地NF部署在不同TMSP的其他NF
增加本地网络配置ADD NFNET|ID|131|132|配置记录唯一标识，无实际含义。
IP地址类型|增加本地网络配置ADD NFNET|ip_v6|ip_v6|本端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加本地网络配置ADD NFNET|2409:8027:5003:1113::214:1002|2409:802F:5003:1115::1105:2002|本端IP地址，支持IPV4和IPV6。本端IP地址不可同时用于其他用途。
VPNID|增加本地网络配置ADD NFNET|15|15|VPN ID。
增加对端网络配置ADD NFSEED|ID|1|1|配置记录唯一标识。
NF ID|增加对端网络配置ADD NFSEED|132|131|对端节点归属的NF的唯一标识。
节点类型|增加对端网络配置ADD NFSEED|CUDR_DMCC|CUDR_DMCC|对端节点类型。包括CUDR_DMCC：CUDR控制中心PROV_PDM_SRV_SCCU：受理服务SCCUPROV_PGW_SCCU：受理网关SCCU
IP地址类型|增加对端网络配置ADD NFSEED|ip_v6|ip_v6|对端IP地址类型，支持IPV4和IPV6，必须和参数IP的实际类型相匹配。
IP地址|增加对端网络配置ADD NFSEED|2409:802F:5003:1115::1105:2002|2409:8027:5003:1113::214:1002|对端IP地址，支持IPV4和IPV6。
IP端口|增加对端网络配置ADD NFSEED|60001|60001|对端IP监听端口，根据对端节点类型配置，包括：CUDR控制中心：固定配置为60001受理服务SCCU：固定配置为30001受理网关SCCU：固定配置为20001
增加容灾NSSF配置ADD BACKUPNSSF（仅在备用NSSF配置）|IP地址|NA|2409:8027:5003:1113::214:1002|主用NSSF的HTTP地址
端口号|增加容灾NSSF配置ADD BACKUPNSSF（仅在备用NSSF配置）|NA|8080|主用NSSF的HTTP端口号
IP地址类型|增加容灾NSSF配置ADD BACKUPNSSF（仅在备用NSSF配置）|NA|IPV6|主用NSSF的HTTP地址类型
HTTP模板号|增加容灾NSSF配置ADD BACKUPNSSF（仅在备用NSSF配置）|NA|1|主用NSSF的关联的IHTTP模板号，请先在HTTP配置管理中添加客户端模版。配置方法：HTTP配置管理-HTTP模版配置-客户端模版配置。
修改通用开关配置SET SWITCHCONFIG（仅在备用NSSF配置）|开关参数名称|NA|mainStandbyFlag|每个全局配置的参数名,都有指定的含义，业务需支持开发实现。
开关参数值|修改通用开关配置SET SWITCHCONFIG（仅在备用NSSF配置）|NA|1|全局配置的开关参数值。
##### 配置步骤 
主用NSSF配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NFCFG:NFID=131,NFNAME="NSSF131",NFTYPE="self_nf"ADD NFCFG:NFID=132,NFNAME="NSSF132",NFTYPE="diff_vnfp_nf"
2|增加本地网络配置|ADD NFNET:ID=131,IPTYPE="ip_v6",IP="2409:8027:5003:1113::214:1002",VPNID=15
3|增加对端网络配置|ADD NFSEED:ID=1,NFID=132,TYPE="CUDR_DMCC",IPTYPE="ip_v6",IP="2409:802F:5003:1115::1105:2002",PORT=6000
备用NSSF配置
步骤|操作说明|操作
---|---|---
1|增加NF标识配置|ADD NF:NFID=132,NFNAME="NSSF132",NFTYPE="self_nf"ADD NF:NFID=131,NFNAME="NSSF131",NFTYPE="diff_vnfp_nf"
2|增加本地网络配置|ADD NFNET:ID=132,IPTYPE="ip_v6",IP="2409:802F:5003:1115::1105:2002",VPNID=15
3|增加对端网络配置|ADD NFSEED:ID=1,NFID=131,TYPE="CUDR_DMCC",IPTYPE="ip_v6",IP="2409:8027:5003:1113::214:1002",PORT=60001
4|增加容灾NSSF配置|ADD BACKUPNSSF:IP="2409:8027:5003:1115::214:1001",PORT=8080,IPTYPE="IPV6",HTTPMOULD=1
5|修改通用开关配置|SET SWITCHCONFIG:PARANAME="mainStandbyFlag",PARAVALUE="1"
##### 指标监控 
性能统计
NSSF容灾需要监控的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|Nnssf_NSSelection接口|C545020001 接收Nnssf_NSSelection_Get请求次数
2|C545020002 发送Nnssf_NSSelection_Get响应次数|Nnssf_NSSelection接口
告警与通知
NSSF容灾涉及的告警与通知参见下表。 
序号|告警名称
---|---
1|3423600649 NSSAI Availability服务QPS超过告警门限
2|3423600640 NSSAI NSSelection服务QPS超过告警门限
# 缩略语 
# 缩略语 
## 5G-GUTI 
5G Globally Unique Temporary Identity5G全球唯一临时标识
## AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
## AMF 
Access and Mobility Management Function接入和移动管理功能
## AUSF 
Authentication Server Function鉴权服务器功能
## BE 
Back End后端/后台
## BOSS 
Business and Operation Support System运营和运维支撑系统
## BSF 
Binding Support Function绑定支持功能
## CDU 
Cloud Database Unit云数据库单元
## CE 
Carrier Ethernet电信级（运营级）以太网
## CG 
Charging Gateway计费网关
## CGW 
CDB GatewayCDB接入网关
## CHF 
Charging Function计费功能
## CMP 
Calling Main Processor主呼叫处理模块
## DB 
Database数据库
## DC 
Data Center数据中心
## DDB 
DSC DatabaseDSC数据库模块
## DNN 
Data Network Name数据网名称
## DSA 
Directory Service Agent目录服务代理
## EM 
Element Management网元管理
## FE 
Front End前端/前台
## FQDN 
Fully Qualified Domain Name完全限定域名
## GPSI 
Generic Public Subscription Identifier一般公共用户标识
## GSU 
General Service Unit通用业务单元
## GT 
Global Title全局名
## GTP 
GPRS Tunneling ProtocolGPRS隧道协议
## GUAMI 
Globally Unique AMF ID全球唯一AMF标识
## GUTI 
Globally Unique Temporary Identity全球唯一临时标识
## GW 
GateWay网关
## HTTP 
Hypertext Transfer Protocol超文本传输协议
## IP 
Internet Protocol因特网协议
## IPU 
Interface Process Unit接口处理单元
## LB 
Load Balance负载均衡
## LDB 
Local Database本地数据库
## LSU 
Log Storage Unit日志存储单元
## MCC 
Mobile Country Code移动国家码
## MNC 
Mobile Network Code移动网络号
## MPU 
Main Processing Unit主处理单元
## NF 
Network Function网络功能
## NRF 
NF Repository Function网络仓储功能
## NRI 
Network Resource Identifier网络资源标识
## NSSF 
Network Slice Selection Function网络切片选择功能
## OMM 
Operation and Maintenance Management操作维护管理
## OMP 
Operation & maintenance Main Processor操作维护主处理板
## OMU 
Operation & Management Unit操作管理单元
## P-CSCF 
Proxy-Call Session Control Function代理呼叫会话控制功能
## PCC 
Policy and Charging Control计费和策略控制
## PCF 
Policy Control Function策略控制功能
## PCRF 
Policy and Charging Rules Function策略和计费规则功能
## PDS 
Primary Directory Server主用目录服务器
## PDU 
Packet Data Unit分组数据单元
## PEI 
Permanent Equipment Identifier永久设备标识
## PFCP 
Packet Forwarding Control Protocol报文转发控制协议
## PFU 
Packet Forwarding Unit网络处理单元
## PGW 
Provision Gateway受理网关
## PI 
Performance Index性能指标
## PLMN 
Public Land Mobile Network公共陆地移动网
## PNR 
Push-Notification-Request推送通知请求
## RAN 
Radio Access Network无线接入网
## RCP 
Resource Control Platform资源控制平台
## RG 
Rating Group费率组
## RGW 
Replication Gateway局间复制模块
## S-NSSAI 
Single Network Slice Selection Assistance Information单个网络切片选择辅助信息
## SA 
Standalone5G独立组网
## SBI 
Service Based Interface基于服务的接口
## SC 
Service Component服务组件
## SCTP 
Stream Control Transmission Protocol流控制传输协议
## SIPI 
Signaling IP bearer Interface信令IP承载接入板
## SM 
Session Management会话管理
## SMF 
Session Management Function会话管理功能
## SMP 
Signal Main Processor信令主处理模块
## SPR 
Subscription Profile Repository用户签约数据库
## SSDS 
Secondary Synchronization Directory Server数据同步的备用目录服务器
## SUPI 
Subscriber Permanent Identifier用户永久标识
## TA 
Tracking Area跟踪区域
## TEID 
Tunnel Endpoint Identifier隧道端点标识
## UDM 
Unified Data Management统一数据管理
## UDR 
User Data Request用户数据（读取）请求
## UDSF 
Unstructured Data Storage Function非结构化数据存储功能
## UE 
User Equipment用户设备
## UPF 
User Plane Function用户平面功能
## URI 
Uniform Resource Identifier统一资源标识符
## VM 
Virtual Machine虚拟机
## VNF 
Virtualized Network Function虚拟化网络功能
## VoLTE 
Voice over LTELTE语音
## VoNR 
Voice over New Radio新空口承载语音
# 5GC逃生解决方案 
## 方案概述 
 5GC逃生方案是指因终端或网络原因出现5GC业务全阻或部分业务受阻，且短时间内无法恢复，在此期间通过存量4G网络为用户提供正常业务服务。导致5GC业务不可用的原因包括：传输层故障、网络故障、网元故障、应用故障、终端协议处理异常等。从业务角度看，5GC业务不可用会影响数据、语音、短信、彩信、定位等业务的可用性。 
5GC逃生更多地应用于5G建设初期，由于网络出现异常，在容灾失败的情况下，5GC逃生可作为应急手段，回落到4G网络以保持各业务正常，如[图1](1604539084060.html#zb92d4313fdd04b549b886c957c166715__30308e9d-bd41-4b83-bdb1-9b8c60e8ba1f)所示。
图1  5GC逃生方案
[]images/%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0-NEW.png)
集中需要逃生的场景包括如下几种： 
KPI指标（例如：5G的会话建立成功率、注册成功率、EPS Fallback成功率）降低到限定值（现场判断） 
有大规模用户投诉 
5G数据或语音业务全阻 说明：现场技术支持人员与运营商沟通后，由运营商来决策启用的逃生解决方案。 

5GC逃生的前提条件是保证4G业务可用，从以下几个层面考虑： 
制式4G网络有MME、SGW、PGW网元，可保证4G业务接入，只需用户重新选择到4G网络，逃生风险不大。 
用户5G用户签约在UDM网元时，如果5G网络故障覆盖UDM网元，则逃生到4G网络后仍然会因鉴权/签约数据的无法获取而导致失败，需考虑单独的5G签约数据逃生方案（例如，在HSS中重新放号）。 
组网部分运营商部署ToC和ToB两张网络（ToB网络面对行业应用），有些行业应用在4G网络中并未部署（例如：NAS短信、URLLC超低时延通信），对于这种仅在5G网络部署的ToB网络，无法跨RAT逃生。 
应用应用可区分为5G业务全阻、仅语音全阻、仅数据全阻，任何一种应用全阻触发逃生的必然结果是该用户的全部应用回落到4G网络。因此，业务全阻和部分业务全阻可采用统一的逃生方案。 

为降低业务影响的范围，建议针对不同业务场景启用不同的逃生解决方案，参见下表。 
编号|场景|解决方案|适用范围
---|---|---|---
1|5G全业务逃生|断开全部AMF N2接口，5G用户全部重新接入4G网络，使用4G的语音/数据/短信业务。|5G无独立ToB网络4G网络支持5G ToB业务5G业务全阻或数据/语音业务的其中之一全阻
2|5G ToC业务逃生|断开ToC AMF N2接口，ToC用户被ToB AMF拒绝接入后重新接入到4G网络，使用4G的语音/数据/短信业务。|4G网络不支持5G ToB业务
## 业务场景 
### 5G全业务逃生 
### 5G全业务逃生 
##### 应用场景 
5G网络或网元故障导致5G业务全阻或部分业务全阻，但存量的4G网络正常。为保证终端业务可用，同时避免5G终端在故障网络中反复尝试造成系统雪崩，可启动5G业务全阻逃生方案，将全部5G接入用户切换到4G网络。 
##### 组网架构 
5G全业务逃生的组网示意图如[图1](1604453722955.html#zbc4fa31656d74e3681da4424e8941d61__ed52b569-d995-41c7-916a-3548c5f285d9)所示。
图1  5G全业务逃生组网示意图
[]images/1606266807055.png)
#### 实现原理 
###### 方案 
5G全业务逃生是通过接口隔离来触发5G接入的用户快速地逃生到存量网络，并阻断与故障网络间的交互，防止故障范围的扩散。 
隔离AMF的N2接口和N26接口隔离N2接口：NG-RAN检测到N2接口无可用连接时，将触发小区退出服务或闭塞小区。终端在5G信号覆盖区域发现无可用小区时，会自动选择可用网络，通过IMSI附着或局间TAU接入4G网络。如图2所示，该方案可保证用户快速回到4G网络，同时用户在5G网络反复尝试，当5G网络正常后，UE可快速接入5G网络。图2  隔离N2接口隔离N26接口：隔离与4G网络间的互操作接口，用于避免逃生后触发4/5G互操作带来的不可预料的异常。 
（可选）隔离融合SMF的2/3/4G接口如果SMF为融合局且现场判断需要隔离SMF，则需要断开融合SMF（作为SAE-GW-C时，提供对SGW/MME的接口（S5/S8/S11）；作为GGSN时，提供对SGSN的Gn接口）。 
#### 逃生说明 
###### 准备工作 
确保4G业务可用。 
确保4G网络设备预留足够的容量（包括硬件资源、License等）。由于全部5G接入用户将接入4G网络，需要确保4G网络预留足够的资源，否则可能导致4G网络过载，进一步影响4G业务可用性。 
4G网络需做好过载保护。N2接口断链后，连接态用户会立即重选4G网络，可能引发短时间内的信令风暴。 
MME和SGW开启PRN功能。融合SMF断开S5/S8接口后，MME和SGW开启PRN功能以保证MME可感知。 
###### 逃生操作 
通过端口号修改方式，断开全部AMF的N2接口。 
（可选）通过接口闭塞方式，闭塞全部融合SMF的对外接口。 
###### 逃生预期结果 
从用户和网络的维度观察，预期结果参见下表。 
维度|预期结果|观测手段
---|---|---
用户|逃生启动12秒后，5G接入用户开始返回4G网络。大部分连接态用户在大约1分钟内接入4G网络。空闲态用户在一次周期性注册更新定时器时长范围内（默认54分钟）均匀离散地接入4G网络。|观测测试手机信号变化为4G接入。
5G网络（逃出）|NG-RAN大约在20秒内（ZTE基站约12秒）检测到断链，关闭/闭塞小区，触发UE重选网络。AMF、SMF（可选）、NRF（可选）、周边交换机会出现局向/链路相关告警。AMF用户资源残留：当N8接口在逃生过程中可用，用户逃生到4G网络时，通过UDM的去注册消息释放残留的用户资源；否则，空闲态用户的残留资源将随着不可达定时器/上下文删除定时器等超时后逐步释放，连接态用户的残留资源在N2接口恢复后用户进入空闲态并逐步释放。SMF会话资源残留：通过N4口断链触发资源回收。|逃生前后在AMF/SMF/UDM网元收集用户数/会话数统计，作为4G逃入指标变化的参考。
4G网络（逃入）|5G连接态用户在逃生后1分钟内快速接入EPC，对MME、HSS、SAE-GW、CG/OCS、IMS等形成瞬时信令冲击，可能产生流控相关告警。|逃生前后在MME/PGW/HSS收集用户数/会话数统计，作为4G逃入指标变化的参考。逃生过程中，观测4G各网元的接入成功率、CPU利用率指标，以及是否有过负荷、容量、数据区等相关告警。
###### 逃生影响及消除方法 
用户逃生到4G网络后，5G NF中存在资源残留，其影响及消除方法如下： 
网元|残留资源分析|结论或消除方法
---|---|---
AMF|正常情况下，用户回落到4G网络后，UDM/HSS会通知AMF释放5G用户资源。如果上述流程条件不满足时，用户资源残留通过如下途经被释放：连接态用户：保持连接态一直不释放。直到该AMF恢复N2接口，NG-RAN触发NG Setup后AMF释放全部N2接口的连接，用户进入空闲态，后续处理同“空闲态用户”。空闲态用户：周期性更新定时器（默认54分钟）超时后，用户进入隐式分离态。待PURGE定时器（默认1天）超时，彻底清除用户上下文资源。|一段时间内会存在残留资源，可自动清除。即使AMF恢复后仍有未清除的残留资源，也不影响用户再次接入。
SMF|SMF依赖N4口断链回收所有会话资源。|SMF可回收残留的会话资源。
#### 恢复操作 
###### 准备工作 
时机判定5G网络故障解决，通过拨测确认5G网络已恢复正常后，才可触发5G逃生恢复。 
拨测方法使用5G测试站点和AMF建立N2接口连接。AMF侧需要使用与正常商用5G站点不同的N2服务端地址或端口号。如果逃生时闭塞了融合SMF的全部接口，SMF中5G相关接口需要解闭塞。AMF启用拨测功能，使用终端拨测到指定的SMF，观测业务指标是否正常。 
###### 恢复操作 
恢复逃生时闭塞的全部接口以及修改的配置。 
###### 预期结果 
维度|预期结果|观测手段
---|---|---
用户|N2接口恢复后5G小区解闭塞，终端重新收到5G信号后，连接态用户在进入空闲态时通过注册更新返回5G网络，空闲态用户逐步返回5G网络。|观测测试手机的信号变化为5G接入。
5G网络|5G各NF用户数逐步增加，经过一段时间后（一般为一次周期性更新，时长默认为54分钟），恢复到逃生前的水平。如果仍有残留用户资源未释放，可能导致用户数超过逃生前的用户数，但是在一段时间（不超过24小时）内会回收。|在AMF/SMF/UDM网元收集用户数/会话数统计，作为5G指标变化的参考。观测5G各网元的接入成功率、CPU利用率指标，以及是否有过负荷、容量、数据区等相关告警。
4G网络|随着5G用户逐步返回5G网络，4G用户数逐步减少。|在MME/PGW/HSS网元收集用户数/会话数统计，作为5G指标变化的参考。
### 5G ToC业务逃生 
### 5G ToC业务逃生 
##### 应用场景 
5G中仅ToC网络或网元故障，导致5G ToC业务全阻或部分类型业务全阻，但存量4G系统正常。为保证终端业务可用，同时避免5G终端在故障网络中反复尝试造成系统雪崩，此时可启动5G
ToC业务逃生方案，将5G ToC接入用户切换到4G网络。 
##### 组网架构 
5G ToC业务逃生的组网示意图如[图1](1604453726115.html#zb789f9432a4242b29dcd4e383b523b43__b3bd259f-d85b-4061-be33-931d040612a3)所示。
图1  5G ToC业务逃生组网示意图
[]images/1606266945661.png)
#### 实现原理 
###### 方案 
5G ToC业务逃生是通过接口隔离触发5G接入用户快速逃生到存量网络，并阻断与故障网络间交互，防止故障范围扩散。 
隔离ToC AMF的N2接口和N26接口隔离N2接口：NG-RAN检测到ToC AMF的N2接口断链后，ToC用户信令将被转发到ToB网络可用的AMF中。由于业务受限（签约或号段），ToB
AMF拒绝ToC用户接入，拒绝原因值缺省#111。终端自动选择其他可用网络，通过IMSI附着或局间TAU接入4G网络。如图2所示，该方案可保证用户快速回到4G网络。图2  隔离N2接口隔离N26接口：隔离与4G间互操作接口，避免逃生后触发4/5G互操作带来不可预料的异常。 
（可选）隔离ToC网络融合SMF的2/3/4G接口如果SMF为融合局且现场判断需要隔离SMF，则需要断开融合SMF（作为SAE-GW-C时，提供对SGW/MME的接口（S5/S8/S11）；作为GGSN时，提供对SGSN的Gn接口）。 
###### 业务流程 
5G ToC逃生过程中的业务流程如[图3](1604453726115.html#z32b88dfdcb3942e3ba2ad5a30524db00__45ce04c8-104e-4c21-9ce8-3fea21497687)所示。
图3  5G ToC逃生业务流程
[]images/1606267286136.png)
流程说明如下： 
UE发送N1/N2上行信令到达gNB，准备发往ToC AMF。 
gNB检测到ToC AMF故障，进行故障重选后，gNB转发消息给ToB AMF。 
 说明： 
ToB AMF和ToC AMF PLMN不同时，如果全部ToC AMF的N2连接断开，则会导致基站不再广播ToC PLMN给UE。在需要逃生的场景，UE不会选择ToB AMF直接逃生到4G网络。 
ToB AMF无该用户信息，拒绝上行信令请求，触发用户重注册。 
UE发起注册请求，gNB转发注册请求给ToB AMF。 
ToB AMF根据签约切片或ToB用户号段白名单判定该用户非ToB用户，拒绝接入（原因值为#111）。 
该原因值下UE不会在短时间内重发请求信令，以缓解可能引发的信令风暴，同时UE默认在12分钟后重新尝试接入5G网络。确保5G网络恢复后，终端可尝试重新接入5G网络。 
终端收到#111原因值的具体行为说明参见下表。 
原因值|原因描述|说明
---|---|---
#111|Protocol error, unspecified|UE将重注册尝试计数器设置为5。UE将删除5G-GUTI、TAI列表、上次访问的注册TAI、等效PLMN列表（如果有）和ngKSI，启动计时器T3502，并将5GS更新状态设置为5U2 NOT UPDATED。为执行PLMN选择（根据3GPP TS 23.122 [5]协议），UE更改5GS的状态为5GMM-DEregister.ATTEMPTING-REGISTRATION。如果该过程是通过3GPP接入执行的，并且UE正在单注册模式下运行：UE应对3GPP TS 24.301 [15]协议中规定的异常情况，另外处理EMM参数（EPS更新状态、EMM状态、4G-GUTI、TAI列表、上次访问的注册TAI、等效PLMN列表和eKSI）。EPS附着过程失败，并且附着尝试计数器设置为5。UE将尝试选择E-UTRAN无线电接入技术，并进行适当的EMM特定过程。此外，UE可以禁用N1模式功能。
终端重选其他可用网络。UE通过eNB向MME发送Attach Request消息。 
MME向UE返回Attach Accept消息。UE在4G网络中成功接入。 
#### 逃生说明 
###### 准备工作 
确保4G业务可用。 
确保4G网络预留足够资源。全部5G用户将接入4G网络，需要确保4G网络预留有足够资源，否则可能导致4G网络过载，进一步影响4G业务可用性。 
ToB网络中AMF、UDM、NSSF、NRF均会受到冲击，需提前做好过载保护。ToC AMF的N2接口断链，无线重选ToB AMF处理在线用户信令，ToB AMF拒绝用户接入触发终端回4G网络，该过程可能导致ToB AMF过载。 
4G网络需做好过载保护。ToB AMF拒绝ToC用户接入触发用户回4G网络，该过程可能导致4G网络过载。 
MME和SGW开启PRN功能。融合SMF断开S5/S8接口后，MME和SGW开启PRN功能以保证MME可感知。 
###### 逃生操作 
通过端口号修改方式，断开全部ToC AMF的N2接口和N26接口。 
通过接口闭塞方式，闭塞全部ToC的融合SMF的对外接口。 
###### 逃生预期结果 
从用户、逃生出网络、逃生到网络三个维度来看，预期结果参见下表。 
维度|预期结果|观测手段
---|---|---
用户|逃生启动12秒后，5G接入用户开始返回4G网络。连接态用户保持一段时间（一般在10分钟以内）后中断，信令触发用户返回4G网络。空闲态用户在一次周期性注册更新定时器时长范围内（默认54分钟）均匀离散的接入4G网络。|观测测试手机信号变化为4G接入。
5G网络（逃出）|NG-RAN大约在20秒内（ZTE基站约12秒）检测到断链，后续用户上行信令全部转发到ToB AMF。ToC AMF、ToC SMF（可选）、ToC NRF（可选）、周边交换机会出现局向/链路相关告警。ToC AMF用户资源残留：N8接口在逃生过程中可用，用户逃生到4G网络时，通过UDM的去注册消息释放用户资源；否则，空闲态用户的残留资源将随着不可达定时器/上下文删除定时器等超时后逐步释放，连接态用户的残留资源在N2接口恢复后用户进入空闲态并逐步释放。ToC SMF会话资源残留：通过N4接口断链触发资源回收。|逃生前后在AMF/SMF/UDM收集用户数/会话数统计，作为4G逃入指标变化的参考。
4G网络（逃入）|5G连接态用户在逃生后一段时间（一般在10分钟内）重新接入EPC，对MME、HSS、SAE-GW、CG/OCS、IMS等形成一定的信令冲击，可能产生流控相关告警。|逃生前后在MME/PGW/HSS收集用户数/会话数统计，作为4G逃入指标变化的参考。逃生过程中，观测4G各网元的接入成功率、CPU利用率指标，以及是否有过负荷、容量、数据区等告警。
###### 逃生影响及消除方法 
用户逃生到4G网络后，5G NF中存在资源残留，其影响及消除方法参见下表。 
网元|残留资源分析|结论或消除方法
---|---|---
AMF|正常情况下，用户回落到4G网络后，UDM/HSS会通知AMF释放5G用户资源。如果上述流程条件不满足时 ，用户资源残留通过如下途经被释放：连接态用户：保持在连接态一直不释放，直到该AMF恢复N2接口。NG-RAN触发NG Setup后AMF网元释放全部N2接口连接，用户进入空闲态，后续处理同“空闲态用户”。空闲态用户：周期性更新定时器（默认54分钟）超时后进入隐式分离态，待PURGE定时器超时（默认1天），彻底清除用户上下文资源。|一段时间内存在资源残留，可自动清除。即使AMF恢复后仍有未清除的残留资源，不影响用户再次接入。
SMF|SMF依赖N4接口断链回收所有会话资源。|SMF可回收会话资源。
#### 恢复说明 
###### 准备工作 
时机判定5G网络故障解决，通过拨测确认5G网络已恢复正常后，才可触发5G逃生恢复。 
拨测方法使用5G测试站点和AMF建立N2接口连接。为避免正常商用5G站点也恢复连接，AMF侧需要使用不同的N2服务端地址或端口号。如果逃生时闭塞了融合SMF的全部接口，SMF中5G相关接口需要解闭塞。AMF启用拨测功能，使用终端拨测到指定SMF，观测业务指标是否正常。 
###### 恢复操作 
恢复逃生时闭塞的全部接口以及修改的配置。 
###### 恢复预期结果 
维度|预期结果|观测手段
---|---|---
用户|N2接口恢复后5G小区解闭塞，终端重新收到5G信号后，连接态用户在进入空闲态时通过注册更新返回5G网络，空闲态用户逐渐返回5G网络。|观测测试手机信号变化为5G接入。
5G网络|5G各NF用户数逐步增加，一段时间后（一般是一次周期性更新时长，时长默认为54分钟）恢复到逃生前的水平。如果之前有残留用户资源未释放，有可能会导致用户数超过逃生前用户数，但是一段时间（不超过24小时）内会回收掉。|恢复后在AMF/SMF/UDM网元收集用户数/会话数统计，作为5G指标变化的参考。观测5G各网元的接入成功率、CPU利用率指标，是否有过负荷、容量、数据区等告警。
4G网络|随着5G用户逐步返回5G网络，4G用户数逐步减少。|恢复后在MME/PGW/HSS网元收集用户数/会话数统计，作为5G指标变化的参考。
## 应用限制 
本方案在应用上存在如下约束： 
无4G能力终端将无法保障业务可用。 
需要确保4G业务可用并预留足够资源。 
无法保证业务连续，存在一次数据和语音会话重建。 
## 客户收益 
受益方|受益描述
---|---
运营商|保证5G业务可用，避免因网络故障引发用户投诉。
用户|可正常使用移动通信业务。
## 可获得性 
### 涉及NF 
网元|发布版本
---|---
AMF|ZXUN uMAC V7.20.30
SMF|ZXUN xGW V7.20.30
### License支持 
无 
## 规格指标 
名称|指标
---|---
连接态用户逃生完成时间|N2接口断链后1分钟
空闲态用户逃生完成时间|最长不超过54分钟（一次周期性注册更新时长）
5G恢复后用户返回5G网络时间|最长不超过54分钟（一次周期性注册更新时长）
## 遵循标准 
标准类别|标准名称
---|---
3GPP|3GPP TS 23.401 General Packet Radio Service (GPRS) enhancements for Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access
## 指标监控 
### 性能统计 
#### AMF网元 
性能测量类型|说明
---|---
初始注册流程测量|编号为C51001开头的计数器。
N8接口测量|编号为C51052开头的计数器。
N11接口测量|编号为C51053开头的计数器。
N12接口测量|编号为C51054开头的计数器。
用户数测量|编号为C51350开头的计数器。
业务请求流程测量|编号为C51004开头的计数器。
PDU会话流程测量|编号为C51007开头的计数器。
#### SMF网元 
性能测量类型|说明
---|---
5G基于DNN的PDU会话测量|编号为C51521开头的计数器。
4/5G互操作流程测量|编号为C51539开头的计数器。
会话建立流程测量|编号为C51501开头的计数器。
I-SMF会话建立流程测量|编号为C51533开头的计数器。
会话数测量|编号为C51507开头的计数器。
GSU性能测量|编号为C04909开头的计数器。
### 告警与通知 
#### AMF网元 
告警码|告警名称
---|---
150101|接口IPv4协议态down
150102|接口IPv6协议态down
8402690|偶联断链
3305242916|SMF不可达
3305242924|gNB断链退服告警
#### SMF网元 
告警码|告警名称
---|---
3322019843|NRF节点不可达告警
103007|和GTP控制面节点之间链路故障
103001|和RADIUS鉴权服务器之间通讯断
103002|和RADIUS计费服务器之间通讯断
103006|DHCP客户端与服务端断链
103008|和CG之间链路故障
108003|Diameter邻接局不可达
108010|SCTP偶联通路断
109201|UPF节点不可达
150101|接口IPv4协议态down
150102|接口IPv6协议态down
## 数据配置 
### 配置前提 
用户已经在4G签约。 
如果SMF作为2/3/4/5G融合的网元，需要完成与MME的对接配置。 
### 数据规划 
#### MME网元 
配置命令|参数名称|参数取值|说明
---|---|---|---
SET SOFTWARE PARAMETER|786601|1|该软件参数用于控制MME是否支持PRN功能（可参考协议3GPP 29274的7.9.5章节）。该软件参数应用于需要判断MME是否支持PRN功能的场景。 该软件参数值设置为0：MME不支持该功能，丢弃PGW Restart Notification消息。 该软件参数值设置为1：MME支持该功能，处理PGW Restart Notification消息。
786602|SET SOFTWARE PARAMETER|1|在MME处理PGW Restart Notification消息时，如果发现CAUSE未携带或者CAUSE不为“PGW not responding（12）”，通过该软件参数控制MME判定PGW是否重启。该软件参数的应用场景为：MME收到PGW Restart Notification消息但消息中携带的CAUSE不为12。 该软件参数值设置为0：MME丢弃PGW Restart Notification消息。 该软件参数值设置为1：MME判定PGW重启，回收该PGW占用的所有资源。
786603|SET SOFTWARE PARAMETER|1|在MME处理PGW Restart Notification消息时，如果发现CAUSE为“PGW not responding（12）”，通过该软件参数控制MME的处理策略。该软件参数的应用场景为：MME收到PGW Restart Notification消息且消息中携带的CAUSE为12。该软件参数值设置为0：MME丢弃PGW Restart Notification消息。 该软件参数值设置为1：MME判定PGW重启，回收该PGW占用的所有资源。
786604|SET SOFTWARE PARAMETER|1|该软件参数用于控制MME是否支持PGW重选功能。该软件参数的应用场景为：UE请求建立PDN连接，如果MME发现原有的SGW和PGW链路中断，则需要根据该软件参数值决定是否重新选择一个新的PGW。 该软件参数值设置为1：支持PGW的重新选择。 该软件参数值设置为0：不支持PGW的重新选择。
786549|SET SOFTWARE PARAMETER|1|该软件参数用于控制PGW的有效性管理。如果SGW在Create Session Response消息中带了原因值“Remote peer not responding（100）”，MME会累计收到此原因值的次数。当累计的次数大于或等于该软件参数值时，MME把该PGW IP地址置为无效。在此IP地址恢复正常之前，MME不会选择该IP地址。该软件参数一般不需要修改，保持默认值即可。 该软件参数值设置为0：不启用本功能。 该软件参数值设置为1~10000：收到原因值“Remote peer not responding”的最大次数。具体次数根据现场需求设置。
ADD GTP ALARM NODE|对端节点IP地址|195:168:114::11|GSN/GW节点的IP地址，包括IPv4或者IPv6地址。执行SHOW EPC APN或SHOW EPCHOST命令，从中选择需要隔离的SMF地址。
SET GTP PARAMETER|GTP会话管理信令发送次数|5|该安全变量用于设置GTP会话管理信令发送次数（包括首次发送和后续重发）。在SGW没有响应的情况下，GTP消息会重发，消息发送次数由此安全变量控制。仅对S11接口的信令有效。
主动发送ECHO消息|SET GTP PARAMETER|是|该安全变量用于设置MME是否主动发送Echo Request消息。如果设置为否，则本端MME不会主动发送Echo Request消息，但对于收到的Echo Request消息仍会回Echo Response响应消息。如果设置为是，则本端MME会主动发送Echo Request消息。
ECHO信令发送次数|SET GTP PARAMETER|5|该参数用于设置Echo Request消息尝试次数（包括首次发送和后续重发），对应于协议29060中的N3-REQUESTS计数器。当对端不回Echo Response消息时，MME会重发Echo Request消息。 当重发达到最大次数，仍然没有收到对端Echo Response消息，则停止发送，认为对端链路故障或对端网元发生故障。
GTP移动性管理信令发送次数|SET GTP PARAMETER|4|该安全变量用于设置GTP移动性管理信令发送次数（包括首次发送和后续重发）。在对端MME/SGSN没有响应的情况下，GTP消息会重发，消息发送次数由此安全变量控制。对除了S11接口之外的S10、Gn/Gp、Sv等接口信令有效。
#### SGW网元 
配置命令|参数名称|参数取值|说明
---|---|---|---
SET PRNFUNCTION|重发次数|3|表示SGW-C在支持PRN功能的情况下，如果MME（或S3/S4 SGSN）没有回复PRN Acknowledge消息，SGW-C重发PRN消息的次数。
是否支持PRN功能|SET PRNFUNCTION|打开|表示SGW-C是否支持PRN功能。
#### UPF网元 
配置命令|参数名称|参数取值|说明
---|---|---|---
SET HEARTBEAT|心跳开关|ENABLE|该参数用于开启/关闭UP心跳检测功能。ENABLE：表示开启UP心跳检测功能。 DISABLE：表示关闭UP心跳检测功能。
重发次数|SET HEARTBEAT|5|该参数用于设置UP心跳重发次数，也可称为心跳检测连续异常次数。连续检测到心跳检测异常的次数达到该次数，则认为关联断链。
应答策略|SET HEARTBEAT|ACKWORK|该参数用于设置UP心跳检测应答策略。ACKALL：设置为应答所有，表示对所有心跳检测请求做应答。 ACKWORK：设置为应答会话，表示只对建立会话的心跳检测请求做应答。
发送间隔(s)|SET HEARTBEAT|20|该参数用于设置心跳检测发送间隔，单位是秒。
#### AMF网元 
通过修改本端端口号达到断开N2接口的目的，使用如下配置： 
-配置命令|参数名称|参数取值|说明
---|---|---|---
SET SCTP|SCTP标识|10|该参数为需要隔离的基站的偶联ID。
本端端口|SET SCTP|38415|该参数为偶联的本端端口号。修改为任意端口，使得与基站的偶联建立失败。
其他参数|SET SCTP|-|保持原有配置，无需修改。
### 配置过程 
#### MME网元 
当融合的SMF有2/3/4G用户接入时，需要进行该设置。 
步骤|说明|操作
---|---|---
1|开启相关软参，设置MME支持PGW故障的检测|SET SOFTWARE PARAMETER:PARAID=786601,PARAVALUE=1SET SOFTWARE PARAMETER:PARAID=786602,PARAVALUE=1SET SOFTWARE PARAMETER:PARAID=786603,PARAVALUE=1SET SOFTWARE PARAMETER:PARAID=786604,PARAVALUE=1SET SOFTWARE PARAMETER:PARAID=786549,PARAVALUE=1
2|新增GTP链路告警对端节点地址|ADD GTP ALARM NODE:IP="195:168:114::11"
3|设置GTP参数|SET GTP PARAMETER:SMSENDCOUNT=5,ECHOREQ="YES",ECHORESENDCOUNT=5,MMSENDCOUNT=4
#### SGW网元 
当融合的SMF有2/3/4G用户接入时，需要进行该设置。 
步骤|说明|操作
---|---|---
1|设置SGW-C支持PRN功能|SET PRNFUNCTION:PRNSENDTIMES=3,CFGSWITCH="ENABLE"
#### AMF网元 
步骤|说明|操作
---|---|---
1|进入Rosng，通过shutdown端口的方式断开AMF网元的N2接口和N26接口|ZXROSNG#con tZXROSNG(config)#interface xgei-1/0/1/1ZXROSNG(config-if-xgei-1/0/1/1)#shutdown
2|通过修改与基站对接的偶联端口的方式断开N2接口|SET SCTP:ID=10,LOCPORT=38455
#### SMF网元 
步骤|说明|操作
---|---|---
1|进入Rosng，将SMF网元的对外接口全部shutdown|ZXROSNG#con tZXROSNG(config)#interface xgei-1/0/1/1ZXROSNG(config-if-xgei-1/0/1/1)#shutdown
### 测试用例 
#### 5G全业务逃生测试用例 
##### 5G全业务逃生 
测试项目|5G全业务逃生
---|---
测试目的|启动5G逃生，全部5G用户可以快速逃生到4G网络。
预置条件|用户签约及终端都支持4G，且4G网络正常可用。4G业务可用并预留足够资源。
测试过程|用户已在5G网络接入。现场决定启动5G逃生。AMF网元上断开N2接口和N26接口。SMF网元上断开所有对外接口。
通过准则|断开端口后，上报相关的异常告警。基站检测到和AMF网元断链后，触发小区退出服务或闭塞小区。5G用户通过重新选择到4G小区接入，快速逃生到4G网络，业务正常。新接入用户直接选择4G网络接入，业务正常。
测试结果|-
##### 5G全业务恢复 
测试项目|5G全业务恢复
---|---
测试目的|5G网络恢复后，全部用户可以顺利返回5G网络。
预置条件|5G网络已恢复正常，可以正常接入用户。
测试过程|恢复AMF网元的N2接口和N26接口的配置。恢复SMF网元对外接口的配置。
通过准则|基站和AMF之间的链路恢复后，终端主动尝试重新接入5G网络。逃生到4G的用户逐步回到5G网络，业务正常。新接入的5G用户可以正常选择5G网络接入，业务正常。
测试结果|-
#### 5G ToC业务逃生测试用例 
##### 5G ToC业务逃生 
测试项目|5G ToC业务逃生
---|---
测试目的|启动5G ToC业务逃生，ToC业务快速逃生到4G网络。
预置条件|用户签约及终端都支持4G，且4G网络正常可用。4G业务可用并预留足够资源。
测试过程|ToC用户已在5G网络接入。现场决定启动5G ToC业务逃生。MME和SGW开启PRN功能。AMF上断开ToC业务的N2接口和N26接口。SMF上断开S5/S8接口。
通过准则|gNB检测到ToC AMF故障。UE的上行信令由gNB转发给ToB AMF。ToB AMF无该用户信息拒绝上行信令请求，触发用户重注册。UE发起注册请求，gNB转发给ToB AMF。ToB AMF根据签约切片或ToB用户号段白名单判定该用户非ToB用户，拒绝接入，原因值为#111。终端重选其他可用网络。UE在4G网络中成功接入，业务正常。ToB用户可以正常使用5G网络，业务不受影响。新接入ToC用户直接选择4G网络接入。
测试结果|-
##### 5G ToC业务恢复 
测试项目|5G ToC业务恢复
---|---
测试目的|5G网络恢复，逃生到4G网络的ToC用户可以顺利回5G网络。
预置条件|5G网络已恢复正常，可以正常接入用户。
测试过程|恢复AMF上ToC业务的N2接口和N26接口。恢复SMF上断开S5/S8接口。
通过准则|ToC业务链路恢复后，ToC用户终端主动尝试重新接入5G网络。逃生到4G网络的ToC业务用户逐步回到5G网络，ToC业务正常。新接入的ToC用户可以正常选择5G网络接入，业务正常。
测试结果|-
## 常见问题处理 
### 问题一 
故障现象
逃生后，部分终端不切回4G网络或2G网络，一直驻留在5G网络。 
故障分析
按照统计的AMF注册态用户来计算未逃生用户。 
这种统计方式不准确。AMF上部分用户仍旧为注册态，可能是因为部分用户始终未收到IWF的Deregistration Notification消息，导致AMF网元统计该用户始终处于注册态。 
AMF未收到IWF的Deregistration Notification消息，并不代表用户未逃生到4G网络。 
通过信令分析，大部分终端进行了逃生4G，但AMF网元并未收到Deregistration Notification消息，导致从AMF的统计存在偏差。 
可能原因为个别终端是数据卡，仅支持5G网络，无法选择4G网络；或在4G签约不全，无法在4G成功注册。 
### 问题二 
故障现象
逃生后，部分终端直接回落到2G网络，有的等一段时间回4G网络。个别测试手机长时间不回4G网络，一直驻留在2G网络。 
故障分析
终端长期不回4G网络该终端是一款老版本的测试终端。由于其他测试终端都正常，且并无异常信令，因此该异常场景与终端版本有较大关系。 
部分终端回落到2G网络终端在4G选网是TAU方式，长时间TAU失败，可能触发终端回落到2G网络。如挂断电话后可迅速返回4G PS域，则属于正常场景。 
### 问题三 
故障现象
5G网络恢复后，某终端不停在5G网络和4G网络之间来回切换。 
故障分析
从5G网络侧跟踪信令分析，网络侧收到了正常的切换请求，并无报错。从现象看是终端处于4G/5G信号覆盖重叠区域，收到4G和5G信号的RSRP的强度有波动，导致基站频繁触发切换请求。 
将该终端移动到另一个小区后恢复正常。 
### 问题四 
故障现象
5G网络恢复后，部分终端未及时切回5G网络。 
故障分析
对未及时切回5G网络的测试号码进行信令回溯，在5G网络侧并未跟踪到用户的注册信令。因此，终端未及时切回5G网络可能与无线配置的RSRP门限、信号强弱有关系。终端所在位置未达到选择5G的门限，因此导致部分用户回5G网络较慢。 
# 缩略语 
# 缩略语 
## AMF 
Access and Mobility Management Function接入和移动管理功能
## HSS 
Home Subscriber Server归属用户服务器
## KPI 
Key Performance Index关键性能指标
## MME 
Mobility Management Entity移动管理实体
## NAS 
Network Access Service网络接入服务
## PGW 
PDN Gateway分组数据网网关
## PRN 
PGW Restart NotificationPGW重启通知
## SGW 
Serving Gateway服务网关
## UDM 
Unified Data Management统一数据管理
## URLLC 
Ultra Reliable Low Latency Communication超高可靠超低时延通信
# 信令风暴抑制方案 
## 方案概述 
信令风暴是指网络中的信令负荷超出了网络的设计能力，导致网络拥塞甚至雪崩效应，使网络崩溃或者不可用。通过网络侧采取一定的措施，减少网络侧要处理的信令，进行信令风暴抑制，可以避免网络拥塞，化解信令风暴。 
引发信令风暴的原因主要包括以下几类： 
终端及应用原因智能终端信令能力相对于普通终端极大提升智能终端行为模式复杂化，各种异常引发信令增加海量APP应用导致信令剧增APP永久在线导致保活信令剧增海量物联网终端行为趋同，特定行为（如：定时抄表）触发信令冲击异常终端因配置错误、中毒、欠费、服务器异常等，对网络持续反复发送各种连接建立请求 
特殊事件原因节假日话务剧增引发的信令风暴体育赛事演唱会等引发特定区域的信令风暴地震海啸台风等灾害引发的信令风暴其他群体事件引发的信令风暴 
网络及运营原因网络部署时信令能力考虑不足、冗余不够导致部分网元故障导致连锁反应部分链路故障导致信令风暴网络升级或业务调整时引发的信令风暴因网络配置等原因引起网络环路运营商定义的定时网络行为造成的信令冲击，比如零点全网用户套餐清零等 
信令风暴发生后将引发一系列问题，包括但不限于： 
部分链路拥塞该链路上用户失败率上升该链路业务质量下降该链路可接入用户数下降 
部分网元过负荷或失效该网元接入能力下降或者完全失效该网元部分用户业务质量下降，失败率上升该网元用户掉线或者转入其他容灾网元，造成其他网元负荷上升 
整个网络服务能力下降业务服务质量下降，时延增加用户业务失败率剧增网络整体可接入用户数下降 
网络雪崩，完全无法提供服务所属区域内用户都无法接入整个网络完全无法提供服务 
针对信令风暴，可采用以下几类方法，多维度防控信令风暴。 
无效信令抑制，减少不必要的信令智能识别异常信令，异常终端进行管控，并设置合理的退出机制保证用户权益区分业务（DNN、切片等）的拥塞控制，对部分用户延时处理，降低当期网络负荷，平滑业务峰谷 
自身过载控制，保证本网元正常运行设定过载指标（CPU、数据区等核心指标）区分业务优先级，按比例应答拒绝，逐步降低本网元负荷业务拒绝时携带合适原因和退避定时器，防止反复请求向上游网元发送过载通知，减少来自上游的业务量根据部署策略启用自动弹性扩容，扩充虚机数量，增加业务处理能力，降低单虚机负荷 
周边网元过载保护，保护周边网元正常运行通过邻接网元过载控制保护，均衡整个网络负荷，保障整个网络的稳定性 
## AMF/MME/SGSN流控 


因网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 


AMF/MME/SGSN提供自保流控、周边网元过载保护及无效信令抑制多套解决方案，对信令风暴进行综合治理。 


总体原则：默认开启CPU过负荷和动态流控，分别用于保护自身和保护周边网元，其他流控功能按需开启。相关解决方案参见下表。 


分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|AMF CPU过负荷控制MME/SGSN CPU过负荷控制|在服务组件上根据CPU拥塞情况对各类业务限制一定的通过率，保护CPU不会冲高。|是|默认开启
自保流控|AMF入向业务总量控制MME/SGSN入向业务总量控制|控制单位时间内允许通过的业务总量，业务总量的计算为各个单项业务的加权叠加。|否|AMF入向业务总量控制的配置方法MME/SGSN入向业务总量控制的配置方法
自保流控|AMF入向业务单项控制MME/SGSN入向业务单项控制|控制单位时间内通过的各个单项业务量。|否|AMF入向业务单项控制的配置方法MME/SGSN入向业务单项控制的配置方法
自保流控|AMF NAS拥塞控制MME NAS拥塞控制|支持区分接入类型/业务的流量控制，避免单个业务占用过多系统资源。|否|AMF NAS拥塞控制的配置方法MME NAS拥塞控制的配置方法
自保流控|N2接口过载控制S1接口过载控制Iu接口过载控制|网元自身过载时通知周边网元流控，以保护网元自身。|否|N2接口过载控制的配置方法S1接口过载控制的配置方法Iu接口过载控制的配置方法
自保流控|服务化接口过载控制S6a接口拥塞控制GTP接口拥塞控制MAP接口拥塞控制|网元自身过载时通知周边网元流控，以保护网元自身。|否|服务化接口过载控制的配置方法S6a接口拥塞控制的配置方法GTP接口拥塞控制的配置方法MAP接口拥塞控制的配置方法
周边网元过载保护|AMF出向业务控制MME出向业务控制SGSN出向业务控制|对于本网元发起的到其他网元的业务，限制一定的业务量，保护对方网元不会被冲击。|否|AMF出向业务控制的配置方法MME出向业务控制的配置方法SGSN出向业务控制的配置方法
周边网元过载保护|S6a接口自动流控|自动计算周边网元处理能力，实时流控，以保护周边网元。|是|默认开启流控参数设置参见S6a接口自动流控的配置方法
周边网元过载保护|Iu接口过载控制RNC/eNodeB无线拥塞控制|基于周边网元反馈，实时流控，以保护周边网元。|否|Iu接口过载控制的配置方法RNC/eNodeB无线拥塞控制的配置方法
周边网元过载保护|服务化接口过载控制|基于周边网元反馈，实时流控，以保护周边网元。|是|服务化接口过载控制的配置方法
周边网元过载保护|S6a接口拥塞控制GTP接口拥塞控制MAP接口拥塞控制|基于周边网元反馈，实时流控，以保护周边网元。|否|S6a接口拥塞控制的配置方法GTP接口拥塞控制的配置方法MAP接口拥塞控制的配置方法
周边网元过载保护|信令拥塞控制|按照信令链路拥塞情况，限制信令接口的业务通过量，保护信令链路。|是|信令拥塞控制的配置方法
无效信令抑制|AMF UE异常信令管控MME UE异常信令管控SGSN UE异常信令管控|智能识别异常行为的用户，进行管控，以减少用户无效而频繁的信令业务，进行端到端防护。|否|AMF UE异常信令管控的配置方法MME UE异常信令管控的配置方法SGSN UE异常信令管控的配置方法


### 自保流控 
#### AMF CPU过负荷控制 
##### 应用场景 
系统过载时，通过入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定和高优先级业务成功率。 
##### 保护对象 
AMF 
##### 流控原理 
AMF CPU过载控制是AMF过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量的门限（超过门限外的其他话务量将被丢弃/拒绝，不再处理），来实现将CPU负荷控制在目标范围之内。 
图1  CPU过载控制
[]images/image.png)
CPU过载控制包括门限配置，分为高低两个控制门限及负荷区间。一般低负荷区间在75%~85%，高负荷区间在85%~100%。 
当系统CPU负荷超过低负荷控制门限（可配置）后，将启动CPU过载控制功能，此时对系统定义的低优先级消息/业务进行控制。 
当系统CPU负荷超过高负荷控制门限（可配置）后，将对系统定义的低优先级消息/业务，以及高优先级消息/业务同时进行控制。 
最终CPU过载控制的目标是将CPU负荷控制在一定区间以内（一般为70%~75%，可配置）。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
在消息优先级及业务优先级均为低时按低优先级处理，其他情况按高优先级处理。从而在控制话务的同时，能够尽力兼顾高优先级消息/业务的处理。 
系统对高低优先级消息定义的缺省示例如下： 
高优先级：位置更新，切换等。 
低优先级：初始注册，业务请求，PDU会话-初始建立请求等。 
不受控消息：去注册，PDU会话-释放。 
系统对高低优先级业务定义的缺省示例如下： 
高优先级：语音业务。 
低优先级：数据业务。 
不受控消息：紧急业务。 
##### 配置方法 
启用CPU过负荷控制。 
[SET OVERLOADCFG](None):OLSWITCH="AMFOLSWITCHON"
设置CPU负荷等级，使用如下默认配置。 
[SET OLCPULEVELCFG](None):OL1THRESHOLD=90,OL2THRESHOLD=80,OL3THRESHOLD=70,OL4THRESHOLD=60
#### MME/SGSN CPU过负荷控制 
##### 应用场景 
系统过载时，通过入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定和高优先级业务成功率。 
##### 保护对象 
MME/SGSN 
##### 流控原理 
MME/SGSN CPU过载控制是MME/SGSN过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量的门限（超过门限外的其他话务量将被丢弃/拒绝，不再处理），来实现将CPU负荷控制在目标范围之内。 
图1  CPU过载控制
[]images/1616118426355.png)
CPU过载控制包括门限配置，分为高低两个控制门限及负荷区间。一般低负荷区间在75%~85%，高负荷区间在85%~100%。 
当系统CPU负荷超过低负荷控制门限（可配置）后，将启动CPU过载控制功能，此时对系统定义的低优先级消息/业务进行控制。 
当系统CPU负荷超过高负荷控制门限（可配置）后，将对系统定义的低优先级消息/业务，以及高优先级消息/业务同时进行控制。 
最终CPU过载控制的目标是将CPU负荷控制在一定区间以内（一般为70%~75%，可配置）。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
在消息优先级及业务优先级均为低时按低优先级处理，其他情况按高优先级处理。从而在控制话务的同时，能够尽力兼顾高优先级消息/业务的处理。 
系统对高低优先级消息定义的缺省示例如下： 
高优先级：位置更新，切换等。 
低优先级：附着，业务请求，专用承载建立等。 
不受控消息：分离，S1释放。 
系统对高低优先级业务定义的缺省示例如下： 
高优先级：语音业务。 
低优先级：数据业务。 
不受控消息：紧急业务。 
##### 配置方法 
使用默认配置。 
[SET OVERLOAD BASIC PARA](None)
#### AMF入向业务总量控制 
##### 应用场景 
无论系统是否过载，通过控制单位时间内通过的业务总量，来限制大话务业务量的输入对系统的冲击。 
##### 保护对象 
AMF 
##### 流控原理 
入向业务总量，指各个单项业务通过量按照权重（对CPU负荷的占用比例）累加，AMF入向业务总量控制区分为： 
N2口业务总量控制 
SBI业务总量控制 
AMF支持配置“每秒每实例N2口入向控制总量”和“每秒每实例SBI口入向控制总量”，以及各个单项业务的权重。 
各个业务处理实例将分别统计单位时间内N2口入向业务总量和SBI接口业务总量，对于单位时间内超过配置的入向业务将予以拒绝或丢弃。 
入向业务控制不考虑CPU是否拥塞，配置后立即生效，迅速限制大话务业务量的输入。 
##### 防御策略 
本功能一般用于网元设备升级、突发业务（比如大型赛事）等场景，网络中的话务量超过正常运行的话务量。 
除了默认开启的CPU过负荷控制功能外，也可以开启入向业务总量控制功能。事先获取本网元正常话务情况下的入向业务量和CPU负荷，再设置CPU负荷达到75%时允许的入向业务总量。 
##### 配置方法 
启用业务通过量负荷控制。 
[SET OVERLOADCFG](None):SRVSWITCH="SRVSWITCHON"
设置AMF Communication服务的入向业务总量控制。 
[SET OLTOTALNUMCFG](None)
#### MME/SGSN入向业务总量控制 
##### 应用场景 
无论系统是否过载，通过控制单位时间内通过的业务总量，来限制大话务业务量的输入对系统的冲击。 
##### 保护对象 
MME/SGSN 
##### 流控原理 
入向业务总量，指各个单项业务通过量按照权重（对CPU负荷的占用比例）累加，MME/SGSN的入向业务总量控制，包括MME入向业务总量控制和SGSN入向业务总量控制。 
MME/SGSN支持分别配置MME和SGSN的“每实例每秒通过业务最大个数”以及各个单项业务的权重。 
各个业务处理实例将分别统计单位时间内MME入向业务总量、SGSN入向业务总量，对于单位时间内超过配置的入向业务将予以拒绝或丢弃。 
入向业务控制不考虑CPU是否拥塞，配置后立即生效，迅速限制大话务业务量的输入。 
##### 防御策略 
本功能一般用于网元设备升级、突发业务（比如大型赛事）等场景，网络中的话务量超过正常运行的话务量。 
除了默认开启的CPU过负荷控制功能外，也可以开启入向业务总量控制功能。事先获取本网元正常话务情况下的入向业务量和CPU负荷，然后设置CPU负荷达到75%时允许的入向业务总量。 
##### 配置方法 
设置MME业务控制参数。SET MME SERVICE CONTROL 
设置SGSN业务控制参数。SET SERVICE CONTROL 
#### AMF入向业务单项控制 
##### 应用场景 
无论系统是否过载，通过控制单位时间内通过的各个单项业务量，来限制大话务业务量的输入对系统的冲击。 
##### 保护对象 
AMF 
##### 流控原理 
AMF支持入向业务单向控制，支持控制单位时间内N2接口和SBI接口的各个单项业务量的输入量。 
以Communication服务为例，N2接口支持被控制的单项业务包括： 
初次注册和周期性注册 
注册更新 
业务请求 
上行NAS转发 
切换 
上行NAS配置转发 
SBI接口支持被控制的单项业务量包括： 
PDU建立请求类型的N1N2转发 
PDU更新请求类型的N1N2转发 
DDN请求类型的N1N2转发 
对端是PCF的N1N2转发 
无UE的N2消息转发 
NF状态通知 
AMF支持配置各个单项入向业务的单位时间内的通过量，超过配置的业务将予以拒绝或丢弃。 
入向业务控制不考虑CPU是否拥塞，配置后立即生效，迅速限制大话务业务量的输入。 
##### 防御策略 
本功能一般用于网元设备升级场景，由于整局重启，导致初始接入的业务量远远超过正常业务量。 
除了默认开启的CPU过负荷控制功能外，也可以开启入向业务单项控制功能，通过限制每秒内初次注册的次数，来控制用户接入速率，避免对AMF设备的冲击。 
##### 配置方法 
启用业务通过量负荷控制。 
[SET OVERLOADCFG](None):SRVSWITCH="SRVSWITCHON"
设置Communication N2口业务单项控制。 
[ADD OLINPUTN2SRVCFG](None)
推荐配置如下： 
[ADD OLINPUTN2SRVCFG](None):SRVTYPE="REGISTRATION",OLMAXNUM=180,OLWEIGHT=50
[ADD OLINPUTN2SRVCFG](None):SRVTYPE="REGISTERUPDATE",OLMAXNUM=600,OLWEIGHT=50
（可选）设置Communication SBI业务单项控制，通常推荐不配置。 
[ADD OLINPUTSBISRVCFG](None)
#### MME/SGSN入向业务单项控制 


##### 应用场景 
无论系统是否过载，通过控制单位时间内通过的各个单项业务量，来限制大话务业务量的输入对系统的冲击。 


##### 保护对象 
MME/SGSN 


##### 流控原理 
MME/SGSN支持入向业务单向控制，支持控制单位时间内MME和SGSN的各个单项业务量的输入量。 
MME支持被控制的单项业务量包括： 

 
附着 

 
业务请求 

 
跟踪区更新 

 
切换 

 
PDN连接建立 

 
专用承载激活 

 
下行数据通知 

 
SGSN支持被控制的单项业务包括： 

 
附着 

 
业务请求 

 
路由器更新 

 
切换 

 
激活 

 
短消息 

 
MME/SGSN支持配置各个单项入向业务的单位时间内的通过量，超过配置的业务将予以拒绝或丢弃。 
入向业务控制不考虑CPU是否拥塞，配置后立即生效，迅速限制大话务业务量的输入。 


##### 防御策略 
本功能一般用于网元设备升级场景，由于整局重启，导致初始接入的业务量远远超过正常业务量。 
除了默认开启的CPU过负荷控制功能外，也可以开启入向业务单项控制功能，通过限制每秒内附着的次数，来控制用户接入速率，避免对MME/SGSN设备的冲击。 


##### 配置方法 

 
设置MME业务控制参数。SET MME SERVICE CONTROL 

 
设置SGSN业务控制参数。SET SERVICE CONTROL 

 


#### AMF NAS拥塞控制 
##### 应用场景 
支持区分业务的流量控制，避免单个业务占用过多系统资源。 
##### 保护对象 
AMF 
##### 流控原理 
当NAS接口某类型的业务输入过多时，AMF可以通过向UE发送拒绝消息并携带退避时长，请求UE在此时间内抑制请求消息的发送，从而有效减少业务输入并实现负荷控制。 
图1  AMF NAS拥塞控制
[]images/1616119783255.png)
##### 防御策略 
NAS拥塞控制功能一般在CPU过载控制功能之前生效，NAS拥塞控制功能尝试通过拒绝和抑制一部分比例UE的请求，从而尝试预防或阻止AMF负荷继续升高。NAS拥塞控制的具体启控门限取决于运营商要求，一般可以配置为综合话务模型50%~60%CPU负荷时的话务量。 
当系统实际话务量继续增长，达到CPU过载控制门限时（一般是70%~75%CPU负荷），AMF将进一步启动CPU过载控制机制。 
##### 配置方法 
需要对全类型业务控制时，配置基于NAS MM的拥塞控制。SET NASMMCONGESTINCFG:CONGESTIONSWITCH="SUPCONGESTIONCTRL",TYPE="MAXNASMM",MAXNASMM=1300TYPE参数设置为MAXNASMM，表示“NAS MM拥塞控制类型”为“接收NAS MM信令速率”。MAXNASMM参数为每实例支持的最大NAS MM信令接收速率，一般根据现场话务模型设置。 
需要对指定DNN业务进行控制时，配置基于DNN的拥塞控制。ADD DNNCONGESTIONCFG:CONGESTIONSWITCH="SUPDNNCONGESTIONCTRL",DNN="ims",TYPE="MAXRATE",MAXRATE=1000,MINDELAY=600,MAXDELAY=1800,REJECTRATE=100TYPE参数为“DNN拥塞控制类型”，默认设置为MAXRATE，表示“建立会话速率”。MAXRATE参数为每实例最大会话建立速率，一般根据现场话务模型设置。 
需要对指定切片业务进行控制时，配置基于SNSSAI的拥塞控制。ADD SNSSAICONGESTIONCFG:CONGESTIONSWITCH="SUPSNSSAICONGESTIONCTRL",SNSSAINAME="1",SST="eMBB",SD="100001",TYPE="MAXRATE",MAXRATE=400,MINDELAY=600,MAXDELAY=1800,REJECTRATE=100SNSSAINAME、SST、SD为SNSSAI值，根据现场情况配置。TYPE参数为“SNSSAI拥塞控制类型”，默认设置为MAXRATE，表示“建立会话速率”。MAXRATE参数为每实例最大会话建立速率。 
需要对指定DNN+切片业务进行控制时，配置基于SNSSAI和DNN的拥塞控制。ADD SNSSAIDNNCONGESTIONCFG:CONGESTIONSWITCH="SUPSNSSAIDNNCONGESTIONCTRL",SNSSAIDNNIDENTITY="1",SST="eMBB",SD="100001",DNN="ims",TYPE="MAXRATE",MAXRATE=400,MINDELAY=600,MAXDELAY=1800,REJECTRATE=100 
#### MME NAS拥塞控制 
##### 应用场景 
支持区分业务的流量控制，避免单个业务占用过多系统资源。 
##### 保护对象 
MME 
##### 流控原理 
当NAS接口某类型（RAT、APN）的业务输入过多时，MME可以通过向UE发送拒绝消息并携带退避时长，请求UE在此时间内抑制请求消息的发送，从而有效减少业务输入并实现负荷控制。 
##### 防御策略 
NAS拥塞控制功能一般在CPU过载控制功能之前生效，NAS拥塞控制功能尝试通过拒绝和抑制一部分比例UE的请求，从而尝试预防或阻止MME负荷继续升高。NAS拥塞控制的具体启控门限取决于运营商要求，一般可以配置为综合话务模型50%~60%CPU负荷时的话务量。 
当系统实际话务量继续增长，达到CPU过载控制门限时（一般是70%~75%CPU负荷），MME将进一步启动CPU过载控制机制。 
##### 配置方法 
基于接入类型进行NAS拥塞控制
打开基于RAT进行NAS拥塞控制的开关。 
[SET RAT CONGESTION SWITCH](None):SUPNBRATCON="YES"
设置针对NB-IoT接入的用户进行拥塞控制，拥塞控制类型为承载建立速率，拥塞控制的域值为承载建立速率100个每秒，超过此阈值后承载建立拒绝比例为100%，下发的拒绝消息中携带的backoff time时间为300秒到600秒之间的随机值。 
[ADD RAT CONGESTION POLICY](None):ACCESSTYPE="NB-IOT",CTLTYPE="RATE_BEARER_ACTIVATIONS",MAXRATE=100,REJECTRATE=100,BACKOFFTIMESTART=300,BACKOFFTIMEEND=600
基于APN进行拥塞控制时区分WB和NB-IoT分别控制
打开基于APN拥塞控制开关，对于用户NB-IoT RAT接入时，使用低接入优先级拥塞控制参数进行拥塞控制。 
[SET APN CONGESTION SWITCH](None):NBUSELPACAPN="USE"
设置对于APN为zte.com.nmnc001.mcc460.gprs建立的承载进行拥塞控制，拥塞控制类型为承载建立速率，拥塞控制的域值为承载建立速率100个每秒，超过此阈值后承载建立拒绝比例为100%，下发的拒绝消息中携带的backoff time时间普通用户为300秒到600秒之间的随机值，低优先级用户为600秒到1800秒之间的随机值。 
[ADD APN CONGESTION POLICY](None):APN="zte.com.nmnc001.mcc460.gprs",TYPE="BEARERRATE",PERIOD="SECOND",MAXRATE=100,MINDELAY=300,MAXDELAY=600,REJECTRATE=100,DEACTBEAR="NO",LOWMIN=600,LOWMAX=1800
基于MTC进行拥塞控制时区分WB和NB-IoT分别控制
打开基于MTC用户的MME网元拥塞控制开关，对于用户NB-IoT RAT接入时，使用低接入优先级拥塞控制参数进行拥塞控制。 
[SET MTCMME CONGESTION SWITCH](None):NBUSELPACMTC="USE"
设置对于签约MTC GroupID为460-01-1的用户进行拥塞控制，拥塞控制类型为接收NAS MM信令速率，拥塞控制的域值为最大接收NAS MM信令速率为100个每秒，超过此阈值后用户NAS MM信令拒绝比例为100%，下发的拒绝消息中携带的backoff time时间普通用户为300秒到600秒之间的随机值，低优先级用户为600秒到1800秒之间的随机值。 
[ADD MTCMME CONGESTION POLICY](None):MTCGRPID="460"-"01"-"1",TYPE="NASMMRATE",MAXNASMM=100,MINDELAY=300,MAXDELAY=600,REJECTRATE=100,DEACTBEAR="NO",LOWMIN=600,LOWMAX=1800
基于APN和MTC的组合进行拥塞控制时分NB-IoT和WB分别控制
打开基于MTC用户的APN拥塞控制开关，对于用户NB-IoT RAT接入时，使用低接入优先级拥塞控制参数进行拥塞控制。 
[SET MTCAPN CONGESTION SWITCH](None):NBUSELPACMTCAPN="USE"
设置对于签约MTC GroupID为460-01-1以及签约了zte.com的用户进行拥塞控制，拥塞控制类型为接收NAS MM信令速率，拥塞控制的域值为最大接收NAS MM信令速率为100个每秒，超过此阈值后用户NAS MM信令拒绝比例为100%，下发的拒绝消息中携带的backoff time时间普通用户为300秒到600秒之间的随机值，低优先级用户为600秒到1800秒之间的随机值。 
[ADD MTCAPN CONGESTION POLICY](None):MTCGRPID="460"-"01"-"1",APN="zte.com",TYPE="NASMMRATE",MAXNASMM=100,MINDELAY=300,MAXDELAY=600,DEACTBEAR="NO",LOWMIN=600,LOWMAX=1800
#### N2接口过载控制 
##### 应用场景 
AMF过载时，向gNodeB发送N2 Overload Start消息，对gNodeB输入的话务消息进行一定比例的控制，帮助AMF降低系统处理负荷并恢复正常状态。 
在AMF系统负荷恢复正常后，AMF向gNodeB发送N2 Overload Stop消息，告知gNodeB解除对话务的输入控制，恢复正常处理状态。 
##### 保护对象 
AMF 
##### 流控原理 
图1  过负荷控制执行 - N2 OVERLOAD START流程图
[]images/1616120545099.png)
过负荷控制执行 - N2 OVERLOAD START流程说明： 
AMF根据资源负荷等级判断，需要执行过负荷控制功能。 
AMF向gNodeB发送N2 OVERLOAD START消息，并携带AMF Overload Response参数，指示控制的话务类型，如拒绝非紧急及非高优先级终端发起的信令连接，只接受紧急业务、高优先级业务和终呼信令连接等；携带AMF
Traffic Load Reduction Indication参数，指示需要减少话务的百分比。 
gNodeB接收N2 OVERLOAD START消息后，根据携带参数执行相应控制，减少到此AMF的话务输出。 
图2  过负荷控制解除 - N2 OVERLOAD STOP流程图
[]images/1616120608263.png)
过负荷控制解除 - N2 OVERLOAD STOP流程说明： 
AMF根据资源负荷等级判断，需要解除之前已启动的过负荷控制功能。 
AMF向gNodeB发送N2 OVERLOAD STOP消息，指示gNodeB解除过负荷控制。 
gNodeB接收N2 OVERLOAD STOP消息后，解除过负荷控制，正常向此AMF进行话务输出。 
##### 防御策略 
当AMF因对输入的业务处理造成系统发生过载时，需要减少业务输入从而对系统负荷进行有效控制。 
对于N2接口，N2 Overload Control机制可以将AMF的过负荷情况告知给gNodeB，同时指示gNodeB减少某类型业务的输入。 
##### 配置方法 
开启过载控制。 
[SET OLTORANCFG](None):OLSWITCH="OLSWITCHON"
设置N2过负荷控制参数。 
[SET OLTORANBASICCFG](None)
#### S1接口过载控制 
##### 应用场景 
当MME负荷较高时，通过S1接口过载控制，限制部分eNodeB发给MME的业务，使MME的负荷稳定在一个正常的范围。 
##### 保护对象 
MME 
##### 流控原理 
图1  S1接口过载控制
[]images/1616120703740.png)
MME检测到本网元负荷过高时，选择部分eNodeB发送Overload Start消息。 
MME检测到本网元负荷恢复时，向已经发送Overload Start消息的eNodeB发送Overload Stop消息。 
##### 防御策略 
当MME因对输入的业务处理造成系统发生过载时，需要减少业务输入从而对系统负荷进行有效控制。 
对于S1接口，S1 Overload Control机制可以将MME的过负荷情况告知给eNodeB，同时指示eNodeB减少某类型业务的输入。 
##### 配置方法 
设置S1过载控制参数。 
[SET  MME OVERLOAD PARA](None)
#### Iu接口过载控制 
##### 应用场景 
SGSN在自身负荷较高时，通知对端降低发给本端的业务量，避免因本网元负荷过高导致设备异常或崩溃。
##### 保护对象 
SGSN 
##### 流控原理 
图1  Iu接口过载控制
[]images/1616120794885.png)
SGSN定时检测本端CPU负荷，如果CPU超过过负荷门限，则随机选择RNC发送Overload消息，支持发送消息的间隔时间可配置。 
##### 防御策略 
当SGSN因对输入的业务处理造成系统发生过载时，需要通知RNC网元减少接入到本端网元的业务量。 
##### 配置方法 
设置Iu过载控制参数。 
[SET OVERLOAD PARA](None)
#### 服务化接口过载控制 


##### 应用场景 
支持服务化接口的过载预防和过载控制，避免因服务化接口输入话务造成系统过载。 


##### 保护对象 
AMF 


##### 流控原理 
当AMF接近过载或进入过载状态后，可控制AMF对SMF/PCF网元执行SBI接口过载控制机制，从而抑制SMF/PCF对AMF的输入话务量，辅助实现AMF过载控制。 
图1  服务化接口过载控制


[]images/1616120872595.png)



##### 防御策略 
当AMF接近过载（门限可配置）状态时，可配置AMF对输入话务较多的SMF或PCF启动429控制机制，向实际话务输入较多（超过接收消息门限）的SMF或PCF回送429
Too Many Requests响应，并携带Retry-After头部（单位秒，头部示例：Retry-After: 60），指示其在此期间抑制向AMF发送请求消息，从而辅助AMF进行过载控制。 
当AMF进入过载（门限可配置）状态时，可配置AMF对输入话务较多的SMF或PCF启动503控制机制，向实际话务输入较多（超过接收消息门限）的SMF或PCF回送503
Service Unavailable响应，并携带Retry-After头部，指示其在此期间抑制向AMF发送请求消息，从而辅助AMF进行过载控制。 
当Retry-After头部指示的时间过后，接收429或503响应的SMF或PCF恢复正常的请求消息发送。 


##### 配置方法 


配置功能开关。 
[SET OVERLOADCFG](None):STATUSSENDSWITCH="STATUSSENDSWITCHON"
STATUSSENDSWITCH参数设置为STATUSSENDSWITCHON，表示该AMF启用状态码过载控制中的状态码发送功能，包括429和503。


配置状态码控制，示例如下。 
[SET GENERALSTATUSCODECFG](None):NFTYPE="SMF",MSGTHRESHOLD=2000,JUDGEPERCENT=50,CTRLTOPNUM=2,ONLY503="YES",MINRETRYAFTER=10,MAXRETRYAFTER=30

 
NFTYPE参数用于设置此NF类型相关的状态码控制参数，需要对SMF和PCF入向的状态码控制。 

 
MSGTHRESHOLD参数用于设置每秒每实例接收单个NF请求消息的门限。当接近过载和过载时，对于超过此门限消息数的NF，会综合判断是否执行429状态码过载控制。 

 
JUDGEPERCENT参数用于设置判定启动状态码控制的超消息数门限的实例数比例门限。当超过消息门限的实例数比例超过配置的比例门限时，对此NF启动状态码控制。 

 
CTRLTOPNUM参数表示：当过载时，对于未执行429状态码控制的NF，选择本网元接收消息最多的若干个NF执行503状态码过载控制，NF个数由本参数值确定。 

 
ONLY503参数表示：当过载时，在开关打开的情况下，对本应使用429状态码过载控制的NF执行503状态码过载控制。 

 
MINRETRYAFTER参数表示：当执行状态码过载控制时，429或503响应消息中携带Retry-After，此参数取值在Retry-After最小值与Retry-After最大值的范围内随机选择。该参数用于指示Retry-After的最小值。 

 
MAXRETRYAFTER参数表示：当执行状态码过载控制时，429或503响应消息中携带Retry-After，此参数取值在Retry-After最小值与Retry-After最大值的范围内随机选择。该参数用于指示Retry-After的最大值。 

 




#### S6a接口拥塞控制 
##### 应用场景 
S6a接口拥塞控制支持入向控制， MME和HSS业务交互过程中，MME为保护自身网元不被冲击，控制单位时间内HSS的业务消息数量，防止MME拥塞。 
##### 保护对象 
MME 
##### 流控原理 
S6a入向拥塞控制原理：MME设置单位时间内从S6a口接收的消息数量，用以控制HSS的入向消息，保护MME网元。 
图1  S6a接口拥塞控制
[]images/1616121112093.png)
##### 防御策略 
本功能防御手段主要是根据MME自身能力和负荷，设置S6a口入向消息速率，防止HSS发起的话务冲击。 
此功能默认未开启。 
##### 配置方法 
通过软参“MME和SGSN是否支持接口消息流控（0xc01e2）”开启接口消息流控。 
[SET SOFTWARE PARAMETER](None):PARAID=786914,PARAVALUE=1
设置S6a口入向消息速率控制。 
[SET INTERFACE MSG OVERLOAD](None)
#### GTP接口拥塞控制 
##### 应用场景 
由于网络故障或者节假日导致业务激增，或者周边网元引发相关GTP接口入向业务大量增加，导致MME负荷上升，MME拥塞后启动拥塞负荷控制，降低接入消息负荷，保障MME网元正常。 
##### 保护对象 
MME 
##### 流控原理 
GTP接口拥塞控制是指系统运行中，MME对自身进行拥塞负荷控制，控制入向消息量，同时在负荷拥塞时将负荷信息通知给SGW，在系统负荷允许的范围内通过尽量多的业务。进行负荷控制时，用户业务被拒绝后，通过重新尝试，可以逐渐平滑的接入网络。 
图1  GTP接口拥塞控制
[]images/1616121204545.png)
详细描述： 
基于APN和MTC用户进行入向拥塞控制，对S1口和GTP口进行流控。 
MME发生过负荷后，MME将过负荷信息通过SGW通知给PGW，由PGW根据过负荷信息，完成过负荷控制，降低到MME的专有承载建立/修改等业务负荷。 
MME发生过负荷后，MME在DDN响应消息中向SGW返回控制门限和延迟时间，由SGW完成对DDN消息的控制。 
对于UE的上行业务，MME在拒绝时，通过返回在一定范围内随机化的Back-Off Timer的方式，控制UE后继的业务重试，将业务洪峰离散化，使UE平滑接入。 
MME设置单位时间内从GTP接口接收的消息量，控制GTP接口入向消息量。 
##### 防御策略 
根据CPU负荷控制GTP口入向负荷，与S1口流控一起控制MME的负荷， CPU负荷流控默认开启。 
MME过负荷时，通过SGW向PGW发送过负荷信息，包括负荷时长和缩减比例。默认关闭。 
MME控制GTP接口上的入向消息速率，控制周边网元业务量增加导致MME负荷升高。默认关闭。 
根据需要开启对应的防御方法。 
##### 配置方法 
PGW负荷拥塞控制配置
基于APN和MTC用户的拥塞配置。 
基于APN的拥塞控制开关配置。 
[SET APN CONGESTION SWITCH](None)
APN拥塞控制策略配置。 
[ADD APN CONGESTION POLICY](None)
基于MTC用户的MME网元拥塞控制开关配置。 
[SET MTCMME CONGESTION
SWITCH](None)
MTC用户的MME网元拥塞控制策略配置。 
[ADD MTCMME CONGESTION POLICY](None)
基于MTC用户的APN拥塞控制开关配置。 
[SET MTCAPN CONGESTION SWITCH](None)
MTC用户的APN拥塞控制策略配置。 
[ADD MTCAPN CONGESTION POLICY](None)
下行数据通知延迟配置。 
[SET DDN DELAY](None)
设置MME到SGW/PGW的过负荷配置信息。 
[SET MME OVERLOAD INFO
TO GW](None)
GTP口S11/Sv/S10/Gn入向固定速率控制配置
通过软参“MME和SGSN是否支持接口消息流控（0xc01e2）”开启接口消息流控。 
[SET
SOFTWARE PARAMETER](None):PARAID=786914,PARAVALUE=1
设置GTP接口入向消息速率控制。 
[SET INTERFACE MSG OVERLOAD](None)
CPU负荷控制配置
设置CPU过负荷基本参数。 
[SET OVERLOAD BASIC PARA](None)
#### MAP接口拥塞控制 
##### 应用场景 
系统过载时，SGSN一方面通过Iu/Gb口的终端入向流控防止拥塞恶化造成整系统瘫痪，同时通过控制MAP口消息防止SGSN拥塞扩大，从SGSN网元两端保证业务稳定。 
##### 保护对象 
SGSN 
##### 流控原理 
MAP接口拥塞是根据CPU过载控制来实现的。SGSN综合评估CPU负荷及实际处理话务量的关系，通过动态调整MAP口入向话务量，实现将CPU负荷控制在目标范围之内。 
图1  MAP接口拥塞控制
[]images/1616121557099.png)
CPU过载控制包括门限配置，分为高低两个控制门限及负荷区间。一般低负荷区间在75%~85%，高负荷区间在85%~100%。 
最终CPU过载控制的目标是将CPU负荷控制在一定区间以内（一般为70%~75%，可配置）。 
##### 防御策略 
CPU负荷控制默认开启，是基础SGSN防御措施。在CPU负荷到达门限时，根据业务消息优先级对消息进行流控，在消息优先级及业务优先级均为低时按低优先级处理，其他情况按高优先级处理。从而在控制话务的同时，能够尽力兼顾高优先级消息/业务的处理。 
CPU负荷高时，SGSN根据CPU负荷控制MAP口周边网元始发的MAP对话消息。 
##### 配置方法 
设置CPU过负荷基本参数，使用默认配置。 
[SET OVERLOAD BASIC PARA](None)
### 周边网元过载保护 
#### AMF出向业务控制 


##### 应用场景 
AMF对发往RAN、SBI接口的业务量进行一定的限制，保护对方网元不会被冲击。 


##### 保护对象 
gNodeB、SMF等周边SBI接口的网元。 


##### 流控原理 
AMF支持对发往RAN和SBI接口的业务量，进行出向业务控制。 
AMF支持几个主要业务的“N2口出向业务每秒每实例最大通过量”和“SBI口出向业务每秒每实例最大通过量”配置。超过配置的业务将予以丢弃。 
以Communication服务为例，支持的N2口出向控制的业务包括： 

 
寻呼 

 
支持的SBI出向控制的业务包括： 

 
SM上下文建立 

 
UE鉴权 

 
UECM注册 

 
AM控制策略建立 

 
NF更新 

 
事件暴露通知 

 


##### 防御策略 
如果周边网元（比如UDM）处理能力较弱，可以设置出局的业务数量（比如UE鉴权的最大通过数），从而保障周边网元安全。 


##### 配置方法 


启用业务通过量负荷控制。 
[SET OVERLOADCFG](None):SRVSWITCH="SRVSWITCHON"


配置Communication N2口出向业务控制。 
[ADD OLOUTPUTN2SRVCFG](None)


配置Communication SBI出向业务控制。 
[ADD OLOUTPUTSBISRVCFG](None)




#### MME出向业务控制 


##### 应用场景 
MME对发往HSS、VLR的业务量进行一定的限制，保护对方网元不会被冲击。 


##### 保护对象 
HSS、VLR等 


##### 流控原理 
MME支持对发往Diameter局向和VLR局向的业务，进行基于局向的出向单项业务控制。 
MME支持配置通用Diameter局向、VLR局向的单位时间单项业务最大数目，和特定Diameter局向、VLR局向的单位时间单项业务最大数目。 
如果对端Diameter局向或VLR局向已经配置了特定局向出向业务控制，则采用该特定局向的单位时间单项业务最大数目作为控制门限，否则采用通用局向的单位时间单项业务最大数目作为控制门限。如果单位时间内发往该局向的业务量超过配置的最大业务量，则超过的业务将被丢弃。 
Diameter局向出向控制的业务包括： 

 
鉴权 

 
位置更新 

 
VLR局向出向控制的业务包括： 

 
位置更新 

 
起呼短消息 

 


##### 防御策略 
如果周边网元（比如HSS）处理能力较弱，可以设置出局到该网元的业务数量（比如鉴权的最大通过数），从而保障周边网元安全。 


##### 配置方法 

 
设置MME通用局向的出向业务控制。SET MME SERVICE CONTROL 

 
设置MME特定Diameter出向业务控制。ADD MME DIAMETER SERVICE
MAXIMUM/SET MME DIAMETER SERVICE MAXIMUM 

 
设置MME特定VLR出向业务控制。ADD MOLVLR/SET MOLVLR 

 


#### SGSN出向业务控制 
##### 应用场景 
SGSN对发往HLR、SMC的业务量进行一定的限制，保护对方网元不会被冲击。 
##### 保护对象 
HLR、SMC 
##### 流控原理 
SGSN支持对发往HLR局向和SMC局向的业务，进行基于局向的出向单项业务控制。 
SGSN支持配置通用HLR局向、SMC局向的单位时间单项业务最大数目，和特定HLR局向、SMC局向的单位时间单项业务最大数目。 
如果对端HLR局向或SMC局向已经配置了特定局向出向业务控制，则采用该特定局向的单位时间单项业务最大数目作为控制门限，否则采用通用局向的单位时间单项业务最大数目作为控制门限。如果单位时间内发往该局向的业务量超过配置的最大业务量，则超过的业务将被丢弃。 
HLR局向出向控制的业务包括： 
鉴权 
位置更新 
SMC局向出向控制的业务包括： 
短消息 
##### 防御策略 
如果周边网元（比如HLR）处理能力较弱，可以设置出局到该网元的业务数量（比如鉴权的最大通过数），从而保障周边网元安全。 
##### 配置方法 
设置SGSN通用局向的出向业务控制。SET SERVICE CONTROL 
设置SGSN特定局向出向业务控制。ADD SGSN OFFICE SERVICE MAXIMUM/SET SGSN OFFICE SERVICE MAXIMUM 
#### S6a接口自动流控 
##### 应用场景 
S6a接口自动流控是指周边HSS网元存在过载风险时，MME根据HSS网元返回成功应答数的周期变化自动调节Attach、Inter-MME TAU、Inter RAT Intra  TAU流程的处理速率，从而控制向HSS网元发送的请求数，达到保护HSS网元的目的。 
##### 保护对象 
DRA、HSS 
##### 流控原理 
MME根据DRA能力以及HSS能力，统一设置S6a口ALC（Analog Line Card模拟用户板）自动流控的初始控制门限、初始最大控制门限等自动流控参数，当业务达到控制条件后，控制S1口的Attach、Inter-MME TAU、Inter RAT Intra  TAU的业务消息速率，从而保护S6a口的DRA和HSS网元。 
图1  S6a接口自动流控
[]images/1616122024499.png)
图中： 
初始起控门限对应配置参数：触发拥塞的接入业务通过数量（单模块每秒） 
允许最大控制门限对应配置参数： 初始限制的接入业务最大数量（单模块每秒） 
控制原理： 
业务速率达到初始起控门限，并且HSS业务成功率低于设定值（85%）开始控制。 
业务速率达到初始最大起控门限，不管HSS业务成功率是多少， 立即起控。 
过了一个评判周期（15 s）后，业务负荷依然高，且HSS成功率高于设定值（85%），根据步长加大放通率。 
当加大放通率后，HSS成功率低于设定值（85%），下个周期根据步长降低放通率。 
后续如果业务负荷平稳，无流控，并且HSS成功率高于设定值（85%），持续设定时长后，解除本次拥塞流控。 
##### 防御策略 
S6a接口自动流控是重要的防御DRA和HSS拥塞的手段， 默认是开启，建议按开启处理。 
防御措施： 
评估出DRA和HSS的能力，取最小值，例如：3000 caps。 
根据业务SC数量算出每个SC的最大caps，如100个SC（模块），单SC最大caps为：3000/100 = 30 caps。 
设置[SET MME AUTO CNGCTL](None)命令中的对应参数：
初始限制的接入业务最大数量(单模块每秒)： 30 caps。 
触发拥塞的接入业务通过数量(单模块每秒)：30 caps ×（50%～60%） = 15 caps～20 caps。 
接入业务控制步长： 动态调整通过率步长。 
控制持续时间(分钟)： 没有流控时， 解除流控的保护时长。在该参数设定的时长超时后， 告警恢复。 
##### 配置方法 
配置的重要内容是评估出DRA、HSS的能力，并进行设置。 
通过MME自动业务控制配置，设置拥塞负荷控制参数。 
[SET MME AUTO CNGCTL](None)
#### Iu接口过载控制 
##### 应用场景 
RNC在自身负荷较高时，通知SGSN降低发给本端的业务量，避免因本网元负荷过高导致设备异常或崩溃。 
##### 保护对象 
RNC 
##### 流控原理 
RNC过载时，通过Overload消息通知SGSN。 
SGSN收到RNC的Overload消息时，开启TigOC、TinTC定时器，来维护对端RNC的过载step。 
TigOC定时器超时前如果继续收到该RNC的Overload消息，则忽略该消息。 
如果TigOC定时器超时但TinTC定时器未超时，收到该RNC的Overload消息，则step++，并重新启动TigOC、TinTC定时器。 
如果TinTC定时器超时，则step--。 
图1  RNC Congest Step
[]images/1616122613188.png)
当RNC的过载step不为0时，SGSN对该RNC进行网元过载控制，减少发往该RNC的寻呼、切换消息。 
##### 防御策略 
RNC过载时，会通知SGSN，SGSN减少发往该RNC的寻呼、切换消息。 
##### 配置方法 
设置Iu过载控制参数。 
[SET OVERLOAD PARA](None)
#### RNC/eNodeB无线拥塞控制 
##### 应用场景 
RNC/eNodeB在自身负荷较高时，通知PCRF降低发给本端的业务量，避免因本网元负荷过高导致设备异常或崩溃。 
##### 保护对象 
RNC、eNodeB 
##### 流控原理 
无线拥塞控制可以部署在无线侧，检测小区内的负载状态，上报拥塞现象报告，并依据下发的拥塞控制策略，预防或减轻拥塞现象。 
无线侧RNC/eNodeB检测小区负载状态，若发生拥塞现象，则会在上行的IuPS/S1-U的GTP-U消息里携带一个特殊的字段，这个字段指示发生了拥塞。 
SGSN/SGW把对应的表示拥塞的字段转发给GGSN/PGW，由PCEF向PCRF申请特定的预定义规则。 
无线侧RNC/eNodeB根据PCRF分配的拥塞控制规则对小区拥塞现象进行预防或处理。 
##### 防御策略 
需要端到端定制，默认关闭。 
##### 配置方法 
将“SGSN支持Iu口GTP-U扩展头”功能配置为开启。 
[SET SOFTWARE PARAMETER](None):PARAID=393267, PARAVALUE=1
#### 服务化接口过载控制 


##### 应用场景 
支持服务化接口的过载预防和过载控制，避免因服务化接口输出话务造成对端NF系统过载。 


##### 保护对象 
SMF、PCF、UDM等。 


##### 流控原理 
AMF接收到对端NF的429/503响应码，若其携带Retry-After头部（包含抑制时间），则在指定时间内AMF将抑制向此NF发送新的初始请求，帮助其恢复正常。在指定时间超时后，再恢复向此NF发送新请求。 
图1  服务化接口过载控制


[]images/1616122744358.png)



##### 防御策略 
当AMF接收到对端NF发送的429 Too Many Requests或503
Service Unavailable响应后，若其携带Retry-After头部（包含抑制时间），则在指定时间内AMF抑制向其发送请求消息，从而辅助对端NF进行负载/过载控制。 
控制过程中，若存在其他可选NF，则AMF尝试选择其他NF继续流程；若不存在其他可选NF，则AMF按本次流程失败处理。 
当Retry-After头部指示的时间超时后，AMF恢复正常的请求消息发送。 


##### 配置方法 
设置功能开关。 
[SET OVERLOADCFG](None):STATUSRECVSWITCH="STATUSRECVSWITCHON"
STATUSRECVSWITCH参数设置为STATUSRECVSWITCHON，表示该AMF启用状态码过载控制中的状态码接收处理，包括429和503。


#### S6a接口拥塞控制 


##### 应用场景 
S6a接口HSS过载时，HSS将负荷拥塞报告通知给MME，MME根据HSS的负荷拥塞报告进行出向负荷控制，从而控制到HSS的业务量，以保护HSS正常工作。 
DRA能力不足时，MME根据DRA能力设置S6a口出向消息的最大速率门限，保护S6a口周边网元（DRA、HSS）。 


##### 保护对象 
DRA、HSS 


##### 流控原理 


S6a接口过载控制是MME保护自身和周边网元的一种机制，MME根据HSS返回的负荷控制拥塞信息，根据负荷有效时长和缩减比例，控制到HSS的鉴权和位置更新的消息量，从而保护HSS网元。 
[]images/1616122839162.png)


MME根据DRA能力设置S6a口出向消息的最大速率门限，保护S6a口周边网元。 
[]images/1616122853765.png)




##### 防御策略 


MME收到HSS的消息，消息中携带负荷拥塞信息，MME根据消息中携带的过负荷有效时长和缩减百分比进行业务控制。默认关闭。 


DRA发生拥塞的场景，根据DRA能力设置S6a口出向消息的最大速率门限进行防御。默认关闭。 


根据实际判断打开开关。 


##### 配置方法 
携带OC-Supported-Features和OC-OLR，通知MMEHSS发生拥塞，MME进行负荷控制配置


License项“MME支持HSS过负荷控制功能”为“支持”。 


开启HSS过负荷控制功能，设置back-off timer。 
[SET HSS OVERLOAD
CONTROL](None)


通过软参“diameter对端指示too busy过载业务缩减百分比率（262572）”，配置缩减百分比。 
[SET SOFTWARE PARAMETER](None)


通过软参“diameter对端指示too busy过载时长（262573）”，配置过载持续时长。 
[SET SOFTWARE PARAMETER](None)


根据DRA能力设置S6a口出向消息的最大速率门限


通过软参“MME和SGSN是否支持接口消息流控（0xc01e2）”开启接口消息流控。 
[SET
SOFTWARE PARAMETER](None):PARAID=786914,PARAVALUE=1


设置S6a接口出向消息速率控制。 
[SET INTERFACE MSG OVERLOAD](None)




#### GTP接口拥塞控制 
##### 应用场景 
由于网络故障或者节假日导致业务激增，导致MME发往周边GTP接口网元的消息量急剧增加，导致周边SGW/PGW发生负荷拥塞，MME启动出向拥塞负荷控制，降低接入消息负荷，保障周边GTP接口网元正常。 
##### 保护对象 
SGW/PGW 
##### 流控原理 
GTP出向负荷控制为了保护MME周边GTP接口网元，指系统运行中，SGW/PGW在负荷拥塞时，将负荷拥塞信息通知MME，MME根据有效时长和缩减百分比进行入向业务消息控制，拒绝用户业务，并携带backoff
time，使用户逐渐平滑的接入网络，有效保障SGW/PGW网元安全。 
图1  GTP接口拥塞控制
[]images/1616122972842.png)
SGW/PGW拥塞控制SGW网元过负荷控制用户业务急剧增加，引发SGW短时间内突发大量的业务，发生过负荷。SGW过负荷后，将序列号、有效时长和减少百分比等信息通知MME。MME根据有效时长、减少百分比、业务的优先级，减少到该SGW的业务负荷。PGW网元的网元级过负荷控制用户业务急剧增加，引发PGW短时间内突发大量的业务，发生过负荷。PGW过负荷后，将序列号、有效时长和减少百分比等过负荷信息通过SGW通知MME。MME根据有效时长、减少百分比、业务的优先级，减少到该PGW的业务负荷。PGW网元的APN级过负荷控制PGW为不同的APN分配不同的可用资源，某个APN引发短时间内突发大量的业务，造成该APN资源不足发生过负荷，MME根据PGW返回的APN拥塞策略继续控制：PGW将包含APN、序列号、有效时长和减少百分比等信息的过负荷信息通知MME，MME根据有效时长、减少百分比、业务的优先级，减少到该PGW上该APN的业务负荷。PGW收到该APN的创建会话请求后返回拒接，携带“APN拥塞”的拒绝原因，以及back-off time。MME收到后，在back-off
time内，该APN的PDN链接建立时不再选择此PGW。上述两种方式，同一时间只有一种生效。 
GTP口固定速率控制MME根据S11/Sv/S10/Gn口网元能力设置GTP口出向消息的最大速率门限，保护S11/Sv/S10/Gn口周边网元。 
##### 防御策略 
根据SGW和PGW负荷拥塞信息，MME根据业务优先级控制入向PDN建立等业务消息，降低SGW/PGW的负荷。默认关闭。 
MME根据S11/Sv/S10/Gn口网元能力设置GTP口出向消息的最大速率门限，保护S11/Sv/S10/Gn口周边网元。默认关闭。 
根据实际情况开启对应的防御方法。 
##### 配置方法 
SGW/PGW负荷拥塞控制配置
SGW过负荷控制配置。修改SGW过负荷控制参数，包括功能开关，以及SGW过负荷时NAS拒绝消息中携带的Back-off
Timer的范围。 
[SET SGW OVERLOAD CONTROL](None)
PGW过负荷控制配置。修改PGW过负荷控制参数，包括功能开关，以及PGW过负荷时NAS拒绝消息中携带的Back-off
Timer的范围。 
[SET PGW OVERLOAD CONTROL](None)
GTP口S11/SV/S10/Gn网元出向固定速率控制配置
通过软参“MME和SGSN是否支持接口消息流控（0xc01e2）”开启接口消息流控。 
[SET
SOFTWARE PARAMETER](None):PARAID=786914,PARAVALUE=1
设置GTP接口出向消息速率控制。 
[SET INTERFACE MSG OVERLOAD](None)
#### MAP接口拥塞控制 
##### 应用场景 
由于网络故障引发大量UE重新附着，或者因节假日业务激增等原因，引发MAP口HLR短时间内突发大量的业务，发生过负荷。 
由于节假日等原因，终端集中发送短信，造成短信风暴，引发短消息中心信令风暴。 
##### 保护对象 
HLR、SMS-GMSC/SMS-IWMSC 
##### 流控原理 
MME根据STP、HLR、SMS接口网关能力设置MAP口出向消息的最大速率门限，保护MAP口周边网元。 
图1  MAP接口拥塞控制
[]images/1616123305781.png)
##### 防御策略 
STP发生拥塞的场景根据STP能力设置全局MAP口鉴权、位置更新、短消息的最大速率门限，进行MAP口出向消息防御。默认65525（等同未开启）。 
HLR/SMS-GMSC/SMS-IWMSC发生拥塞的场景根据对应局向能力设置对应局向的鉴权、位置更新、短消息的最大速率门限，进行对应局向出向消息防御。默认未配置数据。 
根据实际判断进行配置。 
##### 配置方法 
全局MAP出向拥塞控制。配置通用业务控制，即配置全局MAP口出向控制参数，包括：HLR鉴权最大数目、 HLR位置更新最大数目 、SMC短消息最大数目。SET SERVICE CONTROL 
分局向MAP出向拥塞控制。配置SGSN特定局向业务控制，即配置分局向MAP口出向控制参数，包括：HLR鉴权最大数目、 HLR位置更新最大数目 、SMC短消息最大数目。ADD SGSN OFFICE SERVICE MAXIMUM 
#### 信令拥塞控制 
##### 应用场景 
按照信令链路拥塞情况，限制信令接口的业务通过量，保护信令链路。 
##### 保护对象 
AMF/MME/SGSN和对方网元之间的信令链路。 
##### 流控原理 
AMF、MME、SGSN根据信令链路是否拥塞，动态调整该信令链路上的出向业务话务量门限（超过门限的其他话务量将被丢弃，不再处理），来实现该信令链路不会完全“堵死”。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
AMF或MME局点，执行ADD SIGLOADCTRL命令，其中“负荷控制类型”为“SCTP”，“发送拥塞流控”参数为“打开”。 
SGSN局点，执行ADD SIGLOADCTRL命令，其中“负荷控制类型”为“SCCP”，“发送拥塞流控”参数为“打开”。 
AMF、MME和SGSN融合局点，执行两次ADD SIGLOADCTRL命令，其中“负荷控制类型”分别为“SCTP”和“SCCP”，“发送拥塞流控”参数都为“打开”。 
### 无效信令抑制 
#### AMF UE异常信令管控 
##### 应用场景 
终端由于网络或者自身的原因，无法获取正常的网络服务，从而尝试不停触发信令业务。 
##### 保护对象 
AMF 
##### 流控原理 
当大批量的用户陷入这种异常行为时，将会产生大量的业务信令，触发信令风暴，造成网络拥塞。为了避免这种情况产生，网络需要提前识别异常行为的用户，并采取诸如黑名单管控、虚假网络服务等措施，以减少用户无效而频繁的信令业务。 
##### 防御策略 
针对终端异常行为，AMF启用基于UE粒度的异常信令管控功能，使用默认参数配置，对用户注册、业务请求、PDU会话建立三种信令业务进行异常行为管控。 
##### 配置方法 
启用异常信令管控功能。 
[SET ABNORMALSIGMCPOLICY](None):SUPPORTSIGCTRL="YES"
设置异常信令管控参数，使用默认值。 
[SET ABNORMALSIGMCCONFIG](None)
#### MME UE异常信令管控 
##### 应用场景 
终端由于网络或者自身的原因，无法获取正常的网络服务，从而尝试不停触发信令业务。 
##### 保护对象 
MME 
##### 流控原理 
当大批量的用户陷入这种异常行为时，将会产生大量的业务信令，触发信令风暴，造成网络拥塞。为了避免这种情况产生，网络需要提前识别异常行为的用户，并采取诸如黑名单管控、虚假网络服务等措施，以减少用户无效而频繁的信令业务。 
##### 防御策略 
MME异常信令管控，具体包括附着请求异常信令管控、业务请求异常信令管控和PDN连接建立异常信令管控。 
MME在各信令的每个统计周期内统计各信令数，如果统计的信令数大于配置的对应信令的最大信令数，则MME将用户加入信令黑名单，并启动黑名单定时器。 
在信令黑名单定时器管理时间内，MME拒绝或丢弃信令；或MME建立FAKE APN PDN连接，用户使用此PDN连接无法上网。 
信令黑名单定时器超时后，用户从信令黑名单被移除，可以正常上网。 
##### 配置方法 
启用异常信令管控功能。 
[SET SIGSRESTRAIN FLAG](None):FLAG="YES"
设置异常信令管控参数：虚假APN取决于运营商规划，其他管控参数取默认值。 
[SET SIGSRESTRAIN](None):FAKEAPN="fake.apn"
#### SGSN UE异常信令管控 
##### 应用场景 
终端由于网络或者自身的原因，无法获取正常的网络服务，从而尝试不停触发信令业务。 
##### 保护对象 
SGSN 
##### 流控原理 
当大批量的用户陷入这种异常行为时，将会产生大量的业务信令，触发信令风暴，造成网络拥塞。为了避免这种情况产生，网络需要提前识别异常行为的用户，并采取诸如黑名单管控、虚假网络服务等措施，以减少用户无效而频繁的信令业务。 
##### 防御策略 
SGSN异常信令管控，具体包括附着请求异常信令管控、业务请求异常信令管控和PDP激活异常信令管控。 
SGSN在各信令的每个统计周期内统计各信令数，如果统计的信令数大于配置的对应信令的最大信令数，则SGSN将用户加入信令黑名单，并启动黑名单定时器。 
在信令黑名单定时器管理时间内，SGSN拒绝或丢弃信令；或SGSN建立FAKE APN PDP，用户使用此PDP连接无法上网。 
信令黑名单定时器超时后，用户从信令黑名单被移除，可以正常上网。 
##### 配置方法 
启用异常信令管控功能。 
[SET SGSN SIGSRESTRAIN FLAG](None):FLAG="ON"
设置异常信令管控参数：虚假APN取决于运营商规划，其他管控参数取默认值。 
[SET SGSN SIGSRESTRAIN](None):FAKEAPN="fake.apn"
## SMF/GW-C流控 
网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行，需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 
SMF/GW-C提供自保流控及周边网元过载保护多套解决方案，对信令风暴进行综合治理。 
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|基于业务的自保流控|基于CPU过负荷入向流控|在服务组件上根据CPU负荷情况对各类业务限制一定的通过率，保护CPU不会冲高 。|是|默认开启
4G基于GTP-C入向流控|自保流控|基于业务的自保流控|4G基于GTP-C入向流控包含如下四种方案：PGW/SGW基于业务通过数的流控PGW携带节点级OCI给MME功能PGWJ基于APN流控，携带back-off time(仅GTPv2接入)SGW携带节点级OCI给MME/SGSN /PGW功能|否|4G基于GTP-C入向流控的配置方法
4G基于QoS接纳控制|自保流控|基于业务的自保流控|4G基于QOS接纳控制包含如下两种方案：基于ARP、CPU占用率执行接纳控制基于ARP、CPU占用率执行抢占|否|4G基于QoS接纳控制的配置方法
5G基于消息入向流控|自保流控|基于业务的自保流控|5G基于消息入向流控包含如下三种方案：基于NAS消息通过速率的过负荷控制基于会话创建消息通过速率的过负荷控制基于会话创建总量的过负荷控制的过负荷控制|否|5G基于消息入向流控的配置方法
基于接口的自保流控|自保流控|5G基于接口入向流控|网元自身过载时通知N11/N10/N7接口周边网元流控，以保护网元自身。|否|5G基于接口入向流控的配置方法
周边网元过载保护|基于业务的周边网元过载保护|4G基于GTP-C出向流控|PGW基于MME/SGSN/SGW周边网元反馈携带的OCI进行实时流控，以保护周边网元。|否|4G基于GTP-C出向流控的配置方法
4G DDN信令抑制|周边网元过载保护|基于业务的周边网元过载保护|SGW根据基于MME反馈的DDN Throttling，进行DDN消息节流。|否|4G DDN信令抑制的配置方法
基于接口的周边网元过载保护|周边网元过载保护|5G基于接口出向流控|基于向AMF/UDM/PCF/NRF发出的流量进行实时流控，以保护周边网元。|否|5G基于接口出向流控的配置方法
4G基于网元出向流控|基于接口的周边网元过载保护|周边网元过载保护|基于向SGW/PCRF/OCS/CG发出的流量进行实时流控，以保护周边网元。|否|4G基于网元出向流控的配置方法
### 自保流控 
#### 基于业务的自保流控 
##### 基于CPU过负荷入向流控 
###### 应用场景 
系统过载时，SMF/GW-C通过入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定和高优先级业务成功率。
###### 保护对象 
SMF/GW-C
###### 流控原理 
CPU过载控制是SMF/GW-C过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），将CPU控制在目标范围之内。CPU过载控制分为过载区、目标控制区和正常负荷区三个区间。
CPU负荷过载区：系统指定的CPU负荷过大的区间，可以通过SET OL_LEVEL_CPU命令进行配置。 
CPU负荷目标控制区：正常负荷区和过载区之间的区域，也可被视为过载区和正常负荷区之间的一个缓冲区。 
CPU正常负荷区：目标控制区以下的区域为CPU负荷正常区域。 
流控示意图如[图1](1615537544707.html#zbfe0bffa85444786b5c693df4d9e3252__d71f520a-03c4-4c41-a376-8dc359356453)所示。
图1  CPU过载控制
[]images/1616990134947.png)
SMF/GW-C中将系统的负荷状况分为四级负荷、三级负荷、二级负荷、一级负荷四级： 
负荷等级|CPU利用率|控制策略
---|---|---
一级负荷|90%|对高、低优先级消息均进行控制
二级负荷|85%|对低优先级消息进行控制
三级负荷|80%|进行过负荷告警，但业务通过率不变
四级负荷|75%|进行过负荷告警，但业务通过率不变
当系统的负荷状态到达某个级别区间时，系统会根据配置的处理策略对收到的请求类消息进行随机拒绝处理，响应类消息不做控制。CPU负荷越高，消息被拒绝的概率越高。 
SMF/GW-C中的过负荷控制原理是通过二分法动态调整业务，控制周期允许通过的业务（新建或刷新）流程数，具体算法如下： 
到达评价周期时，如达到过负荷状态，则需要往下调整允许通过数 = {high值（将上一周期通过数作为high值）+low值（低值初始为保证通过数，low值为固定值）}/
2。 
到达评价周期时，如不在过负荷状态且仍然丢包，则需要往上调整允许通过数 ={low值（将上一周期通过数作为low值）+high值（高值的初始值为第一次过负荷时的通过数，high值为固定值）}
/ 2。 
到达评价周期时，如不在过负荷状态且无丢包，则允许通过数不变。 
###### 防御策略 
本功能默认开启，并推荐使用默认配置。在消息优先级及业务优先级均为低时按低优先级处理，其他情况按高优先级处理，从而在控制话务的同时，能够尽力兼顾高优先级消息/业务的处理。 
系统对高优先级消息定义缺省示例：更新类消息 
系统对低优先级消息定义缺省示例：创建类消息 
系统对不识别的消息定义缺省示例：释放类消息 
 说明： 
对于紧急呼叫不进行控制。 
###### 配置方法 
打开CPU过负荷告警通知，打开业务拥塞控制，关闭业务通过数门限控制，修改控制周期为1 s(单位100 ms)，评估周期与控制周期比值为5，CPU采样周期为10
s(单位2 s)，CPU负荷缓冲区为5%。 
[SET OVERLOAD_CFG](None):OL_SWITCH=ENABLE,OL_ALARM_SWITCH=ALL,SRV_SWITCH=DISABLE,CONTROL_CYCLE=10,JUDGE_RATIO=5,SAMPLE_CYCLE=5,RECOV_BUFF=5
配置CPU拥塞控制各负荷等级对应的CPU利用率区间。 
[SET OL_LEVEL_CPU](None):OL1_THRESHOLD=100,OL2_THRESHOLD=90,OL3_THRESHOLD=85,OL4_THRESHOLD=80,OL5_THRESHOLD=75
修改业务通过数门限。 
[SET OVERLOAD_SRV](None):NEW_SRV_MAXNUM=700
配置5G CPU过负荷退避时间。 
[SET CONGESTIONCFG5G](None):MINDELAY=10,MAXDELAY=100
##### 4G基于GTP-C入向流控 


###### 应用场景 
系统过载时，GW-C通过入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定和高优先级业务成功率。 


###### 保护对象 
PGW-C、SGW-C 


###### 流控原理 
GTP-C拥塞控制包括以下几个方面： 

 
PGW/SGW基于业务通过数的流控，根据新建和更新类消息通过量控制新建和更新消息。 

 
PGW业务量超过拥塞阈值，即CPU负荷时，通过在发给SGW的消息中携带OCI信元，SGW再透传给MME的方式，通知MME减少消息发送量。 

 
SGW业务量超过拥塞阈值，即CPU负荷时，通过在发给MME和PGW的消息中携带OCI信元的方式，通知MME和PGW减少消息发送量。 

 
PGW基于某个APN的接入速率以及APN的最大承载数超过配置的门限值时，做过负荷控制处理（丢消息），并携带back-off
time(仅GTPv2接入)给SGW，再透传至MME。 

 


###### 防御策略 
不区分消息类型，无特殊策略。 


###### 配置方法 


打开业务通过数门限控制。 
[SET OVERLOAD_CFG](None):SRV_SWITCH=ENABLE


配置业务通过数门限控制。修改新建类业务的最大允许通过量及更新类业务的最大允许通过量，并分别设置两类业务的权重。 
[SET OVERLOAD_SRV](None): NEW_SRV_MAXNUM=40000,UPDATE_SRV_MAXNUM=50000,NEW_SRV_WEIGHT=2,UPDATE_SRV_WEIGHT=1,MAX_TOTALNUM=1000000


开启SGW GTP-C过负荷控制开关。 
[SET SGWGTPCOVERLOADCTL](None):CFGSWITCH="ENABLE"


开启PGW GTP-C过负荷控制开关。 
[SET PGWGTPCOVERLOADCTL](None):CFGSWITCH="ENABLE"


配置OCI控制信息策略，新增SGW过负荷控制策略。设置CPU负荷门限，ORM（Overload Reduction Metric）值，以及终端退避时间。 
[ADD SGWOCIPOLICY](None):LOADTHRESHOLD=60,ORM=40,OCIUNIT="_1H",OCIVALUE=3


配置OCI控制信息策略，新增PGW过负荷控制策略。设置CPU负荷门限，ORM（Overload Reduction Metric）值，以及终端退避时间。 
[ADD PGWOCIPOLICY](None):LOADTHRESHOLD=60,ORM=40,OCIUNIT="_1H",OCIVALUE=3


修改APN/DNN过负荷控制门限配置。
[SET APNDNNBASIC](None):NAME="zte",BACKOFFUNIT="2s",BACKOFFTIME="5",MAXBEARACTRATE="5000",MAXBEARNUM="4000000"




##### 4G基于QoS接纳控制 
###### 应用场景 
在系统资源受限时，可以开启本功能保证高优先级用户的接入成功率。 
###### 保护对象 
PGW-C、SGW-C 
###### 流控原理 
4G基于QoS接纳控制包括基于ARP、CPU占用率执行接纳控制和执行抢占两部分。
基于ARP、CPU占用率执行接纳控制：按ARP中的PL把承载分为高、中、低三个等级，通过SET ARPPLMAP命令配置PL和承载等级的对应关系。针对每个等级，配置对应的允许接入的CPU利用率。默认承载和专有承载建立时，根据ARP中的PL值和配置策略将承载划分为高、中、低三类，获取CPU利用率门限以及当前的CPU利用率，若当前CPU利用率超出门限，则拒绝承载的建立。 
基于ARP、CPU占用率执行抢占：当整个系统或接入的APN中无可用资源，即没有空闲上下文空间时，可以通过SET ARPACCESSCONTROL命令配置启用抢占功能，即高优先级承载可以抢占低优先级的承载的上下文空间，低优先级承载将会被强制删除。 
###### 防御策略 
本功能默认关闭。开启本功能后，可以通过以下方式进行防御： 
高优先级承载可以抢占低优先级的承载的上下文空间。 
低优先级承载将会被强制删除。 
###### 配置方法 
当基于ARP、CPU占用率执行接纳控制时，配置ARP接纳控制策略。开启APP接纳控制开关及承载抢占开关，设置CPU利用率负荷门限。SET ARPACCESSCONTROL:FUNCTION="ENABLE",BEARPREEMPTABLE="ENABLE",CPULOWLOADGATE=65,CPUMIDDLELOADGATE=75,CPUHIGHLOADGATE=85 
当基于ARP、CPU占用率执行抢占时，配置PL到承载等级映射，修改PL映射承载等级。SET ARPPLMAP:ARPPRIORITYLEVEL=1,BEARERLEVEL="LOW" 
##### 5G基于消息入向流控 
###### 应用场景 
在话务量高峰时期或者话务模型异常畸变（如重大节日导致的话务量飙升等）、以及与SMF对接的设备性能严重不匹配的场景下，需要启用本功能保证用户的正常接入。 
###### 保护对象 
SMF 
###### 流控原理 
5G基于消息入向流控可分为基于NAS消息、基于会话创建消息和通过会话创建总量的过负荷控制。 
基于NAS消息通过速率的过负荷控制。使用令牌桶算法进行速率限制。控制创建、更新请求消息。 
基于会话创建消息通过速率的过负荷控制。使用令牌桶算法进行速率限制。仅控制会话创建消息。 
基于会话创建总量的过负荷控制。会话创建总量指最大建立会话数。仅控制会话创建消息。 
###### 防御策略 
本功能默认关闭。 
5G拥塞控制的优先级如下： 
CPU的过负荷控制 > NAS消息通过速率的过负荷控制 > 会话创建消息通过速率的过负荷控制 > 会话创建总量的过负荷控制 > 服务化接口消息通过速率的过负荷控制 
###### 配置方法 
修改过负荷控制配置。打开5G NAS拥塞控制开关，修改5G拥塞控制全局配置。5G过负荷拥塞控制方式为切片联合DNN模式（支持四种模式：CLOSE/SLICE_DNN/SLICE/DNN）。 
[SET CONGESTIONCFG5G](None):CONSWITCH="SLICE_DNN"
新增拥塞控制配置。配置只控制会话建立请求，不填写429响应码，新增切片ST为EMBB，SD为123456，DNN为cmnet。配置最大会话数为100（整局），最大会话速率为200个每秒（整局），最大接收NAS信令速率为300tps，最小退避时间为600s，最大退避时间为1800s，拒绝门限为80%，拒绝率为20%。其余参数为默认配置。 
[ADD CONCFG5G](None):ESTASWITCH="true"RSPSWITCH="false",SNSSAISST="EMBB",SNSSAISD="123456",DNN="cmnet",MAXSESSION=100,MAXRATE=200,MAXNASSM=300,MINDELAY=600,MAXDELAY=1800,REJECT_THRESHOLD="80",REJECT_RATE="20"
#### 基于接口的自保流控 
##### 5G基于接口入向流控 
###### 应用场景 
在话务量高峰时期或者话务模型异常畸变（如重大节日导致的话务量飙升等）、以及与SMF对接的设备性能严重不匹配的场景下，需要启用本功能保证用户的正常接入。 
###### 保护对象 
SMF 
###### 流控原理 
5G基于接口入向流控基于服务化接口的消息通过速率，使用令牌桶算法进行速率限制，控制N11、N10、N7接口的入向消息。 
###### 防御策略 
本功能默认关闭。 
5G拥塞控制的优先级如下： 
CPU的过负荷控制 > NAS消息通过速率的过负荷控制 > 会话创建消息通过速率的过负荷控制 > 会话创建总量的过负荷控制 > 服务化接口消息通过速率的过负荷控制 
###### 配置方法 
配置5G服务化接口最大收发消息。 
新增SMF服务化接口最大收发消息配置，接口类型为N11，入向请求消息的速率为1000tps(整局速率，实际根据该局的能力配置)，控制update信令开关为“关闭”。ADD MMR:INTERFACE="N11",INRATE=1000,CTRLUPT="DISABLE" 
新增SMF服务化接口最大收发消息配置，接口类型为N10，入向请求消息的速率为1000tps，控制update信令开关为“关闭”。ADD MMR:INTERFACE="N10",INRATE=1000,CTRLUPT="DISABLE" 
新增SMF服务化接口最大收发消息配置，接口类型为N7，入向请求消息的速率为1000tps，控制update信令开关为“关闭”（开启N7拥塞控制功能后，可能造成用量统计丢失）。ADD MMR:INTERFACE="N7",INRATE=1000,CTRLUPT="DISABLE" 
### 周边网元过载保护 
#### 基于业务的周边网元过载保护 
##### 4G基于GTP-C出向流控 
###### 应用场景 
在话务量高峰时期或者话务模型异常畸变（如重大节日导致的话务量飙升等）、以及与GW-C对接的设备性能严重不匹配的场景下，需要启用本功能保证用户的正常接入。 
###### 保护对象 
MME/SGW-C 
###### 流控原理 
PGW向SGW发送专有承载建立/更新请求消息时，比较MME、SGSN和SGW的OCI中的ORM（Overload Reduction Metric，过载减少指标），取最大值ORM对应的OCI(包括OCSN、ORM、PoV)，在PoV（Period of Validity，有效期间）时间内，按照ORM进行消息节流。如果收到的OCI变化，则取最大值ORM对应的OCI重置PoV进行消息节流。
###### 防御策略 
本功能默认关闭，只控制专有承载创建和更新消息。 
###### 配置方法 
配置GTP-C流控控制开关。 
[SET PGWGTPCOVERLOADCTL](None):CFGSWITCH="ENABLE"
##### 4G DDN信令抑制 
###### 应用场景 
当运营商部署的现网业务中有大量下行寻呼流程时，可能对MME网元造成信令冲击，导致其过负荷。此时需要对下行数据通知信令进行抑制。 
###### 保护对象 
MME 
###### 流控原理 
SGW-U收到IDLE用户的下行数据，触发下行数据寻呼流程。 
MME回复给SGW-C的Downlink Data Notification Acknowledge消息中携带throttling，指示SGW-C对低优先级用户进行下行寻呼消息截流，并对发送给当前指示截流的MME的下行寻呼消息进行测速。 
SGW-C根据下行寻呼消息速度，按照令牌桶算法进行截流，取到令牌的寻呼消息则会发送给MME。若未取到令牌，则丢弃消息，同时清除用户缓存的下行报文。 
 说明： 
若Throttling Delay到期，则不进行DDN节流。 
###### 防御策略 
不区分消息类型，无特殊策略。 
###### 配置方法 
开启SGW GTP-C过负荷控制开关。 
[SET SGWGTPCOVERLOADCTL](None):CFGSWITCH="ENABLE"
配置GTP-C流控控制开关，修改低优选级流控配置。 
[SET LOWPRIORTHROT](None):CFGSWITCH="ENABLE",PL=5
#### 基于接口的周边网元过载保护 
##### 5G基于接口出向流控 
###### 应用场景 
在话务量高峰时期或者话务模型异常畸变（如重大节日导致的话务量飙升等）、以及与SMF对接的设备性能严重不匹配的场景下，需要启用本功能保证用户的正常接入。 
###### 保护对象 
周边NF（AMF/CHF/UDM/PCF/NRF等） 
###### 流控原理 
5G基于接口出向流控是基于服务化接口消息通过速率的过负荷控制。使用令牌桶算法进行速率限制。用于控制N11接口、N10接口、N7接口和NRF的出向消息，不支持N40接口。 
###### 防御策略 
本功能默认关闭。开启后，5G基于接口出向流控对各接口出向消息的控制优先级分类举例如下。 
优先级|消息类型
---|---
高优先级|N11接口：会话更新消息N7接口：会话更新消息
低优先级|N11接口：新建会话建立消息、承载建立消息N7/N10接口：初始消息
不受控消息|N11接口：会话释放消息N7/N10接口：会话释放消息
###### 配置方法 
配置5G服务化接口最大收发消息。 
新增SMF服务化接口最大收发消息配置，接口类型为N11，出向请求消息的速率为1000tps（全局），控制update信令开关为“关闭”。ADD MMR:INTERFACE="N11",OUTRATE=1000,CTRLUPT="DISABLE"、 
新增SMF服务化接口最大收发消息配置，接口类型为N10，出向请求消息的速率为1000tps（全局），控制update信令开关为“关闭”。ADD MMR:INTERFACE="N10",OUTRATE=1000,CTRLUPT="DISABLE" 
新增SMF服务化接口最大收发消息配置，接口类型为N7，出向请求消息的速率为1000tps（全局），控制update信令开关为“关闭”。ADD MMR:INTERFACE="N7",OUTRATE=1000,CTRLUPT="DISABLE" 
配置NRF缓存老化时长策略。 
[SET NRFPOLICY](None):RENEWCACHETHRESHOLD=30
##### 4G基于网元出向流控 
###### 应用场景 
GW-C支持S11接口、Gx接口、Gy接口与Ga接口的出向过负荷控制，可以在话务量冲击过大时保护MME、PCRF、OCS与CG等周边网元不会被过量负荷冲击瘫痪。 
###### 保护对象 
MME、PCRF、OCS、CG 
###### 流控原理 
根据人工配置阈值的出向过负荷控制对各个接口进行控制，具体情况参见下表。 
接口|控制原则
---|---
S11接口|报文发送速率超过所配置的向MME发送速率阈值后，报文会被丢弃。
Gx接口|报文发送速率超过所配置的向PCRF发送速率阈值后，超出部分的报文将会被丢弃或发送向备用PCRF（如果存在备用PCRF）。
Gy接口|报文发送速率超过所配置的向OCS发送速率阈值后，超出部分的报文将会被丢弃或发送向备用OCS（如果存在备用OCS）。
Ga接口|报文发送速率超过所配置的向CG发送速率阈值后，超出部分的报文将会被丢弃或发送向备用CG（如果存在备用CG）。
###### 防御策略 
本功能默认关闭。各接口的防御策略参见下表。 
接口|防御策略
---|---
S11接口|只针对专载创建和更新消息进行控制。
Gx接口|如果有备用PCRF则向备用PCRF发送消息，如果没有备用PCRF，则：对于CCR-I消息，进行丢弃处理。对于CCR-U消息，进行丢弃处理。对于CCR-T消息，不进行过负荷控制。
Gy接口|如果有备用OCS则向备用OCS发送消息，如果没有备用OCS，则：对于CCR-I消息，进行丢弃处理。对于CCR-U消息，进行丢弃处理。对于CCR-T消息，不进行过负荷控制。
Ga接口|对于超出当前周期（每秒）最大发送量的消息，如果有备用CG，会将消息切换发送向备用CG。如果所有CG服务器都无法发送，则将话单缓存到本地。
###### 配置方法 
S11接口
配置GTP-C流控控制开关，开启SGW GTP-C过负荷控制开关。 
[SET SGWGTPCOVERLOADCTL](None):CFGSWITCH="ENABLE"
配置S11出口流控。设置S11出口每秒发送消息的最大条数为60。 
[SET MAXS11RATE](None):MAXS11RATE=60
Gx接口
配置PCRF邻接局pcrf-test的流量控制，修改普通流控门限值为200。 
[SET PCRFFLOWCTRL](None):ADJACENTNODENAME="pcrf-test",NWAL=200
修改邻接局CCFH配置。其中配置名称为config1，邻接局名称为pcrf-test，CCAI消息的信用控制失败动作为失败，CCAU消息的信用控制失败动作。 
[SET PCCCCFHDEFAULTCONFIG](None):CONFIGNAME="config1",ADJACENTNAME="pcrf-test",CCAIACTION="CCFH_FAIL",CCAUACTION="CCFH_SUCCESS"
Gy接口
修改OCS邻接局ocs_test的流量控制配置。 
[SET OCSFLOWCTRL](None):ADJACENTNODENAME="ocs_test",NWAL=200
修改邻接局CCFH配置。邻接局节点名称"ocs_test"，用户归属类型"USER_HOME_TYPE_HOME"，初始化时的策略和更新时的策略都选择"CCFH_TERMINATE"。 
[SET DIAMETERADJACENTCCFH](None):ADJACENTNODENAME="ocs_test",HOMEDTYPE="USER_HOME_TYPE_HOME",INIT="CCFH_TERMINATE",UPDATE="CCFH_TERMINATE"
Ga接口
配置CG Profile流量控制。Profile名称为profile1，主用CG普通流控门限修改为150，备用CG普通流控门限修改为150。 
[SET CGPROFILEFLOWCTRL](None):CGPROFILENAME="profile1",PRIMARYNWAL=150，SECONDNWAL=150
配置SGW CG Profile流量控制。Profile名称为profile1，主用CG普通流控门限修改为150，备用CG普通流控门限修改为150。 
[SET SGWCGPROFILEFLOWCTRL](None):CGPROFILENAME="profile1",PRIMARYNWAL=150，SECONDNWAL=150
## NRF流控 


网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 


NRF提供自保流控、分局向流控多套解决方案，对信令风暴进行综合治理。 


分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|CPU过负荷流控|CPU过负荷时，降低业务通过率，保护业务进程稳定。|是|默认开启
自保流控|NRF QPS流控|业务请求数过多时，拒绝超过门限的业务请求，保护业务进程稳定。|是|默认开启
周边网元过载保护|分局向QPS流控|单局向业务请求数过多时，拒绝超过门限的业务请求，保护业务进程稳定。|是|默认开启


### 自保流控 
#### CPU过负荷流控 
##### 应用场景 
CPU负荷超过门限配置时，根据配置的策略降低业务通过率，保护业务进程稳定。 
##### 保护对象 
NRF 
##### 流控原理 
CPU过载控制是NRF过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），将CPU控制在目标范围之内。流控示意图如[图1](1615166928880.html#z85c0603eb02a4bf3a9cba4888de0ab94__4a9daa3a-444b-4b21-a3a2-f65724b745b3)所示。
图1  NRF CPU过载控制
[]images/NRF%20CPU%E8%BF%87%E8%BD%BD%E6%8E%A7%E5%88%B6.png)
CPU过载控制包括门限配置和控制策略两部分。 
门限配置：按CPU利用率可分为四级负荷、三级负荷、二级负荷、一级负荷四级。 
控制策略：包括保持业务通过率不变、按步长降低业务通过率、按步长升高业务通过率、业务通过率置为最小值四类。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。默认配置参见[表1](1615166928880.html#z85c0603eb02a4bf3a9cba4888de0ab94__a692c9ae-8f54-466a-89b6-a4968eaac95e)。
负荷等级|CPU利用率|控制策略
---|---|---
一级负荷|90%|业务通过率置为最小值
二级负荷|80%|按步长降低业务通过率
三级负荷|75%|按步长降低业务通过率
四级负荷|70%|保持业务通过率不变
##### 配置方法 
配置CPU过负荷功能开关 
该功能默认开启（值为1）。配置为1表示开启CPU过负荷控制，配置为0表示关闭CPU过负荷控制。 
[SET PARAMETER](None):PARANAME="CPUOverLoadControl",PARAVALUE=1
配置CPU负荷等级： 
默认设置[表1](1615166928880.html#z85c0603eb02a4bf3a9cba4888de0ab94__a692c9ae-8f54-466a-89b6-a4968eaac95e)。执行命令可设置负荷等级对应的CPU利用率及对应的控制策略。
[SET CPULEVELCFG](None):OL1THRESHOLD=90,OL2THRESHOLD=80,OL3THRESHOLD=75,OL4THRESHOLD=70,OL1POLICY="MINIMUM_PASS_RATE",OL2POLICY="REDUCE_PASS_RATE",OL3POLICY="REDUCE_PASS_RATE",OL4POLICY="UNCHANGED_PASS_RATE"
配置CPU过载控制时，每个周期调整步长（单位：%） 
每次调整业务通过率的值，默认为5%。即每次CPU过负荷时按照步长增加或降低5%的业务通过率。 
[SET PARAMETER](None):PARANAME="CPUDropPercent",PARAVALUE="5"
配置CPU过载控制调整周期 
配置值为CPU采集周期的倍数，建议设置为5。CPU的采集周期为2.1 s，业务默认2.1*10=21 s采集一次CPU的负荷。 
[SET PARAMETER](None):PARANAME="CPUOverLoadControlPeriod",PARAVALUE="5"
配置CPU过载控制调整能达到的最低业务通过率 
当CPU超过一级负荷的时候允许业务通过率，默认为1%。当业务通过率设置成1%后，CPU占有率会逐步降低，在一个CPU过载控制调整周期后，CPU占有率根据CPU过负荷控制策略，逐渐增加/降低业务的通过率（每次增加/降低的业务通过率为：CPU过载控制时每个周期调整步长）。 
[SET PARAMETER](None):PARANAME="CPUOverLoadControlMinRate",PARAVALUE="30"
#### NRF QPS流控 
##### 应用场景 
接收请求超过系统QPS设置时，NRF通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。
##### 保护对象 
NRF 
##### 流控原理 
流量控制与TPS类型License功能融合： 
TPS使用达到License的80%，上报告警。 
TPS使用达到License的100%，进行流控。 
当请求总量达到流控阈值时，根据配置的策略，返回503或307。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置：TPS使用达到Lisence的80%，上报告警；达到License的100%，进行流控。 
NRF容灾方式为双活部署时，流控总量控制策略配置项为响应307。 
NRF容灾方式为主备部署时，流控总量控制策略配置项为响应503。 
##### 配置方法 
配置流控总量控制策略：配置流控总量控制为重试，间隔5秒。 
[SET TRAFFICPOLICY](None):TRAFFPOLICY="RETRY"
[SET TRAFFRETRYPERIOD](None):RETRYPERIOD=5
### 周边网元过载保护 
#### 分局向QPS流控 
##### 应用场景 
由于业务请求的不均衡性，NRF可通过业务层标识例如NFID、FQDN等或IP区分局向，对不同局向的业务请求进行QPS流控，防止某一局向异常，影响其他局向的业务处理。
##### 保护对象 
其他NF 
##### 流控原理 
NRF通过业务层标识如NFID、FQDN等或IP区分局向，对不同局向的业务请求分别进行统计： 
当某一局向达到配置的流控阈值时，进行QPS流控，防止某一局向异常，影响其他局向的业务处理。 
当某个NF请求达到流控阈值时，返回429响应。 
##### 防御策略 
区分局向的策略分为两种： 
按业务层标识进行流控，如NFID、FQDN等。 
按IP进行流控。 
流控策略分为两种： 
按统一阈值进行流控，例如单NF请求阈值统一设置为500。 
分NF分别进行阈值设置。 
##### 配置方法 
配置NF流控策略： 
配置为“ON”表示开启NF流控，配置为“OFF”表示关闭NF流控。 
[SET NFTRAFPOLICY](None):NFCTRLPOLICY="ON"
配置NF流控QPS公共阈值 
配置单NF在单SC上处理的QPS阀值，此处500为范例，现场需要根据实际情况修改。建议配置为：单NF的请求最大不超过总请求数的10%，即License中发现QPS项的值*10%/SC个数。
[SET NFCOMMTHRED](None):COMTHRD=500
配置NF流控层级策略 
配置针对具体NF的流控策略，可以通过配置应用层或IP层来针对具体的NF进行流控。实际使用场景中，推荐使用IP进行流控。 
[SET NFTRAFCTRLPARA](None):NFCTRLPARA="IP"
配置NF流控IP层特异阈值 
针对某NF具体的IP进行流量控制时，配置此NF在单SC上的流量阈值。例如，设置192.168.0.1的阈值为50： 
[ADD NFIPSPLTHRD](None):REQNFIP="192.168.0.1",SPECIALTHRD=50
## NSSF流控 
网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 
NSSF提供自保流控、分局向流控多套解决方案，对信令风暴进行综合治理。 
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|CPU过负荷流控|CPU过负荷时，降低业务通过率，保护业务进程稳定。|是|默认开启
NSSF QPS流控|自保流控|业务请求数过多时，拒绝超过门限的业务请求，保护业务进程稳定。|是|默认开启
周边网元过载保护|分局向QPS流控|单局向业务请求数过多时，拒绝超过门限的业务请求，保护业务进程稳定。|是|默认开启
### 自保流控 
#### CPU过负荷流控 
##### 应用场景 
接收请求超过系统QPS设置时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。 
##### 保护对象 
NSSF 
##### 流控原理 
CPU过载控制是NSSF过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），将CPU控制在目标范围之内。流控示意图如[图1](1615970635542.html#z85c0603eb02a4bf3a9cba4888de0ab94__b2a59c13-d039-4c13-a72a-131349fd927e)所示。
图1  NSSF CPU过载控制
[]images/NSSF%20CPU%E8%BF%87%E8%BD%BD%E6%8E%A7%E5%88%B6.png)
CPU过载控制包括门限配置和控制策略两部分。 
门限配置：按CPU利用率可分为四级负荷、三级负荷、二级负荷、一级负荷四级。 
控制策略：包括保持业务通过率不变、按步长降低业务通过率、按步长升高业务通过率、业务通过率置为最小值四类。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。默认配置参见[表1](1615970635542.html#z85c0603eb02a4bf3a9cba4888de0ab94__8c145934-325b-4aad-a58c-adc3d9581a5b)。
负荷等级|CPU利用率|控制策略
---|---|---
一级负荷|90%|业务通过率置为最小值
二级负荷|80%|按步长降低业务通过率
三级负荷|75%|按步长降低业务通过率
四级负荷|70%|保持业务通过率不变
##### 配置方法 
配置CPU过负荷功能开关 
该功能默认开启（值为1）。配置为1表示开启CPU过负荷控制，配置为0表示关闭CPU过负荷控制。 
[SET SWITCHCONFIG](None):PARANAME=CPUOverLoadControl,PARAVALUE=1
配置CPU负荷等级： 
默认设置[表1](1615970635542.html#z85c0603eb02a4bf3a9cba4888de0ab94__8c145934-325b-4aad-a58c-adc3d9581a5b)。执行命令可设置负荷等级对应的CPU利用率及对应的控制策略。
[SET CPULEVELCFG](None):OL1THRESHOLD=90,OL2THRESHOLD=80,OL3THRESHOLD=75,OL4THRESHOLD=70,OL1POLICY="MINIMUM_PASS_RATE",OL2POLICY="REDUCE_PASS_RATE",OL3POLICY="REDUCE_PASS_RATE",OL4POLICY="UNCHANGED_PASS_RATE"
配置CPU过载控制时，每个周期调整步长（单位：%） 
每次调整业务通过率的值，默认为5%。即每次CPU过负荷时按照步长增加或降低5%的业务通过率。 
[SET SWITCHCONFIG](None):PARANAME=CPUDropPercent,PARAVALUE=5
配置CPU过载控制调整周期 
配置值为CPU采集周期的倍数，默认为10。CPU的采集周期为2.1 s，业务默认2.1*10=21 s采集一次CPU的负荷。 
[SET SWITCHCONFIG](None):PARANAME=CPUOverLoadControlPeriod,PARAVALUE=5
配置CPU过载控制调整能达到的最低业务通过率 
当CPU超过一级负荷的时候允许业务通过率，默认为1%。当业务通过率设置成1%后，CPU占有率会逐步降低，在一个CPU过载控制调整周期后，CPU占有率根据CPU过负荷控制策略，逐渐增加/降低业务的通过率（每次增加/降低的业务通过率为：CPU过载控制时每个周期调整步长）。 
[SET SWITCHCONFIG](None):PARANAME=CPUOverLoadControlMinRate,PARAVALUE=30
#### NSSF QPS流控 
##### 应用场景 
接收请求超过系统QPS设置时，NSSF通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。
##### 保护对象 
NSSF 
##### 流控原理 
流量控制与TPS类型License功能融合： 
TPS使用达到License的80%，上报告警。 
TPS使用达到License的100%，进行流控。 
当请求总量达到流控阈值时，根据配置的策略，返回503或307。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置：TPS使用达到Lisence的80%，上报告警；达到License的100%，进行流控。 
NSSF容灾方式为双活部署时，流控总量控制策略配置项为响应307。 
NSSF容灾方式为主备部署时，流控总量控制策略配置项为响应503。 
##### 配置方法 
配置流控总量控制策略：配置流控总量控制为重试，间隔5秒。 
[SET TRAFFICPOLICY](None):TRAFFPOLICY="RETRY"
[SET TRAFFRETRYPERIOD](None):RETRYPERIOD=5
### 周边网元过载保护 
#### 分局向QPS流控 
##### 应用场景 
由于业务请求的不均衡性，NSSF可通过业务层标识例如NFID、FQDN等或IP区分局向，对不同局向的业务请求进行QPS流控，防止某一局向异常，影响其他局向的业务处理。
##### 保护对象 
其他NF 
##### 流控原理 
NSSF通过业务层标识如NFID、FQDN等或IP区分局向，对不同局向的业务请求分别进行统计： 
当某一局向达到配置的流控阈值时，进行QPS流控，防止某一局向异常，影响其他局向的业务处理。 
当某个NF请求达到流控阈值时，返回429。 
##### 防御策略 
区分局向的策略分为两种： 
按业务层标识进行流控，如NFID、FQDN等。 
按IP进行流控。 
流控策略分为两种： 
按统一阈值进行流控，例如单NF请求阈值统一设置为500。 
分NF分别进行阈值设置。 
##### 配置方法 
配置NF流控策略： 
配置为“ON”表示开启NF流控，配置为“OFF”表示关闭NF流控。 
[SET NFTRAFPOLICY](None):NFCTRLPOLICY="ON"
配置NF流控QPS公共阈值 
配置单NF在单SC上处理的QPS阀值，此处500为范例，现场需要根据实际情况修改。建议配置为：单NF的请求最大不超过总请求数的10%，即License中发现QPS项的值*10%/SC个数。
[SET NFCOMMTHRED](None):COMTHRD=500
配置NF流控层级策略 
配置针对具体NF的流控策略，可以通过配置应用层或IP层来针对具体的NF进行流控。实际使用场景中，推荐使用IP进行流控。 
[SET NFTRAFCTRLPARA](None):NFCTRLPARA="IP"
配置NF流控IP层特异阈值 
针对某NF具体的IP进行流量控制时，配置此NF在单SC上的流量阈值。例如，设置192.168.0.1的阈值为50： 
[ADD NFIPSPLTHRD](None):REQNFIP="192.168.0.1",SPECIALTHRD=50
## PCF/PCRF流控 
网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 
PCF/PCRF提供自保流控、周边网元过载保护等多套解决方案，对信令风暴进行综合治理。     
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|系统资源过负荷控制|PCF/PCRF过负荷控制的系统资源包括CPU、内存、业务数据区以及License在线用户容量。系统资源负荷等级通过CPU负荷等级、数据区负荷等级、业务内存负荷等级、License在线用户容量负荷等级共同决定。PCF/PCRF收到业务请求消息时，根据当前系统资源负荷等级和对应的业务消息优先级通过率判断是否对该消息进行过负荷控制。|是|默认开启
周边网元过载保护|业务请求出局流控|PCF/PCRF发送业务请求消息时，根据业务全局配置对发送业务请求进行流量控制，防止本端出向流量过大造成周边网元过载。|是|默认开启
### 自保流控 
#### 系统资源过负荷控制 
##### 应用场景 
系统过载时，通过入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定和高优先级业务成功率。 
##### 保护对象 
PCF/PCRF 
##### 流控原理 
系统资源负荷等级通过CPU负荷等级、数据区负荷等级、业务内存负荷等级、License在线用户容量负荷等级共同决定，PCF/PCRF根据当前系统资源负荷等级对业务消息进行控制。 
当License在线用户容量未达到一级负荷阈值时，取CPU负荷等级、数据区负荷等级、业务内存负荷等级中的最高等级作为当前系统资源负荷等级。 
当License在线用户容量达到一级负荷阈值时，当前系统资源负荷等级即为一级。 
缺省配置情况下，CPU负荷等级、数据区负荷等级、业务负荷等级、License在线用户容量负荷等级阈值参见[表1](1615883759057.html#z837cc62d89bd4149b2bcd32b8e3aef4d__439bede6-88d4-4a43-afa6-d5a06692c58c)，包含三个等级的上下限阈值。
过负荷类型|一级负荷上限阈值（%）|一级负荷下限阈值（%）|二级负荷上限阈值（%）|二级负荷下限阈值（%）|三级负荷上限阈值（%）|三级负荷下限阈值（%）
---|---|---|---|---|---|---
CPU|90|85|85|80|80|75
数据区|90|85|85|80|80|75
业务内存|90|85|85|80|80|75
License在线用户容量|100|90|85|80|75|70
在系统达到三级及以上的负荷等级时，可以通过配置业务通过率，丢弃部分优先级较低的入局业务请求，以保证在系统过负荷时重要的业务优先得到保证。 
缺省配置情况下，不同业务类型消息不同负荷等级下的业务通过率配置参见[表2](1615883759057.html#z837cc62d89bd4149b2bcd32b8e3aef4d__2fa3bf8e-f5a4-445d-a1eb-998f9c761813)。
业务类型|一级负荷业务通过率（%）|二级负荷业务通过率（%）|三级负荷业务通过率（%）
---|---|---|---
VoLTE业务（更新消息）|0|100|100
VoLTE业务（初始消息）|0|100|100
数据业务（更新消息）|0|100|100
数据业务（初始消息）|0|100|100
系统资源负荷等级为一级时，VoLTE业务、数据业务的初始或更新请求通过率默认为0，并且不可修改。PCF/PCRF只会处理紧急呼叫请求和会话释放请求。 
系统资源负荷等级为二级或三级时，PCF/PCRF支持配置VoLTE业务、数据业务的初始或更新请求通过率。 
License在线用户容量控制比较特殊，不按照负荷级别设定通过率进行过负荷控制： 
License在线用户容量达到一级负荷等级时，拒绝用户上线消息（紧急呼叫除外）。 
License在线用户容量达到二、三级负荷等级时，不丢弃消息。 
License在线用户容量三个负荷级别的阈值设定，主要用于告警上报和告警恢复。 
系统资源过负荷控制机制综合评估系统资源负荷与实际处理话务量（各业务类型消息的处理个数）的关系，通过动态调整实际处理话务量（超出的话务量将被丢弃/拒绝，不再处理），将系统资源负荷控制在目标范围之内。以系统资源中的CPU过负荷控制为例，流控示意图如[图1](1615883759057.html#z837cc62d89bd4149b2bcd32b8e3aef4d__5693213e-5d7c-4f17-8862-9fe667ec3b35)所示。
图1  CPU过负荷流控示意图
[]images/1616142504201.png)
##### 防御策略 
本功能默认开启，并推荐使用默认配置，参见[表1](1615883759057.html#z837cc62d89bd4149b2bcd32b8e3aef4d__439bede6-88d4-4a43-afa6-d5a06692c58c)和[表2](1615883759057.html#z837cc62d89bd4149b2bcd32b8e3aef4d__2fa3bf8e-f5a4-445d-a1eb-998f9c761813)。
##### 配置方法 
配置过负荷控制：[SET LOADCFG](../../Npcf_PolicyManagement\zh-CN\mml\1787059.html)
配置过负荷业务通过率：[SET OLSERVRATIO](../../Npcf_PolicyManagement\zh-CN\mml\1787119.html)
### 周边网元过载保护 
#### 业务请求出局流控 
##### 应用场景 
在套餐生效/失效、规则生效/失效以及月初批量用量清零时，可能会有大量业务规则重决策，从而引发业务请求消息的发送。PCF/PCRF根据业务全局配置对发送业务请求进行流量控制，防止本端出向流量过大造成周边NF（如SMF）过载。 
##### 保护对象 
周边NF（SMF/xGW/AMF等） 
##### 流控原理 
PCF/PCRF在用户割接、容灾切换和月初用量清零等场景时，可能会触发大量用户重决策规则，从而向对端NF（如SMF）下发大量决策消息，引发对端NF负荷瞬时陡增。因而，PCF/PCRF采用缓冲队列方式，通过决策限速的方式（如每个处理模块每秒最多下发30个决策请求）达到保护对端NF不过载的目的。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
参数编号|参数名称|默认值
---|---|---
1052|消息流控参数|10
##### 配置方法 
配置消息流控参数：[SET SYS GLOBPARA](../../Npcf_PolicyManagement\zh-CN\mml\1787502.html):IDX=1052,CURVAL="10",EXTFLAG=1
## CHF/CGF流控 
网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防，抑制信令风暴，避免网络拥塞及过载。 
CHF/CGF提供自保流控解决方案，对信令风暴进行综合治理。
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
信令跟踪流控|信令跟踪限流|CPU中度过载时自动停止信令跟踪。|4G、5G适用自动开启（无法关闭）|自动开启（无法关闭）
CHF自保流控|CPU过负荷流控|根据系统CPU使用率，计算得到CPU过负荷级别。根据不同的负荷强度，采用不同策略拒绝计费消息，从而控制流量。|5G适用自动开启（无法关闭）|自动开启（无法关闭）
License流控|CHF自保流控|根据License配置限定的处理话单速率以及当前处理话单速率来决定是否限流。当处理速率超过License限定时，停止转发计费消息，并且向SMF回复429（Too Many Requests）。|4G、5G适用建议开启|默认开启
资源异常流控|CHF自保流控|当话单存储出现异常（例如，云盘只读、空间不足）时，停止转发计费消息，并且向SMF回复503（Service Unavailable）。|4G、5G适用自动开启（无法关闭）|自动开启（无法关闭）
CG Rf口自保流控|CPU过负荷流控|根据系统CPU使用率，计算得到CPU过负荷级别。根据不同的负荷强度，采用不同策略拒绝计费消息，从而控制流量。|4G适用自动开启（无法关闭）|自动开启（无法关闭）
License流控|CG Rf口自保流控|根据License配置限定的处理话单速率以及当前处理话单速率来决定是否限流。当处理速率超过License限定时，停止转发计费消息，并且向业务回复3004（Diameter too busy）。|4G、5G适用建议开启|默认开启
资源异常流控|CG Rf口自保流控|当话单存储出现异常（例如，云盘只读、空间不足）时，停止处理计费消息，并且向业务回复4002（Out Of Space）。|4G适用自动开启（无法关闭）|自动开启（无法关闭）
CG Ga口自保流控|License流控|根据License配置限定的处理话单速率以及当前处理话单速率来决定是否限流。当处理速率超过License限定时，停止处理计费消息。|4G、5G适用建议开启|默认开启
资源异常流控|CG Ga口自保流控|当话单存储出现异常（例如，云盘只读、空间不足）时，停止处理计费消息。|4G适用自动开启（无法关闭）|自动开启（无法关闭）
### 信令跟踪限流 
#### 应用场景 
信令跟踪功能打开则上报信令消息，在发生信令风暴时，如果网管未及时终止信令跟踪，系统UB可能会占满，使得其它重要消息申请UB失败，进而影响业务的正常运行。 
#### 保护对象 
CHF/CGF 
#### 流控原理 
CPU使用率超过80%或者每秒信令跟踪流量超过2048KiB时自动停止信令跟踪。 
#### 防御策略 
本功能永久生效，无法关闭。 
#### 配置方法 
默认开启，无需配置。 
### CHF自保流控 
#### CPU过负荷流控 
##### 应用场景 
系统过载时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证CHF业务稳定。
##### 保护对象 
CHF 
##### 流控原理 
CPU过载控制是CHF过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他计费消息将被丢弃/拒绝），将CPU使用率控制在目标范围之内。
流控示意图如[图1](1615774714071.html#zade658aafc9742c39ac7bd69225f3a80__a2413ee0-72be-4cca-8e36-693eb23d94a6)所示。
图1  CPU过负荷流控示意图
[]images/1616142733686.png)
CPU过载控制的门限配置，分为三级：轻度、普通、严重。默认情况下，轻度的负荷区间在70%~79%，普通的负荷区间在80%~89%，严重的负荷区间在90%~100%。 
当系统CPU负荷超过轻度负荷控制的门限（可配置）后，将按照固定比例丢弃来自SMF业务网元的CREATE消息。 
当系统CPU负荷超过普通负荷控制的门限（可配置）后，将全部丢弃来自SMF业务网元的CREATE消息。 
当系统CPU负荷超过严重负荷控制的门限（可配置）后，将全部丢弃来自SMF业务网元的计费消息，并且向业务返回429（可配置）。 
##### 防御策略 
本功能永久生效，无法关闭。 
推荐使用默认配置，可以配置检测周期。 
##### 配置方法 
推荐采用默认配置。 
设置CPU监控参数。例如：监控阈值-轻度为70%，监控阈值-普通为80%，监控阈值-严重为90%，监控周期时长为1分钟。SET CPUCONTROL:BRTHRESHOLD=70,TRTHRESHOLD=80,FTHRESHOLD=90,DURATION=1;CPU使用率监控阈值必须满足如下规则：轻度(%) < 普通(%) < 严重(%)。当CPU使用率超过设置的阈值时，会产生相应级别的告警。 
查询CPU监控参数。SHOW CPUCONTROL; 
#### License流控 
##### 应用场景 
接收请求超过系统License设置时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。 
##### 保护对象 
CHF 
##### 流控原理 
流量控制与License功能融合，当每秒话务量超过License最大处理话务量，进行流控，向业务返回状态码429（可配置）。 
##### 防御策略 
本功能默认开启。当每秒话务量超过License最大处理话务量，进行流控。当一个检测周期（1800秒）内流控次数达到指定次数（默认3次）时，上报告警。 
推荐使用默认配置。 
##### 配置方法 
推荐采用默认配置。 
当发生流控时，CHF向业务返回状态码。修改响应码，例如过载保护错误码设置为429。SET OCSCODE:BUSYCODE=429;查询系统中的响应码配置。SHOW OCSCODE; 
License流控的开关，配置在/global/bill/conf/nmbsys.ini文件中。[FlowControl]
FlowControlSwitch=1  /*开启license流控*/
ThresholdTimes=3    /*一个检测周期内每秒话务量超过license设置的次数才上报告警*/
AlarmPeriod=1800    /*上报告警检测周期*/ 
#### 资源异常流控 
##### 应用场景 
由于CHF需要话单落地，磁盘空间成为关键资源。当资源不足时，为了防止计费信息丢失，保证SMF业务稳定，CHF需要设置流控。 
##### 保护对象 
CHF 
##### 流控原理 
当CHF出现资源不足时，向SMF回应状态码503，SMF将计费消息转到其他CHF处理。 
##### 防御策略 
本功能永久生效，无法关闭。 
当CHF出现资源不足或者磁盘操作异常时，向业务返回状态码503（可配置）。 
##### 配置方法 
推荐采用默认配置。 
修改响应码，例如，资源不足错误码设置为503。SET OCSCODE:STOPSVR=503; 
查询系统中的响应码配置。SHOW OCSCODE; 
### CG Rf口自保流控 
#### CPU过负荷流控 
##### 应用场景 
系统过载时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证CG业务稳定。 
##### 保护对象 
CGF 
##### 流控原理 
CPU过载控制是CG过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他计费消息将被丢弃/拒绝），将CPU使用率控制在目标范围之内。
流控示意图如[图1](1615774734679.html#z6984a574b35e4317b318d2043717f716__d165de26-b0a2-437c-a088-0145f49358b5)所示。
图1  CPU过负荷流控示意图
[]images/1616142799766.png)
CPU过载控制的门限配置，分为三级：轻度、普通、严重。默认情况下，轻度的负荷区间在70%~79%，普通的负荷区间在80%~89%，严重的负荷区间在90%~100%。 
当系统CPU负荷超过轻度负荷控制的门限（可配置）后，将按比例拒绝一部分ACR。 
当系统CPU负荷超过普通负荷控制的门限（可配置）后，将不再接收新会话ACR（EVENT和START ACR）。 
当系统CPU负荷超过严重负荷控制的门限（可配置）后，将不再接收ACR。 
##### 防御策略 
本功能永久生效，无法关闭。 
推荐使用默认配置，可以配置检测周期。 
当拒绝接收ACR，CG向前台网元回复resultCode为3004（Diameter too busy）的ACA，网元会处理此类回复消息。 
##### 配置方法 
推荐采用默认配置。 
设置CPU监控参数。例如：监控阈值-轻度为60%，监控阈值-普通为80%，监控阈值-严重为90%，监控周期时长为1分钟。SET CPUCONTROL:BRTHRESHOLD=60,TRTHRESHOLD=80,FTHRESHOLD=90,DURATION=1;CPU使用率监控阈值必须满足如下规则：轻度(%) < 普通(%) < 严重(%)。当CPU使用率超过设置的阈值时，会产生相应级别的告警。 
查询CPU监控参数。SHOW CPUCONTROL; 
#### License流控 
##### 应用场景 
接收请求超过系统License设置时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。 
##### 保护对象 
CGF 
##### 流控原理 
流量控制与License功能融合，当每个流控检测周期（100秒）接收到的话务量超过License最大处理话务量，将不再接收ACR，向前台网元回复resultCode为3004（Diameter too busy）的ACA，网元会处理此类回复消息。 
##### 防御策略 
本功能默认开启。当每个流控检测周期的话务量超过License最大处理话务量，进行流控。当一个检测周期（1800秒）内流控次数达到指定次数（默认3次）时，上报告警。 
推荐使用默认配置。 
##### 配置方法 
推荐采用默认配置。 
License流控的开关，设置在/global/bill/conf/nmbsys.ini文件中。
`[FlowControl]
FlowControlSwitch=1 /*开启license流控*/
CheckPeriod=100    /*流控检测周期*/
ThresholdTimes=3   /*一个检测周期内每秒话务量超过license设置的次数才上报告警*/
AlarmPeriod=1800   /*上报告警检测周期*/` 
#### 资源异常流控 
##### 应用场景 
由于CG需要话单落地，磁盘空间成为关键资源。当资源不足时，为了防止计费信息丢失，CG需要流控。 
##### 保护对象 
CGF 
##### 流控原理 
当CG出现资源不足时，向前台网元回复resultCode为4002（Out Of Space）的ACA，网元会处理此类回复消息。 
##### 防御策略 
本功能永久生效，无法关闭。 
当CG出现资源不足或者磁盘操作异常时，向业务返回状态码4002。 
##### 配置方法 
无。 
### CG Ga口自保流控 
#### License流控 
##### 应用场景 
接收请求超过系统License设置时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务稳定。 
##### 保护对象 
CGF 
##### 流控原理 
流量控制与License功能融合，当每个流控检测周期（100秒）已接收到的话务量超过License最大处理话务量，进行流控，该粒度的后续时间都不再处理UDP的socket缓存话单。
##### 防御策略 
本功能默认开启。当每个流控检测周期的话务量超过License最大处理话务量，进行流控。当一个检测周期（1800秒）内流控次数达到指定次数（默认3次）时，上报告警。 
推荐使用默认配置。 
##### 配置方法 
推荐采用默认配置。 
License流控的开关，设置在/global/bill/conf/nmbsys.ini文件中。
`[FlowControl]
FlowControlSwitch=1 /*开启license流控*/
CheckPeriod=100    /*流控检测周期*/
ThresholdTimes=3   /*一个检测周期内每秒话务量超过license设置的次数才上报告警*/
AlarmPeriod=1800   /*上报告警检测周期*/` 
#### 资源异常流控 
##### 应用场景 
由于CG需要话单落地，磁盘空间成为关键资源。当资源不足时，为了防止计费信息丢失，CG需要流控。 
##### 保护对象 
CGF 
##### 流控原理 
当CG出现硬盘空间不足时，向前台网元回复资源不可用消息，同时发送重定向消息。 
##### 防御策略 
本功能永久生效，无法关闭。 
当CG出现硬盘空间不足时，触发流控。 
##### 配置方法 
无。 
## DSC流控 


因网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 


DSC提供自保流控、周边网元过载保护多套解决方案，对信令风暴进行综合治理。 


分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|系统资源过负荷控制|计算系统CPU占用和内存占用，根据系统CPU占用和内存占用的当前值以及系统配置的阈值分别计算得到CPU负荷等级和内存负荷等级，取CPU负荷等级和内存负荷等级中的最高等级作为当前系统资源负荷等级。DRA收到Diameter业务请求消息时，根据当前系统资源负荷等级和对应的业务消息优先级通过率判断是否对该消息进行负荷控制。|是|默认开启
自保流控|模块流量控制|模块流量控制分散在各模块独立控制。各模块收到Diameter业务请求消息时，根据本模块当前的流量和对应的消息优先级通过率，判断是否对该消息进行负荷控制。|是|默认开启
自保流控|按对等端入局流控|收到Diameter业务请求消息时，根据接收端局向流量和对应的消息优先级通过率，判断是否对该消息进行负荷控制。|否|否
自保流控|事务资源保护|当处理发往某个对端的请求消息的事务资源占用达到本模块事务资源的一定比例后，启动事务资源保护，根据配置对请求消息进行丢弃或者返回指定响应码。|是|默认开启
周边网元过载保护|按对等端出局流控|发送Diameter业务请求消息时，根据发送端局向流量和对应的消息优先级通过率，判断是否对该消息进行负荷控制。|否|否


### 自保流控 
#### 系统资源过负荷控制 
##### 应用场景 
系统过载时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证业务的稳定和高优先级业务的成功率。 
##### 保护对象 
DRA/STP/BSF/SCP
##### 流控原理 
系统资源负荷等级由CPU负荷等级和业务资源负荷等级共同决定，取其中负荷等级最高的作为当前系统资源负荷等级，并根据当前系统资源负荷等级对业务消息进行控制。 
目前业务资源包括会话缓存的内存资源和事务资源两种。 
DRA系统中判断依据是取CPU负荷等级、会话资源负荷等级、事务资源负荷等级中的最高等级作为当前系统资源负荷等级并根据该等级对业务消息进行控制。 
缺省配置情况下，CPU负荷等级设定参见[表1](DSC%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E8%BF%87%E8%B4%9F%E8%8D%B7%E6%8E%A7%E5%88%B6.html#T_1615002940323__CPU%E8%B4%9F%E8%8D%B7%E7%AD%89%E7%BA%A7-A69A35A5)（边界值按照低一级优先级处理）。
CPU占用率(%)|0~75|75~80|80~85|85~90|90~95|95~100
---|---|---|---|---|---|---
负荷等级|无|5|4|3|2|1
缺省配置情况下，业务资源负荷等级设定参见[表2](DSC%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E8%BF%87%E8%B4%9F%E8%8D%B7%E6%8E%A7%E5%88%B6.html#T_1615002940323__%E5%86%85%E5%AD%98%E8%B5%84%E6%BA%90%E8%B4%9F%E8%8D%B7%E7%AD%89%E7%BA%A7-A69A330C)（边界值按照低一级优先级处理）。
资源占用率(%)|0~75|75~80|80~85|85~90|90~95|95~100
---|---|---|---|---|---|---
负荷等级|无|5|4|3|2|1
启动系统资源过负荷时，在相同的系统资源负荷等级下，不同的业务消息优先级可以设置不同的通过率，这样系统过负荷时重要的业务优先得到保证。这就需要对业务划分优先级并合理设置其在某负荷等级下的通过率，最终系统资源过载控制的目标是将CPU或者系统资源控制在一定区间以内。 
业务消息优先级设定举例参见[表3](DSC%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E8%BF%87%E8%B4%9F%E8%8D%B7%E6%8E%A7%E5%88%B6.html#T_1615002940323__%E4%B8%9A%E5%8A%A1%E6%B6%88%E6%81%AF%E4%BC%98%E5%85%88%E7%BA%A7-A69A0E65)。
消息类型|应用接口类型|优先级
---|---|---
CCR|Gy|1(优先级高)
…|…|1(优先级高)
RAR|Gy|2
…|…|2
PPR|Cx|3
…|…|3
…|…|4(优先级低)
…|…|4(优先级低)
业务的优先级和各负荷等级下的通过比例参见[表4](DSC%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E8%BF%87%E8%B4%9F%E8%8D%B7%E6%8E%A7%E5%88%B6.html#T_1615002940323__%E4%B8%9A%E5%8A%A1%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E5%92%8C%E5%90%84%E8%B4%9F%E8%8D%B7%E7%AD%89%E7%BA%A7%E4%B8%8B%E7%9A%84%E9%80%9A%E8%BF%87%E6%AF%94%E4%BE%8B-A69A2C45)。
负荷等级|5|4|3|2|1
---|---|---|---|---|---
业务优先级|4|100%|50%|25%|0|0
3|业务优先级|100%|75%|50%|25%|0
2|业务优先级|100%|100%|75%|50%|0
1|业务优先级|100%|100%|100%|75%|0
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
配置控制选项：其中：CPU负荷等级ID取值范围为100~104，业务资源负荷等级ID取值范围为105~109。例如：将ID为100的CPU 5级拥塞下限（%）设置为75。SET DOLCTRL:ID=100,VALUE=75; 
配置消息优先级：例如：将消息优先级的标识设置为1，应用接口类型设置为16777238，命令码设置为272，优先级设置为LEVEL1。ADD DOLMSGPRI:ID=1,APPID=16777238,CMDCODE=272,PRIORITY="LEVEL1"; 
#### 模块流量控制 
##### 应用场景 
模块流量超过预定的门限时，通过控制入向流控防止拥塞恶化造成整系统瘫痪，保证本模块业务的稳定和高优先级业务的成功率。  
##### 保护对象 
DRA 
##### 流控原理 
模块流量控制分散在各模块独立控制。各模块收到Diameter业务请求消息时，根据本模块当前的流量和对应的消息优先级通过率，判断是否对该消息进行负荷控制。 
模块流量门限包括该模块总的流量门限和各优先级消息的流量门限。 
各优先级消息的流量门限设定方式为： 
各优先级消息的流量门限
= 模块流量门限 × 各优先级的消息通过率 
模块流量中各优先级的消息达到对应的流量门限就开始控制；若各优先级的流量门限没达到，总的流量门限已达到，则不区分优先级进行控制。 
消息的优先级配置与系统资源负荷优先级采用相同的配置。 
消息的优先级与流量门限的对应关系参见[表1](DSC%E6%A8%A1%E5%9D%97%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6.html#T_1615002940323__%E6%A8%A1%E5%9D%97%E6%B6%88%E6%81%AF%E6%B5%81%E9%87%8F%E8%BF%87%E8%BD%BD%E6%8E%A7%E5%88%B6%E6%97%B6%E5%90%84%E4%BC%98%E5%85%88%E7%BA%A7%E6%B6%88%E6%81%AF%E6%B5%81%E6%8E%A7%E6%AF%94%E4%BE%8B-A69C5954)，可根据需要进行调整。
优先级|流量门限
---|---
4|85%
3|90%
2|95%
1|100%
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
配置控制选项：例如：将ID为110的Diameter SMP流控门限设置为8000，ID为111的Diameter CMP流控门限设置为8000。SET DOLCTRL:ID=110,VALUE=8000;SET DOLCTRL:ID=111,VALUE=8000; 
配置消息优先级：例如：将消息优先级的标识设置为1，应用接口类型设置为16777238，命令码设置为272，优先级设置为LEVEL1。ADD DOLMSGPRI:ID=1,APPID=16777238,CMDCODE=272,PRIORITY="LEVEL1"; 
#### 按对等端入局流控 
##### 应用场景 
某对等端异常，发送大量请求消息到本端时，触发入局流控保护本端。 
##### 保护对象 
DRA  
##### 流控原理 
收到Diameter Peer 1的请求消息Request后，先获取对等端局向的流控开关。若开关打开则进行入局局向流控，同时统计接收对等端（Diameter
Peer 1）消息流量，如果超过配置的接收对等端局向流量则启动流控。 
对等端入局流控启动后，不同的应用消息可以按照不同的优先级设定控制规则。优先级设定条件包括应用ID、命令码、目的主机名、目的域名、源主机名、源域名等，根据不同的条件设定不同的控制优先级以及控制动作。控制动作分为丢弃、丢弃返回错误码。 
##### 防御策略 
本功能默认关闭，需要针对不同的对等端分析其合理的流量门限后，设置流控门限，并且针对该对等端的消息进行优先级分类。 
建议按照对等端的角色开启。一般而言，针对客户端角色网元开启入局流控获取流控门限。 
获取流控门限的方法：通过查询该对等端，统计一段时间内的峰值流量后计算得到。 
##### 配置方法 
设置合理的入局流控门限： 
例如：将入局流控门限设置为8000。 
[SET DPEER](None):INFCTH=8000;
#### 事务资源保护 
##### 应用场景 
某对等端异常，发送给它的请求消息都无法正常回复响应消息，会导致本端事务资源无法释放，影响到其他对等端业务。  
##### 保护对象 
DRA 
##### 流控原理 
本端事务资源为每个对等端的使用上限设置一个百分比的利用率。当给某个对等端发送请求消息后，如果该对等端不能及时返回响应消息，在事务超时之前的这段时间内，该对等端可能会占用大量事务资源不释放，造成其他对等端没有事务资源，无法发送消息。因此事务资源百分比可以控制某个对等端异常情况下最大能使用的资源数，保护有足够的事务资源供其他对等端使用。 
当某个对等端出现异常，占用的事务资源超过上限后，本端针对后续请求消息就会直接丢弃或者返回指定响应码。 
##### 防御策略 
本功能默认开启，每个对等端取默认值。 
目前在用版本的默认值均为80%，需要手工调整为30%。 
##### 配置方法 
设置合理的最大事务资源百分比： 
例如：将最大事务资源百分比设置为30。 
[SET DPEER](None):MAXTRANS=30;
### 周边网元过载保护 
#### 按对等端出局流控 
##### 应用场景 
某对等端异常，发送大量请求消息到本端时，触发出局流控保护下游网元。 
##### 保护对象 
对等端网元 
##### 流控原理 
发送Diameter Peer 1的请求消息前，先获取对等端局向的流控开关。若开关打开则进行出局局向流控，同时统计发送给对等端（Diameter
Peer 1）消息流量，如果消息流量超过配置的发送对等端局向流量则启动流控。 
对等端出局流控启动后，不同的应用消息可以按照不同的优先级设定控制规则。优先级设定条件包括应用ID、命令码、目的主机名、目的域名、源主机名、源域名等，根据不同的条件设定不同的控制优先级以及控制动作。控制动作分为丢弃、丢弃返回错误码。 
##### 防御策略 
本功能默认关闭，需要针对不同的对等端分析其合理的流量门限后，设置流控门限，并且针对该对等端的消息进行优先级分类。 
建议按照对等端的角色开启。一般而言，针对服务端角色网元开启出局流控。 
获取流控门限的方法：可以由下游网元给出，也可以根据DRA一段时间内统计的下游网元话务量来计算得到。  
##### 配置方法 
设置合理的出局流控门限： 
例如：将出局流控门限设置为8000。 
[SET DPEER](None):OUTFCTH=8000;
## MSCS流控 


因网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 


MSCS提供自保流控、周边网元过载保护多套解决方案，对信令风暴进行综合治理。 


分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|CPU拥塞控制|当系统CPU（包括SMP/CMP/VMP）处于拥塞的时候，通过对接入的业务进行控制，将CPU控制在目标范围之内。|是|默认开启
自保流控|总量流量控制|设置业务周期内（10s，可配置）允许通过的所有业务总量。|否|总量流量控制的配置方法
自保流控|单项流量控制|为了保证某一突发业务不会对其他业务造成大的影响（例如，突发短信对呼叫的影响），可以设置不同业务的每秒通过次数。|否|单项流量控制的配置方法
自保流控|信令拥塞控制|本机制用于保证SMP和链路的安全。当信令链路/偶联以及SMP本身拥塞的时候，减少到该SMP或者链路上的业务次数。对于No.7链路，允许配置拥塞阈值。|是|信令拥塞控制的配置方法
周边网元过载保护|单项业务流量控制|提供到HLR、SMSC（短消息中心）、SCP/EIR业务的次数控制方法，以防止突发流量对其他网元的冲击，该机制既可以控制到HLR、SMSC、SCP总的业务次数，还可以根据GT进行配置，控制到某一目标的次数。|否|单项业务流量控制的配置方法
周边网元过载保护|其他网元拥塞控制|当其他网元拥塞时，会给MSCS发送通知消息（或字段），MSCS相应减少到该网元的业务量。目前支持BSC、RNC以及NNI接口。|否|其他网元拥塞控制的配置方法


### 自保流控 
#### CPU拥塞控制 
##### 应用场景 
系统CPU过载时（包括MP/CMP/VMP），通过控制入向业务流，防止拥塞恶化造成整系统瘫痪，保证MSCS业务稳定以及高优先级业务的成功率。 
##### 保护对象 
MSCS 
##### 流控原理 
CPU拥塞控制是MSCS过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），来实现将CPU负荷控制在目标范围之内。 
流控示意图如[图1](1615885038756.html#zd74910c6ba8b4a4ba32103c0fa7eb818__0d90c04f-7430-49b6-b56b-057300132fd8)所示。
图1  CPU过负荷流控示意图
[]images/CPU%E8%BF%87%E8%BD%BD%E6%8E%A7%E5%88%B6.png)
CPU拥塞控制通过设置过载门限，将业务按照优先级进行控制。门限区间的设置和业务控制策略参见[表1](1615885038756.html#zd74910c6ba8b4a4ba32103c0fa7eb818__5209411c-9f1a-4ec7-af3a-ccc8625deab7)。最终CPU过载控制的目标是将CPU控制在一定区间以内（一般为75%-80%，可配置）。
门限名称|负荷区间|控制策略
---|---|---
目标控制区|75% - 80%|当系统CPU负荷从低过载区回落到目标控制区门限（可配置）后，将关闭CPU过载控制功能，所有消息/业务都不进行控制。
低过载区|80% - 90%|当系统CPU负荷超过低负荷控制的门限（可配置）后，将启动CPU过载控制功能，此时只对系统定义的普通消息/业务进行控制。
高过载区|90% - 100%|当系统CPU负荷超过高负荷控制门限（可配置）后，将对系统定义的普通优先级消息/业务，以及高优先级消息/业务同时进行控制。
受控业务类型以及系统缺省定义的优先级如下： 
高优先级位置更新、紧急呼叫、高优先级用户呼叫。 
普通优先级移动起呼、局间入呼、短信起呼（包括A/Iu/SGs接口）、短信终呼补充业务、切换（包括A/Iu/Sv/MAP接口）。 
##### 防御策略 
本功能默认开启，推荐使用默认配置。 
##### 配置方法 
推荐采用默认配置。 
使用[SHOW DEFCPUOLCFG](None)命令查询CPU过载默认配置，如[图2](1615885038756.html#zd74910c6ba8b4a4ba32103c0fa7eb818__cd081ef4-29a7-4eb6-a0ba-de433a1db089)所示。
图2  CPU过载默认配置
[]images/1621394437627.png)
使用[SHOW CPUOLCFG](None)命令查询CPU过载当前配置，如[图3](1615885038756.html#zd74910c6ba8b4a4ba32103c0fa7eb818__56df827b-6418-415c-87be-81b7fff27b9b)所示。
图3  CPU过载当前配置
[]images/1621394534572.png)
#### 总量流量控制 
##### 应用场景 
当系统CPU拥塞控制机制出现异常，导致CPU负荷居高不下，维护人员需手动对系统总的流量进行控制，限制接入MSCS的业务量。 
##### 保护对象 
MSCS 
##### 流控原理 
流量控制机制是指在流量控制周期（单位时间，缺省为10s）内，如果允许的所有业务数量超过设定阈值，则拒绝业务请求。允许流量按照MSCS全局允许通过量来设定。 
总量控制是指所有的业务数量之和超过设定阈值，按照每类业务流量的多少，对每类业务设置一个“等效CPU消耗”，表示系统该类一次业务所花费的负荷。 
目前系统根据各业务流量自动计算等效CPU消耗。 
##### 防御策略 
当本局需要进行入向流量控制时，需要进行MSC业务能力限制配置。按照控制方式，入向流量控制可分为总量流量控制和单项流量控制。 
总量流量控制主要按照CPU消耗来进行控制。MSC业务能力设置成功后，MSCS将对入向业务进行流量检查，当入向业务超过设置的阈值时，将进行流量控制。 
##### 配置方法 
 小心！ 
该配置对业务影响较大，如需开启，请先联系中兴通讯。 
当需要进行入向总量流量控制时，使用[ADD MSCSRVLMT](None)命令，新增MSCS业务能力限制。
例如，设置为允许的业务总量为10000，其中，参数ALLSRVNUM表示控制每秒通过的业务总量。
[ADD MSCSRVLMT](None):ALLSRVNUM=10000;
#### 单项流量控制 
##### 应用场景 
当系统出现特定单个业务突发流量超过系统能力，维护人员需手动对系统单项业务的流量进行控制，限制该业务接入MSCS的业务量。 
##### 保护对象 
MSCS 
##### 流控原理 
流量控制（单项）是指在流量控制周期（可配置，缺省为10s）内，如果允许的某种业务数量超过设定阈值，则拒绝该业务请求。 
目前支持的控制业务类型包括： 
呼叫（包括移动起呼和入局呼叫） 
短消息（包括起呼和终呼） 
位置更新（包括A/Iu/SGs接口） 
切换（包括A/Iu/Sv） 
LCS 
直传短消息 
USSD 
彩铃 
##### 防御策略 
当本局需要进行入向流量控制，并且是采用单项流量控制时，需要进行MSC业务能力限制配置，设置呼叫、位置更新、短消息、切换等单项业务的每秒允许通过数。 
##### 配置方法 
根据需要设置各单项业务数量。 
[ADD MSCSRVLMT](None):CALLNUM=1000,LUNUM=1000,SMSNUM=1000,HONUM=1000,USSDNUM=1000,LCSNUM=1000,PBRTNUM=1000,DSMSNUM=1000;
参数说明参考[表1](1615885288981.html#z837e44f2097b4764bed9bcd9351c43b6__46f4030f-3cc5-49b8-bd1c-e4d24204b592)。
参数|说明
---|---
CALLNUM|允许的每秒呼叫数量。
LUNUM|允许的每秒位置更新数量。
SMSNUM|允许的每秒短消息数量。
HONUM|允许的每秒切换数量。
USSDNUM|允许的每秒USSD数量。
LCSNUM|允许的每秒LCS业务数量。
PBRTNUM|允许的每秒彩铃数量。
DSMSNUM|允许的每秒直传短消息数量。
#### 信令拥塞控制 
##### 应用场景 
由于数据的配置或者是网络原因，导致信令交互出现大量失败，产生信令风暴，从而影响正常业务。 
信令拥塞控制就是为了防止信令流量过大，造成业务拥塞。 
##### 保护对象 
MSCS 
##### 流控原理 

信令拥塞通过如下两个指标进行判断： 
链路拥塞No.7号链路可以通过设置ERL阈值来确定是否拥塞。偶联链路的拥塞程度通过发送缓存占用率来确定是否拥塞。当信令拥塞级别满足链路拥塞时，则对出向流量进行控制，即对下行业务进行控制。 
SMP模块拥塞通过CPU占用率来判断是否拥塞。当信令拥塞级别满足SMP拥塞时，需要对入向/出向业务进行控制。一旦进入CPU过载区，还需要启动过负荷控制机制，按照流量控制机制实现一个业务周期内，下发的业务通过数超过允许通过量时即采取控制。每2s作为一个业务周期，可配置。 
目前支持控制业务类型为： 
A/Iu接口：SCCP的CR消息和Page消息。 
Mc接口：第一条Add消息。 
MAP接口：TC_BEGIN消息。 
NNI接口：TUP/BICC/ISUP的IAM消息。 
SIP接口：Invite消息。 
SGs：Page消息。 
Sv：HO消息。 
##### 防御策略 
入向业务控制：接收流控开关打开。 
出向业务控制：发送流控开关可在周边网元拥塞时，手动开启。 
##### 配置方法 
当需要对本局业务进行过负荷流量控制时，使用命令[SET SENDFC](None)设置信令处理模块负荷流量控制的数据。
命令[SET SENDFC](None)参数说明参见[表1](1615885320045.html#z76c40d8cdc6442c3a019fdcd9fc56122__e1badda5-8e22-4088-8225-a9745a060731)。
参数|名称|说明
---|---|---
FCFLAG|发送流控开关|出局业务流量过大，会导致信令处理模块CPU负荷过高以及链路拥塞等问题，打开本开关，业务会根据所配流控参数，对出局消息进行流控。
RCVFC|接收流控开关|入局业务流量过大，会导致信令处理模块CPU负荷过高以及链路拥塞等问题，打开本开关，业务会根据所配流控参数，对入局消息进行流控。
### 周边网元过载保护 
#### 单项业务流量控制 
##### 应用场景 
MSCS通过单向业务流量控制机制，限定到目标GT所对应邻接设备的业务，实现出向业务负荷控制，防止过量业务对邻接网元造成冲击。 
##### 保护对象 
对端网元 
##### 流控原理 
为了防止MSCS的业务对邻接网元产生严重冲击影响，需要通过出向单项流量控制机制控制到其他网元的消息流量。出向单项流量控制是指在流量控制周期（可配置，缺省为10s）内，如果出向业务数量超过设定阈值，则丢弃该消息，不再发送。 
目前出向的控制主要考虑以下4种情况： 
到HLR业务 
到短消息中心业务 
到SCP业务 
到EIR的业务 
通过目标GT配置，实现根据该GT组的负荷控制模板对目标GT所对应邻接设备的出向业务进行负荷控制。 
##### 防御策略 
缺省关闭。需要打开时，需先获知对端网元的处理能力，再根据处理能力设置最大允许通过业务数量。 
##### 配置方法 
使用命令[ADD GTLOADTMPLT](None)配置需要进行出向业务控制的邻接网元对应的目标GT。
命令[ADD GTLOADTMPLT](None)参数说明参见[表1](1615885345803.html#z744e61e1c5974982af0ba94a1c91f7c0__c32c9c27-0101-4378-bf57-06857488801d)。
参数|名称|说明
---|---|---
GTGROUP|归属GT组|缺省配置为0，表示不区分GT进行控制。推荐不进行GT限制。
NUMPERSECHLR|每秒允许发起到HLR业务的次数|该参数用于设置每秒允许发起到HLR业务的次数。被控制的到HLR的业务请求包含路由信息请求过程、位置更新过程、鉴权信息请求过程、Restore过程。
NUMPERSECSMS|每秒允许发起到短消息中心业务的次数|该参数用于设置每秒允许发起到短消息中心业务的次数。被控制的到短消息中心的业务请求包含终呼短消息投递。
NUMPERSECSCP|每秒允许发起到SCP业务的次数|该参数用于设置每秒允许发起到SCP业务的次数。被控制的到SCP的业务请求包含各种到SCP的智能业务请求。
NUMPERSECOTHER|每秒允许发起到其他对应网元业务的次数|该参数用于设置每秒允许发起到其他对应网元业务的次数。当前被控制的到其他对应网元业务请求包含Check IMEI过程。
#### 其他网元拥塞控制 
##### 应用场景 
其他网元拥塞的时候，MSCS减少到该网元的业务量。当邻接局发生拥塞的时候，本局可以通过自动拥塞控制（ACC）机制，只允许一部分呼叫通过，另一部分呼叫直接拒绝或者重新选择新的局向出局，减少拥塞局的话务量，以减轻其拥塞。邻接局拥塞状态分为不拥塞、1级拥塞、2级拥塞。1级拥塞是CPU处于CPU负荷配置的低过载区，2级拥塞是CPU处于负荷配置的高过载区。 
##### 保护对象 
对端网元 
##### 流控原理 
周边网元拥塞的时候，会给MSCS发送通知消息（或字段），MSCS相应减少到该网元的业务量。目前支持BSC、RNC以及NNI接口。 
A/Iu接口的控制如果在A/Iu口接收到OVERLOAD消息，将该局向拥塞级别加1，并设定长短定时器。在短定时器期间如果再次收到OVERLOAD，则不理会。如果短定时器到时后又收到OVERLOAD消息，则局向拥塞级别加1，同时重新设置长短定时器。如果长定时器到时，则局向拥塞级别减1，直到为0。MSCS记录RNC/BSC拥塞级别，并相应减少允许下发的请求消息数（Page和CR）。 
MC接口的控制如果MGW检测到拥塞，通过拥塞包通知MSCS，MSCS则根据MGW上报的允许通过率对下行消息进行控制。 
NNI接口控制（ACC，自动拥塞控制）如果本网元收到来自对端的RELEASE消息，消息中携带了自动拥塞级别，则通知数据库，让数据库减少到该局向的电路选择次数。 
##### 防御策略 
缺省关闭。如果需要开启，则在和对端网元协商后才能开启。 
##### 配置方法 
A/Iu/MC口控制开启安全变量874， 根据MGW/RNC/BSC拥塞级别控制下行消息。命令如下： SET VARVAL:ID=874,VAL=1; 
NNI口控制开启ACC功能，对出向和入向话务控制分别控制。命令如下：SET TGFLG:CTGADD="ACCTCTL"&"ACLSEND";设置中继组拥塞控制参数。在中继组上配置拥塞级别1是操作方式为CANCEL（拒绝呼叫），比例为80%，拥塞级别2也为CANCEL（拒绝呼叫），比例为50%。整个中继的占用阈值为100%。命令如下：SET TG:GATE=100,EQUC1="TRUE",ACCL1=80,EQUC2="TRUE",ACCL2=50;设置CPU拥塞控制阈值保持缺省配置。设置QoS指标拥塞控制参数设置QoS指标对应的拥塞级别，QoS 指标50对应拥塞级别1，指标90对应拥塞级别2。命令如下：SET IPQOSCFG:AUTOCONGLVL1=50,AUTOCONGLVL2=90; 
## MGW流控 


因网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 


为了保证系统在过量业务情况下，能够安全运行，MGW提供基于CPU的拥塞控制机制。 


分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|CPU拥塞控制|当系统CPU（包括SMP/CMP）处于拥塞的时候，通过对接入的业务进行控制，将CPU控制在目标范围之内。|是|默认开启
自保流控|信令拥塞控制|本机制用于保证SMP和链路的安全。当信令链路/偶联以及SMP本身拥塞的时候，减少到该SMP或者链路上的业务次数。对于No.7链路，允许配置拥塞阈值。|否|信令拥塞控制的配置方法
周边网元过载保护|无|无|无|无


### 自保流控 
#### CPU拥塞控制 
##### 应用场景 
系统过载时，通过控制入向业务量防止拥塞恶化造成整系统瘫痪，保证业务稳定。 
##### 保护对象 
MGW 
##### 流控原理 
CPU过载控制是MGW过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系。通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），来实现将CPU控制在目标范围之内。 
CPU过载控制包括门限配置，过负荷区间在80%~100%，如下图所示。 
图1  CPU过负荷区间
[]images/%E5%9B%BE%E7%89%871.png)
系统CPU负荷超过负荷控制的门限（可配置）后，将启动CPU过载控制功能，此时对系统定义的普通消息/业务进行控制。 
最终CPU过载控制的目标是将CPU控制在一定区间以内（CPU一般为75%~80%，可配置）。 
受控的业务类型包括： 
SCCP的CR消息（包含各种业务请求，例如位置更新、呼叫、短信）。 
MAP的TC_BEGIN消息。 
局间入局的IAM消息。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
使用[SET CPUCTRL](None)命令设置用户面CPU负荷控制属性，推荐采用默认配置。
#### 信令拥塞控制 
##### 应用场景 
防止信令流量过大造成业务拥塞。 
##### 保护对象 
MGW 
##### 流控原理 
信令拥塞通过如下两个指标进行判断： 
链路拥塞通过发送缓存占用率判断是否拥塞。 说明：No.7号链路可以通过设置ERL阈值来确定是否拥塞，偶联链路没有ERL统计，而且不同偶联共用带宽。偶联链路的拥塞程度通过发送缓存占用率来确定。 
SMP模块拥塞通过CPU判断是否拥塞。信令拥塞级别为链路拥塞或SMP拥塞，两者之一拥塞，则对下行业务进行控制。SMP拥塞的情况下，还对入向的业务进行控制。目前支持控制的业务类型为：A/Iu接口：SCCP的CR消息和Page消息。MAP接口：TC_BEGIN消息。NNI接口：TUP/BICC/ISUP的IAM消息。 
##### 防御策略 
缺省不开启。MGW已不再作为STP使用，该控制无应用场景，不开启。 
##### 配置方法 
使用[SET FLOWCCTRL](None)命令设置信令流量控制，出向/入向流控开关参数说明参见下表，其他参数采用缺省配置。
参数|名称|说明
---|---|---
SFCFLAG|出向流控开关|发送流控开关，出局业务流量过大，会导致信令处理模块CPU负荷过高以及链路拥塞等问题。打开本开关，业务会根据所配流控参数，对出局消息进行流控。
RECEIVEFCFLAG|入向流控开关|接收流控开关，入局业务流量过大，会导致信令处理模块CPU负荷过高以及链路拥塞等问题。打开本开关，业务会根据所配流控参数，对入局消息进行流控。
## UPF/GW-U流控 
网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 
UPF提供自保流控及周边网元过载保护多套解决方案，对信令风暴进行综合治理。 
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|N4口过负荷控制|UPF将负荷信息上报到SMF，SMF根据负荷选择UPF。UPF根据自身负荷情况控制PFCP会话创建消息接入速率，或者完全丢弃PFCP会话创建消息。|是|保持默认配置
周边网元过载保护|Error indication抑制|UPF收到GTPU报文后，若找不到转发表，会发送Error Indication报文通知对端GSN设备释放会话。如果UPF发送的Error Indication过多，会影响无线指标，因此需要控制发送Error Indication报文数量。|否|Error Indication抑制的配置方法
L2TP信令流控|周边网元过载保护|UPF和LNS 在L2TP隧道创建过程中的SCCRQ、SCCRP消息里携带Receive Window Size这个AVP，了解对端的L2TP消息并发处理能力。|是|自动开启（无法关闭）
### 自保流控 
#### N4口过负荷控制 
##### 应用场景 
UPF在高负荷状态下运行，或被黑客进行PFCP消息攻击时，UPF进行N4口过负荷控制。 
##### 保护对象 
UPF 
##### 流控原理 
CPU过载控制是UPF过载控制的核心机制，此机制综合评估CPU负荷及实际处理话务量（各类型消息的处理个数）的关系，通过动态调整实际处理话务量（其他话务量将被丢弃/拒绝，不再处理），来实现将CPU控制在目标范围之内。 
UPF定时收集各个业务虚机CPU、流量、用户数信息，根据配置的负荷计算方式计算CPU负荷，然后根据CPU负荷进行PFCP会话创建消息接入控制。 
PFCP会话创建消息负荷控制分为两级： 
一级为控制会话创建Caps、上报OCI和LCI。 
二级为拒绝会话创建消息，拒绝会话创建消息还可以配置是否给SMF应答。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。默认配置参见下表。 
负荷等级|相关参数|控制策略
---|---|---
一级负荷|过负荷门限：75%恢复门限：55%|上报OCI、LCI（默认打开），控制会话接入Caps（默认关闭）
二级负荷|CPU利用率：90%|拒绝所有会话创建消息
##### 配置方法 
配置负荷与过负荷控制参数，打开过负荷控制。设置不同业务单元CPU负荷采用最大值计算方式、上下文负荷采用平均值计算方式。总的负荷计算中，CPU利用率占比35%、上下文使用率占比35%，吞吐量占比30%。SET LOADINFOCFG:ENABLELCI="ENABLE",ENABLEOCI="ENABLE",CPUPOLICY="MAXPOLICY",USRPOLICY="AVERAGEPOLICY",THROUGHPUTPOLICY="ENABLE",ENABLEWEIGHT="ENABLE",CPUWEIGHT=35,USRWEIGHT=35,THROUGHPUTWEIGHT=30,CAPSSWITCH="ENABLE",CAPSTHRESHOLD=2 
打开过负荷控制，设置过负荷时控制会话接入速率为2KCaps。SET LOADINFOCFG:ENABLELCI="ENABLE",ENABLEOCI="ENABLE",CAPSSWITCH="ENABLE",CAPSTHRESHOLD=2 
打开过负荷控制，设置CPU负荷超90%拒绝新会话接入。SET LOADINFOCFG:ENABLELCI="ENABLE",ENABLEOCI="ENABLE",RSPPOLICY="RESPONSE",REJECTTHRESHOLD=90 
### 周边网元过载保护 
#### Error indication抑制 
##### 应用场景 
当UPF向对端GSN设备，特别是RAN发送的Error indication报文数目，影响对接网元的指标时，进行Error indication抑制。
##### 保护对象 
RAN、UPF 
##### 流控原理 
如果Error Indication发送开关关闭，则不发送Error Indication报文。 
如果Error Indication发送开关打开，根据报文间隔数与静默时长，分为以下两种情况：配置报文间隔数为N，则按照协议每产生N个Error Indication报文才真正给对端发送一次。配置静默时长为M，则GTPU承载删除后的M秒内，收到报文都不会给对端设备回Error Indication报文。 
##### 防御策略 
本功能默认关闭。UPF可以通过以下三种方式抑制Error indication报文。 
完全关闭Error Indication报文发送。 
每N个找不到转发表的报文发送一个Error Indication报文。 
设置转发表删除一定时间内不发送Error Indication报文。 
 说明： 
UPF默认每有一个找不到转发表的报文就发送一个Error Indication。如果有需要可以启用Error Indication抑制功能。 
##### 配置方法 
修改GTPU错误指示，关闭Error Indication报文发送。SET ERRORINDICATION:SENDSWITCH="DISABLE" 
修改GTPU错误指示，设置每20个报文发送一个Error Indication。SET ERRORINDICATION:SENDSWITCH="ENABLE",SENDINTVAL=20 
修改GTPU错误指示，设置Error Indication报文静默时长为5s。SET ERRORINDICATION:SENDSWITCH="ENABLE",SLILENTDURATION=5 
#### L2TP信令流控 
##### 应用场景 
UPF和LNS之间发送L2TP信令。 
##### 保护对象 
UPF、LNS 
##### 流控原理 
UPF和LNS 在L2TP隧道创建过程中的SCCRQ、SCCRP消息里携带Receive Window Size这个AVP，了解对端的L2TP消息并发处理能力。
例如：UPF/LNS在Receive Window Size消息中指示接收窗口为N，对端可以在没有收到确认的情况下最多发送N个消息。如果没有发送这个AVP，对端必须假设接收窗口是4（协议规定的默认值）。 
##### 防御策略 
本功能默认开启。没有开关，通过协议实现。 
UPF根据对接的LNS数量决定本端接收窗口大小。 
UPF支持按APN配置决定本端接收窗口大小。 
##### 配置方法 
配置L2TP接收窗口为20。 
[SET L2TPCFG](None):NAME="aaa",LACWINSIZE=20
## UDM/AUSF流控 
因网络故障、系统升级、特殊事件、终端及应用等多种原因，均可能引发信令风暴，为保证业务稳定运行需部署相应的流控方案来预防、抑制信令风暴，避免网络拥塞及过载。 
UDM/AUSF提供自保流控、周边网元过载保护等多套解决方案，对信令风暴进行综合治理。
分类|解决方案|方案说明|是否建议开启|开启方式
---|---|---|---|---
自保流控|入向消息流量控制|控制单位时间内允许通过的单业务消息量和全部业务消息总量。全部业务消息总量的计算方式为各个单项业务消息的加权叠加。|是|默认开启
系统资源过负荷控制|自保流控|基于系统资源负荷（CPU、数据区）进行自适应动态控制入向消息流量。当系统资源饱和时，有计划的对入向业务进行流控，尽量保证有资源接纳高优先级业务。|是|默认开启
出向异常NF检测|自保流控|基于PDB负荷作为参考指标和保护对象，识别并隔离异常NF的流量，防止少量异常NF过多占用系统资源，影响其他NF业务。|是|默认开启
周边网元过载保护|出向自适应流控|AUSF/UDM作为服务使用方，在服务提供方（比如AMF、SMF等）过负荷时，根据其返回的状态码主动进行流量控制或卸载处理。|是|默认开启
### 自保流控 
#### 入向消息流量控制 
##### 应用场景 
通过控制单位时间内通过的各个单业务消息量和全部业务消息总量，来限制大话务业务量的输入对系统的冲击。 
##### 保护对象 
UDM/AUSF 
##### 流控原理 
单业务消息量流控：UDM/AUSF对单业务操作流量进行统计和流控。一旦达到各类业务配置的流量门限，AUSF/UDM针对流量过高的NF发起的被拒业务返回HTTP 429(Too Many Requests)状态码。收到该状态码后，对端NF应抑制到AUSF/UDM的请求消息数量。对于其他NF的被拒业务，则返回500(Internal Server Error)状态码。 
全部业务消息总量流控：AUSF/UDM支持以服务为单位对业务总流量进行控制，避免AUSF/UDM的CPU等资源满载。一旦达到配置的业务总流量门限后，AUSF/UDM返回500(Internal Server Error)状态码。收到该状态码后，对端NF应抑制到AUSF/UDM的请求消息数量。支持对以下服务消息的总流量控制：AUSF服务消息UEAUTH服务消息SDM服务消息UECM服务消息EE服务消息(NF) AUSF/UDM全服务消息 
各个业务处理实例将分别统计单位时间内单业务消息量和区分服务的业务消息总量，对于单位时间内超过配置的入向业务将予以拒绝或丢弃。 
入向业务控制不考虑CPU是否拥塞，配置后立即生效，迅速限制大话务业务量的输入。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
修改入向单业务流量门限：例如：修改AMF鉴权请求业务流控参数，为10000条/秒。SET SBISVCOLOPT:NFSOP="AUSF_GET_AUTHENTICATION_VECTOR_FOR_AMF",FLOWTHRESHOLD=10000; 
修改入向NFS总业务流量门限：例如：修改(NFS) Nudm_SDM服务消息流量为10000条/秒。SET SBISVCOLOPT:NFSOP="SDM_SERVICE",FLOWTHRESHOLD=10000; 说明：触发NFS总业务流控时，AUSF/UDM不支持分时分用户流控策略，可能会导致同一用户的连续多次业务请求（如鉴权、注册、获取数据、订阅数据变更通知等）出现随机业务失败的情况，影响单用户全流程业务成功率，请谨慎设置。 
修改入向NF总业务流量门限：例如：修改AUSF/UDM全服务消息流量为10000条/秒。SET SBISVCOLOPT:NFSOP="AUSF_UDM_SERVICE",FLOWTHRESHOLD=10000; 
#### 系统资源过负荷控制 


##### 应用场景 
系统过载时，通过控制入向流控防止拥塞恶化造成系统瘫痪，保证业务稳定和高优先级业务成功率。 


##### 保护对象 
UDM/AUSF 


##### 流控原理 
系统资源过负荷控制用于动态评估CPU负荷及实际处理话务量（各业务消息的处理个数）的关系，通过动态调整实际处理话务量（超出的话务量将被丢弃/拒绝，不再处理），来实现将CPU负荷控制在目标范围之内。
预期控制效果如[图1](1615949489266.html#z608ee0cc850c4dccb28555bb4ab16834__d987bfd0-0c49-4eec-8e99-d8dd5f2678e3)所示。
图1  系统资源过负荷控制


[]images/%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E8%B4%9F%E8%8D%B7.png)


 
系统资源阈值内（默认85%，可配置），提供最大处理能力。 

 
达到流控阈值后，优先保障高优先级业务。 

 
在某一个时间段内尽量保证一批用户全业务通过，并根据时间、负载进行用户轮换，即分时、分用户流控策略。 

 
负荷超过流控阈值（默认85%，可配置）以后，低优先级业务被优先丢弃，高优先级业务也在逐渐增加丢弃比例，降低系统负荷。 


##### 防御策略 
本功能默认开启，并推荐使用默认配置。 


##### 配置方法 
修改过负荷控制参数： 
例如：“过负荷阀值”设置为70%，“过负荷拒绝方式”设置为返回429状态码，“流控用户流转周期”设置为30s。 
[SET SBIOLOPT](None):OLTHRESHOLD=70,OLREJMODE=1,ROULETTECYCLE=30;


#### 出向异常NF检测 
##### 应用场景 
识别并隔离异常NF的流量，防止少量异常NF过多占用系统资源，导致整个系统瘫痪。
##### 保护对象 
UDM/AUSF 
##### 流控原理 
UDM以实时PDB负荷作为参考指标，当PDB占用率超过80%时启动异常NF检测和保护，识别并隔离异常NF的流量，防止少量异常NF过多占用系统资源，导致整系统瘫痪。

UDM的每个业务模块对NF的交互异常行为（请求/响应超时）进行统计，每"异常交互统计周期"（默认10s），如NF的连续无响应次数大于配置的"单个端局连续交互异常门限"（默认100次），则认定该NF为异常端局，UDM发送"外部网元无响应异常"告警。如果异常NF端局已占用PDB个数超出配置的"单个异常端局占用资源上限"（默认100个），或者所有异常端局占用PDB总数超出配置的"全部异常端局占用资源上限"（默认800个）时，则禁止接收来自异常端局的新业务或主发到这些端局的新业务，否则允许业务。拒绝接收新业务时，返回503状态码。禁止主发新业务时，上报"当前网元业务受控"呼损。 
当前异常端局的连续成功业务次数达到配置的"扫描周期内业务连续成功次数"（默认15次），判定端局恢复正常，并将端局从异常列表中删除。如果连续三个检查周期（每个周期默认10s，周期次数可通过"网络连续恢复正常次数"进行配置，默认3次），异常端局表中没有异常端局记录，且PDB占用小于70%，则对"外部网元无响应异常"告警进行恢复。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
修改出向异常NF检测相关参数： 
例如："异常交互统计周期"设置为10s，"单个端局连续交互异常门限"为100次，"单个异常端局占用资源上限"设置为100个，"全部异常端局占用资源上限"设置为800个，"扫描周期内业务连续成功次数"设置为15次“，"网络连续恢复正常次数"设置为3次。 
[SET SBIRESCTL](None):SCANTIMER=10,FAILTHRESHOLD=100,FAULTNFRES=100,ALLFAULTNFRES=800,SUCCTHRESHOLD=15,NWSUCCTHRESHOLD=3;
### 周边网元过载保护 
#### 出向自适应流控 
##### 应用场景 
在批量修改业务签约或者大量用户4/5G切换时，可能触发UDM/AUSF发送大量的请求消息给AMF/SMF。UDM/AUSF根据AMF/SMF返回的状态码进行流量控制，防止本端出向流量过大造成周边网元持续过载。
##### 保护对象 
AMF/SMF等周边SBI接口网元 
##### 流控原理 

AUSF/UDM作为服务使用方，在服务提供方（比如AMF、SMF等）过负荷时，根据其返回的状态码主动进行流量控制或卸载处理。 
收到HTTP 307 (Temporary Redirect)响应状态码时，支持根据响应中Location头部指示，将本次请求消息重定向至目标服务方。 
收到HTTP 429 (Too Many Requests)响应状态码时，支持抑制出向到该NF的请求流量。 
收到HTTP 503 (Service Unavailable)响应状态码时，支持抑制出向到该NF的请求流量。 
AUSF/UDM在检测到上述状态码时，参考3GPP TS29.500中SRE（Site Reliability Engineering）描述，根据AUSF/UDM的出向业务请求数量、接收的响应数量，动态计算出向流量丢弃率，实现出向自适应节流。 
##### 防御策略 
本功能默认开启，并推荐使用默认配置。 
##### 配置方法 
修改出向自适应流控参数： 
例如：出向消息拒绝率设置为1。 
[SET SBIOLOPT](None):OUTMSGREJRATE=1;
# 缩略语 
# 缩略语 
## ACR 
Accounting Request计费请求
## AMF 
Access and Mobility Management Function接入和移动管理功能
## APN 
Access Point Name接入点名称
## AUSF 
Authentication Server Function鉴权服务器功能
## AVP 
Attribute Value Pair属性值对
## BSF 
Binding Support Function绑定支持功能
## CGF 
Charging
Gateway Function 计费网关功能
## CHF 
Charging Function计费功能
## CPU 
Central Processing Unit中央处理器
## DNN 
Data Network Name数据网名称
## DRA 
Diameter Routing AgentDiameter路由代理
## FQDN 
Fully Qualified Domain Name完全限定域名
## ID 
Identifier识别
## IP 
Internet Protocol因特网协议
## L2TP 
Layer2 Tunneling Protocol第二层隧道协议
## LNS 
L2TP Network ServerL2TP网络服务器
## MME 
Mobility Management Entity移动管理实体
## NF 
Network Function网络功能
## OCI 
Overload Control Information过载控制信息
## PDB 
Process Data Block进程数据区
## PFCP 
Packet Forwarding Control Protocol报文转发控制协议
## PL 
Priority Level优先等级
## QoS 
Quality of Service服务质量
## QPS 
Queries-per-second每秒查询率
## SCP 
Service Control Point业务控制点
## SGSN 
Serving GPRS Support Node服务GPRS支持节点
## SMF 
Session Management Function会话管理功能
## STP 
Signaling Transfer Point信令转接点
## UDM 
Unified Data Management统一数据管理
## UDP 
User Datagram Protocol用户数据报协议
# 全融合接入解决方案 
## 方案概述 
### 背景 
运营商现已部署的2/3/4G融合部署架构，如[图1](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__815d6509-8b66-475c-a496-04a78d5cf323)所示。
图1  2/3/4G融合
[]images/1607930289527.png)
5G网络已进入商用阶段，4/5G互操作的网络架构，如[图2](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__1ff293af-9579-48d8-bf52-0013dcb30d3a)所示。
图2  4/5G互操作
[]images/1607930289574.png)
如[图1](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__815d6509-8b66-475c-a496-04a78d5cf323)、[图2](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__1ff293af-9579-48d8-bf52-0013dcb30d3a)所示：
为满足2/3/4G互操作业务连续性需求，3GPP协议定义了PGW与GGSN必须融合部署。 
为满足4/5G互操作业务连续性需求，3GPP协议上定义了PGW-C与SMF必须融合部署。 
为减少SGW-U与PGW-U网元间转发流量，建议将SGW-C和PGW-C融合部署。 
### 方案概述 
目前5G标准尚未定义2/3/4/5G全融合架构，中兴通讯提供了如下的2/3/4/5G全融合解决方案。 
融合控制面功能：融合GGSN-C/SGW-C/PGW-C/SMF功能，可支持2/3/4/5G用户的融合接入，适应多样的业务接入的需要。 
融合用户面功能：融合GGSN-U/SGW-U/PGW-U/UPF功能，可支持2/3/4/5G用户的融合接入，适应多样的业务转发的需要。 
从长期演进来看，[图1](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__815d6509-8b66-475c-a496-04a78d5cf323)和[图2](%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9.html#%E4%BA%A7%E5%93%81%E5%AE%9A%E4%BD%8D%E4%B8%8E%E7%89%B9%E7%82%B9-3FB53F69__1ff293af-9579-48d8-bf52-0013dcb30d3a)所示的两种架构分离部署存在较多问题：
网元种类多，运维难度增加。 
将非融合架构的用户接入到融合架构中，涉及到网元配置数据的复杂调整。 
异系统（例如：现网设备为非虚拟化设备，新建5G设备为虚拟化设备）之间同时进行扩缩容操作，难度大。 
2/3/4/5G融合部署存在多方面的优势： 
运维简便：融合部署减少网元节点，降低运维成本。 
效率提升：跨节点交互转变为节点内交互，降低信令负荷，提升信令成功率，提高转发效率，节省转发带宽。 
模块重用：部分模块可共享，与分离部署相比更加节约资源。 
动态共享：支持全接入模式，2/3/4/5G容量动态共享，避免为各种制式分别预留额外资源，节约资源成本。 
协调演进：2/3/4G向5G平滑演进，网络节点数量及组网不变，演进过程中避免频繁的网元销毁、新建。 
## 全融合局点采用服务化接口 
### 描述 

### 描述 


 

#### 应用场景 
现有的2/3G网络服务于物联网用户及部分人网用户，将长期存在并持续提供服务，退网可能性较小。未来设备将演进为2/3/4/5G融合设备，支持对2/3/4/5G用户进行策略控制和融合计费。 
#### 客户收益 
受益方|受益描述
---|---
用户|用户不感知该方案。
运营商|保护现有的2/3G网络，同时提供5G网络服务，节约建设成本。节省运维成本、提升运维效率。
#### 组网说明 
###### 网络建设初期组网架构 
由于全融合网络建设的复杂性，在网络建设初期，为保证用户业务正常进行，2/3/4G现网设备依然会存在。 
在这种情况下， 2/3/4G用户会接入到现网设备，4/5G互操作用户会通过现网设备接入到PGW-C/SMF。 
AMF/MME依据终端能力和签约情况选择PGW-C/SMF。只有5G终端才会选择到融合的PGW-C/SMF， 对于纯4G终端而言，签约了5G套餐也只能选择现网的SGW/PGW。因此，不会出现大量4G用户通过SGW接入到融合PGW-C/SMF导致PGW-C/SMF流量过大的问题。 
图1  网络建设初期
[]images/1607934576967.png)
###### 本地接入场景下的全融合网络组网架构 
本地接入场景下的全融合网络组网架构如[图2](1607926602112.html#z96ec1f54f632426a9e5e62d74fdaf5b0__19eeebcd-cbc0-4400-97ed-cd1a7d41e741)所示。
图2  本地接入场景下的全融合网络组网架构
[]images/1607934790536.png)
在本地接入场景下的全融合网络的组网架构中， 
SGW-C和GGSN-C/PGW-C/SMF是合一部署的。 
SGW-U和GGSN-U/PGW-U/UPF是合一部署的。 
N40+接口支持2/3G接入，即接入到PGW-C的2/3G用户的计费信息可以通过N40+接口与CHF交互。N40+接口是N40接口的扩展。 
N7+接口支持2/3G接入，即接入到PGW-C的2/3G用户的策略信息可以通过N7+接口与PCRF/PCF交互。N7+接口是N7接口的扩展。 
###### 漫游接入场景下的全融合网络组网架构 
漫游接入场景下的全融合网络组网架构如[图3](1607926602112.html#z96ec1f54f632426a9e5e62d74fdaf5b0__8f8bca14-3ba4-4b1a-9d80-b34619e24376)所示，当5G用户从本地移动到拜访地，可以通过插入I-SMF接入到PGW-C/SMF。
图3  漫游接入场景下的全融合网络组网架构
[]images/1607934820759.png)
在漫游接入场景下的全融合网络的组网架构中， 
针对国际漫游用户，SGW-C通过Ga接口生成承载级话单（按承载计费）。 
针对2/3G用户，GGSN-C/PGW-C/SMF通过N40+/N7+接口生成会话级话单（按会话计费）。 
#### 实现原理 
###### GGSN-C/SGW-C/PGW-C/SMF全融合 
控制面功能全融合架构图如[图4](1607926602112.html#zeff3daa60b82441ea23576c135989f99__1a9941e2-c166-4d67-aa4b-9d4fc71b2c18)所示。
图4  GGSN-C/SGW-C/PGW-C/SMF全融合
[]images/1607935360589.png)
控制面功能全融合后，系统有以下变化： 
SGW-C与PGW-C之间的S5-C接口采用内部接口。 
SGW-C通过Ga口使用CG进行计费。 
2/3G接入支持使用N7+接口。 
2/3G接入支持使用N40+接口。 
SGW-C不提供服务化接口。 
###### GGSN-U/SGW-U/PGW-U/UPF全融合 
用户面功能全融合架构图如[图5](1607926602112.html#zeff3daa60b82441ea23576c135989f99__d201c3d9-6f4e-47bd-a421-ca55e3407c74)所示。
图5  GGSN-U/SGW-U/PGW-U/UPF全融合
[]images/1607935378170.png)
用户面功能全融合后，系统有以下变化： 
SGW-U与PGW-C之间的S5-U接口采用内部接口。 
### 配置 
### 配置 
#### 配置前提 
###### 前提条件 
核心网各网元已完成4、5G业务的基础配置，并保证5G用户的N7和N40接口信令交互正常。 
###### SMF数据规划 
配置项|参数名称|参数取值|说明
---|---|---|---
APNDNN接口模式配置模板|接口模式模板|interfacemode|该参数用于标识一个接口模式，对用户的计费和策略接口进行配置。|interfacemode
23G和纯4G用户的计费接口模式|APNDNN接口模式配置模板|N40|23G和纯4G用户的计费接口模式，选项如下。Ga/Gy：对承载进行计费，将计费信息通过Gy接口发给OCS。N40：对会话进行计费，将计费信息通过N40接口发给CHF。Ga+/Gy+：对会话进行计费，将计费信息通过Gy接口发给OCS。|N40
23G和纯4G用户的PCC接口模式|APNDNN接口模式配置模板|N7|23G和纯4G用户的PCC接口模式，选项如下。Gx：通过Gx接口与PCRF交互进行策略控制。N7：通过N7接口与PCF交互进行策略控制。|N7
5G用户的计费接口模式|APNDNN接口模式配置模板|N40|5G用户的ACC接口模式，选项如下。N40：对会话进行计费，将计费信息通过N40接口发给CHF。Ga+/Gy+：对会话进行计费，将计费信息通过Gy接口发给OCS。|N40
关联APNDNN基础配置|APN/DNN|cmnet|APN/DNN。该APN/DNN名称必须先通过ADD APNDNN命令进行配置。|cmnet
接口模板名|关联APNDNN基础配置|interfacemode|该参数用于配置与APN/DNN关联的接口模板名称。该模板名称必须先通过ADD INTERFACEMODEPROFILE命令进行配置。|interfacemode
用户面属性配置|用户面名称|UPF127|用户面名称，用于标识UP Function。该用户面名称必须先通过ADD UPNODE命令进行配置。|UPF127
SGW-U|用户面属性配置|是|该参数表示该UPF是否支持4G协议中的SGW-U功能。是：该UPF支持4G协议中的SGW-U功能。否：该UPF不支持4G协议中的SGW-U功能。|是
PGW-U|用户面属性配置|是|该参数表示该UPF是否支持4G协议中的PGW-U功能。是：该UPF支持4G协议中的PGW-U功能。否：该UPF不支持4G协议中的PGW-U功能。|是
SGW-S8|用户面属性配置|是|该参数表示该UPF是否支持4G协议中SGW-S8接口。是：该UPF支持4G协议中SGW-S8接口。否：该UPF不支持4G协议中SGW-S8接口。|是
PGW-S8|用户面属性配置|是|该参数表示该UPF是否支持4G协议中PGW-S8接口。是：该UPF支持4G协议中PGW-S8接口。否：该UPF不支持4G协议中PGW-S8接口。|是
其他参数|用户面属性配置|使用初始配置，无需修改|-|使用初始配置，无需修改
TAC组配置|TAC组名称|upf127_tacgrp|TAC组名称。|upf127_tacgrp
TAC类型|TAC组配置|TAC|TAC类型，用于区分不同的接入类型，3G对应LAC、值为1，4G对应TAC、值为2，5G对应TACNR、值为3。|TAC
用户面关联TAC组配置|用户面名称|UPF127|用户面名称，该用户面名称必须已经存在，即需要先通过ADD UPNODE命令进行配置|UPF127
TAC组名称|用户面关联TAC组配置|upf127_tacgrp|支持4G接入类型的TAC组名称。该TAC组必须已经存在，即需要先通过ADD TACGROUP命令进行配置。|upf127_tacgrp
GWU类型|用户面关联TAC组配置|SGWU|PGWU|GWU类型，默认值为SGWU。
TAC分段配置|段名称|TAC1|段名称，不同TAC段的名称不能重复。|TAC1
START(十六进制)|TAC分段配置|0x6001|段起始TAC值，不能大于END。|0x6001
END(十六进制)|TAC分段配置|0x6001|段终止TAC值，不能小于START。|0x6001
TAC组名称|TAC分段配置|upf127_tacgrp|支持4G接入类型的TAC组名称。该TAC组必须已经存在，即需要先通过ADD TACGROUP命令进行配置。|upf127_tacgrp
###### UPF数据规划 
配置命令项|参数名称|参数取值|说明
---|---|---|---
CP关联地址配置|CP网元ID|28|该参数用于设置CP网元ID，用于唯一标识一个CP网元，即控制面网元。该参数为必选参数。|28|28|28|28
CP网元名称|CP关联地址配置|SMF128|该参数用于设置CP网元名称。该参数为必选参数。|SMF128|SMF128|SMF128|SMF128
IP地址类型|CP关联地址配置|IPv6|该参数用于设置IP地址类型。有IPv4和IPv6两种类型。该参数为必选参数。|IPv6|IPv6|IPv6|IPv6
IPv6地址|CP关联地址配置|195:168:128:4::11|该参数用于设置CP关联IPv6地址。当IP Version取值为IPv6时，该参数为必选参数。|195:168:128:4::11|195:168:128:4::11|195:168:128:4::11|195:168:128:4::11
网络实例|CP关联地址配置|N4|该参数用于设置网络实例，网络示例可以通过SHOW VPNINSTANCE命令进行查询。|N4|N4|N4|N4
CP网元类型|CP关联地址配置|"SGW_C"&"PGW_C"&"SMF"|该参数用于设置CP网元充当的角色。包括SGW_C、PGW_C、TDF_C、SMF。|"SGW_C"&"PGW_C"&"SMF"|"SGW_C"&"PGW_C"&"SMF"|"SGW_C"&"PGW_C"&"SMF"|"SGW_C"&"PGW_C"&"SMF"
其他参数|CP关联地址配置|默认值|-|默认值|默认值|默认值|默认值
4G网络实例配置|网络实例|SGW-S5u|SGW-S8u|PGW-S5u|PGW-S8u|S1u|网络实例名称
IPv6的VRF名称|4G网络实例配置|N9|N9|N9|N9|N3|IPv6的VPN实例名称
IPv6的VPN ID|4G网络实例配置|9|9|9|9|3|IPv6的VPN实例ID
其他参数|4G网络实例配置|默认值|其他参数使用默认值|默认值|默认值|默认值|默认值
4G网络接口业务地址配置|逻辑接口名称|SGW-S5u|SGW-S8u|PGW-S5u|PGW-S8u|S1u|该参数用于设置逻辑接口命令。
逻辑接口类型|4G网络接口业务地址配置|CORE|CORE|ACCESS|ACCESS|ACCESS|用于指示逻辑接口类型。Access：接入网。Core：核心网。SGi-LAN：业务链。CP：控制面。L2TP：L2TP隧道传输协议。同一Interfacetype+Networkinstance下最多配置32个地址。
网络实例|4G网络接口业务地址配置|SGW-S5u|SGW-S8u|PGW-S5u|PGW-S8u|S1u|该参数用于指示该逻辑接口所在的IP域。同一Interfacetype+Networkinstance下最多配置32个地址。
IP地址类型|4G网络接口业务地址配置|IPv6|IPv6|IPv6|IPv6|IPv6|该参数用于表示逻辑接口地址的IP类型。有IPv4和IPv6两种类型
IPV6地址|4G网络接口业务地址配置|195:166:127:5::100|195:166:127:5::100|195:166:127:6::100|195:166:127:6::100|195:166:127:7::100|该参数在“IPVERSION”配置为“IPv6”时为必选参数。该参数用于指示逻辑接口的IPv6地址。
参考点类型|4G网络接口业务地址配置|S5S8U|S5S8U|S5S8U|S5S8U|S1U|该参数用于标识该逻辑接口是哪种3gpp referface point，可用于向NRF注册时携带的UPInterfaceTyp。判断具体注册的逻辑接口类型是N3，N6，N9。
其他参数|4G网络接口业务地址配置|默认值|-|默认值|默认值|默认值|默认值
#### 配置过程 
###### SMF配置步骤 
步骤|说明|操作
---|---|---
1|新增APNDNN接口模式配置模板，设置2/3/4/5G用户支持N40计费接口模式，2/3G和纯4G用户支持N7的PCC接口模式。|ADD INTERFACEMODEPROFILE:PROFILENAME="interfacemode",PURE4G23GACCINTERFACEMODE="N40",PURE4G23GPCCINTERFACEMODE="N7",5GACCINTERFACEMODE="N40"
2|修改关联APNDNN基础配置，配置APNDNN关联新增的接口模板。|SET MAPAPNDNNPROFILE:APNDNN="cmnet",INTERFACEMODEPROFILE="interfacemode"
3|修改对应的UPF支持SGW-U和PGW-U的功能及接口。|SET UPATTRIBUTE:UPNAME="UPF127",SGWUFUNC="true",PGWUFUNC="true",SGW_S8="true",PGW_S8="true"
4|增加用户面TAC组配置。|ADD TACGROUP:TACGROUPNAME="upf127_tacgrp",TYPE="TAC"
5|增加4G网元使用的TAC分段配置。|ADD TACSECTION:SECNAME=TAC1,STARTTAC=0x6001,ENDTAC=0x6001,TACGROUPNAME=upf127_tacgrp
6|增加用户面关联TAC组配置。|ADD UPTACGROUP:UPNAME="UPF127",TACGROUPNAME="upf127_tacgrp",GWUTYPE="SGWU"ADD UPTACGROUP:UPNAME="UPF127",TACGROUPNAME="upf127_tacgrp",GWUTYPE="PGWU"
###### UPF配置步骤 
步骤|说明|操作
---|---|---
1|设置CP关联地址，其中CP网元类型需要支持SGW_C、PGW_C和SMF。|ADD CPASSOCADDR:CPID=28,CPNAME="smf128",IPVERSION="IPV6",IPV6ADDR="195:168:128:4::11",NETWORKINSTANCE="N4",CPFUNC="SGW_C"&"PGW_C"&"SMF"
2|增加4G网络接口的网络实例配置。|ADD VPNINSTANCE:NETWORKINSTANCE="SGW-S5u",VPNID=0,VRFNAMEV6="N9",VPNIDV6=9,MS2MSMODE="INNERFORWARD"ADD VPNINSTANCE:NETWORKINSTANCE="SGW-S8u",VPNID=0,VRFNAMEV6="N9",VPNIDV6=9,MS2MSMODE="INNERFORWARD"ADD VPNINSTANCE:NETWORKINSTANCE="PGW-S5u",VPNID=0,VRFNAMEV6="N9",VPNIDV6=9,MS2MSMODE="INNERFORWARD"ADD VPNINSTANCE:NETWORKINSTANCE="PGW-S8u",VPNID=0,VRFNAMEV6="N9",VPNIDV6=9,MS2MSMODE="INNERFORWARD"ADD VPNINSTANCE:NETWORKINSTANCE="S1u",VPNID=0,VRFNAMEV6="N3",VPNIDV6=3,MS2MSMODE="INNERFORWARD"
3|增加4G网络接口业务地址。|ADD LOGICIP:LOGICIPNAME="SGW-S5u",INTTYPE="CORE",NETWORKINSTANCE="SGW-S5u",IPVERSION="IPV6",IPV6ADDR="195:166:127:5::100",STATUS=NORMAL,PUBLISHBGPROUTE="ON",UPINTERFACETYPE="S5S8U"ADD LOGICIP:LOGICIPNAME="SGW-S8u",INTTYPE="CORE",NETWORKINSTANCE="SGW-S8u",IPVERSION="IPV6",IPV6ADDR="195:166:127:5::100",STATUS=NORMAL,PUBLISHBGPROUTE="ON",UPINTERFACETYPE="S5S8U"ADD LOGICIP:LOGICIPNAME="PGW-S5u",INTTYPE="ACCESS",NETWORKINSTANCE="PGW-S5u",IPVERSION="IPV6",IPV6ADDR="195:166:127:6::100",STATUS=NORMAL,PUBLISHBGPROUTE="ON",UPINTERFACETYPE="S5S8U"ADD LOGICIP:LOGICIPNAME="PGW-S8u",INTTYPE="ACCESS",NETWORKINSTANCE="PGW-S8u",IPVERSION="IPV6",IPV6ADDR="195:166:127:6::100",STATUS=NORMAL,PUBLISHBGPROUTE="ON",UPINTERFACETYPE="S5S8U"ADD LOGICIP:LOGICIPNAME="S1u",INTTYPE="ACCESS",NETWORKINSTANCE="S1u",IPVERSION="IPV6",IPV6ADDR="195:166:127:7::100",STATUS=NORMAL,PUBLISHBGPROUTE="ON",UPINTERFACETYPE="S1U"
## 全融合局点采用非服务化接口 
### 描述 

### 描述 


 

#### 应用场景 
部分运营商对支持服务化接口的计费功能改造困难，周期长，为了快速推出5G业务，可以在现有CG/OCS设备进行改造，以支持5G相关字段。 
#### 客户收益 
受益方|受益描述
---|---
用户|该方案用户不感知。
运营商|对现网设备改造，快速开展5G业务，增加营收。充分利用现有投资，降低成本。
#### 组网说明 
新建融合设备（C面的融合设备及U面的融合设备）可以实现5G用户接入，同时对于2、3、4G用户而言，新建设备与现网设备组POOL实现负荷分担。 
CG/OCS没有设计新的接口，在原有接口上进行扩展，变为Ga+/Gy+，支持5G用户的计费功能。 
图1  组网说明
[]images/Ch-0XV_O7RuAQVMyAADj_aZMbdY430.png)
图中的红色实线表示数据流。 
#### 实现原理 
###### Ga+计费功能 
现有的Ga计费的原理如[图2](1607926660502.html#zeff3daa60b82441ea23576c135989f99__1077253f-7cbc-4fae-b1fa-ec9013b9fcd0)所示。
Ga计费以承载为粒度生成话单，每个承载生成的话单有唯一的一个Charging ID。每个承载生成的话单内部对不同Service ID、Rating Group的业务用量进行了细分。 
图2  现有Ga计费原理
[]images/1608086699683.png)
Ga+支持按会话计费，原理如[图3](1607926660502.html#zeff3daa60b82441ea23576c135989f99__9bf3850b-d903-466c-9645-9b140de9780b)所示。
与N40接口的离线会话计费一样，Ga+接口以PDU会话为粒度建立计费会话，每个计费会话绑定一个Charging ID，计费会话内部可针对不同Service ID、Rating Group的业务用量进行细分。 
4/5G互操作用户及2/3/4G用户均可使用Ga+接口进行计费。 
图3  Ga+计费
[]images/1608087304291.png)
###### Gy+计费功能 
现有的Gy计费的原理如[图4](1607926660502.html#zeff3daa60b82441ea23576c135989f99__a2b3adff-bc3f-4787-8ac1-2767a479c25d)所示。
基于承载为粒度建立Gy口Diameter会话，每个Diameter会话绑定承载的Charging ID。每个承载内部可细分不同Service ID、Rating Group的业务，在其归属的Diameter会话内单独进行信用控制。 
图4  现有Gy计费
[]images/1608088072211.png)
Gy+支持按会话计费，原理如[图5](1607926660502.html#zeff3daa60b82441ea23576c135989f99__1210f54b-c1a4-4c1e-9b08-d77b9484062c)所示。
与N40接口的在线计费会话一样，Gy+计费以PDU会话为粒度建立计费会话，每个计费会话绑定一个Charging ID，计费会话内部可针对不同Service ID、Rating Group的业务用量进行细分。 
4/5G互操作用户及2/3/4G用户均可使用Gy+接口进行计费。 
图5  Gy+计费
[]images/1608088147612.png)
#### 应用限制 
开启Ga+/Gy+接口功能时，有以下限制： 
系统不支持多锚点功能，包括本地分流（即ULCL分流），Multi-Homing功能，SSC Mode3。 
系统不支持碎片话单功能。 
### 配置 

### 配置 


 

#### 配置前提 
###### 前提条件 
各网元已完成开局初始配置，保证用户可以正常接入，正常使用数据业务。 
现网CG/OCS设备改造前，核心网已完成跟CG/OCS的对接，并且离线/在线话单可以正常生成。 
已开通离线内容计费功能和在线内容计费功能，具体操作参见ZUF-82-13-002 离线内容计费和ZUF-82-13-003 在线内容计费。 
###### SMF数据规划 
配置项|参数名称|参数取值|说明
---|---|---|---
话单字段携带配置|话单类型|PCDR|话单类型，取值如下：GCDR：GGSN输出的话单。PCDR：PGW输出的话单。SGWCDR：SGW输出的话单。
话单字段|话单字段携带配置|TRAFFICVOLUME|话单中的字段。
携带|话单字段携带配置|ENABLE|配置指定的话单类型中是否携带指定的话单字段。参数取值如下：关闭：不携带。打开：携带。
新增APNDNN接口模式配置模板，设置23G和纯4G用户的计费接口模式|接口模式模板|interfacemode|该参数用于标识一个接口模式，对用户的计费和策略接口进行配置。
23G和纯4G用户的计费接口模式|新增APNDNN接口模式配置模板，设置23G和纯4G用户的计费接口模式|Ga+/Gy+|23G和纯4G用户的计费接口模式，选项如下。Ga/Gy：对承载进行计费，将计费信息通过Gy接口发给OCS。N40：对会话进行计费，将计费信息通过N40接口发给CHF。Ga+/Gy+：对会话进行计费，将计费信息通过Gy接口发给OCS。
23G和纯4G用户的PCC接口模式|新增APNDNN接口模式配置模板，设置23G和纯4G用户的计费接口模式|Gx|23G和纯4G用户的PCC接口模式，选项如下。Gx：通过Gx接口与PCRF交互进行策略控制。N7：通过N7接口与PCF交互进行策略控制。
5G用户的ACC接口模式|新增APNDNN接口模式配置模板，设置23G和纯4G用户的计费接口模式|Ga+/Gy+|5G用户的ACC接口模式，选项如下。N40：对会话进行计费，将计费信息通过N40接口发给CHF。Ga+/Gy+：对会话进行计费，将计费信息通过Gy接口发给OCS。
修改关联APNDNN基础配置|APN/DNN|cmnet|APN/DNN。该APN/DNN名称必须先通过ADD APNDNN命令进行配置。
接口模板名|修改关联APNDNN基础配置|interfacemode|该参数用于配置与APN/DNN关联的接口模板名称。该模板名称必须先通过ADD INTERFACEMODEPROFILE命令进行配置。
#### 配置过程 
###### SMF配置步骤 
步骤|说明|操作
---|---|---
1|设置PGW话单里面携带TRAFFICVOLUME相关的字段。|SET CDRCARRY:CDRTYPE="PCDR",CDRFIELD="TRAFFICVOLUME",CARRY="ENABLE"
2|新增APNDNN接口模式配置模板，设置2/3/4/5G用户支持Ga+Gy+计费接口模式，适配改造后的CG/OCS。|ADD INTERFACEMODEPROFILE:PROFILENAME="interfacemode",PURE4G23GACCINTERFACEMODE="GaplusGyplus",PURE4G23GPCCINTERFACEMODE="Gx",5GACCINTERFACEMODE="GaplusGyplus"
3|修改关联APNDNN基础配置，配置APNDNN关联新增的接口模板。|SET MAPAPNDNNPROFILE:APNDNN="cmnet",INTERFACEMODEPROFILE="interfacemode"
# 端到端切片解决方案 
## 方案概述 
### 背景 
5G时代，移动通信将进一步发展并触及各种垂直行业，成为社会数字化发展的强力催化剂。但业务需求的多样性为运营商带来了巨大的挑战，例如智能家居、智能电网、智能农业需要大量的额外连接和频繁传输小数据包的服务支撑，自动驾驶和工业控制要求毫秒级时延和接近100%的可靠性，而娱乐信息服务则要求高质量的固定或移动宽带连接。国际电信联盟将5G时代的业务归纳成三种典型的类型，增强型移动宽带（eMBB）、超高可靠性低时延业务（URLLC）和海量机器类通信（mMTC）。
为满足不同的网络及业务需求，3GPP针对5G网络提出了网络切片（Network Slice，简称切片）的概念。通过网络切片，使得运营商能够在一个通用平台之上构建多个专用的、虚拟化的、互相隔离的逻辑网络，来满足不同客户对网络能力的不同要求，实现按需的网络能力和灵活的运行与管理。 
### 切片解决方案 
5G网络切片是基于现有物理网络资源（如核心网设备、承载网设备、无线网络设备）之上的一个逻辑网络概念。定义和部署这个逻辑网络的目的，是基于统一的物理基础设施用于满足不同行业、不同用户的业务需求及网络特性。 
5G网络切片是提供特定网络能力的、端到端的逻辑专用网络。一个网络切片实例是由网络功能和所需的物理/虚拟资源的集合，由无线、传输和核心网的子网络切片实例组成。从编排部署的角度看，切片的编排部署，就是每个子切片的编排部署以及子切片之间网络连接关系的部署。 
## 部署方案 
### 系统架构 
端到端切片系统架构图如[图1](1602816677580.html#z22d3a6099f75441b9ab9d18841d994ec__b989c91c-f170-4b08-88cc-47dcecb69a43)所示。
图1  端到端切片系统架构
[]images/%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%88%87%E7%89%87%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png)
端到端切片包括管理域和设备域。管理域和设备域又分为无线、承载和核心网三个网络子域： 
无线侧提供网管UME和基站设备，可实现无线侧子切片的配置和管理。 
核心网侧提供5GC NF、UME(R50)、GSO三个产品，可实现核心网子切片的配置和管理。 
承载侧提供UME和承载设备，可实现承载侧的子切片配置和管理。 
### 管理架构 
为了实现网络切片的管理，5G网络中新增了网络切片的管理功能，包括NSMF和NSSMF。
实际场景中，NSMF存在以下两种实现方式： 
NSMF由GSO承担，GSO支持5G切片网络的蓝图设计，虚拟化网络资源的实例化部署，以及无线站点与核心网之间的切片链路建立。GSO承担NSMF时网络切片管理架构如图1所示。图1  GSO承担NSMF时网络切片管理架构 
NSMF由运营商自建，负责切片设计、部署、指标监控，提供无线侧、承载网和核心网的端到端切片管理能力。运营商自建NSMF的网络切片管理架构如图2所示。图2  运营商自建NSMF的网络切片管理架构切片管理系统NSMF，主要负责切片网络的设计、编排、部署和运维。主要功能包括：端到端的切片设计。提供切片模板NST（Network Slice）设计功能，切片在实例化之前需要先进行设计，将对应的无线子切片NSST、核心网NSST、承载NSST关联到对应切片NST上。切片的实例化部署。通过NSMF与无线EM（对应无线UME产品）、承载EM（对应承载UME产品）、核心网NSSMF之间的接口，创建并激活具体的切片实例，同时可去激活和删除已有切片实例。切片的SLA指标监控。通过采集各子切片的性能数据，汇聚为端到端切片的SLA指标提供给NSMF。目前支持上下行时延、上下行吞吐量和在线用户数指标的监控。无线子切片管理系统RAN NSSMF，负责无线侧的切片管理。提供NSMF-NSSMF接口供NSMF管理切片时使用，产品集成在无线UME网管中。主要功能包括：提供无线子切片NSST模板供NSMF调用，同时可支持无线子切片的配置。无线UME自身的网元管理功能。支持切片的告警数据、性能数据的采集和北向对接。承载子切片管理系统TN NSSMF，负责承载传输侧的切片管理，提供NSMF-NSSMF接口供NSMF管理切片时使用，产品集成在承载UME网管中。主要功能包括：提供承载子切片NSST模板供NSMF调用，同时可支持承载子切片的配置。承载UME自身的网元管理功能。支持切片的性能数据的采集和北向对接。核心网子切片管理系统CN NSSMF，负责核心网子切片管理。CN NSSMF集成在GSO中，即GSO承担核心网NSSMF子切片管理的功能，与无线NSSMF、承载NSSMF系统共同实现跨专业网的5G切片网络部署。CN NSSMF通过NSMF-NSSMF接口实现和NSMF模块之间的交互。主要功能包括：提供核心网子切片NSST模板创建、删除、修改，同时可支持核心网子切片的配置。与核心网EM对接，采集核心网设备的告警数据、性能数据，并生成核心网子切片的告警和性能数据。 
### 网络平面拉通 
#### 拉通原理 
切片端到端网络拉通原理如[图1](1602817507804.html#zae841882f1f642ad8743d902e879bc13__3000875e-7363-4216-a855-d4a89da9a52e)所示。
图1  切片端到端网络拉通原理
[]images/%E5%88%87%E7%89%87%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%BD%91%E7%BB%9C%E6%8B%89%E9%80%9A%E5%8E%9F%E7%90%86.png)
切片端到端网络拉通，主要通过关联无线、承载网和核心网端到端切片的方式实现。无线、承载网和核心网端到端切片通过VLAN
ID来关联，不同的切片基于VLAN区分。切片和VLAN的配置根据网络规划情况进行分配和实时配置。 VLAN仅是二层属性，只需保证节点唯一即可，不需要全局都保持一致。以下举例说明。 
无线站点对应切片VLAN 1000、VLAN1001与承载子切片的接入VLAN进行映射。 
核心网UPF出DC连接承载网EOR设备的VLAN 2000、VLAN2002与承载网子切片的VLAN进行匹映射。
 说明： 
目前，端到端切片解决方案主要实现媒体面数据的切片，因而主要对UPF进行切片路由的VLAN映射，AMF等控制面网元不做映射。 
确定切片的映射VLAN关系之后，各自进行相应的配置。 
创建承载切片子网（以VR切片为例），具体步骤如下： 
在各PE上创建VRF。
在无线CU侧PE创建子接口，VLAN ID=1000，IP=192.168.10.2。 
在CN侧PE创建子接口，VLAN ID=2000，在该子接口配置两个IP：192.168.20.3和192.168.21.3。 
分别将以上子接口与VRF绑定。 
创建连接各个PE的VRF之间的隧道，此隧道需满足用户切片的SLA要求。 
完成VRF路由扩散，将基站路由扩散至CN侧PE，将UPF路由扩散至CU侧PE。 
#### VLAN/IP/VRF规划示例 
以下述场景为例，说明无线与承载，承载与核心网对接相关的切片VLAN/IP/VRF规划。其中，切片1和切片2均通过RAN连接承载网络的同一个端口，并通过IP/VLAN隔离。 
切片端到端VLAN网络配置示例如[图2](1602817507804.html#zae841882f1f642ad8743d902e879bc13__9f7a1c77-c8fa-4648-b726-a3462a706544)所示。
图2  切片端到端VLAN网络配置
[]images/%E5%88%87%E7%89%87%E7%AB%AF%E5%88%B0%E7%AB%AFVLAN%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B.png)
承载网络中，与RAN/5GC对接均采用10GE端口，在承载网络内部为切片1分配10GE FlexE时隙，为切片2分配10GE
FlexE时隙。对所有业务，承载网均采用L3VPN Over SR Over FlexE业务模型。 
承载PE与基站对接的接口切片1：VLAN 1000，IP：192.168.10.x切片2：VLAN 1001，IP：192.168.11.x基站控制面：VLAN 1002，IP：192.168.12.x基站管理面：VLAN 1003，IP：192.168.13.x 
承载PE与核心网对接时，采用一个端口连接CE交换机，配置四个VLAN：VLAN2000对应切片1的UPF接口IP：192.168.20.x/192.168.21.xUPF业务IP：192.168.100.1VLAN2002对应切片2的UPF接口IP：192.168.22.x/192.168.23.xUPF业务IP：192.168.101.1VLAN2004对应核心网AMF接口IP：192.168.24.xAMF业务IP：192.168.102.1VLAN2100对应无线网管UME接口IP：192.168.30.xUME业务IP：192.168.110.1交换机采用不同端口连接到UPF/AMF/UME，到同一个UPF的2个L3接口可能属于同一物理接口，也可能属于不同物理接口（根据UPF是位于一台物理机还是分别位于两台物理机），交换机根据VLANID将报文转发至UFP或者AMF。 
因交换机仅做L2转发，承载网PE与UPF之间采用多个L3接口时，配置为ECMP方式，L3接口上启用BFD检测。 
## 三网子切片设计 
### 无线子切片设计 
#### 概述 
无线子切片设计指的是对无线子切片模板RAN NSST及配套的无线业务参数模板的设计。无线业务参数模板用于配套具体业务场景提供具体的业务参数。
无线子切片实例RAN NSSI基于子切片模板和对应的无线业务参数模板，生成实例化参数并完成实例创建。
#### 总体要求 
设计无线子切片模板RAN NSST和配套无线业务参数模板，包括：子切片模板基本信息（比如：标识、子切片类型等）。切片PRB保留策略。切片QoS映射策略等信息。 
支持在图形化界面创建、修改、删除和查询子切片模板，并绑定子切片模板的业务参数模板。 
支持导入、导出子切片模板NSST文件和无线业务参数模板文件。 
支持在同一业务参数模板中，设计多个不同的业务参数组合以便于实现不变更NSST模板的情况下，不同NSSI实例的不同能力的切换和变更。不同业务能力通过S-NSSAI来进行标识，从而映射到业务层面的不同编排规格。 
### 无线子切片配置概述 
#### 配置效果 
通过终端及无线侧配置，可实现无线切片选择及无线切片级资源预留。通过配置映射数据，将无线参数转化为传输侧需求，提供给传输进行转发调度。针对隔离度要求高的切片可按需配置用户组数据、CAG cell、专用的频段划分等数据。 
#### 终端接入切片配置 
终端接入切片配置涉及预配置和BOSS开通两个配置域。 
预配置预配置的NSSAI（Default configured NSSAI）可选，也可以由PCF在线下发。预配置URSP规则。 
BOSS开通EHPLMN：可选。采用多PLMN ID方案下适用。需在USIM卡中写入EHPLMN数据（46000、46002等）。CAG Identifier：PNI-NPN（非独立组网的非公众网络）适用。CAG ID用于选择对应的CAG Cells。同时签约数据中还具备Allowed CAG ID list，CAG-only标识来标识用户只能通过特定的CAG cell接入PLMN。 
领域|配置域|配置类型|配置内容
---|---|---|---
终端|预配置|切片标识|default configured NSSAI
终端|预配置|URSP|预配置的URSP
终端|BOSS开通|EHPLMN|EHPLMN ID
终端|BOSS开通|CAG ID|CAG ID
#### 无线子切片配置 
无线子切片配置涉及编排配置和网管配置两个配置域。 
编排配置：切片用户组数据配置切片用户组ID配置组内切片ID配置共享/专用标志配置用户组内切片对应的预留的PRB资源比例配置预留的PRB中专用PRB资源比例。可配置设置部分资源为切片内用户专用 说明：目前切片用户组参数通过厂家NSSMF自动配置，网管不感知。 
网管配置切片选择数据配置NSSAI和AMF（Set）映射数据若UE未提供辅助信息以支持AMF选择，则NG-RAN会将NAS消息路由到默认的AMF灵活帧结构配置、灵活带宽配置配置CAG cell（PNI-NPN场景适用）切片映射数据切片ID（NSSAI）与VLAN ID的映射数据切片与QoS优先级映射数据，如针对相同QoS但不同切片的情况，通过ARP等参数引入切片优先级 
领域|配置域|参数类型|配置类型|配置内容
---|---|---|---|---
无线|网管配置域|业务参数|切片选择数据|NSSAI和AMF（Set）映射数据
无线|编排配置域|业务参数|切片用户组|用户组ID组内切片ID用户组共享专用标志PRB配置
无线|网管配置域|业务参数|灵活无线资源配置|灵活帧结构灵活带宽
无线|网管配置域|业务参数|CAG|CAG cell
无线|网管配置域|映射参数|切片映射数据|NSSAI与VLAN ID映射数据NSSAI与QoS Priority映射数据
 说明： 
基站应支持配置至少15个切片。 
### 传输与承载子切片设计 
#### 概述 
承载子切片规划基于切片的VLAN分配、划分VPN ，并根据专网专线场景规划承载子切片的软硬通道。传输SPN的切片设计包括硬隔离(FLEX E)技术、软隔离(VPN)技术、QoS保障。 
#### 传输隔离能力划分 
传输隔离能力划分为以下几类： 
T10|T20|T30
---|---|---
T11：共享MTN接口|T21：共享分组隧道|T31：VPN共享
T12：专用MTN 2.0通道（小颗粒）|T22：专用分组隧道|T32：VPN隔离
T13：专用MTN 1.0通道（N*5G颗粒）|-|-
T11：共享MTN接口SPN共享的硬切片通道，最小颗粒度5G带宽，无MTN交叉。 
T12：专用MTN接口和MTN通道 SPN专用的硬切片通道，最小颗粒度5G带宽，具备MTN交叉。 
T13：专用MTN接口和小颗粒通道 SPN专用的硬切片通道，最小颗粒度10M带宽，具备MTN交叉和小颗粒带宽支持能力。 
T21:共享分组隧道 支持MPLS-TP隧道共享和SR-TP隧道共享，切片业务基于隧道共享创建。 
T22:隔离分组隧道 支持MPLS-TP隧道共享和SR-TP隧道共享，切片业务基于隧道共享创建。 
T31:VPN共享 业务共享VPN。 
T32:VPN隔离业务通过VPN隔离。 
### 承载子切片配置概述 
#### 配置效果 
通过配置传输网业务参数，可实现传输QoS保障。通过配置映射数据，可实现传输网络切片的软/硬隔离及传输承载VLAN接入对应VPN。  
目前传输网仅能基于VLAN Priority进行调度，需确保无线侧上来的对应切片能够进入正确的传输通道中以保证切片端到端参数配置一致性。 
#### 传输子切片配置 
传输网需要通过传输编排配置域，由SC向OMC配置如下内容： 
传输业务参数配置VPN的带宽、保护、恢复、路由策略等参数 
VLAN优先级完成无线VLAN priority和VLAN ID与传输VLAN priority/DSCP的映射（确定无线优先级和传输优先级的映射表），使切片需求能映射到正确的DSCP列队中（VLAN priority与DSCP存在固定映射关系） 
切片映射数据配置VLAN和VPN映射数据配置切片与软/硬管道映射数据独享硬切片：将基站配置的独享VLAN ID与独占硬切片通道进行映射共享硬切片、独立软切片：将基站配置的独享VLAN ID与L3 VPN及SR隧道进行映射共享软切片：将基站配置的共享VLAN映射到共享L3 VPN及SR隧道中 
领域|配置域|参数类型|配置内容
---|---|---|---
传输|切片编排配置域|业务参数|VPN业务参数
传输|切片编排配置域|业务参数|VLAN优先级
传输|切片编排配置域|映射参数|VLAN->VPN
传输|切片编排配置域|映射参数|VLAN->软管道
传输|切片编排配置域|映射参数|VLAN->硬管道
#### 承载子切片配置 
承载网需要通过网管配置域配置如下内容： 
配置VLAN和VPN映射数据不同的VLAN子接口或者物理主接口按需接入VPN对于相同服务质量等级并且无隔离需求的业务，可以配置接入相同VPN对于对有隔离要求的业务，根据不同的主接口或者不同的vlan配置接入不同的VPN（如UPF分流场景） 
配置DC内外VLAN映射数据以保证在多云一网的情况下，云内VLAN映射到正确的云间VLAN中，可通过SDN编排器自动映射 
领域|配置域|参数类型|配置内容
---|---|---|---
承载|网管配置域|映射参数|VLAN<->VPN，相同VPN
承载|网管配置域|映射参数|VLAN<->VPN，不同VPN
承载|网管配置域|映射参数|DC内VLAN<->DC外VLAN
### 核心网子切片设计 
#### 概述 
核心网子切片设计指的是对核心网子切片模板NSST的设计，核心网子切片实例NSSI基于此模板并结合具体的实例化参数完成实例创建。 
#### 总体要求 
设计核心网子切片模板NSST，包括：切片子网模板基本信息（例如：标识、切片子网类型等）。切片子网能力模型参数 (例如：用户数、时延、容量、移动性、可靠性等)。切片子网所包含资源模型（例如：NSD信息等）。切片子网策略模型信息（例如：SLA闭环策略、自愈策略等）。 
在没有单独设计NFV网络服务的情况下，核心网子切片设计应包括：NS的设计。核心网子切片网络资源设计。 
为了在子切片设计过程中获取网络服务模板信息，设计工具应支持导入NSD并管理导入的NSD。 
支持在图形化界面创建、修改、删除和查询子切片模板。 
支持导入、导出子切片模板NSST文件。 
支持在同一NSST模板中，设计多个不同的能力模型以及对应的资源模型的组合，以便于实现不变更NSST模板的情况下，NSSI实例在不同能力和规格之间的切换和变更。不同能力模型通过Flavor ID来进行标识，在资源层面与NSD的Flavor对应，从而映射到资源层面的不同编排规格。 
### 核心网子切片配置概述 
#### 配置效果 
通过核心网网元/NF局数据配置，可实现切片的接入控制、切片选择、切片策略签约、执行等功能。通过配置切片映射数据，可实现用户面、信令面针对ToB、ToC的切片的逻辑隔离。  
#### 核心网子切片配置 
核心网切片配置，主要涉及AMF、NRF、PCF、SMF、UPF、NSSF网元的如下配置内容： 
编排配置-MANO/边缘云管切片生命周期管理针对切片对资源的需求，NSSMF将需求下发给MANO进行网元的实例化或虚机扩容。针对网元的实例化/创建，取决于NSSI隔离性，不同应用场景下的实例化/创建需求不同。表1  不同应用场景下的实例化/创建需求领域配置域配置类型配置场景核心网编排配置域网元生命周期管理不进行网元实例化（切片完全共享NF）核心网编排配置域网元生命周期管理网元实例化（切片完全新建NF） 
网管配置配置切片到VLAN映射数据（SMF、UPF）切片局数据（通用部分）NF配置支持的切片（AMF、NSSF）NF可选配置授权切片allowed NSSAI（AMF）切片局数据（差异化部分）表2  分网元切片局数据配置网元局数据PCF URSP：配置URSP策略触发条件，配置URSP规则若切片涉及新的QoS，需定义/下发新的QoS Rule AMF配置切片与SMF的对应信息（可选）SMF 基于切片进行NAS接口拥塞控制配置切片对应的UPF配置切片的SM Policy (若涉及新的QoS，需定义新的QoS Rule和QoS Profile)UPF 配置切片对应的Predefined rule NSSF 配置PLMN、S-NSSAI、TAI与允许的NSSAI、AMF SET ID对应关系表 NRF 静态配置跨NRF查询数据，包括而不限于：SMF发现条件（切片、DNN）与NRF的映射关系UDM模板号 
BOSS开通/签约数据配置策略数据：包含新增/修改用户属性签约信息、业务策略、用户策略信息，同时将切片策略传递至UDR/PCF，将切片ID和用户/业务策略编码关联用户签约数据：包含创建新用户，新增/修改S-NSSAI签约数据，每用户最多签约16个S-NSSAI，每个S-NSSAI最多签约50条DNNURSP签约（包含在策略数据签约中） 
## 开通流程 
当前，中兴通讯提供两种端到端切片开通部署方式： 
在无线侧UME、承载网UME、核心网GSO分别创建三网子切片。将三网接口的配置文件提供给运营商，由运营商自建的NSMF拉通三网子切片并进行统一管理。 
由GSO统一部署并拉通三网子切片。 
由运营商自建NSMF系统拉通三网子切片流程如[图1](1602817271433.html#z012b9048ef7a4cf8900aca948055a185__f26ea5f8-1711-4baf-8d63-9904b2dd92eb)所示。
图1  GSO统一开通端到端切片流程
[]images/GSO%E7%BB%9F%E4%B8%80%E5%BC%80%E9%80%9A%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%88%87%E7%89%87%E6%B5%81%E7%A8%8B.png)
由GSO统一部署并拉通端到端切片的流程如[图2](1602817271433.html#z012b9048ef7a4cf8900aca948055a185__ad0a4a2a-cb6a-4db5-a749-3484faa96bf0)所示。
图2  运营商NSMF端到端切片开通流程
[]images/1606215989555.png)
其中，各软件部署联调包括：5GC VNF、GSO、UME、5G基站、无线UME，承载设备、承载UME安装部署完成，管理面通道打通。GSO与核心网EMS、无线UME、承载UME的网络打通。
## 手工开通三网子切片并接入NSMF 
### 开通无线子切片 
开通无线子切片可以基于图形化界面配置，也可以通过导入参数模板文件的方式进行批量操作。 
#### 开通无线子切片（图形化界面方式） 
##### 摘要 
本节介绍如何通过图形化界面的方式开通无线子切片功能。 
##### 前提 
承载网打通与无线RAN和5GC两侧的路由。 
##### 步骤 
在无线UME网管客户端，选择菜单无线配置管理→MO编辑器
，选择需要配置的网元进行配置。
选择传输网络→接口
节点，配置管理面、控制面及用户面VLAN等基站接口参数信息，如[图1](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__acbae343-dbd1-4b30-a8ce-45a37263c8b1)所示。
图1  配置基站接口信息
[]images/%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%AB%99%E6%8E%A5%E5%8F%A3%E4%BF%A1%E6%81%AF.png)
选择传输网络→IP层配置
节点，配置VLAN对应的IP信息，每个VLAN配置一个IP，如[图2](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__b5fd8393-526b-4003-881c-49682f5f5d4a)所示。
图2  配置基站IP信息
[]images/%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%AB%99IP%E4%BF%A1%E6%81%AF.png)
选择传输网络→5G业务承载通道
节点，配置VLAN对应的5G业务承载通道，如[图3](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__65b2feb3-cb87-458b-a49f-718aa7fae62a)所示。
图3  配置5G业务承载通道
[]images/%E9%85%8D%E7%BD%AE5G%E4%B8%9A%E5%8A%A1%E6%89%BF%E8%BD%BD%E9%80%9A%E9%81%93.png)
选择GNBCUUPFunction→网络切片
节点，配置切片业务类型、切片区分及关联的VLAN，如[图4](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__b94f9fd0-f3f1-425c-bea3-be52b045f13c)所示。
图4  配置网络切片
[]images/%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87.png)
选择gNB DU功能配置→网络切片配置
节点，配置切片状态，如[图5](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__965b6c6b-9a76-4215-b27b-0ca04a0f4eb0)所示。
图5  配置网络切片状态
[]images/%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E5%88%87%E7%89%87%E7%8A%B6%E6%80%81.png)
选择gNB DU功能配置→网络切片配置→切片关联业务配置
节点，配置跟踪区码及PLMN，如[图6](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__d4e2662b-3dae-4b6d-a504-864654ddd772)所示。
图6  配置切片关联业务
[]images/%E9%85%8D%E7%BD%AE%E5%88%87%E7%89%87%E5%85%B3%E8%81%94%E4%B8%9A%E5%8A%A1.png)
选择gNB DU功能配置→网络切片配置→切片关联业务配置→NSSAI配置
节点，配置切片业务类型及切片分区，如[图7](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__a9eea52c-09b2-476d-beb6-c3f99cf4e490)所示。
图7  配置切片业务类型及切片分区
[]images/%E9%85%8D%E7%BD%AE%E5%88%87%E7%89%87%E4%B8%9A%E5%8A%A1%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%88%87%E7%89%87%E5%88%86%E5%8C%BA.png)
选择gNB DU功能配置→UserGroupRrmPolicy
节点，以下行为例，配置三个切片组PRB资源保障策略，如[图8](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__af7ce912-c0cf-4394-9aed-e3b9f0f25bff)所示。参数说明参见[表1](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__f550ca18-4f24-4ab5-b9a6-67b311bc6e19)。
图8  创建切片组并配置PRB资源保障策略
[]images/%E5%88%9B%E5%BB%BA%E5%88%87%E7%89%87%E7%BB%84%E5%B9%B6%E9%85%8D%E7%BD%AEPRB%E8%B5%84%E6%BA%90%E4%BF%9D%E9%9A%9C%E7%AD%96%E7%95%A5.png)
切片组ID|下行资源类型dlQuotaType|下行分配资源的最小比例dlMinRatio|下行分配资源的最大比例dlMaxRatio|下行分配资源的最小保障比例dlMinMarginRatio
---|---|---|---|---
1|Strict|20%|60%|0
2|Float30|30%|50%|20%
4|Strict0|0|0|0
 说明： 
切片组2独占20%资源，30%-20%=10%的资源优先调度，50%-30%=20%的资源正常调度。 
切片组4不配置PRB资源保障。 
选择UserGroupRrmPolicy→UserGroupSliceList
节点，创建三个UserGroupSliceList，分别属于不同的UserGroupRrmPolicy，并配置PLMN标识，如[图9](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__517e3ab8-84e7-4ae1-9e12-102d3ec56487)所示。
图9  配置UserGroupSliceList
[]images/%E9%85%8D%E7%BD%AEUserGroupSliceList.png)
选择UserGroupRrmPolicy→UserGroupSliceLis→NetworkSliceInfoDU配置
节点，每个UserGroupRrmPolicy下的UserGroupSliceList分别配置1个切片，如[图10](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__6b11d3b1-7779-4eb5-955b-b69d2682ecc8)所示。
图10  配置NetworkSliceInfoDU
[]images/%E9%85%8D%E7%BD%AENetworkSliceInfoDU.png)
选择DU小区配置→PlmnGroupList配置
，开启切片PRB资源保障功能开关，如[图11](1603795105116.html#z9c1a7a05b9244429b0776f60cf4b7496__95bb96a6-1d49-4907-902f-0f342c4da789)所示。
图11  打开切片组PRB资源保障功能开关
[]images/%E6%89%93%E5%BC%80%E5%88%87%E7%89%87%E7%BB%84PRB%E8%B5%84%E6%BA%90%E4%BF%9D%E9%9A%9C%E5%8A%9F%E8%83%BD%E5%BC%80%E5%85%B3.png)
#### 开通无线子切片（参数模板方式） 
##### 摘要 
本节介绍如何通过参数模板文件方式开通无线子切片功能。 
##### 前提 
承载网开通与无线RAN和5GC两侧的路由。 
##### 步骤 
导出excel参数模板
在无线UME客户端，选择菜单无线配置管理→数据导出
，打开数据导出页面，如[图1](1603795108416.html#zb364d538fce44e98b94076614c04387f__6b44ec1b-0913-4982-98b9-12b88c4f43e8)所示。
图1  数据导出页面
[]images/%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E9%A1%B5%E9%9D%A2.png)
在数据导出页面，单击参数模板，选择自定义导出，选择网元类型、模型类型、单击选择网元按钮选择网元，并在左侧管理网元导航树下选择相应的配置项，如[图2](1603795108416.html#zb364d538fce44e98b94076614c04387f__01e4ceea-d879-4d75-bc7e-6306d512b57a)所示。
图2  参数模板页面
[]images/%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF%E9%A1%B5%E9%9D%A2.png)
单击导出按钮，导出参数模板文件，如[图3](1603795108416.html#zb364d538fce44e98b94076614c04387f__a40d8698-e3b0-42e1-ba5c-b07ab5294187)所示。
图3  导出参数模板文件
[]images/%E5%AF%BC%E5%87%BA%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6.png)

配置excel参数模板
导出的模板文件配置项说明参见[表1](1603795108416.html#zb364d538fce44e98b94076614c04387f__bdad1833-d2ec-4d1f-bbdf-9c73e491748a)。参考相关参数说明，按照规划进行相关配置的增加、修改、删除或维持不变。
管理对象名称|索引|描述
---|---|---
Interface|Interface|配置接口参数。
Ip|Ip|表示IP层相关参数的配置。
ServiceMap5g|ServiceMap5g|用于配置5G业务类型和DSCP之间的映射规则。
NetworkSliceInfo|NetworkSliceInfo|该MO节点用于配置不同的网络切片。每个网络切片之间通过不同的配置，实现传输数据的相互隔离。
NetworkSliceSubnet|NetworkSliceSubnet|该节点用于5G网络中网络切片实例的属性配置，通过配置此节点下的相关参数，可以为不同的切片设置不同的业务类型，可接纳的用户数等。
SliceProfile|SliceProfile|NSSI关联业务列表。
NSSAI|NSSAI|业务切片标识列表。
UserGroupRrmPolicy|UserGroupRrmPolicy|该节点用于设置UserGroupRrmPolicy相关配置。
UserGroupSliceList|UserGroupSliceList|该节点用于设置UserGroupSliceList相关配置。
NetworkSliceInfoDU|NetworkSliceInfoDU|业务切片标识列表。
PlmnGroupList|PlmnGroupList|该节点用于设置PlmnGroupList相关参数。
导入excel参数模板
在无线UME客户端，选择菜单无线配置管理→规划区管理
，创建规划区或使用已有的规划区。单击规划区后的打开按钮并选择导入导出，打开导入导出页面，如[图4](1603795108416.html#zb364d538fce44e98b94076614c04387f__8bbbcba0-c8e3-4d57-bcce-021660610fa4)所示。
图4  导入导出页面
[]images/%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E9%A1%B5%E9%9D%A2.png)
单击参数模板，在参数模板页面的导入模板处，选择已填写完成的参数模板文件，如[图5](1603795108416.html#zb364d538fce44e98b94076614c04387f__93fa805c-1b69-4706-810c-3659734876d6)所示。
图5  导入参数模板文件
[]images/%E5%AF%BC%E5%85%A5%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6.png)
在无线配置管理页面，选择数据激活→立即激活
，进行数据同步，如[图6](1603795108416.html#zb364d538fce44e98b94076614c04387f__e022642e-9a2c-4be3-8fa1-1d789af4491a)所示。
图6  立即激活
[]images/%E7%AB%8B%E5%8D%B3%E6%BF%80%E6%B4%BB.png)
##### 相关任务 
如果参数模板页面显示为空，则需要先进行创建参数模板的操作。 
在UME客户端，选择无线配置管理→模板管理
，单击创建，增加全参模板，如[图7](1603795108416.html#zb364d538fce44e98b94076614c04387f__4cbaaeaa-f724-4663-91cc-3abaff92723f)所示。
图7  创建参数模板
[]images/%E5%88%9B%E5%BB%BA%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF.png)
### 开通承载子切片 
#### 配置承载子切片数据 
##### 摘要 
本节介绍如何在承载UME客户端配置承载子切片数据。 
##### 步骤 
在承载UME客户端网络切片页面，配置承载子切片硬隔离，如[图1](1603807350199.html#z31f2795d54ee49439e476a2bcfb19fec__57d0c2e4-b27b-4d1a-9f62-3946ca28e478)所示。
图1  承载子切片硬隔离配置
[]images/%E6%89%BF%E8%BD%BD%E5%AD%90%E5%88%87%E7%89%87%E7%A1%AC%E9%9A%94%E7%A6%BB%E9%85%8D%E7%BD%AE.png)
在业务配置页面配置隧道软隔离技术，如[图2](1603807350199.html#z31f2795d54ee49439e476a2bcfb19fec__a83fe906-a0e9-4989-a183-910539fd28ac)和[图3](1603807350199.html#z31f2795d54ee49439e476a2bcfb19fec__60fbfb8c-51b5-47ea-9a0b-891d063f5772)所示。
图2  隧道软隔离技术配置
[]images/%E9%9A%A7%E9%81%93%E8%BD%AF%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E9%85%8D%E7%BD%AE.png)
图3  完成隧道软隔离技术配置
[]images/%E5%AE%8C%E6%88%90%E9%9A%A7%E9%81%93%E8%BD%AF%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E9%85%8D%E7%BD%AE.png)
在业务配置页面配置VPN软隔离技术，如[图4](1603807350199.html#z31f2795d54ee49439e476a2bcfb19fec__eb763272-7d3e-4fb1-b154-4f0984197544)所示。
图4  VPN软隔离技术配置
[]images/VPN%E8%BD%AF%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E9%85%8D%E7%BD%AE.png)
配置网元、链路。 
配置flexegroup、flexe channel、flexe以太网通道。 
#### 实例化承载子切片 
##### 摘要 
本节介绍如何进行承载子切片实例化操作。 
##### 步骤 
获取现场组网信息，根据组网信息配置切片实例化参数文件slice.xlsx。参数含义及配置方法参见[表1](1603942798689.html#zfdfd2c4301024c9f84eaf8d571c11755__88eae516-462a-4a55-9e30-25cd27dd6d19)。
字段|取值获取方法
---|---
网元ID|从拓扑→资源列表→网元中获取。
网元名称|固定格式：ME{网元ID}。
端口ID|UUID，可以保持模板示例内容不变。
端口名称|使用创建l3vpn功能，在用户侧配置中增加节点，选择网元后，按F12，打开chrome控制台，然后单击确定。在弹出的是否为此网元配置端口？提示框中，单击是，查看端口返回报文报文。
端口类型|固定填写UNI。
端点角色|对应L3VPN中的角色，101表示NPE，103表示UPE。
端口IP类型|L3VPN的U侧口ip地址，CIDR格式。
端口IP/掩码|L3VPN的U侧口掩码。
端口VLAN|L3VPN的U侧口VLAN。
FlexE切片ID|目前测试使用的都是基于物理网络的L3VPN，此处不填写。如果L3VPN基于切片，此处填充切片的UUID。
下一跳|对NPE侧有效，如果UPE和核心网连接没有使用动态协议，此处需要配置连接核心网的下一跳ip地址信息。
目的|对NPE侧有效，如果UPE和核心网连接没有使用动态协议，此处需要配置连接核心网的目的网段信息。
路由约束工作必经可选|第一个AC节点对应行配置此选项，此选项对应整个切片，配置创建隧道的路由约束信息。每条约束信息包含的信息是：隧道A端点UUID，隧道Z端点UUID，三层链路UUID，几个信息元素通过逗号分隔，如果要对多个隧道进行配置，多个隧道的约束之间通过分号分隔。其中，三层链路的UUID可以通过隧道功能进行查看，具体方式是：新建sr-te隧道，按F12，打开控制台，然后在路由约束处，选择类型三层链路查看返回的三层链路报文，根据隧道端点信息和方向，找到对应三层链路的UUID。
 说明： 
实例化参数文件的主要用途是配置L3VPN的端点和组网信息，用于建立L3VPN。同时，可以指定创建隧道的三层链路约束，约束隧道的生成。 
表格中的每行描述一个L3的AC口信息，路由约束列例外，路由约束列只使用在第一个AC口对应行，描述整个切片对应隧道的约束信息。 
根据不同情况，选择执行如下操作： 
如果...|那么...
---|---
配置了FTP服务器|将配置好的slice.xlsx文件放到FTP服务器上。
未配置FTP服务器|将配置好的slice.xlsx文件拷贝到nm-vnethypervisor微服务的/home/umebn/nm-vnethypervisor/conf/ftp_dir目录中。
调用实例化接口，触发实例化过程。 
根据现场情况，判断是否需要补充接入侧路由（目前实例化过程支持在核心网侧自动添加静态路由，所以核心网侧可以不用手动添加）。 
根据组网规划，在接入侧添加arp记录。 
### 开通核心网子切片 
#### 创建核心网子切片蓝图 


##### 摘要 
本节介绍如何开通核心网子切片蓝图。 


##### 相关信息 
通过创建核心网子切片蓝图，设计核心网子切片模板NSST。NSST模板是面向不同的业务场景需求及不同的资源部署形态而制定的具备一定可重用性的子切片实例模板。
当部署切片时，可以通过核心网NS的定义来设置切片参数数据。 
核心网NS主要定义5GC NF如何分配到不同的NS中。如共享同一个切片的5GC NF可以分配到一个NS中，独占一个切片的5GC
NF可以单独分配到一个NS中。NS的规划示例参见[表1](1605183921585.html#z301e720794b04f5e934eb405511f3d65__2ef4e16a-c900-4e8a-a7da-cd1683f37df9)。其中，控制面NF共享一个NS中。由于每个切片独占UPF，故UPF单独分配到一个NS中。
NS|VNF
---|---
NS-Share|AMF11、SMF12、PCF13、NRF14、NSSF15、USPP16
NS-VR|UPF17
NS-SHM|UPF27


##### 步骤 


在GSO客户端，选择菜单编排→设计→蓝图中心
，并切换到NSST页签，如[图1](1605183921585.html#z301e720794b04f5e934eb405511f3d65__aaf4f3b3-ee1d-403f-b336-091e1360c96f)所示。
图1  蓝图中心页面


[]images/1605183920915.png)



在NSST页签，单击创建按钮，打开创建NSST对话框，如[图2](1605183921585.html#z301e720794b04f5e934eb405511f3d65__d5eff2af-279c-42e6-9bfc-dcc79eba4ab3)所示。
图2  创建NSST对话框


[]images/1605183921045.png)



填写核心网子切片名称，单击确定按钮，进入蓝图中心设计页面，如[图3](1605183921585.html#z301e720794b04f5e934eb405511f3d65__47bfd6a2-dfac-426d-89af-800cb8bf0543)所示。
图3  蓝图中心设计页面


[]images/1605183921165.png)



在蓝图中心设计页面，选取已经创建好的NS实例或NS蓝图，如[图4](1605183921585.html#z301e720794b04f5e934eb405511f3d65__9d6c3901-6c22-4af6-a639-9c4cce29553b)所示。
图4  选取创建好的NS实例


[]images/1605183921285.png)



单击蓝图参数按钮，在弹出的蓝图参数页面，填写NSST固定标识，如[图5](1605183921585.html#z301e720794b04f5e934eb405511f3d65__a69f2edd-c6b4-4cae-8a57-4f9357343c82)所示。
图5  填写蓝图参数


[]images/%E5%A1%AB%E5%86%99%E8%93%9D%E5%9B%BE%E5%8F%82%E6%95%B0.png)



单击保存按钮，保存蓝图设计。


单击发布按钮，发布蓝图。在蓝图中心页面的NSST页签，可以看到发布的核心网子切片蓝图，如[图6](1605183921585.html#z301e720794b04f5e934eb405511f3d65__bf5b74f9-6eac-4591-aa4b-50bf2456b6bd)所示。
图6  核心网子切片创建完成


[]images/1605183921535.png)





#### 实例化核心网子切片 
##### 摘要 
本节介绍如何实例化核心网子切片。 
##### 步骤 
在GSO客户端，选择编排→应用→NSSI
，在NSSI页面，单击新建按钮，如[图1](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__0dac56f5-e754-40da-94f1-5cb106f98b3f)所示。
图1  NSSI页面
[]images/NSSI%E9%A1%B5%E9%9D%A2.png)
在新建NSSI页面的选择包页签，选择核心网子切片模板NSST，如[图2](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__5eff6eec-afb5-482b-bbc4-39cbd3ccd1b1)所示。
图2  选择核心网子切片模板NSST
[]images/%E9%80%89%E6%8B%A9NSST%E6%A8%A1%E6%9D%BF.png)
在部署参数页签，按照核心网子切片规划，填写部署参数，如[图3](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__14c99c86-b368-49c4-9e6c-cadb14c57964)和[图4](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__6c713d24-ea38-4754-ac65-8573ddbf5581)所示。其中，业务参数中S-NSSAI、PLMN、覆盖区域TAC参数需要根据规划填写，其他业务参数如果现场未规划则，则按照默认参数即可。
图3  填写部署参数
[]images/%E5%A1%AB%E5%86%99%E9%83%A8%E7%BD%B2%E5%8F%82%E6%95%B0.png)
图4  填写业务信息
[]images/%E5%A1%AB%E5%86%99%E4%B8%9A%E5%8A%A1%E4%BF%A1%E6%81%AF.png)
在选择项目区域，对归属NSST的NS进行参数规划。如果规划的NS已存在则引用已存在的NS实例，如[图5](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__1c007651-759b-4cd5-bb57-93b2321785c3)所示。如果不存在，则按照之前保存的NS参数规划进行NS实例新建。
图5  引用已存在的NS实例
[]images/%E5%BC%95%E7%94%A8%E5%B7%B2%E5%AD%98%E5%9C%A8%E7%9A%84NS%E5%AE%9E%E4%BE%8B.png)
单击下一步按钮，进入沙箱测试页签。单击提交按钮，开始实例化核心网子切片，如[图6](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__fde10c7d-b147-4d90-87cc-7d4cc6997d69)所示。
图6  实例化NSSI
[]images/%E5%AE%9E%E4%BE%8B%E5%8C%96NSSI.png)
在NSSI列表中查询到核心网子切片实例，如[图7](1605343790464.html#z2a7f2e7a73df41e189bd2af72f64a58f__2dfd4140-9f43-4c34-8c21-9bfccc18fc22)所示。
图7  查看NSSI实例
[]images/%E6%9F%A5%E7%9C%8BNSSI%E5%AE%9E%E4%BE%8B.png)
### NSMF统一拉通三网子切片 
目前，运营商均自建了端到端切片管理系统。当无线子切片、承载子切片、核心网子切片创建完成后，中兴通讯支持将三网子切片接入运营商NSMF。由运营商NSMF拉通三网子切片并统一管理。 
当运营商没有自建NSMF系统时，可以通过核心网Cloudstudio GSO作为NSMF，与中兴通讯三网子切片对接，统一拉通三网子切片，具体步骤参见[GSO统一开通端到端切片](1603448467219.html)。
## GSO统一开通端到端切片 
### 摘要 
在GSO客户端统一开通端到端切片，拉通无线子切片、承载子切片和核心网子切片，包括： 
创建核心网子切片蓝图在GSO客户端蓝图中心NSST页面，新建核心网子切片NSST模板。 
创建端到端切片蓝图在GSO客户端蓝图中心NST页面，新建端到端切片NST模板，通过与无线UME和承载UME的接口，获取无线子切片和承载子切片的模型。 
部署端到端切片在GSO客户端编排页面，通过导入json文件，获取无线子切片和承载子切片的配置文件，触发各子切片NSSMF系统加载配置文件，再由GSO统一拉通三网子切片。 
### 前提 
GSO上需要提供的端到端切片和各子切片的json文件，包括： 
端到端切片json文件提供切片的能力需求参数、S-NSSAI和PLMN等相关信息，在部署切片时导入。 
无线子切片json文件提供无线子切片的配置文件名称，如“SubSlice-sd1118481-RAN.zip”。在创建无线子切片时导入，从而能够通过接口通知无线NSSMF创建无线子切片。 
核心网子切片json文件提供核心网子切片NSSI和NS的对应关系。在创建核心网子切片时导入，从而能够建立核心网子切片与NS之间的关系。 
承载子切片json文件提供承载子切片的配置文件slice.xlsx在承载UME的路径。在创建承载子切片时导入，从而能够通过接口通知承载NSSMF创建承载子切片。 说明：slice.xlsx文件的具体参数参见实例化承载子切片。 
### 步骤 
在GSO客户端蓝图中心NSST页面，创建核心网子切片蓝图。 
在GSO客户端蓝图中心NST页面，创建端到端切片蓝图。 
在GSO客户端编排页面，部署端到端切片。
扫描如下二维码，获取《GSO端到端切片操作演示》完整视频。 
[]images/%E6%93%8D%E4%BD%9C%E6%BC%94%E7%A4%BA%E4%BA%8C%E7%BB%B4%E7%A0%81_new.png)
# 缩略语 
# 缩略语 
## CIDR 
Classless Inter-Domain Routing无类别域间路由
## CP 
Connection Point连接点
## DC 
Data Center数据中心
## FlexE 
Flex Ethernet灵活以太网
## FTP 
File Transfer Protocol文件传输协议
## GSO 
Global Service Orchestrator全局业务编排器
## L3VPN 
Layer 3 Virtual Private Network三层虚拟专用网
## NF 
Network Function网络功能
## NS 
Network Service网络服务
## NSMF 
Network Slice Management Function网络切片管理功能
## NSSI 
Network Slice Subnet Instance网络子切片实例
## NSSMF 
Network Slice Subnet Management Function网络子切片管理功能
## NSST 
Network Slice Subnet Template网络子切片模板
## PE 
Provider Edge运营商网络边缘
## PRB 
Physical Resource Block物理资源块
## QoS 
Quality of Service服务质量
## SLA 
Service Level Agreement服务等级协议
## UME 
Unified Management Expert统一管理专家
## UPF 
User Plane Function用户平面功能
## UUID 
Universal Unique Identifier全局唯一标识符
## VL 
Virtual Link虚拟链路
## VNF 
Virtualized Network Function虚拟化网络功能
# 流量经营解决方案 
## 背景与挑战 
在移动互联网时代，越来越多的互联网公司越过运营商，发展基于开放互联网的各种视频及数据服务业务（又称OTT）。这些OTT应用促进用户行为改变，把人的时间碎片化和重叠化，一方面吸引用户使用移动数据业务增加运营商管道的流量，另一方面也从海量用户的大数据分析中挖掘新的价值。
运营商和OTT跨界竞争，实质是产业价值正向应用和服务转移。为了避免管道化，运营商需要强化数据业务精细化运营能力，优化网络资源使用、提升网络的智能化水平、提升用户体验，从而拥抱OTT的强力挑战，把产业价值更好地向应用和服务转移。
在以上运营商业务转型的背景下，流量经营应运而生，本文重点阐述5G核心网流量经营解决方案的场景和原理。 
## 方案描述 
### 定义 
#### 定义 
流量经营是以智能管道（物理网络）和聚合平台（商业网络）为基础；以扩大流量规模、提升流量层次、丰富流量内涵为经营方向；以释放流量价值为目的的一系列理念、策略和行动的集合。流量经营的最终目的是顺应移动互联网的发展，转变运营商的收入结构，达到利润最大化。中兴通讯提供的流量经营解决方案，包括了流量经营的若干场景，利用3GPP协议的PCC架构实现流量经营。
不同于话务经营和宽带经营，流量经营是在全业务和移动互联网新形势下，通信运营商向信息运营商转型的全新命题，是顺应移动互联网发展规律、把握移动互联网发展机遇，改变互联网时代“管道工”角色的关键。 
流量经营的提出与通信需求向信息需求的转型有莫大的关系。这种转型根本性地重塑电信运营商的价值创造方式，必然也要求电信运营商的基础设施和商业模式随之做出转变，而智能管道和聚合平台是实现这一转变的抓手和基石。为了避免“被管道化”，目前三大运营商正积极构建移动互联网的生态体系，在服务内容上不断丰富。 
流量经营对运营商的意义在于：帮助运营商从个性化需求中寻求价值；从流量规模的经营转变为流量价值的经营；从而丰富流量内涵，突破底层流量，提升流量层次。 
流量经营也与大家的生活息息相关。例如每个月大家使用的各式各样的流量套餐，套餐的本质一种流量经营——对流量、上网速率等使用情况进行管控。例如：在签约的包月流量套餐耗尽前，能享受高速带宽，看视频、下载均畅通无阻，但套餐快要耗尽时，用户会收到短信，提示合理使用流量，套餐耗尽后也会短信提示对用户上网将进行限速等。 
#### 系统架构 
5G网络中的PCC整体系统架构如[图1](1632395447564.html#z718f43945a644d4ba70ff7b152063a5f__57a0fdfe-4266-41ca-aadd-748493860f1c)所示。
图1  组网图
[]images/1630342114762.png)
涉及NF的功能说明，参见下表。 
涉及NF|功能说明
---|---
AMF|从PCF接收UE选网和路由策略、接入和移动性策略，分别传递给UE和(R)AN。向PCF上报PCF订阅的事件。运营商未部署PCF时，根据本地配置策略进行接入和移动性策略控制。
SMF|从PCF接收并执行会话管理策略。向PCF上报PCF订阅的事件。运营商未部署PCF时，根据本地配置策略进行会话策略控制。
UPF|执行数据包检测，执行实现原理部分的业务感知。执行门控、重定向等用户面策略执行。
PCF|进行UE策略、接入和移动性策略和会话管理策略决策与控制。
CHF|基于SBI接口的计费网元，可以实现Nchf接口在线计费和离线计费。
### 功能 
流量经营需要使用到的典型功能参见[表1](1632395463735.html#z477df42fc7ca4bcdbf72eba78fbf7749__bab992cd-9e47-44fa-af41-70633d999e24)。在流量经营商业部署实践中，以下功能可以为运营商增加营收、增强用户网络体验、提升网络效率。
功能|功能简介|参考
---|---|---
5G PCC策略|除4G时使用的会话管理策略，5G的PCC策略新引入了AM策略和UE策略，侧重从用户层面对用户级带宽、接入区域、选网策略等进行控制。|5G PCC策略
基于业务感知的策略控制|基于业务感知的策略控制，是指在用户会话过程中，对用户的数据报文进行解析，从而区分出用户使用的不同业务，并根据业务策略对业务数据进行转发/控制的过程。|基于业务感知的策略控制
E2E的QoS管理|QoS管理是网络满足业务质量要求的控制机制，它是一个E2E（End-to-End，终端到终端）的过程，要求业务从发起者到响应者之间所经历的网络各节点共同协作，以保障服务质量。|端到端QoS管理
多维度PCC策略控制|多维度的PCC策略控制，是指在用户会话过程中，可以基于用户、业务、用户接入网络制式、用户所在位置等综合决策用户的策略。|多维度PCC策略控制
基于实时位置的策略控制|基于实时位置的策略控制，是指PCF下发位置改变事件，SMF到AMF订阅位置事件改变上报。当用户的位置发生变化时，AMF通知SMF用户位置发生改变，SMF向PCF发送策略更新请求消息携带最新的位置信息，PCF根据变化的位置信息进行策略更新。|-
基于指定区域的策略控制（PRA）|基于指定区域的策略控制，是指当用户进入运营商订阅的PRA（Presence Reporting Area，出现上报区域）后，执行不同的服务策略（如特殊计费、套餐、信息推送等），用户通过签约享受相应服务，满足运营商基于位置信息的差异化和定制化需求。当用户进入/离开PRA时，核心网会判定用户当前的位置或者状态并上报给上游网元，进行不同的策略控制。|-
基于Tethering的策略控制|基于Tethering的策略控制，是指识别开启了Tethering功能的用户，并检测出Tethering用户自身和其他智能终端设备的流量，根据检测的结果对Tethering用户和共享上网设备执行指定的管控策略。|-
基于业务感知的QoS控制|基于业务感知的QoS控制，可以根据PCRF或者PCF下发的PCC预定义规则或本地配置的静态规则为用户建立专有承载或专有QoS Flow，从而对特定业务进行E2E的QoS保障。|-
基于业务累计流量的策略控制|基于业务累计流量的策略控制，是指UPF/GW-U根据PCRF/PCF指定的用量监控条件，对用户使用业务的流量和时长等进行监控统计。当达到用量上报触发条件时，PGW-C/SMF向PCRF/PCF上报用户的用量，PCRF/PCF可以基于用户的累计流量进行策略控制。|-
计费功能|计费功能是运营商为了衡量用户对网络资源的占用情况，根据一定的资费政策建立的费用计算系统。|-
策略控制能力开放|策略控制能力开放，是指当用户使用AF提供的游戏加速等业务时，为了保障用户的业务体验，AF会通过Rx或者N5接口向PCRF/PRF授权接入，请求为用户使用的业务提供资源保障。PCRF/PRF接收到AF的请求后，会根据请求带宽或业务路由进行策略计算，并向PGW-C/SMF下发特定的规则，从而为终端用户提供端到端的QoS保障。|-
#### 5G PCC策略 
##### PCC策略分类 
4G时，PCC策略一般是指会话管理策略，5G新引入了AM策略（接入和移动性策略）和UE策略，侧重从用户层面对用户级带宽、接入区域、选网策略等进行控制。
策略类型|关键信息|描述
---|---|---
PDU会话策略控制|业务级：QoS，计费策略、转发策略等会话级：Session-AMBR、用户的计费方式、事件触发器|侧重从用户会话和业务层面进行QoS管控。主要包括带宽控制、计费控制、头增强、重定向等。用于为用户提供差异化的服务质量，如：灵活的带宽控制、网络资源使用优先级、计费方式等。
接入和移动性策略控制|SAR（Service Area Restrictions，业务区域限制）|业务区域限制（Service Area Restrictions）包含允许区域（Allowed Area）和非允许区域（Non-Allowed Area）。UE在允许区域内可以正常进行语音和数据业务。UE在非允许区域内可以注册，但不能进行其他业务。
RFSP（RAT Frequency Selection Priority，无线频率选择优先级）|接入和移动性策略控制|无线频率选择优先级是无线接入网进行无线资源管理时所采用的策略。不同的无线频率选择优先级可以使用不同的RFSP Index取值来表示。基站可以根据RFSP Index实施无线资源管理策略，例如指示UE使用特定的无线接入方式和频率进行数据传输。
UE策略|ANDSP（Access Network Discovery & Selection Policy，接入网发现和选择策略）|辅助用户选择Non-3GPP方式接入网络。
URSP（UE Route Selection Policy，UE路由选择策略）|UE策略|包括切片选择策略、SSC模式选择策略、DNN选择策略、PDU Session类型选择策略、非无缝卸载指示，以及接入类型偏好。用于辅助UE为上行流量选择合适的路由，如在已有PDU Session上传输，卸载到Non-3GPP接入网络传输，或触发新建一个PDU Session传输。
##### PDU会话策略控制 
PDU会话策略控制是指PCF向SMF提供用于PDU会话管理的控制策略，简称SM策略。 
PDU会话策略控制包括： 
PDU会话QoS控制：RCP向SMF提供授权的会话聚合带宽和缺省QoS（通过SessionRule的authSessAmbr和authDefQoS参数提供）。 
PDU会话计费控制：RCP指示SMF对PDU会话实施在线计费或离线计费，并提供计费系统地址（通过smPolicyDecision下的online、offline和chargingInfo参数提供）。 
PDU会话业务控制：RCP向SMF提供业务PCC规则，指定SMF对业务实施QoS控制、计费控制、业务流向控制（通过pccRule及其关联的qosDesc、chgDesc、traffContDecs参数提供）。 
PDU会话策略控制应用场景包括： 
运营商期望提供多种类型的套餐满足不同用户需求。不同类型的套餐可以提供不同的带宽，包含不同的用量门限，超过用量门限要对用户限速或禁止上网。有的套餐是通用套餐，适用于任何流量；有的套餐是定向套餐，只能访问特定的业务。有的套餐适用于任何区域，有的套餐只能在非漫游或漫游场景下使用。运营商可以在PCF上按每个套餐的具体策略要求来配置策略规则，在UDR中存放每个用户的策略签约信息（其中包含套餐签约信息）。 
运营商期望当用户使用特定业务时，能对该业务提供QoS保障。例如，当用户使用VoNR时，能够获得较好的通话质量。为此，IMS中的P-CSCF充当AF，在用户发起VoNR通话时，将VoNR媒体流信息和QoS要求发送给PCF，触发PCF构造PCC规则并下发给SMF。SMF收到PCC规则后，通知UPF为VoNR媒体流建立专门的QoS Flow，为VoNR媒体流传输提供保障带宽和较高的转发优先级。 
运营商期望对用户实施动态的计费控制。例如，对后付费用户，在非漫游时实施离线计费，在漫游时实施在线计费。 
##### 接入和移动性策略控制 
接入和移动性策略控制指的是PCF向AMF提供用于接入和移动性管理的控制策略，简称AM（Access & Mobility）策略，包含PCF授权（批准或修改）的业务区域限制和RFSP Index。 
获取、更新和终止AM策略具体过程如下： 
获取AM策略在UE注册或切换到AMF时，AMF需要向PCF请求建立AM策略关联。请求消息中包含AMF从UDM获取的UE签约的业务区域限制和RFSP Index。PCF根据运营商策略（例如基于策略签约信息，或基于累计用量）批准或修改AMF提供的业务区域限制和RFSP Index，并在响应消息中下发给AMF。 
更新AM策略此后，PCF可以因为内部事件（如时段切换）或外部事件（如UDR通知该用户的策略签约变更）触发而主动向AMF更新AM策略；或者，PCF可以在AMF上报接入和移动性相关事件时，在响应消息中更新AM策略。 
终止AM策略在UE去注册或切换到其他AMF时，AMF请求PCF终止该UE的AM策略关联；PCF也可能因为某些事件（如UDR通知该用户的策略签约删除）而主动要求AMF终止该UE的AM策略关联。 
接入和移动性策略控制主要适用于以下几种场景： 
运营商需要对业务区域限制实施动态策略控制。例如对享有大额度优惠流量的家庭CPE，可以进行以下限制：限制CPE只能在家庭周边基站接入，防止用户在非允许区域使用此类CPE上网，从而避免网络拥塞。当某个CPE每月的优惠流量耗尽时，缩小其允许区域，扩大其非允许区域，以限制该CPE继续使用业务。当用户购买新的优惠流量或下个账期开始时，自动恢复至原来的业务区域限制。 
运营商需要对RFSP Index实施动态策略控制。例如PCF根据RAN拥塞信息动态调整RFSP Index并传递给RAN，RAN指示UE选择该RFSP Index对应的无线接入方式和频率进行数据传输。 
 说明： 
EPC中，MME可以从HSS获取UE签约的业务区域限制和RFSP Index，下发给RAN和UE执行。但在EPC中，PCRF和MME之间没有接口，MME无法向PCRF上报UE签约的业务区域限制和RFSP Index，PCRF也无法修改业务区域限制和RFSP Index。 
5GC中，AMF从UDM获取UE签约的业务区域限制和RFSP Index后，可以通过N15接口发送给PCF。PCF可以批准或修改AMF提供的业务区域限制和RFSP Index。这使得运营商可以对业务区域限制和RFSP Index实施动态的策略控制。 
##### UE策略 
URSP（UE Route Selection Policy，UE路由选择策略）可预配置在UE或通过PCF下发给UE，预配置策略只在PCF未下发相同类型的策略时生效。 
URSP策略控制为UE策略控制的一个重要组成部分，用于UE决定如何为出局的业务流选择路由，主要包含如下几个方面： 
SSC模式选择策略：用于UE关联匹配SSC模式的应用。 
网络切片选择策略：用于UE关联匹配S-NSSAI的应用。 
DNN选择策略：用于UE关联匹配DNN的应用。 
PDU会话类型策略：用于UE关联匹配PDU会话类型的应用。 
非无缝卸载策略：UE使用该策略来确定匹配的应用程序非无缝卸载到PDU会话之外的Non-3GPP接入网络。 
接入类型优先策略：用于UE需要为匹配的应用建立PDU会话，指示优选的接入类型是3GPP或Non-3GPP。 
 说明： 
在2G/3G/4G时，UE上业务流使用的路由策略，是通过诸如OTA配置、UE上直接写入、UE上设置业务参数等方式控制的。如果要新增一种业务应用，就需要修改UE侧的路由策略，非常不灵活。 
5G网络引入切片、SSC模式，统一3GPP和Non-3GPP后，UE上对业务流的路由选择策略更加复杂。通过在USIM卡预先写入（已放号的USIM卡无法写入）或其他非标准方式实现UE路由选择策略的修改，需专业人员实施，并且，与4G网络相比，策略修改的频度也会增加。因此，为用户提供一种更灵活的更改路由策略的手段，将更加便于业务创新和网络维护。 
#### 基于业务感知的策略控制 
##### 基本概念 
业务感知，是指在用户会话过程中，对用户的数据报文进行解析，从而区分出用户使用的不同业务，并根据业务策略对业务数据进行转发/控制的过程。 
举例而言，如果用户在同时进行浏览网页、下载视频、游戏等多个业务，通过业务感知，核心网可以识别出来用户的这些业务，并根据每种业务的特点，对用户的数据进行分类处理：给下载视频业务分配较多带宽、给游戏业务配置较低的时延与丢包、预留少量带宽给用户浏览网页、当用户访问的网站的IP地址不安全时，禁止用户访问等等。 
随着宽带网络的不断普及和移动智能终端硬件性能的提升，各类互联网应用逐渐延续到移动端，移动数据业务迎来了爆发式的发展，尤其是在5G时代，人们对移动网络提出了更丰富的诉求，运营商可以根据实际需求为每个应用业务定制不同的控制策略，可以将网络资源分配到带宽需求较高的业务应用上，最终在成本不变的情况下保证用户体验。 
在网络运营中对带宽资源高效控制和利用、制定灵活的计费策略，有力地保障了运营商的收益。为了满足运营商基于内容计费、带宽控制、安全防护、行为分析、统计报表等方面的精细化运营需求，需要UPF/GW-U的DPI功能对用户业务报文进行解析，获得报文携带的目的地址、目的端口、传输协议、应用协议特征及设备类型等报文特征信息，根据上述报文特征信息匹配到关联的控制策略（如：重定向、头增强等），并对用户报文执行匹配的控制策略。 
##### 原理描述 
业务感知主要在ZXUN xGW的UPF/GW-U执行，UPF/GW-U对报文的解析与规则匹配技术，可划分为以下三种： 
SPI技术，对报文的三四层进行解析与规则匹配，体现在对报文的“五元组（源地址、源端口、目的地址、目的端口以及协议类型）”信息进行解析与规则匹配，并对报文进行策略控制。 
DPI技术，对报文的七层进行解析与匹配，体现在对报文应用层特征关键字（例如：HTTP协议的URL、操作码等）信息进行解析与规则匹配，并对报文进行策略控制。 
HPI技术，适用于比较复杂的协议或加密的协议，体现在对报文的特定特征及行为进行分析与规则匹配，并对报文进行策略控制，需要定时更新协议特征库。 
这三类识别技术分别适用于不同类型的协议，ZXUN xGW的UPF/GW-U综合运用这三大技术，实现灵活控制和精确计费。
针对用户数据报文的识别与控制归纳典型的应用场景， ZXUN xGW的UPF/GW-U支持的DPI特性参见下表：
相关特性|实现简述
---|---
基本业务识别|UPF/GW-U可以基于L3/4或者L7特征来识别终端使用的协议和当前进行的业务，并将识别出的结果与PCC计费和策略控制动作相结合。通过这两个功能的配合，运营商可以实现精细化管理网络的目的。L3识别是基于IP地址的识别L4识别是基于端口和协议类型的识别L7识别是基于URI等特征的识别相关特导：ZXUN xGW的 ZUF-83-06-001 基本业务识别
增强业务识别|UPF/GW-U可以通过特征库识别用户流量，采用包括HPI启发式识别在内的多种方法，可以对互联网进行深度识别和归类，使用HPI技术。识别范围包括各类协议，比如浏览类（如HTTP）、流媒体类（如RTSP）、传输类（如FTP）、会话控制（SIP）、即时通讯（TCP/UDP）等协议，以及各种应用，比如Skype、Facebook、QQ、Wechat等。相关特导：ZXUN xGW的ZUF-83-06-002 增强业务识别
域名业务识别|UPF/GW-U基于DNS查询与会话识别出主机域名与IP地址的对应关系，从而根据IP地址检测出对应域名的数据业务，使用SPI和DPI技术。典型的业务包括：基于域名系统来辅助检测加密业务、利用域名系统检测服务器地址动态变化的业务。相关特导：ZXUN xGW的ZUF-83-06-003 基于域名业务的识别
IPv6报文识别功能|除了识别原有的IPv4地址类型的业务数据流量，还支持识别IP地址类型为IPv6的业务数据流量。相关特导：ZXUN xGW的ZUF-83-06-004 IPv6报文识别功能
UPF对用户数据报文的处理按照三四层解析、七层解析和协议识别的顺序进行Filter匹配，之后根据匹配Filter结果获取对应的Action，从而对业务报文进行控制。
PCC&DPI业务匹配逻辑如[图1](1632471028731.html#zcf808024684e4bb588d87ed7703041ec__7f33e8e4-9593-44e1-81ca-02fb22774ad1)所示。
图1  业务感知匹配原理
[]images/1640680431626.png)
#### 端到端QoS管理 
##### QoS基本概念 
QoS是指针对各种业务的不同需求，为其提供端到端的服务质量保证，使用户获得预期水平的服务。 
在3GPP移动网络演进过程中，为了根据不同业务特点为用户提供满意的服务，移动网络的QoS机制也在不断发展，经历了R97/98 QoS、R99 QoS、EPC QoS、5GS QoS等几个阶段，分别应用于GPRS、UMTS、EPS、5GS等网络制式。 
5GC的QoS参数描述如[表1](1632995969667.html#z9ba67634433e406c81011f4e813fcf4f__7272e4c6-6aa2-436b-a54e-f9b91f71330f)所示。
参数|参数描述
---|---
5QI|5G QoS索引，一个5QI就代表一套QoS参数。5QI相对QCI进行了大量扩展，并且5G支持个性化的Priority Level、Averaging Window和Maximum Data Burst Volume参数携带。|5QI
ARP|分配保留优先级。ARP信元包含priority level、pre-emption capability和pre-emption vulnerability。在资源受限情况下，决定是否接受新的QoS flow，以及决定QoS flow是否优先占用资源。priority level分为1到15个等级，1为最高优先级。pre-emption capability决定一个数据流是否可以抢占低优先级的资源。pre-emption vulnerability决定一个数据流是否可以被高优先级的数据流抢占资源。|ARP
Flow Bits Rate|GFBR（Guaranteed Flow Bit Rate，保证流比特率）：能够提供的流保证比特率。MFBR（Maximum Flow Bit Rate，最大流比特率）：能够提供的流最大比特率。|Flow Bits Rate
RQA|Reflective QoS Attribute，反射QoS属性，可选参数。当QoS flow中指示了Reflective QoS属性，则(R)AN将RQI与QoS flow进行关联，用于指明该QoS flow是受制于Reflective QoS。RQA在(R)AN建立UE上下文或在QoS flow增加和删除的时候，SMF通过N2接口通知给(R)AN。|RQA
Notification Control|指示当GFBR在QoS Flow的生存期内不再满足流QoS时，(R)AN会通知SMF，SMF转发给PCF。用于5G核心网对该QoS Flow进行对应的调整。|Notification Control
Averaging Window|GBR数据统计评估时间窗。|Averaging Window
Maximum Packet Loss Rate|允许的QoS Flow最大报文丢失率。|Maximum Packet Loss Rate
PDB|Packet Delay Budget，数据包时延预算。定义了空口的时延。|PDB
Session-AMBR|Session Aggregate Maximum Bit Rate，会话的聚合最大比特率。一个会话的所有Non-GBR QoS Flows共享的最大比特速率。GBR QoS Flows的流量不在Session-AMBR范围内。SMF从UDM获取签约的Session-AMBR发送给UPF和UE，由UPF和UE执行QoS控制。|Session-AMBR
UE-AMBR||UE Aggregate Maximum Bit Rate，UE的聚合最大比特率。一个UE的所有Non-GBR QoS Flows共享的最大比特速率。GBR QoS Flows的流量不在UE-AMBR范围内。AMF从UDM获取签约的UE-AMBR，发送给(R)AN。由(R)AN执行QoS控制。
QoS Flow||QoS Flow是5G QoS控制的最小粒度。一个PDU会话可能包含有多个QoS Flow，每一个QoS Flow由QFI（QoS Flow ID）唯一识别。
##### QoS管理机制 
会话管理功能是SMF的基本功能，是用户与外部DN建立连接，进行数据业务的基础。SMF的会话管理功能包括网络侧发起的会话管理和UE发起的会话管理。
SM策略中的QoS主要从用户会话级和业务级两个层面进行QoS管理。 
会话级QoS管理：会话级QoS策略是表示以PDU Session为度量单位，1个PDU Session中包含的QoS策略内容。 
业务级QoS管理：业务级QoS表示以用户访问的业务为度量单位，1个业务包含的QoS策略内容。 
会话下可以包含多个业务，因此会话级QoS策略与业务级QoS策略的关系是：会话级QoS策略可能包含了多个业务级QoS策略内容。 
会话级QoS策略和业务级QoS策略如[图1](1632995969667.html#z9ba67634433e406c81011f4e813fcf4f__e7f7c3c2-1d90-4835-bb2f-7bb1d3dd644a)所示：
图1  QoS管理层次图
[]images/1634711021103.png)
QoS管理的实现机制可以从信令面和数据面两个维度来说明，信令面的作用就是将QoS Flow（类似于4G的Bearer，数据通路）建立起来，侧重于QoS策略是如何生成和下发的，而用户面的作用则是基于已经建好的QoS Flow进行业务，即如何来保障用户的上网质量，侧重于QoS策略是如何实施的。QoS策略管理流程如[图2](1632995969667.html#z9ba67634433e406c81011f4e813fcf4f__d47ad593-5bd9-4f02-a5a0-454e09717bf8)所示：
图2  QoS策略管理流程图
[]images/1634715214243.png)
网元功能简介： 
网元|功能
---|---
PCF|PCF拥有QoS参数的最高决策权，如果PCF没有下发相应的QoS参数，则由SMF根据本地配置，决定是否授权用户使用请求的QoS。
SMF|SMF主要处理来自PCF下发的SMPolicy。SMF根据QoS参数和业务信息，确定QoS Flow信息（QFI，PFS（Packet Filter Set），QoS参数等），进而控制QoS Flow的建立、修改和删除，即将QoS Flow的相关信息分别知会UPF/RAN/UE，指示其如何处理数据包。
AMF|AMF主要对信令建立提供通道，信息透传。
UPF|UPF作为QoS策略执行网元，处理来自SMF的PFS（Packet Filter Set）和QoS信息，根据QoS策略把数据包映射到QoS Flow上，进行下行QFI的标记和控制，并对上行QFI进行验证。
RAN|RAN处理信令面传来的QoS策略，将信令面的QoS参数做用户面的映射，实现用户业务的服务质量的控制。
UE|UE处理信令面传来的QoS策略，根据QoS策略把数据包映射到QoS Flow上。
QoS映射和标记原理如[图3](1632995969667.html#z9ba67634433e406c81011f4e813fcf4f__ecf44b8d-5b2f-43dc-bd1b-e1be3b249b34)所示。
图3  QoS映射和标记原理图
[]images/1634719516594.png)
数据报文的QoS映射原理如下： 
下行数据映射原理：UPF根据PDRs对下行数据进行分类，并将数据包映射到QoS Flow上。UPF对QoS Flow进行标记，在N3接口用QFI标记该数据分组。UPF在执行完这些操作后将该数据包发送给(R)AN。(R)AN收到数据包后，执行QoS Flow到Radio Bearer的映射过程，并将数据包发送给UE。 
上行数据映射原理：UE根据QoS规则将上行数据进行分类，并将数据包映射到QoS Flow上，用QFI标记该数据分组。UE执行QoS Flow到Radio Bearer的映射过程。UE在执行完这些操作后将数据发送到(R)AN。(R)AN收到数据包后，将数据包发送到UPF。 
在上述过程中，有两级映射： 
数据包到QoS Flow的映射：数据包的发送端UE/UPF，对数据包中的业务进行流过滤器的识别分类后，将业务的数据包映射到QoS Flow上，用QFI标记该数据包。 
QoS Flow和Radio Bearer的映射：无限空口资源是有限的，为高效利用空口资源，(R)AN决策调度QoS Flow和Radio Bearer之间进行映射。 
#### 多维度PCC策略控制 
PCC系统可以提供多维度的策略控制，如[图1](1634711935317.html#zb6090e9cbf304e11a16a5d403da3d9d5__9d0443f5-1be8-4e36-b1a8-537886b7b9ab)所示。
图1  多维度策略控制
[]images/1640681097766.png)
如上图所示，PCC系统能够基于如下多种条件定义策略规则： 
业务类型 
无线接入类型 
时段 
位置信息 
累计用量 
签约信息 
PCC系统可以基于以上的条件作出如下多种策略决策和控制措施： 
QoS策略 
门控策略 
通知策略 
计费策略 
举例： 
PCC系统可以根据用户的时段实施差异化策略控制。通常，网络忙时负荷重，闲时负荷轻。运营商希望通过时段策略来调节忙闲时网络负荷，例如：忙时对P2P等低价值业务限速，防止网络拥塞；推出闲时优惠套餐，引导用户增加闲时上网，减少忙时上网。此外，运营商也可能推出Happy Hour流量免费等基于时段的促销活动，或和OTT厂商合作在指定时段对OTT业务流量免费。 
用户位置实施差异化策略控制。例如：当用户在特定位置时，向其发送欢迎或促销短信。限制用户在体育场馆等人口密集区使用P2P业务或视频业务的带宽，以保障大多数人的上网体验。 
### 场景说明 
5GC支持如下流量经营的典型应用场景。 
场景名称|描述|参考
---|---|---
拥塞控制|运营商根据不同场景下业务的优先级进行差异化服务的策略。|具体场景说明参见：流量经营场景之拥塞控制
校园通|运营商将校园区域规划为一个小区，当用户处于校园区域，生成差异化计费话单，用户可以享受更便宜的资费。|具体场景说明参见：流量经营场景之校园通
金银铜用户|运营商可以对客户进行金银铜的等级分类，区分用户等级提供不同的数据传输渠道，以便高等级用户享受更好的数据业务体验。|具体场景说明参见：流量经营场景之金银铜用户
Tethering控制|运营商基于用户终端的区别实行差异化流量经营。|具体场景说明参见：流量经营场景之Tethering控制
家长控制|运营商辅助家长引导不同年龄阶段的未成年人在规定时间有限度的访问适龄业务。|具体场景说明参见：流量经营场景之家长控制
能力开放|运营商将QoS控制能力一定程度上开放给OTT厂商，触发专载QoS Flow。|具体场景说明参见：流量经营场景之能力开放
高价值业务QoS提升|运营商为高价值业务主动触发专载QoS Flow。|具体场景说明参见：流量经营场景之高价值业务QoS提升
达量降速|运营商通过PCF进行流量累计，在累计流量达到一定限额时，限制用户访问速率或提高资费。|具体场景说明参见：流量经营场景之达量限速
超套限速|运营商通过第三方系统上报的流量累计，在累计流量达到一定限额时，限制用户访问速率。|具体场景说明参见：流量经营场景之超套限速
## 流量经营场景之拥塞控制 
### 应用场景 
#### 背景介绍 
网络拥塞是一种网络过度负载状态。在这种状态下，少量用户使用带宽抢占能力强的业务（例如P2P业务）时占用大量传输资源，使大量其他用户在使用交互类业务（例如网页浏览、邮件收发）时发生数据丢失、时延增加、吞吐量下降的现象，影响用户体验。 
网络拥塞十分普遍，通常发生在人口密集区域，例如景区、高校、道路、高铁、地铁、商业中心、办公区、居民区、大型活动等场所。 
为了满足运营商根据用户所在位置区域进行差异化业务控制需求，中兴通讯提出了支持基于用户位置的拥塞控制解决方案。 
#### 场景说明 
拥塞控制策略是一种根据不同位置场景下业务的优先级进行差异化服务的策略。有利于运营商提高网络资源效益，提高用户体验。 
拥塞控制策略的核心在于“控保结合”，即： 
控制用户不敏感、大颗粒度、流量占比大的业务，对受控制业务的上行/下行速率进行控制。 
保障高敏感、用户易投诉、流量占比小的业务。 
举例，在4G接入的不同场景下，基于业务类型的拥塞控制策略参见[表1](1629182316075.html#ze3296216bc6445a0a39f974da9cb8b38__07ad06fe-a514-434f-9499-e40d72ac1ef8)（可以根据流量经营场景灵活调整）。
场景|业务类型|策略
---|---|---
景区|微信（非语音视频通话）|QCI=6保障
下载、P2P、iTunes/iCloud同步|景区|核心网限速
视频|景区|QCI=7劣化
道路|导航|QCI=6保障
下载、P2P、iTunes/iCloud同步|道路|核心网限速
视频|道路|QCI=7劣化
地铁|新闻浏览（今日头条、新浪、凤凰）|QCI=6保障
下载、P2P、iTunes/iCloud同步|地铁|核心网限速
视频|地铁|QCI=7劣化
高校|游戏|QCI=6保障
视频|高校|QCI=7劣化
商业中心|大众点评|QCI=6保障
视频、下载、P2P、iTunes/iCloud同步|商业中心|QCI=7劣化
高铁|12306|QCI=6保障
下载、P2P、iTunes/iCloud同步|高铁|核心网限速
视频|高铁|QCI=7劣化
居民区|美团|QCI=6保障
视频|居民区|QCI=7劣化
办公场所|淘宝、京东|QCI=6保障
视频、下载、P2P、iTunes/iCloud同步|办公场所|QCI=7劣化
大型活动|微信（非语音视频通话）|QCI=6保障
视频、下载、P2P、iTunes/iCloud同步|大型活动|QCI=7劣化
 说明： 
QCI是资源类型、优先级、时延、丢包率等一组参数（称为QCI特征）的取值集合的索引，用于控制承载级别的包转发处理。不同QCI的业务需要使用不同的承载。QCI特征参数如下：
资源类型：用于区分相应的承载是否具有保证的最小带宽，分为GBR（保证比特速率）和Non-GBR（非保证比特速率）两种。GBR指承载要求的比特速率被网络“永久”恒定的分配，即使在网络资源紧张的情况下，相应的比特速率也能够保持。相反的，Non-GBR指承载不具备“恒定”的比特速率，在网络拥塞的情况下，业务（或者承载）需要承受降低速率的要求。 
优先级：承载上数据包的调度和速率控制等转发处理的优先级。 
分组数据延时：即时延，指一个报文或分组从一个网络的一端传送到另一端所需要的时间。 
分组数据丢包率：即丢包率，指在网络传输过程中丢失报文的百分比，用来衡量网络正确转发用户数据的能力。 
### 实现原理 
#### 概述 
拥塞控制策略是一种根据不同位置场景下业务的优先级进行差异化服务的策略，可以基于指定位置和业务进行差异化的策略控制。 
部署基于指定用户位置的拥塞控制解决方案，是指为拥塞控制的区域定义PRA（Presence Reporting Area，出现上报区域）区域，用户进入这些区域，区分业务流进行限速。 
PRA可分为动态PRA和预定义PRA两种类型。 
动态PRA类型PRA区域列表来自用户签约信息或由第三方应用提供给PCF，PCF给SMF下发PRA订阅信息时，需要同时携带PRA ID和完整的PRA区域列表。 
预定义PRA类型PCF给SMF下发PRA订阅信息时，不携带PRA区域列表，仅需携带PRA ID，与此PRA ID相关联的PRA区域列表在网络规划时由核心网进行预定义，并配置到AMF。 
SMF通过Namf_EventExposure_Subscribe Request向AMF订阅PRA事件，当UE进入或者离开PRA区域，AMF通过Namf_EventExposure_Notify消息通知SMF，SMF通过Npcf_SMPolicyControl_Update Request消息通知PCF用户进入或者离开PRA区域，由PCF下发管控策略。 
管控策略需要在UPF上提前配置拥塞区域的预定义规则或者预定义规则组，不同拥塞区域可能对应不同的预定义规则或者预定义规则组，不同的预定义规则或者预定义规则组配置不同的业务标识和业务策略。用户一旦进入某拥塞区域，PCF可以给SMF下发该拥塞区域对应的预定义规则或者预定义规则组，SMF将预定义规则或者预定义规则组通过N4接口传递给UPF，并由UPF激活对应的预定义规则或者预定义规则组，从而可以区分业务进行限速，即业务流限速。 
业务流限速原理如[图1](1629182317006.html#z712dc59954dc40b8b5bc91a1f6ca9463__f177d8ca-6352-4999-8326-b4de71601d9c)所示。不同于传统的管道式限速，业务流限速可以满足拥塞控制“控保结合”的核心诉求，保障高敏感、用户易投诉、流量占比小的业务；控制用户不敏感、大颗粒度、流量占比大的业务，从而提高网络资源效益，提升用户体验。
图1  管道式限速和业务流限速
[]images/%E9%99%90%E9%80%9F%E6%96%B9%E5%BC%8F.png)
#### 关键流程 
基于PRA功能实现拥塞控制的流程图如[图2](1629182317006.html#z712dc59954dc40b8b5bc91a1f6ca9463__a9eb6cf2-354a-42a6-bc97-37d5a654581f)所示。
图2  基于PRA功能实现拥塞控制的流程图
[]images/1640745921511.png)
流程关键描述参见[表1](1629182317006.html#z712dc59954dc40b8b5bc91a1f6ca9463__1903934a-6cb3-4b9e-93bf-20aa561fa896)。
步骤|描述
---|---
18|Namf_eventExposure_subscribe Request：SMF向AMF发起事件订阅，Namf_eventExposure_subscribe Request携带参数AMFEventSubscription中携带(AMFEvent, AMFEventMode)，其中AMFEvent中的AMFEventType为PRESENCE_IN_AOI_REPORT，AMFEventArea中为PraInfos，AMFEventMode中AMFEventTrigger设置为Continuous，AmfEvent中的immediateFlag设置为true。
19|Namf_eventExposure_subscribe Response：AMF向SMF发送Namf_EventExposure_subscribe Response中参数AMFEventState携带out状态。
20|Npcf_SMPolicyControl_Updata Request：SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，携带PRA_CH及PraInfos，其中包含praID和presenceState。
21|Npcf_SMPolicyControl_Updata Response：PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，PCF基于PRA位置进行策略决策，下发非拥塞区域的预定义规则组。
22|SMF向UPF发送PFCP Session Modification Request消息，携带非拥塞区域的预定义规则组，UPF上预配置非拥塞区域的预定义规则组，比如保障所有业务。
24|AMF向SMF发送Namf_eventExposure_subscribe Response中参数AMFEventState携带in状态。
25|SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，携带PRA_CH及PraInfos，其中包含praID和presenceState。
26|PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，PCF基于PRA位置进行策略决策，判断用户进入拥塞区域，下发拥塞区域的预定义规则组。
27|SMF向UPF发送PFCP Session Modification Request消息，携带拥塞区域的预定义规则组，UPF上预配置拥塞区域的预定义规则组，比如保障用户上网和IM类通信业务、劣化游戏和视频类业务。
## 流量经营场景之校园通 
### 应用场景 
#### 背景介绍 
校园是具备集中用户的典型区域。充分开发集中用户，可以实现校园这一特定区域的无线资源利用最大化，节省运营商资源消耗。为了吸纳校园区域内的用户，提升资源利用率，可以引入校园通策略。 
 说明： 
基于区域的策略场景繁多，本文档以“校园通”举例说明位置控制的解决方案，其他场景控制策略原理相同。 
#### 场景说明 
校园通策略指的是：在运营商规划的校园区域内，使用差异化计费方式。采用这种策略，可以让特定区域的用户享受更便宜的资费，为运营商吸引更多新用户。具体场景说明参见[表1](1629101220096.html#ze3296216bc6445a0a39f974da9cb8b38__8b14f7e1-974d-438b-abf0-199df1ee37cb)。
用户类型|策略
---|---
签约校园通套餐的校园用户|在校园区域内使用数据业务，比在校园区域外使用数据业务的资费更便宜。
未签约校园通套餐的校园用户|在校园区域内使用数据业务与在校园区域外使用数据业务资费没有差异。
 说明： 
除了实行差异化计费策略外，还可以实行差异化QoS、差异化业务接纳，体现运营商的定制化服务能力，吸纳更多用户。 
### 实现原理 
#### 概述 
该方案除了需要利用多维度套餐策略功能、PCC策略功能的支持以外，还需要利用以下功能支持： 
PRA功能 
位置上报功能 
PRA功能
PRA（Presence Reporting Area，出现区域上报）功能是基于指定区域的策略控制，PRA定义的区域通常是包含一组位置信息的集合。当用户进入或离开指定PRA区域，SMF向PCF上报用户当前区域和状态信息，PCF根据SMF上报的信息进行策略决策并发起策略更新。
订阅：PCF下发PRA信息，SMF到AMF订阅PRA，PCF可以在不同的业务流程里下发订阅信息，SMF订阅、更新或取消订阅PRA事件。 
上报：AMF上报PRA状态，SMF向PCF上报PRA的状态，PCF根据PRA状态下发不同的策略。 
位置上报功能
PCF下发位置类的事件，当用户位置发生改变时，SMF向PCF上报用户当前位置，PCF根据SMF上报的位置信息进行策略决策并发起策略更新。 
订阅：PCF下发SCELL_CH事件，SMF到AMF订阅小区事件。PCF可以在不同的业务流程里下发订阅信息，SMF订阅、更新或取消订阅SCELL_CH事件。 
上报：AMF实时上报小区位置，SMF向PCF上报小区位置，PCF根据小区位置下发不同的策略。 
#### 关键流程 
该策略的关键流程为小区位置的订阅。 
通过PCF订阅SCELL_CH（小区位置）来实现“校园通”的流程图如[图1](1629101230498.html#z712dc59954dc40b8b5bc91a1f6ca9463__772f22ba-ed06-46ae-8e14-2cbe2da81cbf)所示。
图1  校园通接入流程
[]images/image.png)
流程关键描述参见[表1](1629101230498.html#z712dc59954dc40b8b5bc91a1f6ca9463__5c0bed9c-e579-4e47-969e-c565dfeb3d66)。
步骤|描述
---|---
5|SMF向PCF发起Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF向SMF发送Npcf_SMPolicyControl_Create Response消息，PCF判断用户是签约了园区套餐，但是处于非园区位置，不下发非园区预定义规则组。
18|SMF向AMF发起事件订阅,Namf_eventExposure_subscribe Request携带小区位置上报订阅。
20|终端访问业务，SMF向CHF发送非校园区域的计费标识。
21|用户进入校园区域后，AMF向SMF发送Namf_eventExposure_notification Request消息，携带校园区域的NCGI。
22|SMF向PCF发送Npcf_SMPolicyControl_Update Request消息请求修改SM策略控制关联，消息中携带SCELL_CH及NCGI。
23|PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，PCF基于NCGI进行策略决策，下发校园区域的预定义规则组。
24|SMF向UPF发送PFCP Session Modification Request消息，携带校园区域的预定义规则组，UPF预先配置校园区域的预定义规则组差异化的计费策略。
26|终端访问业务，SMF向CHF发送校园区域的计费标识，用户享受更低的资费。
27|用户离开校园区域后，AMF向SMF发送Namf_eventExposure_notification Request消息，携带非校园区域的NCGI。
28|SMF向PCF发送Npcf_SMPolicyControl_Update消息请求修改SM策略控制关联，消息中携带SCELL_CH及NCGI。
29|PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，PCF基于NCGI进行策略决策，移除校园区域的预定义规则组。
32|终端访问业务，SMF向CHF发送非校园区域的计费标识，对用户进行普通计费。
## 流量经营场景之金银铜用户 
### 应用场景 
#### 背景介绍 
网络中存在不少低价值不限流量套餐用户，这种套餐用户群数量大，特别是在忙时拥塞小区对网络资源冲击比较大，为运营商带来收益极少。而对运营商收入贡献占比比较大的套餐用户，网络资源却得不到有效保障，影响这部分优质用户满意度。 
为了缓解网络资源忙时紧张状况，特引入金银铜控制策略。基于用户流量消费对用户进行分级，等级越高的用户流量消费越高，可以享受更好的数据传输质量。从而保障高价值套餐用户的网络资源使用率，为运营商带来更多收益。 
#### 场景说明 
根据用户等级，制定金银铜用户控制策略，参见[表1](1630983049657.html#z256986900642446981f2d60474a6cec8__8a898dc1-081c-4c20-a059-f3737835b3ff)。
用户类型|拥塞小区1|非拥塞小区2
---|---|---
忙时（09:00～22:00）|非忙时|不区分闲忙时
---|---|---
金牌用户|BT业务：限速256kbps其他业务：不限速|BT业务：不限速其他业务：不限速|BT业务：不限速其他业务：不限速|BT业务：不限速其他业务：不限速
银牌用户|BT业务：限速128kbps其他业务：不限速|BT业务：限速128kbps其他业务：不限速|BT业务：限速128kbps其他业务：不限速|BT业务：限速128kbps其他业务：不限速
铜牌用户|BT业务：禁止其他业务：不限速|BT业务：禁止其他业务：不限速|BT业务：禁止其他业务：不限速|BT业务：禁止其他业务：不限速
 说明： 
BT全称BitTorrent，即比特流，是一种内容分发协议，每个下载者在下载的同时不断向其他下载者上传已下载的数据，充分利用用户的上载带宽，共享大体积文件。 
### 实现原理 
#### 概述 
该方案用到两大基本功能： 
弹性、多维度的套餐策略 
PCC策略执行功能 
#### 关键流程 
本策略的关键流程在于如何根据用户等级实现分级接入，从而下发不同策略。 
金牌用户
金牌用户接入的流程图如[图1](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__e7e842d9-38fe-4481-817e-a17ddd9a2f69)所示。
图1  金牌用户接入流程
[]images/1630996592524.png)
流程关键描述参见[表1](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__b51e7dbf-92de-474a-9af3-bd5e7117e3ef)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含金牌用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF向SMF发送Npcf_SMPolicyControl_Create Response消息，PCF判断用户是金牌用户，且是非忙时忙区接入，下发非忙时忙区的预定义规则组。
9|SMF向UPF发送PFCP Session Establishment Request消息，携带非忙时忙区的预定义规则组，UPF上预先配置了该预定义规则组的策略，比如BT业务不限速，其他业务也不限速。
20-21|用户进入忙时忙区，SMF向PCF发起Npcf_SMPolicyControl_Update Request消息，携带当前忙区的userLocationInfo。
22|PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，PCF判断用户是金牌用户，且是忙时忙区接入，下发忙时忙区的预定义规则组。
23|SMF向UPF发送PFCP Session Modification Request消息，携带忙时忙区的预定义规则组，UPF上预先配置了该预定义规则组的策略，比如BT业务限速256kbps，其他业务不限速。
银牌用户
银牌用户接入的流程图如[图2](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__65f62178-3010-4dca-a93b-9759f673255f)所示。
图2  银牌用户接入流程
[]images/1630996917518.png)
流程关键描述参见[表2](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__43da407d-5465-4a93-aab2-99837e5fc0f6)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含银牌用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF向SMF发送Npcf_SMPolicyControl_Create Response消息，PCF判断用户是银牌用户，下发银牌预定义规则组，不区分忙时忙区。
9|SMF向UPF发送PFCP Session Establishment Request消息，携带银牌预定义规则组，UPF上预先配置了该预定义规则组的策略，比如BT业务限速128kbps，其他业务不限速。
铜牌用户
铜牌用户接入的流程图如[图3](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__4fde4cea-d184-49b4-b306-7472f03e356d)所示。
图3  铜牌用户接入流程
[]images/1630997029465.png)
流程关键描述参见[表3](1630993976071.html#z86fe3f1409f14ff78eda937c1fcbfda8__9f34b017-7dd7-401c-b6f2-aa1c1e7f272a)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含铜牌用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF向SMF发送Npcf_SMPolicyControl_Create Response消息，PCF判断用户是铜牌用户，下发铜牌预定义规则组，不区分忙时忙区。
9|SMF向UPF发送PFCP Session Establishment Request消息，携带铜牌预定义规则组，UPF上预先配置了该预定义规则组的策略，比如不能访问BT业务，其他业务不限速。
## 流量经营场景之Tethering控制 
### 应用场景 
#### 背景介绍 
Tethering是一种网络共享技术，Laptop、Tablet或其他智能终端等设备（从终端）可以通过WiFi接入具备Tethering功能的移动智能终端（主终端），使用分组数据业务，如[图1](1630999672677.html#z04850f8933cd4ff9902cbaab90b73adb__c8dd1dbc-f867-4b41-85a3-897dcf13cc44)所示。
图1  Tethering共享接入
[]images/1631151983278.png)
使用Tethering目前存在以下问题： 
非签约设备（Laptop、PC、Tablet等）可以作为从终端使用主终端的网络流量，用户月平均使用流量出现明显上升，运营商的成本上升，盈利下降。 
对运营商业务数据卡的销售产生冲击，减少运营商收益点。 
基于上述问题，引入了Tethering用户检测功能，利用Tethering检测对Tethering用户的主、从终端进行不同的策略控制。 
#### 场景说明 
Tethering控制策略是一种基于用户终端的区别实行差异化流量经营的策略，可以增加新的收入增长点，弥补其数据卡业务收入流失。Tethering套餐是目前针对使用Tethering情况设计的一种流量套餐。针对用户是否签约Tethering套餐，可以设置不同的PCC控制策略，具体策略说明参见[表1](1630999672677.html#z04850f8933cd4ff9902cbaab90b73adb__99913787-1be6-4005-b090-963ac7475dd2)。
用户类型|终端类型|策略
---|---|---
签约了Tethering套餐的用户|主终端|允许访问所有业务，不限速
从终端|签约了Tethering套餐的用户|允许访问所有业务，限速256kbps定义一个套餐流量更大、单位流量成本更低的Tethering套餐，培养用户新的消费习惯
没有签约Tethering套餐的用户|主终端|允许访问所有业务，不限速
从终端|没有签约Tethering套餐的用户|不允许访问所有业务发送E-mail/SMS短信给该用户，引导其签约Tethering套餐
### 实现原理 
#### 概述 
该解决方案，除了应用多维度的套餐策略功能外，还利用了如下功能： 
主从业务流量独立控制功能 
Tethering上报功能 
主从业务流量独立控制功能
使用UPF实现主从业务流量独立控制功能，具体实现方式如下： 
UPF检测用户的Tethering行为，包括用户是否开启了Tethering，以及有多少设备（从终端）连接了用户的智能终端（主终端）。 
对Tethering主、从终端进行独立的策略控制。 
Tethering上报功能
UPF把检测的Tethering终端个数上报给SMF，SMF把Tethering终端个数上报PCF，由PCF进行策略决策。 
#### 关键流程 
签约用户
签约了Tethering套餐的用户流程如[图1](1630999990178.html#z2a36c830f32744e2811a4b4c1dc44fb6__00876300-f538-4935-a6ff-85581d5e3379)所示。
图1  签约Tethering套餐的用户流程图
[]images/1631001416411.png)
流程关键描述参见[表1](1630999990178.html#z2a36c830f32744e2811a4b4c1dc44fb6__e8e6ef2b-39f5-43e1-96c0-5a014757f10f)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi等关键信息。
6|PCF判断用户是Tethering签约用户，下发Tethering套餐、主从用户预定义规则组。
9|SMF向UPF发送PFCP Session Establishment Request消息，携带Tethering套餐的主从用户预定义规则组，UPF上预先配置了该预定义规则组的策略，比如主终端允许访问所有业务且不限速，从终端允许访问所有业务，限速256kbps。
未签约用户
未签约Tethering套餐的用户流程图如[图2](1630999990178.html#z2a36c830f32744e2811a4b4c1dc44fb6__779ed93a-0835-4c7e-817b-9a73f310090f)所示。
图2  未签约Tethering套餐的用户流程图
[]images/1631001457435.png)
流程关键描述参见[表2](1630999990178.html#z2a36c830f32744e2811a4b4c1dc44fb6__6a8e5ab9-c6bf-4525-be08-8b180c79a256)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi等关键信息。
6|PCF判断用户是非Tethering签约用户，下发非Tethering套餐、主从用户预定义规则组以及TETHERING_COUNT事件。
9|SMF向UPF发送PFCP Session Establishment Request 消息，携带非Tethering套餐的主从用户预定义规则组，UPF上预先配置了该预定义规则组的策略，比如主终端允许访问所有业务且不限速，从终端不允许访问所有业务。
18|用户开始Tethering行为，由于UPF禁止从终端的业务报文，从终端无法访问业务，UPF向SMF上报PFCP Session Report Request消息，携带tetheringCount属性指示Tethering终端个数。
20|SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，携带TETHERING_COUNT事件，并通知tetheringCount属性指示Tethering终端个数。PCF收到该消息后，发送E-mail/SMS短信给该Tethering用户，引导其订阅Tethering套餐。
#### 应用限制 
当存在如下情况时，无法进行Tethering检测，会导致策略失效： 
非Android、iOS、Windows系统。 
通过其他系统（如移动Wi-Fi设备）共享上网。 
使用工具软件修改了默认IP或TCP首部。 
使用Proxy共享、VPN共享上网。 
智能终端的出厂预装操作系统是Android9（Linux内核版本V4.9+）及以上系统。 
## 流量经营场景之家长控制 
### 应用场景 
#### 背景介绍 
未成年人的自我约束能力较弱，需要家长引导，引导主要体现在四个层面。 
年龄：小学生和中学生的自我约束能力不同，家长的引导程度不同。 
业务：未成年人分辨能力较弱，需要引导他们浏览正确内容（例如教育、科研），免遭不健康网站、易沉迷性游戏的毒害。 
时间：未成年人自制能力不强，需要引导他们在允许时间内使用网络业务，例如上课时间不允许使用。 
每日用量：未成年人使用网络过度，既易上瘾又易对身体健康造成伤害，因此需要限制他们每天的使用量，超出用量时，拒绝访问。 
基于上述引导需要，本策略引入家长控制，方便家长对未成年人实施引导教育，体现运营商差别化定制的能力。 
#### 场景说明 
本方案采用控制手段，辅助家长引导不同年龄阶段的未成年人在规定时间、有限度地访问适龄业务。基于年龄的引导可参照[流量经营场景之金银铜用户](1630983508909.html)策略，基于每日用量的引导可参照[流量经营场景之达量限速](1631063710268.html)策略，以下对业务和时间引导策略做场景说明，参见[表1](1631069430329.html#z04fc9744e72a4a7e9a82f44e1b9279e5__26c1388d-73fe-4bba-87bb-99c74647dea5)。
控制对象|策略
---|---
业务|拒绝访问IM通信类业务、不健康网站、游戏等，只允许访问特定业务，比如教育、科研类业务。
时间|上课时间不允许使用业务，课余时间、节假日可以使用业务。
### 实现原理 
#### 概述 
该解决策略，除了应用概述中提到的基本功能外，还应用了规则支持时间策略。 
规则支持时间策略即策略中的规则可以携带AT（激活时间）和DT（去激活时间），用户处于规则生效时间内，规则才有效，当用户处于非生效时间内，规则不生效。规则支持时间策略需要以下网元支持： 
PCF：PCF下发规则携带AT和DT。 
SMF：SMF收到PCF下发的规则，SMF把规则名和AT、DT一并携带给UPF。 
UPF：PCC预定义规则的策略配置在UPF上，UPF收到SMF透传的预定义规则，如果携带AT/DT，则采用不同的处理方式：携带AT：UPF激活预定义规则，该预定义规则开始生效。携带DT：UPF去激活该预定义规则，该预定义规则不再生效。 
#### 关键流程 
对学生上网业务进行控制
基于业务控制的流程图如[图1](1631069915783.html#z9f596c41fdf14f8fa57d65a40a0fb80c__0e570812-6fa0-40aa-8f15-559d62611700)所示。
图1  基于业务控制的流程
[]images/1631070370620.png)
流程关键描述参见下表。 
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF判断用户签约了家长管控套餐，在Npcf_SMPolicyControl_Create Response消息中向SMF下发家长管控套餐对应的规则组名。
7|SMF向UPF发送PFCP Session Establishment Request消息，携带家长管控套餐对应的规则组名，UPF上预配置家长管控套餐对应的规则组，规则组的策略包括：允许访问特定业务，比如新闻、教育、科研类业务；禁止访问IM通信类业务、娱乐、游戏等。
8|UPF激活家长管控套餐对应的规则组，并向SMF发送PFCP Session Establishment Response消息。
后续UPF只允许用户访问教育、科研类业务。 
对学生上网的时间进行控制
基于时间控制的流程图如[图2](1631069915783.html#z9f596c41fdf14f8fa57d65a40a0fb80c__3c5581c1-bb1c-4ac2-8bea-bf90aca90a2e)所示。
图2  基于时间控制的流程
[]images/1631070582297.png)
流程关键描述参见下表。 
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF判断用户签约了家长管控套餐，向SMF下发家长管控套餐对应的规则组，包含了两组规则组：1.对学生上网业务进行控制的家长管控规则组，参考对学生上网业务进行控制流程；2.基于时间的业务禁止规则组，生效时间上午8:00到下午17:00。
9|SMF向UPF发送PFCP Session Establishment Request 消息，包含了两组规则组：1.对学生上网业务进行控制的家长管控规则组，参考对学生上网业务进行控制流程；2.基于时间的业务禁止规则组，生效时间上午8:00到下午17:00。UPF上预配置这两组规则组的策略。
18|上午8:00，UPF激活基于时间的业务禁止规则组，禁止访问任何业务。
19|下午17:00，UPF去激活基于时间的业务禁止规则组，允许访问教育、科研类业务。
## 流量经营场景之能力开放 
### 应用场景 
#### 背景介绍 
QoS能够反映网络服务质量，网络服务包括网络传输带宽、时延、丢包率等，网络服务质量越高，用户体验感越好。 
专载QoS Flow是5G网络中为特定业务（如视频、语音等）建立的有特定QoS保证的数据通路。专载QoS Flow原理示意图如[图1](1631067025006.html#zc48a6c75e64c481ca1cad65505c29cb2__dd5bd90a-5b7f-4d7b-aa67-f9cd8677a39a)所示。
图1  专载QoS Flow原理示意图
[]images/1631067207301.png)
建立专载QoS Flow后，QoS保障的效果有显著提升，具体参见[表1](1631067025006.html#zc48a6c75e64c481ca1cad65505c29cb2__a395345d-199b-40be-8d02-7fb561b28f61)。
业务类型|QoS保障效果
---|---
手游业务|时延降低至100ms，最低可达50ms，可将整体时延降低50%-70%。
证券类业务|手机券商APP行情刷新率提高80%，提升交易及时性。
移动视频类业务|高清、超高清视频播放的卡顿发生率降低30%，卡顿时长占比降低40%，用户体验提升。
上述效果是OTT厂家的迫切需求，而前提是运营商部署对应的网络。为探索运营商和OTT厂家合作新模式，引入该能力开放策略。 
 说明： 
OTT是通过互联网向用户提供的应用业务。这种业务和目前运营商所提供的通信业务不同，它仅利用运营商的网络，而服务由运营商之外的第三方提供。目前，典型的OTT业务有互联网电视业务、苹果应用商店等。 
#### 场景说明 
能力开放策略指的是，将QoS控制能力一定程度上开放给OTT厂商，触发专载QoS Flow。打通运营商和OTT厂家之间的联系，有助于增强用户的业务体验和黏性，拓宽运营商市场，增加收益。场景说明参见[表2](1631067025006.html#zc48a6c75e64c481ca1cad65505c29cb2__e408af83-8011-4663-a43d-039c7a975c4b)。
场景|场景说明|场景收益
---|---|---
一键加速|一键加速场景指的是用户可以通过一键加速这一选项提升网速。|与SP合作，为用户提供更优体验，实现后向盈利，促进用户消费。通过APP客户端，用户可通过临时签约提升带宽，满足用户紧急需求。
赞助业务QoS保障|赞助业务指的是赞助商替用户付费的业务，例如视频广告。|OTT厂商为VIP用户流量买单，运营商提升VIP用户的QoS。运营商向OTT厂商开放QoS控制及用量监控能力，满足OTT厂商的赞助业务需求并使得运营商能够分享收益。
### 实现原理 
#### 概述 
该解决方案需要利用以下功能支持： 
PCF的能力开放 
第三方支付 
PCF能力开放
PCF能力开放需要PCF网元和SMF网元的配合： 
PCF对外支持能力开放接口（Rx接口或者N5接口），收到能力开放平台的QoS申请，转换成PCC规则下发给SMF。 
SMF收到PCF下发的PCC规则，SMF触发建立专有QoS Flow对业务进行QoS保障和计费。 
第三方支付
当PCF下发动态规则中的赞助商标识（Sponsor Identity）或者应用服务提供商标识（Application Service Provider Identity）时，当用户访问相应业务，SMF对赞助业务单独出话单，对用户免费。具体需要以下网元的配合： 
网元|作用
---|---
PCF|接收AF的消息通知，将第三方业务识别过滤规则与第三方标识（分为赞助商标识与服务提供商标识）合在一起，定义出一个新的业务规则，通过标准的协议消息下发给PGW-C/SMF，指示PGW-C/SMF给用户会话安装新的业务规则。
SMF|接收PCF下发的消息，安装PCF指示的第三方业务规则，保存第三方标识。将PCF下发的第三方规则转化为标准的PFCP格式信息，并通过Sx/N4接口，下发给UPF，指示其安装相应的过滤、度量规则。处理来自UPF的用量上报请求，在话单中对第三方业务建立独立的容器保存用量，并在容器中填写最初PCF下发的第三方标识，输出话单给计费中心。
UPF|接收SMF的消息，安装相应的第三方业务规则，对匹配第三方业务识别条件的报文进行用量统计，并在满足特定条件的情况下，上报用量数据给SMF。
#### 关键流程 
一键加速
一键加速流程图如[图1](1631067813447.html#z09a5fcb11fa545cf946b813b13b446ce__e6afa48e-dd57-49c8-bf5f-c88f0375ec8b)所示。
图1  一键加速流程
[]images/1631068586083.png)
流程关键描述参见下表。 
步骤|描述
---|---
1|AF向PCF发起Npcf_PolicyAuthorization_Create Request或者AAR消息，请求QoS加速。
2|PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify Request消息，携带需要QoS加速业务的PCC规则。
5-17|SMF根据PCF的规则授权结果，触发建立QoS Flow，对业务进行QoS加速保障。
赞助业务QoS保障
赞助业务QoS保障流程图如[图2](1631067813447.html#z09a5fcb11fa545cf946b813b13b446ce__0caf8ff6-0d8d-4a07-9803-527f4836e299)所示。
图2  赞助业务QoS保障流程
[]images/1631068723443.png)
流程关键描述参见[表2](1631067813447.html#z09a5fcb11fa545cf946b813b13b446ce__57c8427e-5cea-4672-bf06-201a217f6883)。
步骤|描述
---|---
1|AF向PCF发送Npcf_PolicyAuthorization_Create Request或者AAR消息，请求对赞助业务进行QoS加速，携带赞助的配额。
2|PCF向SMF发送Npcf_SMPolicyControl_UpdateNotify Request消息，携带需要QoS加速业务的PCC规则，携带sponsorId、appSvcProvId、用量监控等信息。
5-17|SMF根据PCF的规则授权结果，触发建立QoS Flow，对业务进行QoS加速保障。
18-20|赞助业务单独出话单，对用户免费。
23|赞助业务的用量用完，SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，携带US_RE事件，并通过accuUsageReports属性携带当前的用量。
24|PCF向SMF发送Npcf_SMPolicyControl_Update Response消息，移除PCC规则，移除用量监控。
25-37|SMF根据PCF的规则授权结果，触发释放QoS Flow。
38-40|赞助业务不再单独出话单，开始对用户收费。
## 流量经营场景之高价值业务QoS提升 
### 应用场景 
#### 背景介绍 
QoS能够反映网络服务质量，网络服务包括网络传输带宽、时延、丢包率等，网络服务质量越高，用户体验感越好。 
专有QoS Flow是5G网络中为特定业务（如视频、语音等）建立有特定QoS保证的数据通路。专有QoS Flow的实现原理和保障效果请参考“[流量经营场景之能力开放](1631067019481.html)”
章节。
为了建立专有QoS Flow，运营商需要将QoS控制能力在一定程度上开放给OTT厂商，由OTT厂家触发专有QoS Flow的建立。同时，运营商需要部署能力开放平台，由OTT厂家向能力开放平台申请QoS提升，并且PCF需要向能力开发平台开放接口（Rx接口或者N5接口）。 
但由于运营商部署能力开放平台有一定的门槛，当运营商不愿将QoS控制能力开放给OTT厂商，或者暂时无法部署能力开发平台，或者OTT厂家不具备接入能力开发的条件时，可采用本方案来实现高价值业务QoS保障。 
#### 场景说明 
高价值业务QoS保障的专有QoS Flow建立由业务触发，当UPF检测到高价值的业务数据流到达时，UPF向SMF请求创建专有QoS Flow。当UPF检测到高价值的业务数据流结束时，UPF向SMF请求释放专有QoS Flow。 
本方案通过SMF/UPF检测业务，若为高价值业务则主动触发建立专载QoS Flow，对高价值业务进行保障。详细的场景说明参见[表1](1631005450887.html#z1311350d621846a2b4b3fddae97cfb13__1781b45d-ee31-4acb-bacc-e75e1e06e1b5)。
场景|场景说明|场景收益
---|---|---
高价值业务QoS保|当UPF检测到高价值的业务数据流到达时，UPF向SMF请求创建专有QoS Flow。当UPF检测到高价值的业务数据流结束时，UPF向SMF请求释放专有QoS Flow。|与SP合作，为用户提供更优体验，实现后向盈利，促进用户消费。通过APP客户端，用户可通过临时签约提升带宽，降低时延。相比较“流量经营场景之能力开放”，OTT厂家不需要对接能力开发平台，不需要提供高价值业务流的流特征信息。
### 实现原理 
#### 概述 
该策略除了需要基本功能支持以外，还需要TDF功能支持。
SMF/UPF根据PCF下发的PCC预定义规则或本地配置的静态规则为用户建立专有QoS
Flow进行QoS保障。 
具体需要以下网元的配合： 
网元|作用
---|---
PCF|根据用户的签约信息和位置信息等，给SMF下发支持本地TDF功能的预定义规则。
SMF|收到PCF下发的支持本地TDF功能的预定义规则，把预定义规则名发送给UPF。收到UPF的业务开始消息，新建QoS Flow，并把新建QoS Flow的消息通知UPF。收到UPF的业务结束消息，释放QoS Flow，并把释放QoS Flow的消息通知UPF。
UPF|收到SMF下发的支持本地TDF功能的预定义规则，对规则关联的业务进行业务检测。如果UPF上配置的静态规则支持TDF功能，对规则关联的业务进行业务检测。当特定业务开始时，通知SMF业务开始。当特定业务结束时，通知SMF业务结束。
#### 关键流程 
高价值业务QoS提升的流程图如[图1](1631005453733.html#z7a9d4830ee7e480580b1a6e4c7380bed__e02cef83-bc98-4292-8947-5303c98cde53)所示。
图1  高价值业务QoS提升的流程图
[]images/1647583644378.png)
流程关键描述参见下表。 
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF向SMF发送Npcf_SMPolicyControl_Create Resonse消息，PCF判断用户签约了高价值业务提升套餐，向SMF发送针对高价值业务下发QoS提升的预定义规则。
7|SMF向UPF发送PFCP Session Establishment Request消息，携带QoS提升的预定义规则，UPF上预先配置了该预定义规则组的策略，开启TDF功能。
18|用户访问高价值业务，UPF检测业务开始后，通过PFCP Session Report Request消息，通知SMF业务开始。
20-32|SMF根据UPF触发的业务开始行为，SMF建立QoS Flow。
#### 应用限制 
SMF/UPF需要提取业务的五元组建立专载，当业务的五元组不明确时，SMF/UPF提取的五元组不能表示业务特征，业务的上行报文可能传输在默认承载上。 
建议仅针对五元组比较明确的高价值业务开启该功能。 
## 流量经营场景之达量限速 
### 应用场景 
#### 背景介绍 
由于运营商最初采用包月不限流量的方式来拓展市场，对用户使用的业务没有限制，但P2P业务的广泛传播，打破了原有的网络流量模型，20%的用户占用了网络80%的流量，使得大部分用户由于网络拥塞而无法满足通信需求，新业务难以发展。因此，需要限制用户在某周期内的流量，在用户访问量超出限额时降低其访问速率或者提高费率，达到网络公平使用的原则，保证使用相同业务的用户得到同样的网络体验。
例如，对于包月用户，随着用户使用流量的增加，逐步降低用户带宽，降低访问速率，直至阻塞，如[图1](1631063713425.html#z4aa70a9a5bf0454ea799ec0cec998435__e6f140da-77ce-409b-854e-62061c2cb0fd)所示。
图1  包月用户被降低带宽过程
[]images/1631520887370.png)
用户流量的累计是采用流量控制策略的前提。目前有两种方法实现用户流量的累计： 
通过PCF进行流量累计。 
通过第三方系统（如计费系统）进行流量累计。 
#### 场景说明 
该方案采用PCF进行流量累计，在累计流量达到一定限额时，限制用户访问速率，实现对用户流量的控制，保证网络资源的公平使用，为使用相同业务的用户提供同样的网络体验。具体场景说明参见[表1](1631063713425.html#z4aa70a9a5bf0454ea799ec0cec998435__57862daf-76c5-4714-82b5-d9c8405e6275)。
场景|套餐说明
---|---
不限量上网流量包月|套餐配额为20 GB，超过20 GB要限速。当配额在20 GB内，限速Session AMBR=1 Gbps。当配额超过20 GB且小于30 GB，限速Session AMBR=1 Mbps。当配额超过30 GB，限速Session AMBR=256 Kbps。在每个速率切换的时间点，发送消息通知用户。
 说明： 
Session AMBR信元用于表示UE建立PDU会话时指示初始签约的PDU会话聚合最大比特速率，或者在网络改变PDU会话聚合最大比特速率时指示新签约的PDU会话聚合最大比特速率。 
### 实现原理 
#### 概述 
除了需要多维度的套餐策略以及PCC策略执行功能支持外，还需要用量监测功能支持。 
用量检测功能的具体内容如下： 
监测：SMF/UPF根据PCF指定的用量监控条件，对用户使用业务的流量和时长等进行监控统计。 
上报：当达到用量上报触发条件时，SMF向PCF上报用户的用量，PCF可以基于用户的用量进行PCC策略的重决策和重授权。 
#### 关键流程 
本方案的关键流程为达量降速。 
达量限速流程图如[图1](1631065142664.html#zdff1c52d90cf45ed9d21e3d7760fcff9__98933357-4f01-4bf7-b9d0-a370a3857339)所示。
图1  达量限速流程
[]images/1647510256284.png)
流程关键描述参见[表1](1631065142664.html#zdff1c52d90cf45ed9d21e3d7760fcff9__df09f054-023d-4d36-bfaa-aa981eb9d5f6)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF判断用户是达量限速用户，下发Session AMBR=1Gbps，携带会话级UmData。
8|SMF向UPF发送PFCP Session Establishment Request消息，携带Session AMBR=1Gbps和会话级用量监控。
21|SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，持续进行用量监控和用量上报。
22|PCF判断流量使用大于20GB，且小于30GB，PCF发送E-mail/SMS短信给该用户，提醒速率变更。PCF向SMF发送Npcf_SMPolicyControl_UpdateResponse消息，携带Session AMBR=1Gbps。
38|SMF向PCF发送Npcf_SMPolicyControl_Update Request消息，持续进行用量监控和用量上报。
39|PCF判断流量使用大于30GB，PCF发送E-mail/SMS短信给该用户，提醒速率变更。PCF向SMF发送Npcf_SMPolicyControl_UpdateResponse消息，携带Session AMBR=256Kbps。
## 流量经营场景之超套限速 
### 应用场景 
#### 背景介绍 
本方案的背景与[流量经营场景之达量限速](1631063710268.html)一致。区别在于流量累计的主体不同。
#### 场景说明 
在[流量经营场景之达量限速](1631063710268.html)中，是由PCF进行流量累计，在累计流量达到一定限额时，限制用户访问速率。
本方案通过第三方系统（如计费系统）进行流量累计，当计费信息判断累计流量达到一定限额时，BOSS系统到UDR上修改套餐的状态，PCF针对不同的套餐状态修改PCC策略，达到超套限速的目的。 
### 实现原理 
#### 概述 
该方案需要多维度的套餐策略、PCC策略执行功能两大基础功能的支持。 
#### 关键流程 
超套限速流程图如[图1](1631013136410.html#z808754508688466593cfc08cec91f8ff__ce99a791-177f-4130-9aaa-cec84f1793cf)所示。
图1  超套限速流程
[]images/1631015884936.png)
流程关键描述参见[表1](1631013136410.html#z808754508688466593cfc08cec91f8ff__15721e27-34c1-47af-a8f8-4ad418ed77e4)。
步骤|描述
---|---
5|SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，其中包含用户的关键信息，包括gpsi、supi、userLocationInfo等关键信息。
6|PCF到UDR上获取用户签约信息，判断用户目前的流量使用的状态处于套餐内。
7|PCF向SMF返回Npcf_SMPolicyControl_Create Response消息，指示sessionAMBR=1Gbps。
20|用户持续上网，SMF持续向计费系统上报话单，计费系统进行套餐用量累计。当用量超过套餐时，计费系统通过IT系统到UDR上修改用户套餐的状态。
21|UDM通知PCF用户签约信息的套餐状态发生改变。
23|PCF判断用户签约信息套餐状态发生改变，通过Npcf_SMPolicyControl_UpdateNotify Request消息通知SMF，指示sessionAMBR=10Mbps。
25-37|SMF触发修改sessionAMBR=10Mbps。
# 缩略语 
# 缩略语 
## AF 
Application Function应用功能
## AM 
Access and Mobility Management接入移动管理
## AMBR 
Aggregate Maximum Bit Rate聚合最大比特率
## AMF 
Access and Mobility Management Function接入和移动管理功能
## ANDSP 
Access Network Discovery & Selection Policy接入网发现和选择策略
## CHF 
Charging Function计费功能
## DN 
Data Network数据网
## DPI 
Deep Packet Inspection深度包检测
## GFBR 
Guaranteed Flow Bit Rate保证流比特率
## IM 
Instant Message即时消息
## MFBR 
Maximum Flow Bit Rate最大流比特率
## OTT 
Over The Top通过互联网向用户提供各种应用服务
## P2P 
Point to Point点对点
## PCC 
Policy and Charging Control计费和策略控制
## PCF 
Policy Control Function策略控制功能
## PDB 
Packet Delay Budget数据包时延预算
## PDR 
Packet Detection Rule报文检测规则
## PRA 
Presence Reporting Area出现上报区域
## QCI 
QoS Class IdentifierQoS类别标识
## RFSP 
RAT/Frequency Selection Priority无线/频率选择优先级
## RQA 
Reflective QoS Attribute反射QoS属性
## SBI 
Service Based Interface基于服务的接口
## SMF 
Session Management Function会话管理功能
## SP 
Service Provider服务提供商
## TDF 
Traffic Detection Function流量检测功能
## UPF 
User Plane Function用户平面功能
## URSP 
UE Route Selection PolicyUE路由选择策略
# 5G ULCL分流解决方案 
## 分流概念 
### 何为分流 
#### 概念 
ULCL是3GPP标准定义的新技术之一，目的是将PDU会话的上行流量分流到不同UPF，进一步发送至不同的DN，称之为“分流”。
#### 背景知识 
在没有“分流”概念的4G时代，移动网络已经出现了比较广泛的、对数据目的地的定制化诉求： 
服务商将服务器逐渐下沉部署，减少线路迂回以提升客户体验。 
企业对内部网络进行定制化管理，获得具有更高安全性和保障性的带宽。 
但仍有诉求在4G时代并没有得到很好的解决： 
服务器下沉后，从UE到核心网的距离，并没有本质的改变，因此线路迂回仍然较长，如图1所示。图1  本地数据迂回 
企业用户可以接入专用APN来访问企业内网，但是这种做法会导致用户无法同时访问外部网络，或者需要打通企业内网和通用网络之间的路径，如图2所示。图2  专网用户无法访问通用数据 
ULCL技术出现后，上述问题迎刃而解。负责分流的ULCL UPF将本地业务（如企业内部使用的业务，或服务商部署的下沉业务）与Internet业务分离开来，并分别通过主/辅锚点UPF，送达中心网络或本地网络，如[图3](6944191.html#Qy-0440B6F3__82dcb439-3efc-4a6e-b483-fc7c7f66cec2)所示。
图3  ULCL分流
[]images/1646796418354.png)
#### 系统架构 
针对ULCL分流，3GPP标准定义的网络架构图如[图4](6944191.html#Qy-0440B6F3__6bab3431-dae8-42d3-b747-c78928f6a707)所示。
图4  3GPP定义的分流架构
[]images/%E5%9B%BE%E7%89%871.png)
在如[图4](6944191.html#Qy-0440B6F3__6bab3431-dae8-42d3-b747-c78928f6a707)所示分流线路上，UPF有两种形态——ULCL UPF（中文常称为“分流UPF”）和PSA UPF（中文常称为“锚点UPF”），而PSA UPF可以细分为主锚点UPF与辅锚点UPF，具体说明参见[表1](6944191.html#Qy-0440B6F3__9a79b50c-d2ef-45ea-854f-6ab743f68f9b)。
UPF形态|描述
---|---
ULCL UPF（Uplink Classifier UPF）|实现ULCL功能的UPF。在激活分流策略时或分流业务进行时，由SMF插入到用户会话中。ULCL UPF通过N9接口与锚点UPF连接：对于上行流量，ULCL UPF按分流策略识别报文后，区分出需要发送给主锚点UPF和辅锚点UPF的报文并转发给相应的锚点UPF。对于下行流量，对来自锚点UPF的报文进行聚合，并通过N3接口转发给基站。|ULCL UPF（Uplink Classifier UPF）
PSA UPF|主锚点UPF (PDU Session Anchor UPF)|该UPF通过N6接口与Internet连接。用户业务过程中，主锚点UPF作为Internet的PDU会话锚点，对ULCL UPF-主锚点UPF-Internet链路中的用户数据进行转发，并完成计费、业务控制等功能。
辅锚点UPF(Additional PDU Session Anchor UPF)|PSA UPF|激活分流策略时，与ULCL UPF同时插入到用户会话中的UPF。该UPF通过N6接口与本地DN连接。用户业务过程中，辅锚点UPF作为访问本地DN的PDU会话锚点，对ULCL UPF-辅锚点UPF-本地DN链路中的用户数据进行转发，并完成计费、业务控制等功能。
### 为何分流 
#### 概述 
ULCL分流作为5GC的新技术之一，目前主要有两类应用场景。 
应用场景一：园区或者企业希望“数据不出园区”。 
应用场景二：企业基于对数据安全/隐私的考虑，希望内网数据能够从移动核心网直接转发至企业内部。 
#### 应用场景一 
园区或者企业“数据不出园区”的场景，即园区数据（也就是本地数据）停留在园区内处理完成，不经过外部网络。特点如下： 
减少线路迂回，减少数据转发时延，提升用户体验。 
数据不出园区，提高企业信息的安全性。 
以应用广泛的校园网为例，说明该场景中的常见数据类型： 
终端类型|使用场景|常见数据类型
---|---|---
访问Internet的数据|访问本地DN的数据
---|---
手机（学生&教职工）|校园内|常规浏览网页产生的数据社交应用产生的数据|访问数字图书馆的数据访问各种校内资源产生的数据
手机（访客）|活动现场等特定区域|常规浏览网页产生的数据社交应用产生的数据|访问校内特定资源产生的数据
该场景的系统架构图如[图1](8092816.html#Qy-0440B6F3__70bb26c9-0adf-4f6a-a60d-10ce1eb8e134)所示。
图1  校园网分流系统架构
[]images/1646362152130.png)
通过ULCL分流，将校园内部流量直接转发至属于学校的本地DN，能有效提升数据的安全性并减少数据转发时延。 
同时，用户也可以访问Internet的业务，例如普通社交业务等。 
#### 应用场景二 
企业基于对数据安全/隐私的考虑，希望内网数据能从移动核心网直接转发至企业内部。特点如下： 
不管用户移动到哪里，都可以访问企业内网。 
内网数据位置固定，不随用户移动而变更。 
以应用广泛的校园网为例，说明该场景中的常见数据类型： 
终端类型|使用场景|常见数据类型
---|---|---
Internet的数据|学校的数据
---|---
手机（学生&教职工）|在家或者在学校外的其他地方|常规浏览网页产生的数据社交应用产生的数据|访问数字图书馆的数据访问各种校内资源产生的数据
该场景的系统架构图如[图2](8092816.html#Qy-0440B6F3__1576bb5a-e19f-4913-8252-7b7f08d77560)所示。
图2  校园网远程分流系统架构
[]images/1646362214898.png)
通过ULCL分流，将校园网用户的流量转发至属于学校的本地DN，使用户可以远程访问校园服务器，比如电子图书馆等数据。 
### 如何分流 
#### 概述 
ULCL分流的实现原理参见下表。 
核心|作用|实施网元
---|---|---
分流策略下发|分流策略决定哪些数据是通用业务，哪些数据是本地业务，以及本地业务部署在哪些位置（TA、小区等移动网络可区分的粒度）。激活分流策略，即在指定的用户会话上启动分流。|PCF/SMF
UPF选择及插入|根据激活的分流策略，选择合适的ULCL UPF和辅锚点UPF插入用户会话，以便正确转发本地数据。|SMF
分流策略实施|将分流策略转换成N4接口的数据转发/控制策略，下发给UPF，实施数据报文的正确转发。|SMF、UPF
#### 分流策略下发 
分流策略的下发并不受标准限定，一般是通过PCC规则的下发确定分流业务，典型的有三种方式，参见下表。 
分流策略的下发方式|说明
---|---
PCF下发的动态PCC规则|在PCF上配置完整的分流策略。当用户激活或者进入特定区域时，PCF将完整的分流策略下发给SMF，经过SMF处理后最终下发给ULCL UPF。
SMF本地配置的PCC规则|在SMF上配置分流策略名称，在UPF上配置完整的分流策略。当用户激活或者进入特定区域时，SMF会根据用户的DNN、位置等信息，将需要启用的分流策略名称（携带Application ID）下发给ULCL UPF。ULCL UPF根据接收到的策略名称，启用对应的分流策略。
PCF下发的预定义PCC规则|在PCF上配置分流策略名称，同时在SMF和UPF上配置完整的分流策略。当用户激活或者进入特定区域时，PCF根据用户签约信息，下发需要启用的策略名称下发给SMF，经过SMF处理后，再将Application ID继续下发给UPF。ULCL UPF根据接收到的Application ID，启用对应的分流策略。
#### UPF选择及插入 
在激活分流的过程中，SMF需要在众多UPF中，根据用户位置、分流业务部署、UPF服务范围等决策出最合适的UPF，并插入到用户会话中。 
插入的UPF|插入时机|插入UPF的目的|主要决策条件
---|---|---|---
主锚点UPF|用户激活时|完成用户与Internet之间的业务|用户DNN与切片信息
ULCL UPF|触发分流时|将用户数据分流给主/辅锚点UPF|用户DNN与切片信息用户位置信息合一部署情况，即ULCL UPF是否跟辅锚点UPF合一部署
辅锚点UPF|完成用户与本地DN之间的业务|触发分流时|DNAI信息用户DNN与切片信息合一部署情况，即ULCL UPF是否跟辅锚点UPF合一部署
#### 分流策略实施 
以校园网为例，介绍由PCF动态下发的ULCL分流策略实施的全流程：校园网用户在校园外接入网络后，移动到校园区域内，触发分流。校园网业务分流架构如[图1](8740596.html#Qy-0440B6F3__bc27f5d0-b777-49a3-8d91-3c10982ba4a8)所示。
图1  校园网业务分流架构
[]images/%E5%9B%BE%E7%89%872.png)
Step1：策略下发
在UE发起PDU会话请求，AMF为UE分配SMF后，SMF通过Npcf_SMPolicyControl_Create Request/Response消息与PCF建立SM策略关联，由PCF完成策略下发。
该过程中，PCF根据来自SMF的Npcf_SMPolicyControl_Create Request消息中携带的用户信息，查询用户签约数据，发现这名用户是校园网用户，签约了分流套餐。于是，PCF在下发的Npcf_SMPolicyControl_Create Response消息中包含分流策略，用于指示SMF/UPF如何分流。
Step2：PDU会话建立
在PCF向SMF下发PCC规则之后，SMF会基于DNN、切片、DNAI、UPF接口能力等因素，为UE选择合适的UPF（即主锚点UPF）。
SMF会向UPF下发业务策略，并最终建立UE-基站-主锚点UPF之间的PDU会话。该PDU会话是分流前的常规PDU会话，即校园网用户在校园外接入网络的场景，数据转发路径如[图1](8740596.html#Qy-0440B6F3__bc27f5d0-b777-49a3-8d91-3c10982ba4a8)中用户处于校园外情况。
Step3：触发分流
当校园网用户从校园外移动到校园内时，触发分流。触发分流分为如下几个关键过程： 
在用户会话过程中，SMF会实时检测用户的位置（一般是用户所在的TAI区或者小区），一旦用户的DNN+位置组合满足分流的触发条件，便会触发分流。此时，SMF会根据UPF的条件进行决策，选择最合适的ULCL UPF和辅锚点UPF。
选定UPF之后，SMF通知ULCL UPF和辅锚点UPF分别建立PFCP会话。在PFCP会话建立过程中：
SMF向ULCL UPF下发PDR，将需要启用的分流策略带给ULCL UPF，并获取ULCL UPF上的N3和N9隧道的本端信息。 
SMF向辅锚点UPF下发PDR，将进行校园内网业务的数据/策略控制/计费规则携带给辅锚点UPF，并获取辅锚点UPF上N9隧道的本端信息。 
进行会话更新。在已有PDU会话中插入ULCL UPF和辅锚点UPF的信息参见下表。 
更新内容|更新方式|涉及的消息流程
---|---|---
ULCL UPF-主锚点UPF之间的N9隧道|下行隧道端点|SMF从ULCL UPF获取，传递给主锚点UPF|SMF与各UPF之间的PFCP消息
上行隧道端点|ULCL UPF-主锚点UPF之间的N9隧道|SMF从主锚点UPF获取，传递给ULCL UPF|SMF与各UPF之间的PFCP消息
ULCL UPF-辅锚点UPF之间的N9隧道|下行隧道端点|SMF从ULCL UPF获取，传递给辅锚点UPF|SMF与各UPF之间的PFCP消息
上行隧道端点|ULCL UPF-辅锚点UPF之间的N9隧道|SMF从辅锚点UPF获取，传递给ULCL UPF|SMF与各UPF之间的PFCP消息
ULCL UPF-基站之间的N3隧道|下行隧道端点|AMF从基站获取，经SMF透传给ULCL UPF|SMF与ULCL UPF之间的PFCP消息
上行隧道端点|ULCL UPF-基站之间的N3隧道|SMF从ULCL UPF获取，经AMF透传给基站|SMF与AMF之间的Namf_Communication_N1N2MessageTransfer消息、AMF与基站之间的PDU Session Resource Setup消息
触发分流过程如[图3](8740596.html#Qy-0440B6F3__cd295064-e290-4ec8-a638-f5792853bf55)所示。
图3  触发分流过程
[]images/%E5%9B%BE%E7%89%873.png)
 说明： 
当用户从分流区域内直接上线时，Step2和Step3会合并成一个步骤执行，也就是，在会话建立过程中直接进行分流。 
Step4：分流生效
在触发分流过程，SMF已经将分流策略、业务控制规则下发给对应的UPF，ULCL UPF和主/辅锚点UPF使用N4接口规则进行报文处理，达到分流及数据转发目的，如[图5](8740596.html#Qy-0440B6F3__5f62feea-0d53-435d-87be-31fd181d8a6f)所示。
图5  分流生效过程
[]images/%E5%9B%BE%E7%89%874.png)
Step5：流程结束
至此，用户数据的转发路径完成了状态的迁移，如[图7](8740596.html#Qy-0440B6F3__db5b8ec1-f4ab-4d39-a21a-93b0c85e67ee)所示。图中常规会话表示分流前用户的数据转发路径，分流会话表示用户移动到分流区域，触发分流后的数据转发路径。
图7  分流转发路径的迁移
[]images/%E5%9B%BE%E7%89%875.png)
## 分流实现原理 
### 描述 
       3GPP针对于5G用户数据分流场景定义了ULCL功能，通过上行分流器（即ULCL  UPF）实现根据用户业务流特征将访问园区业务的数据分流到园区内，将访问Internet的数据分流到Internet，有以下优点：
实现对用户业务数据的分流控制，满足用户“数据不出园区”的诉求。 
避免边缘侧数据通过公共承载网迂回，缩短数据传输路径。 
提升用户体验，节省运营商传输资源。 

ULCL功能的网络架构如[图1](7064048.html#Qy-0440B6F3__fc99184e-d652-49bb-a6d4-4f70b26aa6b5)所示。
用户访问本地DN的数据经过ULCL  UPF分拣后，通过N9接口传送给边缘UPF（即辅锚点UPF），并通过边缘UPF的N6接口传送到本地DN。 
用户访问Internet的数据通过N9接口传送给中心UPF（即主锚点UPF），通过中心UPF的N6接口传送到Internet。 
图1  ULCL网络架构
[]images/1648628226377.png)

为实现上述分流目的，需要SMF和UPF协作完成的功能项参见下表。 
功能项|描述
---|---
判断启动分流|用户只有进入到一定的区域范围内访问区域内的数据时才可能触发ULCL分流，且用户需要签约获取访问区域内业务的权限。 因此网络侧需要基于用户当前所处位置以及用户通过ULCL分流方式访问园区内业务的签约情况来判断是否需要分流。当网络侧判定用户需要通过ULCL分流方式访问区域内业务时，需要选择一个ULCL UPF和辅锚点UPF承接分流业务。
创建分流会话|修改/创建用户会话，最终创建UE-(R)AN-ULCL  UPF-主锚点UPF-Internet和UE-(R)AN-ULCL  UPF-辅锚点UPF-本地DN的数据通路。
下发分流策略|分流会话创建过程中，控制面网元PCF、SMF将分流策略下发给ULCL  UPF，其他策略（如计费相关的PCC规则）下发给辅锚点UPF。
执行分流策略|ULCL  UPF收到控制面下发的分流策略后会执行策略安装，在收到用户数据包以后根据数据包的特征对用户数据进行分流，如根据数据包携带的IP地址头或DNS域名头将用户数据分流到本地DN或Internet。
分流场景下的计费|分流场景下，辅锚点UPF和主锚点UPF均承担了终结用户数据流的角色，因此辅锚点也需要执行SMF下发的计费相关策略，对分流到园区内的数据流进行计费，ULCL UPF只负责分流数据，不负责计费。
业务分流过程|分流会话创建完成后，用户进行不同的数据业务，数据包的目的地可能是Internet也可能是本地DN。业务报文基于IP地址或域名匹配DPI规则后，被发送至相应的目的地。
### 判断启动分流 
用户如果要通过ULCL分流的方式访问园区业务，需要满足两个基本条件。 
用户进入到企业/单位规定的区域范围内，如进入企业园区等，区域范围在业务部署时确定。 
用户需要签约通过分流方式访问的业务套餐，通过部署业务对应的DNAI来确定。 
简言之，用户位置和签约的分流业务一起决定了是否启动分流。 
分流业务部署|分流激活时机|分流判断及激活|场景举例
---|---|---|---
SMF本地规则配置分流信息|员工从园区外移动至园区内，触发切换或移动更新流程，AMF会通过Nsmf_PDUSession_UpdateSMContext消息将用户位置信息带给SMF。或者，员工从园区内接入，AMF会通过Nsmf_PDUSession_CreateSMContext消息将用户位置信息带给SMF。|SMF根据从AMF侧获取到的用户位置信息和本地配置的分流业务所归属的区域，决策是否激活分流策略。（可选）如果激活了分流策略，SMF使用分流策略关键信息DNAI选择可承载分流业务的辅锚点UPF以及ULCL UPF，也就是为分流业务选择合适的UPF（选择方法见表2）。（可选）如果分流UPF选择成功，则为用户创建分流会话。|专用DNN：该DNN下的用户都使用相同的策略。例如，企业为员工统一签约专用DNN，员工在园区范围内基于企业专用DNN通过ULCL分流的方式访问园区业务。通用DNN：所有人员都分流。例如，博物馆等公共服务，不需要特殊签约，只要来到分流区域，就启动分流。
PCF签约分流业务套餐|员工从园区外移动至园区内，触发切换或移动更新流程，AMF会通过Nsmf_PDUSession_UpdateSMContext消息将用户位置信息带给SMF。或者，员工从园区内接入，AMF会通过Nsmf_PDUSession_CreateSMContext消息将用户位置信息带给SMF。SMF通过Npcf_SMPolicyControl_Update_Request将用户位置上报给PCF。PCF根据用户位置和用户分流套餐的签约情况，判断是否激活分流业务。若要激活分流业务，PCF通过Npcf_SMPolicyControl_Update_Response将分流策略下发给SMF。|如果PCF下发了分流策略，SMF使用分流策略关键信息DNAI选择可承载分流业务的辅锚点UPF以及ULCL UPF，也就是为分流业务选择合适的UPF（选择方法见表2）。如果分流UPF选择成功，则为用户创建分流会话。|不管是通用DNN还是专用DNN，分流业务都需要区分用户。在DNN下，不同用户签约不同的分流套餐。例如，企业在员工已使用的通用DNN下叠加不同的分流套餐，可做到不同权限的员工可访问的企业业务范围不同，比如，只有财务人员才可访问企业服务器等。同理，只用专用DNN的情况下，不同用户也可以签约不同的分流业务。
UPF类型|必选条件|可选条件
---|---|---
主锚点UPF|用户DNN信息用户切片信息（S-NSSAI）通用业务支持能力（DNAI为*）UPF的接口能力：N9和N6|UPF的位置信息DNN内的优先级负载权重
ULCL UPF|用户DNN信息用户切片信息（S-NSSAI）用户位置区信息UPF的接口能力：N3和N9|DNN内的优先级负载权重
辅锚点UPF|用户DNN信息用户切片信息（S-NSSAI）分流业务支持能力，以DNAI标识UPF的接口能力：N9和N6|合一UPF（ULCL UPF和辅锚点UPF合一）优先级负载权重
### 创建分流会话 
#### N4接口规则 
执行分流的UPF选择完成之后，SMF需要通过PFCP会话消息通知各个UPF执行动作，最终打通数据路径。SMF和UPF之间的N4接口定义了PDR、FAR、QER、URR等规则（以下简称N4接口规则），参见下表。 
N4接口规则|作用
---|---
PDR|入向数据业务流识别策略，对进入UPF的数据包进行识别，主要包括流规则PDI（Packet Detection Information）和对应流动作（FAR、QER、URR）的ID信息。PDI包含报文方向（source interface）和Filter（SDF Filter/Application ID）。PDR通过流动作ID关联相应的FAR、QER、URR，来对用户报文进行相应的处理。
FAR|指示转发动作，转发动作包含转发、缓存、丢弃等。
QER|指示流控类动作，如带宽控制等。
URR|指示统计上报类动作，包含配额、阈值、时长、流量、上报原因等。
#### 业务流程 
分流示意图
分流会话过程中，上下行PDR、上下行数据流及组网接口如[图1](1448289.html#Qy-0440B6F3__75d08231-9049-4038-a8c0-d52cd8569759)所示。
图1  分流会话示意图
[]images/1648452906524.png)
上行PDR指示数据流从access口发送到core口，下行PDR指示数据流从core口发送到access口。
N9接口为UPF之间的接口，位于ULCL UPF一端的被称为N9c口，位于主锚点UPF和辅锚点UPF一端被称为N9a口。 
信令流程
以会话创建时启动分流为例，说明SMF如何通过N4接口的PFCP信令指示UPF进行数据分流。 
图2  会话建立时启动分流的N4交互流程
[]images/1646797610073.png)图中PSA0为主锚点UPF，ULCL/PSA1为ULCL UPF和辅锚点UPF合设。
流程说明如下。 
会话建立，SMF从PCF处获取分流策略或根据本地策略判断需要启用分流（方法参见[判断启动分流](1637362.html)），并根据分流业务的部署选择UPF。
SMF向PSA0（主锚点UPF）发起PFCP Session Establishment Request消息，携带UE地址，在该UPF上创建通用业务的上、下行PDR；PSA0在返回的响应消息中携带分配的N9上行隧道信息（F-TEID），用于连接ULCL UPF。
上行PDR参见表1，Source Interface为access，Destination Interface为core，因此上行PDR和其关联的FAR指示了PSA0的上行报文从自身的N9a口入，N6口出。FAR的Apply Action字段中forw位置位为1，表示对上行数据包执行转发。表1  下发给PSA0（主锚点UPF）的上行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中到PSA0的上行PDR标识。PDISource Interfaceaccess该PDR识别的源端口为access。Network InstanceN9a_VPN表示源端口的VPN，这里指PSA0的N9a口的VPN，SMF上可配置。SDF Filterany to assigned表示PCC规则。Source Interface TypeN9该PDR识别的源端口类型为N9a口。FAR ID整型表示和该PDR关联的FAR的标识。Create FARFARFAR ID整型FAR的标识。Apply Actionforw(1)取值为1，表示执行转发动作。Destination Interfacecore该PDR识别的目标端口为core。Destination Interface TypeN6该PDR识别的目标端口类型为N6口。 
下行PDR参见表2，Source Interface为core，Destination Interface为access，因此下行PDR和其关联的FAR规定了PSA0（主锚点UPF）的下行报文从自身的N6口入，N9a口出。FAR的Apply Action字段中buff位置位为1，表示当收到下行数据包时，将数据包缓存起来。表2  下发给PSA0（主锚点UPF）的下行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中到PSA0的下行PDR标识。PDISource Interfacecore该PDR识别的源端口为core。Network InstanceN6_VPN表示源端口的VPN，这里指PSA0的N6口的VPN，SMF上可配置。SDF Filterany to assigned表示PCC规则。Source Interface TypeN6该PDR识别的源端口类型为N6口。FAR ID整型表示和该PDR关联的FAR的标识。Create FARFARFAR ID整型FAR的标识。Apply Actionbuff(1)取值为1，表示执行缓存动作。Destination Interfaceaccess该PDR识别的目标端口为access。Destination Interface TypeN9该PDR识别的目标端口类型为N9口。Outer Header Creation(出口指向)x.x.x.x(ULCL UPF的N9c口地址)表示该PDR指向的目的端口（ULCL UPF的N9c口）的地址信息。 
SMF向ULCL/PSA1（ULCL UPF/辅锚点UPF）发起PFCP Session Establishment Request消息，创建分流UPF的上、下行PDR。SMF一般会下发两对PDR，一对用于指示ULCL UPF和主锚点UPF之间数据转发，一对用于指示ULCL/PSA1转发数据包到本地DN。ULCL/PSA1在返回给SMF的响应消息中携带给(R)AN侧分配的N3上行隧道信息以及给PSA0（主锚点UPF）分配的N9下行隧道信息。
ULCL UPF和PSA0（主锚点UPF）之间数据转发的PDR。上行PDR参见表3，Source Interface为access，Destination Interface为core，上行PDR和其关联的FAR规定了ULCL UPF的上行报文从自身的N3口入、N9c口出，指向PSA0（主锚点UPF）的N9a口。FAR的Apply Action字段中forw位置位为1，表示对上行数据包执行转发。表3  ULCL UPF和PSA0（主锚点UPF）之间数据转发的上行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中到PSA0（主锚点UPF）的上行PDR标识。PDI Source Interfaceaccess该PDR识别的源端口为access。Network InstanceN3_VPN表示源端口的VPN，这里指ULCL UPF的N3口的VPN。SDF Filterany to assigned表示PCC规则。Source Interface TypeN3-3gpp-access该PDR识别的源端口类型为N3口。FAR ID整型表示和该PDR关联的FAR的标识。Create FARFARFAR ID整型FAR的标识。Apply Actionforw(1)取值为1，表示执行转发动作。Destination Interfacecore该PDR识别的目标端口为core。Destination Interface TypeN9该PDR识别的目标端口类型为N9c口。Outer Header Creation(出口指向)x.x.x.x(PSA0 UPF N9a口地址)表示该PDR指向的目的端口（PSA0的N9a口）的地址信息。下行PDR参见表4，Source Interface为core，Destination Interface为access，因此下行PDR和其关联的FAR规定了ULCL UPF的下行报文从自身的N9c口入，从N3口出。FAR的Apply Action字段中buff位置位为1，表示当收到下行数据包时先缓存起来。表4  ULCL UPF和PSA0 UPF之间数据转发的下行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中到PSA0（主锚点UPF）的下行PDR标识。PDISource Interfacecore该PDR识别的源端口类型为core。Network InstanceN9_VPN表示源端口的VPN，这里指ULCL UPF N9c口的VPN。SDF Filterany to assigned表示PCC规则。Source Interface TypeN9该PDR识别的源端口类型为N9c口。FAR ID整型表示和该PDR关联的FAR的标识。Create FARFARFAR ID整型FAR的标识。Apply Actionbuff(1)取值为1，表示执行缓存动作。Destination Interfaceaccess该PDR识别的目标端口为access。Destination Interface TypeN3该PDR识别的目标端口类型为N3口。Outer Header Creation(出口指向)x.x.x.x(ULCL UPF的N9c口地址)表示该PDR指向的目的端口（ULCL UPF的N9c口）的地址信息。 
ULCL/PSA1和本地DN之间数据转发的PDR。上行PDR参见表5，Source Interface为access，Destination Interface为core，上行PDR和其关联的FAR规定了ULCL/PSA1的上行报文从自身的N3口入，从N6口出，指向Local DN。FAR的Apply Action字段中forw位置位为1，表示对上行数据包执行转发。表5  ULCL/PSA1 UPF到本地DN的上行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中到PSA1（辅锚点UPF）的上行PDR标识。PDISource Interfaceaccess该PDR识别的源端口为access。Network InstanceN3_VPN表示源端口的VPN，这里指ULCL UPF N3口的VPN。Source Interface Typeaccess该PDR识别的源端口类型为N3口。Application IDlocal_serviceSMF下发的分流策略，ULCL UPF在收到数据包后按Application ID匹配的本地分流策略执行数据的分流转发。FAR ID整型表示和该PDR关联的FAR的标识。Create FARFARFAR ID整型FAR的标识。Apply Actionforw(1)取值为1，表示执行转发。Destination Interfacecore该PDR识别的目标端口为core。Destination Interface TypeN6该PDR识别的目标端口类型为N6口。下行PDR参见表6，Source Interface为core，Destination Interface为access，下行PDR和其关联的FAR规定了ULCL UPF/PSA1的下行报文从N6口入，从N3口出。FAR的Apply Action字段中buff位置位为1，表示对下行数据包执行缓存。表6  本地DN到ULCL/PSA1 UPF的下行PDRIE类型取值含义Create PDRPDR ID整型指示当前会话中本地DN到ULCL/PSA1 UPF的下行PDR标识。PDISource Interfacecore该PDR识别的源端口为core。Network InstanceN6_VPN表示源端口的VPN，这里指ULCL/PSA1 N6口的VPN，SMF上可配置。Application IDlocal_service表示分流PCC规则。Source Interface TypeN6该PDR识别的源端口类型为N6口。FAR ID整型表示和该PDR关联的FAR标识。Create FARFARFAR ID整型FAR的标识。Apply Actionbuff(1)取值为1，表示执行缓存动作。Destination Interfaceaccess该PDR识别的目标端口为access。Destination Interface TypeN3该PDR识别的目标端口类型为N3口。Outer Header Creation(出口指向)x.x.x.x(ULCL/PSA1 UPF的N6接口地址)表示该PDR指向的目的端口（ULCL/PSA1 UPF的N6口）的地址信息。 
SMF向PSA0（主锚点UPF）发起PFCP Session Modification流程，更新下行PDR关联的FAR，指示数据报文从自身N9a口出，指向ULCL UPF的N9c口，同时将buff置为0，forw置为1，表示PSA0（主锚点UPF）可以转发下行数据包。详细字段描述参见[表7](1448289.html#Qy-0440B6F3__d80dc8b4-f30b-4438-a4c8-c6cf14d82893)。
IE类型|取值|含义
---|---|---
Update FAR|FAR|ID|整型|FAR的标识。
Apply Action|Update FAR|FAR|forw(1)|取值为1，表示执行转发动作。
Network Instance|Update FAR|FAR|N9_VPN|表示PSA0（主锚点UPF）的N9a口的VPN。
Outer Header Creation(出口指向)|Update FAR|FAR|x.x.x.x(ULCL UPF的N9c口地址)|表示该PDR指向的目的端口（ULCL UPF的N9c口）的地址信息。
SMF通过AMF与无线侧进行消息交互，将ULCL UPF分配给(R)AN侧的上行隧道信息带给(R)AN侧，并获取(R)AN侧为ULCL UPF分配的下行隧道信息。 
在与(R)AN侧完成交互后，SMF向ULCL UPF/PSA1 UPF发起PFCP Session Modification流程，更新N3隧道信息，详细字段描述参见[表8](1448289.html#Qy-0440B6F3__4c18b701-4d33-4b07-9635-d1fbaf1d14af)。至此ULCL分流会话的上、下行数据转发通路建立完毕。
IE类型|取值|含义
---|---|---
Update FAR|FAR|ID|整型|FAR的标识。
Apply Action|Update FAR|FAR|forw(1)|取值为1，表示执行转发动作。
Network Instance|Update FAR|FAR|N3_VPN|表示(R)AN侧的N3口的VPN。
Outer Header Creation（出口指向）|Update FAR|FAR|x.x.x.x|表示(R)AN侧的IP地址信息。
经过以上步骤，确定用户数据在ULCL UPF/辅锚点UPF、主锚点UPF上进行处理时所需要的PDR规则，规则说明如[图3](1448289.html#Qy-0440B6F3__2544aec7-16b1-4245-9ae7-ec687e9dc781)所示，UPF按照这些规则执行对应动作达到分流目的。
图3  ULCL/辅锚点UPF合一场景下的N4规则
[]images/%E5%9B%BE%E7%89%8710.png)
### 下发分流策略 
ULCL UPF要对数据包进行分流，需要知道进行分流的数据包的特征，也就是ULCL UPF要执行的分流策略。ULCL UPF上的分流策略，可通过两种方式确定。 
UPF本地配置分流策略主要针对固定业务模式的行业用户，分流业务标识相对固定，比如企业固定服务器地址、DNS服务器等，波及PCF/SMF与UPF之间的业务映射，如图1所示。PCF/SMF和UPF需要共同规划Application ID即APP ID，通过Application ID标识业务；UPF定义具体的业务流特征，并在用户数据包转发过程中基于Application ID匹配本地配置的分流策略实现对数据报文的转发。图1  本地规则分流的业务映射关系 
网络侧动态下发分流策略主要针对动态上线的业务，可以通过PCF下发动态PCC规则来获取分流策略，其中包括定义业务报文特征的PF，SMF将PF通过N4接口规则PDR下发给UPF，UPF通过PF识别分流业务。 
综上，对于ULCL UPF来说，无论是哪一种分流策略获取方式，都需要在用户的分流会话创建/更新流程中由控制面来激活这些分流策略。 
### 执行分流策略 
#### 场景描述 
UPF按照分流策略，对符合分流特征的数据包进行分流，将本地业务流分流到园区服务器。 
#### 分流策略的安装 
ULCL UPF与辅锚点UPF可以分设，也可以合设。 
合设的场景下，SMF为合设的UPF创建一个PFCP会话，会话中包含分流到辅锚点UPF的PDR和分流到主锚点UPF的PDR，以及每个PDR关联的URR、QER、FAR。 
分设的场景下，SMF为ULCL UPF和辅锚点UPF各创建一个PFCP会话。 
安装对象|转发目的地|方向|PDR|FAR|URR|QER
---|---|---|---|---|---|---
Source Interface|F-TEID|SDF filter/Application ID|Destination Interface|F-TEID
---|---|---|---|---
ULCL UPF（分设）|辅锚点UPF|上行|Access|N3口|SDF/APPID|Core|N9口|-|-
(R)AN|ULCL UPF（分设）|下行|Core|N9口|SDF/APPID|Access|N3口|-|-
主锚点UPF|ULCL UPF（分设）|上行|Access|N3口|Any to Any|Core|N9口|-|-
(R)AN|ULCL UPF（分设）|下行|Core|N9口|Any to Any|Access|N3口|-|-
辅锚点UPF（分设）|Local DN|上行|Access|N9口|SDF/APPID|Core|-|分流业务规则|分流业务规则
ULCL UPF|辅锚点UPF（分设）|下行|Core|-|SDF/APPID|Access|N9口|分流业务规则|分流业务规则
ULCL UPF+辅锚点UPF（合设）|Local DN|上行|Access|N3口|SDF/APPID|Core|-|分流业务规则|分流业务规则
(R)AN|ULCL UPF+辅锚点UPF（合设）|下行|Core|-|SDF/APPID|Access|N3口|分流业务规则|分流业务规则
主锚点UPF|ULCL UPF+辅锚点UPF（合设）|上行|Access|N3口|Any to Any|Core|N9口|-|-
(R)AN|ULCL UPF+辅锚点UPF（合设）|下行|Core|N9口|Any to Any|Access|N3口|-|-
主锚点UPF|DN|上行|Access|N9口|SDF/APPID|Core|-|公网业务规则|公网业务规则
ULCL UPF|主锚点UPF|下行|Core|-|SDF/APPID|Access|N9口|公网业务规则|公网业务规则
APPID为PCF下发给SMF的Application ID，对应UPF上配置在RULE内的Application ID，SMF和UPF上配置的Application ID需要协商保持一致。 
#### 分流策略的匹配 
上行数据报文匹配过程
上行数据报文的匹配过程如[图1](7501365.html#Qy-0440B6F3__c881d4a7-6c04-40f4-810a-489c0e5efcc8)所示。
图1  上行匹配过程
[]images/1646880814119.png)
上行数据报文到达ULCL UPF，ULCL UPF根据F-TEID找到会话。 
对内层报文进行解析，通过深度识别获取业务对应的APP ID。匹配找到APP ID所属的PDR。 
（可选）如果存在SDF，通过匹配找到对应的PDR。 
综合选出优先级最高的PDR。 
执行PDR关联的URR、QER、FAR，完成数据转发。 
下行数据报文匹配过程
下行数据报文的匹配过程如[图2](7501365.html#Qy-0440B6F3__b40d0b01-228d-47c1-b984-4d831f530946)所示。
图2  下行匹配过程
[]images/1646880851719.png)
下行数据报文到达辅锚点UPF，辅锚点UPF根据UE的IP找到会话。 
对报文进行解析，通过深度识别获取APP ID。匹配找到APP ID所属的PDR。 
（可选）如果存在SDF，通过匹配找到对应的PDR。 
综合选出优先级最高的PDR。 
执行PDR关联的URR、QER、FAR，完成数据转发。 
#### 分流策略的执行 
对于UPF来说，分流策略包括动态规则和预定义规则。 
基于动态规则分流
图3  基于动态规则分流
[]images/1646881084077.png)
PCF通过SMF向UPF下发动态规则，规则中包含要分流业务的APP ID和分流业务的QoS规则、计费规则、转发规则。 
UPF收到报文后，匹配到对应的APP ID，执行PDR关联的QER、URR、FAR，实现指定业务的分流。
基于预定义规则分流
图4  基于预定义规则分流
[]images/1646881097416.png)
PCF通过SMF向UPF下发预定义规则，规则中包含要分流业务的预定义规则名。UPF上配置规则名对应的APP ID和QoS规则、计费规则、转发规则。 
UPF收到报文后，匹配到对应的Rule Name，执行业务规则，实现指定业务的分流。 
### 分流场景下的计费 
在非分流场景下，所有业务数据都由锚点UPF转发处理，计费也在锚点UPF执行。 
在分流场景下，数据转发路径上有两个锚点UPF，主锚点UPF负责转发处理普通业务的数据，辅锚点UPF负责转发处理分流业务的数据，各UPF执行对应数据的计费。 
以会话建立阶段启动分流为例，计费的实现原理如下。 
用户激活阶段，SMF将计费规则通过N4接口分别下发到主锚点UPF（PSA0）和辅锚点UPF（PSA1）。 
用户访问业务阶段，主/辅锚点UPF均可以对经过的数据申请配额、收集业务使用量，并上报到SMF，SMF按UPF向CHF申请配额，即CHF对每个锚点UPF进行配额管理，每个UPF独享配额。 
ULCL UPF没有计费规则，不执行计费。通常情况，ULCL UPF与辅锚点UPF是合设的，该合一UPF执行作为辅锚点UPF的计费操作。 
计费功能的信令流程图如[图1](7595889.html#Qy-0440B6F3__2be97ee0-2847-4b45-8439-83fa046a10f4)所示。
图1  计费流程
[]images/1640241345874.png)图中PSA0为主锚点UPF，ULCL/PSA1为ULCL UPF和辅锚点UPF合设。 
关键流程描述参见下表。 
步骤|描述
---|---
3a-3b|SMF将普通业务的计费规则下发给主锚点UPF。
4a-4b|SMF将分流业务的计费规则下发给辅锚点UPF。
7a-7b|辅锚点UPF向SMF发送PFCP Session Report Request消息，上报流量，申请配额。
8a-8b|SMF为辅锚点UPF向CHF申请配额（消息中Multiple Unit Usage字段携带PSA1的UPF ID）。
10a-10b|主锚点UPF向SMF发送PFCP Session Report Request消息，上报流量，申请配额。
11a-11b|SMF为主锚点UPF向CHF申请配额（消息中Multiple Unit Usage字段携带PSA0的UPF ID）。
后续计费流程和普通计费流程相同。 
### 业务分流过程 
分流会话创建完成后，用户进行不同的数据业务，数据包的目的地可能是Internet也可能是本地DN。报文匹配DPI规则（包括一级规则和二级规则）后，被发送至相应的目的地。
从用户报文的角度，业务分流可分为[基于IP地址分流](1641566569370.html)和[基于域名分流](1641566633774.html)两种。
#### 基于IP地址分流 
根据用户报文的目的IP地址和端口号进行分流策略匹配，将匹配成功的业务报文分流到本地网络的服务器。该方式实际上是基于一级规则的分流，分流流程如[图1](1641566569370.html#z0cb5d72aade24c5e90d5f805b8848c75__7ea88ef9-6a95-4b79-bbae-b48f23318cf5)所示。
图1  基于IP地址分流流程
[]images/1646895387530.png)
流程描述如下。 
会话建立，SMF获取分流策略或者根据本地策略判断需要启用分流，并根据分流业务的部署选择UPF，假设其选择结果为：主锚点UPF为PSA0，ULCL UPF和辅锚点UPF合设为ULCL/PSA1。 
UE发起上行业务，(R)AN将用户报文封装在N3接口GTPU隧道中，发送给ULCL/PSA1。 
ULCL/PSA1基于上行报文匹配一级分流规则，当报文的目的IP+端口号与规则匹配成功时，执行分流动作。ULCL/PSA1对分流报文的上下行数据执行QER、URR、FAR等规则。
ULCL/PSA1将N3接口GTPU隧道传输的报文解封装后，通过N6接口发送到本地网络。 
用户的下行报文通过N6接口返回ULCL/PSA1。 
ULCL/PSA1将下行报文封装在N3接口的GTPU隧道中，发送给(R)AN，(R)AN将下行业务报文发送给UE。 
正常对后续报文进行分流。 
#### 基于域名分流 
在无法获取用户报文的目的IP地址，只能获取业务流对应的域名时，需要根据用户报文的域名进行分流，将匹配成功的报文分流到特定域名的本地网络服务器。 
基于域名的分流相当于间接的二级规则分流，分流流程如[图1](1641566633774.html#zba867b9e77a94230993224fbc2bd2df0__eec2c85f-74b3-4e4c-a1f7-96fe5ca9e2dd)所示。
图1  基于域名的分流流程
[]images/1649215565432.png)
流程描述如下。 
会话建立，SMF获取分流策略或者根据本地策略判断需要启用分流，并根据分流业务的部署选择UPF，假设其选择结果为：主锚点UPF为PSA0，ULCL UPF和辅锚点UPF合设为ULCL/PSA1。 
UE发起DNS请求，比如域名是zte.com。(R)AN将DNS报文封装在N3接口的GTPU隧道中发送给ULCL/PSA1。 
ULCL/PSA1将N3接口的GTPU隧道报文解封装，基于上行报文匹配域名分流规则，当匹配到分流规则时，执行分流动作。ULCL/PSA1对分流报文的上下行数据执行QER、URR、FAR等规则。
ULCL/PSA1将DNS请求通过N6接口发送到本地网络的DNS服务器。 
用户的下行响应报文由N6接口返回ULCL/PSA1。 
ULCL/PSA1将下行报文封装在N3接口的GTPU隧道，发送给(R)AN，(R)AN将下行业务报文发送给UE。 
如果本地网络中的本地服务器不处理非本端地址的DNS请求，那么在步骤2、3、4、5中，ULCL/PSA1需要将DNS请求的目的地址重定向成本地DNS服务器，待收到DNS应答后，ULCL/PSA1将报文地址恢复成原始地址发送给UE。 
ULCL/PSA1通过匹配分流规则，确定DNS域名对应的服务器地址。 
用户发起本地DNS服务器的上行业务，(R)AN将用户报文封装在N3接口的GTPU隧道中发送给ULCL/PSA1。 
ULCL/PSA1基于上行报文的IP地址获取对应的域名，匹配基于域名的分流规则，匹配成功时，执行分流动作。ULCL/PSA1对分流报文的上下行数据执行QER、URR、FAR等规则。
ULCL/PSA1将N3接口的GTPU隧道报文解封装后，通过N6接口发送到本地网络。 
用户的下行报文通过N6接口发送到ULCL/PSA1。 
ULCL/PSA1将下行报文封装在N3接口的GTPU隧道中发送给(R)AN，(R)AN将下行业务报文发送给UE。 
正常对后续报文进行分流。 
## 分流UPF部署 
### 描述 
  
ULCL分流是MEC解决方案的基础，支撑着整个解决方案。移动边缘计算MEC将应用、内容以及核心网的部分业务处理和资源调度功能，一同部署在靠近接入侧的网络边缘，通过业务在网络边缘的本地处理，以及应用、内容与网络的协同，提供可靠、极致的业务体验。ULCL分流可广泛应用于自动驾驶、AR维修、远程医疗等5G业务场景，可灵活部署在企业园区、体育场、CBD等热点区域。3GPP协议定义，将靠近接入侧分流的ULCL架构嵌入到MEC解决方案中，也就是将ULCL UPF、辅锚点UPF部署在靠近用户的MEC平台中。
除了MEC、校园网等对接入侧的分流需求之外，在实际的应用中，也存在企业基于对数据安全/隐私的考虑，希望内网数据能从移动核心网直接转发至企业内部。不管用户移动到哪里，都可以访问企业内网，例如高校的学生放假回家也可以访问校园内的电子图书馆等数据。而这类应用场景，内网数据位置是固定的，不随用户移动而变更。针对这种实际的需求，利用ULCL数据分离技术，在归属UPF侧进行数据的分离，也就是ULCL UPF和主锚点UPF合一部署，达到数据在网络后侧分流的目的。 
为了方便表述，将3GPP定义的ULCL架构（前述第一类分流）称为前向分流，将第二类分流称之为后向分流。
前向分流和后向分流的具体区别参见[表1](1640589133374MrZt5o.html#Qy-0440B6F3__17666c67-d48f-450b-aa7f-71dc3f340655)。
分流架构|UPF部署方式|描述|应用说明
---|---|---|---
前向分流|ULCL UPF和辅锚点UPF分离部署，如图1所示。|靠近接入侧插入分流点进行分流，内网数据在靠近用户的地方接入内网。|内网数据部署在靠近用户接入的位置，只在指定区域内访问。具有如下优点：园区数据不出园区，保障安全性/隐私性。缩短内网数据转发路径，提高用户体验，节约网络资源。推荐合一部署方式，节约UPF资源，减少园区数据转发跳数。
ULCL UPF和辅锚点UPF合一部署，如图2所示。|前向分流|靠近接入侧插入分流点进行分流，内网数据在靠近用户的地方接入内网。|内网数据部署在靠近用户接入的位置，只在指定区域内访问。具有如下优点：园区数据不出园区，保障安全性/隐私性。缩短内网数据转发路径，提高用户体验，节约网络资源。推荐合一部署方式，节约UPF资源，减少园区数据转发跳数。
后向分流|ULCL UPF和主锚点UPF合一部署，如图3所示。|靠近网络侧插入分流点进行分流，内网数据集中到数据转发路径的后端集中接入内网，不随用户移动而变化。|内网数据集中部署，用户可在任何区域内访问。具有如下优点：园区数据不出园区，保障安全性/隐私性。
图1  ULCL UPF和辅锚点UPF分离部署的前向分流
[]images/1648106776531.png)
图2  ULCL UPF和辅锚点UPF合一部署的前向分流
[]images/1648106776672.png)
图3  后向分流
[]images/1648106776564.png)
### 前向分流 
前向分流是3GPP标准定义的分流典型场景，ULCL UPF部署在靠近用户接入的位置，当用户移动到指定区域内时进行分流。一方面，园区数据不出园区，保障安全性/隐私性；另一方面，缩短内网数据转发路径，提升用户体验，节约网络资源。 
针对用户是否处于跨域状态，3GPP标准定义了非跨域接入和跨域接入情况下的分流架构，如[图1](16405891339617EM48m.html#Qy-0440B6F3__6fee98b3-7399-4af2-b4ba-7a755c9ecac5)和[图3](16405891339617EM48m.html#Qy-0440B6F3__b3773e8d-a2a6-4807-999e-1406e1b38ad4)所示。
图1  非跨域接入分流架构
[]images/1651127038010.png)
图3  跨域接入分流架构
[]images/1651127090038.png)
以某大型企业为例，该企业在全国两个省份的三个地区设有三个园区，园区间相距较远，每个园区各自部署ULCL UPF，期望达到的数据访问控制效果参见[表1](16405891339617EM48m.html#Qy-0440B6F3__cd0936bb-4eb0-445b-84cd-c9e93c08a209)。
区域划分|不同类型用户的访问控制
---|---
企业用户|普通公众用户
---|---
企业园区|正常访问Internet网络正常访问该企业内网实现ULCL分流，自动分流内网和Internet数据跨域时，回归属域接入|正常接入5GC并访问Internet网络不能接入该企业内网
其它区域|正常接入5GC并访问Internet网络不能接入该企业内网|正常接入5GC并访问Internet网络不能接入该企业内网
以一个企业用户的接入过程为例，说明在不同区域访问内网数据和公网数据的过程，以及不同区域ULCL UPF的部署。 
场景一
企业用户从省A的园区1上线，通过园区1的ULCL UPF将内网数据分流到园区网络，将公网数据通过中心UPF分流到Internet网络，数据转发路径如[图5](16405891339617EM48m.html#Qy-0440B6F3__abb25784-77d6-4797-bd96-3879a72ba9cc)所示。
图5  园区1接入分流
[]images/1653531272731.png)
场景二
该企业用户从园区1移动到省A另一地区的园区2，此时由园区2的ULCL UPF2将内网数据分流到园区网络，将公网数据通过中心UPF分流到Internet网络，数据转发路径如[图7](16405891339617EM48m.html#Qy-0440B6F3__7b9be0a9-0251-4d3d-82d4-44208a997824)所示。
图7  园区2接入分流
[]images/%E5%9B%BE%E7%89%878.png)
场景三
该企业用户从园区1发生跨省漫游，到达省B的园区3，此时由园区3的ULCL UPF3将内网数据分流到园区网络，将公网数据通过中心UPF分流到Internet网络，数据转发路径如[图9](16405891339617EM48m.html#Qy-0440B6F3__b8a52585-8a6d-427d-b805-61626dd3a1a9)所示。
图9  跨域接入分流
[]images/%E5%9B%BE%E7%89%879.png)
 说明： 
场景一、二、三是以一个连续的接入为例进行描述。企业用户可以选择在任一园区进行初始接入，ULCL UPF为本园区UPF。 
### 后向分流 
后向分流是在数据转发路径的后端插入ULCL UPF，将内网数据分流到园区网络，解决内网数据不出园区的诉求，不管用户移动到何处都可以访问园区数据。 
以某企业为例，该企业只设有一个园区，期望达到如[表1](1640589133560gJSMqG.html#Qy-0440B6F3__e5dbb586-e2cc-4d85-ae65-0db95f9fabb1)所示的数据访问控制。
区域划分|不同类型用户的访问控制
---|---
企业用户|普通公众用户
---|---
企业园区|正常访问Internet网络正常访问该企业内网实现ULCL分流，自动分流内网数据和Internet数据|正常接入5GC网络并访问Internet网络不能接入该企业内网
其它区域|正常访问Internet网络正常访问该企业内网实现ULCL分流，自动分流内网数据和Internet数据跨域时，回归属域接入|正常接入5GC网络并访问Internet网络不能接入该企业内网
这种情况下，已部署的中心UPF承担ULCL UPF的功能，另部署一个或一对辅锚点UPF（边缘UPF）接入企业园区。以一企业用户接入/移动过程为例，说明后向分流的过程。 
场景一
企业用户从任何区域上线，中心UPF将公网数据转发到Internet网络，同时将内网数据分流到辅锚点UPF，进一步通过辅锚点UPF转发到园区，如[图1](1640589133560gJSMqG.html#Qy-0440B6F3__fcdab07e-cbf5-470b-9c37-42b2f4e1228c)所示。
图1  后向分流
[]images/5b6a3b6127c744a395c7d7bf9c55f920.png)
场景二
企业用户移出了中心UPF的服务区域，SMF选择一个I-UPF桥接数据，此时，园区数据依然由中心UPF分流，通过辅锚点UPF转发到园区，如[图3](1640589133560gJSMqG.html#Qy-0440B6F3__d341b52c-d215-423d-80a0-c6c65a71c4cb)所示。
图3  使用I-UPF的后向分流
[]images/1e38abcac6144e33a693869f493a1bd8.png)
场景三
企业用户移出SMF的服务区域，AMF选择并插入I-SMF，此时，园区数据依然由中心UPF分流，通过辅锚点UPF转发到园区，如[图5](1640589133560gJSMqG.html#Qy-0440B6F3__01754b88-b0fb-4476-951c-45cc5fe6a61a)所示。
图5  使用I-SMF的后向分流
[]images/cea79729daa94a0e9085a5f5f37c824f.png)
综上，后向分流场景，不关心用户所在的位置，企业网用户在任何地方均可访问园区内网。 
## 分流业务配置 
5G DNN等价于4G中的APN，是用户要访问的外部网络的标识。在实际应用中，DNN分为专用DNN和通用DNN两类。
分类|定义
---|---
专用DNN|运营商专门为某些特定的政企客户签约的用于标记政企业务的DNN。部分企业出于特定的业务需求会统一采购用于企业业务的固定终端或员工办公用的终端，企业会在这些终端上安装服务于自身业务的特殊APP，此时会考虑签约专用的DNN，通过统一发放SIM卡的方式对终端的业务行为进行控制。
通用DNN|用户访问运营商网络所公共使用的DNN。用户使用通用DNN可以访问Internet，也可以访问MEC园区网络。普通用户选购的某个运营商业务，SIM卡中一般内置了通用DNN。对于政企用户，在其签约专用DNN的场景下，运营商提供的终端SIM卡会内置通用DNN或同时内置专用DNN和通用DNN，这取决于政企业务的具体使用场景。
SMF是否对在线会话的用户启动分流，由以下两个关键因素决定： 
用户当前是否在分流园区内。 
用户是否签约了分流业务。 
分流业务部署是将这两个关键因素转化为网络运维。两个关键因素的配置方式如下： 
在SMF上按照DNN配置本地规则 
通过PCF针对特定用户签约套餐 
分流业务部署的具体配置场景，参见[表2](2614748.html#Qy-0440B6F3__77d91a77-aa47-40c2-86d2-4ef44052c6f6)。
分流业务部署|典型场景|适用DNN
---|---|---
基于SMF本地规则的前向分流|某企业用户向运营商申请签约了专用DNN，统一给员工发放企业终端，希望员工仅在企业园区范围内能通过专用DNN访问企业内部数据，同时又允许员工通过企业终端自由访问Internet。|基于SMF本地规则的前向分流|专用DNN
大型活动现场或者博物馆等对所有人都开放的数据，只要用户接入特定区域即允许访问。|基于SMF本地规则的前向分流|基于SMF本地规则的前向分流|通用DNN
基于PCF签约的前向分流|基于预定义规则的前向分流|某高校组建校园网，希望所有教职工及学生能够在校园范围内使用自有终端设备并通过专用的数据通路访问校园网，同时不对这些用户访问Internet的行为进行干涉。该场景的典型特征是人员流动频繁，每年会有大量学生离开或入学。运营商可以通过为校园用户统一签约套餐，在网络侧配置校园网用户信息以及允许访问校园网的区域范围，使校园网用户在规定范围内可以通过ULCL分流的方式访问校园网和Internet。|通用DNN
基于动态规则的前向分流|基于PCF签约的前向分流|场景同基于预定义规则的前向分流，区别在于要在PCF上配置或者从AF获取分流业务标识（比如AppID、PFs等），PCF通过动态规则下发给SMF，SMF不再需要配置具体的业务信息。|通用DNN
### 版本说明 
NF|支持版本
---|---
SMF|V7.21.33及以后版本
UPF|V7.21.32及以后版本
PCF|V7.20.20及以后版本
### 应用限制 
ULCL分流功能只针对5G用户，2/3/4G用户不支持。 
漫游V-SMF/I-SMF场景下暂不支持ULCL分流功能。 
前向分流功能不支持ULCL UPF和辅锚点UPF分离部署。 
ULCL方案必须开启融合计费功能，否则ULCL分流功能无法正常使用。 
### 基于预定义规则的前向分流 
#### 场景描述 
某大学建设校园网，希望所有教职员工以及学生能够使用自有终端设备通过专用的数据通路访问校园网，同时不对这些用户访问Internet的行为进行干涉。 
该场景的典型特征是人员流动频繁，每年会有大量学生离开或入学。运营商可以通过为校园用户统一签约套餐，在网络侧配置校园网用户信息以及允许访问校园网的区域范围，使校园网用户在规定范围内可以通过ULCL分流的方式访问校园网和Internet。 
当校园用户在规定区域内访问校园网时，PCF侧会根据用户信息以及用户当前所处的位置信息下发ULCL分流预定义规则给SMF，SMF基于分流预定义规则为用户创建 “UE→(R)AN→ULCL UPF/辅锚点UPF→主锚点UPF→Internet”和“UE→(R)AN→ULCL UPF/辅锚点UPF→本地DN”的数据通路，具体实现如[图1](0792243.html#Qy-0440B6F3__54b4502b-3025-4cdb-ba96-a768dc171ae1)所示。
图1  基于PCF签约分流策略
[]images/1659344611661.png)
PCF配置基于用户以及用户位置的分流预定义规则。 
UE在园区内发起PDU会话激活流程。 
PCF通过位置订阅的方式感知到用户在园区范围内，并且用户已签约ULCL分流预定义规则，于是向SMF下发ULCL分流预定义规则。 
SMF基于用户当前所处的位置以及分流预定义规则选择出合适的ULCL UPF/辅锚点 UPF。 
SMF辅助创建分流会话，伴随分流会话创建过程，将分流策略（携带Application ID）下发给ULCL UPF/辅锚点 UPF，最终创建“UE→(R)AN→ULCL UPF/辅锚点UPF→主锚点UPF→Internet”和“UE→(R)AN→ULCL UPF/辅锚点UPF→本地DN”的数据通路。 
UE访问Internet/企业本地业务。 
ULCL UPF执行分流策略，将访问Internet的数据分流至主锚点UPF，经主锚点UPF的N6口发送至Internet，将访问企业本地业务的数据分流至辅锚点UPF，经辅锚点UPF的N6口发送至本地DN。 
在该部署场景下，细分三种业务应用场景，具体信令交互流程参见[信令交互](0828355.html)。
#### 功能配置 
##### UPF选择的配置架构 
在UPF选择的过程中，PCF和SMF相关配置及关联关系如[图1](0860107.html#Qy-0440B6F3__0df8f176-6684-4c4c-85db-eabd810f0c76)所示。
图1  UPF选择的配置架构
[]images/1658284574184.png)
##### 预定义规则配置架构 
在基于预定义规则的分流配置过程中，PCF、SMF和UPF相关配置及关联关系如[图2](0860107.html#Qy-0440B6F3__61397169-4b92-4225-898d-8843548ec893)所示。
图2  预定义规则配置架构
[]images/1658284628389.png)
##### SMF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|企业专用DNN。
是否真实APNDNN|ADD APNDNN|是|全网规划|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|-
ADD APNDNNPROFILE|模板名称|abc.com|本端规划|-
ADD MAPAPNDNNPROFILE|APN/DNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
Access|ADD MAPAPNDNNPROFILE|打开|本端规划|-
模板名称|ADD MAPAPNDNNPROFILE|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数。
SET APNDNNBASIC|模板名称|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数，并通过ADD MAPAPNDNNPROFILE命令把APN基础功能模板绑定在APN/DNN下。
ULCL/BP开关|SET APNDNNBASIC|打开|本端规划|-
SET PCCFUNCPROFILE|PCC 功能模板名|abc.com|本端规划|-
规则分流功能方式|SET PCCFUNCPROFILE|预定义规则分流|本端规划|-
分流方式|SET PCCFUNCPROFILE|SMF决策分流|本端规划|-
ADD STEERINGPOLICY|分流策略名称|profilename|本端规划|-
DNAI|ADD STEERINGPOLICY|dnai_abc|本端规划|-
ADD STEERINGRULE|分流规则名称|localrule|对端协商|必须要和对端UPF的SHOW RULE配置中的NAME参数一致。
应用标识|ADD STEERINGRULE|app_abc|对端协商|分流业务的标识，必须要和对端UPF的SHOW RULE配置中的APPLICATION参数一致。
分流策略名称|ADD STEERINGRULE|profilename|本端规划|-
优先级|ADD STEERINGRULE|10|本端规划|-
ADD UGROUP|GW-U组名称|UGroup1|本端规划|-
ADD UGROUPDNN|GW-U组名称|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
DNN|ADD UGROUPDNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
ADD UPNODE|GW-U节点名称|UPF_local|本端规划|负责分流的UPF名称。
GW-U节点对应的组|ADD UPNODE|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
接口类型|ADD UPNODE|IPV4|本端规划|-
GW-U节点网管口端口号|ADD UPNODE|7778|本端规划|-
ADD UPNODEID|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
Node ID类型|ADD UPNODEID|IPv4|本端规划|-
Node ID IPv4取值|ADD UPNODEID|193.168.34.16|本端规划|-
是否闭塞|ADD UPNODEID|否|本端规划|-
C面是否主动发起建链|ADD UPNODEID|是|本端规划|-
ADD UPSXINTERFACEIP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型优先级|ADD UPSXINTERFACEIP|IPv4|本端规划|-
IPv4地址|ADD UPSXINTERFACEIP|193.168.34.16|本端规划|-
IPv6地址|ADD UPSXINTERFACEIP|10::1|本端规划|-
端口|ADD UPSXINTERFACEIP|8805|本端规划|-
IPv4地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
IPv6地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
ADD UPATTRIBUTE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
SGW-U|ADD UPATTRIBUTE|是|对端协商|-
PGW-U|ADD UPATTRIBUTE|是|对端协商|-
UPF-N3|ADD UPATTRIBUTE|是|对端协商|-
UPF-N6|ADD UPATTRIBUTE|是|对端协商|-
UPF-N9|ADD UPATTRIBUTE|是|对端协商|-
SGW-S8|ADD UPATTRIBUTE|否|对端协商|-
PGW-S8|ADD UPATTRIBUTE|否|对端协商|-
ADD UPPDUSESSIONTYPE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型|ADD UPPDUSESSIONTYPE|IPv4v6|本端规划|-
ADD UPWEIGHT|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
权重|ADD UPWEIGHT|100|本端规划|-
ADD UPDNAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
DNAI|ADD UPDNAI|dnai_abc|对端协商|用于关联支撑企业分流业务的辅锚点UPF。说明：如果本UPF没有被其他会话选为主锚点UPF，本参数不能配置为“*”。
ADD UPSNSSAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
切片服务类型|ADD UPSNSSAI|1-eMBB|对端协商|-
切片区分|ADD UPSNSSAI|010101|对端协商|-
ADD TACGROUP|TAC组名称|TAClist|本端规划|企业园区物理位置所对应的TACList。
TAC类型|ADD TACGROUP|TACNR|本端规划|-
ADD TACNRSECTION|段名称|TAC1|本端规划|-
START(十六进制)|ADD TACNRSECTION|0x000001|本端规划|-
END(十六进制)|ADD TACNRSECTION|0x000006|本端规划|-
TACNR组名称|ADD TACNRSECTION|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD UPTACNRGROUP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
TACNR组名称|ADD UPTACNRGROUP|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD TACRANGEMAPPINGDNAI|段名称|TAC1|已配置数据中获取|该参数引用自ADD TACNRSECTION命令中的SECNAME参数。
START(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000001|全局规划|-
END(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000006|全局规划|-
DNAI1|ADD TACRANGEMAPPINGDNAI|dnai_abc|全局规划|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|增加DNN，并开启ULCL分流。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="cmnet"ADD APNDNNPROFILE:NAME="abc.com"ADD MAPAPNDNNPROFILE:APNDNN="abc.com",ACCESS="ENABLE",NAME="abc.com"SET APNDNNBASIC:NAME="abc.com",ULCLBPSWITCH=ENABLE
2|设置规则分流功能方式为预定义规则分流。|SET PCCFUNCPROFILE:PROFILENAME="abc.com",RULESTEERINGMETHOD="PRERULE",STEERINGMODE="SMFSTEERING"
3|新增模板名为profilename的分流策略模板。|ADD STEERINGPOLICY:STEERINGPOLICYNAME="profilename",DNAI="dnai_abc"
4|新增分流规则，绑定策略模板。|ADD STEERINGRULE:STEERINGRULENAME="localrule",APPLICATIONID="app_abc",STEERINGPOLICYNAME="profilename",PRECEDENCE=10
5|新增分流UPF。|ADD UGROUP:GName="UGroup1"ADD UGROUPDNN:GName="UGroup1", DNN="abc.com"ADD UPNODE:UPNAME="UPF_local",GNAME="UGroup1",MGRIPTYPE="IPV4",MGRPORT=7778ADD UPNODEID:UPNAME="UPF_local",NODEIDTYPE="IPV4",NODEIDIPV4VAL=193.168.34.16,ISBLOCK="false",ISACTIVEMAKEASSOC="true"ADD UPSXINTERFACEIP:UPNAME="UPF_local",IPV4ADDR=193.168.34.16,IPV6ADDR="10::1",IPPRIO="IPV4",PORT=8805,IPV4VRFID=1,IPV6VRFID=1ADD UPATTRIBUTE:UPNAME="UPF_local",SGWUFUNC="true",PGWUFUNC="true",UPFN3="true",UPFN6="true",UPFN9="true",SGW_S8="false",PGW_S8="false"
6|配置分流UPF接口类型。|ADD UPPDUSESSIONTYPE:UPNAME="UPF_local",PDUSESSIONTYPE="IPV4V6"
7|配置UPF权重。|ADD UPWEIGHT:UPNAME="UPF_local",WEIGHT=100
8|配置UPF和DNAI关联。|ADD UPDNAI:UPNAME="UPF_local",DNAI="dnai_abc"
9|配置UPF和切片关联。|ADD UPSNSSAI:UPNAME="UPF_local",SST="EMBB",SD="010101"
10|配置UPF和TAC关联。|ADD TACGROUP:TACGROUPNAME="TAClist",TYPE="TACNR"ADD TACNRSECTION:SECNAME="TAC1",STARTTACNR="0x000001",ENDTACNR="0x000006",TACGROUPNAME="TAClist"ADD UPTACNRGROUP:UPNAME="UPF_local",TACGROUPNAME="TAClist"
11|配置TAC和DNAI关联。|ADD TACRANGEMAPPINGDNAI:SECNAME="TAC1",STARTTAC="0x000001",ENDTAC="0x000006",DNAI1="dnai_abc"
##### UPF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|abc.com|企业专用DNN。
是否真实APNDNN|ADD APNDNN|是|全网规划|是|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|abc.com|-
ADD DNCFG|APN/DNN|abc.com|全网规划|abc.com|-
网络实例|ADD DNCFG|N6|全网规划|N6|-
ADD DPIUPCONFIG|DPI模板配置名|nourlprofile|本端规划|nourlprofile|-
信令计费模式|ADD DPIUPCONFIG|信令归业务（默认值）|本端规划|信令归业务（默认值）|-
还原识别开关|ADD DPIUPCONFIG|DISABLE（默认值）|本端规划|DISABLE（默认值）|-
ADD USERPROFILE|用户模板名称|prerule|dynrule|对端协商|与PCF对齐。该参数需要与PCF中ADD DM ACTION命令配置的N7_PCC_RULE_ID的名称一致。
用户模板类型|ADD USERPROFILE|预定义规则组|动态规则|对端协商|与PCF对齐。该参数需要与PCF中ADD DM ACTION命令配置的N7_PCC_RULE_TYPE的类型一致。
优先级|ADD USERPROFILE|4294967295（默认值）|4294967295（默认值）|本端规划|-
DPI模板配置|ADD USERPROFILE|nourlprofile|nourlprofile|已配置数据中获取|该参数引用自ADD DPIUPCONFIG命令中的NAME参数。
ADD URRMAP|URR ID|10000|20000|对端协商|与SMF对齐。
URR类型|ADD URRMAP|离线计费业务|在线计费业务|对端协商|与OCS对齐。
业务标识|ADD URRMAP|1|0|对端协商|与OCS对齐。
费率组|ADD URRMAP|1|1|对端协商|与OCS对齐。
ADD CHARGINGDATA|计费策略名称|charging_zte|本端规划|charging_zte|-
离线URR标识|ADD CHARGINGDATA|10000|已配置数据中获取|10000|该参数引用自ADD URRMAP命令中的URRID参数。
在线URR标识|ADD CHARGINGDATA|20000|已配置数据中获取|20000|该参数引用自ADD URRMAP命令中的URRID参数。
免费|ADD CHARGINGDATA|FALSE（默认值）|本端规划|FALSE（默认值）|-
首包策略|ADD CHARGINGDATA|PASS|本端规划|PASS|-
首包配额|ADD CHARGINGDATA|2000000|本端规划|2000000|-
生成内容计费容器|ADD CHARGINGDATA|ENABLE（默认值）|本端规划|ENABLE（默认值）|-
ADD QOSDATA|QoS策略名称|qos_zte|本端规划|qos_zte|-
ADD LBO|LBO规则名称|lbo10|本端规划|lbo10|-
策略路由模板号|ADD LBO|10|本端规划|10|-
网络实例|ADD LBO|N6|本端规划|N6|-
ADD TRAFFICCONTROLDATA|业务控制规则名称|traffic_zte|本端规划|traffic_zte|-
转发动作|ADD TRAFFICCONTROLDATA|FORWARD|本端规划|FORWARD|-
转发策略类型|ADD TRAFFICCONTROLDATA|LBO|本端规划|LBO|-
转发策略|ADD TRAFFICCONTROLDATA|lbo10|已配置数据中获取|lbo10|该参数引用自ADD LBO命令中的NAME参数。
ADD L34FILTER|L34过滤器名称|l34_v4|本端规划|l34_v4|-
IP地址类型|ADD L34FILTER|IPV4|本端规划|IPV4|-
IPv4服务端IP地址|ADD L34FILTER|192.168.1.0|本端规划|192.168.1.0|园区服务器IP地址。
IPv4服务端IP地址掩码|ADD L34FILTER|24|本端规划|24|园区服务器IP地址。
三四层协议类型|ADD L34FILTER|ANY|本端规划|ANY|-
ADD L34FILTERGROUP|三四层过滤规则组名|l34_g|本端规划|l34_g|-
三四层过滤器名|ADD L34FILTERGROUP|l34_v4|已配置数据中获取|l34_v4|该参数引用自ADD L34FILTER命令中的FILTERNAME参数。
ADD FLOWFILTER|流过滤器名称|l34_ff|本端规划|l34_ff|-
L34过滤规则组名|ADD FLOWFILTER|l34_g|已配置数据中获取|l34_g|该参数引用自ADD L34FILTERGROUP命令中的GROUPNAME参数。
ADD L7FILTER|过滤器名称|l7_dns_lbo|本端规划|l7_dns_lbo|-
URL|ADD L7FILTER|*.zte.com*|本端规划|*.zte.com*|-
应用层协议类型|ADD L7FILTER|DNS|本端规划|DNS|-
ADD L7FILTERGROUP|七层过滤规则组名|l7_dns_lbo_g|本端规划|l7_dns_lbo_g|-
七层过滤器名|ADD L7FILTERGROUP|l7_dns_lbo|已配置数据中获取|l7_dns_lbo|该参数引用自ADD L7FILTER命令中的FILTERNAME参数。
ADD FLOWFILTER|流过滤器名称|l7_dns_lbo_ff|本端规划|l7_dns_lbo_ff|-
L7过滤规则组名|ADD FLOWFILTER|l7_dns_lbo_g|已配置数据中获取|l7_dns_lbo_g|该参数引用自ADD L7FILTERGROUP命令中的GROUPNAME参数。
ADD SERVICEREWRITECTRL|Rewrite控制规则名称|dnsrewrite|本端规划|dnsrewrite|-
重定向的IPv4服务器地址|ADD SERVICEREWRITECTRL|100.100.100.100|对端协商|100.100.100.100|园区DNS服务器IP地址。
重定向的IPv6服务器地址|ADD SERVICEREWRITECTRL|0:0:0:0:0:0:0:0|对端协商|0:0:0:0:0:0:0:0|园区DNS服务器IP地址。
重定向的服务器端口号|ADD SERVICEREWRITECTRL|0|对端协商|0|-
ADD TRAFFICCONTROLDATA|业务流控制策略名称|traffic_dnslbo|本端规划|traffic_dnslbo|-
转发动作|ADD TRAFFICCONTROLDATA|转发|本端规划|转发|-
转发策略类型|ADD TRAFFICCONTROLDATA|LBO|本端规划|LBO|-
转发策略|ADD TRAFFICCONTROLDATA|lbo10|本端规划|lbo10|-
Service Rewrite控制规则名称|ADD TRAFFICCONTROLDATA|dnsrewrite|已配置数据中获取|dnsrewrite|该参数引用自ADD SERVICEREWRITECTRL命令中的RULENAME参数。
ADD RULE|规则名称|iprule|dnsrule|本端规划|-
应用标识|ADD RULE|10001|10001|对端协商|该参数需要与PCF中ADD APPSUBS命令的APPID参数配置一致。
流过滤器|ADD RULE|l34_ff|l7_dns_lbo_ff|已配置数据中获取|该参数引用自ADD FLOWFILTER命令中的FLOWFILTERNAME参数。
QoS策略|ADD RULE|qos_zte|qos_zte|已配置数据中获取|该参数引用自ADD QOSDATA命令中的NAME参数。
计费策略|ADD RULE|charging_zte|charging_zte|已配置数据中获取|该参数引用自ADD CHARGINGDATA命令中的NAME参数。
业务流控制策略|ADD RULE|traffic_zte|traffic_dnslbo|已配置数据中获取|该参数引用自ADD TRAFFICCONTROLDATA命令中的NAME参数。
ADD RULEBINDUP|用户模板|prerule/dynrule|prerule|已配置数据中获取|该参数引用自ADD USERPROFILE命令中的NAME参数。
规则名|ADD RULEBINDUP|iprule|dnsrule|已配置数据中获取|该参数引用自ADD RULE命令中的NAME参数。
优先级|ADD RULEBINDUP|0|0|本端规划|-
###### 配置步骤 
步骤|说明||操作
---|---|---|---
1|配置用户模板|配置APNDNN。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="abc.com"
配置DNN。|1|配置用户模板|ADD DNCFG:DNN="abc.com",NETWORKINSTANCE="N6"
配置DPI模板。|1|配置用户模板|ADD DPIUPCONFIG:NAME="nourlprofile",ACCOUNTMODE="SERVICE",URLRERECOG="DISABLE"
配置用户模板，并将用户模板与DPI模板关联。|1|配置用户模板|ADD USERPROFILE:NAME="prerule",USERPROFILETYPE="PREDEFINED_RULE_GROUP",PRECEDENCE=4294967295,DPIUPCONFIG="nourlprofile"ADD USERPROFILE:NAME="dynrule",USERPROFILETYPE="DYNAMIC_RULE",PRECEDENCE=4294967295,DPIUPCONFIG="nourlprofile"
2|配置计费和QoS策略|新增URR配置，UPF网元在报文匹配时会读取不同规则下对应的URR ID，从而进行相关功能的用量累计和上报。|ADD URRMAP:URRID=10000,TYPE="OFFLINECHARGESERVICE",SERVICEID=1,RATINGGROUP=1ADD URRMAP:URRID=20000,TYPE="ONLINECHARGESERVICE",SERVICEID=0,RATINGGROUP=1
新增计费策略，配置预定义规则对应的计费策略信息。|2|配置计费和QoS策略|ADD CHARGINGDATA:NAME="charging_zte",OFFLINEURRID=10000,ONLINEURRID=20000,FREE="false",NEWPACKETPOLICY="PASS",NEWPACKETQUOTA=2000000
新增QoS策略，配置预定义规则对应的QoS策略信息。|2|配置计费和QoS策略|ADD QOSDATA:NAME="qos_zte"
3|配置策略路由的转发策略|配置LBO分流规则，关联虚拟接口模板，从而关联到ROSNG的路由策略。|ADD LBO:NAME="lbo10",PRVTNO=10,NETWORKINSTANCE="N6"
配置业务控制策略，关联转发策略。|3|配置策略路由的转发策略|ADD TRAFFICCONTROLDATA:NAME="traffic_zte",ACTION="FORWARD",POLICYTYPE="LBO",POLICY="lbo10"
4|配置三四层流过滤器（基于IP地址分流时配置）|配置三四层过滤规则。|ADD L34FILTER:FILTERNAME="l34_v4",IPTYPE="IPV4",IPV4SERVERIP="192.168.1.0",IPV4SERVERIPMASK=24,PROTOCOL="ANY"
配置三四层过滤规则组，关联配置的三四层过滤规则。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD L34FILTERGROUP:GROUPNAME="l34_g",L34FILTERNAME="l34_v4"
配置流过滤器，关联配置的三四层过滤器组，实现对用户报文的特定过滤。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD FLOWFILTER:FLOWFILTERNAME="l34_ff",L34FILTERGROUPNAME="l34_g"
5|配置规则（基于IP地址分流时配置）|配置DPI规则，关联流过滤器、QoS策略、计费策略等，根据这些规则识别满足条件的业务报文，进行不同的计费和控制。|ADD RULE:NAME="iprule",APPLICATION="10001",FLOWFILTER="l34_ff",QOSDATA="qos_zte",CHARGINGDATA="charging_zte",TRAFFICCONTROLDATA="traffic_zte"
配置用户模板与DPI规则绑定。|5|配置规则（基于IP地址分流时配置）|ADD RULEBINDUP:UPNAME="prerule",RULENAME="iprule",PRECEDENCE=0ADD RULEBINDUP:UPNAME="dynrule",RULENAME="iprule",PRECEDENCE=0
6|配置七层流过滤器（基于域名分流时配置）|配置七层过滤规则。|ADD L7FILTER:FILTERNAME="l7_dns_lbo",URL="*.zte.com*",APPTYPE="DNS"
配置七层过滤规则组，关联配置的七层过滤规则。|6|配置七层流过滤器（基于域名分流时配置）|ADD L7FILTERGROUP:GROUPNAME="l7_dns_lbo_g",L7FILTERNAME="l7_dns_lbo"
配置流过滤器，关联配置的七层过滤器组，实现对用户报文的特定过滤。|6|配置七层流过滤器（基于域名分流时配置）|ADD FLOWFILTER:FLOWFILTERNAME="l7_dns_lbo_ff",L7FILTERGROUPNAME="l7_dns_lbo_g"
7|配置规则（基于域名分流时配置）|配置重定向策略，并将业务控制策略关联重定向策略。|ADD SERVICEREWRITECTRL:RULENAME="dnsrewrite",REWRITEIPV4="100.100.100.100",REWRITEIPV6="0:0:0:0:0:0:0:0",REWRITEPORT=0ADD TRAFFICCONTROLDATA:NAME="traffic_dnslbo",ACTION="FORWARD",POLICYTYPE="LBO",POLICY="lbo10",SERVICEREWRITE="dnsrewrite"
配置DPI规则，关联流过滤器、QoS策略、计费策略等，根据这些规则识别满足条件的业务报文，进行不同的计费和控制。|7|配置规则（基于域名分流时配置）|ADD RULE:NAME="dnsrule",APPLICATION="10001",FLOWFILTER="l7_dns_lbo_ff",QOSDATA="qos_zte",CHARGINGDATA="charging_zte",TRAFFICCONTROLDATA="traffic_dnslbo"
配置用户模板与DPI规则绑定。|7|配置规则（基于域名分流时配置）|ADD RULEBINDUP:UPNAME="prerule",RULENAME="dnsrule",PRECEDENCE=0
8|激活DPI规则|DPI RULE REFRESH|激活DPI规则
##### PCF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD PKGINFO|套餐标识|10000|对端协商|10000|校园网专用套餐标识，PCF和SPR(PUDR)保持一致。
全局优先级|ADD PKGINFO|50|本端规划|50|-
套餐名称|ADD PKGINFO|xxxxstu|对端协商|xxxxstu|校园网专用套餐名称，PCF和SPR(PUDR)保持一致。
套餐属性|ADD PKGINFO|业务套餐|本端规划|业务套餐|-
ADD PKGSVC|套餐业务基本配置编号|10001|本端规划|10001|-
套餐标识|ADD PKGSVC|10000|已配置数据中获取|10000|该参数引用自ADD PKGINFO命令中的PKGID参数。
签约业务标识|ADD PKGSVC|10001|本端规划|10001|校园网专用套餐与业务ID关联，现场根据实际情况规划。
ADD PCEFEVENT|上报事件配置编号|100|本端规划|100|-
套餐标识|ADD PCEFEVENT|10000|已配置数据中获取|10000|该参数引用自ADD PKGINFO命令中的PKGID参数。
TAI改变|ADD PCEFEVENT|上报|本端规划|上报|-
服务区域改变|ADD PCEFEVENT|上报|本端规划|上报|-
ADD NUMABS|映射配置编号|10000|本端规划|10000|-
号码类型|ADD NUMABS|ULI_TAC|本端规划|ULI_TAC|-
起始号码|ADD NUMABS|00000001|本端规划|00000001|校园园区物理位置所对应的TACList，现场根据实际情况规划。
结束号码|ADD NUMABS|00000006|本端规划|00000006|校园园区物理位置所对应的TACList，现场根据实际情况规划。
映射标识|ADD NUMABS|10000|本端规划|10000|-
ADD APPSUBS|应用标识|10001|本端规划|10001|-
应用标识描述|ADD APPSUBS|xxxxstu_ULCL|本端规划|xxxxstu_ULCL|-
签约业务标识|ADD APPSUBS|10001|已配置数据中获取|10001|该参数引用自ADD PKGSVC命令中的SUBSID参数。
签约业务标识描述|ADD APPSUBS|xxxxstu_ULCL|本端规划|xxxxstu_ULCL|-
承载控制模式|ADD APPSUBS|UE_NW|本端规划|UE_NW|-
支持预下发|ADD APPSUBS|是|本端规划|是|-
PS数据黑白名单指示|ADD APPSUBS|白名单|本端规划|白名单|-
ADD DM COND|条件名称|10001|区域内|本端规划|-
业务键|ADD DM COND|SYS.GX_APP_ID|SYS.GX_ULI_TAC_ATTR_ID|本端规划|-
运算符|ADD DM COND|In|IfHave|本端规划|-
业务键值类型|ADD DM COND|值|值|本端规划|-
业务键值|ADD DM COND|10001|10000|已配置数据中获取|10001引用自ADD APPSUBS命令中的APPID参数。10000引用自ADD NUMABS命令中的ABSATTRID参数。
ADD DM ACTION|动作参数名称|xxxxstu_ULCL|本端规划|xxxxstu_ULCL|-
参数类型|ADD DM ACTION|N7 PCC规则参数集|本端规划|N7 PCC规则参数集|-
动作参数集|ADD DM ACTION|"SYS.N7_PCC_RULE_ID"-"0"-"prerule"|对端协商|"SYS.N7_PCC_RULE_ID"-"0"-"prerule"|PCF下发给SMF的ULCL分流预定义规则名，PCF和SMF需要保持一致。
"SYS.N7_PCC_RULE_TYPE"-"0"-"PRE_RULE"|动作参数集|"SYS.N7_PCC_RULE_TYPE"-"0"-"PRE_RULE"|ADD DM ACTION|本端规划|-
"SYS.N7_PCC_APPID"-"0"-"10001"|动作参数集|"SYS.N7_PCC_APPID"-"0"-"10001"|ADD DM ACTION|已配置数据中获取|该参数引用自ADD APPSUBS命令中的APPID参数。
ADD DM RULE|规则名称|xxxxstu_ULCL|本端规划|xxxxstu_ULCL|-
策略类型|ADD DM RULE|N7业务控制策略|本端规划|N7业务控制策略|-
规则优先级|ADD DM RULE|5|本端规划|5|-
条件表达式|ADD DM RULE|{10001}&{区域内}|已配置数据中获取|{10001}&{区域内}|该参数引用自ADD DM COND命令中的NAME参数。
动作类型|ADD DM RULE|PARAM|本端规划|PARAM|-
动作参数名称|ADD DM RULE|xxxxstu_ULCL|已配置数据中获取|xxxxstu_ULCL|该参数引用自ADD DM ACTION命令中的NAME参数。
日志开关|ADD DM RULE|关闭|本端规划|关闭|-
规则编号|ADD DM RULE|0|本端规划|0|-
ADD DM ROLE|场景名称|xxxxstu_ULCL|本端规划|xxxxstu_ULCL|-
场景入口|ADD DM ROLE|"SYS.SERV_PAK_ID"-"10000"|已配置数据中获取|"SYS.SERV_PAK_ID"-"10000"|该参数引用自ADD PKGINFO命令中的PKGID参数。
规则名称|ADD DM ROLE|xxxxstu_ULCL|已配置数据中获取|xxxxstu_ULCL|该参数引用自ADD DM RULE命令中的NAME参数。
使能开关|ADD DM ROLE|生效|本端规划|生效|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|增加套餐，PKGID和SPR(PUDR)保持一致。|ADD PKGINFO:PKGID="10000",PRIORITY=50,PKGNAME="xxxxstu",PKGATTR="SERVICE_PKG"
2|套餐关联业务ID，现场根据实际情况规划PKGSVCID和SUBSID。|ADD PKGSVC:ID=10001,PKGID="10000",SUBSID="10001"
3|套餐订阅TAI和SAREACH事件上报，现场根据实际情况规划PCEFEVENT ID。|ADD PCEFEVENT:ID=100,PKGID="10000",TAICHGRPT="YES",SAREACH="YES"
4|增加园区位置信息，位置、ID根据现场实际情况修改。|ADD NUMABS:ID=10000,SVCKEY="ULI_TAC",BEGINVALUE="00000001",ENDVALUE="00000006",ABSATTRID=10000
5|增加内部应用标识。|ADD APPSUBS:APPID=10001,APPDESC="xxxxstu_ULCL",SUBSID="10001",SUBSDESC="xxxxstu_ULCL",BEARCTRMODE="UE_NW",PREPROV="YES",DATABWLSTIND="WHITELIST"
6|策略配置，增加条件。|ADD DM COND:NAME="10001",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="10001"ADD DM COND:NAME="区域内",SVCKEY="SYS.GX_ULI_TAC_ATTR_ID",OPERATOR=18,VALTYPE=0,VALUE="10000"
7|策略配置，增加动作。|ADD DM ACTION:NAME="xxxxstu_ULCL",TYPE=5,PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"prerule"&"SYS.N7_PCC_RULE_TYPE"-"0"-"PRE_RULE"&"SYS.N7_PCC_APPID"-"0"-"10001"
8|策略配置，增加分流规则。|ADD DM RULE:NAME="xxxxstu_ULCL",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=5,CONDEXP="{10001}&{区域内}",ACTTYPE="PARAM",ACTNAME="xxxxstu_ULCL",LOGFLAG="OFF",RULENO=0
9|策略配置，增加场景，入口场景设定为套餐。|ADD DM ROLE:NAME="xxxxstu_ULCL",ENTRANCE="SYS.SERV_PAK_ID"-"10000",RULENAME="xxxxstu_ULCL",VALIDFLAG="ENABLE"
#### 信令交互 
##### 用户在园区内激活会话，启动分流 
用户在园区触发PDU会话激活，SMF通过与PCF间的会话建立流程将用户信息以及用户的位置信息带给PCF，PCF根据这些信息下发分流预定义规则给SMF。SMF基于分流预定义规则以及用户位置信息选择分流UPF，同时创建到主锚点UPF的会话和到ULCL UPF/辅锚点UPF的分流会话，并下发分流策略给ULCL UPF/辅锚点UPF。ULCL UPF/辅锚点UPF执行分流策略，将用户数据报文分流至本地和Internet。端到端信令流程如[图1](8754685.html#Qy-0440B6F3__b1ec11cc-33d1-4d9e-be11-d84b4aee6aa7)所示。
图1  用户在园区内激活会话，启动分流流程
[]images/%E5%9F%BA%E4%BA%8E%E9%A2%84%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%811-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%88%86%E6%B5%81.png)
UE发起会话创建请求给AMF，携带DNN、TAI、S-NSSAI等信息。 
AMF发送Nsmf_PDUSession_CreateSMContext Request给SMF，携带DNN、TAI、S-NSSAI、PDU会话类型等信息，SMF回复Nsmf_PDUSession_CreateSMContext Response消息给AMF。 
SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，请求创建SM策略关联，消息中携带pduSessionId、pduSessionType、dnn、UE Location等信息。PCF根据用户标识查找出用户签约的业务数据，根据用户的会话信息进行策略判断，生成规则，通过Npcf_SMPolicyControl_Create Response消息发送给SMF，消息中会包含PCC RULE以及PCF要求订阅的一些事件（当这些事件发生以及位置变更时，需要SMF发送Npcf_SMPolicyControl_Update Request消息通知PCF），并携带分流预定义规则。 
SMF根据获取到的DNN、S-NSSAI、PDU会话类型以及UPF的接口能力选出主锚点UPF，即PSA0。根据TAI、UPF的接口能力选出ULCL UPF，根据预定义分流规则和DNAI的绑定关系选出辅锚点UPF（PSA1），此处选出的ULCL UPF和PSA1 UPF合一部署。 
SMF向PSA0 UPF发起PFCP会话建立请求，携带给PSA0 UPF分配的上、下行PDR信息、分配的用户IP地址。会话创建成功后，PSA0 UPF会通过PFCP Session Establishment Response消息向SMF返回N9上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发起PFCP会话建立请求，携带相应的规则，包含用于指示ULCL UPF对数据包进行分流的分流规则名和对应的Aplication ID以及数据转发规则FAR。ULCL UPF/PSA1 UPF收到请求后给SMF回复相应的Response消息，携带其分配给(R)AN侧的N3上行隧道信息以及分配给PSA0 UPF的N9下行隧道信息。
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带第5步中ULCL UPF分配的N9下行隧道信息，并更新PSA0 UPF的下行FAR。PSA0 UPF在返回的响应消息中携带给ULCL UPF分配的N9上行隧道信息。 
SMF向AMF发起Namf_Communication_N1N2MessageTransfer流程，携带N2 SM Information给AMF，里面包含ULCL UPF分配的N3上行隧道信息（用于通知(R)AN侧将N3隧道的上行对端隧道信息更新至ULCL UPF），网络侧给UE分配的IP地址Allocated IPv4 Address。AMF向SMF回复响应消息。 
本步骤由如下子步骤组成： 
9a. AMF向(R)AN发送PDU Session Resource Setup Request，请求中包含N3上行隧道信息、网络侧给UE分配的Allocated IPv4 Address。 
9b. (R)AN与UE发起信令交互，将PDU Session ID、Allocated IPv4 Address等转发至UE，请求UE建立PDU会话。 
9c. (R)AN向AMF发送PDU Session Resource Setup Response消息，携带给ULCL UPF分配的N3下行隧道信息AN Tunnel Info等。 
SMF和AMF通过Nsmf_PDUSession_UpdateSMContext消息交互获取AN Tunnel Info等信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Modification Request，将(R)AN侧N3隧道下行隧道信息发送给ULCL UPF/PSA1 UPF，ULCL UPF/PSA1 UPF回复PFCP Session Modification Response消息给SMF。 
##### 用户在园区内激活会话，移动到园区外 
用户在园区内访问本地业务，已激活包含ULCL分流会话的PDU会话。用户从园区内移动到园区外，SMF将用户位置信息上报给PCF。PCF根据用户位置变化更新用户策略，删除分流规则，触发删除分流会话的流程。端到端信令流程如[图1](0605693.html#Qy-0440B6F3__f44a0955-a56e-466d-a8d6-6901d6df8e37)所示。
图1  用户在园区内激活会话，移动到园区外
[]images/%E5%9F%BA%E4%BA%8E%E9%A2%84%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%812-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%9B%AD%E5%8C%BA%E5%A4%96.png)
UE在园区内已激活PDU会话，创建了到PSA0 UPF和ULCL UPF/PSA1 UPF的会话。 
UE从园区内移动至园区外，(R)AN发起基于Xn接口的切换，向AMF发送N2 Path Swtich Request。 
AMF给SMF发送Nsmf_PDUSession_UpdateSmContext Request消息，携带UE Location信息，包含用户最新的位置信息（如当前所处位置的TAI）。 
SMF向PCF发起Npcf_SMPolicyControl_Update流程，携带用户IMSI信息及UE Location给PCF，PCF根据用户信息判断需要删除分流业务，通过响应消息通知SMF删除分流预定义规则。 
SMF根据新策略重选UPF，判定无需分流功能，发起删除分流会话流程。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带上行PDR给PSA0 UPF，指示上行报文从N3口进入，从N6口发出。PSA0 UPF返回响应消息，携带上行N3隧道信息，同时修改下行PDR关联的FAR，将下行隧道信息更新为(R)AN的IP地址信息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带新的N3上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Deletion Request消息，请求删除分流会话。ULCL UPF/PSA1 UPF收到请求后回应Response消息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，删除为分流业务安装的N9上行PDR。 
更新(R)AN侧的隧道信息。 
##### 用户在园区外激活会话，移动到园区内 
用户在园区外访问Internet，已激活PDU会话。用户从园区外移动至园区内，SMF感知到UE位置区变化，触发N7会话更新流程，将用户信息以及用户位置信息带给PCF，PCF根据这些信息下发分流预定义规则给SMF。SMF基于分流预定义规则以及用户位置信息选择分流UPF，创建分流会话并将分流会话插入到用户的PDU会话中，下发分流策略给分流UPF。端到端信令交互如[图1](2647034.html#Qy-0440B6F3__b8d6cf9f-7369-471f-9d9f-109d6b6ee674)所示。
图1  用户在园区外激活会话，移至园区内
[]images/%E5%9F%BA%E4%BA%8E%E9%A2%84%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%813-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%A4%96%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E7%A7%BB%E8%87%B3%E5%9B%AD%E5%8C%BA%E5%86%85.png)
UE已在园区外建立会话。 
UE位置发生改变，从园区外移动至园区内，触发基于Xn接口的切换流程。(R)AN向AMF发送N2 Path Swtich Request消息。 
AMF给SMF发送Nsmf_UpdateSmContext Request消息，携带UE Location信息（包含用户最新的位置信息，如当前所处位置的TAI），携带N2 Container（N2 Path Swtich Request）。 
SMF向PCF发起Npcf_SMPolicyControl_Update流程，携带用户IMSI信息及UE Location给PCF，PCF根据用户信息判断用户需要分流，通过响应消息将分流预定义规则发送给SMF。 
SMF根据新策略及分流业务和DNAI的绑定关系选择ULCL UPF/PSA1 UPF，建立分流会话。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带给PSA0 UPF分配的上行PDR。PSA0 UPF返回响应消息，携带N9a上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Establishment Request消息，携带上、下行PDR、分流规则名和规则对应的Application ID。ULCL UPF/PSA1 UPF收到请求后返回Response消息，携带分配给(R)AN的N3上行隧道信息以及分配给PSA0 UPF的N9c下行隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，通知PSA0 UPF修改下行PDR关联的FAR，更新N9隧道下行隧道信息（指向ULCL UPF的N9c口）。PSA0 UPF返回响应消息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带N2 Container（N2 Path Swtich Ack），将新的N3上行隧道信息告知(R)AN。 
AMF向(R)AN发送N2 Path Swtich Ack，更新N3隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request，删除用户初始激活时创建的N3上行PDR。 
### 基于动态规则的前向分流 
#### 场景描述 
基于动态规则的前向分流的场景描述与基于预定义规则的前向分流的[场景描述](0792243.html)基本相同，区别为：第三步PCF向SMF下发的是动态规则。
在该部署场景下，细分三种业务应用场景，具体信令交互流程参见[信令交互](1656467845634PUYtqo.html)。
#### 功能配置 
##### 动态规则配置架构 
在基于动态规则的分流配置过程中，PCF、SMF和UPF相关配置及关联关系如[图1](1656467845624hOHTrz.html#Qy-0440B6F3__28081349-b1e9-4150-93c8-c852c49e781e)所示。
图1  动态规则配置架构
[]images/1659411938710.png)
##### SMF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|企业专用DNN
是否真实APNDNN|ADD APNDNN|是|全网规划|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|-
ADD APNDNNPROFILE|模板名称|abc.com||-
ADD MAPAPNDNNPROFILE|APN/DNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
Access|ADD MAPAPNDNNPROFILE|打开|本端规划|
模板名称|ADD MAPAPNDNNPROFILE|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数。
SET APNDNNBASIC|模板名称|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数，并通过ADD MAPAPNDNNPROFILE命令把APN基础功能模板绑定在APN/DNN下。
ULCL/BP开关|SET APNDNNBASIC|打开|本端规划|-
SET PCCFUNCPROFILE|PCC 功能模板名|abc.com|本端规划|-
规则分流功能方式|SET PCCFUNCPROFILE|动态规则分流|本端规划|-
分流方式|SET PCCFUNCPROFILE|SMF决策分流|本段规划|-
ADD UGROUP|GW-U组名称|UGroup1|本端规划|-
ADD UGROUPDNN|GW-U组名称|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
DNN|ADD UGROUPDNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
ADD UPNODE|GW-U节点名称|UPF_local|本端规划|负责分流的UPF名称。
GW-U节点对应的组|ADD UPNODE|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
接口类型|ADD UPNODE|IPV4|本端规划|-
GW-U节点网管口端口号|ADD UPNODE|7778|本端规划|-
ADD UPNODEID|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
Node ID类型|ADD UPNODEID|IPv4|本端规划|-
Node ID IPv4取值|ADD UPNODEID|193.168.34.16|本端规划|-
是否闭塞|ADD UPNODEID|否|本端规划|-
C面是否主动发起建链|ADD UPNODEID|是|本端规划|-
ADD UPSXINTERFACEIP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型优先级|ADD UPSXINTERFACEIP|IPv4|本端规划|-
IPv4地址|ADD UPSXINTERFACEIP|193.168.34.16|本端规划|-
IPv6地址|ADD UPSXINTERFACEIP|10::1|本端规划|-
端口|ADD UPSXINTERFACEIP|8805|本端规划|-
IPv4地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
IPv6地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
ADD UPATTRIBUTE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
SGW-U|ADD UPATTRIBUTE|是|对端协商|-
PGW-U|ADD UPATTRIBUTE|是|对端协商|-
UPF-N3|ADD UPATTRIBUTE|是|对端协商|-
UPF-N6|ADD UPATTRIBUTE|是|对端协商|-
UPF-N9|ADD UPATTRIBUTE|是|对端协商|-
SGW-S8|ADD UPATTRIBUTE|否|对端协商|-
PGW-S8|ADD UPATTRIBUTE|否|对端协商|-
ADD UPPDUSESSIONTYPE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型|ADD UPPDUSESSIONTYPE|IPv4v6|本端规划|-
ADD UPWEIGHT|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
权重|ADD UPWEIGHT|100|本端规划|-
ADD UPDNAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
DNAI|ADD UPDNAI|dnai_abc|对端协商|用于关联支撑企业分流业务的辅锚点UPF。说明：如果本UPF没有被其他会话选为主锚点UPF，本参数不能配置为“*”。
ADD UPSNSSAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
切片服务类型|ADD UPSNSSAI|1-eMBB|对端协商|-
切片区分|ADD UPSNSSAI|010101|对端协商|-
ADD TACGROUP|TAC组名称|TAClist|本端规划|企业园区物理位置所对应的TACList。
TAC类型|ADD TACGROUP|TACNR|本端规划|-
ADD TACNRSECTION|段名称|TAC1|本端规划|-
START(十六进制)|ADD TACNRSECTION|0x000001|本端规划|-
END(十六进制)|ADD TACNRSECTION|0x000006|本端规划|-
TACNR组名称|ADD TACNRSECTION|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD UPTACNRGROUP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
TACNR组名称|ADD UPTACNRGROUP|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD TACRANGEMAPPINGDNAI|段名称|TAC1|已配置数据中获取|该参数引用自ADD TACNRSECTION命令中的SECNAME参数。
START(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000001|全局规划|-
END(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000006|全局规划|-
DNAI1|ADD TACRANGEMAPPINGDNAI|dnai_abc|对端协商|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|增加DNN，并开启ULCL分流。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="cmnet"ADD APNDNNPROFILE:NAME="abc.com"ADD MAPAPNDNNPROFILE:APNDNN="abc.com",ACCESS="ENABLE",NAME="abc.com"SET APNDNNBASIC:NAME="abc.com",ULCLBPSWITCH=ENABLE
2|设置规则分流功能方式为动态规则分流。|SET PCCFUNCPROFILE:PROFILENAME="abc.com",RULESTEERINGMETHOD="DYNAMICRULE",STEERINGMODE="SMFSTEERING"
3|新增分流UPF。|ADD UGROUP:GName="UGroup1"ADD UGROUPDNN:GName="UGroup1", DNN="abc.com"ADD UPNODEID:UPNAME="UPF_local",NODEIDTYPE="IPV4",NODEIDIPV4VAL=193.168.34.16,ISBLOCK="false",ISACTIVEMAKEASSOC="true"ADD UPNODE:UPNAME="UPF_local",GNAME="UGroup1",MGRIPTYPE="IPV4",MGRPORT=7778ADD UPSXINTERFACEIP:UPNAME="UPF_local",IPV4ADDR=193.168.34.16,IPV6ADDR="10::1",IPPRIO="IPV4",PORT=8805,IPV4VRFID=1,IPV6VRFID=1ADD UPATTRIBUTE:UPNAME="UPF_local",SGWUFUNC="true",PGWUFUNC="true",UPFN3="true",UPFN6="true",UPFN9="true",SGW_S8="false",PGW_S8="false"
4|配置分流UPF接口类型。|ADD UPPDUSESSIONTYPE:UPNAME="UPF_local",PDUSESSIONTYPE="IPV4V6"
5|配置UPF权重。|ADD UPWEIGHT:UPNAME="UPF_local",WEIGHT=100
6|配置UPF和DNAI关联。|ADD UPDNAI:UPNAME="UPF_local",DNAI="dnai_abc"
7|配置UPF和切片关联。|ADD UPSNSSAI:UPNAME="UPF_local",SST="EMBB",SD="010101"
8|配置UPF和TAC关联。|ADD TACGROUP:TACGROUPNAME="TAClist",TYPE="TACNR"ADD TACNRSECTION:SECNAME="TAC1",STARTTACNR="0x000001",ENDTACNR="0x000006",TACGROUPNAME="TAClist"ADD UPTACNRGROUP:UPNAME="UPF_local",TACGROUPNAME="TAClist"
9|配置TAC和DNAI关联。|ADD TACRANGEMAPPINGDNAI:SECNAME="TAC1",STARTTAC="0x000001",ENDTAC="0x000006",DNAI1="dnai_abc"
##### UPF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|abc.com|企业专用DNN。
是否真实APNDNN|ADD APNDNN|是|全网规划|是|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|abc.com|-
ADD DNCFG|APN/DNN|abc.com|全网规划|abc.com|-
网络实例|ADD DNCFG|N6|全网规划|N6|-
ADD DPIUPCONFIG|DPI模板配置名|nourlprofile|本端规划|nourlprofile|-
信令计费模式|ADD DPIUPCONFIG|信令归业务（默认值）|本端规划|信令归业务（默认值）|-
还原识别开关|ADD DPIUPCONFIG|DISABLE（默认值）|本端规划|DISABLE（默认值）|-
ADD USERPROFILE|用户模板名称|up_zte|本端规划|up_zte|-
用户模板类型|ADD USERPROFILE|动态规则|本端规划|动态规则|-
优先级|ADD USERPROFILE|4294967295（默认值）|本端规划|4294967295（默认值）|-
DPI模板配置|ADD USERPROFILE|nourlprofile|已配置数据中获取|nourlprofile|该参数引用自ADD DPIUPCONFIG命令中的NAME参数。
ADD URRMAP|URR ID|10000|20000|对端协商|与SMF对齐。
URR类型|ADD URRMAP|离线计费业务|在线计费业务|对端协商|与OCS对齐。
业务标识|ADD URRMAP|1|0|对端协商|与OCS对齐。
费率组|ADD URRMAP|1|1|对端协商|与OCS对齐。
ADD CHARGINGDATA|计费策略名称|charging_zte|本端规划|charging_zte|-
离线URR标识|ADD CHARGINGDATA|10000|已配置数据中获取|10000|该参数引用自ADD URRMAP命令中的URRID参数。
在线URR标识|ADD CHARGINGDATA|20000|已配置数据中获取|20000|该参数引用自ADD URRMAP命令中的URRID参数。
免费|ADD CHARGINGDATA|FALSE（默认值）|本端规划|FALSE（默认值）|-
首包策略|ADD CHARGINGDATA|PASS|本端规划|PASS|-
首包配额|ADD CHARGINGDATA|2000000|本端规划|2000000|-
生成内容计费容器|ADD CHARGINGDATA|ENABLE（默认值）|本端规划|ENABLE（默认值）|-
ADD FORWARDPOLICY|转发策略名|ULCL_LY1|对端协商|ULCL_LY1|该参数需要与PCF中ADD DM ACTION命令配置的TC_ROUTE_TO_LOCATION的名称一致。
虚拟接口模板ID|ADD FORWARDPOLICY|10|本端规划|10|-
ADD L34FILTER|L34过滤器名称|l34_v4|本端规划|l34_v4|-
IP地址类型|ADD L34FILTER|IPV4|本端规划|IPV4|-
IPv4服务端IP地址|ADD L34FILTER|192.168.1.0|本端规划|192.168.1.0|园区服务器IP地址。
IPv4服务端IP地址掩码|ADD L34FILTER|24|本端规划|24|园区服务器IP地址。
三四层协议类型|ADD L34FILTER|ANY|本端规划|ANY|-
ADD L34FILTERGROUP|三四层过滤规则组名|l34_g|本端规划|l34_g|-
三四层过滤器名|ADD L34FILTERGROUP|l34_v4|已配置数据中获取|l34_v4|该参数引用自ADD L34FILTER命令中的FILTERNAME参数。
ADD FLOWFILTER|流过滤器名称|l34_ff|本端规划|l34_ff|-
L34过滤规则组名|ADD FLOWFILTER|l34_g|已配置数据中获取|l34_g|该参数引用自ADD L34FILTERGROUP命令中的GROUPNAME参数。
ADD RULE|规则名称|iprule|本端规划|iprule|-
应用标识|ADD RULE|20001|对端协商|20001|该参数需要与PCF中ADD APPSUBS命令的APPID参数配置一致。
流过滤器|ADD RULE|l34_ff|已配置数据中获取|l34_ff|该参数引用自ADD FLOWFILTER命令中的FLOWFILTERNAME参数。
ADD RULEBINDUP|用户模板|up_zte|已配置数据中获取|up_zte|该参数引用自ADD USERPROFILE命令中的NAME参数。
规则名|ADD RULEBINDUP|iprule|已配置数据中获取|iprule|该参数引用自ADD RULE命令中的NAME参数。
优先级|ADD RULEBINDUP|0|本端规划|0|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|配置用户模板|配置APNDNN。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="abc.com"
配置DNN。|1|配置用户模板|ADD DNCFG:DNN="abc.com",NETWORKINSTANCE="N6"
配置DPI模板。|1|配置用户模板|ADD DPIUPCONFIG:NAME="nourlprofile",ACCOUNTMODE="SERVICE",URLRERECOG="DISABLE"
配置用户模板，并将用户模板与DPI模板关联。|1|配置用户模板|ADD USERPROFILE:NAME="up_zte",USERPROFILETYPE="DYNAMIC_RULE",PRECEDENCE=4294967295,DPIUPCONFIG="nourlprofile"
2|配置计费和QoS策略|新增URR配置，UPF网元在报文匹配时会读取不同规则下对应的URR ID，从而进行相关功能的用量累计和上报。|ADD URRMAP:URRID=10000,TYPE="OFFLINECHARGESERVICE",SERVICEID=1,RATINGGROUP=1ADD URRMAP:URRID=20000,TYPE="ONLINECHARGESERVICE",SERVICEID=0,RATINGGROUP=1
3|配置策略路由的转发策略|配置转发策略，关联虚拟接口模板，从而关联到ROSNG的路由策略。|ADD FORWARDPOLICY:NAME="ULCL_LY1",VIRTUALTEMPLATEID=10
4|配置三四层流过滤器（基于IP地址分流时配置）|配置三四层过滤规则。|ADD L34FILTER:FILTERNAME="l34_v4",IPTYPE="IPV4",IPV4SERVERIP="192.168.1.0",IPV4SERVERIPMASK=24,PROTOCOL="ANY"
配置三四层过滤规则组，关联配置的三四层过滤规则。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD L34FILTERGROUP:GROUPNAME="l34_g",L34FILTERNAME="l34_v4"
配置流过滤器，关联配置的三四层过滤器组，实现对用户报文的特定过滤。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD FLOWFILTER:FLOWFILTERNAME="l34_ff",L34FILTERGROUPNAME="l34_g"
5|配置规则（基于IP地址分流时配置）|配置DPI规则，关联流过滤器、QoS策略、计费策略等，根据这些规则识别满足条件的业务报文，进行不同的计费和控制。|ADD RULE:NAME="iprule",APPLICATION="20001",FLOWFILTER="l34_ff",QOSDATA="qos_zte",CHARGINGDATA="charging_zte",TRAFFICCONTROLDATA="traffic_zte"
配置用户模板与DPI规则绑定。|5|配置规则（基于IP地址分流时配置）|ADD RULEBINDUP:UPNAME="up_zte",RULENAME="iprule",PRECEDENCE=0
8|激活DPI规则|DPI RULE REFRESH|激活DPI规则
##### PCF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD PKGINFO|套餐标识|20000|对端协商|20000|校园网专用套餐标识，PCF和SPR(PUDR)保持一致。
全局优先级|ADD PKGINFO|50|本端规划|50|-
套餐名称|ADD PKGINFO|xxxxstu_ULCL_dy|对端协商|xxxxstu_ULCL_dy|校园网专用套餐名称，PCF和SPR(PUDR)保持一致。
套餐属性|ADD PKGINFO|业务套餐|本端规划|业务套餐|-
ADD PKGSVC|套餐业务基本配置编号|20001|本端规划|20001|-
套餐标识|ADD PKGSVC|20000|已配置数据中获取|20000|该参数引用自ADD PKGINFO命令中的PKGID参数。
签约业务标识|ADD PKGSVC|20001|本端规划|20001|校园网专用套餐与业务ID关联，现场根据实际情况规划。
ADD PCEFEVENT|上报事件配置编号|200|本端规划|200|-
套餐标识|ADD PCEFEVENT|20000|已配置数据中获取|20000|该参数引用自ADD PKGINFO命令中的PKGID参数。
TAI改变|ADD PCEFEVENT|上报|本端规划|上报|-
服务区域改变|ADD PCEFEVENT|上报|本端规划|上报|-
ADD NUMABS|映射配置编号|20000|本端规划|20000|-
号码类型|ADD NUMABS|ULI_TAC|本端规划|ULI_TAC|-
起始号码|ADD NUMABS|00000001|本端规划|00000001|校园园区物理位置所对应的TACList，现场根据实际情况规划。
结束号码|ADD NUMABS|00000006|本端规划|00000006|校园园区物理位置所对应的TACList，现场根据实际情况规划。
映射标识|ADD NUMABS|20000|本端规划|20000|-
ADD APPSUBS|应用标识|20001|本端规划|20001|-
应用标识描述|ADD APPSUBS|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
签约业务标识|ADD APPSUBS|20001|已配置数据中获取|20001|该参数引用自ADD PKGSVC命令中的SUBSID参数。
签约业务标识描述|ADD APPSUBS|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
承载控制模式|ADD APPSUBS|UE_NW|本端规划|UE_NW|-
支持预下发|ADD APPSUBS|是|本端规划|是|-
PS数据黑白名单指示|ADD APPSUBS|白名单|本端规划|白名单|-
ADD SVCFLOWCHR|业务特征流配置编号|20001|本端规划|20001|-
服务器IP地址|ADD SVCFLOWCHR|0.0.0.0|对端协商|0.0.0.0|-
掩码|ADD SVCFLOWCHR|0.0.0.0|对端协商|0.0.0.0|-
服务器最大/小端口|ADD SVCFLOWCHR|0|对端协商|0|-
方向|ADD SVCFLOWCHR|双向|对端协商|双向|-
应用标识|ADD SVCFLOWCHR|20001|本端规划|20001|-
ADD DM COND|条件名称|20001|区域内|本端规划|-
业务键|ADD DM COND|SYS.GX_APP_ID|SYS.GX_ULI_TAC_ATTR_ID|本端规划|-
运算符|ADD DM COND|In|IfHave|本端规划|-
业务键值类型|ADD DM COND|值|值|本端规划|-
业务键值|ADD DM COND|20001|20000|本端规划|-
ADD DM ACTION|动作参数名称|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
参数类型|ADD DM ACTION|N7 PCC规则参数集|本端规划|N7 PCC规则参数集|-
动作参数集|ADD DM ACTION|"SYS.N7_PCC_RULE_ID"-"0"-"ULCL_DY_N7PCCRULE"|对端协商|"SYS.N7_PCC_RULE_ID"-"0"-"ULCL_DY_N7PCCRULE"|PCF下发给SMF的ULCL分流动态规则，SMF需要执行该规则。
"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"|动作参数集|"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"|ADD DM ACTION|本端规划|-
"SYS.N7_PCC_APPID"-"0"-"20001"|动作参数集|"SYS.N7_PCC_APPID"-"0"-"20001"|ADD DM ACTION|本端规划|适用于只下发APPID的场景。
"SYS.N7_PCC_QoS_ID"-"0"-"ULCL_QOS1"|动作参数集|"SYS.N7_PCC_QoS_ID"-"0"-"ULCL_QOS1"|ADD DM ACTION|本端规划|-
"SYS.N7_PCC_TC_ID"-"0"-"ULCL_TC1"|动作参数集|"SYS.N7_PCC_TC_ID"-"0"-"ULCL_TC1"|ADD DM ACTION|本端规划|-
ADD DM ACTION|动作参数名称|ULCL_QOS1|本端规划|ULCL_QOS1|-
参数类型|ADD DM ACTION|QoS参数集|本端规划|QoS参数集|-
动作参数集|ADD DM ACTION|"SYS.QOS_ID"-"0"-"ULCL_QOS1"|本端规划|"SYS.QOS_ID"-"0"-"ULCL_QOS1"|-
"SYS.QOS_5QI"-"0"-"5"|动作参数集|"SYS.QOS_5QI"-"0"-"5"|ADD DM ACTION|全网规划|5QI值需要全网规划。
"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"|动作参数集|"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"|ADD DM ACTION|全网规划|ARP优先级需要全网规划。
"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"|动作参数集|"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"|ADD DM ACTION|全网规划|抢占能力需要全网规划。
"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE"|动作参数集|"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE"|ADD DM ACTION|全网规划|被抢占能力需要全网规划。
ADD DM ACTION|动作参数名称|ULCL_TC1|本端规划|ULCL_TC1|-
参数类型|ADD DM ACTION|TC参数集|本端规划|TC参数集|-
动作参数集|ADD DM ACTION|"SYS.TC_ID"-"0"-"ULCL_TC1"|本端规划|"SYS.TC_ID"-"0"-"ULCL_TC1"|-
"SYS.TC_ROUTE_TO_LOCATION"-"0"-"ULCL_LY1"|动作参数集|"SYS.TC_ROUTE_TO_LOCATION"-"0"-"ULCL_LY1"|ADD DM ACTION|本端规划|-
ADD DM ACTION|动作参数名称|ULCL_LY1|本端规划|ULCL_LY1|-
参数类型|ADD DM ACTION|路由目的地参数集|本端规划|路由目的地参数集|-
动作参数集|ADD DM ACTION|"SYS.DNAI"-"0"-"dnai_abc"|对端协商|"SYS.DNAI"-"0"-"dnai_abc"|DNAI需要与对端协商。
ADD DM RULE|规则名称|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
策略类型|ADD DM RULE|N7业务控制策略|本端规划|N7业务控制策略|-
规则优先级|ADD DM RULE|5|本端规划|5|-
条件表达式|ADD DM RULE|{20001}&{区域内}|本端规划|{20001}&{区域内}|-
动作类型|ADD DM RULE|PARAM|本端规划|PARAM|-
动作参数名称|ADD DM RULE|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
日志开关|ADD DM RULE|关闭|本端规划|关闭|-
规则编号|ADD DM RULE|0|本端规划|0|-
ADD DM ROLE|场景名称|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
场景入口|ADD DM ROLE|"SYS.SERV_PAK_ID"-"20000"|本端规划|"SYS.SERV_PAK_ID"-"20000"|-
规则名称|ADD DM ROLE|xxxxstu_ULCL_dy|本端规划|xxxxstu_ULCL_dy|-
使能开关|ADD DM ROLE|生效|本端规划|生效|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|增加套餐，PKGID和SPR(PUDR)保持一致。|ADD PKGINFO:PKGID="20000",PRIORITY=50,PKGNAME="xxxxstu_ULCL_dy",PKGATTR="SERVICE_PKG"
2|套餐关联业务ID，现场根据实际情况规划PKGSVCID和SUBSID。|ADD PKGSVC:ID=20001,PKGID="20000",SUBSID="20001"
3|套餐订阅TAI和SAREACH事件上报，现场根据实际情况规划PCEFEVENT ID。|ADD PCEFEVENT:ID=200,PKGID="20000",TAICHGRPT="YES",SAREACH="YES"
4|增加园区位置信息，位置、ID根据现场实际情况修改。|ADD NUMABS:ID=20000,SVCKEY="ULI_TAC",BEGINVALUE="00000001",ENDVALUE="00000006",ABSATTRID=20000
5|增加内部应用标识。|ADD APPSUBS:APPID=20001,APPDESC="xxxxstu_ULCL_dy",SUBSID="20001",SUBSDESC="xxxxstu_ULCL_dy",BEARCTRMODE="UE_NW",PREPROV="YES",DATABWLSTIND="WHITELIST"
6|增加业务流特征。|ADD SVCFLOWCHR:ID=20001,SERVERIPADDR="0.0.0.0",MASK="0.0.0.0",SERVERPORT=0,APPID=20001
7|策略配置，增加条件。|ADD DM COND:NAME="20001",SVCKEY="SYS.GX_APP_ID",OPERATOR=1,VALTYPE=0,VALUE="20001"ADD DM COND:NAME="区域内",SVCKEY="SYS.GX_ULI_TAC_ATTR_ID",OPERATOR=18,VALTYPE=0,VALUE="20000"
8|策略配置，增加动作（路由目的地参数集）。|ADD DM ACTION:NAME="ULCL_LY1",TYPE="ROUTE_PARASET",PARAMS="SYS.DNAI"-"0"-"dnai_abc"
9|策略配置，增加动作（TC参数集）。|ADD DM ACTION:NAME="ULCL_TC1",TYPE="TC_PARASET",PARAMS="SYS.TC_ID"-"0"-"ULCL_TC1"&"SYS.TC_ROUTE_TO_LOCATION"-"0"-"ULCL_LY1"
10|策略配置，增加动作（QoS参数集）。|ADD DM ACTION:NAME="ULCL_QOS1",TYPE="QOS_PARASET",PARAMS="SYS.QOS_ID"-"0"-"ULCL_QOS1"&"SYS.QOS_5QI"-"0"-"5"&"SYS.QOS_ARP_PRIORITY_LEVEL"-"0"-"1"&"SYS.QOS_ARP_PREEMPTION_CAP"-"0"-"MAY_PREEMPT"&"SYS.QOS_ARP_PREEMPTION_VULN"-"0"-"NOT_PREEMPTABLE"
11|策略配置，增加动作（N7 PCC规则参数集）。|ADD DM ACTION:NAME="xxxxstu_ULCL_dy",TYPE="N7PCCRULE_PARASET",PARAMS="SYS.N7_PCC_RULE_ID"-"0"-"ULCL_DY_N7PCCRULE"&"SYS.N7_PCC_RULE_TYPE"-"0"-"DYNA_RULE"&"SYS.N7_PCC_QoS_ID"-"0"-"ULCL_QOS1"&"SYS.N7_PCC_TC_ID"-"0"-"ULCL_TC1"
12|策略配置，增加分流规则。|ADD DM RULE:NAME="xxxxstu_ULCL_dy",PLCTYPE="DM_RULE_TYPE_N7_SERVICE",PRIOR=5,CONDEXP="{20001}&{区域内}",ACTTYPE="PARAM",ACTNAME="xxxxstu_ULCL_dy",LOGFLAG="OFF",RULENO=0
13|策略配置，增加场景，入口场景设定为套餐。|ADD DM ROLE:NAME="xxxxstu_ULCL_dy",ENTRANCE="SYS.SERV_PAK_ID"-"20000",RULENAME="xxxxstu_ULCL_dy",VALIDFLAG="ENABLE"
#### 信令交互 
##### 用户在园区内激活会话，启动分流 
用户在园区触发PDU会话激活，SMF通过与PCF间的会话建立流程将用户信息以及用户的位置信息带给PCF，PCF根据这些信息下发分流动态规则给SMF。SMF基于分流动态规则以及用户位置信息选择分流UPF，同时创建到主锚点UPF的会话和到ULCL UPF/辅锚点UPF的分流会话，并下发分流策略给ULCL UPF/辅锚点UPF。ULCL UPF/辅锚点UPF执行分流策略，将用户数据报文分流至本地和Internet。端到端信令流程如[图1](1656467845922yUSzzn.html#Qy-0440B6F3__c4ab0c7a-bfa9-4102-a520-9e0c593b446f)所示。
图1  用户在园区内激活会话，启动分流流程
[]images/%E5%9F%BA%E4%BA%8E%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%811-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%88%86%E6%B5%81.png)
UE发起会话创建请求给AMF，携带DNN、TAI、S-NSSAI等信息。 
AMF发送Nsmf_PDUSession_CreateSMContext Request给SMF，携带DNN、TAI、S-NSSAI、PDU会话类型等信息，SMF回复Nsmf_PDUSession_CreateSMContext Response消息给AMF。 
SMF向PCF发送Npcf_SMPolicyControl_Create Request消息，请求创建SM策略关联，消息中携带pduSessionId、pduSessionType、dnn、UE Location等信息。PCF根据用户标识查找出用户签约的业务数据，根据用户的会话信息进行策略判断，生成规则，通过Npcf_SMPolicyControl_Create Response消息发送给SMF，消息中会包含PCC Rule以及PCF要求订阅的一些事件（当这些事件发生以及位置变更时，需要SMF发送Npcf_SMPolicyControl_Update Request消息通知PCF），并携带分流动态规则。 
SMF根据获取到的DNN、S-NSSAI、PDU会话类型以及UPF的接口能力选出主锚点UPF，即PSA0。根据TAI、UPF的接口能力选出ULCL UPF，根据动态分流规则和DNAI的绑定关系选出辅锚点UPF（PSA1），此处选出的ULCL UPF和PSA1 UPF合一部署。 
SMF向PSA0 UPF发起PFCP会话建立请求，携带给PSA0 UPF分配的上、下行PDR信息、分配的用户IP地址。会话创建成功后，PSA0 UPF会通过PFCP Session Establishment Response消息向SMF返回N9上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发起PFCP会话建立请求，携带相应的规则，包含用于指示ULCL UPF对数据包进行分流的分流规则对应的Aplication ID以及数据转发规则FAR。ULCL UPF/PSA1 UPF收到请求后给SMF回复相应的Response消息，携带其分配给(R)AN侧的N3上行隧道信息以及分配给PSA0 UPF的N9下行隧道信息。
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带第5步中ULCL UPF分配的N9下行隧道信息，并更新PSA0 UPF的下行FAR。PSA0 UPF在返回的响应消息中携带给ULCL UPF分配的N9上行隧道信息。 
SMF向AMF发起Namf_Communication_N1N2MessageTransfer流程，携带N2 SM Information给AMF，里面包含ULCL UPF分配的N3上行隧道信息（用于通知(R)AN侧将N3隧道的上行对端隧道信息更新至ULCL UPF），网络侧给UE分配的IP地址Allocated IPv4 Address。 
本步骤由如下子步骤组成： 
9a. AMF向(R)AN发送PDU Session Resource Setup Request，请求中包含N3上行隧道信息、网络侧给UE分配的Allocated IPv4 Address。 
9b. (R)AN与UE发起信令交互，将PDU Session ID、Allocated IPv4 Address等转发至UE，请求UE建立PDU会话。 
9c. (R)AN向AMF发送PDU Session Resource Setup Response消息，携带给ULCL UPF分配的N3下行隧道信息AN Tunnel Info等。 
SMF和AMF通过Nsmf_PDUSession_UpdateSMContext消息交互获取AN Tunnel Info等信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Modification Request，将(R)AN侧N3隧道下行隧道信息发送给ULCL UPF/PSA1 UPF，ULCL UPF/PSA1 UPF回复PFCP Session Modification Response消息给SMF。 
##### 用户在园区内激活会话，移动到园区外 
用户在园区内访问本地业务，已激活包含ULCL分流会话的PDU会话。用户从园区内移动到园区外，SMF将用户位置信息上报给PCF。PCF根据用户位置变化更新用户策略，删除分流规则，触发删除分流会话的流程。端到端信令流程[图1](1656467845864PCUExF.html#Qy-0440B6F3__fce740b0-beef-4dab-a867-73e40790c948)所示。
图1  用户在园区内激活会话，移动到园区外流程
[]images/%E5%9F%BA%E4%BA%8E%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%812-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%9B%AD%E5%8C%BA%E5%A4%96.png)
UE在园区内已激活PDU会话，创建了到PSA0 UPF和ULCL UPF/PSA1 UPF的会话。 
UE从园区内移动至园区外，(R)AN发起基于Xn接口的切换，向AMF发送N2 Path Swtich Request。 
AMF给SMF发送Nsmf_PDUSession_UpdateSmContexts Request消息，携带UE Location信息，包含用户最新的位置信息（如当前所处位置的TAI）。 
SMF向PCF发起Npcf_SMPolicyControl_Update流程，携带用户IMSI信息及UE Location给PCF，PCF根据用户信息判断需要删除分流业务，通过响应消息通知SMF删除分流动态规则。 
SMF根据新策略重选UPF，判定无需分流功能，发起删除分流会话流程。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带上行PDR给PSA0 UPF，指示上行报文从N3口进入，从N6口发出。PSA0 UPF返回响应消息，携带上行N3隧道信息，同时修改下行PDR关联的FAR，将下行隧道信息更新为(R)AN的IP地址信息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带新的N3上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Deletion Request消息，请求删除分流会话。ULCL UPF/PSA1 UPF收到请求后回应Response消息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，删除分流时安装的N9上行PDR。 
更新(R)AN侧的隧道信息。 
##### 用户在园区外激活会话，移动到园区内 
用户在园区外访问Internet，已激活PDU会话。用户从园区外移动至园区内，SMF感知到UE位置区变化，触发N7会话更新流程，将用户信息以及用户位置信息带给PCF，PCF根据这些信息下发分流动态规则给SMF。SMF基于分流动态规则以及用户位置信息选择分流UPF，创建分流会话并将分流会话插入到用户的PDU会话中，并下发分流策略给分流UPF。端到端信令交互如[图1](1656467845864dt97io.html#Qy-0440B6F3__99196829-e5fe-4a8d-922d-6425d04f4741)所示。
图1  用户在园区内激活会话，移动到园区外
[]images/1659337267646.png)
UE已在园区外建立会话。 
UE位置发生改变，从园区外移动至园区内，触发基于Xn接口的切换流程。(R)AN向AMF发送N2 Path Swtich Request消息。 
AMF给SMF发送Nsmf_UpdateSmContext Request消息，携带UE Location信息（包含用户最新的位置信息，如当前所处位置的TAI），携带N2 Container（N2 Path Swtich Request）; 
SMF向PCF发起Npcf_SMPolicyControl_Update流程，携带用户IMSI信息及UE Location给PCF，PCF根据用户信息判断用户需要分流，通过响应消息将分流动态规则发送给SMF。 
SMF根据新策略及分流业务和DNAI的绑定关系选择ULCL UPF/PSA1 UPF，建立分流会话。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带给PSA0 UPF分配的上行PDR。PSA0 UPF返回响应消息，携带N9a上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Establishment Request消息，携带上、下行PDR、分流规则对应的Application ID。ULCL UPF/PSA1 UPF收到请求后返回Response消息，携带分配给(R)AN的N3上行隧道信息以及分配给PSA0 UPF的N9c下行隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，通知PSA0 UPF修改下行PDR关联的FAR，更新N9隧道下行隧道信息（指向ULCL UPF的N9c口）。PSA0 UPF返回响应消息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带N2 Container（N2 Path Swtich Ack），将新的N3上行隧道信息告知(R)AN。 
AMF向(R)AN发送N2 Path Swtich Ack，更新N3隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request，删除用户初始激活时创建的N3上行PDR。 
### 基于本地规则的前向分流 
#### 场景描述 
某企业用户向运营商申请签约了专用DNN，统一给员工发放企业终端，希望员工在企业园区范围内通过专用DNN访问企业内部数据，同时允许员工通过企业终端访问Internet。运营商在针对该企业用户放号时，会在SIM卡中内置专用DNN。 
当企业用户访问普通Internet业务时，基于专用DNN激活PDU会话，网络侧为用户创建“UE→(R)AN→主锚点UPF→Internet”的数据通路。 
当用户访问企业业务时，基于专用DNN激活PDU会话，网络侧为用户创建“UE→(R)AN→ULCL/辅锚点合一UPF→主锚点UPF→Internet”和“UE→(R)AN→ULCL/辅锚点合一 UPF→本地DN”的数据通路。 
图1  基于SMF本地规则的分流
[]images/1659344872988.png)
详细流程如下： 
SMF本地完成基于专用DNN的分流策略配置，并使能该专用DNN的ULCL属性。 
UE需要访问企业本地业务，基于专用DNN发起PDU激活流程。 
SMF基于用户当前所处的位置以及专用DNN选择ULCL UPF和PSA1 UPF，选择结果是ULCL/辅锚点合一 UPF。 
SMF辅助创建分流会话，在分流会话创建过程中，SMF将分流策略（Application ID）下发给ULCL UPF，最终建立“UE→(R)AN→ULCL UPF/辅锚点UPF→主锚点UPF>Internet”和“UE→(R)AN→ULCL UPF/辅锚点UPF→本地DN”的数据通路。 
UE访问Internet/企业本地业务。 
ULCL UPF执行分流策略，将访问Internet的数据流分流至主锚点UPF，经N6口发送至Internet，将访问企业本地业务的数据分流至ULCL UPF/辅锚点UPF，经N6口发送至本地DN。 
#### 功能配置 
##### 本地规则配置架构 
在基于本地规则的分流配置过程中，PCF、SMF和UPF相关配置及关联关系如[图1](0894839.html#Qy-0440B6F3__88087ee4-f677-4fe9-b08d-4146ab4b0fa3)所示。
图1  本地规则配置架构
[]images/1658453693249.png)
##### SMF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|企业专用DNN。
是否真实APNDNN|ADD APNDNN|是|全网规划|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|-
ADD APNDNNPROFILE|模板名称|abc.com|本端规划|-
ADD MAPAPNDNNPROFILE|APN/DNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
Access|ADD MAPAPNDNNPROFILE|打开|本端规划|
模板名称|ADD MAPAPNDNNPROFILE|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数。
SET APNDNNBASIC|模板名称|abc.com|已配置数据中获取|该参数引用自ADD APNDNNPROFILE命令中的NAME参数，并通过ADD MAPAPNDNNPROFILE命令把APN基础功能模板绑定在APN/DNN下。
ULCL/BP开关|SET APNDNNBASIC|打开|本端规划|-
SET PCCFUNCPROFILE|PCC 功能模板名|abc.com|本端规划|-
规则分流功能方式|SET PCCFUNCPROFILE|本地规则分流|本端规划|-
分流方式|SET PCCFUNCPROFILE|SMF决策分流|本端规划|-
ADD STEERINGPOLICY|分流策略名称|profilename|本端规划|-
DNAI|ADD STEERINGPOLICY|dnai_abc|本端规划|-
ADD STEERINGRULE|分流规则名称|localrule|对端协商|必须要和对端UPF的SHOW RULE配置中的NAME参数一致。
应用标识|ADD STEERINGRULE|app_abc|对端协商|分流业务的标识，必须要和对端UPF的SHOW RULE配置中的APPLICATION参数一致。
分流策略名称|ADD STEERINGRULE|profilename|本端规划|-
优先级|ADD STEERINGRULE|10|本端规划|-
ADD STEERINGRULEBASE|分流规则组名称|localup|对端协商|-
分流规则名称|ADD STEERINGRULEBASE|localrule|已配置数据中获取|该参数引用自ADD STEERINGRULE命令中的STEERINGRULENAME参数。
ADD UGROUP|GW-U组名称|UGroup1|本端规划|-
ADD UGROUPDNN|GW-U组名称|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
DNN|ADD UGROUPDNN|abc.com|已配置数据中获取|该参数引用自ADD APNDNN命令中的APNDNN参数。
ADD UPNODE|GW-U节点名称|UPF_local|本端规划|负责分流的UPF名称。
GW-U节点对应的组|ADD UPNODE|UGroup1|已配置数据中获取|该参数引用自ADD UGROUP命令中的GNAME参数。
接口类型|ADD UPNODE|IPV4|本端规划|-
GW-U节点网管口端口号|ADD UPNODE|7778|本端规划|-
ADD UPNODEID|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
Node ID类型|ADD UPNODEID|IPv4|本端规划|-
Node ID IPv4取值|ADD UPNODEID|193.168.34.16|本端规划|-
是否闭塞|ADD UPNODEID|否|本端规划|-
C面是否主动发起建链|ADD UPNODEID|是|本端规划|-
ADD UPSXINTERFACEIP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型优先级|ADD UPSXINTERFACEIP|IPv4|本端规划|-
IPv4地址|ADD UPSXINTERFACEIP|193.168.34.16|本端规划|-
IPv6地址|ADD UPSXINTERFACEIP|10::1|本端规划|-
端口|ADD UPSXINTERFACEIP|8805|本端规划|-
IPv4地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
IPv6地址VRF ID|ADD UPSXINTERFACEIP|1|本端规划|-
ADD UPATTRIBUTE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
SGW-U|ADD UPATTRIBUTE|是|对端协商|-
PGW-U|ADD UPATTRIBUTE|是|对端协商|-
UPF-N3|ADD UPATTRIBUTE|是|对端协商|-
UPF-N6|ADD UPATTRIBUTE|是|对端协商|-
UPF-N9|ADD UPATTRIBUTE|是|对端协商|-
SGW-S8|ADD UPATTRIBUTE|否|对端协商|-
PGW-S8|ADD UPATTRIBUTE|否|对端协商|-
ADD UPPDUSESSIONTYPE|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
IP地址类型|ADD UPPDUSESSIONTYPE|IPv4v6|本端规划|-
ADD UPWEIGHT|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
权重|ADD UPWEIGHT|100|本端规划|-
ADD UPDNAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
DNAI|ADD UPDNAI|dnai_abc|对端协商|用于关联支撑企业分流业务的辅锚点UPF。
ADD UPSNSSAI|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
切片服务类型|ADD UPSNSSAI|1-eMBB|对端协商|-
切片区分|ADD UPSNSSAI|010101|对端协商|-
ADD TACGROUP|TAC组名称|TAClist|本端规划|企业园区物理位置所对应的TACList。
TAC类型|ADD TACGROUP|TACNR|本端规划|-
ADD TACNRSECTION|段名称|TAC1|本端规划|-
START(十六进制)|ADD TACNRSECTION|0x000001|本端规划|-
END(十六进制)|ADD TACNRSECTION|0x000006|本端规划|-
TACNR组名称|ADD TACNRSECTION|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD UPTACNRGROUP|用户面名称|UPF_local|已配置数据中获取|该参数引用自ADD UPNODE命令中的UPNAME参数。
TACNR组名称|ADD UPTACNRGROUP|TAClist|已配置数据中获取|该参数引用自ADD TACGROUP命令中的TACGROUPNAME参数。
ADD TACRANGEMAPPINGDNAI|段名称|TAC1|已配置数据中获取|该参数引用自ADD TACNRSECTION命令中的SECNAME参数。
START(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000001|全局规划|-
END(十六进制)|ADD TACRANGEMAPPINGDNAI|0x000006|全局规划|-
DNAI1|ADD TACRANGEMAPPINGDNAI|dnai_abc|全局规划|-
###### 配置步骤 
步骤|说明|操作
---|---|---
1|增加DNN，并开启ULCL分流。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="cmnet"ADD APNDNNPROFILE:NAME="abc.com"ADD MAPAPNDNNPROFILE:APNDNN="abc.com",ACCESS="ENABLE",NAME="abc.com"SET APNDNNBASIC:NAME="abc.com",ULCLBPSWITCH=ENABLE
2|设置规则分流功能方式为预定义规则分流。|SET PCCFUNCPROFILE:PROFILENAME="abc.com",RULESTEERINGMETHOD="LOCALRULE",STEERINGMODE="SMFSTEERING"
3|新增模板名为profilename的分流策略模板。|ADD STEERINGPOLICY:STEERINGPOLICYNAME="profilename",DNAI="dnai_abc"
4|新增分流规则，绑定策略模板。|ADD STEERINGRULE:STEERINGRULENAME="localrule",APPLICATIONID="app_abc",STEERINGPOLICYNAME="profilename",PRECEDENCE=10
ADD STEERINGRULEBASE:STEERINGRULEBASENAME="localup",STEERINGRULENAME="localrule"|4|新增分流规则，绑定策略模板。
5|新增分流UPF。|ADD UGROUP:GName="UGroup1"ADD UGROUPDNN:GName="UGroup1", DNN="abc.com"ADD UPNODE:UPNAME="UPF_local",GNAME="UGroup1",MGRIPTYPE="IPV4",MGRPORT=7778ADD UPNODEID:UPNAME="UPF_local",NODEIDTYPE="IPV4",NODEIDIPV4VAL=193.168.34.16,ISBLOCK="false",ISACTIVEMAKEASSOC="true"ADD UPSXINTERFACEIP:UPNAME="UPF_local",IPV4ADDR=193.168.34.16,IPV6ADDR="10::1",IPPRIO="IPV4",PORT=8805,IPV4VRFID=1,IPV6VRFID=1ADD UPATTRIBUTE:UPNAME="UPF_local",SGWUFUNC="true",PGWUFUNC="true",UPFN3="true",UPFN6="true",UPFN9="true",SGW_S8="false",PGW_S8="false"
6|配置分流UPF接口类型。|ADD UPPDUSESSIONTYPE:UPNAME="UPF_local",PDUSESSIONTYPE="IPV4V6"
7|配置UPF权重。|ADD UPWEIGHT:UPNAME="UPF_local",WEIGHT=100
8|配置UPF和DNAI关联。|ADD UPDNAI:UPNAME="UPF_local",DNAI="dnai_abc"
9|配置UPF和切片关联。|ADD UPSNSSAI:UPNAME="UPF_local",SST="EMBB",SD="010101"
10|配置UPF和TAC关联。|ADD TACGROUP:TACGROUPNAME="TAClist",TYPE="TACNR"ADD TACNRSECTION:SECNAME="TAC1",STARTTACNR="0x000001",ENDTACNR="0x000006",TACGROUPNAME="TAClist"ADD UPTACNRGROUP:UPNAME="UPF_local",TACGROUPNAME="TAClist"
11|配置TAC和DNAI关联。|ADD TACRANGEMAPPINGDNAI:SECNAME="TAC1",STARTTAC="0x000001",ENDTAC="0x000006",DNAI1="dnai_abc"
##### UPF 
###### 数据规划 
命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---
ADD APNDNN|APNDNN|abc.com|全网规划|abc.com|企业专用DNN。
是否真实APNDNN|ADD APNDNN|是|全网规划|是|-
真实APNDNN|ADD APNDNN|abc.com|全网规划|abc.com|-
ADD DNCFG|APN/DNN|abc.com|全网规划|abc.com|-
网络实例|ADD DNCFG|N6|全网规划|N6|-
ADD DPIUPCONFIG|DPI模板配置名|nourlprofile|本端规划|nourlprofile|-
信令计费模式|ADD DPIUPCONFIG|信令归业务（默认值）|本端规划|信令归业务（默认值）|-
还原识别开关|ADD DPIUPCONFIG|DISABLE（默认值）|本端规划|DISABLE（默认值）|-
ADD USERPROFILE|用户模板名称|localrule|dynrule|对端协商|-
用户模板类型|ADD USERPROFILE|本地规则|动态规则|对端协商|-
优先级|ADD USERPROFILE|4294967295（默认值）|4294967295（默认值）|本端规划|-
DPI模板配置|ADD USERPROFILE|nourlprofile|nourlprofile|已配置数据中获取|该参数引用自ADD DPIUPCONFIG命令中的NAME参数。
ADD URRMAP|URR ID|10000|20000|对端协商|-
URR类型|ADD URRMAP|离线计费业务|在线计费业务|对端协商|-
业务标识|ADD URRMAP|1|0|对端协商|-
费率组|ADD URRMAP|1|1|对端协商|-
ADD CHARGINGDATA|计费策略名称|charging_zte|本端规划|charging_zte|-
离线URR标识|ADD CHARGINGDATA|10000|已配置数据中获取|10000|该参数引用自ADD URRMAP命令中的URRID参数。
在线URR标识|ADD CHARGINGDATA|20000|已配置数据中获取|20000|该参数引用自ADD URRMAP命令中的URRID参数。
免费|ADD CHARGINGDATA|FALSE（默认值）|本端规划|FALSE（默认值）|-
首包策略|ADD CHARGINGDATA|PASS|本端规划|PASS|-
首包配额|ADD CHARGINGDATA|2000000|本端规划|2000000|-
生成内容计费容器|ADD CHARGINGDATA|ENABLE（默认值）|本端规划|ENABLE（默认值）|-
ADD QOSDATA|QoS策略名称|qos_zte|本端规划|qos_zte|-
ADD LBO|LBO规则名称|lbo10|本端规划|lbo10|-
策略路由模板号|ADD LBO|10|本端规划|10|-
网络实例|ADD LBO|N6|本端规划|N6|-
ADD TRAFFICCONTROLDATA|业务控制规则名称|traffic_zte|本端规划|traffic_zte|-
转发动作|ADD TRAFFICCONTROLDATA|FORWARD|本端规划|FORWARD|-
转发策略类型|ADD TRAFFICCONTROLDATA|LBO|本端规划|LBO|-
转发策略|ADD TRAFFICCONTROLDATA|lbo10|已配置数据中获取|lbo10|该参数引用自ADD LBO命令中的NAME参数。
ADD L34FILTER|L34过滤器名称|l34_v4|本端规划|l34_v4|-
IP地址类型|ADD L34FILTER|IPV4|本端规划|IPV4|-
IPv4服务端IP地址|ADD L34FILTER|192.168.1.0|本端规划|192.168.1.0|园区服务器IP
IPv4服务端IP地址掩码|ADD L34FILTER|24|本端规划|24|园区服务器IP
三四层协议类型|ADD L34FILTER|ANY|本端规划|ANY|-
ADD L34FILTERGROUP|三四层过滤规则组名|l34_g|本端规划|l34_g|-
三四层过滤器名|ADD L34FILTERGROUP|l34_v4|已配置数据中获取|l34_v4|该参数引用自ADD L34FILTER命令中的FILTERNAME参数。
ADD FLOWFILTER|流过滤器名称|l34_ff|本端规划|l34_ff|-
L34过滤规则组名|ADD FLOWFILTER|l34_g|已配置数据中获取|l34_g|该参数引用自ADD L34FILTERGROUP命令中的GROUPNAME参数。
ADD L7FILTER|过滤器名称|l7_dns_lbo|本端规划|l7_dns_lbo|-
URL|ADD L7FILTER|*.zte.com*|本端规划|*.zte.com*|-
应用层协议类型|ADD L7FILTER|DNS|本端规划|DNS|-
ADD L7FILTERGROUP|七层过滤规则组名|l7_dns_lbo_g|本端规划|l7_dns_lbo_g|-
七层过滤器名|ADD L7FILTERGROUP|l7_dns_lbo|已配置数据中获取|l7_dns_lbo|该参数引用自ADD L7FILTER命令中的FILTERNAME参数。
ADD FLOWFILTER|流过滤器名称|l7_dns_lbo_ff|本端规划|l7_dns_lbo_ff|-
L7过滤规则组名|ADD FLOWFILTER|l7_dns_lbo_g|已配置数据中获取|l7_dns_lbo_g|该参数引用自ADD L7FILTERGROUP命令中的GROUPNAME参数。
ADD SERVICEREWRITECTRL|Rewrite控制规则名称|dnsrewrite|本端规划|dnsrewrite|-
重定向的IPv4服务器地址|ADD SERVICEREWRITECTRL|100.100.100.100|对端协商|100.100.100.100|园区DNS服务器IP。
重定向的IPv6服务器地址|ADD SERVICEREWRITECTRL|0:0:0:0:0:0:0:0|对端协商|0:0:0:0:0:0:0:0|园区DNS服务器IP。
重定向的服务器端口号|ADD SERVICEREWRITECTRL|0|对端协商|0|-
ADD TRAFFICCONTROLDATA|业务流控制策略名称|traffic_dnslbo|本端规划|traffic_dnslbo|-
转发动作|ADD TRAFFICCONTROLDATA|转发|本端规划|转发|-
转发策略类型|ADD TRAFFICCONTROLDATA|LBO|本端规划|LBO|-
转发策略|ADD TRAFFICCONTROLDATA|lbo10|本端规划|lbo10|-
Service Rewrite控制规则名称|ADD TRAFFICCONTROLDATA|dnsrewrite|已配置数据中获取|dnsrewrite|该参数引用自ADD SERVICEREWRITECTRL命令中的RULENAME参数。
ADD RULE|规则名称|iprule|dnsrule|本端规划|-
应用标识|ADD RULE|app_zte|app_zte|对端协商|-
流过滤器|ADD RULE|l34_ff|l7_dns_lbo_ff|已配置数据中获取|该参数引用自ADD FLOWFILTER命令中的FLOWFILTERNAME参数。
QoS策略|ADD RULE|qos_zte|qos_zte|已配置数据中获取|该参数引用自ADD QOSDATA命令中的NAME参数。
计费策略|ADD RULE|charging_zte|charging_zte|已配置数据中获取|该参数引用自ADD CHARGINGDATA命令中的NAME参数。
业务流控制策略|ADD RULE|traffic_zte|traffic_dnslbo|已配置数据中获取|该参数引用自ADD TRAFFICCONTROLDATA命令中的NAME参数。
ADD RULEBINDUP|用户模板|localrule|localrule|已配置数据中获取|该参数引用自ADD USERPROFILE命令中的NAME参数。
规则名|ADD RULEBINDUP|iprule|dnsrule|已配置数据中获取|该参数引用自ADD RULE命令中的NAME参数。
优先级|ADD RULEBINDUP|0|0|本端规划|-
###### 配置步骤 
步骤|说明||操作
---|---|---|---
1|配置用户模板|配置APNDNN。|ADD APNDNN:APNDNN="abc.com",REAL="false",REALAPNDNN="abc.com"
配置DNN。|1|配置用户模板|ADD DNCFG:DNN="abc.com",NETWORKINSTANCE="N6"
配置DPI模板。|1|配置用户模板|ADD DPIUPCONFIG:NAME="nourlprofile",ACCOUNTMODE="SERVICE",URLRERECOG="DISABLE"
配置用户模板，并将用户模板与DPI模板关联。|1|配置用户模板|ADD USERPROFILE:NAME="localrule",USERPROFILETYPE="LOCAL_RULE",PRECEDENCE=4294967295,DPIUPCONFIG="nourlprofile"ADD USERPROFILE:NAME="dynrule",USERPROFILETYPE="DYNAMIC_RULE",PRECEDENCE=4294967295,DPIUPCONFIG="nourlprofile"
2|配置计费和QoS策略|新增URR配置，UPF网元在报文匹配时会读取不同规则下对应的URR ID，从而进行相关功能的用量累计和上报。|ADD URRMAP:URRID=10000,TYPE="OFFLINECHARGESERVICE",SERVICEID=1,RATINGGROUP=1ADD URRMAP:URRID=20000,TYPE="ONLINECHARGESERVICE",SERVICEID=0,RATINGGROUP=1
新增计费策略，配置预定义规则对应的计费策略信息。|2|配置计费和QoS策略|ADD CHARGINGDATA:NAME="charging_zte",OFFLINEURRID=10000,ONLINEURRID=20000,FREE="false",NEWPACKETPOLICY="PASS",NEWPACKETQUOTA=2000000
新增QoS策略，配置预定义规则对应的QoS策略信息。|2|配置计费和QoS策略|ADD QOSDATA:NAME="qos_zte"
3|配置策略路由的转发策略|配置LBO分流规则，关联虚拟接口模板，从而关联到ROSNG的路由策略。|ADD LBO:NAME="lbo10",PRVTNO=10,NETWORKINSTANCE="N6"
配置业务控制策略，关联转发策略。|3|配置策略路由的转发策略|ADD TRAFFICCONTROLDATA:NAME="traffic_zte",ACTION="FORWARD",POLICYTYPE="LBO",POLICY="lbo10"
4|配置三四层流过滤器（基于IP地址分流时配置）|配置三四层过滤规则。|ADD L34FILTER:FILTERNAME="l34_v4",IPTYPE="IPV4",IPV4SERVERIP="192.168.1.0",IPV4SERVERIPMASK=24,PROTOCOL="ANY"
配置三四层过滤规则组，关联配置的三四层过滤规则。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD L34FILTERGROUP:GROUPNAME="l34_g",L34FILTERNAME="l34_v4"
配置流过滤器，关联配置的三四层过滤器组，实现对用户报文的特定过滤。|4|配置三四层流过滤器（基于IP地址分流时配置）|ADD FLOWFILTER:FLOWFILTERNAME="l34_ff",L34FILTERGROUPNAME="l34_g"
5|配置规则（基于IP地址分流时配置）|配置DPI规则，关联流过滤器、QoS策略、计费策略等，根据这些规则识别满足条件的业务报文，进行不同的计费和控制。|ADD RULE:NAME="iprule",APPLICATION="app_zte",FLOWFILTER="l34_ff",QOSDATA="qos_zte",CHARGINGDATA="charging_zte",TRAFFICCONTROLDATA="traffic_zte"
配置用户模板与DPI规则绑定。|5|配置规则（基于IP地址分流时配置）|ADD RULEBINDUP:UPNAME="localrule",RULENAME="iprule",PRECEDENCE=0ADD RULEBINDUP:UPNAME="dynrule",RULENAME="iprule",PRECEDENCE=0
6|配置七层流过滤器（基于域名分流时配置）|配置七层过滤规则。|ADD L7FILTER:FILTERNAME="l7_dns_lbo",URL="*.zte.com*",APPTYPE="DNS"
配置七层过滤规则组，关联配置的七层过滤规则。|6|配置七层流过滤器（基于域名分流时配置）|ADD L7FILTERGROUP:GROUPNAME="l7_dns_lbo_g",L7FILTERNAME="l7_dns_lbo"
配置流过滤器，关联配置的七层过滤器组，实现对用户报文的特定过滤。|6|配置七层流过滤器（基于域名分流时配置）|ADD FLOWFILTER:FLOWFILTERNAME="l7_dns_lbo_ff",L7FILTERGROUPNAME="l7_dns_lbo_g"
7|配置规则（基于域名分流时配置）|配置重定向策略，并将业务控制策略关联重定向策略。|ADD SERVICEREWRITECTRL:RULENAME="dnsrewrite",REWRITEIPV4="100.100.100.100",REWRITEIPV6="0:0:0:0:0:0:0:0",REWRITEPORT=0ADD TRAFFICCONTROLDATA:NAME="traffic_dnslbo",ACTION="FORWARD",POLICYTYPE="LBO",POLICY="lbo10",SERVICEREWRITE="dnsrewrite"
配置DPI规则，关联流过滤器、QoS策略、计费策略等，根据这些规则识别满足条件的业务报文，进行不同的计费和控制。|7|配置规则（基于域名分流时配置）|ADD RULE:NAME="dnsrule",APPLICATION="app_zte",FLOWFILTER="l7_dns_lbo_ff",QOSDATA="qos_zte",CHARGINGDATA="charging_zte",TRAFFICCONTROLDATA="traffic_dnslbo"
配置用户模板与DPI规则绑定。|7|配置规则（基于域名分流时配置）|ADD RULEBINDUP:UPNAME="localrule",RULENAME="dnsrule",PRECEDENCE=0
8|激活DPI规则|DPI RULE REFRESH|激活DPI规则
#### 信令交互 
##### 用户在园区内激活会话，启动分流 
用户在园区内触发PDU会话激活。SMF基于本地分流规则、DNN以及用户位置信息选择ULCL UPF/辅锚点UPF，同时创建到主锚点UPF的会话和到ULCL UPF/辅锚点UPF的分流会话，下发分流策略给ULCL UPF/辅锚点UPF。ULCL UPF/辅锚点UPF执行分流策略，将用户数据报文分流至本地和Internet，端到端信令流程如[图1](1640679880278HHuXMD.html#Qy-0440B6F3__0e2c6f90-98b6-40be-a19d-28f66e5e01db)所示。
图1  用户在园区内激活会话，启动分流
[]images/%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%811-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%88%86%E6%B5%81.png)
UE发起会话创建请求给AMF，携带DNN、TAI、S-NSSAI等信息。 
AMF发送Nsmf_PDUSession_CreateSMContext Request给SMF，携带DNN、TAI、S-NSSAI、PDU会话类型等信息，SMF回复Nsmf_PDUSession_CreateSMContext Response消息给AMF。  
SMF根据获取到的DNN、S-NSSAI、PDU会话类型以及UPF的接口能力选出主锚点UPF，即PSA0。根据TAI、UPF的接口能力（从N4接口PFCP Association Setup流程中获取）选出ULCL UPF，结合SMF本地配置的DNN和DNAI的绑定关系选出辅锚点UPF（PSA1），此处选出的ULCL UPF和PSA1 UPF合一部署。 
SMF向PSA0 UPF发起PFCP会话建立请求，携带给PSA0 UPF分配的上、下行PDR信息，分配的的用户IP地址。会话创建成功后，PSA0 UPF会通过PFCP Session Establishment Response消息返回N9上行隧道信息。  
SMF向ULCL UPF/PSA1 UPF发起PFCP会话建立请求，携带相应的规则，包含用于指示ULCL UPF对数据包进行分流的分流规则对应的Aplication ID以及数据转发规则FAR。ULCL UPF/PSA1 UPF收到请求后给SMF回复相应的Response消息，携带其分配给(R)AN侧的N3上行隧道信息以及分配给PSA0 UPF的N9下行隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带第5步中ULCL UPF分配的N9下行隧道信息，并更新PSA0 UPF的下行FAR。PSA0 UPF在返回的响应消息中携带给ULCL UPF分配的N9上行隧道信息。 
SMF向AMF发起Namf_Communication_N1N2MessageTransfer流程，携带N2 SM Information给AMF，里面包含ULCL UPF分配的N3上行隧道信息（用于通知(R)AN侧将N3隧道的上行对端隧道信息更新至ULCL UPF），网络侧给UE分配的IP地址Allocated IPv4 Address。AMF向SMF回复响应消息。 
本步骤由如下子步骤组成： 
8a. AMF向(R)AN发送PDU Session Resource Setup Request，请求中包含N3上行隧道信息、网络侧给UE分配的Allocated IPv4 Address。 
8b. (R)AN与UE发起信令交互，将PDU Session ID、Allocated IPv4 Address等转发至UE，请求UE建立PDU会话。 
8c. (R)AN向AMF发送PDU Session Resource Setup Response消息，携带给ULCL UPF分配的N3下行隧道信息AN Tunnel Info等。 
SMF和AMF通过Nsmf_PDUSession_UpdateSMContext消息交互获取AN Tunnel Info等信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Modification Request，将(R)AN侧N3隧道下行隧道信息发送给ULCL UPF/PSA1 UPF，ULCL UPF/PSA1 UPF回复PFCP Session Modification Response消息给SMF。 
##### 用户在园区内激活会话，移动到园区外 
用户在园区内访问本地业务，已激活包含ULCL分流会话的PDU会话。用户从园区内移动到园区外，SMF感知到用户位置变化，决策停止分流，触发删除分流会话流程。端到端信令流程如[图1](%E5%A4%84%E7%90%86%E5%91%8A%E8%AD%A6.html#topic1__4c88a395-c738-4f71-8a5d-8830a76bb5fe)所示。
图1  用户在园区内激活会话，移动到园区外
[]images/%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%812-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%86%85%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E7%A7%BB%E5%8A%A8%E5%88%B0%E5%9B%AD%E5%8C%BA%E5%A4%96.png)
UE在园区内已激活PDU会话，创建了到PSA0 UPF和ULCL UPF/PSA1 UPF的会话。 
UE从园区内移动至园区外，(R)AN发起基于Xn接口的切换，向AMF发送N2 Path Swtich Request。 
AMF给SMF发送Nsmf_PDUSession_UpdateSmContexts Request消息，携带UE Location信息，包含用户最新的位置信息（如当前所处位置的TAI）。 
SMF根据用户的新位置判定用户已经移出园区范围，无需分流，发起删除分流会话的流程。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带上行PDR给PSA0 UPF，指示上行报文从N3口进入，N6口发出。PSA0 UPF返回响应消息，携带上行N3隧道信息，同时修改下行PDR关联的FAR，将下行隧道信息更新为(R)AN的IP地址信息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带新的N3上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Deletion Request消息，请求删除分流会话。ULCL UPF/PSA1 UPF收到请求后回应Response消息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，删除为分流业务安装的N9上行PDR。 
更新(R)AN侧的隧道信息。 
##### 用户在园区外激活会话，移动到园区内 
用户在园区外通过专用DNN访问Internet，已激活PDU会话。用户从园区外移动至园区内，SMF感知到UE位置区变化，基于SMF本地配置的分流规则和用户当前的位置信息选择分流UPF，创建分流会话并将分流会话插入到用户的PDU会话中，下发分流策略给分流UPF。分流UPF执行分流策略，将用户数据报文分流至本地和Internet，端到端信令交互如[图1](8177220.html#Qy-0440B6F3__2cf639ef-5fc4-4fd9-9d89-8a4f9c340b39)所示。
图1  用户在园区外激活会话，移至园区内
[]images/%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E8%A7%84%E5%88%99%E7%9A%84%E5%89%8D%E5%90%91%E5%88%86%E6%B5%813-%E7%94%A8%E6%88%B7%E5%9C%A8%E5%9B%AD%E5%8C%BA%E5%A4%96%E6%BF%80%E6%B4%BB%E4%BC%9A%E8%AF%9D%EF%BC%8C%E7%A7%BB%E8%87%B3%E5%9B%AD%E5%8C%BA%E5%86%85.png)
UE已在园区外建立会话。 
UE位置发生改变，从园区外移动至园区内，触发基于Xn接口的切换流程。(R)AN向AMF发送N2 Path Swtich Request消息。 
AMF给SMF发送Nsmf_UpdateSmContext Request消息，携带UE Location信息（包含用户最新的位置信息，如当前所处位置的TAI），携带N2 Container（N2 Path Swtich Request）。 
SMF根据用户的新位置和本地配置的分流规划决策需要分流，基于本地配置的UPF和DNAI的绑定关系选择ULCL UPF/PSA1 UPF，创建分流会话。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，携带给PSA0 UPF分配的上行PDR。PSA0 UPF返回响应消息，携带N9a上行隧道信息。 
SMF向ULCL UPF/PSA1 UPF发送PFCP Session Establishment Request消息，携带上、下行PDR以及分流规则对应的Application ID。ULCL UPF/PSA1 UPF收到请求后回应Response消息，携带分配给(R)AN的N3上行隧道信息以及分配给PSA0 UPF的N9c下行隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request消息，通知PSA0 UPF修改下行PDR关联的FAR，更新N9隧道下行隧道信息（指向UL CL UPF的N9c口）。PSA0 UPF返回响应消息。 
SMF返回Nsmf_UpdateSmContext Response消息给AMF，携带N2 Container（N2 Path Swtich Ack），将新的N3上行隧道信息告知(R)AN。 
AMF向(R)AN发送N2 Path Swtich Ack，更新N3隧道信息。 
SMF向PSA0 UPF发送PFCP Session Modification Request，删除用户初始激活时创建的N3上行PDR。 
## 分流场景下的关联方案 
### 分流UPF上UE地址冲突解决方案 
ULCL分流场景下，存在如下地址的冲突的问题： 
冲突场景|场景描述|解决方案
---|---|---
UE终端地址冲突|某地市的企业专网用户以本地市UPF作为主锚点，以本地市下沉UPF作为ULCL/辅锚点UPF。由于多套主锚点UPF的地址池存在重叠，当两个激活在不同主锚点的企业用户接入园区时，ULCL/辅锚点UPF上就可能出现UE间的地址冲突。|ULCL UPF上UE地址冲突解决方案
园区内网地址和UE终端地址冲突|园区内网服务器的IP地址与终端地址池的IP地址都是私网地址，各自规划，可能存在冲突。|园区内网地址和UE终端地址冲突解决方案
不同园区私网之间的地址冲突|本地市用户对应的ULCL分流UPF对接所有本地的园区，不同园区的内网服务器IP地址可能存在冲突。|不同园区内网地址冲突解决方案
#### ULCL UPF上UE地址冲突解决方案 
##### 场景说明 
如[图1](0862400.html#Qy-0440B6F3__98f43da9-91c9-4d96-8814-94ef73cf7384)所示，不同主锚点的用户对应同一个ULCL+辅锚点UPF。
图1  ULCL上UE地址冲突场景
[]images/1658459097894.png)
当同时满足以下条件时，用户在ULCL+辅锚点UPF上会产生地址冲突问题。 
两个主锚点上规划的地址段有重叠。 
两个主锚点分别为同一个本地网络的两个用户，分配了相同的IP地址。 
本地网络没有使用NI映射功能，没有为不同锚点的用户指定不同的NI。 
 说明： 
冲突的概率取决于中心UPF地址池的容量和当前在线的使用分流业务用户数，中心UPF地址池的容量越大，冲突的概率越小，当前在线的使用分流业务的用户越多，冲突概率越高。 
##### 解决方案 
ULCL+辅锚点UPF进行UE地址冲突检测，若发现冲突，可采取如下措施。 
去活老用户，允许新用户接入。 
保留老用户，拒绝新用户接入。 
两种策略可通过配置调整，默认保留老用户。 
#### 园区内网地址和UE终端地址冲突解决方案 
##### 场景说明 
中心UPF作为会话主锚点，为用户分配的IP地址IP1与园区网服务器地址相同。 
用户使用该地址访问园区内网，上行报文到达ULCL+辅锚点UPF时，UPF会认为该报文是发往终端的下行报文，导致业务中断。 
图1  UE地址和园区内网地址冲突
[]images/1658472652338.png)
##### 解决方案 
针对园区内网地址和UE终端地址冲突的问题，有如下两种解决方案。 
使用专用DNN。专用DNN地址有限，规划地址时，避免与园区内网地址重叠。 
本地UPF和园区内网间部署双向NAT，将园区网与核心网隔离，避免地址冲突，如图2所示。图2  双向NAT 
#### 不同园区内网地址冲突解决方案 
##### 场景说明 
园区1和园区2都使用ULCL+辅锚点UPF，将内网数据分流到园区内，两个园区服务器地址相同，都是IP1。当用户访问园区业务，目的地址是IP1时，ULCL+辅锚点UPF无法确定将报文发送至哪个园区。 
图1  不同园区内网地址冲突
[]images/1658496640358.png)
##### 解决方案 
SMF针对不同园区的分流业务（由APP ID标识）配置对应的RouteProfileID，在给UPF下发FAR时携带Forwarding Policy ID=RouteProfileID。以[图2](2346284.html#Qy-0440B6F3__5a2040c7-ffa3-4811-806e-7ffadcf7fad5)为例：园区1的业务APP ID1，路由信息配置为RouteProfileID1；园区2的业务APP ID2，路由信息配置为RouteProfileID2。
图2  通过RouteProfile区分转发路径
[]images/1658494891350.png)
UPF针对RouteProfileID配置不同VPN策略，实现两个园区数据的隔离转发。例如：配置RouteProfileID1对应的N6 VPN为VPN-A。配置RouteProfileID2对应的N6 VPN为VPN-B。 
用户A访问园区1的业务，SMF根据本地分流策略配置或者PCF下发的预定义规则判断需要进行分流，在ULCL+辅锚点UPF上的PFCP会话Session1的建立过程中，上行数据的FAR中转发策略为Forwarding Policy ID=RouteProfileID1。用户B访问园区2的业务，SMF根据本地分流策略配置或者PCF下发的预定义规则判断需要进行分流，在ULCL+辅锚点UPF上的PFCP会话Session2建立过程中，上行数据的FAR中转发策略为Forwarding Policy ID=RouteProfileID2。
用户A发送上行数据报文P1（目的IP为10.10.10.1），ULCL+辅锚点UPF根据N3隧道匹配到Session1，根据FAR的转发策略判断需要转发至VPN-A，报文P1送至园区1。用户B发送上行数据报文P2（目的IP为10.10.10.1），ULCL+辅锚点UPF根据N3隧道匹配到Session2，根据FAR的转发策略判断需要转发至VPN-B，报文P2送至园区2。 
### ULCL容灾方案 
#### 描述 
##### 定义 
支持ULCL容灾，是指ULCL UPF支持主备路由组网下的主备方式容灾，或者主机路由组网下的负荷分担方式容灾，提高业务可用性。 
容灾，指位于不同地理位置的两个站点，当其中一个站点因自然灾害、电力故障等不可控因素无法提供服务时，另一个站点可以接管用户业务，提高网络可靠性。 
##### 背景知识 
ULCL是在PDU会话的数据路径上插入一个UPF作为Uplink Classifier，用于将会话的一部分数据分流到本地网络，对数据进行合理路由。一般情况下，ULCL UPF和辅锚点UPF合一部署，本功能特指合一部署的ULCL UPF。
为了提高ULCL业务的可用性，可以部署一对UPF提供高可用ULCL服务，有如下两种部署方式。
当使用主备静态路由组网时，这一对UPF配置为主备方式容灾。 
当使用主机路由方式组网时，这一对UPF配置为负荷分担方式容灾。 
ULCL容灾特性可以保证单ULCL故障期间，业务仍可用。 
#### 实现原理 
##### 系统架构 
按照组网方式的不同，ULCL容灾可分为如下两种情况。 
本地网络到主备ULCL UPF采用静态路由方式组网，系统架构如图1所示。图1  静态路由方式ULCL容灾架构图 
本地网络到两个ULCL UPF采用BGP路由方式组网，ULCL用户动态发布主机路由，系统架构如图2所示。图2  主机路由方式ULCL容灾系统图 
##### 涉及的网元 
网元名称|网元作用
---|---
SMF|SMF可根据不同的APN配置ULCL UPF的优先级，在插入ULCL UPF时，优选高优先级的ULCL UPF。
本地网络|静态路由方式：支持到主备ULCL UPF的主备路由。主机路由方式：支持主机路由通告，即由用户上线时发布单地址路由。
##### 本网元实现 
ULCL UPF和辅锚点UPF合设，作为ULCL业务分流点，同时也作为本地网络的辅锚点。以下按照不同的路由方式对实现原理进行介绍。
静态路由方式
主用ULCL UPF故障及恢复场景的报文转发主用ULCL UPF故障时报文转发场景如图3所示，当主用ULCL UPF故障恢复后，对于故障期间从备用ULCL UPF接入的用户，本地网络将按主用路由发送下行报文到主用ULCL UPF。主用ULCL UPF将此类报文，通过配置的NF互转隧道，转发到备用ULCL UPF进行下行报文的发送，报文转发场景如图4所示。图3  故障时报文转发场景当主用ULCL UPF发生故障时，主要涉及如下处理过程。主用ULCL UPF发生故障，SMF检测到故障后，将用户下线。用户重新接入，SMF选择备用ULCL UPF作为到本地网络的分流点，上行报文正常分流到本地网络。本地网络的企业网关检测到主用ULCL UPF故障，选择备用路由发送下行报文到备用ULCL UPF。图4  故障后恢复下行报文转发场景当主用ULCL UPF发生了故障并且故障已经恢复时，主要涉及如下处理过程。主用ULCL UPF恢复，故障期间通过备用ULCL UPF重新接入的用户，仍然通过备用ULCL UPF分流。主用ULCL UPF上无此用户上下文。本地网络的企业网关检测到主用ULCL UPF链路恢复，选择主用路由，发送下行报文到主用ULCL UPF。主用ULCL UPF收到下行报文，发现用户不在本ULCL UPF，且目的地址为配置的ULCL UPF地址池中的地址，则通过互转隧道，将报文转发到备用ULCL UPF。备用ULCL UPF收到互转来的报文，下行发送给用户。 
主用ULCL UPF与本地网络之间路由故障场景的报文转发主用ULCL UPF与本地网络之间的路由故障时，上行报文通过配置的NF互转隧道，转发到备用ULCL UPF发送。路由故障上行互转场景如图5所示。图5  路由故障上行互转场景当主用ULCL UPF与本地网络之间的路由故障时，主要涉及如下处理过程。主用ULCL UPF进行路由查找失败，则通过互转隧道，将上行报文转发到备用ULCL UPF。备用ULCL UPF收到互转来的报文，上行发送到本地网络。 
上下行路径一致场景的报文转发如果主用ULCL UPF故障已恢复，但在备用ULCL UPF的地址段中配置了上下行路径一致性，则备用ULCL UPF上收到的上行报文，通过NF互转隧道转给主用ULCL UPF发送，以保证用户的上下行报文在N6侧都经过相同的转发路径。对于部署了企业网关侧防火墙的场景，如需要出入向同路径，则需要开启此功能。故障时报文转发场景如图3所示，故障恢复时报文转发场景如图6所示。图6  故障后恢复上行报文转发场景主用ULCL UPF恢复，故障期间重新通过备用ULCL UPF接入的用户，仍然通过备用ULCL UPF分流。上行报文到达备用ULCL UPF，如果主用ULCL UPF可用，那么为了保证上下行路径一致，通过互转隧道，将报文转发到主用ULCL UPF。主用ULCL UPF收到互转来的报文，上行发送到本地网络，上下行报文都经过相同的防火墙。 
主机路由方式
ULCL UPF在用户会话建立时，发布用户的主机路由；在用户会话删除时，撤销用户的主机路由。主机路由方式容灾场景如[图7](6-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html#T_2017510842497__a726e98f-a1ab-4c55-8d5e-42efa7a1f72f)所示。
图7  主机路由方式容灾场景
[]images/%E5%9B%BE%E7%89%877(%E9%87%8D%E7%94%A81).png)
用户所在ULCL UPF1发生故障，SMF检测到故障后，将用户下线。 
用户重新接入，SMF选择可用ULCL UPF2作为到本地网络的分流点，上行报文正常分流到本地网络，ULCL UPF2发布此用户IP的主机路由。 
本地网络的企业网关接收到ULCL UPF2通告的主机路由，发送下行报文到ULCL UPF2。 
使用本方式时，用户从接入的ULCL UPF发布路由，下行报文始终发往用户所在的ULCL UPF，无需互转隧道。 
# 缩略语 
# 缩略语 
## AMF 
Access and Mobility Management Function接入和移动管理功能
## APN 
Access Point Name接入点名称
## BGP 
Border Gateway Protocol边界网关协议
## DN 
Data Network数据网
## DNAI 
DN Access Identifier数据网络接入标识符
## DNN 
Data Network Name数据网名称
## DPI 
Deep Packet Inspection深度包检测
## FAR 
Forwarding Action Rule报文转发规则
## IE 
Information Element信息元
## MEC 
Multi-access Edge Computing多接入边缘计算
## NAT 
Network Address Translation网络地址转换
## PCC 
Policy and Charging Control计费和策略控制
## PCF 
Policy Control Function策略控制功能
## PDR 
Packet Detection Rule报文检测规则
## PDU 
Protocol Data Unit协议数据单元
## PF 
Packet Filter包过滤
## PFCP 
Packet Forwarding Control Protocol报文转发控制协议
## PSA 
PDU Session AnchorPDU会话锚点
## PUDR 
Policy UDR统一的策略数据存储库
## QER 
QoS Enforcement RuleQoS执行规则
## SMF 
Session Management Function会话管理功能
## SPR 
Subscription Profile Repository用户签约数据库
## UE 
User Equipment用户设备
## ULCL 
Uplink Classifier上行分类器
## UPF 
User Plane Function用户平面功能
## URR 
Usage Reporting Rule用量上报规则
# 5G异网漫游解决方案 
## 方案概述 
### 背景与挑战 
由于终端用户具有不断移动的特点，当终端用户在国内移动到了归属运营商的5G网络未覆盖的地区时，则无法继续使用5G通信服务，可能导致用户掉线、业务中断。为了保证用户的持续接入、确保业务连续性，5G异网漫游应运而生。 
### 定义 
5G异网漫游，是指终端用户在本国内移动到归属运营商没有5G网络覆盖的地区时，可以通过其他运营商的5G网络继续使用5G通信服务。 
中兴通讯提供的5G异网漫游解决方案，以3GPP协议定义的5G国际漫游为基础，使用HomeRouted漫游架构构建。 
### 漫游架构参考 
3GPP协议定义的5G国际漫游架构分为Home Routed架构和Local Breakout架构。 
HomeRouted架构如[图1](1668582409960.html#z06db9a59c3d04332b5fdaed9e8138feb__42028ad2-5f49-4ce9-b6ed-5ba979fceaa7)所示，LocalBreakOut架构如[图2](1668582409960.html#z06db9a59c3d04332b5fdaed9e8138feb__32f46a74-fd2e-4f39-9ad4-e4c821d05233)所示。图中橙色的虚线框内的NF均需通过SEPP与异网NF进行交互。
图1  HomeRouted漫游架构
[]images/0472796ab22e4e808bc0c42c2b4d2d7d.png)
图2  LocalBreakOut漫游架构
[]images/27fd676009e842a6bb7ad4db8a56e3c4.png)
HomeRouted架构和LocalBreakOut架构的说明及特点参见[表1](1668582409960.html#z06db9a59c3d04332b5fdaed9e8138feb__6e524d15-ca58-43c5-9c00-c23c11969c96)。
漫游架构|说明|特点
---|---|---
HomeRouted架构|签约、策略和会话锚点均在归属地，拜访地提供接入能力。|优点：拜访地和归属地均有计费能力，方便对账。缺点：业务传输路径长。
LocalBreakOut架构|会话锚点在拜访地，归属地只提供签约和策略，拜访地提供接入能力。|优点：业务传输路径短，业务体验好。缺点：归属地无计费能力，无法对账。
5G异网漫游解决方案基于对策略、计费对账等功能的需要，选择使用HomeRouted架构。 
## 原理介绍 
### 组网架构 
#### 对接组网 
拜访网络和归属网络的对接组网如[图1](1669165870801.html#za17398c8c67d4c8f9648601f612dcac6__6cef8bef-16ae-43f8-be7f-8c14a58801ad)所示。
图1  对接组网
[]images/7653d35f6dd44da7bfbc72753a6c12ce.png)
拜访网络和归属网络在各自信令面边缘部署安全边缘保护代理（SEPP）和边界网关（BG），实现拓扑隐藏、安全防护等功能。拜访网络和归属网络的UPF通过边界网关（BG）和Internet网络分组交互协议（IPX）路由连接。
基于各运营商对于各自网络的规划，运营商之间的对接组网方式可以分为如下两种： 
异网间SEPP对等组网 
异网间SEPP多对多组网 
##### 异网间SEPP对等组网 
5GC异网漫游架构下的SEPP对等组网如[图1](1669165895353.html#zf62b54be3473491396dfed2af1dd5e39__3e891d51-6d5e-4e1e-90d2-ae2e5ff59906)所示。
图1  异网间SEPP对等组网示例
[]images/69b2c996655e430ebdde309a4d6049fc.png)
该组网方式的说明如下。 
运营商之间的SEPP部署SEPP按节点/大区对等部署，即运营商A的北京节点部署几个SEPP，那么对应运营商B的北部大区也部署相同个数的SEPP。对等节点/大区所部署的SEPP间交叉互联，实现负荷分担组网，以及转发跨PLMN信令。非对等节点/大区间的SEPP不交叉互联。 
运营商内部的SEPP部署两个节点/大区之间的SEPP互通，转发相关的跨节点/大区信令。每一节点/大区的SEPP仅与本节点/大区管辖省份的5GC、I-NRF对接，不与跨节点/大区省份的5GC网元、I-NRF对接。 
NRF部署运营商A的一个I-NRF固定指向运营商B对应大区的一个I-NRF，即无大区/节点间交叉。I-NRF关口局负责异网漫游互通，隐藏网内拓扑，简化组网对接，每个I-NRF和该运营商网内所有L-NRF对接。 
##### 异网间SEPP多对多组网 
根据运营商组网方案变化，可能存在多对多组网方式，如[图1](1669165899504.html#zfb089e0852fc47a690d94e74131d1dc6__e8983b1e-a468-423a-946d-a94567668fa4)所示。
图1  异网间SEPP多对多组网示例
[]images/1b06196fa9de442398928b5c9a5be821.png)
该组网方式的说明如下。 
A运营商按2个节点，每个节点部署2对SEPP及I-NRF。 
B运营商按1个大区，大区中的每个省份部署1对SEPP，但是仅在一个省份部署1对I-NRF。 
A运营商每个I-NRF和网内所有L-NRF对接；B运营商的SEPP以负荷分担方式向A运营商的2对SEPP发送消息。 
A运营商的SEPP发往B运营商的消息分为如下两种情况：服务发现消息直接发送到B运营商中有I-NRF的省份的SEPP。5GC业务消息按照B运营商的省份信息直接发送到B运营商对应省份的SEPP。 
#### 组网约束 
相比5G国际漫游，5G异网漫游有如下组网约束： 
拜访网络在空口广播新的共享专用网号由于现网运营商的USIM卡可能已将其他运营商的网号（MCC+MNC的组合）添加为禁用网号，此时要求拜访网络运营商支持多网号，以提供给其他运营商用户在异网漫游接入时使用。为支持异网漫游功能，拜访网络为每一个其他运营商的异网漫游用户都设置一个独立共享专用网号。如图1所示，运营商A的网号为PLMN1，运营商B和运营商C已将运营商A的网号PLMN1添加为禁用网号，所以运营商A需要新增共享专用网号PLMN12和PLMN13，分别提供给运营商B和运营商C的归属用户异网漫游接入时使用。例如：5G拜访网络为中国移动时，中国移动无线网络在空口除了广播中国移动的PLMN（46000），还会广播中国电信用户（HPLMN为46011）接入使用的共享专用网号（比如46021）和中国联通用户（HPLMN为46001）接入使用的共享专用网号（比如46022）。图1  拜访网络在空口广播新的共享专用网号 
语音业务只支持通过VoNR方式进行，不支持通过EPS Fallback方式进行拜访网络仅提供5G异网漫游，不提供4G异网漫游，即用户无法访问4G拜访网络。用户接入5G拜访网络后，若不能进行VoNR业务，而用户又不能回落到4G拜访网络，则用户只能回落到4G归属网络。由于4G归属网络和5G拜访网络间不提供跨PLMN的N26接口互连（对现网4G网络改动较大），因此用户也无法使用EPS Fallback方式进行语音业务。综上所述，5G异网漫游用户的语音业务只支持通过VoNR方式进行。系统架构如图2所示。 说明：用户在4G归属网络和5G拜访网络间移动时，需重新接入网络，已激活的PDU Session会在删除后重新建立，业务有短暂的网络中断。图2  4G归属网络和5G拜访网络间不提供跨PLMN的N26接口 
### 功能介绍 
#### 接入控制 
5G拜访网络为每一个其他网络的异网漫游用户都设置一个独立的共享专用网号，在漫游区域内，异网漫游用户仅能使用共享专用网号接入拜访网络。 
接入控制由AMF/MME实现，对AMF/MME的要求如下： 
归属AMF/MME将包含共享专用网号的EPLMN列表下发至终端，确保UE后续移动到漫游区域时，可以优选共享专用网号。 
拜访AMF将包含用户归属网络移动网号的EPLMN列表下发至终端和无线接入网，确保用户从VPLMN网络可以切换到HPLMN（3GPP协议规定切换的目标网络必须是Serving PLMN或EPLMN）。 
UE移动至漫游区域接入拜访网络，但没有使用其共享专用网号时，拜访AMF需要拒绝用户接入。 
拜访SMF向NRF注册服务区域（taiList/taiRangeList）时，需要包含共享PLMN的TA段，同时拜访SMF服务的plmnList中需要增加共享PLMN，以便异网用户拜访接入时，AMF能够选择该SMF作为vSMF提供服务。 
归属SMF向NRF注册服务区域（taiList/taiRangeList）时，需要包含本省拜访运营商共享PLMN的TA段，以便于用户异网漫游时，AMF优先选择本省SMF作为hSMF，此时interPlmnFqdn使用归属运营商的网号进行配置。 
#### 网元发现、选择和路由 
##### NF路由 
路由包括如下两种方式： 
基于Request URI的路由方式当NF（消息起始发送者）判断消息是跨PLMN异网漫游用户消息，需要发送至其他PLMN时，在消息的URI的“Authority”中携带目标NF地址信息，并将消息发送至SEPP。SEPP收到转发消息后，基于URI的“Authority”中目标NF的地址信息进行路由转发，如图1所示。图1  基于Request URI的路由方式 
基于3gpp-Sbi-Target-apiRoot的路由方式当NF判断是跨PLMN网漫游用户消息需要发送至其他PLMN时，在3gpp-Sbi-Target-apiRoot中携带目标NF的地址信息，将消息发送至SEPP。SEPP收到转发消息后，基于3gpp-Sbi-Target-apiRoot中目标NF的地址信息进行路由转发，如图2所示。图2  基于3gpp-Sbi-Target-apiRoot的路由方式 
5G异网漫游场景需要部署SEPP作为边界网关，当用户漫游到归属运营商网络以外的地区时，可以通过SEPP进行信令消息转发（SEPP在信令消息转发过程中会对消息进行拓扑隐藏），用户可以继续使用5G通信服务。通过SEPP进行消息转发的过程中使用的路由包含分为两种类型，分别是NF到SEPP的路由和SEPP到其他PLMN SEPP的路由，具体说明参见下表。 
路由类型|路由方式|对NF要求|对SEPP要求
---|---|---|---
NF到SEPP的路由|基于Request URI的路由方式|NF需感知SEPP，配置NF与SEPP对接。NF根据异网目的FQDN进行路由，将信令消息发送至SEPP，目的FQDN携带在HTTP消息的Request URI中。|根据异网目的FQDN将信令转发至相应的异网SEPP。作为接收方SEPP，根据接收到的信令消息的URI中的FQDN将信令转发至NF或SCP。
基于3gpp-Sbi-Target-apiRoot的路由方式|NF到SEPP的路由|NF需感知SEPP，配置NF与SEPP对接。NF根据异网目的FQDN进行路由，将信令消息发送至SEPP，并将目标网元地址填写在HTTP头部的3gpp-Sbi-Target-apiRoot参数中。|支持3gpp-Sbi-Target-apiRoot参数。根据3gpp-Sbi-Target-apiRoot中异网目的FQDN将信令转发至相应的跨PLMN的SEPP。作为接收方SEPP，根据接收信令中URI中FQDN将信令转发至NF。
SEPP到SEPP的路由|基于Request URI的路由方式|-|发起方SEPP在URI中携带目标NF的FQDN地址。
基于3gpp-Sbi-Target-apiRoot的路由方式|SEPP到SEPP的路由|-|发起方SEPP在URI中携带对端SEPP的FQDN地址，在3gpp-Sbi-Target-apiRoot中携带目标NF的FQDN地址。
##### NF服务发现和选择 
5G异网漫游时，涉及发现其他PLMN下的NF，与本PLMN内的NF发现相比，跨PLMN的NF发现为了实现路由和授权功能，对NF和NRF进行了功能增强处理。 
异网漫游场景下，AMF/SMF/UDM/AUSF等NF向NRF发送服务注册/更新请求消息时，需要携带interPlmnFqdn、plmnList、allowedPlmns，具体说明参见下表。信元说明interPlmnFqdn用于跨PLMN服务发现时作为服务发现的结果返回给跨PLMN的对端网元。plmnList异网漫游时一个运营商可能有多个PLMN，AMF向NRF注册时应在plmnList中包含这些PLMN，否则对端NF携带target-plmn进行服务发现时，无法发现该AMF。allowedPlmnsallowedPlmns中包含签约漫游协议的其他运营商的PLMN ID，如果未携带allowedPlmns则表示任意PLMN都可支持。 
AMF需要发现其他PLMN的AMF/SMF/UDM/AUSF或UDM需要发现其他PLMN的AMF时，向NRF发送服务发现请求，消息中除原有服务发现参数外，还需携带请求NF和目的NF的PLMN ID（包括requester-plmn-list、target-plmn-list），具体说明参见下表。信元说明requester-plmn-list用于跨PLMN服务发现时，跨PLMN的NRF判断是否允许该NF进行跨PLMN服务发现。比如vAMF发现hSMF/hAUSF/hUDM时，服务发现请求中需要携带UE选择的PLMN，即共享专用网号。target-plmn-list用于跨PLMN服务发现时，本PLMN的NRF根据目的PLMN可以将请求路由到对应的SEPP，或本PLMN服务发现时，本PLMN的NRF将目的PLMN作为条件过滤目标NF。比如vAMF发现hSMF/hAUSF/hUDM时，服务发现请求中携带UE归属的PLMN，即UE的SUPI或SUCI中的PLMN。 
vAMF发现hSMF时，要求选择和拜访网络相近的hSMF。例如，当用户漫游到A省其他运营商的5G网络，需要就近选择A省的hSMF。hSMF的选择如图3所示，拜访网络和归属网络设置了本地的二级NRF流程。vAMF选择hSMF时，向NRF发送的服务发现请求消息中携带UE的位置信息（即TA，该TA中的PLMN为共享专用网号）。hSMF注册时包含拜访网络对应省份的TA List（TA List中TA的PLMN为共享专用网号），则NRF根据UE当前接入的TA信息选择就近的hSMF。归属网络的local NRF（即hL-NRF）应支持对NFprofile中的IP地址和端口等敏感信息进行删除和隐藏。图3  AMF选择hSMF 
#### 切片要求 
如果UE使用切片，那么对于切片映射的要求如下： 
UE使用标准切片（如eMBB切片），且拜访网络也支持该标准切片，S-NSSAI在不同PLMN下相同，那么拜访网络无需进行切片映射。例如：运营商A和运营商B都支持S-NSSAI为1（SST=1，SD为空）的切片，无需进行映射。 
UE使用非标准切片，或UE使用了标准切片但拜访网络不支持该标准切片，则S-NSSAI在不同PLMN下取值不同，拜访网络需进行切片映射。例如：运营商A支持S-NSSAI为1的切片（SST=1，SD为空），而运营商B对应切片的S-NSSAI为1-000000（SST=1，SD=0x000000），那么UE在运营商AB间进行异网漫游时，拜访网络需配置切片映射规则。 
对于Allowed NSSAI信息在N14接口的传递，不同的协议版本有不同的描述，如果不同的AMF按不同的协议版本实现，可能带来兼容性问题，导致流程失败，影响用户业务体验。例如，UE跨PLMN移动时，AMF（支持3GPP TS 29.518-g50即2020年9月R16以前的版本） 收到了对端AMF（支持3GPP TS 29.518-g50及后续版本）的消息，无法识别allowedHomeNssai，则不能获取UE的allowedNssai信息。AMF支持的协议版本及说明参见下表。 
支持的协议版本|说明
---|---
支持3GPP TS 29.518-g50以前的版本|AMF与同PLMN的AMF交互和与跨PLMN的AMF交互，都使用allowedNssai字段。
支持3GPP TS 29.518-g50及后续的版本|AMF与同PLMN的AMF交互时使用allowedNssai字段，与跨PLMN的AMF交互时使用allowedHomeNssai字段。
基于上述情景，5GC对异网漫游用户切片的处理要求如下。 
如果拜访网络和归属网络的S-NSSAI不同，则运营商根据漫游协议确定映射关系，由拜访网络的AMF或NSSF配置切片映射规则。 
UE在跨PLMN的移动过程中，vAMF和hAMF之间的N14接口需要支持3GPP TS 29.518-g50及后续版本，跨PLMN传递UeContext时采用allowedHomeNssai传递网络切片标识。UE从归属网络移动到拜访网络，vAMF和vNSSF根据获得的allowedHomeNssai进行切片映射。 
#### 跨PLMN订阅 
跨PLMN的订阅/订阅更新和去订阅涉及的NF及架构如[图1](1669172318919.html#z18f231300a97468596c2988909f60c22__cde4f592-fc84-4673-a50c-eeee91b67af2)所示。
图1  跨PLMN订阅架构
[]images/7411f7ca838447cc956bf70cd6c1b133.png)
vNF在跨PLMN服务发现hNF后，本地缓存了hNF的NFPROFILE信息。为了感知hNF属性变更及状态变更，vNF需要订阅hNF。订阅及更新订阅的主要过程如下： 
跨PLMN订阅消息，由vNF发起，通过vL-NRF、vI-NRF、vSEPP、hSEPP、hI-NRF转发，最终由hL-NRF创建订阅事件。 
订阅有效期到期前，vNF可对已创建的订阅信息进行更新。跨PLMN更新订阅消息，由vNF发起，通过vI-NRF、vSEPP、hSEPP、hI-NRF转发，最终由hL-NRF更新订阅。 
当hNF状态/属性发生变更后，由hL-NRF发起通知消息，通过hSEPP、vSEPP转发，发送给vNF。 
当vNF无需订阅hNF时，可以发起去订阅。去订阅的主要过程如下: 
当vNF清理hNF信息后，vNF可对已创建的订阅信息进行去订阅。跨PLMN去订阅消息，由vNF发起，通过vI-NRF、vSEPP、hSEPP、hI-NRF转发，最终由hL-NRF删除订阅。 
#### 安全边缘保护 
##### 互通接口 
不同运营商核心网的信令面通过SEPP之间的N32接口互通。互通接口如[图1](1669172357818.html#z795ea880c5b64bc481d5a4fb17a915f9__f1808705-106a-4ca7-b859-81187d587363)所示。
图1  互通接口
[]images/90a6cf208bc5455da0e790090720a240.png)
N32接口逻辑上分为两个接口N32-c和N32-f，具体说明如下。 
N32-c：SEPP之间的控制平面接口，用于执行初始握手消息交互、安全保护协商、参数交换，实现N32接口信令消息转发，完成初始交互流程。 
N32-f：SEPP之间的消息转发接口，用于在进行安全保护协商之后转发NF服务消费者和NF服务提供者之间的信令消息。 
对于N32-f接口的消息转发，两个SEPP需要进行安全保护协商，选择同一种安全机制。目前有TLS传输层加密和PRINS应用层加密两种安全传输方式： 
协商使用TLS，用于SEPP直连场景。SEPP间直接建立端到端TLS连接进行信令转发，不需要重新对HTTP应用层消息进行封装。 
协商使用PRINS，用于IPX场景。SEPP将对消息重新进行封装，N32-f消息经过IPX代理转接，IPX代理也可能修改HTTP消息。 
在本方案中，SEPP之间的N32接口采用直连模式： 
不同运营商的SEPP之间经过BG相连，在互通链路上运营商可根据自身策略在SEPP侧的交换机上部署防火墙。 
拜访网络的SEPP与归属网络的SEPP间采用TLS进行传输层加密，SEPP间直接建立端到端的TLS连接进行信令转发，SEPP之间不部署IPX。 
##### 安全协商 
安全协商内容包括两部分内容： 
是否支持TLS链路在5G核心网漫游架构下，若SEPP之间需要启用TLS安全保护模式，则SEPP预先静态配置安全参数，通过静态配置的方式完成安全协商。SEPP支持静态HTTP链路或动态HTTP链路，SEPP之间推荐使用静态HTTP链路，SEPP与NF之间推荐使用动态HTTP链路。 
是否支持3GPP-Sbi-Target-apiRootSEPP支持配置向指定运营商的SEPP发送消息中是否携带3GPP-Sbi-Target-apiRoot，接收消息可自适应支持3GPP-Sbi-Target-apiRoot。当SEPP接收到跨PLMN的请求消息，如果消息中携带3GPP-Sbi-Target-apiRoot，则通过3GPP-Sbi-Target-apiRoot中的地址进行路由，如果消息中未携带3GPP-Sbi-Target-apiRoot，则通过URI中的地址进行路由。当SEPP发送消息到指定运营商时，根据配置决策是否启用3GPP-Sbi-Target-apiRoot，如果配置开启，则使用3GPP-Sbi-Target-apiRoot携带目标NF地址，URI中携带对端SEPP的FQDN，如果配置为不开启，则在URI中携带目标NF的FQDN。 
##### 安全校验 
SEPP支持信令安全校验，功能包括： 
接口黑白名单可以通过路由转发策略配置仅允许转发漫游场景下开通的接口操作，屏蔽其他接口操作。 
操作黑白名单对接口白名单中不适用于漫游场景的操作进行屏蔽，如限制UDM接口获取非漫游所需签约信息。 
信令防欺诈支持本端PLMN ID校验和对端PLMN ID校验两种方式，用于检查业务信令中携带的FQDN、PLMN ID等参数的一致性。 
扩展信令屏蔽屏蔽HTTP信令中特定参数，如HTTP消息头参数，消息体中的业务参数等。 
SEPP安全校验的主要场景包括： 
本端安全校验本端SEPP从对端接收请求消息，校验消息中目的NF的PLMN ID是否与本端PLMN ID一致。 
对端安全校验接收侧校验：SEPP接收上一跳请求消息时判断消息的源PLMN ID与上一跳NF或SEPP的PLMNID是否一致。发送侧校验：SEPP往下一跳节点发送消息前判断消息中目的NF的PLMN ID与对端是否一致。 
信令屏蔽接收跨PLMN的请求消息，匹配本地配置的屏蔽规则，若符合屏蔽规则，则按照配置丢弃或者发起错误响应。 
##### 拓扑隐藏 
SEPP向对端SEPP发送消息前通过拓扑隐藏将信令中的FQDN信息或其他重要网络信息（如号段、IP地址等）进行转换、修改或替换，避免暴露给其他运营商。具体功能包括： 
删除指定HTTP字段适用于不影响业务的HTTP头字段。 
将指定信息加密后放入FQDN将待隐藏的FQDN或IP地址使用AES_256_GCM加密，转换为二进制密文（非字符串格式，不可读）后，通过BASE32编码将二进制密文转换为字符串。 
将指定的FQDN映射为多个FQDN 
将IP地址映射为隐藏后的FQDN归属网络方的SEPP（hSEPP）将smcontextRef中的IP地址替换为标识hSMF的FQDN。归属网络方的SEPP（hSEPP）对location信元内apiRoot的IP地址做拓扑隐藏，替换为隐藏后的FQDN。 
拓扑隐藏主要场景包括： 
pSEPP返回服务发现响应时，对NF的FQDN进行隐藏处理。pSEPP收到后续业务请求时，对FQDN进行还原。 
cSEPP发出跨域业务请求时，对Callback URI中的FQDN信息进行隐藏。cSEPP收到后续通知消息时，对FQDN进行还原。 
pSEPP发出跨域业务响应时，对Location头域中的FQDN信息进行隐藏。pSEPP收到后续业务请求时，对FQDN进行还原。 
cSEPP/pSEPP跨域发送业务消息时，删除Via头域中其他NF/SCP相关信息，只保留SEPP的信息。 
#### 计费要求 
Home Routed漫游架构中，hSMF和vSMF提供QBC计费功能，支持根据不同5QI流量生成不同的计费话单，架构如[图1](1669172446373.html#z6da977d221284298b44d7bad4493370c__a60bf94f-9978-4a12-bee5-c2371c7880f2)所示。
图1  HR漫游计费架构
[]images/509aae300a964eac99194710a561a394.png)
针对漫入用户，vSMF采用QBC计费模式，仅支持离线计费。vSMF生成计费消息，携带CHF-CDR话单给本地配置的vCHF，与异网漫游运营商进行结算。 
针对漫出用户，hSMF支持FBC和QBC计费能力，可以基于市场策略灵活选择。但是由于QBC计费不支持ULCL分流等多U场景，当hSMF采用QBC计费模式，用户从异网漫游回归属网络，且会话一直未下线时，如果需要触发分流业务，则需要重建会话。 
QBC模式和FBC模式支持的计费类型不同，具体说明如下： 
QBC模式下，hSMF基于QoS流统计计费信息，仅支持离线计费，不支持在线计费和内容计费。 
FBC模式下，hSMF基于RG统计计费信息，支持离线计费、在线计费和内容计费。离线计费场景下，hSMF生成计费消息，生成并发送CHF-CDR话单给本地配置的hCHF；在线计费场景下，SMF生成计费消息，和hCHF进行交互，实现在线计费。 
Charging Id是话单中的关键字段，在每一个PDU会话建立（包括I-SMF插入的情况）时，由处理会话建立初始请求的SMF产生。Charging Id在PDU会话的整个生命周期中进行传递并保持不变。 
当会话在归属网络中初始建立（包括I-SMF插入的情况）时，Charging Id由hSMF产生。当UE从归属网络移动到拜访网络，不存在I-SMF时，vSMF向hSMF获取SMContext，其中包含Charging Id。当UE从归属网络移动到拜访网络，存在I-SMF时，vSMF向I-SMF获取SMContext，其中不包含Charging Id，在后续vSMF向hSMF发起的会话更新请求过程中，hSMF将Charging Id通过homeProvidedChargingId参数传递给vSMF。 
当会话在拜访网络中初始建立时，Charging Id由vSMF产生传递给hSMF，vSMF产生Charging Id包含VPLMN的PLMN ID。 
在同一PLMN内发生vSMF改变时或不同PLMN间发生vSMF改变时，Charging Id从老的vSMF传递给新的vSMF。 
### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|23.501|system architecture for the 5g system
23.502|3GPP|procedures for the 5g system
29.500|3GPP|technical realization of service based architecture
29.502|3GPP|session management services
29.503|3GPP|unified data management services
29.510|3GPP|network function repository services
29.525|3GPP|ue policy control service
29.531|3GPP|network slice selection services
29.573|3GPP|5g system; public land mobile network (plmn) interconnection
32.255|3GPP|5g data connectivity domain charging
32.291|3GPP|5g system, charging service
行业标准|-|5G异网漫游_核心网漫游总体技术要求
## 无SCP的SEPP多对多组网 
### 场景说明 
5G异网漫游场景需要部署SEPP作为边界网关，当用户漫游到归属运营商网络以外的地区时，可以通过SEPP进行信令消息转发，SEPP在信令消息转发过程中对消息进行拓扑隐藏，用户可以继续使用5G通信服务。 
在无SCP的SEPP异网漫游组网场景中，NF与SEPP直连，SEPP路由方式为3gpp-Sbi-Target-apiroot方式，且两个PLMN间的SEPP按多对多进行不对等部署。
### 客户收益 
客户收益参见下表。 
受益方|受益描述
---|---
终端用户|用户跨PLMN漫游时无需换卡，不感知网络变化。
运营商|节省投资：通过异网漫游方式，共享其他运营商的网络。增加收益：通过对其他运营商用户提供业务，提高网络使用效率，增加收益。提高用户业务体验：使用户在归属运营商无5G网络覆盖的地区，可继续使用5G通信服务。
### 实现原理 
#### 组网说明 
5GC异网漫游架构下的无SCP的SEPP多对多组网如[图1](1668738012846.html#z5dd1dbaa70d44adba683241d00504bde__5fef5e12-6ccb-488d-a182-9c32ab573857)所示。
图1  无SCP的SEPP多对多组网
[]images/eba5b05d40564967a07b9d44ab47f45a.png)
该组网方式的说明如下。 
运营商之间的SEPP部署A运营商按2个节点，每个节点部署2对SEPP及I-NRF。B运营商在每个省份都部署1对SEPP，但是仅在1个省份部署1对I-NRF。非对等节点/大区间的SEPP交叉互联，A运营商的SEPP将服务发现消息直接发到B运营商中有I-NRF的省份的SEPP，将5GC业务消息按照B运营商的省份信息直接送到B运营商对应省份的SEPP。 
运营商内部的SEPP部署A运营商2个节点之间的SEPP或2个大区之间的SEPP互通，转发相关的跨节点/大区信令。B运营商省份之间的SEPP不互联，异网漫游业务服务消息由异网SEPP直接路由到对应省份的SEPP处理，异网漫游服务发现请求消息则由异网SEPP寻址到部署了I-NRF的省份的SEPP处理。每一节点/大区的SEPP仅与本节点/大区管辖省份的5GC、I-NRF对接，不与跨节点/大区省份的5GC网元、I-NRF对接。 
NRF部署I-NRF关口局负责异网漫游互通，隐藏网内拓扑，简化组网对接，每个I-NRF和该运营商网内所有L-NRF对接。 
#### 各NF/网元作用 
5G异网漫游涉及的NF/网元作用参见下表。 
NF/网元名称|网元作用
---|---
AMF|归属AMF将包含共享专用网号的EPLMN列表下发至终端。拜访AMF将包含用户归属网络移动网号的EPLMN列表下发至终端和无线接入网。当UE未使用其共享专用网号接入漫游网络，拜访AMF会拒绝用户接入。支持跨PLMN的NF发现，当跨PLMN发现hSMF时，需要携带UE当前接入的TA。UE在跨PLMN的移动过程中，传递UeContext时采用allowedHomeNssai传递网络切片标识。
AUSF|对漫出用户进行鉴权。
UDM|对漫出用户进行接入控制。
PCF|为5G异网漫游用户提供特殊的QoS和计费策略。
SMF|支持N1会话管理功能，N2会话管理功能，负责会话的建立、更新、释放。支持vSMF功能，可以识别和处理N16和N38接口信令消息。支持N4用户面管理功能，选择合适的vUPF以及PSA UPF插入会话。支持用户数据管理，向UDM获取签约信息，并注册会话。支持VPLMN QoS协商以及计费策略的管理。
UPF|为5G异网漫游用户提供用户数据转发功能。
NRF|提供跨PLMN的NF发现功能。提供跨PLMN的NF订阅功能。NRF具体的功能实现参见NF服务管理功能。
NSSF|支持切片映射功能。
SEPP|不同运营商在网络边界部署SEPP进行信令面数据互通，SEPP功能如下：接收来自NF的所有服务层消息，并在消息从N32接口发出之前对其进行保护。接收N32接口上的所有消息，并在验证安全性后将其转发到相应的NF。为两个不同PLMN的两个NF之间交换的所有服务层信息实现应用层安全保护。SEPP具体的功能实现参见SEPP功能。
MME/SGSN|归属MME/SGSN将包含共享专用网号的EPLMN列表下发至终端。
RAN|5G无线接入网络，在5G异网漫游场景中的功能如下：支持广播多个PLMN。支持VoNR。
UE|支持5G接入的终端，在5G异网漫游场景中的功能如下：支持异网漫游频段的搜网。支持接入5G核心网，及对5G核心网进行能力上报。支持5G系统间互操作（如：4/5G互操作）、5G系统内互操作（如：异网漫游）等。不支持VoNR的终端，应结合用户标识和拜访网络的PLMN ID禁止接入拜访地的5G网络。
##### SEPP功能 
###### SEPP路由功能 
####### 概述 
NF针对目标网元地址为其他运营商地址的信令消息，将信令消息路由至SEPP，SEPP负责PLMN间信令的路由转发。在SEPP对等或不对等组网场景下，跨PLMN信令的路由有基于Request URI的路由方式及基于3gpp-Sbi-Target-apiRoot的路由方式两种，具体路由流程如下。 
####### 基于Request URI的路由方式 
图1  基于Request URI的路由方式
[]images/9a725d1042a6497287c0e615ebd3f2ee.png)
 说明： 
本场景中，NF到SEPP的路由不支持3gpp-Sbi-Target-apiRoot，SEPP间的路由不支持3gpp-Sbi-Target-apiRoot，NF和SEPP都使用目的URI进行路由。 
流程说明如下： 
NF服务消费者向cNRF发起服务发现请求消息。 
cNRF将消息转发到cSEPP，消息的Request URI中携带异网pNRF的FQDN。 
cSEPP和pSEPP此前已经完成了TLS链路的建立。cSEPP接收到cNRF的服务发现请求消息后，根据Request URI中的pNRF FQDN路由分析得到下一跳的pSEPP地址，将消息转发给pSEPP。 
pSEPP接收消息后根据pNRF的FQDN进行路由分析将消息转发到目的NF（pNRF）。 
pNRF返回服务发现响应消息，响应消息中携带NF服务提供者的FQDN。pNRF将服务发现响应消息原路返回到pSEPP。 
pSEPP将服务发现响应转发到cSEPP。 
cSEPP将服务发现响应消息发送到cNRF。 
cNRF将服务发现响应消息发送到NF消费者。 
NF消费者根据服务发现的结果发起业务请求消息到cSEPP。 
cSEPP将业务请求消息发送到pSEPP。 
pSEPP将消息发送到NF服务提供者。 
####### 基于3gpp-Sbi-Target-apiRoot的路由方式 
图2  基于3gpp-Sbi-Target-apiRoot的路由方式
[]images/f43ff4ecd8044b959c0fa6a1f9dd97e5.png)
 说明： 
本场景中，NF和SEPP使用3gpp-Sbi-Target-apiRoot携带NF地址，通过3gpp-Sbi-Target-apiRoot进行消息路由转发。 
流程说明如下： 
NF消费者向cNRF发起服务发现请求消息。 
cNRF将消息转发到cSEPP，消息的Request URI中携带下一跳节点的FQDN，3gpp-Sbi-Target-apiRoot头域中携带目的NF（即pNRF）的FQDN。 
cSEPP接收到cNRF的服务发现请求消息后，完成和pSEPP之间的TLS链路建立。 
cSEPP根据3gpp-Sbi-Target-apiRoot头域中携带目的NF（即pNRF）的FQDN路由分析得到下一跳的pSEPP地址，将消息转发给pSEPP。 
pSEPP接收消息后根据pNRF的FQDN进行路由分析将消息转发到目的NF（即pNRF）。 
pNRF向pSEPP返回服务发现响应消息，响应消息中携带NF服务者的FQDN。 
pSEPP将服务发现响应消息返回cSEPP。 
cSEPP将服务发现响应消息返回cNRF。 
cNRF将服务发现响应消息返回NF消费者。 
NF消费者根据服务发现的结果发起业务请求消息给cSEPP。 
cSEPP将业务请求消息发送给pSEPP。 
pSEPP将业务请求消息发送给NF服务者。 
###### SEPP拓扑隐藏功能 
####### 概述 
SEPP向对端SEPP发送消息前通过拓扑隐藏将信令中的FQDN信息或其他重要网络信息（如号段、IP地址等），进行转换、修改或替换，避免暴露给其他运营商。 
 说明： 
在下面的流程中，当SEPP对x信息进行拓扑隐藏时，隐藏后的信息用x`表示。 
####### 服务发现隐藏 
当pSEPP返回NRF服务发现响应时，对NF的FQDN进行隐藏处理。当pSEPP收到cSEPP发送的后续业务请求消息时进行拓扑还原处理。 
信令流程图如[图1](1669278443279.html#zc8d9fcbfdbd346bfa11df50def9f7b93__0f199f3d-67cd-4d50-852a-8fca0fcf7f4a)所示。
图1  服务发现隐藏流程
[]images/1dd4a0ce96df4fa0a2ec4258c28bb1fe.png)
流程说明如下： 
服务消费者cNF向cNRF发起服务发现请求消息。 
cNRF将消息转发到cSEPP。 
cSEPP经过路由分析将消息转发给异网的pSEPP。 
pSEPP将服务发现请求消息发送到pNRF。 
pNRF执行服务发现请求操作，将服务发现响应消息返回给pSEPP，消息中包含了服务发现结果pNF。 
pSEPP接收消息后执行服务发现的拓扑隐藏操作，对pNF进行拓扑隐藏，将其隐藏为pNF`。 
pSEPP将拓扑隐藏后的服务发现响应消息返回给cSEPP。 
cSEPP将服务发现响应消息原路返回给cNRF。 
cNRF将服务发现响应消息返回到cNF。 
cNF接收到服务发现响应消息后，获取到目的NF地址pNF`，将其作为服务请求消息的目的NF，向其发起服务请求，消息到达cSEPP。 
cSEPP将服务请求消息转发到pSEPP，消息中携带的3gpp-Sbi-Target-apiRoot为pNF`。 
pSEPP收到服务请求消息后进行拓扑还原，将pNF`还原为pNF。 
pSEPP将服务请求消息发送到pNF。 
####### Callback隐藏 
cNF跨PLMN向其他NF发送业务请求，cSEPP转发业务请求时对Callback URI中的FQDN信息进行隐藏。当CSEPP收到pSEPP回复的业务响应消息时，对Callback URI中的FQDN信息进行还原。 
信令流程图如[图2](1669278443279.html#zc8d9fcbfdbd346bfa11df50def9f7b93__7aecfb02-b772-4443-9a27-22b1e4c26569)所示。
图2  Callback隐藏流程
[]images/81ecff524a304656b4e71ebc96c05ab3.png)
流程说明如下： 
本流程接续服务发现隐藏流程，pSEPP已经将服务发现响应消息中的pNF隐藏为pNF`。 
cNF获取到的是拓扑隐藏后的pNF`。 
cNF向cSEPP发送服务请求消息，消息中携带的CallbackURI为cNF，且携带隐藏后的目的pNF`。 
cSEPP对消息中的CallbackURI进行隐藏，将cNF隐藏为cNF`。 
cSEPP将消息转发给pSEPP，消息中CallbackURI为cNF`，目的NF为pNF`。 
pSEPP收到消息，对monitoredResourceUri进行还原。 
pSEPP将服务请求消息发送到pNF，消息中CallbackURI为cNF`。 
pNF接收服务请求消息后返回服务响应消息。 
pNF需要向cNF发送服务通知消息，先将消息发送至pSEPP，此消息中的3gpp-Sbi-Target-apiRoot为cNF`。 
pSEPP将服务通知消息发送到cSEPP。 
cSEPP需要将此消息中的目的NF进行拓扑还原，将cNF`还原为cNF。 
cSEPP将服务通知消息发送到cNF。 
####### 响应消息隐藏 
pSEPP收到跨PLMN的业务请求消息，当向cSEPP回复业务响应消息时，对Location头域中的FQDN信息进行隐藏。后续pSEPP收到cSEPP发送的业务请求消息时，对Location头域中的FQDN信息进行还原。 
信令流程图如[图3](1669278443279.html#zc8d9fcbfdbd346bfa11df50def9f7b93__e62a0bc5-895a-4d72-a3c2-3f956d46cd93)所示。
图3  响应消息隐藏流程
[]images/7eed2536dc394bc6a0ec51b131da973c.png)
流程说明如下： 
cNF向cSEPP发起服务请求消息。 
cSEPP将此服务请求消息转发到pSEPP。 
pSEPP将服务请求消息发送到本网的目的pNF。 
pNF进行服务请求消息处理后向pSEPP回复响应消息，响应消息中携带Location头域，Location头域内容为pNF1。 
pSEPP接收到服务响应消息后进行拓扑隐藏，将Location头域中的pNF1隐藏为pNF1`。 
pSEPP将隐藏后的服务响应消息发送到cSEPP。 
cSEPP将服务响应消息转发到cNF。 
cNF接收到服务响应消息后，根据消息中的Location头域发起后续服务请求消息，请求消息的3gpp-Sbi-Target-apiRoot=pNF1`。 
cSEPP接收到cNF发起的服务发现请求消息，根据3gpp-Sbi-Target-apiRoot的pNF1`将其路由到pSEPP。 
pSEPP接收到服务请求消息后，将pNF1`拓扑还原为pNF1。 
pSEPP将拓扑还原后的请求消息转发到目的pNF1。 
###### SEPP安全校验及安全屏蔽流程 
####### 本端安全校验 
本端SEPP接收到对端SEPP发送的业务请求消息时，会校验消息中的目的NF的PLMN ID是否与本端的PLMN ID一致，若校验不通过，则丢弃消息或回复错误响应消息给对端SEPP。 
信令流程如[图1](1669278512500.html#zaf437662617a4d00b02c890721830176__05d7bab5-6ba5-4811-9845-885d59f9d1ff)所示。
图1  本端安全校验
[]images/3895e372473b4bb68b84ffdb064d9736.png)
流程说明如下： 
cNF向cSEPP转发跨PLMN的服务请求消息。 
cSEPP将此服务请求消息转发到pSEPP。 
pSEPP接收到服务请求消息后对请求消息中的目的FQDN进行PLMN ID的校验，若消息中目的FQDN的PLMN ID与pSEPP的PLMN ID不一致，则校验不通过，pSEPP直接丢弃该消息或者回复错误响应。 
（可选）若校验不通过，pSEPP向cSEPP返回失败响应消息，失败码为403 Forbidden。 
（可选）cSEPP向cNF返回失败响应消息，失败码为403 Forbidden。 
pNF向pSEPP发送跨PLMN的服务请求消息。 
pSEPP将此请求消息转发到cSEPP。 
cSEPP接收到服务请求消息后对请求消息中的目的FQDN进行PLMN ID的校验，若消息中目的FQDN的PLMN ID与cSEPP的PLMN ID不一致，则校验不通过，cSEPP直接丢弃该消息或者回复错误响应。 
（可选）若校验不通过，cSEPP向pSEPP返回失败响应消息，失败码为403 Forbidden。 
（可选）pSEPP向pNF返回失败响应消息，失败码为403 Forbidden。 
####### 对端安全校验 
接收侧校验：SEPP接收上一跳节点的请求消息时，判断消息的源PLMN ID与上一跳NF或SEPP的PLMN ID是否一致。 
转发侧校验：SEPP向下一跳节点发送消息前，判断消息中的目的NF的PLMN ID与对端PLMN ID是否一致。 
信令流程如[图2](1669278512500.html#zaf437662617a4d00b02c890721830176__1af57ae2-bbf4-4957-acef-b58e2728687b)所示。
图2  对端安全校验流程
[]images/3a58f90cde004ef8894a6e9f76efcd68.png)
流程说明如下： 
对于接收侧校验，cNF向cSEPP转发跨域服务请求消息。 
cSEPP接收到请求消息，对请求消息中的源PLMN ID与cNF的PLMN ID进行校验，若校验不通过，丢弃或者回复错误响应消息。 
（可选）若校验不通过，cSEPP给cNF返回失败响应消息，失败码为403 Forbidden。 
对于转发侧校验，cNF向cSEPP发送服务请求消息。 
cSEPP将服务请求消息转发到pSEPP。 
pSEPP接收到服务请求消息后对请求消息中的目的FQDN进行PLMN ID的校验，若消息中目的FQDN的PLMN ID与cSEPP的PLMN ID不一致，则校验不通过，直接丢弃或者回复错误响应。 
（可选）若校验不通过，pSEPP向cSEPP返回失败响应，失败码为403 Forbidden。 
（可选）cSEPP向cNF返回失败响应。 
####### 信令屏蔽 
当SEPP接收到跨PLMN的请求消息时，匹配本地配置的屏蔽规则，若符合屏蔽规则，则按照配置丢弃消息或者发送错误响应给对端SEPP。 
以cSEPP的信令屏蔽为例，信令流程如[图3](1669278512500.html#zaf437662617a4d00b02c890721830176__ac0763a1-5c93-42e1-bf2d-3ba9719bdbc3)所示。
图3  信令屏蔽流程
[]images/dbe8a072f32a49a5a55e314b1654333c.png)
流程说明如下： 
pSEPP向cSEPP发送服务请求消息。 
cSEPP查询本地配置的屏蔽规则。 
（可选）若符合屏蔽规则，cSEPP向pSEPP返回屏蔽失败错误响应，失败码为400 Bad Request或配置的其它错误码。 
##### NF服务管理功能 
###### NF服务注册和更新功能 
5G异网漫游场景下，AMF/SMF/UDM/AUSF向NRF发送服务注册/更新请求消息时，需要携带interPlmnFqdn、plmnList、allowedPlmns。 
信令流程图如[图1](1669279391965.html#z3d004269e81b44e5a4583fa8bb51b2bf__108432f8-f922-4001-ae71-21115a5e4f0c)所示。
图1  NF注册/更新流程
[]images/1db78802d1a14085a342d5b526589646.png)
流程说明如下。 
AMF/SMF/UDM/AUSF向NRF发送NF注册请求/NF更新请求消息，除了在本PLMN内注册所需的信息，还包括如下字段。 
interPlmnFqdn：跨PLMN进行服务发现时，作为服务发现结果返回给跨PLMN的对端网元。 
plmnList：异网漫游场景下，一个运营商可能有多个PLMN，AMF向NRF注册时应在plmnList中包含这多个PLMN，否则对端NF携带target-plmn进行服务发现时，会无法发现。 
allowedPlmns：allowedPlmns中包含签约了漫游协议的其他运营商的PLMN ID，如果未携带allowedPlmns则表示支持任意PLMN的NF发现本NF。 
NFR返回NF注册响应/NF更新响应。 
###### NF服务发现功能 
####### 概述 
5G异网漫游场景下，涉及发现其他PLMN下的NF，包括： 
vAMF发现AUSF 
vAMF发现UDM 
vAMF发现hSMF 
vAMF发现hAMF 
hAMF发现vAMF 
UDM发现vAMF 
####### vAMF发现AUSF 
UE在拜访地接入5G网络，需对UE进行鉴权时，vAMF使用SUPI发现AUSF。 
图1  vAMF查找AUSF
[]images/55c2dfb84688481188a8e2c0c05b54d9.png)
流程说明如下： 
vAMF需要对UE进行鉴权，则需要选择AUSF。 
vAMF给vLNRF发送Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI）消息。 
vL-NRF基于Target PLMN选择vINRF。 
vL-NRF向vINRF转发Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI）消息。 
vI-NRF基于Target PLMN选择vSEPP和hINRF。vINRF获取vSEPP地址和hINRF的FQDN。 
vI-NRF向vSEPP转发Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写hI-NRF的FQDN。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN中的PLMN选择hSEPP。 
vSEPP向hSEPP转发Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI，3gpp-Sbi-Target-apiroot）消息。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定hI-NRF。 
hSEPP向hI-NRF转发Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI）消息。 
hI-NRF基于SUPI确定hL-NRF。 
hI-NRF向hLNRF转发Nnrf_NFDiscovery Request（AUSF，requester-plmn-list，target-plmn-list，SUPI）消息。 
 说明： 
hI-NRF需要配置全网SUPI号段和hL-NRF的对应关系。 
hL-NRF根据SUPI信息，匹配到对应的AUSF List。 
hL-NRF给hINRF原路返回Nnrf_NFDiscovery Response消息，携带AUSF List信息，AUSF List中包含AUSF的Inter-PLMN FQDN信息，不包含IP信息。 
hI-NRF向hSEPP原路转发Nnrf_NFDiscovery Response（AUSF List）消息。 
 说明： 
如果hL-NRF没有隐藏IP（即携带了IP地址），则hI-NRF会把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
hSEPP将Inter-PLMN FQDN中除PLMN的部分隐藏（即仅显示PLMN，其他部分隐藏）。 
hSEPP向vSEPP原路转发Nnrf_NFDiscovery Response（AUSF List）消息。 
vSEPP向vI-NRF原路转发Nnrf_NFDiscovery Response（AUSF List）消息。 
vI-NRF向vL-NRF原路转发Nnrf_NFDiscovery Response（AUSF List）消息。 
vL-NRF向vAMF原路转发Nnrf_NFDiscovery Response（AUSF List）消息。 
####### vAMF发现UDM 
UE在拜访地接入5G网络，需获取用户签约信息时，vAMF使用SUPI发现UDM。 
图2  vAMF发现UDM
[]images/b7716def5a5342bb882f706aafdd8974.png)
流程说明如下： 
vAMF需要获取用户签约信息，则需要选择UDM。 
vAMF给vL-NRF发送Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI）消息。 
vL-NRF基于Target PLMN选择vI-NRF。 
vL-NRF向vINRF转发Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI）消息。 
vI-NRF基于Target PLMN选择vSEPP和hINRF。vI-NRF获取vSEPP地址和hI-NRF的FQDN。 
vI-NRF向vSEPP转发Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写hI-NRF的FQDN。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN中的PLMN选择hSEPP。 
vSEPP向hSEPP转发Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI，3gpp-Sbi-Target-apiroot）消息。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定hI-NRF。 
hSEPP向hI-NRF转发Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI）消息。 
hI-NRF基于SUPI确定hL-NRF。 
hI-NRF向hL-NRF转发Nnrf_NFDiscovery Request（UDM，requester-plmn-list，target-plmn-list，SUPI）消息。 
 说明： 
hI-NRF需要配置全网SUPI号段和hL-NRF的对应关系。 
hL-NRF根据SUPI信息，匹配到对应的UDM List。 
hL-NRF向hINRF原路返回Nnrf_NFDiscovery Response消息，携带UDM List信息，UDM List中包含UDM的Inter-PLMN FQDN信息，不包含IP信息。 
hI-NRF向hSEPP原路转发Nnrf_NFDiscovery Response（UDM List）消息。 
 说明： 
如果hL-NRF没有隐藏IP（即携带了IP地址），则hI-NRF会把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
hSEPP将Inter-PLMN FQDN中除PLMN的部分隐藏（即仅显示PLMN，其他部分隐藏）。 
hSEPP向vSEPP原路转发Nnrf_NFDiscovery Response（UDM List）消息。 
vSEPP向vI-NRF原路转发Nnrf_NFDiscovery Response（UDM List）消息。 
vI-NRF向vL-NRF原路转发Nnrf_NFDiscovery Response（UDM List）消息。 
vL-NRF向vAMF原路转发Nnrf_NFDiscovery Response（UDM List）消息。 
####### vAMF发现hSMF 
UE在拜访5G网络中激活PDU Session时，vAMF需要发现hSMF并选择就近的hSMF，因此发现参数包含用户当前接入TA信息。 
图3  vAMF发现hSMF
[]images/b9f92baac0814513bf296a0b3529b658.png)
流程说明如下： 
UE在拜访5G网络中激活PDU Session时，vAMF需要发现hSMF。 
vAMF向vLNRF发送Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA）消息。 
vL-NRF基于Target PLMN选择vINRF。 
vL-NRF向vI-NRF转发Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA）消息。 
vI-NRF基于Target PLMN选择vSEPP和hI-NRF。vI-NRF获取vSEPP地址和hI-NRF的FQDN。 
vI-NRF向vSEPP转发Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写hI-NRF的FQDN。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN中的PLMN选择hSEPP。 
vSEPP向hSEPP转发Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA，3gpp-Sbi-Target-apiroot）消息。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定hI-NRF。 
hSEPP向hI-NRF转发Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA）消息。 
hI-NRF基于TA确定hL-NRF。 
hI-NRF向hL-NRF转发Nnrf_NFDiscovery Request（SMF，requester-plmn-list，target-plmn-list，S-NSSAI、DNN、TA）消息。 
 说明： 
hI-NRF需要配置拜访网络的TA和hL-NRF的对应关系。 
hL-NRF根据S-NSSAI、DNN、TA等信息，匹配到对应的SMF List。 
hL-NRF给hI-NRF原路返回Nnrf_NFDiscovery Response消息，携带SMF List信息，SMF List中包含SMF的Inter-PLMN FQDN信息，不包含IP信息。 
hI-NRF向hSEPP原路转发Nnrf_NFDiscovery Response（SMF List）消息。 
 说明： 
如果hL-NRF没有隐藏IP（即携带了IP地址），则hI-NRF会把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
hSEPP将Inter-PLMN FQDN中除PLMN的部分隐藏（即仅显示PLMN，其他部分隐藏）。 
hSEPP向vSEPP原路转发Nnrf_NFDiscovery Response（SMF List）消息。 
vSEPP向vI-NRF原路转发Nnrf_NFDiscovery Response（SMF List）消息。 
vI-NRF向vL-NRF原路转发Nnrf_NFDiscovery Response（SMF List）消息。 
vL-NRF向vAMF原路转发Nnrf_NFDiscovery Response（SMF List）消息。 
####### vAMF发现hAMF 
UE从HPLMN注册更新到VPLMN或从VPLMN切换到HPLMN时，vAMF发现hAMF。注册更新流程中，vAMF使用GUAMI发现hAMF；在切换流程中，vAMF使用TA发现hAMF。 
图4  vAMF发现hAMF
[]images/af68eb023df94c0bb64ba61e31f2338a.png)
流程说明如下： 
UE从HPLMN注册更新到VPLMN或从VPLMN切换到HPLMN时，vAMF发现hAMF。注册更新流程中，vAMF使用GUAMI发现hAMF；在切换流程中，vAMF使用TA发现hAMF。 
vAMF给vLNRF发送Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
vL-NRF基于Target PLMN选择vI-NRF。 
vL-NRF向vI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
vI-NRF基于Target PLMN选择vSEPP和hI-NRF。vI-NRF获取vSEPP地址和hI-NRF的FQDN。 
vI-NRF向vSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写h-INRF的FQDN。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN的PLMN选择hSEPP。 
vSEPP向hSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA，3gpp-Sbi-Target-apiroot）消息。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定hI-NRF。 
hSEPP向hI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
hI-NRF基于GUAMI或TA确定hL-NRF。 
hI-NRF向hL-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
 说明： 
hI-NRF需要配置拜访网络的TA和hL-NRF的对应关系。 
hL-NRF根据GUAMI或TA等信息，匹配到对应的AMF List。 
hL-NRF向hI-NRF原路返回Nnrf_NFDiscovery Response消息，携带AMF List信息，AMF List中包含hAMF的Inter-PLMN FQDN信息，不包含IP信息。 
hI-NRF向hSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
 说明： 
如果hL-NRF没有隐藏IP（即携带了IP地址），则hI-NRF会把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
hSEPP将Inter-PLMN FQDN中除PLMN的部分隐藏（即仅显示PLMN，其他部分隐藏）。 
hSEPP向vSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
vSEPP向vI-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
vI-NRF向vL-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
vL-NRF向vAMF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
####### hAMF发现vAMF 
UE从VPLMN注册更新到HPLMN或从HPLMN切换到VPLMN时hAMF发现vAMF。注册更新流程中，hAMF使用GUAMI发现vAMF；在切换流程中，hAMF使用TA发现vAMF。 
图5  hAMF发现vAMF
[]images/7ac277d1706e44b08769d967a6a12fcc.png)
流程说明如下： 
UE从VPLMN注册更新到HPLMN或从HPLMN切换到VPLMN时hAMF发现vAMF。注册更新流程中，hAMF使用GUAMI发现vAMF；在切换流程中，hAMF使用TA发现vAMF。 
hAMF给hL-NRF发送Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
hL-NRF基于Target PLMN选择hI-NRF。 
hL-NRF向hI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
hI-NRF基于Target PLMN选择hSEPP和vI-NRF。hI-NRF获取hSEPP地址和vI-NRF的FQDN。 
hI-NRF向hSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写vI-NRF的FQDN。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN的PLMN选择vSEPP。 
hSEPP向vSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA，3gpp-Sbi-Target-apiroot）消息。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定vI-NRF。 
vSEPP向vI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
vI-NRF基于GUAMI或TA确定vL-NRF。 
vI-NRF向vL-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，GUAMI 或 TA）消息。 
 说明： 
vI-NRF需要配置GUAMI或TA和hL-NRF的对应关系。 
vL-NRF根据GUAMI或TA等信息，匹配到对应的AMF List。 
vL-NRF给vI-NRF原路返回Nnrf_NFDiscovery Response消息，携带AMF List信息，AMF List中包含vAMF的Inter-PLMN FQDN信息，不包含IP信息。 
vI-NRF向vSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
 说明： 
如果vL-NRF没有隐藏IP（即携带了IP地址），则vI-NRF把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
vSEPP隐藏Inter-PLMN FQDN，Inter-PLMN FQDN中的PLMN不隐藏。 
vSEPP向hSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hSEPP向hI-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hI-NRF向hL-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hL-NRF向hAMF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
####### UDM发现vAMF 
UDM需要获取漫出用户位置信息或进行T-ADS信息的查询时，UDM需要使用InstanceID/GUAMI/FQDN发现vAMF。 
图6  UDM查找vAMF
[]images/fb0aae62286146159b5605bd127486d4.png)
流程说明如下： 
UDM需要获取漫出用户位置信息或进行T-ADS信息的查询时，UDM需要使用InstanceID/GUAMI/FQDN发现vAMF。 
UDM给hL-NRF发送Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN）消息。 
hL-NRF基于Target PLMN选择hI-NRF。 
hL-NRF向hI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN）消息。 
hI-NRF基于Target PLMN选择hSEPP和vI-NRF。hI-NRF获取hSEPP地址和vI-NRF的FQDN。 
hI-NRF向hSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN，3gpp-Sbi-Target-apiroot）消息，其中3gpp-Sbi-Target-apiroot填写vI-NRF的FQDN。 
hSEPP基于3gpp-Sbi-Target-apiroot中FQDN中的PLMN选择vSEPP。 
hSEPP向vSEPP转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN，3gpp-Sbi-Target-apiroot）消息。 
vSEPP基于3gpp-Sbi-Target-apiroot中FQDN确定vI-NRF。 
vSEPP向vI-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN）消息。 
vI-NRF基于InstanceID/GUAMI/FQDN确定vL-NRF。 
vI-NRF向vL-NRF转发Nnrf_NFDiscovery Request（AMF，requester-plmn-list，target-plmn-list，InstanceID/GUAMI/FQDN）消息。 
 说明： 
vI-NRF需要配置InstanceID/GUAMI/FQDN和hL-NRF的对应关系。 
vL-NRF根据InstanceID/GUAMI/FQDN等信息，匹配到对应的AMF List。 
vL-NRF给vI-NRF原路返回Nnrf_NFDiscovery Response消息，携带AMF List信息，AMF List中包含vAMF的Inter-PLMN FQDN信息，不包含IP信息。 
vI-NRF向vSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
 说明： 
如果vL-NRF没有隐藏IP（即携带了IP地址），则vI-NRF把FQDN替换为Inter-PLMN FQDN，并删除IP，即L-NRF需要具备本地FQDN和IP隐藏功能，但在L-NRF不具备该能力时，由I-NRF最后进行隐藏处理。 
vSEPP隐藏Inter-PLMN FQDN，Inter-PLMN FQDN中的PLMN不隐藏。 
vSEPP向hSEPP原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hSEPP向hI-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hI-NRF向hL-NRF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
hL-NRF向hAMF原路转发Nnrf_NFDiscovery Response（AMF List）消息。 
###### 服务订阅功能 
NF要进行跨PLMN的服务订阅时，涉及该流程。 
图1  服务订阅
[]images/acc52e854d7541feb8c69996c4d9adfc.png)
流程说明如下。 
vNF向vL-NRF发送订阅请求，漫游订阅必须携带plmnId和reqPlmnList参数。 
vL-NRF通过plmnId查询本地配置，获取对应的vI-NRF地址后，向vI-NRF转发订阅请求。 
vI-NRF通过plmnId查询本地配置，获取对应的vSEPP地址和hI-NRF的FQDN后，向vSEPP转发订阅请求，其中携带的3gpp-Sbi-Target-apiRoot为hI-NRF的FQDN。 
vSEPP通过3gpp-Sbi-Target-apiRoot查询本地配置，将订阅请求转发至hSEPP。 
hSEPP将订阅请求固定转发给本大区的hI-NRF，同时将订阅消息中nfStatusNotificationUri字段的apiRoot进行拓扑隐藏。 
hI-NRF通过SubscrCond的NFID或AMFSET等参数，查询路由配置，将订阅请求转发至hL-NRF。 
hL-NRF根据SubscrCond创建订阅事件，并将subscriptionId及location返回给hI-NRF。 
hI-NRF将location中的apiRoot作为路由信息编码到subscriptionId中，将新生成的subscriptionId及原始location返回给hSEPP。 
hSEPP对location中的apiRoot进行拓扑隐藏，将响应返回给vSEPP。 
vSEPP将响应返回给vI-NRF。 
vI-NRF在subscriptionId中增加hPLMN前缀，并将location URI中apiRoot修改为指向vI-NRF，后续将新生成的subscriptionId及location返回给vL-NRF。 
vL-NRF将响应返回给vNF。 
###### 服务订阅更新/去订阅流程 
NF要进行跨PLMN的服务订阅更新/去订阅时，涉及该流程。 
图1  服务订阅更新/去订阅
[]images/519320e4a8c741bba98e7bd0c21eaf27.png)
流程说明如下。 
vNF向location对应的NF发送更新订阅\去订阅请求，location指向vI-NRF。 
vI-NRF删除subscriptionId中的hPLMN前缀，通过plmnId查询本地配置，获取对应的vSEPP地址和hI-NRF的FQDN。vI-NRF向vSEPP转发更新订阅\去订阅请求，其中携带的3gpp-Sbi-Target-apiRoot为hI-NRF的FQDN。 
vSEPP通过3gpp-Sbi-Target-apiRoot查询本地配置，将更新订阅\去订阅请求转发至hSEPP。 
hSEPP将订阅请求固定转发给本大区的hI-NRF。 
hI-NRF从subscriptionId中解码出hL-NRF的apiroot，并将subscriptionId替换为原始subscriptionId。hI-NRF向apiroot指向的hL-NRF转发更新订阅\去订阅请求。 
hL-NRF更新/删除订阅，并向hI-NRF返回响应。 
hI-NRF向hSEPP返回响应。 
hSEPP向vSEPP返回响应。 
vSEPP向vI-NRF返回响应。 
vI-NRF向vNF返回响应。 
###### 服务订阅通知流程 
NF要进行跨PLMN的服务订阅通知时，涉及该流程。 
图1  服务订阅通知
[]images/c313d3eb7d91465ca6b69cfec76c6522.png)
流程说明如下。 
hNF向hL-NRF发送NFPROFILE变更请求。 
hL-NRF更新本地NFPROFILE数据，向hNF返回NFPROFILE变更响应。 
hL-NRF查询订阅数据，发现vNF订阅了hNF，同时获取vNF订阅hNF时携带的nfStatusNotificationUri和reqPlmnList。 
hL-NRF通过reqPlmnList查询本地配置，获取hNF对应的hSEPP地址，向hSEPP发送变更通知请求，其中3gpp-Sbi-Target-apiRoot填写为nfStatusNotificationUri。 
hSEPP通过3gpp-Sbi-Target-apiRoot查询本地配置，将变更通知请求转发至vSEPP。 
vSEPP将请求URI中的apiRoot解码，得到vNF的地址，向vNF转发变更通知请求。 
vNF向vSEPP返回响应。 
vSEPP向hSEPP返回响应。 
hSEPP向hL-NRF返回响应。 
#### 业务流程 
##### 初始注册流程 
UE在拜访地开机接入5G无线网络，发起初始注册流程。 
图1  初始注册流程
[]images/8b07a454719a4a79ab5b25f503340424.png)
流程说明如下： 
UE发送Registration Request到RAN，消息中包含注册类型（初始注册）、用户标识（SUCI）、Requested NSSAI（可选）。 
RAN接收到消息，根据Requested NSSAI选择合适的vAMF，如果RAN无法选择到合适的vAMF，则将Registration Request发送给缺省AMF，由缺省AMF进行vAMF选择过程。 
选择完成后，RAN将Registration Request消息转发给vAMF。 
vAMF确定用户是5G异网漫游用户，如果判断UE当前接入的TA中的PLMN不是该UE对应的共享专用网号，则拒绝该用户接入。 
vAMF选择AUSF。 
vAMF触发AUSF对UE的鉴权过程以及AUSF和UE的安全模式协商过程。 
vAMF选择UDM。 
vAMF向UDM获取用户签约的切片信息。 
vAMF向UDM发送Nudm_SubscriberDataManagement_Get Request（SliceData）消息。 
UDM向vAMF返回Nudm_SubscriberDataManagement_Get Response（Subscribed NSSAI）信息。 
vAMF与vNSSF交互。 
如果vAMF发现不能服务该UE或不能触发切片映射，则vAMF向vNSSF发送Nnssf_NSSelection_Get Reqeust消息。 
vNSSF向vAMF返回Nnssf_NSSelection_Get Response（Allowed NSSAI with Mapping Info）信息。 
vAMF向UDM注册。 
vAMF向UDM发送Nudm_UEContextManagement_Registration Request消息。 
UDM向vAMF返回Nudm_UEContextManagement_Registration Response信息。 
vAMF向UDM获取用户签约的接入和移动管理信息、签约的SMF选择信息等。 
vAMF向UDM发送Nudm_SubscriberDataManagement_Get Request（AM&SMFSelectData）消息。 
UDM向vAMF返回Nudm_SubscriberDataManagement_Get Response信息。 
vAMF向UDM订阅用户签约数据改变事件，AMF向UDM发送Nudm_SubscriberDataManagement_Subscribe Request消息。 
UDM向vAMF返回Nudm_SubscriberDataManagement_Subscribe Response信息。 
如果vAMF需要建立AM策略关联，vAMF通过vNRF选择PCF。 
vAMF向vNRF发送Nnrf_NFDiscovery Request（PCF）消息，进行选择PCF的过程。 
vNRF向vAMF返回Nnrf_NFDiscovery Response（PCF List）消息。 
vAMF与vPCF交互。 
vAMF向vPCF发送Npcf_AMPolicyControl_Create Request消息。 
vPCF向vAMF返回Npcf_AMPolicyControl_Create Response消息。 
vAMF与UE之间的交互。 
vAMF向RAN发送Initial Context Setup Request消息，消息中包含NAS消息Registration Accept。Registration Accept消息中包含EPLMN、Allowed NSSAI等信息。 
EPLMN包含UE的归属网络网号。 
如果Allowed NSSAI包含了非标准切片，则非标准切片还包含对应的HPLMN S-NSSAI信息。 
RAN给UE转发NAS消息（Registration Accept消息）。 
RAN给vAMF返回Initial Context Setup Response消息。 
vAMF为UE分配新的5G-GUTI，UE向AMF返回Registration Complete消息。 
##### PDU Session建立流程（HR场景） 
UE在拜访地接入5G无线网络后，如果有语音或数据等业务需要使用，会先建立PDU Session，发起PDU Session建立流程。 
图1  PDU Session建立流程（HR场景）
[]images/589b88f77d0447c79c2d1a6bb4b31b25.png)
流程说明如下： 
UE向vAMF发送PDU Session Establishment Request消息，消息中包括：S-NSSAI、DNN、PDU Session ID、Request type、N1 SMF container（PDU Session Establishment Request）等信息。 
vAMF选择hSMF。 
vAMF选择vSMF。 
vAMF向vNRF发送Nnrf_NFDiscovery Request（SMF）消息。 
vNRF向vAMF返回Nnrf_NFDiscovery Response（SMF List）消息。 
vAMF向vSMF请求建立PDU会话。 
发送Nsmf_PDUSession_CreateSMContext Request消息请求建立PDU会话，消息中包括：SUPI、DNN、S-NSSAI、PDU Session ID、AMF ID、Request Type、N1 SM container（PDU Session Establishment Request）、User location information、Access Type、PEI，GPSI、Subscription For PDU Session Status Notification、hSMFUri等信息。 
vSMF向vAMF返回Nsmf_PDUSession_CreateSMContext Response消息。 
vSMF选择vUPF，并通知UPF创建用户面上下文。 
vSMF选择vUPF。 
vSMF向vUPF发送N4 Session Establishment Request消息，通知UPF创建用户面上下文。 
vUPF向vSMF返回N4 Session Establishment Response消息。 
vSMF向hSMF发送Nsmf_PDUSession_Create Request消息。 
（可选）hSMF选择UDM。 
向hNRF发送Nnrf_NFDiscovery Request（UDM）消息。 
hNRF向hSMF返回Nnrf_NFDiscovery Response（UDM List）消息。 
hSMF向UDM获取用户会话管理签约数据。 
hSMF向UDM发送Nudm_SDM_Get Request(SMData)消息。 
UDM向hSMF返回Nudm_SDM_Get Response(SMData)消息。 
hSMF与UDM交互。 
hSMF向UDM发送Nudm_SDM_Subscribe Request消息。 
UDM向hSMF返回Nudm_SDM_Subscribe Response消息。 
hSMF根据签约信息和本地策略，执行PDU Session鉴权/授权过程。 
（可选）hSMF选择hPCF。 
hSMF向hNRF发送Nnrf_NFDiscovery Request（PCF）消息。 
hNRF向hSMF返回Nnrf_NFDiscovery Response（PCF List）消息。 
hSMF向hPCF发送Npcf_SMPolicyControl_Create Request消息，获取UPF所需要的控制计费策略和QoS。 
hPCF向hSMF返回Npcf_SMPolicyControl_Create Response消息，hPCF会将给UPF的相关QoS控制策略、计费控制策略、UPF选择策略等信息下发给hSMF。 
hSMF选择hUPF。 
hSMF与hPCF交互。 
hSMF向hPCF发送Npcf_SMPolicyControl_Update Request消息，携带选择的UPF信息、给UE分配的IP地址。 
hPCF向hSMF返回Npcf_SMPolicyControl_Update Response消息。 
hSMF通知hUPF创建用户面上下文。 
hSMF向hUPF发送N4 Session Establishment Request消息，通知UPF创建用户面上下文。 
hUPF向hSMF返回N4 Session Establishment Response消息。 
hSMF与UDM交互。 
hSMF向UDM发送Nudm_UECM_Registration Request消息。 
UDM向hSMF返回Nudm_UECM_Registration Response消息。 
hSMF向vSMF返回Nsmf_PDUSession_Create Response消息。 
vSMF通知vUPF更新用户面上下文。 
vSMF向vUPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。 
vUPF向vSMF返回N4 Session Modification Response消息。 
vSMF向vAMF发送Namf_Communication_N1N2MessageTransfer Request消息，携带N2 PDU Session Resource Setup Request（N1 PDU Session Establishment Accept）信息。 
vAMF向vSMF返回Namf_Communication_N1N2MessageTransfer Response消息。 
创建N2 PDU会话，并建立RAN和UE之间的资源连接。 
vAMF向RAN发送N2 PDU Session Resource Setup Request（N1 PDU Session Establishment Accept）消息。 
RAN和UE根据AN-specific resource setup消息建立资源连接，同时RAN向UE转发N1 PDU Session Establishment Accept消息。 
RAN向vAMF返回N2 PDU Session Resource Setup Response消息。 
vAMF与vSMF交互。 
vAMF向vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带N2 Container，Container为RAN回复给SMF的资源建立响应，其中有RAN侧的媒体面隧道端点信息。 
vSMF向vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
vSMF通知vUPF更新用户面上下文。 
vSMF向vUPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。 
vUPF向vSMF返回N4 Session Modification Response消息。 
##### 从HPLMN到VPLMN的切换流程 
###### 从HPLMN到VPLMN的切换流程（无I-SMF和I-UPF） 
UE在HPLMN注册并激活PDU Session，且PDU Session中无I-SMF插入。当UE从HPLMN切换到VPLMN，Source RAN发起切换流程。 
图1  从HPLMN到VPLMN的切换流程（无I-SMF和I-UPF）
[]images/82aa61b0db1e4255b24509bb322a63c7.png)
流程说明如下： 
Source hRAN检测到用户需要切换到Target vRAN，给Source hAMF发送Handover Required消息，携带Handover Type、Target ID、Source To Target Transparent Container等信息。 
Source hAMF检测到Target RAN不归属Source hAMF管理，且用户从HPLMN切换到VPLMN，则Source hAMF选择Target vAMF。具体选择过程参考NF发现。 
Source hAMF给Target vAMF发送Namf_Communication_CreateUEContext Request消息，携带SUPI、Handover Type、Target ID、PDU会话列表、Source To Target Transparent Container、allowedHomeNssai等信息。 
Target vAMF选择Target vSMF。 
Target vAMF根据Target ID中的Target TA中的PLMN，以及消息中servingNetwork信息，判断用户进行了跨PLMN的切换。Target vAMF选择Target vSMF，向vNRF发送Nnrf_NFDiscovery Request（SMF）消息。 
vNRF向Target vAMF返回Nnrf_NFDiscovery Response（SMF List）消息。 
Target vAMF向Target vSMF发送Nsmf_PDUSession_CreateSMContext Request消息，携带用户位置、Target AMF ID、HoState（"PREPARING"）等信息。 
Target vSMF与hSMF交互。 
Target vSMF向hSMF发送Nsmf_PDUSession_Context Request消息。 
hSMF向Target vSMF返回Nsmf_PDUSession_Context Response消息。 
Target vSMF选择vUPF，并通知vUPF创建用户面上下文。 
Target vSMF选择vUPF。 
Target vSMF向Target vUPF发送N4 Session Establishment Request消息，通知UPF创建用户面上下文。 
Target vUPF向Target vSMF返回N4 Session Establishment Response消息。 
Target vSMF向hSMF发送Nsmf_PDUSession_Create Request消息。 
hSMF通知UPF更新用户面下行隧道信息。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF更新用户面下行隧道信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
hSMF向Target vSMF返回Nsmf_PDUSession_Create Response消息。 
Target vSMF向Target vAMF返回Nsmf_PDUSession_CreateSMContext Response消息。 
Target vAMF与Target vRAN交互。 
Target vAMF向Target vRAN发送Handover Request消息，携带Handover Type、SM N2 Information List、UE AMBR、Security Context、UE Security Capabilities等信息。 
Target vRAN向Target vAMF返回Handover Request Acknowledge消息，携带PDU Session Admitted List、Target To Source Transparent Container等信息，其中PDU Session Admmitted List包含了PDU会话ID、SM N2 Information等信息。 
Target vAMF给Target vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、SM N2 Information、HoState（"PREPARED"）等信息。 
Target vSMF与Target vUPF交互。 
Target vSMF向Target vUPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。如果该PDU Session需要数据前转，则携带T-RAN SM N3 forwarding Information list、indication to allocate DL forwarding tunnel(s) for indirect forwarding等信息。 
Target vUPF向Target vSMF返回N4 Session Modification Response消息。如果该PDU Session需要数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）Target vSMF向hSMF发送Nsmf_PDUSession_Update Request消息。如果该PDU Session需要数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）hSMF与PSA UPF交互。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。如果该PDU Session需要数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。如果该PDU Session需要数据前转，则携带UPF SM N3 forwarding Information list信息。 
（可选）hSMF向Target vSMF返回Nsmf_PDUSession_Update Response消息。如果该PDU Session需要数据前转，则携带UPF SM N3 forwarding Information list信息。 
Target vSMF向Target vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
Target vAMF向Source hAMF返回Namf_Communication_CreateUEContext Response消息，携带Target To Source Transparent Container等信息。 
Sourace hAMF通知UE向目标小区切换。 
Source hAMF向Source hRAN发送Handover Command消息。 
Source hRAN向UE发送Handover Command消息，通知UE向目标小区切换。 
Source hRAN向Target vRAN传递信息。 
如果Source hRAN有RAN Status信息需要传递，则给Source hAMF发送Uplink RAN Status Transfer消息。 
Source hAMF给Target vAMF发送Namf_Communication_N1N2MessageTransfer Request消息，转发Uplink RAN Status Transfer消息中的内容。 
Target vAMF给Source hAMF返回Namf_Communication_N1N2MessageTransfer Response消息。 
Target vAMF给Target vRAN发送Downlink RAN Status Transfer消息，转发Uplink RAN Status Transfer消息中的内容。 
UE告知Target vAMF已成功切换。 
UE切换到目标小区后，向Target vRAN发送Handover Confirm。 
Target vRAN发送Handover Notify消息给Target vAMF，通知用户已经成功切换到目标小区。 
Target vAMF通知Source hAMF用户已切换，Source hAMF开启资源保护定时器。 
Target vAMF向Source hAMF发送Namf_Communication_N2InfoNotify Request消息，通知Source hAMF用户已经切换成功。 
Source hAMF向Target vAMF返回Namf_Communication_N2InfoNotify Response消息。 
Source hAMF开启资源保护定时器。 
Target vAMF给vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、HoState（"COMPLETED"）等信息。 
vSMF通知vUPF更新用户面上下文。 
vSMF向vUPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。 
vUPF向vSMF返回N4 Session Modification Response消息。 
（可选）vSMF向hSMF发送Nsmf_PDUSession_Update Request消息。 
hSMF通知PSA UPF更新用户面上下文。 
（可选）hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。 
（可选）PSA UPF向hSMF返回N4 Session Modification Response消息。 
（可选）如果该PDU Session非直接数据前转已建立，则hSMF开启资源保护定时器。 
（可选）hSMF向vSMF返回Nsmf_PDUSession_Update Response消息。 
vSMF向Target vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。如果该PDU Session非直接数据前转已建立，则vSMF起资源保护定时器。 
处理UE发起的切换后的注册更新流程。 
Source hAMF判断资源保护定时器超时，Source hAMF通知Source hRAN释放用户上下文。 
Source hAMF判断资源保护定时器超时。 
Source hAMF给Source hRAN发送UE Context Release Command消息，通知Source hRAN释放用户上下文。 
Source hRAN给Source hAMF返回UE Context Release Complete消息。 
（可选）vSMF判断资源保护定时器超时，通知vUPF释放间接数据前转隧道资源。 
vSMF判断资源保护定时器超时。 
vSMF向vUPF发送N4 Session Modification Request消息，通知UPF释放间接数据前转隧道资源。 
vUPF向vSMF返回N4 Session Modification Response消息。 
hSMF判断资源保护定时器超时，通知PSA UPF释放间接数据前转隧道资源。 
hSMF判断资源保护定时器超时。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF释放间接数据前转隧道资源。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
###### 从HPLMN到VPLMN的切换流程（有I-SMF和I-UPF） 
UE在HPLMN注册并激活PDU Session，且PDU Session有I-SMF插入。UE从HPLMN切换到VPLMN，Source RAN发起切换流程。 
图2  从HPLMN到VPLMN的切换流程（有I-SMF和I-UPF）
[]images/1984af5b8e194e8c8948f3f42289b317.png)
流程说明如下： 
Source hRAN检测到用户需要切换到Target vRAN，给Source hAMF发送Handover Required消息，携带Handover Type、Target ID、Source To Target Transparent Container等信息。 
Source hAMF检测到Target RAN不归属自身管理，且是切换到VPLMN，Source hAMF选择vAMF。具体选择过程参考NF发现。 
Source hAMF给Target vAMF发送Namf_Communication_CreateUEContext Request消息，携带SUPI、Handover Type、Target ID、PDU会话列表、Source To Target Transparent Container、allowedHomeNssai等信息。 
（可选）Target vAMF根据Target ID中Target TA的PLMN，以及消息中servingNetwork信息，判断用户进行了跨PLMN的切换。Target vAMF选择vSMF。 
Target vAMF向vNRF发送Nnrf_NFDiscovery Request（SMF）消息。 
vNRF向Target vAMF返回Nnrf_NFDiscovery Response（SMF List）消息。 
Target vAMF向Target vSMF发送Nsmf_PDUSession_CreateSMContext Request消息，携带用户位置、Target AMF ID、HoState（"PREPARING"）等信息。 
Target vSMF与Source I-SMF交互。 
Target vSMF向Source I-SMF发送Nsmf_PDUSession_Context Request消息。 
Source I-SMF向Target vSMF返回Nsmf_PDUSession_Context Response消息。 
Target vSMF选择Target vUPF，并通知Target vUPF创建用户面上下文。 
Target vSMF选择Target vUPF。 
Target vSMF向Target vUPF发送N4 Session Establishment Request消息，通知UPF创建用户面上下文。 
Target vUPF向Target vSMF返回N4 Session Establishment Response消息。 
Target vSMF向hSMF发送Nsmf_PDUSession_Create Request消息。 
hSMF通知PSA UPF更新用户面下行隧道信息。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面下行隧道信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
hSMF向Target vSMF返回Nsmf_PDUSession_Create Response消息。 
Target vSMF向Target vAMF返回Nsmf_PDUSession_CreateSMContext Response消息。 
Target vAMF与Target vRAN交互。 
Target vAMF向Target vRAN发送Handover Request消息，携带Handover Type、SM N2 Information List、UE AMBR、Security Context、UE Security Capabilities等信息。 
Target vRAN向Target vAMF返回Handover Request Acknowledge消息，携带PDU Session Admitted List、Target To Source Transparent Container等信息，其中PDU Session Admmitted List包含了PDU会话ID、SM N2 Information等信息。 
Target vAMF给Target vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、SM N2 Information、HoState（"PREPARED"）等信息。 
Target vSMF与Target vUPF交互。 
Target vSMF向Target vUPF发送N4 Session Modification Request消息，通知Target vUPF更新用户面上下文。如果该PDU Session需要进行数据前转，则携带T-RAN SM N3 forwarding Information list、indication to allocate DL forwarding tunnel(s) for indirect forwarding等信息。 
Target vUPF向Target vSMF返回N4 Session Modification Response消息。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）Target vSMF向Source I-SMF发送Nsmf_PDUSession_UpdateSMContext Request消息。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
Source I-SMF与Source I-UPF交互。 
Source I-SMF向Source I-UPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）Source I-UPF向Source I-SMF返回N4 Session Modification Response消息。如果该PDU Session需要进行数据前转，则携带UPF SM N3 forwarding Information list信息。 
（可选）Source I-SMF向Target vSMF返回Nsmf_PDUSession_UpdateSMContext Response消息。如果该PDU Session需要进行数据前转，则携带UPF SM N3 forwarding Information list信息。 
Target vSMF向Target vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
Target vAMF向Source hAMF返回Namf_Communication_CreateUEContext Response消息，携带Target To Source Transparent Container等信息。 
Sourace hAMF通知UE向目标小区切换。 
Source hAMF向Source hRAN发送Handover Command消息。 
Source hRAN向UE发送Handover Command消息，通知UE向目标小区切换。 
Source hRAN向Target vRAN传递信息。 
如果Source hRAN有RAN Status信息需要传递，则给Source hAMF发送Uplink RAN Status Transfer消息。 
Source hAMF给Target vAMF发送Namf_Communication_N1N2MessageTransfer Request消息，转发Uplink RAN Status Transfer消息中的内容。 
Target vAMF给Source hAMF返回Namf_Communication_N1N2MessageTransfer Response消息。 
Target vAMF给Target vRAN发送Downlink RAN Status Transfer消息，转发Uplink RAN Status Transfer消息中的内容。 
UE告知Target vAMF已成功切换。 
UE切换到目标小区后，向Target vRAN发送Handover Confirm。 
Target vRAN发送Handover Notify消息给Target vAMF，通知用户已经成功切换到目标小区。 
用户切换成功，开启资源保护定时器。 
Target vAMF向Source hAMF发送Namf_Communication_N2InfoNotify Request消息，通知Source hAMF用户已经切换成功。 
Source hAMF向Target vAMF返回Namf_Communication_N2InfoNotify Response消息。 
Source hAMF开启资源保护定时器。 
Source hAMF向Source I-SMF发送Nsmf_PDUSession_ReleaseSMContext Request消息。 
Source I-SMF向Source hAMF返回Nsmf_PDUSession_ReleaseSMContext Response消息。 
Source I-SMF开启资源保护定时器。 
Target vAMF给Target vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、HoState（"COMPLETED"）等信息。 
Target vSMF通知Target vUPF更新用户面上下文。 
Target vSMF向Target vUPF发送N4 Session Modification Request消息，通知Target vUPF更新用户面上下文。 
Target vUPF向Target vSMF返回N4 Session Modification Response消息。 
（可选）Target vSMF向hSMF发送Nsmf_PDUSession_Update Request消息。 
（可选）hSMF通知PSA UPF更新用户面上下文。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
（可选）hSMF向Target vSMF返回Nsmf_PDUSession_Update Response消息。 
Target vSMF向Target vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。如果该PDU Session非直接数据前转已建立，则vSMF开启资源保护定时器。 
UE发起切换后的注册更新流程。 
Source hAMF判断资源保护定时器超时，通知Source hRAN释放用户上下文。 
Source hAMF判断资源保护定时器超时。 
Source hAMF给Source hRAN发送UE Context Release Command消息，通知Source hRAN释放用户上下文。 
Source hRAN给Source hAMF返回UE Context Release Complete消息。 
（可选）Target vSMF判断资源保护定时器超时，通知Target vUPF释放间接数据前转隧道资源。 
Target vSMF判断资源保护定时器超时。 
Target vSMF向Target vUPF发送N4 Session Modification Request消息，通知Target vUPF释放间接数据前转隧道资源。 
Target vUPF向Target vSMF返回N4 Session Modification Response消息。 
（可选）Source I-SMF判断资源保护定时器超时，通知Source I-UPF释放用户面资源。 
Source I-SMF判断资源保护定时器超时。 
Source I-SMF向Source I-UPF发送N4 Session Release Request消息，通知Source I-UPF释放用户面资源。 
Source I-UPF向Source I-SMF返回N4 Session Release Response消息。 
##### 从VPLMN到HPLMN的切换流程 
###### 从VPLMN到HPLMN的切换流程（无I-SMF和I-UPF） 
UE在VPLMN注册并激活PDU Session，且PDU Session使用HR架构。UE从VPLMN切换到HPLMN，Source RAN发起切换流程，在目标TA下无需插入I-SMF和I-UPF。 
图1  从VPLMN到HPLMN的切换流程（无I-SMF和I-UPF）
[]images/7b52ce44328a4ca9817462b22f285aa5.png)
流程说明如下： 
Source vRAN检测到用户需要切换到Target hRAN，给Source vAMF发送Handover Required消息，携带Handover Type、Target ID、Source To Target Transparent Container等信息。 
Source vAMF检测到Target hRAN不归属Source vAMF管理，且用户是由VPLMN切换到HPLMN，则Source vAMF选择Target hAMF。 
Source vAMF给Target hAMF发送Namf_Communication_CreateUEContext Request消息，携带SUPI、Handover Type、Target ID、PDU会话列表、Source To Target Transparent Container、allowedHomeNssai等信息。 
Target hAMF根据Target ID中Target TA的PLMN，以及消息中servingNetwork信息，判断用户进行跨PLMN切换，Target hAMF决定不需插入I-SMF，Target hAMF向hSMF发送Nsmf_PDUSession_CreateSMContext Request消息，携带用户位置、Target AMF ID、HoState（"PREPARING"）等信息。 
hSMF通知PSA UPF更新用户面下行隧道信息。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面下行隧道信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
hSMF向Target hAMF返回Nsmf_PDUSession_CreateSMContext Response消息。 
Target hAMF与Target hRAN交互。 
Target hAMF向Target hRAN发送Handover Request消息，携带Handover Type、SM N2 Information List、UE AMBR、Security Context、UE Security Capabilities等信息。 
Target hRAN向Target hAMF返回Handover Request Acknowledge消息，携带PDU Session Admitted List、Target To Source Transparent Container等信息，其中PDU Session Admmitted List包含了PDU会话ID、SM N2 Information等信息。 
Target hAMF给hSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、SM N2 Information、HoState（"PREPARED"）等信息。 
（可选）hSMF通知PSA UPF更新用户面上下文。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面上下文。如果该PDU Session需要进行数据前转，则携带Target RAN N3 forwarding Information list等信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。如果该PDU Session需要进行数据前转，则携带Target UPF N9 forwarding Information list等信息。 
（可选）如果该PDU Session需要进行间接数据前转，hSMF向Source vSMF返回Nsmf_PDUSession_UpdateSMContext Request消息，携带Target UPF N9 forwarding Information list等信息。 
（可选）Source vSMF与Source vUPF交互。 
Source vSMF向Source vUPF发送N4 Session Modification Request消息，携带Target UPF N9 forwarding Information list等信息。 
Source vUPF向Source vSMF返回N4 Session Modification Response消息，携带source UPF SM N3 forwarding Information list等信息。 
（可选）Source vSMF向hSMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
hSMF向Target hAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
Target hAMF向Source vAMF返回Namf_Communication_CreateUEContext Response消息，携带Target To Source Transparent Container等信息。 
Source vAMF通知UE向目标小区切换。 
Source vAMF向Source vRAN发送Handover Command消息。 
Source vRAN向UE发送Handover Command消息，通知UE向目标小区切换。 
Source vRAN向Target hRAN传递信息。 
如果Source vRAN有RAN Status信息需要传递，则给Source vAMF发送Uplink RAN Status Transfer消息。 
Source vAMF给Target hAMF发送Namf_Communication_N1N2MessageTransfer Request消息，转发Uplink RAN Status Transfer消息中的内容。 
Target hAMF给Source vAMF返回Namf_Communication_N1N2MessageTransfer Response消息。 
Target hAMF给Target hRAN发送Downlink RAN Status Transfer消息，转发Uplink RAN Status Transfer消息中的内容。 
UE通知Target hAMF用户已成功切换。 
UE切换到目标小区后，向Target hRAN发送Handover Confirm。 
Target hRAN发送Handover Notify消息给Target hAMF，通知用户已经成功切换到目标小区。 
Target hAMF通知Source vAMF用户已经切换成功，Source vAMF开启资源保护定时器。 
Target hAMF向Source vAMF发送Namf_Communication_N2InfoNotify Request消息，通知Source vAMF用户已经切换成功。 
Source vAMF向Target hAMF返回Namf_Communication_N2InfoNotify Response消息。 
Source vAMF开启资源保护定时器。 
Source vAMF与Source vSMF交互，Source vSMF开启资源保护定时器。 
Source vAMF向Source vSMF发送Nsmf_PDUSession_ReleaseSMContext Request消息。 
Source vSMF向Source vAMF返回Nsmf_PDUSession_ReleaseSMContext Response消息。 
Source vSMF开启资源保护定时器。 
Target hAMF给hSMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、HoState（"COMPLETED"）等信息。 
（可选）hSMF通知PSA UPF更新用户面上下文。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面上下文。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
hSMF向Target hAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
（可选）如果该PDU Session间接数据前转隧道已建立，则hSMF开启资源保护定时器。 
UE发起切换后的注册更新流程。 
Source vAMF判断资源保护定时器超时，通知Source NR释放用户上下文。 
Source vAMF判断资源保护定时器超时。 
Source vAMF给Source vRAN发送UE Context Release Command消息，通知Source NR释放用户上下文。 
Source vRAN给Source vAMF返回UE Context Release Complete消息。 
（可选）Source vSMF判断资源保护定时器超时，通知UPF释放间接数据前转隧道资源。 
Source vSMF判断资源保护定时器超时。 
Source vSMF向Source vUPF发送N4 Session Modification Request消息，通知UPF释放间接数据前转隧道资源。 
Source vUPF向Source vSMF返回N4 Session Modification Response消息。 
（可选）hSMF判断资源保护定时器超时，通知UPF释放间接数据前转隧道资源。 
hSMF判断资源保护定时器超时。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知UPF释放间接数据前转隧道资源。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
###### 从VPLMN到HPLMN的切换流程（有I-SMF和I-UPF） 
UE在VPLMN注册并激活PDU Session，且PDU Session使用HR架构。UE从VPLMN切换到HPLMN，Source RAN发起切换流程，且在目标TA下需要插入I-SMF和I-UPF。 
图2  从VPLMN到HPLMN的切换流程（有I-SMF和I-UPF）
[]images/380ee3b71f834c8495de13d1a80f18e7.png)
流程说明如下： 
Source vRAN检测到用户需要切换到Target hRAN，给Source vAMF发送Handover Required消息，携带Handover Type、Target ID、Source To Target Transparent Container等信息。 
Source vAMF检测到Target RAN不归属Source vAMF管理，且用户是从VPLMN切换到HPLMN，则Source vAMF选择hAMF。 
Source vAMF给Target hAMF发送Namf_Communication_CreateUEContext Request消息，携带SUPI、Handover Type、Target ID、PDU会话列表、Source To Target Transparent Container、allowedHomeNssai等信息。 
（可选）Target hAMF选择Target I-SMF。 
Target hAMF根据Target ID中Target TA的PLMN，以及消息中servingNetwork信息，判断用户进行了跨PLMN的切换。Target hAMF判断需插入I-SMF，则Target hAMF选择Target I-SMF，向hNRF发送Nnrf_NFDiscovery Request（SMF）消息。 
hNRF向Target hAMF返回Nnrf_NFDiscovery Response（SMF List）消息。 
Target hAMF选择I-SMF。Target hAMF向Target I-SMF发送Nsmf_PDUSession_CreateSMContext Request消息，携带用户位置、Target AMF ID、HoState（"PREPARING"）等信息。 
Target I-SMF与Source vSMF交互。 
Target I-SMF向Source vSMF发送Nsmf_PDUSession_Context Request消息。 
Source vSMF向Target I-SMF返回Nsmf_PDUSession_Context Response消息。 
Target I-SMF选择Target I-UPF，并通知Target I-UPF创建用户面上下文。 
Target I-SMF选择Target I-UPF。 
Target I-SMF向Target I-UPF发送N4 Session Establishment Request消息，通知Target I-UPF创建用户面上下文。 
Target I-UPF向Target I-SMF返回N4 Session Establishment Response消息。 
Target I-SMF向hSMF发送Nsmf_PDUSession_Create Request消息。 
hSMF通知PSA UPF更新用户面下行隧道信息。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面下行隧道信息。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
hSMF向Target I-SMF返回Nsmf_PDUSession_Create Response消息。 
Target I-SMF向Target hAMF返回Nsmf_PDUSession_CreateSMContext Response消息。 
Target hAMF与Target hRAN交互。 
Target hAMF向Target hRAN发送Handover Request消息，携带Handover Type、SM N2 Information List、UE AMBR、Security Context、UE Security Capabilities等信息。 
Target hRAN向Target hAMF返回Handover Request Acknowledge消息，携带PDU Session Admitted List、Target To Source Transparent Container等信息，其中PDU Session Admmitted List包含了PDU会话ID、SM N2 Information等信息。 
Target hAMF给Target I-SMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、SM N2 Information、HoState（"PREPARED"）等信息。 
Target I-SMF通知Target I-UPF更新用户面上下文。 
Target I-SMF向Target I-UPF发送N4 Session Modification Request消息，通知Target I-UPF更新用户面上下文。如果该PDU Session需要进行数据前转，则携带T-RAN SM N3 forwarding Information list、indication to allocate DL forwarding tunnel(s) for indirect forwarding等信息。 
Target I-UPF向Target I-SMF返回N4 Session Modification Response消息。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）Target I-SMF向Source vSMF发送Nsmf_PDUSession_UpdateSMContext Request消息。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
（可选）TSource vSMF通知Source vUPF更新用户面上下文。 
Source vSMF向Source vUPF发送N4 Session Modification Request消息，通知UPF更新用户面上下文。如果该PDU Session需要进行数据前转，则携带Target I-UPF N9 forwarding Information list信息。 
Source vUPF向Source vSMF返回N4 Session Modification Response消息。如果该PDU Session需要进行数据前转，则携带UPF SM N3 forwarding Information list信息。 
（可选）Source vSMF向Target I-SMF返回Nsmf_PDUSession_UpdateSMContext Response消息。如果该PDU Session需要进行数据前转，则携带UPF SM N3 forwarding Information list信息。 
Target I-SMF向Target hAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。 
Target hAMF向Source vAMF返回Namf_Communication_CreateUEContext Response消息，携带Target To Source Transparent Container等信息。 
Source vAMF通知UE向目标小区切换。 
Source vAMF向Source vRAN发送Handover Command消息。 
Source vRAN向UE发送Handover Command消息，通知UE向目标小区切换。 
Source vRAN向Target hRAN传递信息。 
如果Source vRAN有RAN Status信息需要传递，则给Source vAMF发送Uplink RAN Status Transfer消息。 
Source vAMF给Target hAMF发送Namf_Communication_N1N2MessageTransfer Request消息，转发Uplink RAN Status Transfer消息中的内容。 
Target hAMF给Source vAMF返回Namf_Communication_N1N2MessageTransfer Response消息。 
Target hAMF给Target hRAN发送Downlink RAN Status Transfer消息，转发Uplink RAN Status Transfer消息中的内容。 
UE告知Target hAMF已成功切换。 
UE切换到目标小区后，向Target hRAN发送Handover Confirm。 
Target hRAN发送Handover Notify消息给Target hAMF，通知用户已经成功切换到目标小区。 
Target hAMF通知Source vAMF用户已切换，Source vAMF开启资源保护定时器，Source vSMF开启资源保护定时器。 
Target hAMF向Source vAMF发送Namf_Communication_N2InfoNotify Request消息，通知Source vAMF用户已经切换成功。 
Source vAMF向Target hAMF返回Namf_Communication_N2InfoNotify Response消息。 
Source vAMF开启资源保护定时器。 
Source vAMF向Source vSMF发送Nsmf_PDUSession_ReleaseSMContext Request消息。 
Source vSMF向Source vAMF返回Nsmf_PDUSession_ReleaseSMContext Response消息。 
Source vSMF开启资源保护定时器。 
Target vAMF给Target I-SMF发送Nsmf_PDUSession_UpdateSMContext Request消息，携带PDU会话ID、HoState（"COMPLETED"）等信息。 
Target I-SMF通知Target I-UPF更新用户面上下文。 
Target I-SMF向Target I-UPF发送N4 Session Modification Request消息，通知Target I-UPF更新用户面上下文。 
Target I-UPF向Target I-SMF返回N4 Session Modification Response消息。 
（可选）Target I-SMF向hSMF发送Nsmf_PDUSession_Update Request消息。 
（可选）hSMF通知PSA UPF更新用户面上下文。 
hSMF向PSA UPF发送N4 Session Modification Request消息，通知PSA UPF更新用户面上下文。 
PSA UPF向hSMF返回N4 Session Modification Response消息。 
（可选）hSMF向Target I-SMF返回Nsmf_PDUSession_Update Response消息。 
Target I-SMF向Target vAMF返回Nsmf_PDUSession_UpdateSMContext Response消息。如果该PDU Session间接数据前转隧道已建立，则Target I-SMF起资源保护定时器。 
UE发起切换后的注册更新流程。 
Source vAMF判断资源保护定时器超时，通知Source NR释放用户上下文。 
Source vAMF判断资源保护定时器超时。 
Source vAMF给Source vRAN发送UE Context Release Command消息，通知Source NR释放用户上下文。 
Source vRAN给Source vAMF返回UE Context Release Complete消息。 
（可选）Target I-SMF判断资源保护定时器超时，通知Target I-UPF释放间接数据前转隧道资源。 
Target I-SMF判断资源保护定时器超时。 
Target I-SMF向Target I-UPF发送N4 Session Modification Request消息，通知Target I-UPF释放间接数据前转隧道资源。 
Target I-UPF向Target I-SMF返回N4 Session Modification Response消息。 
（可选）Source vSMF判断资源保护定时器超时，通知Source vUPF释放用户面资源。 
Source vSMF判断资源保护定时器超时。 
Source vSMF向Source vUPF发送N4 Session Release Request消息，通知Source vUPF释放用户面资源。 
Source vUPF向Source vSMF返回N4 Session Release Response消息。 
### 应用限制 
#### NRF应用限制 
I-NRF根据target PLMN查询路由配置，获取本网SEPP的地址和异网I-NRF的FQDN。支持1个PLMN配置指向多个异网I-NRF的FQDN。 
I-NRF和本网所有的L-NRF互通。 
进行NF订阅时，I-NRF对subid的编解码是根据中兴通讯特有方式实现，组网需保证订阅请求经过的I-NRF与续订阅/去订阅请求经过的I-NRF为同一厂家设备。 
### 规格指标 
NF|名称|指标
---|---|---
SEPP|支持配置的最大对等端个数|8192个
AMF|支持的最大TA个数|20万
### 版本说明 
网元|产品版本
---|---
AMF|V7.22.30
SMF|V7.22.31
AUSF/UDM|V7.21.16
SEPP|V7.22.40
NRF|V7.23.20
### 指标监控 
#### 性能统计 
AMF
AMF中需要关注的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|基于IMSI号段的用户数测量|C513520003 平均RM-REGISTERED用户数
C513520004 最大RM-REGISTERED用户数|1|基于IMSI号段的用户数测量
C513520005 平均CM-CONNECTED态用户数|1|基于IMSI号段的用户数测量
C513520006 最大CM-CONNECTED态用户数|1|基于IMSI号段的用户数测量
C513520007 平均CM-IDLE态用户数|1|基于IMSI号段的用户数测量
C513520008 最大CM-IDLE态用户数|1|基于IMSI号段的用户数测量
C513520009 平均RM-DEREGISTERED态用户数|1|基于IMSI号段的用户数测量
C513520010 最大RM-DEREGISTERED态用户数|1|基于IMSI号段的用户数测量
C513520011 平均国内漫游用户数|1|基于IMSI号段的用户数测量
C513520012 最大国内漫游用户数|1|基于IMSI号段的用户数测量
C513520013 平均国际漫游用户数|1|基于IMSI号段的用户数测量
C513520014 最大国际漫游用户数|1|基于IMSI号段的用户数测量
C513520015 平均本网区间漫游用户数|1|基于IMSI号段的用户数测量
C513520016 最大本网区间漫游用户数|1|基于IMSI号段的用户数测量
C513520017 平均语音中心注册用户数|1|基于IMSI号段的用户数测量
C513520018 最大语音中心注册用户数|1|基于IMSI号段的用户数测量
C513520019 平均数据中心注册用户数|1|基于IMSI号段的用户数测量
C513520020 最大数据中心注册用户数|1|基于IMSI号段的用户数测量
2|基于MSISDN号段的用户数测量|C513530003 平均RM-REGISTERED用户数
C513530004 最大RM-REGISTERED用户数|2|基于MSISDN号段的用户数测量
C513530005 平均CM-CONNECTED态用户数|2|基于MSISDN号段的用户数测量
C513530006 最大CM-CONNECTED态用户数|2|基于MSISDN号段的用户数测量
C513530007 平均CM-IDLE态用户数|2|基于MSISDN号段的用户数测量
C513530008 最大CM-IDLE态用户数|2|基于MSISDN号段的用户数测量
C513530009 平均RM-DEREGISTERED态用户数|2|基于MSISDN号段的用户数测量
C513530010 最大RM-DEREGISTERED态用户数|2|基于MSISDN号段的用户数测量
C513530011 平均国内漫游用户数|2|基于MSISDN号段的用户数测量
C513530012 最大国内漫游用户数|2|基于MSISDN号段的用户数测量
C513530013 平均国际漫游用户数|2|基于MSISDN号段的用户数测量
C513530014 最大国际漫游用户数|2|基于MSISDN号段的用户数测量
C513530015 平均本网区间漫游用户数|2|基于MSISDN号段的用户数测量
C513530016 最大本网区间漫游用户数|2|基于MSISDN号段的用户数测量
C513530017 平均语音中心注册用户数|2|基于MSISDN号段的用户数测量
C513530018 最大语音中心注册用户数|2|基于MSISDN号段的用户数测量
C513530019 平均数据中心注册用户数|2|基于MSISDN号段的用户数测量
C513530020 最大数据中心注册用户数|2|基于MSISDN号段的用户数测量
3|基于IMSI号段初始注册流程测量|C512800003 初始注册请求次数
C512800004 初始注册成功次数|3|基于IMSI号段初始注册流程测量
C512800005 初始注册失败次数（3-非法UE）|3|基于IMSI号段初始注册流程测量
C512800006 初始注册失败次数（5-PEI不接受）|3|基于IMSI号段初始注册流程测量
C512800007 初始注册失败次数（6-非法ME）|3|基于IMSI号段初始注册流程测量
C512800008 初始注册失败次数（7-5GS服务不允许）|3|基于IMSI号段初始注册流程测量
C512800009 初始注册失败次数（7.user-5GS服务不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800010 初始注册失败次数（11-PLMN不允许）|3|基于IMSI号段初始注册流程测量
C512800011 初始注册失败次数（12-TA不允许）|3|基于IMSI号段初始注册流程测量
C512800012 初始注册失败次数（13-该TA不允许漫游）|3|基于IMSI号段初始注册流程测量
C512800013 初始注册失败次数（15-该TA中没有合适的小区）|3|基于IMSI号段初始注册流程测量
C512800014 初始注册失败次数（15.user-该TA中没有合适的小区_用户原因）|3|基于IMSI号段初始注册流程测量
C512800015 初始注册失败次数（22-拥塞）|3|基于IMSI号段初始注册流程测量
C512800016 初始注册失败次数（27-N1模式不允许）|3|基于IMSI号段初始注册流程测量
C512800017 初始注册失败次数（72-Non 3GPP接入不允许）|3|基于IMSI号段初始注册流程测量
C512800018 初始注册失败次数（73-服务网络未授权）|3|基于IMSI号段初始注册流程测量
C512800019 初始注册建立时长（毫秒）|3|基于IMSI号段初始注册流程测量
C512800020 紧急注册请求次数|3|基于IMSI号段初始注册流程测量
C512800021 紧急注册成功次数|3|基于IMSI号段初始注册流程测量
C512800022 紧急注册失败次数（3-非法UE）|3|基于IMSI号段初始注册流程测量
C512800023 紧急注册失败次数（5-PEI不接受）|3|基于IMSI号段初始注册流程测量
C512800024 紧急注册失败次数（6-非法ME）|3|基于IMSI号段初始注册流程测量
C512800025 紧急注册失败次数（7-5GS服务不允许）|3|基于IMSI号段初始注册流程测量
C512800026 紧急注册失败次数（7.user-5GS服务不允许）|3|基于IMSI号段初始注册流程测量
C512800027 紧急注册失败次数（11-PLMN不允许）|3|基于IMSI号段初始注册流程测量
C512800028 紧急注册失败次数（12-TA不允许）|3|基于IMSI号段初始注册流程测量
C512800029 紧急注册失败次数（13-该TA不允许漫游）|3|基于IMSI号段初始注册流程测量
C512800030 紧急注册失败次数（15-该TA中没有合适的小区）|3|基于IMSI号段初始注册流程测量
C512800031 紧急注册失败次数（15.user-该TA中没有合适的小区_用户原因）|3|基于IMSI号段初始注册流程测量
C512800032 紧急注册失败次数（22-拥塞）|3|基于IMSI号段初始注册流程测量
C512800033 紧急注册失败次数（27-N1模式不允许）|3|基于IMSI号段初始注册流程测量
C512800034 紧急注册失败次数（72-Non 3GPP接入不允许）|3|基于IMSI号段初始注册流程测量
C512800035 紧急注册失败次数（73-服务网络未授权）|3|基于IMSI号段初始注册流程测量
C512800036 紧急注册建立时长（毫秒）|3|基于IMSI号段初始注册流程测量
C512800037 初始注册失败次数（10-隐式去注册）|3|基于IMSI号段初始注册流程测量
C512800038 紧急注册失败次数（10-隐式去注册）|3|基于IMSI号段初始注册流程测量
C512800039 初始注册失败次数（23-UE安全能力不匹配）|3|基于IMSI号段初始注册流程测量
C512800040 由于拥塞控制被丢弃的初始注册请求次数|3|基于IMSI号段初始注册流程测量
C512800041 初始注册失败次数（111-协议失败，未指定失败）|3|基于IMSI号段初始注册流程测量
C512800042 紧急注册失败次数（111-协议失败，未指定失败）|3|基于IMSI号段初始注册流程测量
C512800043 初始注册失败次数（111.user-协议失败，未指定_用户原因）|3|基于IMSI号段初始注册流程测量
C512800044 初始注册失败次数（62-无可用网络切片）|3|基于IMSI号段初始注册流程测量
C512800045 初始注册失败次数（27.user-N1模式不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800046 初始注册（数据中心）请求次数|3|基于IMSI号段初始注册流程测量
C512800047 初始注册（数据中心）成功次数|3|基于IMSI号段初始注册流程测量
C512800048 初始注册（数据中心）失败次数（3-非法UE）|3|基于IMSI号段初始注册流程测量
C512800049 初始注册（数据中心）失败次数（5-PEI不接受）|3|基于IMSI号段初始注册流程测量
C512800050 初始注册（数据中心）失败次数（6-非法ME）|3|基于IMSI号段初始注册流程测量
C512800051 初始注册（数据中心）失败次数（7-5GS服务不允许）|3|基于IMSI号段初始注册流程测量
C512800052 初始注册（数据中心）失败次数（7.user-5GS服务不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800053 初始注册（数据中心）失败次数（11-PLMN不允许）|3|基于IMSI号段初始注册流程测量
C512800054 初始注册（数据中心）失败次数（12-TA不允许）|3|基于IMSI号段初始注册流程测量
C512800055 初始注册（数据中心）失败次数（13-该TA不允许漫游）|3|基于IMSI号段初始注册流程测量
C512800056 初始注册（数据中心）失败次数（15-该TA中没有合适的小区）|3|基于IMSI号段初始注册流程测量
C512800057 初始注册（数据中心）失败次数（15.user-该TA中没有合适的小区_用户原因）|3|基于IMSI号段初始注册流程测量
C512800058 初始注册（数据中心）失败次数（22-拥塞）|3|基于IMSI号段初始注册流程测量
C512800059 初始注册（数据中心）失败次数（27-N1模式不允许）|3|基于IMSI号段初始注册流程测量
C512800060 初始注册（数据中心）失败次数（72-Non 3GPP接入不允许)|3|基于IMSI号段初始注册流程测量
C512800061 初始注册（数据中心）失败次数（73-服务网络未授权）|3|基于IMSI号段初始注册流程测量
C512800062 初始注册（数据中心）建立时长（毫秒）|3|基于IMSI号段初始注册流程测量
C512800063 初始注册（数据中心）失败次数（10-隐式去注册）|3|基于IMSI号段初始注册流程测量
C512800064 初始注册（数据中心）失败次数（23-UE安全能力不匹配）|3|基于IMSI号段初始注册流程测量
C512800065 初始注册（数据中心）失败次数（111-协议失败，未指定失败）|3|基于IMSI号段初始注册流程测量
C512800066 初始注册（数据中心）失败次数（111.user-协议失败，未指定_用户原因）|3|基于IMSI号段初始注册流程测量
C512800067 初始注册（数据中心）失败次数（62-无可用网络切片）|3|基于IMSI号段初始注册流程测量
C512800068 初始注册（数据中心）失败次数（27.user-N1模式不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800069 初始注册（语音中心）请求次数|3|基于IMSI号段初始注册流程测量
C512800070 初始注册（语音中心）成功次数|3|基于IMSI号段初始注册流程测量
C512800071 初始注册（语音中心）失败次数（3-非法UE）|3|基于IMSI号段初始注册流程测量
C512800072 初始注册（语音中心）失败次数（5-PEI不接受）|3|基于IMSI号段初始注册流程测量
C512800073 初始注册（语音中心）失败次数（6-非法ME）|3|基于IMSI号段初始注册流程测量
C512800074 初始注册（语音中心）失败次数（7-5GS服务不允许）|3|基于IMSI号段初始注册流程测量
C512800075 初始注册（语音中心）失败次数（7.user-5GS服务不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800076 初始注册（语音中心）失败次数（11-PLMN不允许）|3|基于IMSI号段初始注册流程测量
C512800077 初始注册（语音中心）失败次数（12-TA不允许）|3|基于IMSI号段初始注册流程测量
C512800078 初始注册（语音中心）失败次数（13-该TA不允许漫游）|3|基于IMSI号段初始注册流程测量
C512800079 初始注册（语音中心）失败次数（15-该TA中没有合适的小区）|3|基于IMSI号段初始注册流程测量
C512800080 初始注册（语音中心）失败次数（15.user-该TA中没有合适的小区_用户原因）|3|基于IMSI号段初始注册流程测量
C512800081 初始注册（语音中心）失败次数（22-拥塞）|3|基于IMSI号段初始注册流程测量
C512800082 初始注册（语音中心）失败次数（27-N1模式不允许）|3|基于IMSI号段初始注册流程测量
C512800083 初始注册（语音中心）失败次数（72-Non 3GPP接入不允许）|3|基于IMSI号段初始注册流程测量
C512800084 初始注册（语音中心）失败次数（73-服务网络未授权）|3|基于IMSI号段初始注册流程测量
C512800085 初始注册（语音中心）建立时长（毫秒）|3|基于IMSI号段初始注册流程测量
C512800086 初始注册（语音中心）失败次数（10-隐式去注册）|3|基于IMSI号段初始注册流程测量
C512800087 初始注册（语音中心）失败次数（23-UE安全能力不匹配）|3|基于IMSI号段初始注册流程测量
C512800088 初始注册（语音中心）失败次数（111-协议失败，未指定失败）|3|基于IMSI号段初始注册流程测量
C512800089 初始注册（语音中心）失败次数（111.user-协议失败，未指定_用户原因）|3|基于IMSI号段初始注册流程测量
C512800090 初始注册（语音中心）失败次数（62-无可用网络切片）|3|基于IMSI号段初始注册流程测量
C512800091 初始注册（语音中心）失败次数（27.user-N1模式不允许_用户原因）|3|基于IMSI号段初始注册流程测量
C512800092 初始注册失败次数（27.ODB-N1模式不允许_ODB原因）|3|基于IMSI号段初始注册流程测量
C512800093 紧急注册失败次数（27.ODB-N1模式不允许_ODB原因）|3|基于IMSI号段初始注册流程测量
C512800094 初始注册（语音中心）失败次数（27.ODB-N1模式不允许_ODB原因）|3|基于IMSI号段初始注册流程测量
C512800095 初始注册（数据中心）失败次数（27.ODB-N1模式不允许_ODB原因）|3|基于IMSI号段初始注册流程测量
C512800096 初始注册失败次数（76-CAG未授权或仅CAG小区授权）|3|基于IMSI号段初始注册流程测量
C512800097 紧急注册失败次数（76-CAG未授权或仅CAG小区授权）|3|基于IMSI号段初始注册流程测量
C512800098 紧急注册失败次数（111.user-协议失败，未指定_用户原因）|3|基于IMSI号段初始注册流程测量
C512800099 注册拒绝（自运行授权超时）|3|基于IMSI号段初始注册流程测量
C512800100 初始注册失败次数（9-网络无法获取终端标识）|3|基于IMSI号段初始注册流程测量
C512800101 初始注册失败次数（9-网络无法获取终端标识_用户原因）|3|基于IMSI号段初始注册流程测量
C512800102 初始注册（数据中心）失败次数（9-网络无法获取终端标识）|3|基于IMSI号段初始注册流程测量
C512800103 初始注册（数据中心）失败次数（9-网络无法获取终端标识_用户原因）|3|基于IMSI号段初始注册流程测量
C512800104 初始注册（语音中心）失败次数（9-网络无法获取终端标识）|3|基于IMSI号段初始注册流程测量
C512800105 初始注册（语音中心）失败次数（9-网络无法获取终端标识_用户原因）|3|基于IMSI号段初始注册流程测量
C512800106 初始注册失败次数（鉴权无响应）|3|基于IMSI号段初始注册流程测量
C512800107 初始注册失败次数（身份识别无响应）|3|基于IMSI号段初始注册流程测量
C512800108 初始注册失败次数（安全算法协商失败）|3|基于IMSI号段初始注册流程测量
C512800109 初始注册失败次数（PEI检查无响应）|3|基于IMSI号段初始注册流程测量
C512800110 初始注册失败次数（目标NF发现失败）|3|基于IMSI号段初始注册流程测量
4|基于IMSI号段注册更新流程测量|C512810003 移动性注册请求次数
C512810004 移动性注册成功次数|4|基于IMSI号段注册更新流程测量
C512810005 移动性注册失败次数（3-非法UE）|4|基于IMSI号段注册更新流程测量
C512810006 移动性注册失败次数（6-非法ME）|4|基于IMSI号段注册更新流程测量
C512810007 移动性注册失败次数（7-5GS服务不允许）|4|基于IMSI号段注册更新流程测量
C512810008 移动性注册失败次数（9-网络无法派生UE ID）|4|基于IMSI号段注册更新流程测量
C512810009 移动性注册失败次数（10-隐式去注册）|4|基于IMSI号段注册更新流程测量
C512810010 移动性注册失败次数（11-PLMN不允许）|4|基于IMSI号段注册更新流程测量
C512810011 移动性注册失败次数（12-TA不允许）|4|基于IMSI号段注册更新流程测量
C512810012 移动性注册失败次数（13-该TA不允许漫游）|4|基于IMSI号段注册更新流程测量
C512810013 移动性注册失败次数（15-该TA中没有合适的小区）|4|基于IMSI号段注册更新流程测量
C512810014 移动性注册失败次数（22-拥塞）|4|基于IMSI号段注册更新流程测量
C512810015 移动性注册失败次数（27-N1模式不允许）|4|基于IMSI号段注册更新流程测量
C512810016 移动性注册失败次数（72-Non 3GPP接入不允许）|4|基于IMSI号段注册更新流程测量
C512810017 移动性注册失败次数（73-服务网络未授权）|4|基于IMSI号段注册更新流程测量
C512810018 移动性注册建立时长（毫秒）|4|基于IMSI号段注册更新流程测量
C512810019 周期性注册请求次数|4|基于IMSI号段注册更新流程测量
C512810020 周期性注册成功次数|4|基于IMSI号段注册更新流程测量
C512810021 周期性注册失败次数（3-非法UE）|4|基于IMSI号段注册更新流程测量
C512810022 周期性注册失败次数（6-非法ME）|4|基于IMSI号段注册更新流程测量
C512810023 周期性注册失败次数（7-5GS服务不允许）|4|基于IMSI号段注册更新流程测量
C512810024 周期性注册失败次数（9-网络无法派生UE ID）|4|基于IMSI号段注册更新流程测量
C512810025 周期性注册失败次数（10-隐式去注册）|4|基于IMSI号段注册更新流程测量
C512810026 周期性注册失败次数（11-PLMN不允许）|4|基于IMSI号段注册更新流程测量
C512810027 周期性注册失败次数（12-TA不允许）|4|基于IMSI号段注册更新流程测量
C512810028 周期性注册失败次数（13-该TA不允许漫游）|4|基于IMSI号段注册更新流程测量
C512810029 周期性注册失败次数（15-该TA中没有合适的小区）|4|基于IMSI号段注册更新流程测量
C512810030 周期性注册失败次数（22-拥塞）|4|基于IMSI号段注册更新流程测量
C512810031 周期性注册失败次数（27-N1模式不允许）|4|基于IMSI号段注册更新流程测量
C512810032 周期性注册失败次数（72-Non 3GPP接入不允许）|4|基于IMSI号段注册更新流程测量
C512810033 周期性注册失败次数（73-服务网络未授权）|4|基于IMSI号段注册更新流程测量
C512810034 周期性注册建立时长（毫秒）|4|基于IMSI号段注册更新流程测量
C512810035 AMF内移动性注册请求次数|4|基于IMSI号段注册更新流程测量
C512810036 AMF内移动性注册成功次数|4|基于IMSI号段注册更新流程测量
C512810037 AMF间移动性注册请求次数|4|基于IMSI号段注册更新流程测量
C512810038 AMF间移动性注册成功次数|4|基于IMSI号段注册更新流程测量
C512810039 N26口的互操作流程注册请求次数|4|基于IMSI号段注册更新流程测量
C512810040 N26口的互操作流程注册成功次数|4|基于IMSI号段注册更新流程测量
C512810041 无N26接口的互操作流程注册请求次数|4|基于IMSI号段注册更新流程测量
C512810042 无N26口的互操作流程注册成功次数|4|基于IMSI号段注册更新流程测量
C512810043 移动性注册失败次数（23-UE安全能力不匹配）|4|基于IMSI号段注册更新流程测量
C512810044 由于拥塞控制被丢弃的移动性注册请求次数|4|基于IMSI号段注册更新流程测量
C512810045 由于拥塞控制被丢弃的周期性注册请求次数|4|基于IMSI号段注册更新流程测量
C512810046 N26口的互操作流程空闲态5GS到EPS移动次数|4|基于IMSI号段注册更新流程测量
C512810047 N26口的互操作流程空闲态5GS到EPS移动成功次数|4|基于IMSI号段注册更新流程测量
C512810048 AMF内移动性注册I-SMF插入请求次数|4|基于IMSI号段注册更新流程测量
C512810049 AMF内移动性注册I-SMF插入成功次数|4|基于IMSI号段注册更新流程测量
C512810050 AMF内移动性注册I-SMF不变请求次数|4|基于IMSI号段注册更新流程测量
C512810051 AMF内移动性注册I-SMF不变成功次数|4|基于IMSI号段注册更新流程测量
C512810052 AMF内移动性注册I-SMF改变请求次数|4|基于IMSI号段注册更新流程测量
C512810053 AMF内移动性注册I-SMF改变成功次数|4|基于IMSI号段注册更新流程测量
C512810054 AMF内移动性注册I-SMF删除请求次数|4|基于IMSI号段注册更新流程测量
C512810055 AMF内移动性注册I-SMF删除成功次数|4|基于IMSI号段注册更新流程测量
C512810056 AMF间移动性注册I-SMF插入请求次数|4|基于IMSI号段注册更新流程测量
C512810057 AMF间移动性注册I-SMF插入成功次数|4|基于IMSI号段注册更新流程测量
C512810058 AMF间移动性注册I-SMF不变请求次数|4|基于IMSI号段注册更新流程测量
C512810059 AMF间移动性注册I-SMF不变成功次数|4|基于IMSI号段注册更新流程测量
C512810060 AMF间移动性注册I-SMF改变请求次数|4|基于IMSI号段注册更新流程测量
C512810061 AMF间移动性注册I-SMF改变成功次数|4|基于IMSI号段注册更新流程测量
C512810062 AMF间移动性注册I-SMF删除请求次数|4|基于IMSI号段注册更新流程测量
C512810063 AMF间移动性注册I-SMF删除成功次数|4|基于IMSI号段注册更新流程测量
C512810064 N26口的互操作流程注册I-SMF插入请求次数|4|基于IMSI号段注册更新流程测量
C512810065 N26口的互操作流程注册I-SMF插入成功次数|4|基于IMSI号段注册更新流程测量
C512810066 移动性注册失败次数（111-协议失败，未指定失败）|4|基于IMSI号段注册更新流程测量
C512810067 周期性注册失败次数（111-协议失败，未指定失败）|4|基于IMSI号段注册更新流程测量
C512810068 N26口的互操作流程空闲态EPS到5GS移动次数|4|基于IMSI号段注册更新流程测量
C512810069 N26口的互操作流程空闲态EPS到5GS移动成功次数|4|基于IMSI号段注册更新流程测量
C512810070 移动性注册失败次数（27.ODB-N1模式不允许_ODB原因）|4|基于IMSI号段注册更新流程测量
C512810071 周期性注册失败次数（27.ODB-N1模式不允许_ODB原因）|4|基于IMSI号段注册更新流程测量
C512810072 移动性注册失败次数（76-CAG未授权或仅CAG小区授权）|4|基于IMSI号段注册更新流程测量
C512810073 周期性注册失败次数（76-CAG未授权或仅CAG小区授权）|4|基于IMSI号段注册更新流程测量
C512810074 移动性注册失败次数（7.user-5GS服务不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810075 移动性注册失败次数（15.user-该TA中没有合适的小区_用户原因）|4|基于IMSI号段注册更新流程测量
C512810076 移动性注册失败次数（27.user-N1模式不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810077 移动性注册失败次数（111.user-协议失败，未指定_用户原因）|4|基于IMSI号段注册更新流程测量
C512810078 周期性注册失败次数（7.user-5GS服务不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810079 周期性注册失败次数（15.user-该TA中没有合适的小区_用户原因）|4|基于IMSI号段注册更新流程测量
C512810080 周期性注册失败次数（27.user-N1模式不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810081 周期性注册失败次数（111.user-协议失败，未指定_用户原因）|4|基于IMSI号段注册更新流程测量
C512810082 移动性注册失败次数（62-无可用网络切片）|4|基于IMSI号段注册更新流程测量
C512810083 N26口的互操作流程空闲态5GS到EPS移动I-SMF删除请求次数|4|基于IMSI号段注册更新流程测量
C512810084 N26口的互操作流程空闲态5GS到EPS移动I-SMF删除成功次数|4|基于IMSI号段注册更新流程测量
C512810085 AMF内移动性注册I-SMF异常重选请求次数|4|基于IMSI号段注册更新流程测量
C512810086 AMF内移动性注册I-SMF异常重选成功次数|4|基于IMSI号段注册更新流程测量
C512810087 AMF间移动性注册I-SMF异常重选请求次数|4|基于IMSI号段注册更新流程测量
C512810088 AMF间移动性注册I-SMF异常重选成功次数|4|基于IMSI号段注册更新流程测量
C512810089 N26口的互操作注册失败次数（3-非法UE）|4|基于IMSI号段注册更新流程测量
C512810090 N26口的互操作注册失败次数（6-非法ME）|4|基于IMSI号段注册更新流程测量
C512810091 N26口的互操作注册失败次数（7-5GS服务不允许）|4|基于IMSI号段注册更新流程测量
C512810092 N26口的互操作注册失败次数（7.user-5GS服务不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810093 N26口的互操作注册失败次数（9-网络无法派生UE ID）|4|基于IMSI号段注册更新流程测量
C512810094 N26口的互操作注册失败次数（10-隐式去注册）|4|基于IMSI号段注册更新流程测量
C512810095 N26口的互操作注册失败次数（11-PLMN不允许）|4|基于IMSI号段注册更新流程测量
C512810096 N26口的互操作注册失败次数（12-TA不允许）|4|基于IMSI号段注册更新流程测量
C512810097 N26口的互操作注册失败次数（13-该TA不允许漫游）|4|基于IMSI号段注册更新流程测量
C512810098 N26口的互操作注册失败次数（15-该TA中没有合适的小区）|4|基于IMSI号段注册更新流程测量
C512810099 N26口的互操作注册失败次数（15.user-该TA中没有合适的小区_用户原因）|4|基于IMSI号段注册更新流程测量
C512810100 N26口的互操作注册失败次数（22-拥塞）|4|基于IMSI号段注册更新流程测量
C512810101 N26口的互操作注册失败次数（23-UE安全能力不匹配）|4|基于IMSI号段注册更新流程测量
C512810102 N26口的互操作注册失败次数（27-N1模式不允许）|4|基于IMSI号段注册更新流程测量
C512810103 N26口的互操作注册失败次数（27.ODB-N1模式不允许_ODB原因）|4|基于IMSI号段注册更新流程测量
C512810104 N26口的互操作注册失败次数（27.user-N1模式不允许_用户原因）|4|基于IMSI号段注册更新流程测量
C512810105 N26口的互操作注册失败次数（62-无可用网络切片）|4|基于IMSI号段注册更新流程测量
C512810106 N26口的互操作注册失败次数（72-Non 3GPP接入不允许）|4|基于IMSI号段注册更新流程测量
C512810107 N26口的互操作注册失败次数（73-服务网络未授权）|4|基于IMSI号段注册更新流程测量
C512810108 N26口的互操作注册失败次数（76-CAG未授权或仅CAG小区授权）|4|基于IMSI号段注册更新流程测量
C512810109 N26口的互操作注册次数（111-协议失败，未指定失败）|4|基于IMSI号段注册更新流程测量
C512810110 N26口的互操作注册失败次数（111.user-协议失败，未指定_用户原因）|4|基于IMSI号段注册更新流程测量
C512810111 N26口的互操作注册建立时长（毫秒）|4|基于IMSI号段注册更新流程测量
C512810116 移动性注册请求次数（从VPLMN到HPLMN）|4|基于IMSI号段注册更新流程测量
C512810117 移动性注册成功次数（从VPLMN到HPLMN）|4|基于IMSI号段注册更新流程测量
C512810118 移动性注册请求次数（跨PLMN移动到VPLMN）|4|基于IMSI号段注册更新流程测量
C512810119 移动性注册成功次数（跨PLMN移动到VPLMN）|4|基于IMSI号段注册更新流程测量
SEPP
SEPP中需要关注的性能统计数据参见下表。 
性能指标|计算公式|指标描述
---|---|---
460399001 HTTP消息转发成功率(%)|(1-(C460390013+C460390015+C460390016+C460390030)/(C460390006+C460390008))*100|该指标统计测量时间内所有HTTP消息（包括请求和响应消息）的转发成功率，用于衡量链路的流量情况，为系统运行提供重要的参考数据。
460399009 HTTP业务成功率(%)|(1-(C460390013+C460390014+C460390016)/(C460390007+C460390017+C460390018))*100|该指标统计测量时间内所有HTTP业务消息的处理成功率，用于衡量端到端流程的处理成功率，为系统运行提供重要的参考数据。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C460390006 接收请求消息数
2|C460390007 发送请求消息数
3|C460390008 接收响应消息数
4|C460390013 始发错误响应消息数
5|C460390014 转发错误响应消息数
6|C460390015 请求消息丢弃数
7|C460390016 响应消息丢弃数
8|C460390017 超时无响应重发消息数
9|C460390018 重路由发送请求消息数
10|C460390030 接收重路由错误码消息数
NRF
NRF中需要关注的性能统计数据参见下表。 
性能指标|计算公式|指标描述
---|---|---
转发到异网的发现完成率|转发到异网的发现完成率=(C542030002+C542030003+C542030004+C542030005)/C542030001×100%|是NF发起的“发现请求”转发到异网的成功次数+400/403/404失败次数之和与发现请求转发到异网的发现请求总次数的比例。通过该指标可以了解统计周期内NF发起的发现请求转发到异网的完成情况。
来自异网的发现完成率|来自异网的发现完成率=(C542040002+C542040003+C542040004+C542040005)/C542040001×100%|是NRF收到来自异网NF（除特定NF外）的发现请求成功次数+400/403/404失败次数之和与来自异网的发现请求总次数的比例。通过该指标可以了解统计周期内NRF接收来自异网NF的发现请求的完成情况。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C542030001 转发到异网的发现请求次数
2|C542030002 转发到异网的发现成功次数
3|C542030003 转发到异网的发现400失败次数
4|C542030004 转发到异网的403发现失败次数
5|C542030005 转发到异网的404发现失败次数
6|C542040001 来自异网的发现请求次数
7|C542040002 来自异网的发现成功次数
8|C542040003 来自异网的发现400失败次数
9|C542040004 来自异网的403发现失败次数
10|C542040005 来自异网的404发现失败次数
SMF
SMF中需要关注的性能统计数据参见下表。 
性能指标|计算公式|指标描述
---|---|---
I-SMF/V-SMF每PLMN(基于SUPI)会话建立成功率(%)|C515770018/C515770017×100%|适用于拜访网络。
I-SMF/V-SMF每PLMN(基于SUPI) QoS Flow建立成功率(%)|C515770020/C515770019×100%|适用于拜访网络。
H-SMF每PLMN(Serving Network)会话建立成功率(%)|C515860012/C515860011×100%|适用于归属网络。
H-SMF每PLMN(Serving Network)会话建立成功率(去除用户原因)(%)|C515860012/(C515860012+C515860021+C515860022+C515860023+C515860024)×100%|适用于归属网络。
H-SMF每PLMN(Serving Network)专有QoS Flow建立成功率(%)|C515860029/C515860028×100%|适用于归属网络。
V-SMF每PLMN(Serving Network)会话建立成功率(%)|C515860050/C515860049×100%|适用于拜访网络。
V-SMF每PLMN(Serving Network)会话建立成功率(去除用户原因)(%)|C515860050/(C515860050+C515860063+C515860064+C515860065+C515860066)×100%|适用于拜访网络。
V-SMF每PLMN(Serving Network)专有Qos Flow建立成功率(%)|C515860071/C515860070×100%|适用于拜访网络。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C515770017 I-SMF/V-SMF每PLMN会话建立请求次数
2|C515770018 I-SMF/V-SMF每PLMN会话成功建立次数
3|C515770019 I-SMF/V-SMF每PLMN QoSflow建立请求次数
4|C515770020 I-SMF/V-SMF每PLMN QoSflow成功建立次数
5|C515860011 H-SMF每PLMN会话建立请求次数
6|C515860012 H-SMF每PLMN 会话成功建立次数
7|C515860012 H-SMF每PLMN 会话成功建立次数
8|C515860021 H-SMF每PLMN由于上报系统内部错误导致的会话建立失败次数
9|C515860022 H-SMF每PLMN由于PCF无响应或返回失败导致会话创建失败的次数
10|C515860023 H-SMF每PLMN由于CHF无响应或返回失败导致会话创建失败的次数
11|C515860024 H-SMF每PLMN由于UPF无响应或返回失败导致会话创建失败的次数
12|C515860028 H-SMF每PLMN专载建立请求次数
13|C515860029 H-SMF每PLMN专载建立成功次数
14|C515860049 V-SMF每PLMN会话建立请求次数
15|C515860050 V-SMF每PLMN会话成功建立次数
16|C515860050 V-SMF每PLMN会话成功建立次数
17|C515860063 V-SMF每PLMN由于上报系统内部错误导致的会话建立失败次数
18|C515860064 V-SMF每PLMN由于CHF无响应或返回失败导致的会话创建失败
19|C515860065 V-SMF每PLMN由于UPF无响应或返回失败导致的会话创建失败
20|C515860066 V-SMF每PLMN由于H-SMF无响应或返回失败导致的会话创建失败
21|C515860070 V-SMF每PLMN专载建立请求次数
22|C515860071 V-SMF每PLMN专载成功建立次数
UPF
UPF中需要关注的性能统计数据参见下表。 
序号|测量类型|性能计数器
---|---|---
1|基于服务PLMN的流量测量|C550630011 每PLMN接收的上行数据包数
C550630012 每PLMN发送的上行数据包数|1|基于服务PLMN的流量测量
C550630013 每PLMN接收的下行数据包数|1|基于服务PLMN的流量测量
C550630014 每PLMN发送的下行数据包数|1|基于服务PLMN的流量测量
C550630015 每PLMN接收的上行数据包字节数(Byte)|1|基于服务PLMN的流量测量
C550630016 每PLMN发送的上行数据包字节数(Byte)|1|基于服务PLMN的流量测量
C550630017 每PLMN接收的下行数据包字节数(Byte)|1|基于服务PLMN的流量测量
C550630018 每PLMN发送的下行数据包字节数(Byte)|1|基于服务PLMN的流量测量
C550630019 每PLMN接收的上行数据包峰值速率(pps)|1|基于服务PLMN的流量测量
C550630020 每PLMN发送的上行数据包峰值速率(pps)|1|基于服务PLMN的流量测量
C550630021 每PLMN接收的下行数据包峰值速率(pps)|1|基于服务PLMN的流量测量
C550630022 每PLMN发送的下行数据包峰值速率(pps)|1|基于服务PLMN的流量测量
C550630023 每PLMN接收的上行数据包字节峰值速率(KB/s)|1|基于服务PLMN的流量测量
C550630024 每PLMN发送的上行数据包字节峰值速率(KB/s)|1|基于服务PLMN的流量测量
C550630025 每PLMN接收的下行数据包字节峰值速率(KB/s)|1|基于服务PLMN的流量测量
C550630026 每PLMN发送的下行数据包字节峰值速率(KB/s)|1|基于服务PLMN的流量测量
### 各网元配置 
#### 数据规划 
##### 配置前提 
各运营商网内的5G业务正常运行。 
已规划运营商间异网漫游相关的对接配置数据。 
 说明： 
建议的配置顺序如下： 
完成NRF网元配置，避免在未配置共享PLMN的情况下，AMF/SMF先增加共享PLMN配置，导致AMF/SMF向NRF进行注册更新失败。 
完成SMF、AUSF/UDM、NSSF和SEPP的配置后，再进行AMF/MME/SGSN的配置，避免漫游用户在网络侧配置未完成的情况下，从共享PLMN接入网络，导致接入失败。 
##### License要求 
NF|LicenseID|License控制项|取值
---|---|---|---
AMF|uMAC_AMF_7256|AMF支持跨PLMN移动|开
uMAC_AMF_7241|AMF|AMF支持用户QoS控制功能|开
uMAC_AMF_7246|AMF|AMF支持基于SEPP通信|开
##### 数据规划 
无SCP的SEPP多对多组网规划如[图1](1668739046297.html#z51e69f8117ee4ede9adeef4cbebbafc0__434c74dd-0067-43cd-8f85-f43748a14af9)所示。
图1  无SCP的SEPP多对多组网
[]images/44b8dadf861a4fb094a74d6a602652e9.png)
以运营商A和运营商B的异网漫游组网为例，网络总体数据规划参见下表。 
网元|参数名称|参数取值
---|---|---
运营商A|运营商B
---|---
通用|HPLMN|通用|46006|46015
共享PLMN|通用|通用|46032说明：由运营商A提供，当运营商B的用户漫入到运营商A的网络时接入的PLMN。|46022说明：由运营商B提供，运营商A的用户漫入到运营商B的网络时接入的PLMN。
TAC|通用|通用|0A000A|0B000B
S-NSSAI|通用|通用|1-000000|1-NULL
A省|AMF|HTTP IP和端口号|x:x:x:103:181:x:x:100：8080|x:x:x:103:182:x:x:100：8080
interplmn FQDN|A省|AMF|interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org|interplmn_pt02.set02.region02.amf.5gc.mnc015.mcc460.3gppnetwork.org
SMF|A省|HTTP IP和端口号|x:x:x:116:181:x:x:100：8080|x:x:x:116:182:x:x:100：8080
interplmn FQDN|SMF|A省|interplmn_0A_zz_smf181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|interplmn_0B_zz_smf182_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
AUSF|A省|HTTP IP和端口号|x:x:x:118:181:x:x:100：8080|x:x:x:118:182:x:x:100：8080
interplmn FQDN|AUSF|A省|interplmn_0A_zz_udm181ausf01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|interplmn_0B_zz_udm182ausffe01_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
UDM|A省|HTTP IP和端口号|x:x:x:118:181:x:x:100：8080|x:x:x:118:182:x:x:100：8080
interplmn FQDN|UDM|A省|interplmn_0A_zz_udm181udm01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|interplmn_0B_zz_udm182udmfe01_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
L-NRF|A省|HTTP IP和端口号|x:x:x:111:181:x:x:100：8080|x:x:x:111:182:x:x:100：8080
I-NRF1|HTTP IP和端口号|I-NRF1|x:x:x:111:183:x:x:100：8080|-
FQDN|I-NRF1|I-NRF1|0A_zz_inrf183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|-
I-NRF3|HTTP IP和端口号|I-NRF3|x:x:x:111:185:x:x:100：8080|-
FQDN|I-NRF3|I-NRF3|0A_zz_inrf185_zx.0B.node.5gc.mnc006.mcc460.3gppnetwork.org|-
I-NRF5|HTTP IP和端口号|I-NRF5|-|x:x:x:111:184:x:x:100：8080
FQDN|I-NRF5|I-NRF5|-|0B_zz_inrf184_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
I-NRF6|HTTP IP和端口号|I-NRF6|-|x:x:x:111:186:x:x:100：8080
FQDN|I-NRF6|I-NRF6|-|0B_zz_inrf186_zx.0B.node.5gc.mnc015.mcc460.3gppnetwork.org
SEPP1|HTTP IP和端口号|SEPP1|对接内网：x:x:x:115:181:x:x:100：8080对接异网：x:x:x:115:181:x:x:200：8080|-
FQDN|SEPP1|SEPP1|0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|-
SEPP2|HTTP IP和端口号|SEPP2|对接内网：x:x:x:115:183:x:x:200：8080对接异网：x:x:x:115:183:x:x:200：8080|-
FQDN|SEPP2|SEPP2|0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org|-
SEPP3|HTTP IP和端口号|SEPP3|对接内网：x:x:x:115:185:x:x:100：8080对接异网：x:x:x:115:185:x:x:200：8080|-
FQDN|SEPP3|SEPP3|0A_zz_sepp185_zx.0B.node.5gc.mnc006.mcc460.3gppnetwork.org|-
SEPP4|HTTP IP和端口号|SEPP4|对接内网：x:x:x:115:187:x:x:100：8080对接异网：x:x:x:115:187:x:x:200：8080|-
FQDN|SEPP4|SEPP4|0A_zz_sepp187_zx.0B.node.5gc.mnc006.mcc460.3gppnetwork.org|-
SEPP5|HTTP IP和端口号|SEPP5|-|对接内网：x:x:x:115:182:x:x:100：8080对接异网：x:x:x:115:182:x:x:200：8080
FQDN|SEPP5|SEPP5|-|0B_zz_sepp182_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
SEPP6|HTTP IP和端口号|SEPP6|-|对接内网：x:x:x:115:184:x:x:100：8080对接异网：x:x:x:115:184:x:x:200：8080
FQDN|SEPP6|SEPP6|-|0B_zz_sepp184_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org
SEPP7|HTTP IP和端口号|SEPP7|-|对接内网：x:x:x:115:186:x:x:100：8080对接异网：x:x:x:115:186:x:x:200：8080
FQDN|SEPP7|SEPP7|-|0B_zz_sepp186_zx.0B.node.5gc.mnc015.mcc460.3gppnetwork.org
SEPP8|HTTP IP和端口号|SEPP8|-|对接内网：x:x:x:115:188:x:x:100：8080对接异网：x:x:x:115:188:x:x:200：8080
FQDN|SEPP8|SEPP8|-|0B_zz_sepp188_zx.0B.node.5gc.mnc015.mcc460.3gppnetwork.org
#### I-NRF 
##### I-NRF配置步骤 
以运营商A部署的I-NRF1网元为例，进行配置说明。 
I-NRF基础配置
步骤|说明|操作|备注
---|---|---|---
1|开启PLMN级NRF功能|SET PARAMETER:PARANAME="plmnLevelNrfSwitch",PARAVALUE=1|-
2|设置I-NRF等级标识|SET PARAMETER:PARANAME="nrfLeveltype",PARAVALUE="1"|配置I-NRF为一级NRF。
3|开启APIROOT路由|SET PARAMETER:PARANAME="INrfApiRootSwitch",PARAVALUE="1"|配置hI-NRF发送跨PLMN的订阅响应，在subscriptionID中携带apiRoot路由信息。
4|设置NRF类型信息配置|SET ONEROUTFLG:ONETO2DMROUTEFLAG="BYCONFIG",ONETO2LMROUTEFLAG="BYCONFIG",ONETO2OAROUTEFLAG="BYCONFIG"|配置一级NRF（即I-NRF）的路由方式为BYCONFIG模式。
5|新增NRF PLMN配置|ADD NRFPLMNLIST:MCC="460",MNC="32"|将共享PLMN配置为I-NRF支持的PLMN。
与L-NRF对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增对端路由网元SET信息配置|ADD NRFSET:NRFSETINDEX="LNRF_G",NRFTYPE="LNRF",LOCAL="HA"|-
2|新增对端路由网元SET中的网元信息配置|ADD NRFSETNRFINFO:NRFINDEX="LNRF",NFINSTANCEID="0bdbe58c-af3a-4859-a3f4-7b16dbd9edc9",ACCESSTYPE="BYIP",OPPOSITETYPE="TONRF"|配置I-NRF与L-NRF对接，需要与本网内所有L-NRF进行对接。
3|新增对端路由网元IP信息配置|ADD ROUTENRFIP:NRFINDEX="LNRF",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:111:181:x:x:100",NRFPORT=8080|NRFINDEX参数引用自ADD NRFSET命令中的NRFTYPE参数，需要通过ADD NRFSET命令预先配置。
4|新增对端路由网元SET与对端路由网元映射信息配置|ADD NRFSETNRFMAP:NRFINDEX="LNRF",NRFSETINDEX="LNRF_G",PRIORITY=1|NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
与SEPP对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增对端路由网元SET信息配置|ADD NRFSET:NRFSETINDEX="SEPP",NRFTYPE="HNRF",LOCAL="SN"|-
2|新增对端路由网元SET中的网元信息配置|ADD NRFSETNRFINFO:NRFINDEX="SEPP181",NFINSTANCEID="915adc34-f637-11ec-a179-de95d8ab579b",ACCESSTYPE="BYIP",OPPOSITETYPE="TOSEPP",OPERATEMODE="APIROOT",FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"ADD NRFSETNRFINFO:NRFINDEX="SEPP183",NFINSTANCEID="7d690634-f573-11ec-a179-de95d8ab579b",ACCESSTYPE="BYIP",OPPOSITETYPE="TOSEPP",OPERATEMODE="APIROOT",FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|-
3|新增对端路由网元IP信息配置|ADD ROUTENRFIP:NRFINDEX="SEPP181",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:115:181:x:x:100",NRFPORT=8080ADD ROUTENRFIP:NRFINDEX="SEPP183",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:115:183:x:x:100",NRFPORT=8080|NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。
4|新增对端路由网元SET与对端路由网元映射信息配置|ADD NRFSETNRFMAP:NRFINDEX="SEPP181",NRFSETINDEX="SEPP",PRIORITY=1ADD NRFSETNRFMAP:NRFINDEX="SEPP183",NRFSETINDEX="SEPP",PRIORITY=1|配置两个SEPP负荷分担，两个SEPP的优先级相同。NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
I-NRF路由转发配置
步骤|说明|操作|备注
---|---|---|---
1|新增plmn映射配置|ADD PLMNMAP:MCC="460",MNC="15",NRFSETINDEX="SEPP"ADD PLMNMAP:MCC="460",MNC="22",NRFSETINDEX="SEPP"|配置异网PLMN的路由映射。NRFSETINDEX参数引用自ADD NRFSET中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
2|新增plmn-属性映射配置|ADD PLMNATTRIBUTEMAP:MCC="460",MNC="15",ATTRIBUTETYPE="APIROOT",ATTRIBUTE="http://0B_zz_inrf184_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org"ADD PLMNATTRIBUTEMAP:MCC="460",MNC="22",ATTRIBUTETYPE="APIROOT",ATTRIBUTE="http://0B_zz_inrf184_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org"|配置异网PLMN和异网NRF FQDN的映射关系。ATTRIBUTETYPE配置为APIROOT时，ATTRIBUTE配置为由对端网络I-NRF的FQDN组成的URL。
3|设置路由通配模式|SET PARAMETER:PARANAME="HNRFRouteModeByTai",PARAVALUE="3"SET PARAMETER:PARANAME="HNRFRouteModeByGuami",PARAVALUE="2"SET PARAMETER:PARANAME="HNRFRouteModeBySetRegion",PARAVALUE="2"SET PARAMETER:PARANAME="HNRFRouteModeByFQDN",PARAVALUE="2"SET PARAMETER:PARANAME="HNRFRouteModeByDNN",PARAVALUE="3"|I-NRF路由通配模式与L-NRF配置相同。L-NRF配置已存在，无需新增。
4|新增Tai映射配置|ADD TAIMAP:TAIMAPID="1",MCC="460",MNC="22",TAC="0B000B",NRFSETINDEX="LNRF_G"ADD TAIMAP:TAIMAPID="2",MCC="460",MNC="06",TAC="0A000A",NRFSETINDEX="LNRF_G"ADD TAIMAP:TAIMAPID="3",MCC="460",MNC="32",TAC="0A000A",NRFSETINDEX="LNRF_G"|配置本网TAI和L-NRF的路由映射。配置漫游网络共享PLMN的TAC路由，用于本网用户漫游到异网时发现本网的hSMF。配置本网的TAI路由，用于漫游到异网的本网用户切换回本网时，发现本网的AMF。配置本网共享PLMN的TAI路由，用于异网用户从归属网络切换到本网时，发现本网的AMF。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
5|新增SUPI号段映射配置|ADD SUPIMAP:SUPIMAPID="10",SUPISTART="460060000000000",SUPIEND="460069999999999",NRFSETINDEX="LNRF_G"|配置本网SUPI号段和LNRF的路由映射。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
6|新增TacProvince映射配置|ADD TACPROVMAP:TACPROV="0A",TACPROVNAME="0A",NRFSETINDEX="LNRF_G"|配置本网TAC省份编码和LNRF路由映射。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
7|新增Tac映射|ADD TACMAP:TAC="0A000A",NRFSETINDEX="LNRF_G"|可选配置，用于本网根据TAC路由发现本网网元。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
8|新增TaiProvince映射|ADD TAIPROVMAP:TAIPROVMAPID="1",MCC="460",MNC="22",TACPROV="0B",TACPROVNAME="0A",NRFSETINDEX="LNRF_G",ROUTENFTYPE=SystemADD TAIPROVMAP:TAIPROVMAPID="2",MCC="460",MNC="06",TACPROV="0A",TACPROVNAME="0A",NRFSETINDEX="LNRF_G",ROUTENFTYPE=SystemADD TAIPROVMAP:TAIPROVMAPID="3",MCC="460",MNC="32",TACPROV="0A",TACPROVNAME="0A",NRFSETINDEX="LNRF_G",ROUTENFTYPE=System|配置PLMN+TAC省份映射路由。配置漫游网络共享PLMN的TAI省份映射路由，用于本网用户漫游到异网时发现本网的hSMF。配置本网的TAI省份映射路由，用于漫游到异网的本网用户切换回本网时，发现本网的AMF。配置本网共享PLMN的TAI省份映射路由，用于异网用户从归属网络切换到本网时，发现本网的AMF。
9|新增AmfProvince映射|ADD AMFPROVMAP:AMFPROV="010",AMFPROVNAME="AMF",NRFSETINDEX="LNRF_G"|NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
10|设置定制NFID模式配置|SET CUSTOMNFIDMODE:CUSTOMNFIDMODE="REGIONPROVMODE"|-
11|设置大区省份编码配置|SET REGIONPROVCODE:REGIONSTART=3,REGIONEND=4,PROVINCESTART=5,PROVINCEEND=6|-
12|新增RegionProvince映射|ADD REGPROVMAP:REGIONAREA="01",PROVINCENAME="0A",NRFSETINDEX="LNRF_G"|NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
13|新增省份缩写映射|ADD PROVSHORTMAP:PROVSHORT="js",PROVNAME="江苏",NRFSETINDEX="JS_sNRF_G"|AMF全量备份场景和4/5G互操作场景需要配置。
#### L-NRF 
##### L-NRF配置步骤 
以运营商A在A省部署的L-NRF（即A省的NF注册的L-NRF）网元为例，配置参见下表。 
基础配置
步骤|说明|操作|备注
---|---|---|---
1|新增NRF 组信息配置|ADD NRFSET:NRFSETINDEX="iNRF_G",NRFTYPE="HNRF",LOCAL="1"|-
2|新增NRF组中的NRF信息配置|ADD NRFSETNRFINFO:NRFINDEX="iNRF001",NFINSTANCEID="8ccf2eb0-deaf-4c32-bfbc-b0b31620717f",ACCESSTYPE="BYIP",OPPOSITETYPE="TONRF"|配置L-NRF与本大区/节点的I-NRF对接。
3|新增NRF组中的NRF IP信息配置|ADD ROUTENRFIP:NRFINDEX="iNRF001",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:111:183:x:x:100",NRFPORT=8080|NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。
4|新增NRF 组与NRF映射信息配置|ADD NRFSETNRFMAP:NRFINDEX="iNRF001",NRFSETINDEX="iNRF_G",PRIORITY=1|NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置.NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
5|新增默认plmn映射路由|ADD DFTPLMNROUTE:NRFSETINDEX="iNRF_G"|NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
6|新增NRF PLMN配置|ADD NRFPLMNLIST:MCC="460",MNC="32"|将共享PLMN配置为L-NRF支持的PLMN。
7|修改IP地址隐藏参数配置|SET PARAMETER:PARANAME="ifHiddenAddrSwitch",PARAVALUE="1"|配置L-NRF在NF发现响应消息中隐藏NF的IP地址。
8|修改interPLMN FQDN参数配置|SET PARAMETER:PARANAME="InterPlmnFqdnSwitch",PARAVALUE="1"|配置L-NRF在NF发现响应消息中使用InterPLMN FQDN替换普通的FQDN。
与SEPP对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增对端路由网元SET信息配置|ADD NRFSET:NRFSETINDEX="SEPP",NRFTYPE="LNRF",LOCAL="SN"|跨网通知消息，由L-NRF直接发给SEPP。
2|新增对端路由网元SET中的网元信息配置|ADD NRFSETNRFINFO:NRFINDEX="SEPP181",NFINSTANCEID="915adc34-f637-11ec-a179-de95d8ab579b",ACCESSTYPE="BYIP",OPPOSITETYPE="TOSEPP",OPERATEMODE="APIROOT",FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"ADD NRFSETNRFINFO:NRFINDEX="SEPP183",NFINSTANCEID="7d690634-f573-11ec-a179-de95d8ab579b",ACCESSTYPE="BYIP",OPPOSITETYPE="TOSEPP",OPERATEMODE="APIROOT",FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|-
3|新增对端路由网元IP信息配置|ADD ROUTENRFIP:NRFINDEX="SEPP181",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:115:181:x:x:100",NRFPORT=8080ADD ROUTENRFIP:NRFINDEX="SEPP183",HTTPMOULD=1,PROTOCOL="HTTP",NRFIPADDRTYPE="IPV6",NRFIPADDRESS="x:x:x:115:183:x:x:100",NRFPORT=8080|NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。
4|新增对端路由网元SET与对端路由网元映射信息配置|ADD NRFSETNRFMAP:NRFINDEX="SEPP181",NRFSETINDEX="SEPP",PRIORITY=1ADD NRFSETNRFMAP:NRFINDEX="SEPP183",NRFSETINDEX="SEPP",PRIORITY=1|配置两个SEPP负荷分担，两个SEPP的优先级相同。NRFINDEX参数引用自ADD NRFSETNRFINFO命令中的NRFINDEX参数，需要通过ADD NRFSETNRFINFO命令预先配置。NRFSETINDEX参数引用自ADD NRFSET命令中的NRFSETINDEX参数，需要通过ADD NRFSET命令预先配置。
5|新增plmn映射|ADD PLMNMAP:MCC="460",MNC="15",NRFSETINDEX="SEPP"|
#### vSMF 
以运营商A在A省部署的vSMF网元为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|新增PLMN配置|ADD PLMNMCCMNC:PLMNMNC="460",PLMNMCC="32"|SMF向NRF注册时携带的PLMN列表中新增共享PLMN。
2|新增TAI List配置|ADD TAIRANGELIST:SECNAME="shared_plmn_TA",MCC="460",MNC="32",TAISTART="0A000A",TAIEND="0A000A"|作为vSMF，增加本省本网共享PLMN的TA，即用户在该TA使用共享PLMN接入时可以选择该vSMF。
3|新增APNDNN信息配置|ADD APNDNN:APNDNN="default",REAL="true",REALAPNDNN="default",MAXPDPNUM=4294967295|增加默认的DNN。
4|新增APN/DNN Profile配置|ADD APNDNNPROFILE:NAME="default_for_plmn"|增加默认的DNN。
5|新增关联APNDNN基础配置|ADD MAPAPNDNNPROFILE:APNDNN="default",NAME="default_for_plmn"|增加默认的DNN。
6|修改APN/DNN Profile速率控制配置|SET APNDNNBAND:NAME="default_for_plmn",AMBRULIMIT="ENABLE",AMBRDLIMIT="ENABLE"|打开默认DNN的AMBR速率限制。
7|新增QBC模板配置|SET QBCTEMPLATECFG:QBCTEMPNAME="default",VOLUMELIMIT=100000,TIMELIMIT=60,HSMFENABLEQBC="DISABLE",VSMFENABLEQBC="ENABLE",QBCCHARGELEVEL="SESSIONLEVEL"|-
8|新增触发能力模板配置|SET TRIGGERCAPACITY:TRIGGERCAPNAME="roaming_qbc",TRIGGERTYPE="ServingNodeChange",LOCALTRIGGERREPORT="ENABLE",TRIGGERCATEGORY="IMMEDIATE_REPORT",QBCLOCALTRIGGERRPT="ENABLE",QBCTRIGGERCATEGORY="IMMEDIATE_REPORT"SET TRIGGERCAPACITY:TRIGGERCAPNAME="roaming_qbc",TRIGGERTYPE="VolumeLimit",LOCALTRIGGERREPORT="ENABLE",TRIGGERCATEGORY="IMMEDIATE_REPORT",QBCLOCALTRIGGERRPT="ENABLE",QBCTRIGGERCATEGORY="IMMEDIATE_REPORT"SET TRIGGERCAPACITY:TRIGGERCAPNAME="roaming_qbc",TRIGGERTYPE="TimeLimit",LOCALTRIGGERREPORT="ENABLE",TRIGGERCATEGORY="IMMEDIATE_REPORT",QBCLOCALTRIGGERRPT="ENABLE",QBCTRIGGERCATEGORY="IMMEDIATE_REPORT"|如无特殊要求，建议TRIGGERTYPE参数只添加ServingNodeChange、VolumeLimit、TimeLimit三个触发类型，QBC本地触发上报参数QBCLOCALTRIGGERRPT配置为ENABLE，QBC触发类别QBCTRIGGERCATEGORY配置为IMMEDIATE_REPORT。
9|新增N40接口编码模板配置|SET N40ENCODETEMPLATECONFIG:N40ENCODETMPLNAME="default",L1CODE="12",L2CODE="2",L3CODE="0",L4CODE="0",L5CODE="0",PARAMETERNAME="homeProvidedChargingId",CREATE="CARRY",UPDATE="CARRY",RELEASE="CARRY"SET N40ENCODETEMPLATECONFIG:N40ENCODETMPLNAME="default",L1CODE="12",L2CODE="3",L3CODE="4",L4CODE="0",L5CODE="0",PARAMETERNAME="roamerInOut",CREATE="CARRY",UPDATE="CARRY",RELEASE="CARRY"SET N40ENCODETEMPLATECONFIG:N40ENCODETMPLNAME="default",L1CODE="13",L2CODE="0",L3CODE="0",L4CODE="0",L5CODE="0",PARAMETERNAME="roamingQBCInformation",CREATE="CARRY",UPDATE="CARRY",RELEASE="CARRY"|配置vSMF的N40口携带homeProvidedChargingId、roamerInOut、roamingQBCInformation字段。支持homeProvidedChargingId字段需要打开6232软参。
10|新增融合计费模板配置|ADD CONVERGETEMP:CONVERGETEMPNAME="default",CONVERGEOFFTEMPNAME="default-apn",CONVERGEONTEMPNAME="default-apn",CONVERGEFUNCTIONNAME="default-apn",CCRREPORTPOLICYNAME="default-apn",ONLINEABNORMALNAME="default-apn",CCAPOLICYNAME="default",CCFHNAME="default",APPRESULTCODENAME="default",MUIRESULTCODENAME="default",DYNAMICCHFFUNCNAME="default",CHANGECONDITIONNUM=1,RATINGGROUPPARATEMP="default-apn",QBCTEMPLATENAME="default",OFFLINECHARGELEVEL=SESSIONLEVEL|将融合计费模板关联触发能力模板和QBC计费模板。
11|新增SMF计费APN/DNN关联模板配置|ADD ACCDNNTEMPLATE:APNDNN="default",CONVERGETEMPNAME="default",DNNTYPESELCHF="REQUESTED"|将默认DNN关联融合计费模板，并设置N40接口DNN为请求的DNN（即DNNTYPESELCHF配置为REQUESTED）。
12|修改软参配置|SET SOFTPARA:ID=6232,VALUE=1SET SOFTPARA:ID=1990,VALUE=0SET SOFTPARA:ID=1992,VALUE=1SET SOFTPARA:ID=1998,VALUE=0SET SOFTPARA:ID=6123,VALUE=1|设置6232号软参为1，支持V-SMF和I-SMF间的切换。设置1990号软参为0。设置1992号软参为1。配置1998号软参为0。配置6123号软参为1，支持N16接口的Nsmf_PDUSession_Context响应消息里携带新的字段。
13|新增路由集配置|ADD SBISCPROUTESET:ID=1,NAME="SEPP RouteSet1",ADDDISCOVERY="OPTION_NO"|-
14|新增服务器配置|ADD SBISCPSERVER:ID=1,FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100ADD SBISCPSERVER:ID=2,FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100|配置两个SEPP负荷分担，两个SEPP的优先级和权重相同。ROUTESETID参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
15|新增节点配置|ADD SBISCPNODE:ID=1,SERVERIPADDR="x:x:x:115:181:x:x:100",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1ADD SBISCPNODE:ID=2,SERVERIPADDR="x:x:x:115:183:x:x:100",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=1|SCPSERVERID参数引用自ADD SBISCPSERVER命令中的ID，必须通过ADD SBISCPSERVER命令预先配置。
16|设置SEPP基本属性配置|SET SBISEPPBASICATTRIBUTE:SEPPSWITCH="SEPP_ON",CALLBACKMODE="SEPP_TARGETAPIROOT",IPSELECTMODE="IPV6_FIRST"|SEPPSWITCH配置为SEPP_ON（启用SEPP功能），IPSELECTMODE根据运营商策略要求配置。
17|新增SEPP按PLMN选择配置|ADD SBISEPPSELBYPLMN:MCC="460",MNC="15",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
18|新增SEPP按FQDN选择配置|ADD SBISEPPSELBYFQDN:FQDN="mnc015.mcc460.3gppnetwork.org",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置，FQDN使用通用配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
19|设置缺省异网漫游配置|SET SBISEPPDEFAULTSELECTION:SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
20|新增归属PLMN配置|ADD SBIHOMEPLMN:MCC="460",MNC="06"ADD SBIHOMEPLMN:MCC="460",MNC="32"|-
21|修改用户漫游接入的决策方式配置|SET ROAMSELECTIONPOLICY:ROAMINGPOLICY="BYPEERPLMN",ALLOWHRIN="ENABLE"|-
22|新增V-SMF_QoS_Profile配置|ADD VSMFQOSPROFILE:NAME="VQ",_5QIRANGE="1-255",_5QIACTION="REJECT",DEFAULT5QI="_9_NON_GBR",ARPPLMIN=5,ARPPLACTION="REJECT",ARPPCILIST="BOTH",ARPPCIACTION="REJECT",ARPPVILIST="BOTH",ARPPVIACTION="REJECT",GFBRDLMAX=20000000,GFBRDLACTION="REJECT",GFBRULMAX=20000000,GFBRULACTION="REJECT",MFBRDLMAX=20000000,MFBRDLACTION="REJECT",MFBRULMAX=20000000,MFBRULACTION="REJECT",SESSIONAMBRULMAX=20000000,SESSAMBRULACTION="REJECT",SESSIONAMBRDLMAX=20000000,SESSAMBRDLACTION="REJECT"|可选配置，根据运营商的策略要求配置。
23|新增HPLMN关联V-SMF_QoS_Profile配置|ADD HPLMNREFVSMFQOSPROF:MCC="460",MNC="06",QOSPROFILENAME="VQ",N1SMCAUSEFORREJECT="OPERATOR_DETERMINED_BARRING",RATCFORREJ=0,EPLMNCFORREJ=0,UNITOFBACKOFF="VALUE_IS_INCREMENTED_IN_MULTIPLES_OF_10_MINUTES",VALUEOFBACKOFF=1|可选配置，根据运营商的策略要求配置。VSMF QOS模板名引用自”V-SMF_QoS_Profile配置“QOSPROFILENAME参数引用自ADD VSMFQOSPROFILE命令的NAME参数，需要通过ADD VSMFQOSPROFILE命令预先配置。
24|设置SMF的N16/N38接口HTTP头配置|SET NSMFHTTPHEADERS:URIFQDNTOSEPPMSGSW="ENABLE",SEPPCALLBACKURIFQDN="ENABLE",SEPPLOCATIONFQDN="ENABLE"|可选配置，根据运营商的策略要求配置。配置SMF的N16/N38接口HTTP头中的URI携带SEPP FQDN，Callback URI和Location中携带SMF FQDN。
25|设置Nsmf兼容配置参数配置|SET NSMFCOMPATIBILITY:SPTROAMCHARGPROFILE="DISABLE",CRTCHARGINGIDMODE="CHARINGID"|根据运营商的策略要求配置。
26|新增I/V-SMF优选UPF配置|ADD IVSMFPREFEREDUPF:UPNAME="up1",PRIORITY=0|可选配置，根据运营商的策略要求配置。
#### hSMF 
以运营商A在A省部署的hSMF网元为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|新增TAI RangeList配置|ADD TAIRANGELIST:SECNAME="vplmn_TA",MCC="460",MNC="22",TAISTART="0B000B",TAIEND="0B000B"|作为hSMF，增加漫游网络对应省份共享PLMN的TA，即用户在该TA使用共享PLMN接入时可以选择该hSMF。
2|设置NRFFQDN配置|SET NRFFQDN:INTERFQDNSWITCH="true",INTERPLMNFQDN="interplmn_0A_zz_smf181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|配置SMF发送给NRF的注册消息或更新消息中携带的PLMN间FQDN。
3|修改软参配置|SET SOFTPARA:ID=6232,VALUE=1SET SOFTPARA:ID="6244",VALUE="0"|设置6232号软参为1，支持I-SMF和vSMF之间的切换；hSMF支持homeProvidedChargingId。设置6244号软参为0，hSMF不支持会话重建。
4|新增归属PLMN配置|ADD SBIHOMEPLMN:MCC="460",MNC="06"ADD SBIHOMEPLMN:MCC="460",MNC="32"|将本网的HPLMN配置为归属PLMN。
5|新增路由集配置|ADD SBISCPROUTESET:ID=1,NAME="SEPP RouteSet1",ADDDISCOVERY="OPTION_NO"|-
6|新增服务器配置|ADD SBISCPSERVER:ID=1,FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100ADD SBISCPSERVER:ID=2,FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100|配置两个SEPP负荷分担，两个SEPP的优先级和权重相同。ROUTESETID参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
7|新增节点配置|ADD SBISCPNODE:ID=1,SERVERIPADDR="x:x:x:115:181:x:x:100",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1ADD SBISCPNODE:ID=2,SERVERIPADDR="x:x:x:115:183:x:x:100",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=1|SCPSERVERID参数引用自ADD SBISCPSERVER命令中的ID，必须通过ADD SBISCPSERVER命令预先配置。
8|设置SEPP基本属性配置|SET SBISEPPBASICATTRIBUTE:SEPPSWITCH="SEPP_ON",CALLBACKMODE="SEPP_TARGETAPIROOT",IPSELECTMODE="IPV6_FIRST""|SEPPSWITCH配置为SEPP_ON（启用SEPP功能），IPSELECTMODE根据运营商策略要求配置。
9|新增SEPP按PLMN选择配置|ADD SBISEPPSELBYPLMN:MCC="460",MNC="15",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
10|新增SEPP按FQDN选择配置|ADD SBISEPPSELBYFQDN:FQDN="mnc015.mcc460.3gppnetwork.org",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置，FQDN使用通用配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
11|设置缺省异网漫游配置|SET SBISEPPDEFAULTSELECTION:SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
12|修改用户漫游接入的决策方式配置|SET ROAMSELECTIONPOLICY:ROAMINGPOLICY="BYPEERPLMN",ALLOWHRIN="ENABLE"|-
13|设置SMF的N16/N38接口HTTP头配置|SET NSMFHTTPHEADERS:URIFQDNTOSEPPMSGSW="ENABLE",SEPPCALLBACKURIFQDN="ENABLE",SEPPLOCATIONFQDN="ENABLE"|可选配置，根据运营商的策略要求配置。配置SMF的N16/N38接口HTTP头中的URI携带SEPP FQDN，Callback URI和Location中携带SMF FQDN。
#### AUSF/UDM 
以运营商A在A省部署的AUSF/UDM网元为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|设置SEPP功能选项配置|SET SEPPOPT:SUPSEPP="SUPSEPP_YES"|配置开启SEPP功能。
2|设置SEPP基本属性配置|SET SBISEPPBASICATTRIBUTE:SEPPSWITCH="SEPP_ON",CALLBACKMODE="SEPP_TARGETAPIROOT",IPSELECTMODE="IPV6_FIRST"|SEPPSWITCH配置为SEPP_ON（启用SEPP功能），IPSELECTMODE根据运营商策略要求配置。
3|新增路由集配置|ADD SBISCPROUTESET:ID=1,NAME="SEPPRT",ADDDISCOVERY="OPTI ON_NO"|-
4|新增服务器配置|ADD SBISCPSERVER:ID=1,FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=0,WEIGHT=100ADD SBISCPSERVER:ID=2,FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=0,WEIGHT=100|配置两个SEPP负荷分担，两个SEPP的优先级和权重相同。ROUTESETID参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
5|新增节点配置|ADD SBISCPNODE:ID=1,SERVERIPADDR="x:x:x:115:181:x:x:100",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=100ADD SBISCPNODE:ID=2,SERVERIPADDR="x:x:x:115:183:x:x:100",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=100|SCPSERVERID参数引用自ADD SBISCPSERVER命令中的ID，必须通过ADD SBISCPSERVER命令预先配置。
6|设置缺省异网漫游配置|SET SBISEPPDEFAULTSELECTION:SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
7|新增归属PLMN配置|ADD SBIHOMEPLMN:MCC="460",MNC="06"|-
8|设置AUSF注册基础配置|SET AUSFNFREGBASE:INTERPLMNFQDN="interplmn_0A_zz_udm181ausf01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|配置AUSF的Interplmn FQDN。
9|设置UDM注册基础配置|SET UDMNFREGBASE:INTERPLMNFQDN="interplmn_0A_zz_udm181udm01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|配置UDM的Interplmn FQDN。
10|设置服务发现配置|SET SBISRVDISCOVERY:SUBWITHPLMN="YES"|配置订阅请求消息携带被订阅NF所属的PLMN ID。
11|设置订阅参数配置|SET SBISUBPARAM:INTERPLMNSUBSWITCH="SWITCH_ON",SUBREQINTERPLMNFQDN="interplmn_0A_zz_udm181udm01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",CBINTERPLMNFQDN="SWITCH_ON"|INTERPLMNSUBSWITCH配置为SWITCH_ON，表示订阅请求消息携带request plmn。SUBREQINTERPLMNFQDN配置订阅请求消息携带的interplmnfqdn。订阅者Inter Plmn Fqdn取值引用自SET UDMNFREGBASE命令中的INTERPLMNFQDN参数。
12|传送数据|SYNA:STYPE="CHG"|-
#### NSSF 
 说明： 
当不同的运营商使用不同的切片时需要配置。 
以运营商A在A省部署的NSSF网元为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|修改通用开关配置|SET SWITCHCONFIG:PARANAME="roamingFlag",PARAVALUE="1"|打开漫游切片映射开关。
2|新增NSSF本地PLMN配置|ADD NSSFPLMN:PLMNID="46032"|在NSSF增加共享PLMN为支持的PLMN。
3|新增sNssai状态|ADD SNSSAISTATUS:PLMNID="46032",SNSSAI="1-000000",STATUS="ACTIVE"|增加共享PLMN关联的切片。
4|新增vPLMN切片与hplmn切片映射配置|ADD VPLMNHPLMNMAPPING:VPLMNID="46032",VSNSSAI="1-000000",HPLMNID="46015",HSNSSAI="1-FFFFFF"|-
5|新增sNssai-Tai-AMFSet映射配置|ADD SNSSAITAIAMFSET:SNSSAI="1-000000",TAI="46032-0A000A",AMFSETID="460-32-01-010"|-
6|新增PLMN级ConfiguredSnssai配置|ADD CONFIGUREDSNSSAI:PLMNID="46032",SNSSAI="1-000000"|-
7|新增AmfInfo配置|ADD AMFINFO:AMFSETID="460-32-01-010",AMFID="D38EF837-9DCF-4C2C-A5F9-BC6CB18DF033"|-
#### SEPP 
##### SEPP配置步骤 
以运营商A部署的SEPP1网元为例，进行配置说明。 
HTTP模板配置
步骤|说明|操作|备注
---|---|---|---
1|新增服务端模板配置|ADD SERVERPROFILE:ID=1,IPADDR="x:x:x:115:181:x:x:100",PORT=8080,VPNID=3ADD SERVERPROFILE:ID=2,IPADDR="x:x:x:115:181:x:x:200",PORT=8080,VPNID=4,TLSCERTNAME="default_tls13",VERIFYCLI="SWITCH_ON"|新建两个服务端模板，编号分别为1，2。1号服务端模板用于本网NF和同网SEPP对接，使用规划的网内通信地址；端口配置为8080；VPN ID配置为3，对应VRF SBI。1号服务端模板用于网内通信，不启用TLS加密，无需关联TLS证书，TLS认证客户端开关设置为SWITCH_OFF，加密套件集名配置为空。2号服务端模板用于本网SEPP和异网SEPP对接，使用规划的网间通信地址；端口配置为8080；VPN ID为4，对应VRF SBI-EXIT。2号服务端模板用于网间通信，启用TLS加密，关联TLS证书，证书需提前导入，TLS证书名为default_tls13；TLS认证客户端开关设置为SWITCH_ON；加密套件集名配置为空。
2|新增客户端模板配置|ADD CLIENTPROFILE:ID=1,IPADDR="x:x:x:115:181:x:x:100",STARTPORT=20000,ENDPORT=60000,VPNID=3ADD CLIENTPROFILE:ID=2,IPADDR="x:x:x:115:181:x:x:200",STARTPORT=20001,ENDPORT=30000,VPNID=4,TLSCERTNAME="default_tls13"ADD CLIENTPROFILE:ID=3,IPADDR="x:x:x:115:181:x:x:200",STARTPORT=30001,ENDPORT=40000,VPNID=4,TLSCERTNAME="default_tls13"|新建三个客户端模板，编号分别为1，2，3。1用于本网NF和同网SEPP对接，2、3用于网间SEPP对接。1号客户端模板，用于本网NF和同网SEPP对接，使用规划的网内通信地址；端口范围配置为20000~60000；VPN ID配置为3，对应VRF SBI。1号客户端模板用于网内通信，不启用TLS加密，无需关联TLS证书，加密套件名默认为default。2号客户端模板，用于本网SEPP和异网SEPP对接，负责消息转发，使用规划的网间通信地址；端口范围配置为20001~30000；VPN ID配置为4，对应VRF SBI-EXIT。2号客户端模板用于网间通信，启用TLS加密，关联TLS证书，证书需提前导入，TLS证书名为default_tls1.3；采用TLS1.3加密方式，加密套件名配置默认为default。3号客户端模板，用于本网SEPP和异网SEPP对接，负责安全协商（预留备用），使用规划的网间通信地址；端口范围配置为30001~40000；VPN ID配置为4，对应VRF SBI-EXIT。3号客户端模板用于网间通信，启用TLS加密，关联TLS证书，证书需提前导入，TLS证书名为default_tls1.3；采用TLS1.3加密方式，加密套件名配置为default。
基本配置
步骤|说明|操作|备注
---|---|---|---
1|新增本端配置|ADD LOCALENDPOINT:INDEX="1",LOCALROLE="SEPP",SERVERPROFILEID="1",FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"ADD LOCALENDPOINT:INDEX="2",LOCALROLE="SEPP",SERVERPROFILEID="2",FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org"|本端配置对应服务端模板配置，新建两条本端配置。1号本端索引对应1号服务端模板，用于网内通信；2号本端索引对应2号服务端模板，用于网间通信。SERVERPROFILEID参数引用自ADD SERVERPROFILE命令中的ID参数，需要通过ADD SERVERPROFILE命令预先配置。本端角色统一配置为SEPP。域名根据运营商实际规划填写。
2|修改基本信息配置|SET DSCPADDR:IPTYPE1="IPFAMILY_IPV6",IPADDRESS1="x:x:x:115:181:x:x:100",PORT1=8080,IPTYPE2="IPFAMILY_IPV6",IPADDRESS2="x:x:x:115:181:x:x:200",PORT2=8080,MSGRETINT=6,MSGRETTIMES=0,ROUTEMODE="MODEC",SUPSECCAPABILITY="TLS",SUPAPIROOT="SUPPORTED",APIROOTRCFP="KEEPON_APIROOT_ROUTE"|IP类型、IP地址、端口根据ADD SERVERPROFILE命令进行配置，网内通信的地址信息和网间通信的地址信息均需配置。消息重发间隔配置为6秒，消息重发次数配置为0，表示SEPP不进行消息重发，消息超时等待定时器为6秒。SEPP转接模式配置为模式C。SEPP支持安全能力配置为TLS。TLS下支持3gpp-Sbi-Target-apiRoot配置为支持。
3|新增全局参数配置|ADD GLOBALPARAMETER:ID=7,VALUE=1ADD GLOBALPARAMETER:ID=8,VALUE=0|全局参数7为HTTP 2消息头部压缩开关，配置为1，表示不进行头部压缩。全局参数8为HTTP 2消息头部压缩表容量，配置为0。
网内NF对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增客户端模版选择配置|ADD SELPF:ID=101,IPFAMILY="IPV6",IPSTART="x:x:x:103:181:x:x:100",IPEND="x:x:x:103:181:x:x:100",PORT=8080,PROFILE1=1,RRTIME1=1,DESC="AMF"ADD SELPF:ID=102,IPFAMILY="IPV6",IPSTART="x:x:x:116:181:x:x:100",IPEND="x:x:x:116:181:x:x:100",PORT=8080,PROFILE1=1,RRTIME1=1,DESC="SMF"ADD SELPF:ID=103,IPFAMILY="IPV6",IPSTART="x:x:x:118:181:x:x:100",IPEND="x:x:x:118:181:x:x:100",PORT=8080,PROFILE1=1,RRTIME1=1,DESC="USPP"ADD SELPF:ID=104,IPFAMILY="IPV6",IPSTART="x:x:x:111:183:x:x:100",IPEND="x:x:x:111:183:x:x:100",PORT=8080,PROFILE1=1,RRTIME1=1,DESC="iNRF1"|本命令配置SEPP作为HTTP客户端与对端建链时使用的客户端模板。ID的配置建议如下：与C链SEPP（同网且同大区的备用SEPP）建链时ID设置为1。与同网SEPP建链时，ID从2~50顺序配置。与异网SEPP建链时，ID从51~100顺序配置。与同网NF建链时，ID从101开始顺序配置。每对接一个同网NF，配置一条对应的客户端模板选择配置。起始IP地址和终止IP地址配置相同，配置为对端NF服务端业务地址。HTTP客户端PROFILE引用规划的网内通信客户端模板编号，可通过SHOW CLIENTPROFILE命令查询ID参数。每个客户端模板只引用一个HTTP客户端PROFILE，其余为预留。安全协商标记统一配置为不协商。轮选次数配置为1。
2|新增HTTP对等端实体配置|ADD DHTTPPEER:ID=101,SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:103:181:x:x:100",RPORT=8080,NFTYPE="NF",FQDN="interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org",NAME="AMF",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1ADD DHTTPPEER:ID=102,SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:116:181:x:x:100",RPORT=8080,NFTYPE="NF",FQDN="interplmn_0A_zz_smf181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NAME="SMF",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1ADD DHTTPPEER:ID=103SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:118:181:x:x:100",RPORT=8080,NFTYPE="NF",FQDN="interplmn_0A_zz_udm181ausf01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NAME="AUSF",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1ADD DHTTPPEER:ID=104,SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:118:181:x:x:100",RPORT=8080,NFTYPE="NF",FQDN="interplmn_0A_zz_udm181udm01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NAME="UDM",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1ADD DHTTPPEER:ID=105,SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:111:183:x:x:100",RPORT=8080,NFTYPE="NF",FQDN="0A_zz_inrf183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NAME="iNRF1",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1|本命令配置SEPP的下一跳对等端配置。ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1，对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。每对接一个同网NF的地址，增加一条对应配置，若对端NF启用多个地址，则对应多条配置。SCHEME选择HTTP，同网内传输不需要加密。对端端口号配置建议如下：如果对端的服务端地址和客户端地址相同或对端地址仅作为服务端地址，对端端口号根据对端实际情况配置。如果对端地址仅作为客户端地址，对端端口号统一配置为10000。网元类型配置为NF。远端PLMN ID组标识根据现场实际情况配置。建链方式配置为动态建链。是否安全协商配置为不涉及。是否支持3gpp-Sbi-Target-apiRoot配置为不涉及。关联本端标识参数引用自ADD LOCALENDPOINT命令中的INDEX参数。
3|新增HTTP对等端组配置|ADD DHTTPPGROUP:ID=101,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=101,WEIGHT1=1,NAME="AMF"ADD DHTTPPGROUP:ID=102,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=102,WEIGHT1=1,NAME="SMF"ADD DHTTPPGROUP:ID=103,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=103,WEIGHT1=1,NAME="AUSF"ADD DHTTPPGROUP:ID=104,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=104,WEIGHT1=1,NAME="UDM"ADD DHTTPPGROUP:ID=105,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=105,WEIGHT1=1,NAME="iNRF1"|ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1。对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。如果对端NF只有一个对接业务地址，则每个NF配置为一个对等端组。如果对端NF有多个对接业务地址，对应的多个对等端配置组成一个对等端组。对等端组设备选择方式表示在对等端组内选择一个对等端来将HTTP消息路由出局，建议配置为轮选。对等端设备标识PEERID引用自ADD DHTTPPEER命令中的ID参数。
同网SEPP对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增服务端TCP链路配置|对接本大区SEPP2：ADD SERVERTCPLINK:LINKID=1,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=8080,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=10001,VPNID=3,INSTNAME="SEPP183-1"ADD SERVERTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=8080,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=10002,VPNID=3,INSTNAME="SEPP183-2"ADD SERVERTCPLINK:LINKID=3,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=8080,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=10003,VPNID=3,INSTNAME="SEPP183-3"ADD SERVERTCPLINK:LINKID=4,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=8080,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=10004,VPNID=3,INSTNAME="SEPP183-4"|本端SEPP需要针对每一个同网SEPP配置至少4条服务端TCP链路。服务端模板编号统一引用规划的1号服务端模板，用于网内通信，即PROFILEID参数引用自ADD SERVERPROFILE命令中的ID参数。本端IP地址统一配置规划的网内通信业务IP。本端端口统一使用8080。每条链路涉及的本端IP、本端端口、对端IP、对端端口的四元组不能完全相同。VPN ID引用协议栈SBI VRF编号，即编号3。
2|新增客户端TCP链路配置|对接本大区SEPP2：ADD CLIENTTCPLINK:LINKID=1,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=10001,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=8080,VPNID=3,INSTNAME="SEPP183-1"ADD CLIENTTCPLINK:LINKID=2,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=10002,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=8080,VPNID=3,INSTNAME="SEPP183-2"ADD CLIENTTCPLINK:LINKID=3,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=10003,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=8080,VPNID=3,INSTNAME="SEPP183-3"ADD CLIENTTCPLINK:LINKID=4,PROFILEID=1,LOCALIP="x:x:x:115:181:x:x:100",LOCALPORT=10004,REMOTEIP="x:x:x:115:183:x:x:100",REMOTEPORT=8080,VPNID=3,INSTNAME="SEPP183-4"|本端SEPP需要针对每一个同网SEPP配置至少4条客户端TCP链路。客户端模板编号统一引用规划的1号客户端模板，用于网内通信，即PROFILEID参数引用自ADD CLIENTPROFILE命令中的ID参数。本端IP地址统一配置规划的网内通信业务IP。本端端口不能在客户端模板端口范围内，建议在10001~20000范围内顺序配置。每条链路涉及的本端IP、本端端口、对端IP、对端端口的四元组不能完全相同。VPN ID引用协议栈SBI VRF编号，即编号3。
3|新增分区标识配置|ADD ZONE ID DESCRIPTION:ZONEID=1,DESCRIPTION="同网SEPP"|-
4|新增IPv4地址范围配置|ADD IPV4 ADDR RANGE:ID=1,START="x.x.183.x",END="x.x.183.x",ZONEID=1|每个与本端SEPP对接的同网SEPP服务端地址，配置一条对应的记录。起始地址与终止地址配置相同，对应同网的SEPP地址。与本端SEPP对接的同网SEPP，引用同一归属分区标识。归属分区标识参数引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。
5|新增IPv6地址范围配置|ADD IPV6 ADDR RANGE:ID=1,START="x:x:x:115:183:x:x:100/128",END="x:x:x:115:183:x:x:100/128",ZONEID=1|每个与本端SEPP对接的同网SEPP服务端地址，配置一条对应的记录。起始地址与终止地址配置相同，对应同网的SEPP地址。地址统一配置为128位掩码IP，例如2020:143::1:22/128。与本端SEPP对接的同网SEPP，引用同一归属分区标识。归属分区标识参数引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。
6|新增客户端静态链路选择模式|ADD CLIENT STATIC LINK SELECTION:TARGETNFTYPE="SEPP_TYPE",ZONEID=1,STATICONLY="YES"|与本端SEPP对接的本网内所有SEPP对应一条选择模式配置。目的NF类型配置为SEPP。分区标识使用对应的分区标识编号，引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。只选静态链路配置为是。
7|新增客户端模版选择配置|ADD SELPF:ID=1,IPFAMILY="IPV6",IPSTART="x:x:x:115:183:x:x:100",IPEND="x:x:x:115:183:x:x:100",PORT=8080,PROFILE1=1,RRTIME1=1,DESC="SEPP183"|ID的配置建议如下：与C链SEPP（同网且同大区的备用SEPP）建链时ID设置为1。与同网SEPP建链时，ID从2~50顺序配置。与异网SEPP建链时，ID从51~100顺序配置。与同网NF建链时，ID从101开始顺序配置。起始IP地址和终止IP地址配置相同，为对端SEPP服务端业务地址。HTTP客户端PROFILE引用规划的网内通信客户端模板编号，即引用自ADD CLIENTPROFILE命令中的ID参数。每个客户端模板选择配置只引用一个HTTP客户端PROFILE，其余为预留。安全协商标记统一配置为不协商。轮选次数配置为1。
8|新增HTTP对等端实体配置|ADD DHTTPPEER:ID=1,SCHEME="HTTP",RIPFAMILY="IPV6",RIP="x:x:x:115:183:x:x:100",RPORT=8080,NFTYPE="SSEPP",FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NAME="SEPP183",LINKESTMODE="MODE_DYNAMIC",LOCALENDID=1|ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1。对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。每对接一个同网SEPP的地址，增加一条对应配置，若对端SEPP启用多个地址，则对应多条配置。SCHEME选择HTTP，同网内传输不需要加密。对端端口号配置建议如下：如果对端的服务端地址和客户端地址相同或对端地址仅作为服务端地址，对端端口号根据对端实际情况配置。如果对端地址仅作为客户端地址，对端端口号统一配置为10000。网元类型配置为同网SEPP。远端PLMN ID组标识根据现场实际情况配置。建链方式配置为动态建链。是否安全协商配置为不涉及。是否支持3gpp-Sbi-Target-apiRoot配置为不涉及。关联本端标识参数引用自ADD LOCALENDPOINT命令中的INDEX参数。
9|新增HTTP对等端组配置|ADD DHTTPPGROUP:ID=1,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=1,WEIGHT1=1,NAME="SEPP183"|ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1。对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。如果对端同网SEPP只有一个对接业务地址，则每个同网SEPP配置为一个对等端组。如果对端同网SEPP有多个对接业务地址，对应的多个对等端配置组成一个对等端组。对等端组设备选择方式表示在对等端组内选择一个对等端来将HTTP消息路由出局，建议配置为轮选。对等端设备标识PEERID引用自ADD DHTTPPEER命令中的ID参数。
异网SEPP对接配置
步骤|说明|操作|备注
---|---|---|---
1|新增服务端TCP链路配置|对接异网SEPP5：ADD SERVERTCPLINK:LINKID=31,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=10001,VPNID=4,INSTNAME="异网SEPP182-1"ADD SERVERTCPLINK:LINKID=32,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=10002,VPNID=4,INSTNAME="异网SEPP182-2"ADD SERVERTCPLINK:LINKID=33,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=10003,VPNID=4,INSTNAME="异网SEPP182-3"ADD SERVERTCPLINK:LINKID=34,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=10004,VPNID=4,INSTNAME="异网SEPP182-4"对接异网SEPP6：ADD SERVERTCPLINK:LINKID=41,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=10011,VPNID=4,INSTNAME="异网SEPP184-1"ADD SERVERTCPLINK:LINKID=42,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=10012,VPNID=4,INSTNAME="异网SEPP184-2"ADD SERVERTCPLINK:LINKID=43,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=10013,VPNID=4,INSTNAME="异网SEPP184-3"ADD SERVERTCPLINK:LINKID=44,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=10014,VPNID=4,INSTNAME="异网SEPP184-4"对接异网SEPP7：ADD SERVERTCPLINK:LINKID=51,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=10021,VPNID=4,INSTNAME="异网SEPP186-1"ADD SERVERTCPLINK:LINKID=52,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=10022,VPNID=4,INSTNAME="异网SEPP186-2"ADD SERVERTCPLINK:LINKID=53,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=10023,VPNID=4,INSTNAME="异网SEPP186-3"ADD SERVERTCPLINK:LINKID=54,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=10024,VPNID=4,INSTNAME="异网SEPP186-4"对接异网SEPP8：ADD SERVERTCPLINK:LINKID=61,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=10031,VPNID=4,INSTNAME="异网SEPP188-1"ADD SERVERTCPLINK:LINKID=62,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=10032,VPNID=4,INSTNAME="异网SEPP188-2"ADD SERVERTCPLINK:LINKID=63,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=10033,VPNID=4,INSTNAME="异网SEPP188-3"ADD SERVERTCPLINK:LINKID=64,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=8080,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=10034,VPNID=4,INSTNAME="异网SEPP188-4"|本端SEPP需要针对每一个异网SEPP配置至少4条服务端TCP链路。服务端模板编号统一引用规划的2号服务端模板，用于网间通信，即即PROFILEID参数引用自ADD SERVERPROFILE命令中的ID参数。本端IP地址统一配置规划的网间通信业务IP。本端端口统一使用8080。每条链路涉及的本端IP、本端端口、对端IP、对端端口的四元组不能完全相同。VPN ID引用协议栈SBI-EXIT VRF编号，即编号4。
2|新增客户端TCP链路配置|对接异网SEPP5：ADD CLIENTTCPLINK:LINKID=31,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10001,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP182-1"ADD CLIENTTCPLINK:LINKID=32,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10002,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP182-2"ADD CLIENTTCPLINK:LINKID=33,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10003,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP182-3"ADD CLIENTTCPLINK:LINKID=34,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10004,REMOTEIP="x:x:x:115:182:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP182-4"对接异网SEPP6：ADD CLIENTTCPLINK:LINKID=41,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10011,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP184-1"ADD CLIENTTCPLINK:LINKID=42,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10012,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP184-2"ADD CLIENTTCPLINK:LINKID=43,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10013,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP184-3"ADD CLIENTTCPLINK:LINKID=44,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10014,REMOTEIP="x:x:x:115:184:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP184-4"对接异网SEPP7：ADD CLIENTTCPLINK:LINKID=51,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10021,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP186-1"ADD CLIENTTCPLINK:LINKID=52,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10022,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP186-2"ADD CLIENTTCPLINK:LINKID=53,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10023,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP186-3"ADD CLIENTTCPLINK:LINKID=54,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10024,REMOTEIP="x:x:x:115:186:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP186-4"对接异网SEPP8：ADD CLIENTTCPLINK:LINKID=61,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10031,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP188-1"ADD CLIENTTCPLINK:LINKID=62,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10032,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP188-2"ADD CLIENTTCPLINK:LINKID=63,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10033,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP188-3"ADD CLIENTTCPLINK:LINKID=64,PROFILEID=2,LOCALIP="x:x:x:115:181:x:x:200",LOCALPORT=10034,REMOTEIP="x:x:x:115:188:x:x:200",REMOTEPORT=8080,VPNID=4,INSTNAME="异网SEPP188-4"|本端SEPP需要针对每一个异网SEPP配置至少4条客户端TCP链路。客户端模板编号统一引用规划的2号客户端模板，用于网间通信，即PROFILEID参数引用自ADD CLIENTPROFILE命令中的ID参数。本端IP地址统一配置规划的网间通信业务IP。本端端口不能在客户端模板端口范围内，建议在10001~20000范围内顺序配置。每条链路涉及的本端IP、本端端口、对端IP、对端端口的四元组不能完全相同。VPN ID引用协议栈SBI-EXIT VRF编号，即编号4。
3|新增分区标识配置|ADD ZONE ID DESCRIPTION:ZONEID=2,DESCRIPTION="异网SEPP"|-
4|新增IPv4地址范围配置|ADD IPV4 ADDR RANGE:ID=11,START="x.x.182.x",END="x.x.182.x",ZONEID=2ADD IPV4 ADDR RANGE:ID=12,START="x.x.184.x",END="x.x.184.x",ZONEID=2ADD IPV4 ADDR RANGE:ID=13START="x.x.186.x",END="x.x.186.x",ZONEID=2ADD IPV4 ADDR RANGE:ID=14,START="x.x.186.x",END="x.x.186.x",ZONEID=2|每个与本端SEPP对接的异网SEPP服务端地址，配置一条对应的记录。起始地址与终止地址配置相同，对应异网SEPP的地址。与本端SEPP对接的同一PLMN内的异网SEPP，引用同一归属分区标识。归属分区标识参数引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。
5|新增IPv6地址范围配置|ADD IPV6 ADDR RANGE:ID=11,START="x:x:x:115:182:x:x:200/128",END="x:x:x:115:182:x:x:200/128",ZONEID=2ADD IPV6 ADDR RANGE:ID=12,START="x:x:x:115:184:x:x:200/128",END="x:x:x:115:184:x:x:200/128",ZONEID=2ADD IPV6 ADDR RANGE:ID=13,START="x:x:x:115:186:x:x:200/128",END="x:x:x:115:186:x:x:200/128",ZONEID=2ADD IPV6 ADDR RANGE:ID=14,START="x:x:x:115:188:x:x:200/128",END="x:x:x:115:188:x:x:200/128",ZONEID=2|每个与本端SEPP对接的异网SEPP服务端地址，配置一条对应的记录。起始地址与终止地址配置相同，对应异网SEPP的地址。地址统一配置为128位掩码IP，例如2020:143::1:22/128。与本端SEPP对接的同一PLMN内的异网SEPP，引用同一归属分区标识。归属分区标识参数引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。
6|新增客户端静态链路选择模式|ADD CLIENT STATIC LINK SELECTION:TARGETNFTYPE="SEPP_TYPE",ZONEID=2,STATICONLY="YES"|每个PLMN内的所有异网SEPP配置对应一条选择模式配置。目的NF类型配置为SEPP。分区标识使用对应的分区标识编号，引用自ADD ZONE ID DESCRIPTION命令中的ZONEID参数。只选静态链路配置为是。
7|新增客户端模版选择配置|ADD SELPF:ID=51,IPFAMILY="IPV6",IPSTART="x:x:x:115:182:x:x:200",IPEND="x:x:x:115:182:x:x:200",PORT=8080,PROFILE1=2,RRTIME1=1,DESC="异网SEPP182"ADD SELPF:ID=52,IPFAMILY="IPV6",IPSTART="x:x:x:115:184:x:x:200",IPEND="x:x:x:115:184:x:x:200",PORT=8080,PROFILE1=2,RRTIME1=1,DESC="异网SEPP184"ADD SELPF:ID=53,IPFAMILY="IPV6",IPSTART="x:x:x:115:186:x:x:200",IPEND="x:x:x:115:186:x:x:200",PORT=8080,PROFILE1=2,RRTIME1=1,DESC="异网SEPP186"ADD SELPF:ID=54,IPFAMILY="IPV6",IPSTART="x:x:x:115:188:x:x:200",IPEND="x:x:x:115:188:x:x:200",PORT=8080,PROFILE1=2,RRTIME1=1,DESC="异网SEPP188"|ID的配置建议如下：与C链SEPP（同网且同大区的备用SEPP）建链时ID设置为1。与同网SEPP建链时，ID从2~50顺序配置。与异网SEPP建链时，ID从51~100顺序配置。与同网NF建链时，ID从101开始顺序配置。起始IP地址和终止IP地址配置相同，为对端SEPP服务端业务地址。HTTP客户端PROFILE引用规划的网间通信客户端模板编号，即引用自ADD CLIENTPROFILE命令中的ID参数。每个客户端模板选择配置只引用一个HTTP客户端PROFILE，其余为预留。安全协商标记统一配置为不协商。轮选次数配置为1。
8|新增HTTP对等端实体配置|ADD DHTTPPEER:ID=51,SCHEME="HTTPS",RIPFAMILY="IPV6",RIP="x:x:x:115:182:x:x:200",RPORT=8080,NFTYPE="DSEPP",FQDN="0B_zz_sepp182_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org",NAME="异网SEPP182",LINKESTMODE="MODE_DYNAMIC",ISSECNEGOTIATION="NOT_SECURITY_NEGOTIATION",SUPAPIROOT="SUPPORT_APIROOT",LOCALENDID=2ADD DHTTPPEER:ID=52,SCHEME="HTTPS",RIPFAMILY="IPV6",RIP="x:x:x:115:184:x:x:200",RPORT=8080,NFTYPE="DSEPP",FQDN="0B_zz_sepp184_zx.0A.node.5gc.mnc015.mcc460.3gppnetwork.org",NAME="异网SEPP184",LINKESTMODE="MODE_DYNAMIC",ISSECNEGOTIATION="NOT_SECURITY_NEGOTIATION",SUPAPIROOT="SUPPORT_APIROOT",LOCALENDID=2ADD DHTTPPEER:ID=53,SCHEME="HTTPS",RIPFAMILY="IPV6",RIP="x:x:x:115:186:x:x:200",RPORT=8080,NFTYPE="DSEPP",FQDN="0B_zz_sepp186_zx.0B.node.5gc.mnc015.mcc460.3gppnetwork.org",NAME="异网SEPP186",LINKESTMODE="MODE_DYNAMIC",ISSECNEGOTIATION="NOT_SECURITY_NEGOTIATION",SUPAPIROOT="SUPPORT_APIROOT",LOCALENDID=2ADD DHTTPPEER:ID=54,SCHEME="HTTPS",RIPFAMILY="IPV6",RIP="x:x:x:115:188:x:x:200",RPORT=8080,NFTYPE="DSEPP",FQDN="0B_zz_sepp188_zx.0B.node.5gc.mnc015.mcc460.3gppnetwork.org",NAME="异网SEPP188",LINKESTMODE="MODE_DYNAMIC",ISSECNEGOTIATION="NOT_SECURITY_NEGOTIATION",SUPAPIROOT="SUPPORT_APIROOT",LOCALENDID=2|ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1。对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。每对接一个异网SEPP的地址，增加一条对应配置，若对端SEPP启用多个地址，则对应多条配置。SCHEME选择HTTPS，网间传输需要加密。对端端口号配置建议如下：如果对端的服务端地址和客户端地址相同或对端地址仅作为服务端地址，对端端口号根据对端实际情况配置。如果对端地址仅作为客户端地址，对端端口号统一配置为10000。网元类型配置为异网SEPP。远端PLMN ID组标识根据现场实际情况配置。建链方式配置为动态建链。是否安全协商配置为不涉及。是否支持3gpp-Sbi-Target-apiRoot配置为支持。关联本端标识参数引用自ADD LOCALENDPOINT命令中的INDEX参数。
9|新增HTTP对等端组配置|ADD DHTTPPGROUP:ID=51,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=51,WEIGHT1=1,PEERID2=52,WEIGHT2=1,NAME="异网SEPP182-184"ADD DHTTPPGROUP:ID=52,RLSMODE="ROUND-ROBIN",NVALUE=1,PEERID1=53,WEIGHT1=1,PEERID2=54,WEIGHT2=1,NAME="异网SEPP186-188"|ID的配置建议如下：对等端实体为C链SEPP（同网且同大区的备用SEPP）时，ID设置为1。对等端实体为同网SEPP时，ID从2~50顺序配置。对等端实体为异网SEPP时，ID从51~100顺序配置。对等端实体为同网NF时，ID从101开始顺序配置。对于本网SEPP而言，所有同一PLMN内的异网SEPP配置为一个HTTP对等端组。本网SEPP与多个PLMN内的异网SEPP对接，需要配置多个HTTP对等端组。对等端组设备选择方式表示在对等端组内选择一个对等端来将HTTP消息路由出局，建议配置为轮选。对等端设备标识PEERID引用自ADD DHTTPPEER命令中的ID参数。
转发路由策略配置
步骤|说明|操作|备注
---|---|---|---
1|新增路由出口配置|本大区NF类的路由出口配置：ADD DRTOUT:REFINDEX=101,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=101,HTTPBAKPGROUPID=1,DESCRIPTION="AMF"ADD DRTOUT:REFINDEX=102,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=102,HTTPBAKPGROUPID=1,DESCRIPTION="SMF"ADD DRTOUT:REFINDEX=103,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=103,HTTPBAKPGROUPID=1,DESCRIPTION="AUSF"ADD DRTOUT:REFINDEX=104,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=104,HTTPBAKPGROUPID=1,DESCRIPTION="UDM"ADD DRTOUT:REFINDEX=105,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=105,HTTPBAKPGROUPID=1,DESCRIPTION="iNRF1"异网SEPP类的路由出口配置：ADD DRTOUT:REFINDEX=51,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=51,HTTPBAKPGROUPID=1ADD DRTOUT:REFINDEX=52,RESULT="FORWARD_ROUTING_PEER_GROUP",HTTPPGROUPID=52,HTTPBAKPGROUPID=1|分别配置三类路由出口，优选HTTP对等端组分别为本大区NF、本网其他大区SEPP、异网SEPP。优选HTTP对等端组为本大区NF类的路由出口，路由出口的配置数为对接NF的数量，即本端SEPP每对接一个本大区的NF，对应配置一条路由出口。优选对等端组为对应的NF对等端组。第一备份HTTP对等端组为对应C链SEPP（同网且同大区的备用SEPP）的对等端组。第二、三HTTP对等端组为对应NF的备份容灾网元的对等端组，具体视该NF组网和容灾备份策略而定。优选HTTP对等端组为本网其他大区SEPP类的路由出口，路由出口的配置数为本网其他大区的数量，即本端SEPP每对接一个本网其他大区的SEPP，对应配置一条路由出口。优选对等端组为对应大区对接的同网SEPP对等端组。第一备份HTTP对等端组为C链SEPP的对等端组。第二、三HTTP对等端组为预留配置。优选HTTP对等端组为异网SEPP类的路由出口，路由出口的配置数为异网数量，即本端SEPP每对接一个异网运营商，对应配置一条路由出口。优选对等端组为与本端SEPP对接的异网内所有SEPP的对等端组。第一备份HTTP对等端组为C链SEPP的对等端组。第二、三HTTP对等端组为预留配置。本配置中的HTTP对等端组ID均引用自ADD DHTTPPGROUP命令中的ID参数。
2|新增目的主机名路由配置|异网运营商FQDN通配类的路由配置：异网A省NF的路由配置：ADD DRTDHOST:REFINDEX=40000,DHOST="0A.node.5gc.mnc015.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=51,DESC="异网SEPP-A省NF"ADD DRTDHOST:REFINDEX=40000,DHOST="set02.region02.amf.5gc.mnc015.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=51,DESC="异网SEPP-A省AMF"异网B省NF的路由配置：ADD DRTDHOST:REFINDEX=40000,DHOST="0B.node.5gc.mnc015.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=52,DESC="异网SEPP-B省NF"ADD DRTDHOST:REFINDEX=40000,DHOST="set12.region12.amf.5gc.mnc015.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=52,DESC="异网SEPP-B省AMF"本大区NF的具体FQDN类的路由配置：ADD DRTDHOST:REFINDEX=40000,DHOST="interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=101,DESC="AMF"ADD DRTDHOST:REFINDEX=40000,DHOST="interplmn_0A_zz_smf181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=102,DESC="SMF"ADD DRTDHOST:REFINDEX=40000,DHOST="interplmn_0A_zz_udm181ausf01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=103,DESC="AUSF"ADD DRTDHOST:REFINDEX=40000,DHOST="interplmn_0A_zz_udm181udm01_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=104,DESC="UDM"ADD DRTDHOST:REFINDEX=40000,DHOST="0A_zz_inrf183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",NEXTRULE="OUT",NEXTINDEX=105,DESC="iNRF1"|分别配置三类目的主机名路由，目的主机名分别为异网运营商FQDN通配、本网其他大区NF的FQDN通配和本大区NF的具体FQDN。目的主机名为异网运营商FQDN通配类的路由，配置数量为异网运营商数量，即每对接一个异网运营商，对应配置一条路由策略，目的主机名为5gc.mnc015.mcc460.3gppnetwork.org，下一路由参考号关联对应运营商的异网SEPP路由出口配置。目的主机名为本网其他大区NF的FQDN通配类的路由，配置数量根据FQDN通配数量而定，一般一个省份配置一条，主机名例为0B.node.5gc.mnc006.mcc460.3gppnetwork.org，下一路由参考号关联对应本域异大区的SEPP路由出口配置。目的主机名为本大区NF的具体FQDN类的路由，配置数量根据具体NF数量而定，每个NF对应配置一条，例如AMF的主机名为interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org，下一路由参考号关联对应直连对接NF的路由出口配置。本配置中的下一路由参考号均引用自ADD DRTOUT命令中的REFINDEX参数。
3|新增路由入口配置|ADD DRTPROXY:ID=40001,APPID="AMF",RULE="DHOST",REFINDEX=40000,DESC="AMF"ADD DRTPROXY:ID=40002,APPID="AUSF",RULE="DHOST",REFINDEX=40000,DESC="AUSF"ADD DRTPROXY:ID=40003,APPID="NRF",RULE="DHOST",REFINDEX=40000,DESC="NRF"ADD DRTPROXY:ID=40004,APPID="SMF",RULE="DHOST",REFINDEX=40000,DESC="SMF"ADD DRTPROXY:ID=40005,APPID="UDM",RULE="DHOST",REFINDEX=40000,DESC="UDM"|根据目标网元类型，配置对应的5条路由入口配置，标识按配置建议规划。目标NFTYPF分别为AMF、AUSF、NRF、SMF和UDM。下一个路由规则配置为目的主机名。下一个路由索引号配置为40000。该参数引用自ADD DRTDHOST命令中的查询索引号参数。
错误码处理配置
步骤|说明|操作|备注
---|---|---|---
1|新增HTTP错误码配置|ADD HTTP ERROR CODE:HTTPERRCODEID=408,HTTPERRCODE=408,CAUSE="DEFAULT"ADD HTTP ERROR CODE:HTTPERRCODEID=429,HTTPERRCODE=429,CAUSE="DEFAULT"ADD HTTP ERROR CODE:HTTPERRCODEID=500,HTTPERRCODE=500,CAUSE="DEFAULT"|分别配置三个HTTP错误码，错误码标识为408、429和500。408错误码标识，对应HTTP错误码为408，原因值为DEFAULT。429错误码标识，对应HTTP错误码为429，原因值为DEFAULT。500错误码标识，对应HTTP错误码为500，原因值为DEFAULT。
2|新增错误码条件配置|ADD DREROUTE:ID=1,FAILCODE=408,MODE="M_REROUTING",NAME="Request_Timeout"ADD DREROUTE:ID=2,FAILCODE=429,MODE="M_REROUTING",NAME="Too_Many_Requests"ADD DREROUTE:ID=3,FAILCODE=500,MODE="M_REROUTING",NAME="Internal_Server_Error"|分别配置三个错误码处理策略，标识分别为1，2，3。标识1的配置，对应错误码标识引用408，名称为Request_Timeout。标识2的配置，对应错误码标识引用429，名称为Too_Many_Requests。标识3的配置，对应错误码标识引用500，名称为Internal_Server_Error。
拓扑隐藏配置
步骤|说明|操作|备注
---|---|---|---
1|新增拓扑隐藏条件配置|ADD DSCPTOPOCOND:DESTIP="x:x:x:115:182:x:x:200",NFTYPE="NRF"&"UDM"&"AMF"&"SMF"&"AUSF"&"NEF"&"PCF"&"SMSF"&"NSSF"&"UDR"&"LMF"&"GMLC"&"5G_EIR"&"AF"&"UDSF"&"BSF"&"CHF"&"V-SMF"&"I-SMF"&"H-SMF"&"NWDAF"&"UCMF"&"NSSAAF"&"AANF"&"NSACF"&"MFAF"&"EASDF"&"DCCF"&"TSCTSF"&"ADRF",DESC="异网SEPP182"ADD DSCPTOPOCOND:DESTIP="x:x:x:115:184:x:x:200",NFTYPE="NRF"&"UDM"&"AMF"&"SMF"&"AUSF"&"NEF"&"PCF"&"SMSF"&"NSSF"&"UDR"&"LMF"&"GMLC"&"5G_EIR"&"AF"&"UDSF"&"BSF"&"CHF"&"V-SMF"&"I-SMF"&"H-SMF"&"NWDAF"&"UCMF"&"NSSAAF"&"AANF"&"NSACF"&"MFAF"&"EASDF"&"DCCF"&"TSCTSF"&"ADRF",DESC="异网SEPP184"ADD DSCPTOPOCOND:DESTIP="x:x:x:115:186:x:x:200",NFTYPE="NRF"&"UDM"&"AMF"&"SMF"&"AUSF"&"NEF"&"PCF"&"SMSF"&"NSSF"&"UDR"&"LMF"&"GMLC"&"5G_EIR"&"AF"&"UDSF"&"BSF"&"CHF"&"V-SMF"&"I-SMF"&"H-SMF"&"NWDAF"&"UCMF"&"NSSAAF"&"AANF"&"NSACF"&"MFAF"&"EASDF"&"DCCF"&"TSCTSF"&"ADRF",DESC="异网SEPP186"ADD DSCPTOPOCOND:DESTIP="x:x:x:115:188:x:x:200",NFTYPE="NRF"&"UDM"&"AMF"&"SMF"&"AUSF"&"NEF"&"PCF"&"SMSF"&"NSSF"&"UDR"&"LMF"&"GMLC"&"5G_EIR"&"AF"&"UDSF"&"BSF"&"CHF"&"V-SMF"&"I-SMF"&"H-SMF"&"NWDAF"&"UCMF"&"NSSAAF"&"AANF"&"NSACF"&"MFAF"&"EASDF"&"DCCF"&"TSCTSF"&"ADRF",DESC="异网SEPP188"|本SEPP每对接一个异网SEPP，对应配置一条拓扑隐藏条件。目的IP配置对应的异网SEPP地址，服务端地址和客户端地址分别对应配置。网元类型除NULL以外全选。
2|新增预共享密钥配置|ADD DSCPPSK:PSKID="nf@cu.com12345678901234567890123456789012345",PSKVALUE="***********************************"|预共享密钥ID由本运营商提供。预共享密钥值由本运营商输入。
3|新增拓扑策略配置|FQDN隐藏配置：ADD TOPO POLICY:HOSTNAME="0A.node.5gc.mnc006.mcc460.3gppnetwork.org",REPLACEMODE="ENCRYPTED_REPALCE",LABELNUM=7,PSKID="nf@cu.com12345678901234567890123456789012345"IP隐藏配置：ADD TOPO POLICY:HOSTNAME="x:x:x:103:181:x:x:100",REPLACEMODE="ENCRYPTED_REPALCE",DOMAIN="0A.node.5gc.mnc006.mcc460.3gppnetwork.org",PSKID="nf@cu.com12345678901234567890123456789012345"ADD TOPO POLICY:HOSTNAME="x:x:x:116:181:x:x:100",REPLACEMODE="ENCRYPTED_REPALCE",DOMAIN="0A.node.5gc.mnc006.mcc460.3gppnetwork.org",PSKID="nf@cu.com12345678901234567890123456789012345"ADD TOPO POLICY:HOSTNAME="x:x:x:111:181:x:x:100",REPLACEMODE="ENCRYPTED_REPALCE",DOMAIN="0A.node.5gc.mnc006.mcc460.3gppnetwork.org",PSKID="nf@cu.com12345678901234567890123456789012345"|SEPP配置三类拓扑策略，分别为FQDN隐藏、IPv6隐藏和IPv4隐藏。FQDN隐藏策略，主机名根据实际情况填写为本运营商的PLMN。多个PLMN对应配置多条策略。IPv6隐藏策略，主机名配置为0::0/0，即IPv6通配。IPv4隐藏策略，主机名配置为0.0.0.0/0，即IPv4通配。隐藏方式统一配置为加密替换。保留Lable个数在FQDN隐藏策略配置中配置为5。域名在IPv4隐藏策略和IPv6隐藏策略配置中配置为本运营商域名。密钥ID取值引用自ADD DSCPPSK命令中的预共享密钥ID参数。
PLMN ID校验配置（中国移动配置）
步骤|说明|操作|备注
---|---|---|---
1|新增本地PLMN ID配置|ADD LOCAL PLMN ID:INDEX=1,MCC="460",MNC="06"ADD LOCAL PLMN ID:INDEX=2,MCC="460",MNC="32"|本运营商的每一个合法的PLMN ID，对应配置一条记录。移动国家码统一配置为460。移动网号按照现场实际情况填写，取两位即可。
2|新增本地PLMN ID组配置|ADD LOCAL PLMN ID ARRAY:ARRAYID=1,PLMNID=1ADD LOCAL PLMN ID ARRAY:ARRAYID=1,PLMNID=2|本运营商的每一个合法的PLMN ID，对应配置一条记录。PLMN ID组标识统一配置为1。PLMN ID配置索引引用所有本地合法PLMN ID，即引用ADD LOCAL PLMN ID命令中的INDEX参数。
3|新增远端PLMN ID配置|ADD REMOTE PLMNID:INDEX=1,MCC="460",MNC="15"ADD REMOTE PLMNID:INDEX=2,MCC="460",MNC="22"|对端运营商的每一个合法的PLMN ID，对应配置一条记录。移动国家码统一配置为460。移动网号按照现场实际情况填写，取两位即可。
4|新增远端PLMN ID组配置|ADD REMOTE PLMNID ARRAY:ARRAYID=1,PLMNID=1ADD REMOTE PLMNID ARRAY:ARRAYID=1,PLMNID=2|对端运营商的每一个合法的PLMN ID，对应配置一条记录。PLMN ID组标识按照各运营商合法PLMN ID组设置对应标识，从1开始配置。PLMN ID配置索引引用所有远端合法PLMN ID，即引用自ADD REMOTE PLMNID命令中的INDEX参数。
5|设置本端PLMN ID校验|SET DSCPADDR:PLMNCHECK="CHECK_ON",LPLMNIDARRID=1|本端PLMN ID组标识取值引用自ADD LOCAL PLMN ID ARRAY命令中的ARRAYID参数。
6|设置对等端PLMN ID校验|SET DHTTPPEER:ID=51,RPLMNIDARRID=1SET DHTTPPEER:ID=52,RPLMNIDARRID=1|每个需要校验的异网SEPP对等端都必须执行本配置。远端PLMN ID组标识引用对应域的合法PLMN ID组，即引用自ADD REMOTE PLMNID ARRAY命令中的ARRAYID参数。
#### AMF 
以运营商A在A省部署的AMF为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|新增TA配置|ADD TACFG:TAID=1,MCC="460",MNC="32",TAC="0A000A",TANAME="TA-1",TAVOICEPOLICYTEMPID=1,EMERGCAPA="BOTHNRANDEUTRANSPRT",SPRTEMERGFALLBACK="YES",EMERGFALLBACKCAPA="BOTHNRANDEUTRANSPRT",EMERGENCYNUMLISTID=0,EXTEMERGNUMLISTID=0|配置共享PLMN的TA信息。
2|新增注册区域配置|ADD REGAREACFG:REGAREAID=1,REGAREANAME="TA-1"|为共享PLMN的TA增加注册区域。
3|新增注册区域跟踪区标识列表配置|ADD REGAREA TAIDLIST:REGAREAID=1,TAID=1|将注册区域与TA关联。REGAREAID参数引用自ADD REGAREACFG命令配置的参数REGAREAID，必须通过ADD REGAREACFG命令预先配置。TAID参数引用于ADD TACFG命令配置的参数TAID，必须通过ADD TACFG命令预先配置。
4|新增AMF跟踪区配置|ADD AMFTACFG:TAID=1,MCC="460",MNC="32",TAC="0A000A",NAME="TA-1"|配置共享PLMN的TA信息。
5|新增GUAMI配置|ADD GUAMICFG:GUAMIID=2,MCC="460",MNC="32",REGIONID=1,SETID=1,POINTID=1|配置共享PLMN的GUAMI。
ADD GUAMICFG:GUAMIID=3,MCC="460",MNC="32",REGIONID=1,SETID=1,POINTID=2|5|新增GUAMI配置|配置本AMF对应主用局的共享PLMN的GUAMI。AMFID填写主用AMF的AMFID，AMF Identifier = AMF Region ID+AMF Set ID+AMF Pointer。
6|新增本局GUAMI配置|ADD LOCALGUAMI:GUAMIID=2|将共享PLMN的GUAMI配置为本局GUAMI。GUAMIID参数引用自ADD GUAMICFG命令中的GUAMIID，必须通过ADD GUAMICFG命令预先配置。
7|新增本局其他PLMN配置|ADD PLMNCFG:PLMNID="1",MCC="460",MNC="32"|将共享PLMN配置为本局其他HPLMN。
8|新增备份AMF配置|ADD BACKUPAMF:GUAMIID=2,AMFNAME="pt02.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org",INTERPLMNAMFNAME="interplmn.pt02.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org"|配置共享PLMN的GUMAI关联的备份AMF。
9|新增接管AMF配置|ADD TAKEOVERAMF:BACKUPGUAMI=3,MASTERAMFNAME="pt02.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org"|配置本AMF为主用局共享PLMN的GUAMI的接管AMF。BACKUPGUAMI参数配置主用局共享PLMN的GUAMI，可通过查询SHOW GUAMICFG命令获取。MASTERAMFNAME参数配置主用局的AMF name，可通过SHOW AMFLOCALOFFICECFG命令获取。
10|新增路由集配置|ADD SBISCPROUTESET:ID=1,NAME="SEPPRouteSet1",ADDDISCOVERY="OPTION_NO"|-
11|新增服务器配置|ADD SBISCPSERVER:ID=1,FQDN="0A_zz_sepp181_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100ADD SBISCPSERVER:ID=2,FQDN="0A_zz_sepp183_zx.0A.node.5gc.mnc006.mcc460.3gppnetwork.org",ROUTESETID=1,PRIORITY=100,WEIGHT=100|配置两个SEPP负荷分担，两个SEPP的优先级和权重相同。ROUTESETID参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
12|新增节点配置|ADD SBISCPNODE:ID=1,SERVERIPADDR="x:x:x:115:181:x:x:100",SERVERPORT=8080,SCPSERVERID=1,CLIENTPROFILEID=1ADD SBISCPNODE:ID=1,SERVERIPADDR="x:x:x:115:183:x:x:100",SERVERPORT=8080,SCPSERVERID=2,CLIENTPROFILEID=1|SCPSERVERID参数引用自ADD SBISCPSERVER命令中的ID，必须通过ADD SBISCPSERVER命令预先配置。
13|设置SEPP基本属性配置|SET SBISEPPBASICATTRIBUTE:SEPPSWITCH="SEPP_ON",CALLBACKMODE="SEPP_TARGETAPIROOT",IPSELECTMODE="IPV6_FIRST"|SEPPSWITCH配置为SEPP_ON（启用SEPP功能），IPSELECTMODE根据运营商策略要求配置。
14|新增归属PLMN配置|ADD SBIHOMEPLMN:MCC="460",MNC="06"ADD SBIHOMEPLMN:MCC="460",MNC="32"|配置本局所有的HPLMN，包括共享PLMN。
15|新增SEPP按PLMN选择配置|ADD SBISEPPSELBYPLMN:MCC="460",MNC="15",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
16|新增SEPP按FQDN选择配置|ADD SBISEPPSELBYFQDN:FQDN="mnc015.mcc460.3gppnetwork.org",SEPPMODE="SEPP_TARGETAPIROOT",SCPROUTESET=1|根据运营商的策略要求配置，FQDN使用通用配置。SCPROUTESET参数引用自ADD SBISCPROUTESET命令中的ID，必须通过ADD SBISCPROUTESET命令预先配置。
17|新增EPLMN模板配置|ADD EPLMNPROFILE:PROFILEID=1,MCC="460",MNC="22"ADD EPLMNPROFILE:PROFILEID=2,MCC="460",MNC="15"|运营商B的HPLMN和共享PLMN。
18|新增EPLMN跟踪区组配置|ADD EPLMNTAGROUPCFG:TAGROUPID=1,MCC="460",MNC="32",TAC="0A000A"|根据实际情况配置单个TA或TA组。
19|新增基于SUPI号段和区域的EPLMN配置|ADD SUPIAREAEPLMN:SUPISEGMENT="46006",AREATYPE="EPLMNAllAMFAREA",TAGRPID=0,MCC="FFF",MNC="FFF",TAC="000000",PROFILEID=1ADD SUPIAREAEPLMN:SUPISEGMENT="46015",AREATYPE="EPLMNAllAMFAREA",TAGRPID=0,MCC="FFF",MNC="FFF",TAC="000000",PROFILEID=2|将运营商B分配给运营商A的共享PLMN配置为EPLMN分配给运营商A本网的用户。将运营商B的HPLMN作为EPLMN分配给运营商B的漫游用户。参数引用关系如下：TAGRPID参数引用自ADD EPLMNTAGROUPCFG命令中的TAGROUPID，必须通过ADD EPLMNTAGROUPCFG命令预先配置。PROFILEID参数引用自ADD EPLMNPROFILE命令中的PROFILEID，必须通过ADD EPLMNPROFILE命令预先配置。
20|设置切换限制列表配置|SET AMFSUPPORTCARRYHORESTRLIST:SUPHORESTRLIST="AMFSUPTCARRYHORESTRLIST",ONLYSERVPLMNINRATRES="NOTONLYSERVPLMNRESTRI",ONLYSERVPLMNINCNRES="NOTONLYSERVPLMNRESTRI"|运营商规划需要AMF下发移动性限制列表给RAN侧：针对漫游用户，AMF将运营商B的HPLMN作为EPLMN下发给RAN侧。针对本网用户，AMF将运营商B的共享PLMN作为EPLMN下发给RAN侧。
21|设置DNN参数配置|SET DNNPARAMETERCFG:HRCARRYDNNOI="CARRYOI"|设置HR漫游用户携带的DNN包含DNN OI，即HRCARRYDNNOI配置为CARRYOI。
22|设置漫游切片映射策略配置|SET DFTROAMSLICEMAPPLYCFG:SUPROAMSLICEMAP="SPRT",SLICEMAPORG="NSSF",CARRYSTANDMAP="CARRY",TAKEDFTSLICEMAP="YES",REJPDUEST="NO"|两个运营商使用的切片不同时，需要配置切片映射策略。
23|新增基于SUPI号段切片映射策略配置|ADD SUPISEGROAMSLICEMAPPLYCFG:SUPISEG="46015",SUPROAMSLICEMAP=SPRT,SLICEMAPORG=LOCAL,CARRYSTANDMAP=CARRY,TAKEDFTSLICEMAP=NO,REJPDUEST=NO|当网络中未使用NSSF时，需要AMF配置本地切片映射。设置AMF支持根据漫入的异网用户号段进行漫游切片映射。
24|新增基于SUPI号段和归属地S-NSSAI切片映射配置|ADD SUPIHSNSSAIMAPCFG:SUPISEG="46015",HOMESST=eMBB,HOMESD=NULL,MCC="460",MNC="32",SERVERSST=eMBB,SERVERSD=000000|当网络中未使用NSSF时，需要AMF配置本地切片映射。新增漫入的运营商用户号段及其归属地切片（漫入的运营商用户签约切片），和拜访地切片（本网支持的人网切片）之间的映射关系。
25|设置默认Configured Snssai 策略配置|SET DEFAULT CONFIG SNSSAI POLICY:DEFACONFISNSSAIPOL="SUBSCRIPTION"|将Configured NSSAI的默认获取策略设置为"签约(SUBSCRIPTION)"，即AMF下发给UE的Configured NSSAI是签约NSSAI。
26|设置AMF本局配置|SET AMFLOCALOFFICECFG:INTERPLMNFQDN="interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org",INTERPLMNFQDNFLG="ISVALID"|配置AMF的interplmn FQDN。
27|设置服务发现配置|SET SBISRVDISCOVERY:SUBWITHPLMN="YES"|配置订阅请求消息携带被订阅NF所属的PLMN ID。
28|设置订阅参数配置|SET SBISUBPARAM:INTERPLMNSUBSWITCH="SWITCH_ON",SUBREQINTERPLMNFQDN="interplmn.pt01.set01.region01.amf.5gc.mnc006.mcc460.3gppnetwork.org",CBINTERPLMNFQDN="SWITCH_ON"|INTERPLMNSUBSWITCH配置为SWITCH_ON，表示订阅请求消息携带request plmn。SUBREQINTERPLMNFQDN配置订阅请求消息携带的interplmnfqdn。SUBREQINTERPLMNFQDN参数引用自SET AMFLOCALOFFICECFG命令中的INTERPLMNFQDN参数，需要通过SET AMFLOCALOFFICECFG命令预先配置。
29|设置N14接口参数配置|SET N14INTERFACEPARAMETERCFG:IFSERVINGPLMN="CARRYSERVINGPLMN",IFADDITIONSNSSAI=CARRY|跨PLMN的网络间开启N14接口时需要进行该配置。
30|设置跨PLMN移动全局策略配置|SET GLOBALINTERPLMNMOBPLY:IFSPRTINTERPLMNMOB="SPRT",IFSKIPN14IN="NOSPRT",IFSKIPN14OUT="NOSPRT",IFSKIPN26IN="SPRT",IFSKIPN26OUT="SPRT",IFGETSUCIFAILFROMOLD="SPRT",CAUSEFAILFROMOLD="UEIDNOTDERIVEDBYNET"|根据实际组网配置IFSKIPN14IN和IFSKIPN14OUT。
31|接入限制配置|ADD RESTRICTAREACFG:RESAREAID=1,RESAREATYPE="PLMNAREA",MCC="460",MNC="32",TAGRPID=0ADD RESTRICTAREACFG:RESAREAID=2,RESAREATYPE="PLMNAREA",MCC="460",MNC="06",TAGRPID=0SET NUMSEGRESTAREADEFPOLICFG:SUPPAREARESTSUPI="SUPPAREARESTSUPI",DFTAREARESTPOLISUPI="DEFNOTRESTAREASUPI"ADD NUMSEGRESTAREACFG:NUMBERSEG="46015",NUMBERTYPE=ACCESSRESTNUMSUPI,RESAREAID=1,ACCRESTPOLICY=RESTACCESSAREA,ACCRESTCAUSE=PLMNNOALLOWEDADD NUMSEGRESTAREACFG:NUMBERSEG="46015",NUMBERTYPE=ACCESSRESTNUMSUPI,RESAREAID=2,ACCRESTPOLICY=RESTACCESSAREA,ACCRESTCAUSE=PLMNNOALLOWED,COUNTER=15|配置原则：漫游用户只允许从各自专用的共享PLMN接入。
32|设置缺省QoS控制策略配置|SET DEFAULT QOS CONTROL POLICY:SUPQOSCTRL="SUPQOSCTRL",POLICY="UEAMBRLOCAL",UEAMBRDL="1024000",UEAMBRUL="512000",UNIT="AMBRKBPS"|根据运营商的策略要求进行配置。
33|基于SUPI的QoS控制策略配置|ADD CONFIG QOS CONTROL POLICY SUPI:SUPISEG="46015",POLICY="UEAMBRSMALLER",UEAMBRDL="300",UEAMBRUL="300",UNIT="AMBRMBPS"|根据运营商的策略要求进行配置。
34|新增基于SUPI的语音参数策略配置|ADD 5GSUPIVOICEPOLICY:SUPI="46015",ACCESSTYPE="_3GPP",IMSVOPS="SPRT"|配置漫游用户支持IMSVOPS，即IMSVOPS配置为SPRT。
35|新增基于PLMN的NRF发现A-SMF参数配置|ADD PLMN NRFDISCSMFPARA:MCC=460,MNC=15,DNN=NULL,CARRYPREFERREDTAI=NotSupPreferredTai,CARRYTA=SupTai|基于用户PLMN建立PDU会话流程中，AMF通过NRF发现hSMF时，AMF发送给NRF的Nnrf_NFDiscovery请求消息中携带TAI参数。
36|设置45号软参|SET COMMU SOFTWARE PARAMETER:ID=45,VALUE=1|配置AMF进行NF订阅时携带目标PLMN-ID参数。
37|设置531号软参|SET COMMU SOFTWARE PARAMETER:ID=531,VALUE=1|配置异网漫游场景中，AMF向NRF发现老局AMF/目标AMF时，携带target-plmn-list和requester-plmn-list参数。
38|设置542号软参|SET COMMU SOFTWARE PARAMETER:ID=542,VALUE=0|配置AMF向SMF发送关于HR漫游用户的SmContextCreateData消息时，不携带HsmfId。
39|设置554号软参|SET COMMU SOFTWARE PARAMETER:ID=554,VALUE=1|配置异网漫游场景下，AMF向UDM订阅消息时，请求中携带plmnId。
40|设置584号软参|SET COMMU SOFTWARE PARAMETER:ID=584,VALUE=1|配置异网漫游场景下，老局AMF向新局AMF发送的UeContextTransferRspData信息中携带归属地切片。
41|设置585号软参|SET COMMU SOFTWARE PARAMETER:ID=585,VALUE=1|配置AMF给SMF发送的SmContextCreateData中为漫游PDU会话携带hplmnSnssai。
42|设置596号软参|SET COMMU SOFTWARE PARAMETER:ID=596,VALUE=1|配置AMF给SMF发送的SmContextCreateData中为HR漫游PDU会话携带DTSSA特性。
43|设置608号软参|SET COMMU SOFTWARE PARAMETER:ID=608,VALUE=1|配置局间切换流程中，Source AMF向NRF发现Target AMF时携带切片的方式根据目标TA的PLMN决策。异网切换时，如果用户SUPI号码和TargetTA中的PLMN一样，则携带Allowed切片中的H-Snssai。如果SUPI和TargetTA中的PLMN不一样，则不携带切片。
44|设置626号软参|SET COMMU SOFTWARE PARAMETER:ID=626,VALUE=1|配置AMF向NRF发送的注册或者更新消息中Service字段支持携带interPlmnFqdn参数。
45|设置664号软参|SET COMMU SOFTWARE PARAMETER:ID=664,VALUE=1|配置非漫入用户跨AMF移动过程中，新局AMF解析老局AMF失败时，新局AMF向UE获取SUCI。
46|设置667号软参|SET COMMU SOFTWARE PARAMETER:ID=667,VALUE=0|配置用户跨AMF进行初始注册，新局AMF解析老局AMF失败，或向老局AMF获取上下文失败时，依据ID为66的软参判断流程是否继续。
47|设置671号软参|SET COMMU SOFTWARE PARAMETER:ID=671,VALUE=1|针对互操作流程中基于HR架构的漫游，当AMF向NRF发送hSMF发现请求消息时，优化消息中TargetPlmn的获取策略，获取TargetPlmn的顺序依次为：DNN OI、PGW FQDN、SUPI。
48|设置673号软参|SET COMMU SOFTWARE PARAMETER:ID=673,VALUE=1|配置漫游切片映射功能开启时触发N2切换流程，Target AMF向UDM获取切片签约数据。
49|设置565号软参|SET COMMU SOFTWARE PARAMETER:ID=565,VALUE=1|配置局间HO切换，未切换的会话发生I-SMF/V-SMF改变/删除时，AMF通知Source I-SMF/V-SMF释放。
#### MME 
以运营商A在A省部署的MME为例，配置参见下表。 
步骤|说明|操作|备注
---|---|---|---
1|对等PLMN Profile增加PLMN配置|ADD MME PLMN:PROFILEID=1,PLMN="460"-"22"|如果已存在EPLMN Profile，使用该命令增加漫游网络的共享PLMN作为EPLMN下发给本网的用户。
2|新增对等PLMN Profile配置|ADD MME PLMN PROFILE:PROFILEID=1,PLMN="460"-"22"|如果不存在EPLMN Profile，使用该命令新增一个EPLMN Profile，将漫游网络的共享PLMN作为EPLMN下发给本网的用户。
3|新增MME IMSI对等PLMN配置|ADD MME IMSI TAI PLMN:IMSI="46006",ISALLTA="YES",PROFILEID=1|配置本网用户在全TA区域下发EPLMN。PROFILEID参数引用自ADD MME PLMN PROFILE或ADD MME PLMN命令中的PROFILEID参数，需要预先配置。
4|设置移动管理参数配置|SET MOBILE MANAGEMENT:MMEEPLMNLISTNUM="5 EPLMNs"|设置最大支持的EPLMN组数，根据实际情况配置。
#### SGSN 
以运营商A在A省部署的SGSN网元为例，配置参加下表。 
步骤|说明|操作|备注
---|---|---|---
1|对等PLMN Profile增加PLMN配置|ADD SGSN PLMN:PROFILEID=1,PLMN="460"-"22"|如果已存在EPLMN Profile，使用该命令增加漫游网络的共享PLMN作为EPLMN下发给本网的用户。
2|新增对等PLMN Profile配置|ADD SGSN PLMN PROFILE:PROFILEID=1,PLMN="460"-"22"|如果不存在EPLMN Profile，使用该命令新增一个EPLMN Profile，漫游网络的共享PLMN作为EPLMN下发给本网的用户。
3|新增SGSN IMSI对等PLMN配置|ADD SGSN IMSI RAI PLMN:IMSI="46006",ISALLRA="YES",PROFILEID=1|配置本网用户在全TA区域下发EPLMN。PROFILEID参数引用自ADD SGSN PLMN PROFILE或ADD SGSN PLMN命令中的PROFILEID参数，需要预先配置。
#### 测试用例 
测试项目|漫游用户在拜访地初始接入
---|---
测试目的|验证终端在非漫游区域关机、在漫游区域开机并注册成功。
预置条件|拜访网络和归属网络中5GC各网元系统及操作维护平台运行正常。设置发现AUSF/UDM的策略为NRF发现。服务化接口的信令监控、分析工具或者仪表准备就绪。
测试过程|终端在漫游区域内首次开机，并携带SUCI进行初始注册。
通过准则|终端在漫游区域首次开机注册，携带SUCI，RAN将请求发给漫游网络的AMF。AMF携带用户HPLMN、SUCI中的Routing indicator或SUPI向NRF发送发现AUSF请求。AMF携带SUPI、用户HPLMN向NRF发送发现UDM请求。终端注册成功，AMF向终端发送Registration Accept（5G-GUTI，Registration Area，Allowed NSSAI，Equival Plmn List，Periodic Registration Update timer等）消息。在AMF中可以查询到用户注册信息。
测试结果|-
测试项目|漫游用户在拜访地发起会话建立
---|---
测试目的|验证终端在漫游区域开机并成功建立会话。
预置条件|拜访网络和归属网络中5GC各网元系统及操作维护平台运行正常.终端在拜访地发起PDU会话建立。
测试过程|终端在漫游区域内首次开机，并携带SUCI进行初始注册。终端在漫游区域发起PDU会话建立。
通过准则|终端在拜访地发出NAS消息（S-NSSAI（可选），DNN，PDU session ID，Request type，PDU Session Establishment Request）。AMF根据DNN、S-NSSAI等信息选择vSMF以及hSMF信息。AMF给vSMF发送Nsmf_PDUSession_CreateSMContext请求（SUPI，DNN，S-NSSAI，PDU session ID，AMF ID，Request Type，H-PCF ID（可选），N1 SM container（PDU Session Establishment Request)，User location information，Access Type，H-SMFUri）。同时AMF也会将hSMF的identity以及HPLMN对应的S-NNSSAI信息带给vSMF。vSMF向AMF发送Nsmf_PDUSession_CreateSMContext Response（Cause, SM Context ID）。vSMF选择vUPF。vSMF使用选定的vUPF启动N4会话建立过程，vSMF分配V-CN Tunnel Info给vUPF。vSMF到hSMF发送Nsmf_PDUSession_Create Request（SUPI，DNN，S-NSSAI，PDU Session ID，V-SMF ID，V-CN Tunnel Info，User location information，H-PCF ID）。hSMF使用Nudm_UECM_Registration（SUPI，DNN，S-NSSAI with the value defined by the HPLMN，PDU Session ID）向归属地对应的UDM进行注册，获取签约数据并进行订阅流程。hSMF选择hUPF（PSA）启动N4会话建立过程，hSMF分配H-CN Tunnel Info给hUPF（PSA）。hSMF向vSMF返回Nsmf_PDUSession_Create Response（QoS Rule(s)，H-CN Tunnel Info，QFI(s)，QoS profile(s)，Session-AMBR）。vSMF到AMF发送Namf_Communication_N1N2MessageTransfer（PDU Session ID，N2 SM information（PDU Session ID，QFI(s)，QoS Profile(s)，I-CN Tunnel Info，S-NSSAI from the Allowed NSSAI，Session-AMBR，PDU Session Type，N1 SM container（PDU Session Establishment Accept））） 。AMF到(R)AN发送N2 PDU Session Request（N2 SM information，NAS message（PDU Session ID，N1 SM container（PDU Session Establishment Accept））） 。AN到AMF发送N2 PDU Session Response（PDU Session ID，Cause，N2 SM information（PDU Session ID，AN Tunnel Info）。AMF 向vSMF发送Nsmf_PDUSession_UpdateSMContext Request（N2 SM information，Access type）。vSMF向vUPF发起N4 Session Modification流程（AN Tunnel Info）。vSMF到AMF发送 Nsmf_PDUSession_UpdateSMContext Response。
测试结果|-
测试项目|漫游用户在拜访地发起语音呼叫
---|---
测试目的|验证用户在拜访地可以成功发起语音呼叫。
预置条件|拜访网络和归属网络中5GC各网元系统及操作维护平台运行正常。归属SMF已配置VoLTE SBC地址列表。gNB配置为VoNR工作模式。终端A和终端B均为5G用户， 终端A为漫入用户，终端B为漫出用户，在各自归属网络UDM/HSS中正常签约。终端A和终端B在5GC和IMS已正常注册，且处于IDLE状态。
测试过程|使用信令跟踪功能对相关接口进行跟踪。终端A发起到终端B的语音呼叫。
通过准则|终端A发起呼叫前，正确触发Service Request流程。终端A发起呼叫至归属IMS网络，IMS网络发起查询至SMF、PCF，IMS网络发起专用承载建立。gNB和5GC成功建立5QI=1的QoS flow。PCF能支持Rx和N7的会话绑定、协议转换，以及QCI=1的承载建立。SMF调用Npcf_SMPolicyControl_UpdateNotify服务，PCF在AAA消息中上报5G的IP-CAN-Type和RAT-Type参数。SMF调用Npcf_SMPolicyControl_Update服务，PCF在RAR消息中正确上报终端A和终端B的5G位置信息。VoLTE SBC能正确识别PCF上报的5G位置信息，并能根据本地配置，使用用户位置在PANI头域的sbc-domain中正确添加区号和区域识别码。
测试结果|-
## 术语解释 
### vNF 
#### 全称 
Visited Network Function 
#### 解释 
表示位于VPLMN中的NF，例如：vAMF、vSMF、vUPF等。 
### hNF 
#### 全称 
Home Network Function 
#### 解释 
表示位于HPLMN中的NF，例如：hAMF、hSMF、hUPF等。 
### cNF 
#### 全称 
Network Function as Customer 
#### 解释 
表示异网漫游场景中，作为NF服务消费者的NF，例如：cNRF。 
### pNF 
#### 全称 
Network Function as Producer 
#### 解释 
表示异网漫游场景中，作为NF服务生产者的NF，例如：pNRF。 
### L-NRF 
#### 全称 
Local Network Repository Function 
#### 解释 
表示本地NRF，直接与NF交互。 
### I-NRF 
#### 全称 
Intermediate Network Repository Function 
#### 解释 
表示中间NRF，作为关口局NRF，用于和其他PLMN的NRF/NF进行通信，负责异网漫游互通，隐藏网内拓扑，简化组网对接。 
### vL-NRF 
#### 全称 
Visited Local Network Repository Function 
#### 解释 
表示位于VPLMN中的本地NRF，与VPLMN中的NF直接交互。 
### vI-NRF 
#### 全称 
Visited Intermediate Network Repository Function 
#### 解释 
表示位于VPLMN中的中间NRF，作为关口局NRF，用于和其他PLMN的NRF/NF进行通信。 
### hL-NRF 
#### 全称 
Home Local Network Repository Function 
#### 解释 
表示位于HPLMN中的本地NRF，与HPLMN中的NF直接交互。 
### hI-NRF 
#### 全称 
Home Intermediate Network Repository Function 
#### 解释 
表示位于HPLMN中的中间NRF，作为关口局NRF，用于和其他PLMN的NRF/NF进行通信。 
### pSEPP 
#### 全称 
Security Edge Protection Proxy as Producer 
#### 解释 
NF服务生产者（请求接收方）一侧的SEPP称为pSEPP。 
### cSEPP 
#### 全称 
Security Edge Protection Proxy as Customer 
#### 解释 
NF服务消费者（请求发起方）一侧的SEPP称为cSEPP。 
# 缩略语 
# 缩略语 
## BG 
Border Gateways边界网关
## IPX 
Internetwork Packet Exchange protocolInternet网络分组交换协议
## SEPP 
Security Edge Protection Proxy安全边缘保护代理
## SUPI 
Subscriber Permanent Identifier用户永久标识
# 5GC容灾语音快速恢复综合解决方案 
## 术语约定 
### 适用NF 
AMF、SMF、UDM、P-CSCF、S-CSCF、BSF、DRA、IWF、PCF 
### 术语 
本文所涉及的相关术语参见下表。 
术语|说明
---|---
BSF|BSF功能是3GPP定义的标准功能，用于存储用户信息和为PDU会话选择PCF地址。当其他网元，如NEF或者AF需要选择PCF时，通过BSF提供的服务化接口获取对应的PCF信息。当4G和5G进行互操作时，BSF实现对同一个会话选择一个合一的PCRF和PCF节点，使用户在4G和5G之间移动时，绑定的PCF和PCRF地址不变，保证会话不中断。BSF可以部署为以下两种模式：独立BSF。在SMF中内置BSF。
热备|NF Set组网方式下，主用NF将用户的全部数据同步到备用NF；当NF Set下某个或部分NF发生故障，NF Set下其他正常NF根据备用NF中保存的用户全部数据，能无损接管当前用户的业务。
冷备|NF Set组网方式下，NF Set下的NF间不同步用户动态信息；当NF Set下某个或部分NF发生故障，对端NF可以选择NF Set下其他正常NF处理用户业务。
AMF部分备份|AMF Set组网方式下，主用AMF将全部用户的部分数据（TA list、SUPI、GUTI）备份到备用AMF；当主用AMF发生故障，备用AMF收到被叫业务（下行业务）时，根据用户部分上下文信息（TA list、SUPI、GUTI）寻呼用户，触发用户重新初始注册，快速恢复用户语音和数据业务。
## 定义 
### 定义 
5GC容灾语音快速恢复是指：在5GC网元级容灾或DC级容灾等容灾场景下，由于单个/多个NF不可用，或IMS PDU Session在5GC的各个NF上状态不一致，导致出现用户语音业务受阻且短时间内无法恢复时，通过采用增强P-CSCF Restore方式，快速恢复用户语音业务（恢复时间能够达到秒级），提升用户业务体验。 
本方案主要针对基于增强P-CSCF Restore的语音快速恢复机制展开说明。 
 说明： 
本文中的故障NF均指5GC中的NF。 
当语音业务全阻（所用用户的所有语音业务均不可用）时，请参考5GC逃生解决方案。 
增强P-CSCF Restore流程是运营商通过对标准P-CSCF Restore流程进行增强，使5GC中的NF故障时可以快速恢复用户语音业务的方式。 
### 背景知识 
5G语音的挑战
在5GS中，UE仅在PS域下注册，不在CS域下注册。如果UE在5GS中进行语音业务，但业务受阻，则无法通过CS域继续进行语音业务，语音业务失败，如[图1](1685966470322.html#z4619068e34d5497494804a630d86c246__dca45389-d40f-44f0-b4c6-3a5dd2a24d5f)所示。
图1  5G语音业务失败场景
[]images/5fd77112d5d74e3a8ede012488d76d4a.png)
在语音业务失败后，需要尽快恢复用户语音业务，除了使用备用NF继续进行语音业务外，在P-CSCF故障场景下，还可以使用P-CSCF Restore机制快速恢复语音业务。 
标准P-CSCF Restore流程
3GPP TS23.380协议定义了标准的P-CSCF Restore流程，用于解决P-CSCF故障时如何快速恢复用户语音业务。标准的P-CSCF Restore流程，主要有如下两种方式。 
P-CSCF Restore方式|流程说明
---|---
基于PCF的P-CSCF Restore|P-CSCF故障后，S-CSCF通知其他可用的P-CSCF继续接管业务。新P-CSCF接管业务后，通知PCF。PCF通知SMF进行P-CSCF恢复处理。SMF发起重建IMS PDU Session或通知UE更新P-CSCF列表。重建IMS PDU Session方式对UE无依赖，适用的场景更多，以下描述仅考虑IMSI PDU Session重建方式。
基于UDM的P-CSCF Restore|P-CSCF故障后，S-CSCF通知UDM。UDM通知AMF或SMF处理P-CSCF恢复。AMF或SMF发起重建IMS PDU Session或通知UE更新P-CSCF列表。重建IMS PDU Session方式对UE无依赖，适用的场景更多，以下描述仅考虑IMSI PDU Session重建方式。
基于PCF的P-CSCF Restore方式需要协同的网元更多，实现过程更容易受到协同网元故障的影响，因此业界普遍采用基于UDM的P-CSCF Restore。基于UDM的P-CSCF Resore处理流程如[图2](1685966470322.html#z4619068e34d5497494804a630d86c246__c4452e42-8bf8-421f-abda-aad37216a639)所示。
图2  基于UDM的标准P-CSCF Restore流程
[]images/465fad9f036348a7b082a1bb0f7f94ec.png)
主要流程说明如下： 
S-CSCF检测到P-CSCF故障（如没有收到P-CSCF的响应消息，或收到了P-CSCF的没有用户注册信息的失败响应消息）。 
通知UDM进行P-CSCF Restore。 
UDM通知AMF或SMF处理P-CSCF Restore流程，触发IMS PDU Session重建。 
 说明： 
建议优先使用UDM通知AMF的P-CSCF Restore方式。 
基于UDM的P-CSCF Restore流程中，UDM会通知AMF或SMF处理P-CSCF Restore流程，由于UDM通知SMF的方式需要协同的网元比UDM通知AMF的方式更多，实现过程更容易受到协同网元故障的影响，基于最小依赖原则，建议使用UDM通知AMF的方式。 
语音呼叫流程
下面介绍语音呼叫流程的简要过程，了解基本呼叫流程及流程中涉及的5GC NF。 
VoNR的语音呼叫流程示意图如[图3](1685966470322.html#z4619068e34d5497494804a630d86c246__a7c9a814-5164-4354-a1f7-dc408248feaf)所示。
图3  VoNR语音呼叫流程
[]images/25938eb190f5494c92be82b3b9ad8bfb.png)
以UE1为例的基本呼叫流程如下： 
当UE1为主叫时，P-CSCF收到主叫UE的INVITE消息；当UE1为被叫时，P-CSCF收到被叫UE返回的183消息。 
P-CSCF触发语音业务资源预留流程，即语音专有QoS Flow建立流程。 
主叫UE和被叫UE完成振铃以及摘机等交互。 
## 组网架构 
### 概述 
5GC容灾语音快速恢复解决方案基于BSF的部署方式的不同有如下两种组网方式。 
内置BSF组网方式：BSF内置在SMF。 
外置BSF组网方式：BSF独立部署。 
### 内置BSF组网方式 
SMF内置BSF后，可实现如下功能： 
SMF向NRF注册该SMF的IP号段信息。 
SMF对外提供Nbsf_Management_Discovery服务操作。 
SMF内置BSF的组网架构如[图1](1685967770062.html#z8af1e54b30f6492b87cac7d711dd839d__c85debfa-b0aa-4eef-8867-f4ab7753859b)所示。
图1  内置BSF组网方式
[]images/%E5%86%85%E7%BD%AEbsf%E7%BB%84%E7%BD%91%E6%96%B9%E5%BC%8F.png)
语音呼叫过程中，涉及BSF的主要流程说明如下： 
当UE发起VoNR呼叫时，P-CSCF发送AAR消息给DRA，DRA根据用户UE IP地址发现归属的SMF。 
DRA使用Nbsf_Management_Discovery服务操作，基于UE地址向SMF查询PCF会话绑定信息。 
SMF查询成功，向DRA返回UE该PDU会话所选PCF ID或地址。 
DRA向PCF发送AAR消息。 
PCF触发专有QoS Flow建立。 
### 外置BSF组网方式 
外置BSF可实现如下功能： 
BSF向NRF注册该BSF的IP号段信息。 
BSF对外提供Nbsf_Management_Discovery服务操作。 
外置BSF组网架构如[图2](1685967770062.html#z8af1e54b30f6492b87cac7d711dd839d__3dee1b73-7c25-4344-a2d3-bdd2625ef226)所示。
图2  外置BSF组网方式
[]images/aad7357a52c7474f8f73070e98f0de40.png)
语音呼叫过程中，涉及BSF的主要流程说明如下： 
当UE发起VoNR呼叫时，P-CSCF发送AAR消息给DRA。 
DRA根据用户UE IP地址发现BSF，把AAR消息转发给BSF。 
BSF基于UE地址本地查询PCF会话绑定信息，BSF向PCF转发AAR消息。 
PCF触发专有QoS Flow建立。 
## 方案概述 
### 总体解决思路 
5GC中部分NF故障，或部分NF丢失了IMS PDU Session信息，可能导致用户语音业务在PS域下受阻且短时间内无法恢复。 
快速恢复用户在PS域下语音业务，主要有如下两种手段。 
热备NF热备后，若某个NF故障，周边网元会把语音呼叫发送给备用NF，不影响用户语音业务。使用热备策略的NF有AMF、PCF、BSF等。 
增强P-CSCF Restore标准P-CSCF Restore流程用于UE接入的P-CSCF故障后，快速恢复用户语音业务。增强P-CSCF Restore是运营商对标准P-CSCF Restore流程进行的增强功能，当5GC中的NF故障，导致用户语音业务受阻且短时间内无法恢复时，使5GC中的NF故障时可以使用增强P-CSCF Restore机制进行恢复。BSF或PCF发现业务异常后，触发增强P-CSCF Restore流程，使用户重建IMS PDU Session，从而快速恢复用户语音业务。 
本方案主要针对基于增强P-CSCF Restore的语音快速恢复机制展开说明。 
### 语音快速恢复场景分析 
根据NF故障、IMS会话在NF内丢失两种异常场景，分析每种容灾场景中的语音快速恢复解决方案。 
NF故障时的容灾场景下，语音快速恢复方案参见下表。 
容灾网元|解决方案|详细描述|语音业务恢复时长
---|---|---|---
AMF|AMF热备或部分备份|AMF|AMF故障时，周边NF选择备用AMF进行业务，语音业务可立即恢复。|立即恢复（秒级）
外置BSF|SMF|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无语音快速恢复方案。|主叫UE触发业务请求失败，AMF携带会话未激活指示给UE，UE重激活会话，语音业务可立即恢复。UE被叫时，下行SIP报文在UPF侧被丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
BSF|外置BSF|BSF热备|DRA重路由到备用BSF（BSF热备）进行语音业务的恢复。|立即恢复（秒级）
内置BSF|SMF+内置BSF|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无语音快速恢复方案。|主叫UE触发业务请求失败，AMF携带会话未激活指示给UE，UE重激活会话，语音业务可立即恢复。UE被叫时，下行SIP报文在UPF侧被丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
UPF|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无语音快速恢复方案。|UPF|主叫UE触发业务请求失败，AMF携带会话未激活指示给UE，UE重激活会话，语音业务可立即恢复。UE被叫时，下行SIP报文在UPF侧被丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
PCF|PCF热备PCF冷备：PCF触发P-CSCF Restore|PCF|PCF热备：BSF重路由到备用PCF进行语音业务的恢复。PCF冷备：DRA重路由到备用PCF，PCF返回失败原因码5065给DRA，触发P-CSCF Restore流程。|立即恢复（秒级）
DRA|DRA负荷分担（DRA无状态）|DRA|对端重路由到备用DRA进行业务，语音业务可立即恢复。|立即恢复（秒级）
5GC全DC|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无语音快速恢复方案。|5GC全DC|主叫UE触发业务请求失败，AMF携带会话未激活指示给UE，UE重激活会话，语音业务可立即恢复。UE被叫时，下行SIP报文在UPF侧被丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
单个会话在某个NF内丢失时的容灾场景下，语音快速恢复方案参见下表。 
会话丢失网元|解决方案|详细描述|语音业务恢复时长
---|---|---|---
UPF|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无快速恢复方案。|UPF|主叫UE触发业务请求失败，AMF携带会话未激活指示给UE，UE重激活会话，语音业务可立即恢复。UE被叫时，下行SIP报文在UPF侧被丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
AMF|UE主叫时，周边NF使用备用AMF。UE被叫时暂无快速恢复方案。|AMF|UE作为主叫时，周边NF选择备用AMF进行业务，语音业务可立即恢复。UE作为被叫时，下行SIP报文触发SMF向AMF发送下行数据通知，AMF返回的上下文不存在响应会触发SMF和UPF删除IMS PDU Session。下一次被叫时下行SIP报文在UPF侧丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
外置BSF|SMF|主叫UE触发业务请求失败，后续UE重新激活会话。UE被叫时暂无快速恢复方案。|主叫触发业务请求失败携带会话未激活指示给UE，重激活会话，可立即恢复。UE被叫时，下行SIP报文触发UPF向SMF发送下行数据通知，SMF返回的上下文不存在响应回触发UPF删除IMS PDU Session。下一次被叫时下行SIP报文在UPF侧丢弃，IMS响应超时且CS retry失败，通过IMS周期性注册更新流程（最长50分钟）恢复。|最长50分钟
BSF|外置BSF|外置BSF触发P-CSCF Restore|当BSF返回失败原因码5002给DRA时，触发P-CSCF Restore流程。|立即恢复（秒级）
内置BSF|内置BSF触发P-CSCF Restore|内置BSF|当BSF返回404(not found)给DRA时，DRA模拟PCF返回失败原因码5002给P-CSCF，触发P-CSCF Restore流程。|立即恢复（秒级）
PCF|PCF触发P-CSCF Restore|PCF|当PCF（不区分冷备和热备 ）返回失败原因码5065给P-CSCF时，触发P-CSCF Restore流程。|立即恢复（秒级）
根据上述结果，本解决方案以不同网元触发的P-CSCF Restore方式分析特定场景的语音快速恢复方案。 
### 客户收益 
受益方|受益描述
---|---
运营商|用户语音业务受阻后能够快速恢复，增强语音可靠性，提升运营商的服务质量。
用户|语音业务受阻后能够快速恢复，提升用户体验。
### 遵循标准 
标准类别|标准编号|标准名称
---|---|---
3GPP|23.501|system architecture for the 5g system
23.502|3GPP|procedures for the 5g system
23.380|3GPP|IMS Restoration Procedures
29.502|3GPP|session management services
29.503|3GPP|unified data management services
## 实现原理 
### 增强P-CSCF Restore 
#### 组网架构 
3GPP 23.380协议定义的标准P-CSCF Restore流程用于UE接入的P-CSCF发生故障时，快速恢复用户语音业务。 
当5GC中的NF故障，导致用户语音业务受阻且短时间内无法恢复时，运营商对标准P-CSCF Restore流程进行了增强，使5GC中的NF时故障可以使用增强P-CSCF Restore机制，快速恢复用户语音业务。 
注册或PDU Session建立过程中，AMF或SMF把pcscfRestorationCallbackUri发送给UDM。用户呼叫过程中，P-CSCF收到特定失败原因码的AAA消息，比如AAA-5065（IP-CAN Session Unavailable）或AAA-5002（Unknown Session ID）后，P-CSCF通过定制消息通知S-CSCF，触发S-CSCF发起标准的P-CSCF Restore。 
增强P-CSCF Resotre功能的组网图如[图1](1686100896196.html#z675645dc3a61428997604d2b215aac4f__ecf12357-6ec4-4554-bd8b-c742a22d7e94)所示。
图1  增强P-CSCF Restore组网架构
[]images/4e0b14f7bd2240e7b67da4524a1ebff8.png)
增强P-CSCF Restore机制的主要处理流程如下： 
P-CSCF收到PCF返回的错误原因码AAA-5065（IP-CAN Session Unavailable）或BSF返回的错误原因码AAA-5002（Unknown Session ID）。 
P-CSCF通过定制消息通知S-CSCF进行P-CSCF Restore流程。 
S-CSCF发起标准的基于UDM的P-CSCF Restore流程，UDM通知AMF处理P-CSCF Restore流程，触发IMS PDU Session重建。 
增强P-CSCF Restore根据触发机制的不同，可分为以下三类： 
内置BSF触发的增强P-CSCF Restore 
外置BSF触发的增强P-CSCF Restore 
PCF触发的增强P-CSCF Restore 
#### 业务流程 
增强P-CSCF Restore功能主要涉及如下流程： 
注册流程 
PDU Session建立流程 
UDM通知AMF触发P-CSCF Restore流程 
UDM通知SMF触发P-CSCF Restore流程 
注册流程
用户注册时，AMF向UDM发起注册，携带触发P-CSCF Restore所需信息（pcscfRestorationCallbackUri）。注册流程图如[图2](1686100896196.html#z675645dc3a61428997604d2b215aac4f__d7101f0e-bf40-498a-a76e-ce2b79d104c7)所示。
图2  注册流程
[]images/image.png)
流程简要说明如下： 
AMF向UDM发送Nudm_UECM_Registration Request消息，携带pcscfRestorationCallbackUri。 
UDM更新用户AMF动态信息表，保存pcscfRestorationCallbackUri。 
UDM向AMF返回Nudm_UECM_Registration Response消息。 
PDU Session建立流程
PDU Session建立时，SMF向UDM发起注册，携带pcscfRestorationCallbackUri（触发P-CSCF Restore所需信息）。 PDU Session建立流程图如[图3](1686100896196.html#z675645dc3a61428997604d2b215aac4f__20dc13a5-925a-4d10-bed6-101e39568660)所示。
图3  PDU Session建立流程
[]images/7f0c3b0ffdb24987b0977f70d144d486.png)
流程简要说明如下： 
SMF向UDM发送Nudm_UECM_Registration Request消息，携带pcscfRestorationCallbackUri。 
UDM更新用户SMF动态信息表（保存pcscfRestorationCallbackUri）。 
UDM向SMF返回Nudm_UECM_Registration Response消息。 
UDM通知AMF触发P-CSCF Restore流程
语音呼叫过程中，P-CSCF收到AAA-5065或AAA-5002，UDM确定需要通知AMF触发P-CSCF Restore，其流程图如[图4](1686100896196.html#z675645dc3a61428997604d2b215aac4f__1e698794-0dee-4f51-b91e-e5ad79716f37)所示。
图4  UDM通知AMF触发P-CSCF Restore流程
[]images/e915120d44bf4732ae0da349501be7e0.png)
流程简要描述如下： 
语音呼叫过程中，P-CSCF收到DRA发送的AAA-5065（IP-CAN Session Unavailable）或AAA-5002（Unknown Session ID）消息。 
当P-CSCF本地配置的“PCRF容灾通知S-CSCF开关”配置为“开启”，则P-CSCF向S-CSCF发送SIP MESSAGE消息，包含如下XML消息体，指示S-CSCF发起P-CSCF Restore。 
`<ims-3gpp version="1">
    <alternative-service>
        <type>restoration</type>
        <reason>pcrf-failure</reason>
    </alternative-service >
</ims-3gpp>` 
S-CSCF向P-CSCF返回响应消息。 
S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。 
HSS+UDM向S-CSCF返回Cx SAA消息。 
HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。 
AMF向HSS+UDM返回Nudm_UECM_PCscfRestoration notification Response消息。 
AMF通知SMF发起IMS PDU Session释放，UE重新激活IMS PDU Session。如果SMF故障，AMF直接通知UE重建IMS PDU Session。 
UDM通知SMF P-CSCF Restore流程
语音呼叫过程中，P-CSCF收到AAA-5065或AAA-5002，UDM确定需要通知SMF触发P-CSCF Restore，其流程图如[图5](1686100896196.html#z675645dc3a61428997604d2b215aac4f__6d2f02f9-3ee6-47af-8959-6ac8ad549427)所示。
图5  UDM通知SMF P-CSCF Restore流程
[]images/a92c05e21b404d73a4a02abb3230f7ce.png)
流程简要描述： 
语音呼叫过程中，P-CSCF收到5GC的AAA-5065（IP-CAN Session Unavailable）或AAA-5002（Unknown Session ID）消息。 
当P-CSCF本地配置的“PCRF容灾通知S-CSCF开关”配置为“开启”，则P-CSCF向S-CSCF发送SIP MESSAGE消息，包含如下XML消息体，指示S-CSCF发起P-CSCF Restore。 
`<ims-3gpp version="1">
    <alternative-service>
        <type>restoration</type>
        <reason>pcrf-failure</reason>
    </alternative-service >
</ims-3gpp>` 
S-CSCF向P-CSCF返回响应消息。 
S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。 
HSS+UDM向S-CSCF返回Cx SAA消息。 
HSS+UDM向为用户提供服务的SMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，SMF的地址为SMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。 
SMF向HSS+UDM返回Nudm_UECM_PCscfRestoration notification Response消息。 
SMF触发IMS PDU Session释放，UE重新激活IMS PDU会话。 
### 内置BSF触发的增强P-CSCF Restore 
#### 组网架构 
内置BSF功能，是指由SMF提供3GPP标准定义的BSF查询功能，包括如下功能： 
SMF向NRF注册该SMF的IP号段信息。 
SMF对外提供Nbsf_Management_Discovery服务操作。 
SMF基于UE IP地址等信息查询对应的PCF信息。 
DRA向内置BSF请求查询PCF信息，由于以下三种原因，DRA向内置BSF获取PCF信息失败，DRA会模拟PCF向P-CSCF返回5065（IP-CAN Session Unavailable），触发P-CSCF Restore机制： 
DRA发现BSF失败。 
DRA没有收到BSF回复的响应消息。 
DRA收到BSF回复的失败响应（404 Not Found）。 
内置BSF触发的增强P-CSCF Restore组网图如[图1](1686101333513.html#z68a598750a3e47a3be0d70a726a7531e__e190b657-71f4-4f63-9bac-4bfda77038d6)所示。
图1  内置BSF触发的增强P-CSCF Restore组网
[]images/adbf3e99831e4bb381fe642c84436d60.png)
#### 实现原理 
内置BSF触发的增强P-CSCF Restore流程示意图如[图2](1686101333513.html#z68a598750a3e47a3be0d70a726a7531e__149bf4ae-ffa0-4919-a84f-08ce1a9f14e9)所示。
图2  内置BSF触发的增强P-CSCF Restore流程示意
[]images/0a600b62b03e421b89a17737a901bc30.png)
主要处理流程如下： 
当UE发起VoNR呼叫，UE作为主叫时P-CSCF收到主叫UE的SIP INVITE消息，或UE作为被叫时P-CSCF收到UE的SIP 183消息。P-CSCF给DRA发送AAR消息，通知PCF建立语音专有QoS Flow等。 
DRA通过NRF发现BSF失败，或发现BSF成功，但给SMF内置BSF发送Nbsf_Management_Discovery Req(UE IP)消息后，没有收到响应或收到失败响应（404 Not Found）。 
DRA给P-CSCF返回AAA。 
如果没有收到BSF响应，则DRA根据本地配置，携带错误码5065（IP-CAN Session Unavailable）或5002（Unknown Session ID）。 
如果收到失败响应（404 Not Found），则DRA根据本地配置，把失败响应转成携带错误码5065（IP-CAN Session Unavailable）或5002（Unknown Session ID）。 
P-CSCF通过扩展SIP消息，通知S-CSCF发起标准的基于UDM的P-CSCF Restore流程。 
S-CSCF发起标准的基于UDM的P-CSCF Restore流程。 
#### 业务流程 
相关业务流程参见[增强P-CSCF Restore](1686100896196.html)中的业务流程。
### 外置BSF触发的增强P-CSCF Restore 
#### 组网说明 
BSF提供会话绑定管理功能，可以基于UE IP地址等信息查询对应的PCF信息。BSF向NRF注册该BSF的IP号段信息，DRA可以通过NRF获取BSF信息。 
当外置BSF丢失了部分用户的IMS PDU Session信息时，如果收到DRA的AAR消息，外置BSF向DRA返回AAA-5002（Unknown Session ID），DRA向P-CSCF返回AAA-5002，触发P-CSCF Restore流程。 
外置BSF触发的增强P-CSCF Restore组网图如[图1](1686101336810.html#z82e247c76d924821a06f9c6a5200f2cb__adf9a081-e5cf-4093-a03a-2afc42c9dddf)所示。
图1  外置BSF触发的增强P-CSCF Restore组网图
[]images/5c827d31e29a4c6fb710850b29020312.png)
#### 实现原理 
外置BSF异常触发的P-CSCF Restore流程示意图如[图2](1686101336810.html#z82e247c76d924821a06f9c6a5200f2cb__441998b7-fc0f-471c-b0e8-1346422ef3cb)所示。
图2  外置BSF异常触发的P-CSCF Restore流程示意
[]images/40d9e4c1d44847bca8aa591eb136a6ed.png)
主要处理流程如下： 
当UE发起VoNR呼叫，UE作为主叫时，P-CSCF收到主叫UE的SIP INVITE消息，或UE作为被叫时，P-CSCF收到UE的SIP 183消息。 
P-CSCF给DRA发送AAR消息，通知PCF建立语音专有QoS Flow等。 
DRA通过NRF发现BSF成功，向BSF发送Nbsf_Management_Discovery Req(UE IP)消息，但BSF本地查询PCF绑定信息失败，向DRA返回AAA-5002（Unknown Session ID）。 
DRA向P-CSCF返回AAA-5002。 
P-CSCF通过扩展SIP消息，通知S-CSCF发起标准的P-CSCF Restore流程。 
S-CSCF发起标准的基于UDM的P-CSCF Restore流程。 
#### 业务流程 
相关业务流程参见[增强P-CSCF Restore](1686100896196.html)中的业务流程。
### PCF触发的增强P-CSCF Restore 
#### 组网架构 
当PCF故障或PCF丢失了部分用户的IMS PDU Session信息时，如果PCF收到AAR消息请求建立专载，由于PCF找不到会话，会向P-CSCF返回AAA-5065（IP-CAN Session Unavailable），触发P-CSCF发起P-CSCF Restore流程。 
BSF内置或外置不影响PCF容灾场景下的语音快速恢复功能，下面以BSF外置为例，说明PCF触发的增强P-CSCF Restore组网图，如[图1](1686101393489.html#zc78d7f2161c542cc8921da8c5030a968__7cd36e19-1cdd-4da6-a528-c8b5bcab12a1)所示。
 说明： 
BSF外置时，需要BSF支持重路由功能。 
BSF内置时，需要DRA支持重路由功能。 
图1  PCF触发的增强P-CSCF Restore
[]images/2361ae70d94e4c0086df0dd54a10837e.png)
#### 实现原理 
基于PCF的增强P-CSCF Restore流程示意图如[图2](1686101393489.html#zc78d7f2161c542cc8921da8c5030a968__8c602d63-fc2b-4665-ad03-b98dbac2c78f)所示。
图2  PCF触发的增强P-CSCF Restore流程示意
[]images/c81e9d115421494da0267043c256e682.png)
主要处理流程如下： 
当UE发起VoLTE或者VoNR呼叫，UE作为主叫时，P-CSCF收到主叫UE的SIP INVITE消息，或UE作为被叫时，P-CSCF收到UE的SIP 183消息。 
P-CSCF经过DRA和BSF向PCF发送AAR消息，通知PCF建立语音专有QoS Flow。 
PCF本地找不到对应会话上下文。 
PCF经过DRA和BSF向P-CSCF返回AAA-5065（IP-CAN Session Unavailable）。 
P-CSCF通过扩展SIP消息，通知S-CSCF触发S-CSCF的P-CSCF Restore流程。 
S-CSCF发起标准的基于UDM的P-CSCF Restore流程。 
#### 业务流程 
相关业务流程参见[增强P-CSCF Restore](1686100896196.html)中的业务流程。
## 可获得性 
### 版本说明 
网元|产品版本
---|---
AMF|ZXUN uMAC V7.20.24及以上版本
SMF|ZXUN xGW V7.20.24及以上版本
UDM|ZXUN USPP V7.20.14及以上版本
IWF|ZXUN USPP V7.20.14及以上版本
P-CSCF|ZXUN CSCF V5.17.10及以上版本
S-CSCF|ZXUN CSCF V5.17.10及以上版本
BSF|ZXUN DSC V5.20.10及以上版本
DRA|ZXUN DSC V5.20.10及以上版本
PCF|ZXUN RCP V7.20.20及以上版本
### 工程规划要求 
P-CSCF收到AAA-5065（IP-CAN Session Unavailable）或AAA-5002（Unknown Session ID）后，需要通过扩展SIP消息（定制消息），通知S-CSCF触发P-CSCF Restore流程。 
## 指标监控 
### 概述 
本解决方案需要监控的性能统计数据涉及AMF、SMF、PCF和SBC网元。 
### AMF网元关键指标 
AMF网元需要监控的性能统计数据参见下表。 
关键指标|计算公式|指标描述
---|---|---
AMF接收UDM发送的P-CSCF Restore次数|C510520103|在采集周期内，统计AMF接收Nudm_UECM_pcscfRestorationNotification请求次数。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C510520103 接收Nudm_UECM_pcscfRestorationNotification请求次数
### SMF网元关键指标 
SMF网元需要监控的性能统计数据参见下表。 
关键指标|计算公式|指标描述
---|---|---
PDU会话数（5G）(个)|C515070002|统计PDU会话数（5G）。
SMF中UE请求的PDU会话建立成功率（去除用户原因）(%)|100×C515010002/(C515010002+C515010003+C515010006+C515010019+C515010021)|统计SMF中UE请求的PDU会话建立成功率（去除用户原因）。
N7 PolicyControl创建策略成功率(%)|100 × C515110011 / C515110001|在采集周期内，统计N7接口PolicyControl创建策略成功率(%)。
N7 PolicyControl更新策略成功率(%)|100 × C515110012 / C515110003|在采集周期内，统计N7接口PolicyControl更新策略成功率。
N7 PolicyControl PCF发起更新策略成功率(%)|100 × C515110016 / C515110007|在采集周期内，统计N7接口PolicyControl PCF发起更新策略成功率。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C515070002 平均会话数
2|C515010002 UE发起的PDU会话建立成功次数
3|C515010003 由于系统内部错导致的UE发起的PDU会话建立失败次数
4|C515010006 由于资源不足导致会话创建失败的次数
5|C515010019 由于特定切片和DNN的资源不足导致会话创建失败的次数
6|C515010021 由于特定切片的资源不足导致会话创建失败的次数
7|C515110011 创建SM策略成功次数
8|C515110001 发送Npcf_SMPolicyControl_Create Request次数
9|C515110012 更新SM策略成功次数
10|C515110003 发送Npcf_SMPolicyControl_Update Request次数
11|C515110016 发送Npcf_SMPolicyControl_UpdateNotify Response成功次数
12|C515110007 收到Npcf_SMPolicyControl_UpdateNotify Request次数
### PCF网元关键指标 
PCF网元需要监控的性能统计数据参见下表。 
关键指标|计算公式|指标描述
---|---|---
Rx发送失败AAA的总数（5065 IP-CAN会话不存在）|C000180181|在测量周期内，统计RCP向AF发送的返回码为5065的AAA消息的次数。消息中的Experimental_Result_Code为IP-CAN_SESSION_NOT_AVAILABLE (5065)。
在线N7会话数|C000200097|在测量周期内，统计RCP在线N7会话数的实际值。
在线Rx会话数|C000200007|在测量周期内，统计RCP在线Rx会话数的实际值。
License在线IMS会话容量占用率峰值（%）|（C000200074 + C000200108）/ C000200094 × 100|该指标用于统计RCP系统在线IMS会话的比例峰值。
SM策略关联建立成功率（%）|C520010006 / C520010004 × 100|在测量周期内，RCP与对端SMF设备之间通过N7接口交互时，N7接口建立SM策略关联的成功率。
Rx发起成功率（%）|C000190186 / C000190004 × 100|在测量周期内，RCP与对端AF设备之间通过Rx接口创建Rx会话的成功率。
重点计数器参见下表。 
序号|性能计数器
---|---
1|C000180181 Rx发送失败AAA的总数（5065 IP-CAN会话不存在）
2|C000200097 在线N7会话数
3|C000200007 在线Rx会话数
4|C000200074 在线IMS APN的Gx会话数峰值
5|C000200108 在线IMS APN的N7会话数峰值
6|C000200094 License在线IMS会话容量
7|C520010006 发送SM策略关联建立成功应答次数
8|C520010004 收到SM策略关联建立请求次数
9|C000190186 Rx发送成功AAA的总数
10|C000190004 Rx发送AAA的总数
### SBC网元关键指标 
SBC网元需要监控的性能统计数据参见下表。 
关键指标|计算公式|
---|---|---
主叫接通率(%)|C000110029 / C000200006 × 100|该测量指标主要介绍主叫接通率的相关信息。
被叫接通率(%)|C000110031 / C000110009 × 100|该测量指标主要介绍被叫接通率的相关信息。
主叫会话平均建立时长(ms)|C000110041 / C000110029|该测量指标用于反映ZXUN B200当前测量周期内各主叫侧的平均呼叫建立时长。通过所有主叫侧呼叫的总建立时长和总的主叫侧呼叫建立次数的比值获得。主叫侧呼叫，从ZXUN B200收到INVITE到ZXUN B200转发180响应，或没有收到180而直接转发200 OK之间的时间称为一个主叫侧呼叫的建立时长。
被叫会话平均建立时长(ms)|C000110043 / C000110031|该测量指标用于反映ZXUN B200当前测量周期内被叫会话平均建立的快慢程度，通过呼叫业务中ZXUN B200被叫会话建立时长与被叫接通次数的比值获得。被叫会话建立时长是指ZXUN B200收到被叫INVITE请求后，到发送180 Ring消息之间的时间间隔。被叫接通次数是指ZXUN B200收到被叫INVITE请求后，回180 Ringing的次数、以及没有回复180 Ringing只回复200OK的次数。
Rx接口接收AAA响应率(%)|C000380005 / C000380004 × 100|该测量指标主要介绍Rx接口接收AAA响应率的相关信息。
中断率(%)|C000110063 / C000110012 × 100|该指标用于统计呼叫业务中ZXUN B200的呼叫中断次数占试呼次数的比率。呼叫中断次数为ZXUN B200内部异常释放的呼叫次数，通常为超时释放。
重点计数器参见下表。 
序号|性能计数器
---|---
1|（C000110029）主叫接通次数
2|（C000110006）主叫试呼次数
3|（C000110031）被叫接通次数
4|（C000110009）被叫试呼次数
5|（C000110041）主叫会话建立时长(ms)
6|（C000110029）主叫接通次数
7|（C000110043）被叫会话建立时长(ms)
8|（C000110031）被叫接通次数
9|（C000110063）呼叫中断次数
10|（C000110012）试呼次数
## 配置过程 
### 预配置（增强P-CSCF Restore） 
#### 场景说明 
5GC容灾语音快速恢复解决方案涉及如下三个配置场景： 
内置BSF触发的增强P-CSCF Restore场景配置 
外置BSF触发的增强P-CSCF Restroe场景配置 
PCF触发的增强P-CSCF Restore场景配置 
以上三个场景的配置均有相同的前置配置步骤，即在进行以上三个场景的配置前，均需先执行本节的预配置过程。 
#### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行。 
#### 数据规划 
网元|命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---|---
P-CSCF|SET VD|虚拟设备编号|1|已配置数据中获取|把每个VDID（虚拟设备编号）对应的PCRF重启恢复通知开关都配置为ENABLE。
PCRF重启恢复通知开关|P-CSCF|SET VD|ENABLE|本端规划|把每个VDID（虚拟设备编号）对应的PCRF重启恢复通知开关都配置为ENABLE。
S-CSCF|SET SYS GLOBPARA|参数编号|2519|本端规划|打开S-CSCF的P-CSCF容灾开关。
参数值|S-CSCF|SET SYS GLOBPARA|1|本端规划|打开S-CSCF的P-CSCF容灾开关。
UDM|SET GLBOPT|项目标识|17031|本端规划|设置UDM在supportedfeature中指示支持PSBC-Restoration-mechanism为开。
项目取值|UDM|SET GLBOPT|1|本端规划|设置UDM在supportedfeature中指示支持PSBC-Restoration-mechanism为开。
SET UDMUECMOPT|UDM|多NF同时支持P-CSCF容灾时通知NF类型|NOTIFYAMF|本端规划|设置PCSCFRESTNOTINFTYPE开关为通知AMF，即触发P-CSCF Restore时UDM通知AMF。
IWF|SET UDIWFOPT|启用UDIWF|1|本端规划|启用UDIWF功能。
ULR Feature-List-ID2|IWF|SET UDIWFOPT|BIT16|本端规划|设置IWF在ULR请求中的SUPPORT_FEATURE2支持PSBC容灾指示。
SET UDMUECMOPT|IWF|多NF同时支持P-CSCF容灾时通知NF类型|NOTIFYAMF|本端规划|设置PCSCFRESTNOTINFTYPE开关为通知AMF，即触发P-CSCF容灾时IWF给AMF发通知。
SMF|SET GLOBALIMS|P-CSCF恢复GnGp原因值|REACTIVATION_REQUESTED|本端规划|配置P-CSCF Restore场景时，SMF/PGW-C发起用户下线重连时，S5S8、S2b、GnGp、N1口的原因值均为“请求再次激活”。
P-CSCF恢复S5S8原因值|SMF|SET GLOBALIMS|REACTIVATION_REQUESTED|本端规划|配置P-CSCF Restore场景时，SMF/PGW-C发起用户下线重连时，S5S8、S2b、GnGp、N1口的原因值均为“请求再次激活”。
P-CSCF恢复S2b原因值|SMF|SET GLOBALIMS|REACTIVATION_REQUESTED|本端规划|配置P-CSCF Restore场景时，SMF/PGW-C发起用户下线重连时，S5S8、S2b、GnGp、N1口的原因值均为“请求再次激活”。
P-CSCF恢复N1原因值|SMF|SET GLOBALIMS|REACTIVATION_REQUESTED|本端规划|配置P-CSCF Restore场景时，SMF/PGW-C发起用户下线重连时，S5S8、S2b、GnGp、N1口的原因值均为“请求再次激活”。
ADD PCSCFREST|SMF|数据网络名称|ims|已配置数据中获取|指定与P-CSCF列表关联的APN/DNN。该参数引自ADD APNDNN命令中的REALAPNDNN参数，必须通过命令ADD APNDNN预先配置。
基于UDM/HSS的P-CSCF恢复|ADD PCSCFREST|SMF|ENABLE|本端规划|UDM/HSS发现P-CSCF服务器故障时，会发消息通知SMF/PGW-C。在SMF/PGW-C收到消息后，该APN/DNN下的用户需要下线重连。
基于PCF/PCRF的P-CSCF恢复|ADD PCSCFREST|SMF|DISABLE|本端规划|PCF/PCRF发现P-CSCF服务器故障时，会发消息通知SMF/PGW-C。在SMF/PGW-C收到消息后，该APN/DNN下的用户不需要下线重连。
AMF|SET UDMPCSCFRESTORCFG|AMF支持基于UDM的P-CSCF恢复功能|SUPTPCSCFRESTORE|本端规划|-
支持无IMS会话的P-CSCF恢复功能|AMF|SET UDMPCSCFRESTORCFG|SUPTPCSCFNOIMSPDU|本端规划|-
#### 配置过程 
P-CSCF网元
步骤|说明|操作|备注
---|---|---|---
1|把每个VDID对应的PCRF重启恢复通知开关配置为ENABLE。|SET VD:VDID=1,PCRFNOTIFY="ENABLE"|操作前使用SHOW VD命令查看当前配置中PCRFNOTIFY是否已经配置为ENABLE，若已经开启则无需再次执行本步骤命令。命令中的VDID的取值根据现场实际VDID进行填写，所有VDID都需要配置。
S-CSCF网元
步骤|说明|操作|备注
---|---|---|---
1|打开S-CSCF的P-CSCF容灾开关。|SET SYS GLOBPARA:IDX=2519,CURVAL="1"|操作前使用SHOW SYS GLOBPARA DETAIL:BEGIN=2519命令查询当前“参数值”是否为1，若结果为1表示S-CSCF的P-CSCF容灾开关已经开启，无需进行操作。
2|执行传表操作。|SYNA|将修改的数据传送到前台。
UDM网元
步骤|说明|操作|备注
---|---|---|---
1|在UMM节点下设置UDM在supportedfeature中指示“支持PSBC-Restoration-mechanism”。|SET GLBOPT:ID=17031,VALUE="1"|-
2|在UMM节点下设置PCSCFRESTNOTINFTYPE开关为通知AMF，即UDM触发P-CSCF Restore时给AMF发通知。|SET UDMUECMOPT:PCSCFRESTNOTINFTYPE="NOTIFYAMF"|-
3|在UMM节点下执行传表操作。|SYNC UMM|将UMM上的配置数据同步到下级NF中。
IWF网元
步骤|说明|操作|备注
---|---|---|---
1|设置IWF在ULR请求中的SUPPORT_FEATURE2支持PSBC容灾指示。|SET UDIWFOPT:UDIWF=1,ULRFEATURE2="BIT16"&"BIT27"|使用SHOW UDIWFOPT命令查看ULR Feature-List-ID2配置了哪些BIT，在原来的BIT设置基础上增加BIT16，例如：若之前设置了BIT27，则执行命令SET UDIWFOPT:UDIWF=1,ULRFEATURE2="BIT16"&"BIT27"若之前没有设置BIT27，则执行命令SET UDIWFOPT:UDIWF=1,ULRFEATURE2="BIT16"
2|设置PCSCFRESTNOTINFTYPE开关为通知AMF。|SET UDMUECMOPT:PCSCFRESTNOTINFTYPE="NOTIFYAMF"|-
3|在UMM节点下执行传表操作。|SYNC UMM:TYPE="CHG",SYMP="YES"|将UMM上的变化表立即同步到当前UMM下所管理的各NF。
SMF网元
步骤|说明|操作|备注
---|---|---|---
1|配置P-CSCF Restore场景时，SMF/PGW-C发起用户下线重连时，S5S8、S2b、GnGp、N1口的原因值均为“请求再次激活”。|SET GLOBALIMS:GNGPCAUSE="REACTIVATION_REQUESTED",S5S8CAUSE="REACTIVATION_REQUESTED",S2BCAUSE="REACTIVATION_REQUESTED",N1CAUSE="REACTIVATION_REQUESTED"|当P-CSCF服务器出现故障时，PCRF等外部网元可以识别此故障，通过CCR-T消息通知PGW-C，此时PGW-C可以根据通知判断用户是否需要下线重连，若下线重连，需要在Delete Bear Request消息里携带原因值。
2|配置在ims APN下，SMF/PGW-C收到UDM/HSS通知的P-CSCF服务器故障时，SMF/PGW-C通知该APN下的用户下线重连。|ADD PCSCFREST:APNDNN="ims",UDMHSSBASEREST="ENABLE",PCFPCRFBASEREST="DISABLE"|-
AMF网元
步骤|说明|操作|备注
---|---|---|---
1|配置AMF支持基于UDM的P-CSCF Restore功能，开关打开后，AMF向UDM注册时会携带pcscfRestorationCallbackUri。配置AMF在用户未创建IMS会话时的P-CSCF Restore功能。|SET UDMPCSCFRESTORCFG:SUPPCSCFRESTORE="SUPTPCSCFRESTORE",SUPPCSCFNOIMSPDU="SUPTPCSCFNOIMSPDU"|-
### 内置BSF触发的增强P-CSCF Restore场景配置 
#### 场景说明 
内置BSF触发的P-CSCF Restore场景涉及两种组网架构，分别是有UDM无IWF组网和有IWF无UDM组网。 
有UDM无IWF组网如[图1](1686102198309.html#zdd3cd1a97c324f198ad1fdc10ea416ca__6deceb9b-f46c-4690-b93b-400eabbee4b4)所示。
图1  内置BSF组网，有UDM无IWF
[]images/14c5f04323ed46acaa71322fd767286d.png)
该组网架构的特点如下： 
BSF内置部署在SMF中。 
A省PCF1与A省PCF2冷备组网；B省PCF3与B省PCF4冷备组网。 
UDM与HSS融合部署。 
有IWF无UDM组网如[图2](1686102198309.html#zdd3cd1a97c324f198ad1fdc10ea416ca__e95d12e8-3879-4c03-bddf-c2d89f3cc541)所示。
图2  内置BSF组网，有IWF无UDM
[]images/ac638457161d4ab088c354769e7d81dc.png)
该组网架构的特点如下： 
BSF内置部署在SMF中。 
A省PCF1与A省PCF2冷备组网；B省PCF3与B省PCF4冷备组网。 
IWF与HSS分离部署。 
本节介绍内置BSF触发的增强P-CSCF Restore流程配置。 
#### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行，DRA与PCF之间的diameter链路和diameter路由配置正常。 
已完成预配置。 
#### 数据规划 
网元|命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---|---
DRA|SET DPCCPARA|DRA|Rx接口绑定失败后的处理动作|RETURN_ERROR_ANSWER|本端规划|-
Rx接口返回失败码|DRA|SET DPCCPARA|DRA|5002|本端规划|-
#### 配置过程 
步骤|说明|操作
---|---|---
1|配置DRA上Rx接口消息查询绑定信息失败后给对端返回失败响应，响应中的失败码为5002。|SET DPCCPARA:RXBINDFAIL="RETURN_ERROR_ANSWER",RXRETCODE=5002
#### 测试用例 
测试项目|内置BSF场景下，内置BSF故障，用户发起语音呼叫，触发增强P-CSCF Restore流程
---|---
预置条件|网络中有多个SMF（内置BSF）且运行正常。已经完成预配置。已经完成内置BSF触发的增强P-CSCF Restore配置。
测试过程|用户上线。对SMF（内置BSF）的端口进行shutdown操作实现SMF（内置BSF）故障。用户发起语音呼叫。在用户IMS会话重建后重新发起语音呼叫。
通过准则|用户注册成功。内置BSF故障后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA根据IP地址向NRF发现BSF，由于BSF故障，NRF查询结果为404。DRA收到NRF返回的失败码404后，向SBC返回失败码5002。SBC收到DRA的失败码5002后，给S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知UE重新激活IMS PDU Session。 3.       用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
### 外置BSF触发的增强P-CSCF Restroe场景配置 
#### BSF按省份部署组网场景配置 
##### 场景说明 
外置BSF场景下，BSF按省份部署的组网架构如[图1](1686102206262.html#zbfe5279462404966acea3ef1ccbf9dd8__181993f4-641b-4754-a1f4-8f0c79d73dd9)所示。
图1  外置BSF组网，BSF按省份部署
[]images/c21abefd7a3344038ee76b81ab42c55d.png)
该组网架构的特点如下： 
BSF外置独立部署，每个省单独部署一对BSF，A省BSF对接A省PCF，B省BSF对接B省PCF。该场景下可以配置保障路由，即当BSF查询会话绑定的PCF失败时，可以将AAR消息发送给本省的PCF，保障AAR消息可以顺利发送给PCF，例如，当A省BSF1未查询到可用的PCF时，可以将AAR消息发送给A省PCF1或PCF2。 
A省PCF1与A省PCF2热备，两个PCF之间可以进行消息互转；B省PCF3和B省PCF4热备，两个PCF之间可以进行消息互转。 
UDM和HSS融合部署。 
本节介绍外置BSF按省份部署组网场景下，BSF触发的增强P-CSCF Restore流程配置。 
##### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行，且BSF与PCF之间的diameter链路和diameter路由配置正常。 
已完成预配置。 
##### 数据规划 
网元|命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---|---
BSF|ADD DRTOUT|查询索引号|200|本端规划|在BSF上配置用作保障的目的主机所对应的路由出口索引号。
优选Diameter对等端组ID|BSF|ADD DRTOUT|30|已配置数据中获取|在BSF上配置主用PCF1所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据“组名称”参数来确定主用PCF1对应的标识，即为优选Diameter对等端组ID。
备份Diameter对等端组ID|BSF|ADD DRTOUT|31|已配置数据中获取|在BSF上配置备用PCF2所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据“组名称”参数来确定备用PCF2对应的标识，即为备份Diameter对等端组ID。
ADD DRTDHOST|BSF|查询索引号|30004|已配置数据中获取|配置Rx口目的主机名索引号。该参数引用自SHOW DRTPROXY:APPID="16777236"结果中，“下一个路由规则”为“目的主机名”的条目对应的“下一个路由索引号”参数。
目的主机名|ADD DRTDHOST|BSF|ztedefault|本端规划|配置用于保障的下一跳目的主机的名称。
下一个路由索引号|ADD DRTDHOST|BSF|200|已配置数据中获取|该参数引用自ADD DRTOUT命令中的REFINDEX参数，需要通过ADD DRTOUT命令预先配置。
下一个路由规则|ADD DRTDHOST|BSF|路由出口|本端规划|-
SET DPCCPARA|BSF|Rx接口绑定失败后的处理动作|ROUTE_SUBSEQUENTLY|本端规划|Rx接口消息查询会话绑定的PCF失败后，继续根据消息中的字段查询路由。
Rx接口返回失败码|SET DPCCPARA|BSF|5002|本端规划|Rx接口失败后返回失败原因码5002。
##### 配置过程 
步骤|说明|操作|备注
---|---|---|---
1|增加Rx口路由出口，用于在BSF查询会话绑定的PCF失败时能够有一个路由保障信息的继续传递。|ADD DRTOUT:REFINDEX="200",RESULT="OUT",PGROUPID="30",BAKPGROUPID="31",HTTPPGROUPID="0",RETURNCODE="0",CHGDHOST="NO",CHGDREALM="NO",SPECRERTPGID="0",AREAID="0"|-
2|增加目的主机名方式的路由配置。|ADD DRTDHOST:REFINDEX="30004",DHOST="ztedefault",NEXTRULE="OUT",NEXTINDEX="200",AREAID="0"|-
3|Rx接口消息查询会话绑定的PCF失败后，继续根据消息中的字段查询路由。|SET DPCCPARA:RXBINDFAIL="ROUTE_SUBSEQUENTLY",RXRETCODE=5002|-
##### 测试用例 
测试项目|外置BSF按省份部署，BSF丢失会话绑定信息，用户发起呼叫，触发P-CSCF Restore流程
---|---
预置条件|已经完成预配置。已经完成外置BSF触发的增强P-CSCF Restore配置。
测试过程|用户上线。在BSF上执行命令DEL DMBINDING删除会话绑定记录，造成BSF中的会话绑定信息丢失的情况。在主备PCF上执行动态命令REL_USER_SLIENTLY，使主备PCF的会话信息丢失。用户发起语音呼叫。用户IMS会话重建后重新发起语音呼叫。
通过准则|用户注册成功。BSF会话绑定记录丢失后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA把AAR消息路由给BSF，BSF查询会话绑定消息失败。BSF给兜底的主用PCF1发送AAR消息。主用PCF1上查询会话绑定记录失败，向BSF返回失败原因码5065。BSF向DRA返回失败原因码5065。DRA向SBC返回失败原因码5065。SBC收到DRA返回的失败原因码5065后，向S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session。3.     用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
#### BSF按大区部署组网场景配置 
##### 场景说明 
外置BSF场景下，BSF按大区部署的组网架构如[图1](1686102209606.html#zaed79ffcb71046dfbdd55c54eace4a94__59531e7d-c68c-427d-b0b9-581caae1b742)所示。
图1  外置BSF组网，BSF按大区部署
[]images/aaf1907a06de4e2ea5cda18247b1e132.png)
该组网架构的特点如下： 
BSF外置独立部署，一个大区部署一对BSF，同时对接A省和B省的PCF。大区BSF查询会话绑定的PCF失败时，由于无法确认AAR消息应该发送给A省PCF还是B省PCF，因此无法配置保障路由。 
A省PCF1与A省PCF2热备，两个PCF之间可以进行消息互转；B省PCF3和B省PCF4热备，两个PCF之间可以进行消息互转。 
UDM和HSS融合部署。 
本节介绍外置BSF按大区部署组网场景下，BSF触发的增强P-CSCF Restore流程配置。 
##### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行，且BSF与PCF之间的diameter链路和diameter路由配置正常。 
已完成预配置。 
##### 数据规划 
网元|命令|参数名称|取值样例|数据来源|说明
---|---|---|---|---|---
BSF|SET DPCCPARA|BSF|Rx接口绑定失败后的处理动作|RETURN_ERROR_ANSWER|本端规划|Rx接口消息查询绑定失败后的处理动作为返回错误响应。
Rx接口返回失败码|BSF|SET DPCCPARA|BSF|5002|本端规划|Rx接口消息查询绑定失败后返回失败原因码5002。
##### 配置过程 
步骤|说明|操作|备注
---|---|---|---
1|在BSF上配置Rx接口消息查询绑定失败后，向对端返回失败响应，失败原因码为5002。|SET DPCCPARA:RXBINDFAIL="RETURN_ERROR_ANSWER",RXRETCODE=5002|BSF查询会话绑定的PCF失败后，向对端返回失败原因码5002。
##### 测试用例 
测试项目|外置BSF按大区部署，BSF丢失会话绑定信息，用户发起呼叫，触发增强P-CSCF Restore流程
---|---
预置条件|已经完成预配置。已经完成外置BSF触发的增强P-CSCF Restore配置。
测试过程|用户上线。在BSF上执行命令DEL DMBINDING删除会话绑定记录，造成BSF中的会话绑定信息丢失的情况。用户发起语音呼叫。在用户IMS会话重建后重新发起语音呼叫。
通过准则|用户注册成功。BSF会话绑定记录丢失后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA把AAR消息路由给BSF，BSF查询会话绑定消息失败。BSF向DRA返回失败原因码5002。DRA向SBC返回失败原因码5002。SBC收到DRA的失败原因码5002后，给S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session。3.     用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
### PCF触发的增强P-CSCF Restore场景配置 
#### 内置BSF组网场景配置 
##### 场景说明 
在PCF触发的增强P-CSCF Restore流程中，内置BSF组网是否有UDM或IWF在配置上无差别。因此本节以有UDM无IWF组网为例进行介绍，组网架构如[图1](1686102216523.html#zfef979a51ebf442384eaa5b960e3de96__3de7d9ba-8551-4df4-8d47-06d01a12fba3)所示。
图1  内置BSF组网，有UDM无IWF组网
[]images/3da97aaf67b14bc688f16f6027a6a44f.png)
该组网架构的特点如下： 
BSF内置部署在SMF中。 
A省PCF1与A省PCF2冷备组网；B省PCF3与B省PCF4冷备组网。 
UDM与HSS融合部署。 
本节介绍内置BSF组网场景下，PCF触发的增强P-CSCF Restore流程配置。 
##### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行，DRA与PCF之间的diameter链路和diameter路由配置正常。 
已完成预配置。 
##### 数据规划 
网元|命令|参数名称|参数取值|数据来源|说明
---|---|---|---|---|---
DRA|SET DRTOUT|优选Diameter对等端组ID|30|已配置数据中获取|在DRA上配置主用PCF1所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据组名称参数来确定主用PCF1对应的标识，即为优选Diameter对等端组ID。
备份Diameter对等端组ID|DRA|SET DRTOUT|31|已配置数据中获取|在DRA上配置备用PCF2所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据组名称参数来确定备用PCF2对应的标识，即为备份Diameter对等端组ID。
查询索引号|DRA|SET DRTOUT|100|已配置数据中获取|在DRA上配置主用PCF1的目的主机名对应的路由出口索引号。在SHOW DRTDHOST结果中，根据目的主机名来确定主用PCF1对应的路由出口，即“下一个路由索引号”参数。
##### 配置过程 
步骤|说明|操作|备注
---|---|---|---
1|DRA从内置BSF查询到PCF主机名后，新增该目的主机名对应的路由出口配置，为主用PCF1增加一个备用的PCF对等端组，当主用PCF1故障时，给备用PCF2发送消息。|SET DRTOUT:REFINDEX="100",RESULT="OUT",PGROUPID="30",BAKPGROUPID="31",RETURNCODE="0",CHGDHOST="NO",CHGDREALM="NO",SPECRERTPGID="0",AREAID="0"|-
##### 测试用例 
测试项目|内置BSF场景下，主用PCF故障，用户发起语音呼叫，触发增强P-CSCF Restore流程。
---|---
预置条件|已经完成预配置。已经完成内置BSF场景下，PCF触发的增强P-CSCF Restore配置。备用PCF可用。
测试过程|用户上线。对主用PCF的端口进行shutdown操作实现主用PCF故障。用户发起呼叫。在触发增强P-CSCF Restore流程后，重新发起语音呼叫。
通过准则|用户注册成功。主用PCF故障后，用户发起语音呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA携带UE的IP地址向NRF发现BSF，DRA向发现的BSF查询会话绑定消息。BSF查询到用户会话绑定的PCF，给DRA返回绑定的PCF信息。DRA检测到主用PCF故障，给备用PCF发送AAR消息。备用PCF本地查询不到用户会话，备用PCF向DRA返回失败原因码5065，DRA向SBC返回失败原因码5065。SBC收到DRA的失败原因码5065后，向S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session。3.    用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
测试项目|内置BSF场景下，主用PCF语音会话丢失，用户发起语音呼叫，触发增强P-CSCF Restore流程
---|---
预置条件|已经完成预配置。已经完成内置BSF场景下，PCF触发的增强P-CSCF Restore配置。
测试过程|用户上线。在PCF上执行命令REL_USER_SLIENTLY，释放在线用户，使PCF上的会话丢失。用户发起语音呼叫。在触发增强P-CSCF Restore流程后，重新发起语音呼叫。
通过准则|用户注册成功。主用PCF上的会话丢失后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA根据IP地址向NRF发现BSF，DRA向发现的BSF查询会话绑定消息。BSF查询到用户会话绑定的PCF，给DRA返回绑定的PCF信息。DRA给PCF发送AAR消息。PCF本地查询不到会话，PCF向DRA返回错误码5065，DRA向SBC返回错误码5065。SBC收到DRA的错误码5065后，给S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session 3.       用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
#### 外置BSF组网场景配置 
##### 场景说明 
对于PCF触发的增强P-CSCF流程而言，外置BSF组网场景下的BSF按大区部署组网和BSF按省份组网在配置上无差别。因此本节以BSF按大区组网为例进行介绍，组网架构如[图1](1686102220321.html#z5f604ac68acf4e7fa28b82953b41b62a__8d6b731c-eac6-4992-a47c-fcb7f5d2e63b)所示。
图1  外置BSF组网，BSF大区部署
[]images/36af615692a44979b642353c9e961589.png)
该组网架构的特点如下： 
BSF外置独立部署，一个大区部署一对BSF，同时对接A省和B省的PCF。大区BSF查询会话绑定的PCF失败时，由于无法确认AAR消息应该发送给A省PCF还是B省PCF，因此无法配置保障路由。 
A省PCF1与A省PCF2热备，两个PCF之间可以进行消息互转；B省PCF3和B省PCF4热备，两个PCF之间可以进行消息互转。 
UDM和HSS融合部署。 
本节介绍外置BSF组网场景下，PCF触发的增强P-CSCF Restore流程配置。 
##### 配置前提 
各运营商网内的5G业务正常运行。 
语音业务网元正常运行，BSF与PCF之间的diameter链路和diameter路由配置正常。 
已完成预配置。 
##### 数据规划 
网元|命令|参数名称|参数取值|数据来源|说明
---|---|---|---|---|---
BSF|SET DRTOUT|优选Diameter对等端组ID|30|已配置数据中获取|在BSF上配置主用PCF1所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据组名称参数来确定主用PCF1对应的标识，即为优选Diameter对等端组ID。
备份Diameter对等端组ID|BSF|SET DRTOUT|31|已配置数据中获取|BSF上备用PCF2所在的diamter对等端组索引。在SHOW DPGROUP命令的查询结果中，根据组名称参数来确定备用PCF2对应的标识，即为备份Diameter对等端组ID。
查询索引号|BSF|SET DRTOUT|100|已配置数据中获取|在BSF上配置主用PCF1的目的主机名对应的路由出口索引号。在SHOW DRTDHOST结果中，根据目的主机名来确定主用PCF1对应的路由出口，即下一个路由索引号参数。
##### 配置过程 
步骤|说明|操作|备注
---|---|---|---
1|BSF查询到PCF主机名后，新增该目的主机名对应的路由出口配置，为主用PCF1增加一个备用的PCF对等端组，当主用PCF1故障时，给备用PCF2发送消息。|SET DRTOUT:REFINDEX="100",RESULT="OUT",PGROUPID="30",BAKPGROUPID="31",RETURNCODE="0",CHGDHOST="NO",CHGDREALM="NO",SPECRERTPGID="0",AREAID="0"|-
##### 测试用例 
测试项目|外置BSF场景下，主用PCF故障，备用PCF会话丢失，用户发起语音呼叫，触发增强P-CSCF Restore流程
---|---
预置条件|已经完成预配置。已经完成外置BSF场景下，PCF触发的增强P-CSCF Restore配置。备用PCF可用。
测试过程|用户上线。对主用PCF的端口进行shutdown操作实现主用PCF故障。在备用PCF上执行命令REL_USER_SLIENTLY，释放在线用户，使备用PCF上的会话丢失。用户发起语音呼叫。在用户IMS会话重建后重新发起语音呼叫。
通过准则|用户注册成功。主用PCF故障后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA把AAR消息路由给BSF，BSF查询会话绑定消息。BSF检查到会话绑定的主用PCF故障，给备用PCF发送AAR消息。备用PCF本地无会话绑定记录，给BSF返回失败原因码5065。BSF给DRA返回失败原因码5065。DRA给SBC返回失败原因码5065。SBC收到DRA的失败原因码5065后，给S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session。用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
测试项目|外置BSF场景下，主用PCF语音会话丢失，用户发起语音呼叫，触发增强P-CSCF Restore流程
---|---
预置条件|已经完成预配置。已经完成外置BSF场景下，PCF触发的增强P-CSCF Restore配置。
测试过程|用户上线。在主用PCF上执行命令REL_USER_SLIENTLY，释放在线用户会话，使主用PCF上的会话丢失。用户发起语音呼叫在用户IMS会话重建后重新发起语音呼叫。
通过准则|用户注册成功。主用PCF会话丢失后用户发起呼叫，通过信令跟踪功能查看到如下信息：SBC收到invite消息后给DRA发送AAR消息。DRA把AAR消息路由给BSF，BSF查询会话绑定消息。BSF获取到绑定的主用PCF信息，给主用PCF发送AAR消息。主用PCF本地无会话绑定记录给BSF返回失败原因码5065。BSF给DRA返回失败原因码5065。DRA给SBC返回失败原因码5065SBC收到DRA的失败原因码5065后，给S-CSCF发送SIP MESSAGE消息，包含pcrf-failure的消息体，指示S-CSCF发起P-CSCF Restore。S-CSCF向HSS+UDM发送Cx SAR消息，携带SAR-Flags（包含P-CSCF Restoration指示），且P-CSCF Restoration指示中的Server-Assignment-Type AVP值置为DEREGISTER-USER。HSS+UDM向为用户提供服务的AMF发送P-CSCF恢复通知Nudm_UECM_PCscfRestoration notification Request，AMF的地址为AMF注册过程中向HSS+UDM携带的pcscfRestorationCallbackUri。AMF通知SMF发起IMS PDU Session释放，通知UE重新激活IMS PDU Session。3.      用户IMS会话重建后发起的语音呼叫正常。
测试结果|-
# 缩略语 
# 缩略语 
## AF 
Application Function应用功能
## RCP 
Resource Control Platform资源控制平台
## SM 
Session Management会话管理
## SMF 
Session Management Function会话管理功能
